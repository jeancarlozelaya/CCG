<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Control de PEPS de Insumos</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --text-color: #333;
      --border-color: #ddd;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: var(--text-color);
      line-height: 1.6;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
      color: white;
      text-align: center;
      padding: 18px 0;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: var(--shadow);
      position: relative;
    }

    .form-container {
      width: 90%;
      max-width: 1000px;
      margin: 25px auto;
      padding: 25px;
      background-color: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 25px;
      font-size: 1.8rem;
      position: relative;
      padding-bottom: 10px;
    }

    h1:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background-color: var(--secondary-color);
      border-radius: 2px;
    }

    .question-container {
      margin-bottom: 25px;
      padding: 20px;
      border-radius: 8px;
      background-color: #f8f9fa;
      border-left: 4px solid var(--secondary-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .question-container label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark-color);
    }

    .question-container input,
    .question-container select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 16px;
      transition: var(--transition);
      background-color: white;
    }

    .question-container input:focus,
    .question-container select:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: var(--dark-color);
    }

    .form-group input[type="date"],
    .form-group select {
      width: calc(100% - 22px);
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 16px;
      height: 48px;
      box-sizing: border-box;
      transition: var(--transition);
    }

    .form-group input[type="date"]:focus,
    .form-group select:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .form-group input[type="number"] {
      -moz-appearance: textfield;
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 16px;
      transition: var(--transition);
    }

    .form-group input[type="number"]:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .form-group input[type="number"]::-webkit-outer-spin-button,
    .form-group input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .product-quantity-wrapper {
      border: 1px solid #eee;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
      margin-bottom: 15px;
      border-left: 4px solid var(--secondary-color);
      overflow: hidden;
    }

    .product-quantities-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
    }

    .product-quantity-row {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 0;
      flex-shrink: 0;
      flex-grow: 0;
      justify-content: flex-start;
      width: auto;
    }

    .product-quantity-row .label-wrapper {
      min-width: 80px;
      text-align: right;
      padding-right: 10px;
      flex-shrink: 0;
    }

    .product-quantity-row label {
      margin-bottom: 0;
      white-space: nowrap;
      font-weight: 600;
      color: var(--dark-color);
      font-size: 14px;
    }

    .product-quantity-row input {
      width: 60px;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 16px;
      text-align: center;
      box-sizing: border-box;
      height: 40px;
      transition: var(--transition);
    }

    .product-quantity-row input:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .pagination-tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }

    .pagination-tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      background-color: #e9ecef;
      color: #495057;
      font-weight: bold;
      transition: var(--transition);
    }

    .pagination-tab.active {
      background-color: var(--secondary-color);
      color: white;
      border-color: var(--secondary-color);
      border-bottom: 2px solid var(--secondary-color);
    }

    .pagination-tab:hover:not(.active) {
      background-color: #cfe2ff;
    }

    .product-page {
      display: none;
    }

    .product-page.active {
      display: block;
    }

    .level-quantities-section {
      border: 1px solid #eee;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
      margin-top: 20px;
      margin-bottom: 20px;
      border-left: 4px solid var(--secondary-color);
    }

    .level-quantities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .level-quantity-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: var(--transition);
    }

    .level-quantity-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border-color: var(--secondary-color);
    }

    .level-quantity-item label {
      font-weight: bold;
      margin-bottom: 8px;
      text-align: center;
      width: 100%;
      color: var(--dark-color);
    }

    .level-quantity-controls {
      display: flex;
      align-items: center;
      gap: 5px;
      width: 100%;
      justify-content: center;
    }

    .level-quantity-button {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      padding: 0;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2em;
      width: 35px;
      height: 35px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
      transition: var(--transition);
    }

    .level-quantity-button:hover {
      background-color: var(--primary-color);
      transform: scale(1.05);
    }

    .level-quantity-button:active {
      background-color: var(--dark-color);
    }

    .level-quantity-button.minus {
      background-color: var(--accent-color);
    }

    .level-quantity-button.minus:hover {
      background-color: #c0392b;
    }

    .level-quantity-input {
      width: 60px;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      text-align: center;
      font-size: 16px;
      -moz-appearance: textfield;
      box-sizing: border-box;
      height: 40px;
      transition: var(--transition);
    }

    .level-quantity-input:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .level-quantity-input::-webkit-outer-spin-button,
    .level-quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .sobrante-section {
      border: 1px solid #eee;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
      margin-top: 20px;
      margin-bottom: 20px;
      border-left: 4px solid var(--secondary-color);
    }

    .sobrante-section .form-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: nowrap;
    }

    .sobrante-section .form-group label {
      margin-bottom: 0;
      flex-basis: 150px;
      font-weight: 600;
      color: var(--dark-color);
      white-space: nowrap;
      font-size: 14px;
    }

    .sobrante-section .form-group input {
      flex-grow: 0;
      width: 70px;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      text-align: center;
      font-size: 16px;
      -moz-appearance: textfield;
      box-sizing: border-box;
      height: 40px;
      transition: var(--transition);
    }

    .sobrante-section .form-group input:focus {
      border-color: var(--secondary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .button-group button {
      flex-grow: 1;
      padding: 15px 25px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      transition: var(--transition);
      min-width: 150px;
      box-shadow: var(--shadow);
    }

    .button-group button:disabled,
    .advance-button-style:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .button-generate {
      background: linear-gradient(to right, var(--success-color), #27ae60);
      color: white;
    }

    .button-generate:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    .button-generate:active:not(:disabled) {
      transform: translateY(0);
    }

    .button-clear {
      background: linear-gradient(to right, var(--warning-color), #e67e22);
      color: white;
    }

    .button-clear:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    .button-clear:active:not(:disabled) {
      transform: translateY(0);
    }

    #initialFieldsGroup.locked input, #initialFieldsGroup.locked select {
      background-color: #e9ecef;
      cursor: not-allowed;
    }

    .advance-button-style {
      width: 100%;
      padding: 15px 25px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      text-align: center;
      background: linear-gradient(to right, var(--secondary-color), #2980b9);
      color: white;
      margin-top: 25px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      font-weight: 600;
      transition: var(--transition);
    }

    .advance-button-style:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    .advance-button-style:active:not(:disabled) {
      transform: translateY(0);
    }

    .product-page.higienico-page {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }

    .product-page.toalla-page {
      background-color: #6495ED;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
    }

    .scroll-button {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5em;
      cursor: pointer;
      position: fixed;
      bottom: 20px;
      right: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: var(--transition);
      z-index: 1000;
      display: none;
    }

    .scroll-button:hover {
      background-color: var(--primary-color);
      transform: translateY(-3px);
    }

    .scroll-button:active {
      transform: translateY(0);
    }

    .mobile-label {
      display: none;
    }

    /* Estilos responsivos */
    @media (max-width: 768px) {
      .form-container {
        width: 95%;
        padding: 15px;
        margin: 15px auto;
      }
      
      .level-quantities-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .button-group button {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .product-quantities-container {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 5px;
      }
      
      .product-quantity-row {
        width: auto;
        justify-content: flex-start;
        margin-right: 10px;
        margin-bottom: 5px;
      }
      
      .product-quantity-row .label-wrapper {
        min-width: 70px;
        text-align: left;
        padding-right: 5px;
      }
      
      .product-quantity-row label {
        font-size: 13px;
      }
      
      .product-quantity-row input {
        width: 50px;
        height: 35px;
        font-size: 14px;
      }
      
      .sobrante-section .form-group {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 5px;
      }
      
      .sobrante-section .form-group label {
        flex-basis: auto;
        margin-bottom: 0;
        min-width: 120px;
        font-size: 13px;
      }
      
      .sobrante-section .form-group input {
        width: 60px;
        height: 35px;
        flex-grow: 0;
      }
      
      .question-container {
        padding: 15px;
      }
      
      .question-container label {
        font-size: 14px;
        margin-bottom: 10px;
      }
      
      .desktop-label {
        display: none;
      }
      
      .mobile-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--dark-color);
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      .level-quantities-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .pagination-tabs {
        flex-wrap: wrap;
      }
      
      .pagination-tab {
        padding: 8px 12px;
        font-size: 14px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .product-quantities-container {
        justify-content: space-between;
        gap: 3px;
      }
      
      .product-quantity-row {
        margin-right: 5px;
        flex: 1;
        min-width: 45%;
      }
      
      .product-quantity-row .label-wrapper {
        min-width: 55px;
      }
      
      .product-quantity-row label {
        font-size: 12px;
      }
      
      .product-quantity-row input {
        width: 45px;
        height: 32px;
        font-size: 13px;
      }
      
      .sobrante-section .form-group {
        justify-content: space-between;
      }
      
      .sobrante-section .form-group label {
        min-width: 100px;
        font-size: 12px;
      }
      
      .sobrante-section .form-group input {
        width: 50px;
        height: 32px;
      }
    }
  </style>
</head>
<body>
  <div class="header">Pisos Brillantes</div>

  <div class="form-container">
    <h1>Control de PEPS de Insumos</h1>

    <div id="initialFieldsGroup">
        <div class="question-container">
            <div>
                <label for="fecha"><strong>Fecha:</strong></label>
                <input type="date" id="fecha">
            </div>

            <div>
                <label for="turno"><strong>Turno:</strong></label>
                <select id="turno">
                    <option value="">Seleccione</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </div>

            <div>
                <label for="personaEncargada"><strong>Persona Encargada:</strong></label>
                <select id="personaEncargada">
                    <option value="">Seleccione</option>
                    <option value="Adelfa Esperanza Romero">Adelfa Esperanza Romero</option>
                    <option value="Alexsi Nohemi Vallecillo Banegas">Alexsi Nohemi Vallecillo Banegas</option>
                    <option value="Angie Lizeth Vasquez Ochoa">Angie Lizeth Vasquez Ochoa</option>
                    <option value="Belkis Waldina Lopez Lopez">Belkis Waldina Lopez Lopez</option>
                    <option value="Delmi Mercedes Gaitán Reyes">Delmi Mercedes Gaitán Reyes</option>
                    <option value="Iiris Undina Izaguirre Medina">Iris Undina Izaguirre Medina</option>
                    <option value="Jensy Mariela Argueta Escobar">Jensy Mariela Argueta Escobar</option>
                    <option value="Mirian Yolanda Hernández Contreras">Mirian Yolanda Hernández Contreras</option>
                    <option value="Vilma Vasquez Avila">Vilma Vasquez Avila</option>
                </select>
            </div>

            <div>
                <label for="edificio"><strong>Edificio:</strong></label>
                <select id="edificio">
                    <option value="">Seleccione</option>
                    <option value="Cuerpos Bajos">Cuerpos Bajos</option>
                    <option value="Sótano">Sótano</option>
                    <option value="Torre #1">Torre #1</option>
                    <option value="Torre #2">Torre #2</option>
                </select>
            </div>
        </div>

        <button type="button" id="advanceBtn" class="advance-button-style" disabled>Avanzar</button>
    </div>

    <div id="fixedQuantitiesSection" style="display: none;">
        <div class="question-container">
            <label class="desktop-label"><strong>Producto Sobrante del Turno Anterior:</strong></label>
            <div class="product-quantity-wrapper">
                <div class="product-quantities-container">
                    <div class="product-quantity-row">
                        <div class="label-wrapper">
                            <label>Higienico:</label>
                        </div>
                        <input type="number" id="papelHigienicoRestante" min="0" value="0"
                               oninput="saveRestanteQuantity('papelHigienicoRestante')"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                    <div class="product-quantity-row">
                        <div class="label-wrapper">
                            <label>Toalla:</label>
                        </div>
                        <input type="number" id="papelToallaRestante" min="0" value="0"
                               oninput="saveRestanteQuantity('papelToallaRestante')"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                </div>
            </div>
        </div>

        <div class="question-container">
            <label class="desktop-label"><strong>Cantidad de Productos Requisados:</strong></label>
            <div class="product-quantity-wrapper">
                <div class="product-quantities-container" id="papelHigienicoQuantitiesContainer">
                    <div class="product-quantity-row">
                        <div class="label-wrapper">
                            <label>Higienico:</label>
                        </div>
                        <input type="number" id="papelHigienico-0" min="0" value="0"
                               oninput="saveFixedProductQuantity('papelHigienico', 0)"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                    <div class="product-quantity-row">
                        <input type="number" id="papelHigienico-1" min="0" value="0"
                               oninput="saveFixedProductQuantity('papelHigienico', 1)"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                    <div class="product-quantity-row">
                        <input type="number" id="papelHigienico-2" min="0" value="0"
                               oninput="saveFixedProductQuantity('papelHigienico', 2)"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                    <div class="product-quantity-row">
                        <input type="number" id="papelHigienico-3" min="0" value="0"
                               oninput="saveFixedProductQuantity('papelHigienico', 3)"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                </div>
            </div>
            <div class="product-quantity-wrapper" style="margin-top: 15px;">
                <div class="product-quantities-container" id="papelToallaQuantitiesContainer">
                    <div class="product-quantity-row">
                        <div class="label-wrapper">
                            <label>Toalla:</label>
                        </div>
                        <input type="number" id="papelToalla-0" min="0" value="0"
                               oninput="saveFixedProductQuantity('papelToalla', 0)"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                    <div class="product-quantity-row">
                        <input type="number" id="papelToalla-1" min="0" value="0"
                               oninput="saveFixedProductQuantity('papelToalla', 1)"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                    <div class="product-quantity-row">
                        <input type="number" id="papelToalla-2" min="0" value="0"
                               oninput="saveFixedProductQuantity('papelToalla', 2)"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                    <div class="product-quantity-row">
                        <input type="number" id="papelToalla-3" min="0" value="0"
                               oninput="saveFixedProductQuantity('papelToalla', 3)"
                               onfocus="clearZero(this)" onblur="restoreZero(this)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dynamicLevelSectionsContainer">
    </div>

    <div id="sobranteSection" class="sobrante-section" style="display: none;">
        <div class="question-container">
            <h3>Producto Sobrante</h3>
            <div class="form-group">
                <label for="papelHigienicoSobrante">Papel Higiénico:</label>
                <input type="number" id="papelHigienicoSobrante" min="0" value="0"
                       class="level-quantity-input"
                       oninput="saveSobranteQuantity('papelHigienicoSobrante')"
                       onfocus="clearZero(this)" onblur="restoreZero(this)">
            </div>
            <div class="form-group">
                <label for="papelToallaSobrante">Papel Toalla:</label>
                <input type="number" id="papelToallaSobrante" min="0" value="0"
                       class="level-quantity-input"
                       oninput="saveSobranteQuantity('papelToallaSobrante')"
                       onfocus="clearZero(this)" onblur="restoreZero(this)">
            </div>
        </div>
    </div>
    
    <div class="button-group">
        <button type="button" class="button-clear" id="clearBtn" onclick="clearAllData()" disabled>Limpiar Datos</button>
        <button type="button" class="button-generate" id="generateBtn" onclick="generarReporte()" disabled>Generar Reporte PDF</button>
    </div>
  </div>

  <!-- Botón de scroll -->
  <button class="scroll-button" id="scroll-top-button" onclick="scrollToTop()" title="Ir al inicio">&#9650;</button>


  <script>
    const STORAGE_KEY = 'requisitionFormData';
    let formData = {}; // Global object to store all form data

    // Función faltante que causaba el error
    function setDefaultDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('fecha').value = `${yyyy}-${mm}-${dd}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
      setDefaultDate();
      loadFormData();
      setupEventListeners();
      // Determine initial UI state based on loaded formData
      if (formData.formUnlocked) {
          unlockAndLoadForm();
      } else {
          resetFormUI(false); // Do not clear formData, just UI
      }
      checkInitialFieldsForAdvanceButton(); // Check initial state for advance button
    });

    function setupEventListeners() {
      // General form fields for initial section
      document.getElementById('fecha').addEventListener('change', function() { saveFormData(); checkInitialFieldsForAdvanceButton(); });
      document.getElementById('turno').addEventListener('change', function() { saveFormData(); checkInitialFieldsForAdvanceButton(); });
      document.getElementById('personaEncargada').addEventListener('change', function() { saveFormData(); checkInitialFieldsForAdvanceButton(); });
      document.getElementById('edificio').addEventListener('change', function() {
        if (formData.formUnlocked) { // Only save/update if form is unlocked (advanced)
            saveFormData(); // Save current building's level data BEFORE changing building UI
            updateDynamicFields(); // Load data for the new building's UI
        } else {
            saveFormData(); // Save initial selection even if not advanced
        }
        checkInitialFieldsForAdvanceButton(); // Check advance button state
      });

      document.getElementById('advanceBtn').addEventListener('click', handleAdvance);

      // Sobrante inputs event listeners
      document.getElementById('papelHigienicoSobrante').addEventListener('input', () => saveSobranteQuantity('papelHigienicoSobrante'));
      document.getElementById('papelHigienicoSobrante').addEventListener('blur', () => restoreZero(document.getElementById('papelHigienicoSobrante')));
      document.getElementById('papelToallaSobrante').addEventListener('input', () => saveSobranteQuantity('papelToallaSobrante'));
      document.getElementById('papelToallaSobrante').addEventListener('blur', () => restoreZero(document.getElementById('papelToallaSobrante')));
    }

    function checkInitialFieldsForAdvanceButton() {
        const fecha = document.getElementById('fecha').value;
        const turno = document.getElementById('turno').value;
        const personaEncargada = document.getElementById('personaEncargada').value;
        const edificio = document.getElementById('edificio').value;
        const advanceBtn = document.getElementById('advanceBtn');

        if (fecha && turno && personaEncargada && edificio) {
            advanceBtn.disabled = false;
        } else {
            advanceBtn.disabled = true;
        }
    }

    function saveFormData() {
        formData.fecha = document.getElementById('fecha').value;
        formData.turno = document.getElementById('turno').value;
        formData.personaEncargada = document.getElementById('personaEncargada').value;
        formData.edificio = document.getElementById('edificio').value;

        // Nuevos campos de producto restante
        formData.papelHigienicoRestante = parseInt(document.getElementById('papelHigienicoRestante').value) || 0;
        formData.papelToallaRestante = parseInt(document.getElementById('papelToallaRestante').value) || 0;

        // Save the fixed product quantities
        formData.papelHigienicoQuantities = [];
        for(let i = 0; i < 4; i++) {
            const input = document.getElementById(`papelHigienico-${i}`);
            formData.papelHigienicoQuantities.push(parseInt(input?.value) || 0);
        }

        formData.papelToallaQuantities = [];
        for(let i = 0; i < 4; i++) {
            const input = document.getElementById(`papelToalla-${i}`);
            formData.papelToallaQuantities.push(parseInt(input?.value) || 0);
        }

        // Save sobrante quantities
        formData.papelHigienicoSobrante = parseInt(document.getElementById('papelHigienicoSobrante').value) || 0;
        formData.papelToallaSobrante = parseInt(document.getElementById('papelToallaSobrante').value) || 0;

        // Save dynamic level quantities for the *currently active* building(s)
        const currentEdificio = formData.edificio;
        if (currentEdificio) {
            formData.dynamicLevelQuantities = formData.dynamicLevelQuantities || {};

            if (currentEdificio === 'Cuerpos Bajos') {
                const subBuildings = ['CBA', 'CBB', 'CBC'];
                formData.dynamicLevelQuantities[currentEdificio] = formData.dynamicLevelQuantities[currentEdificio] || {};

                subBuildings.forEach(sub => {
                    formData.dynamicLevelQuantities[currentEdificio][sub] = formData.dynamicLevelQuantities[currentEdificio][sub] || { higienico: {}, toalla: {} };

                    const higienicoInputs = document.querySelectorAll(`#dynamicHigienicoQuantitiesContainer-${sub} input[type="number"]`);
                    const toallaInputs = document.querySelectorAll(`#dynamicToallaQuantitiesContainer-${sub} input[type="number"]`);

                    formData.dynamicLevelQuantities[currentEdificio][sub].higienico = {};
                    higienicoInputs.forEach(input => {
                        formData.dynamicLevelQuantities[currentEdificio][sub].higienico[input.id] = parseInt(input.value) || 0;
                    });

                    formData.dynamicLevelQuantities[currentEdificio][sub].toalla = {};
                    toallaInputs.forEach(input => {
                        formData.dynamicLevelQuantities[currentEdificio][sub].toalla[input.id] = parseInt(input.value) || 0;
                    });
                });
            } else {
                formData.dynamicLevelQuantities[currentEdificio] = formData.dynamicLevelQuantities[currentEdificio] || { higienico: {}, toalla: {} };

                const safeEdificioId = currentEdificio.replace(/[ #]/g, '');
                const higienicoInputs = document.querySelectorAll(`#dynamicHigienicoQuantitiesContainer-${safeEdificioId} input[type="number"]`);
                const toallaInputs = document.querySelectorAll(`#dynamicToallaQuantitiesContainer-${safeEdificioId} input[type="number"]`);

                formData.dynamicLevelQuantities[currentEdificio].higienico = {};
                higienicoInputs.forEach(input => {
                    formData.dynamicLevelQuantities[currentEdificio].higienico[input.id] = parseInt(input.value) || 0;
                });

                formData.dynamicLevelQuantities[currentEdificio].toalla = {};
                toallaInputs.forEach(input => {
                    formData.dynamicLevelQuantities[currentEdificio].toalla[input.id] = parseInt(input.value) || 0;
                });
            }
        }

        localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
        console.log('Form data saved:', formData);
    }

    function loadFormData() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            formData = JSON.parse(storedData);
            document.getElementById('fecha').value = formData.fecha || document.getElementById('fecha').value;
            document.getElementById('turno').value = formData.turno || '';
            document.getElementById('personaEncargada').value = formData.personaEncargada || '';
            document.getElementById('edificio').value = formData.edificio || '';

            // Carga los valores restantes si los elementos existen
            const papelHigienicoRestanteInput = document.getElementById('papelHigienicoRestante');
            const papelToallaRestanteInput = document.getElementById('papelToallaRestante');
            
            if (papelHigienicoRestanteInput) {
                papelHigienicoRestanteInput.value = formData.papelHigienicoRestante !== undefined ? formData.papelHigienicoRestante : 0;
                restoreZero(papelHigienicoRestanteInput);
            }
            
            if (papelToallaRestanteInput) {
                papelToallaRestanteInput.value = formData.papelToallaRestante !== undefined ? formData.papelToallaRestante : 0;
                restoreZero(papelToallaRestanteInput);
            }

            // Load the fixed product quantities for Papel Higiénico
            for(let i = 0; i < 4; i++) {
                const input = document.getElementById(`papelHigienico-${i}`);
                if (input && formData.papelHigienicoQuantities && formData.papelHigienicoQuantities[i] !== undefined) {
                    input.value = formData.papelHigienicoQuantities[i];
                    restoreZero(input);
                } else if (input) {
                    input.value = 0;
                    restoreZero(input);
                }
            }

            // Load the fixed product quantities for Papel Toalla
            for(let i = 0; i < 4; i++) {
                const input = document.getElementById(`papelToalla-${i}`);
                if (input && formData.papelToallaQuantities && formData.papelToallaQuantities[i] !== undefined) {
                    input.value = formData.papelToallaQuantities[i];
                    restoreZero(input);
                } else if (input) {
                    input.value = 0;
                    restoreZero(input);
                }
            }

            // Load sobrante quantities
            document.getElementById('papelHigienicoSobrante').value = formData.papelHigienicoSobrante !== undefined ? formData.papelHigienicoSobrante : 0;
            restoreZero(document.getElementById('papelHigienicoSobrante'));
            document.getElementById('papelToallaSobrante').value = formData.papelToallaSobrante !== undefined ? formData.papelToallaSobrante : 0;
            restoreZero(document.getElementById('papelToallaSobrante'));

            // Initialize dynamicLevelQuantities if not present to avoid errors
            formData.dynamicLevelQuantities = formData.dynamicLevelQuantities || {};
            console.log('Form data loaded:', formData);
        } else {
            // Initialize formData if nothing is in localStorage
            formData = {
                dynamicLevelQuantities: {},
                papelHigienicoQuantities: [0,0,0,0],
                papelToallaQuantities: [0,0,0,0],
                papelHigienicoRestante: 0,
                papelToallaRestante: 0,
                papelHigienicoSobrante: 0,
                papelToallaSobrante: 0,
                formUnlocked: false
            };
            // Ensure initial fixed fields are set to 0
            for(let i=0; i<4; i++) {
                const phInput = document.getElementById(`papelHigienico-${i}`);
                if(phInput) { phInput.value = 0; restoreZero(phInput); }
                const ptInput = document.getElementById(`papelToalla-${i}`);
                if(ptInput) { ptInput.value = 0; restoreZero(ptInput); }
            }
            // Set initial values for restante and sobrante if elements exist
            const papelHigienicoRestanteInput = document.getElementById('papelHigienicoRestante');
            const papelToallaRestanteInput = document.getElementById('papelToallaRestante');
            
            if (papelHigienicoRestanteInput) {
                papelHigienicoRestanteInput.value = 0;
                restoreZero(papelHigienicoRestanteInput);
            }
            if (papelToallaRestanteInput) {
                papelToallaRestanteInput.value = 0;
                restoreZero(papelToallaRestanteInput);
            }
            
            document.getElementById('papelHigienicoSobrante').value = 0;
            document.getElementById('papelToallaSobrante').value = 0;
            restoreZero(document.getElementById('papelHigienicoSobrante'));
            restoreZero(document.getElementById('papelToallaSobrante'));
        }
    }

    function clearZero(inputElement) {
        if (inputElement.value === '0') {
            inputElement.value = '';
        }
    }

    function restoreZero(inputElement) {
        if (inputElement.value === '' || isNaN(parseInt(inputElement.value))) {
            inputElement.value = '0';
        }
    }

    function saveFixedProductQuantity(productType, index) {
        const input = document.getElementById(`${productType}-${index}`);
        let value = parseInt(input.value) || 0;

        if (productType === 'papelHigienico') {
            formData.papelHigienicoQuantities[index] = value;
        } else if (productType === 'papelToalla') {
            formData.papelToallaQuantities[index] = value;
        }
        saveFormData(); // Save entire form data
    }

    function saveSobranteQuantity(id) {
        const input = document.getElementById(id);
        const value = parseInt(input.value) || 0;
        formData[id] = value; // Directly set property in formData
        saveFormData();
    }

    function handleAdvance() {
        const fecha = document.getElementById('fecha').value;
        const turno = document.getElementById('turno').value;
        const personaEncargada = document.getElementById('personaEncargada').value;
        const edificio = document.getElementById('edificio').value;

        if (!fecha || !turno || !personaEncargada || !edificio) {
            Swal.fire('Advertencia', 'Por favor complete todos los campos iniciales (Fecha, Turno, Persona Encargada, Edificio) antes de avanzar.', 'warning');
            return;
        }

        formData.formUnlocked = true;
        saveFormData();
        unlockAndLoadForm();
    }

    function unlockAndLoadForm() {
        // Lock initial fields
        document.getElementById('initialFieldsGroup').classList.add('locked');
        document.getElementById('fecha').disabled = true;
        document.getElementById('turno').disabled = true;
        document.getElementById('personaEncargada').disabled = true;
        document.getElementById('edificio').disabled = true;
        document.getElementById('advanceBtn').style.display = 'none';

        // Show fixed quantities section
        document.getElementById('fixedQuantitiesSection').style.display = 'block';

        // Show sobrante section
        document.getElementById('sobranteSection').style.display = 'block';

        // Enable action buttons
        document.getElementById('clearBtn').disabled = false;
        document.getElementById('generateBtn').disabled = false;

        // Update and show dynamic level sections
        updateDynamicFields();
    }

    function resetFormUI(clearData = true) {
        // Clear and enable initial fields
        document.getElementById('initialFieldsGroup').classList.remove('locked');
        document.getElementById('fecha').disabled = false;
        document.getElementById('turno').disabled = false;
        document.getElementById('personaEncargada').disabled = false;
        document.getElementById('edificio').disabled = false;
        document.getElementById('advanceBtn').style.display = 'block';
        document.getElementById('advanceBtn').disabled = true;

        // Disable action buttons
        document.getElementById('clearBtn').disabled = true;
        document.getElementById('generateBtn').disabled = true;

        if (clearData) {
            setDefaultDate();
            document.getElementById('turno').value = '';
            document.getElementById('personaEncargada').value = '';
            document.getElementById('edificio').value = '';

            // Reset fixed product quantities to 0
            for(let i = 0; i < 4; i++) {
                const phInput = document.getElementById(`papelHigienico-${i}`);
                if(phInput) { phInput.value = 0; restoreZero(phInput); }
                const ptInput = document.getElementById(`papelToalla-${i}`);
                if(ptInput) { ptInput.value = 0; restoreZero(ptInput); }
            }
            
            // Reset restante and sobrante quantities to 0
            document.getElementById('papelHigienicoRestante').value = 0;
            document.getElementById('papelToallaRestante').value = 0;
            document.getElementById('papelHigienicoSobrante').value = 0;
            document.getElementById('papelToallaSobrante').value = 0;
            restoreZero(document.getElementById('papelHigienicoRestante'));
            restoreZero(document.getElementById('papelToallaRestante'));
            restoreZero(document.getElementById('papelHigienicoSobrante'));
            restoreZero(document.getElementById('papelToallaSobrante'));
        }

        // Hide fixed quantities section
        document.getElementById('fixedQuantitiesSection').style.display = 'none';

        // Hide sobrante section
        document.getElementById('sobranteSection').style.display = 'none';

        // Clear and hide dynamic level sections
        document.getElementById('dynamicLevelSectionsContainer').innerHTML = '';
        
        // Reset formUnlocked flag and save
        formData.formUnlocked = false;
        if (clearData) {
            formData.papelHigienicoQuantities = [0,0,0,0];
            formData.papelToallaQuantities = [0,0,0,0];
            formData.papelHigienicoRestante = 0;
            formData.papelToallaRestante = 0;
            formData.papelHigienicoSobrante = 0;
            formData.papelToallaSobrante = 0;
            formData.dynamicLevelQuantities = {};
            saveFormData();
        }
    }

    function saveRestanteQuantity(id) {
        const input = document.getElementById(id);
        const value = parseInt(input.value) || 0;
        formData[id] = value;
        saveFormData();
    }

    function updateDynamicFields() {
        const selectedEdificio = document.getElementById('edificio').value;
        const dynamicContainer = document.getElementById('dynamicLevelSectionsContainer');
        dynamicContainer.innerHTML = '';
        
        if (!selectedEdificio) return;

        // Crear ID seguro (sin espacios ni #)
        const safeBuildingId = selectedEdificio.replace(/[ #]/g, '');

        if (selectedEdificio === 'Cuerpos Bajos') {
            console.log('Handling Cuerpos Bajos...');
            const subBuildings = ['CBA', 'CBB', 'CBC'];
            subBuildings.forEach(sub => {
                const numFields = (sub === 'CBA') ? 6 : 8; // CBA has 6 levels, CBB/CBC have 8
                console.log(`Creating section for Cuerpos Bajos - ${sub} with ${numFields} fields.`);

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'level-quantities-section';
                sectionDiv.id = `subBuildingSection-${sub}`; // Added unique ID for sub-building sections
                sectionDiv.innerHTML = `<h3>Cuerpos Bajos - ${sub}</h3>`;

                const paginationTabsDiv = document.createElement('div');
                paginationTabsDiv.className = 'pagination-tabs';
                paginationTabsDiv.innerHTML = `
                    <div class="pagination-tab active" data-product="${sub}-higienico">Papel Higiénico</div>
                    <div class="pagination-tab" data-product="${sub}-toalla">Papel Toalla</div>
                `;
                sectionDiv.appendChild(paginationTabsDiv);

                const higienicoPageDiv = document.createElement('div');
                higienicoPageDiv.id = `${sub}HigienicoPage`;
                higienicoPageDiv.className = 'product-page active';
                higienicoPageDiv.innerHTML = `<div id="dynamicHigienicoQuantitiesContainer-${sub}" class="level-quantities-grid"></div>`;
                sectionDiv.appendChild(higienicoPageDiv);

                const toallaPageDiv = document.createElement('div');
                toallaPageDiv.id = `${sub}ToallaPage`;
                toallaPageDiv.className = 'product-page';
                toallaPageDiv.innerHTML = `<div id="dynamicToallaQuantitiesContainer-${sub}" class="level-quantities-grid"></div>`;
                sectionDiv.appendChild(toallaPageDiv);

                dynamicContainer.appendChild(sectionDiv);

                // Attach event listeners for the newly created tabs
                paginationTabsDiv.querySelectorAll('.pagination-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const productType = this.getAttribute('data-product');
                        activateProductPage(productType, sub); // Pass sub-building identifier
                    });
                });

                // Populate fields for this sub-building
                console.log(`Calling populateLevelQuantities for Cuerpos Bajos - ${sub}`);
                populateLevelQuantities(sub, numFields, 'Cuerpos Bajos');
                activateProductPage(`${sub}-higienico`, sub); // Activate default tab for this section
            });
        } else { // Single building like Torre #1, Torre #2, Sótano
            let numFields = 0;
            switch (selectedEdificio) {
                case 'Torre #1': numFields = 24; break;
                case 'Torre #2': numFields = 25; break;
                case 'Sótano': numFields = 5; break; // Sótano tiene 5 niveles (0-4)
            }

            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'level-quantities-section';
            
            // Usar safeBuildingId en los IDs
            sectionDiv.innerHTML = `
                <div class="pagination-tabs">
                    <div class="pagination-tab active" data-product="higienico">Papel Higiénico</div>
                    <div class="pagination-tab" data-product="toalla">Papel Toalla</div>
                </div>
                <div id="higienicoPage-${safeBuildingId}" class="product-page active">
                    <div id="dynamicHigienicoQuantitiesContainer-${safeBuildingId}" class="level-quantities-grid"></div>
                </div>
                <div id="toallaPage-${safeBuildingId}" class="product-page">
                    <div id="dynamicToallaQuantitiesContainer-${safeBuildingId}" class="level-quantities-grid"></div>
                </div>
            `;

            dynamicContainer.appendChild(sectionDiv);

            // Attach event listeners for the newly created tabs for single buildings
            sectionDiv.querySelectorAll('.pagination-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const productType = this.getAttribute('data-product');
                    activateProductPage(productType); // No subBuilding for single buildings
                });
            });

            populateLevelQuantities(safeBuildingId, numFields);
            activateProductPage('higienico'); // Activate default tab for single section
        }
    }

    function populateLevelQuantities(buildingOrSub, numFields, parentBuilding = null) {
        console.log(`--- populateLevelQuantities called for ${buildingOrSub}, numFields: ${numFields}, parentBuilding: ${parentBuilding} ---`);
        const currentEdificioKey = parentBuilding || formData.edificio; // Use formData.edificio as the main key
        
        // Crear un ID seguro para el edificio/sub-edificio (remover caracteres especiales)
        const safeBuildingIdForContainer = buildingOrSub.replace(/[ #]/g, '');

        // Ensure the data structure exists for current building/sub-building
        formData.dynamicLevelQuantities = formData.dynamicLevelQuantities || {};
        if (parentBuilding) { // Cuerpos Bajos scenario
            formData.dynamicLevelQuantities[currentEdificioKey] = formData.dynamicLevelQuantities[currentEdificioKey] || {};
            formData.dynamicLevelQuantities[currentEdificioKey][buildingOrSub] = formData.dynamicLevelQuantities[currentEdificioKey][buildingOrSub] || { higienico: {}, toalla: {} };
        } else { // Single building scenario
            formData.dynamicLevelQuantities[currentEdificioKey] = formData.dynamicLevelQuantities[currentEdificioKey] || { higienico: {}, toalla: {} };
        }

        const higienicoContainerId = `dynamicHigienicoQuantitiesContainer-${safeBuildingIdForContainer}`;
        const toallaContainerId = `dynamicToallaQuantitiesContainer-${safeBuildingIdForContainer}`;

        const higienicoContainer = document.getElementById(higienicoContainerId);
        const toallaContainer = document.getElementById(toallaContainerId);

        console.log(`Attempting to find containers: Higienico ID: ${higienicoContainerId}, Toalla ID: ${toallaContainerId}`);
        console.log(`Higienico Container found:`, !!higienicoContainer, `Toalla Container found:`, !!toallaContainer);

        if (!higienicoContainer || !toallaContainer) {
            console.error('Containers not found:', higienicoContainerId, toallaContainerId, '. Cannot populate levels.');
            return;
        }

        higienicoContainer.innerHTML = '';
        toallaContainer.innerHTML = '';
        console.log(`Containers cleared. Populating ${numFields} levels.`);

        for (let i = 0; i < numFields; i++) {
            // Use safeBuildingIdForContainer in the input IDs for consistency with how containers are named
            const higienicoItemId = `higienico-${safeBuildingIdForContainer}-${i}`;
            const toallaItemId = `toalla-${safeBuildingIdForContainer}-${i}`;

            let higienicoValue, toallaValue;

            if (parentBuilding) { // Cuerpos Bajos scenario
                higienicoValue = formData.dynamicLevelQuantities[currentEdificioKey][buildingOrSub].higienico[higienicoItemId] !== undefined
                               ? formData.dynamicLevelQuantities[currentEdificioKey][buildingOrSub].higienico[higienicoItemId]
                               : 0;
                toallaValue = formData.dynamicLevelQuantities[currentEdificioKey][buildingOrSub].toalla[toallaItemId] !== undefined
                            ? formData.dynamicLevelQuantities[currentEdificioKey][buildingOrSub].toalla[toallaItemId]
                            : 0;
            } else { // Single building scenario
                higienicoValue = formData.dynamicLevelQuantities[currentEdificioKey].higienico[higienicoItemId] !== undefined
                               ? formData.dynamicLevelQuantities[currentEdificioKey].higienico[higienicoItemId]
                               : 0;
                toallaValue = formData.dynamicLevelQuantities[currentEdificioKey].toalla[toallaItemId] !== undefined
                            ? formData.dynamicLevelQuantities[currentEdificioKey].toalla[toallaItemId]
                            : 0;
            }
            console.log(`Creating item for Nivel ${i}, Higienico ID: ${higienicoItemId}, Value: ${higienicoValue}`);
            higienicoContainer.appendChild(createLevelQuantityItem(higienicoItemId, `Nivel ${i}`, higienicoValue, 'higienico'));
            console.log(`Creating item for Nivel ${i}, Toalla ID: ${toallaItemId}, Value: ${toallaValue}`);
            toallaContainer.appendChild(createLevelQuantityItem(toallaItemId, `Nivel ${i}`, toallaValue, 'toalla'));
        }
        console.log(`--- populateLevelQuantities finished for ${buildingOrSub} ---`);
    }

    function createLevelQuantityItem(id, labelText, value, productType) {
        console.log(`createLevelQuantityItem called for ID: ${id}, Label: ${labelText}`);
        const itemDiv = document.createElement('div');
        itemDiv.className = 'level-quantity-item';
        itemDiv.innerHTML = `
          <label for="${id}">${labelText}:</label>
          <div class="level-quantity-controls">
            <button type="button" class="level-quantity-button minus" onclick="changeLevelQuantity('${id}', -1, '${productType}')">-</button>
            <input type="number" id="${id}" class="level-quantity-input" value="${value}" min="0"
                   oninput="saveLevelQuantity('${id}', '${productType}')"
                   onfocus="clearZero(this)" onblur="restoreZero(this)">
            <button type="button" class="level-quantity-button" onclick="changeLevelQuantity('${id}', 1, '${productType}')">+</button>
          </div>
        `;
        return itemDiv;
    }

    function changeLevelQuantity(id, delta, productType) {
      const input = document.getElementById(id);
      let value = parseInt(input.value) || 0;
      value += delta;
      if (value < 0) value = 0; // Ensure non-negative
      input.value = value;
      saveLevelQuantity(id, productType); // Call the unified save function
    }

    // saveLevelQuantity now updates formData and calls saveFormData
    function saveLevelQuantity(id, productType) {
        // Example IDs: "higienico-CBA-0" or "higienico-Torre1-0" (note: using safe name now)
        const parts = id.split('-'); 
        // For "higienico-CBA-0", parts[1] is "CBA"
        // For "higienico-Torre1-0", parts[1] is "Torre1"
        const buildingOrSubId = parts[1]; // This will be "CBA", "Torre1", etc.

        const currentEdificio = formData.edificio; // This is "Cuerpos Bajos" or "Torre #1"
        const input = document.getElementById(id);
        const value = parseInt(input.value) || 0;

        if (currentEdificio === 'Cuerpos Bajos') {
            // Check if dynamicLevelQuantities[currentEdificio] (Cuerpos Bajos) exists
            // and then if dynamicLevelQuantities[currentEdificio][buildingOrSubId] (CBA, CBB, CBC) exists
            if (formData.dynamicLevelQuantities[currentEdificio] && formData.dynamicLevelQuantities[currentEdificio][buildingOrSubId]) {
                formData.dynamicLevelQuantities[currentEdificio][buildingOrSubId][productType][id] = value;
            }
        } else { // Single buildings like Torre #1, Torre #2, Sótano
            // The key in dynamicLevelQuantities should be the original building name, e.g., "Torre #1"
            if (formData.dynamicLevelQuantities[currentEdificio]) {
                formData.dynamicLevelQuantities[currentEdificio][productType][id] = value;
            }
        }
        saveFormData(); // Unified call to save all data
    }

    function activateProductPage(productTypeFromTab, subBuilding = null) {
        console.log(`activateProductPage called with productTypeFromTab: ${productTypeFromTab}, subBuilding: ${subBuilding}`);
        let sectionElement;
        let pageIdSuffix = '';
        let actualProductType;

        if (subBuilding) {
            sectionElement = document.getElementById(`subBuildingSection-${subBuilding}`);
            pageIdSuffix = subBuilding;
            actualProductType = productTypeFromTab.split('-')[1];
        } else {
            sectionElement = document.querySelector(`#dynamicLevelSectionsContainer .level-quantities-section`);
            pageIdSuffix = formData.edificio ? formData.edificio.replace(/[ #]/g, '') : '';
            actualProductType = productTypeFromTab;
        }
        
        if (!sectionElement) {
            console.warn('No sectionElement found for activation. Exiting activateProductPage.');
            return;
        }

        // Hide all product pages within the current section and deactivate all tabs within the current section
        sectionElement.querySelectorAll('.product-page').forEach(page => {
            page.classList.remove('active');
            page.classList.remove('higienico-page');
            page.classList.remove('toalla-page');
        });
        sectionElement.querySelectorAll('.pagination-tab').forEach(tab => tab.classList.remove('active'));

        // Construct the target page ID
        let finalTargetPageId;
        if (subBuilding) {
            finalTargetPageId = `${subBuilding}${actualProductType.charAt(0).toUpperCase() + actualProductType.slice(1)}Page`;
        } else {
            finalTargetPageId = `${actualProductType}Page-${pageIdSuffix}`;
        }

        const targetTabSelector = `.pagination-tab[data-product="${productTypeFromTab}"]`;

        const targetPage = document.getElementById(finalTargetPageId);
        const targetTab = sectionElement.querySelector(targetTabSelector);

        if (targetPage) {
            targetPage.classList.add('active');
            if (actualProductType === 'higienico') {
                targetPage.classList.add('higienico-page');
            } else {
                targetPage.classList.add('toalla-page');
            }
        } else {
            console.warn(`Target page not found: ${finalTargetPageId}`);
        }
        if (targetTab) {
            targetTab.classList.add('active');
        } else {
            console.warn(`Target tab not found: ${targetTabSelector}`);
        }
        console.log('--- activateProductPage finished ---');
    }

    async function clearAllData() {
        const result1 = await Swal.fire({
            title: '¿Está seguro?',
            text: "Esta acción borrará TODOS los datos ingresados en el formulario de forma permanente.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, borrar todo',
            cancelButtonText: 'Cancelar'
        });

        if (result1.isConfirmed) {
            const result2 = await Swal.fire({
                title: '¿Realmente seguro?',
                text: "Esta es la última advertencia. Los datos no se podrán recuperar.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, estoy absolutamente seguro',
                cancelButtonText: 'No, cancelar'
            });

            if (result2.isConfirmed) {
                localStorage.removeItem(STORAGE_KEY);
                // Reset formData to initial state with 5 default fields for each product
                formData = {
                    dynamicLevelQuantities: {},
                    papelHigienicoQuantities: [0,0,0,0],
                    papelToallaQuantities: [0,0,0,0],
                    papelHigienicoSobrante: 0, // Reset sobrante
                    papelToallaSobrante: 0,     // Reset sobrante
                    formUnlocked: false
                };
                resetFormUI(true); // Clear UI and data
                Swal.fire('¡Borrado!', 'Todos los datos han sido eliminados.', 'success');
            } else {
                Swal.fire('Cancelado', 'La operación de borrado ha sido cancelada.', 'info');
            }
        } else {
            Swal.fire('Cancelado', 'La operación de borrado ha sido cancelada.', 'info');
        }
    }

    // Funciones para scroll
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Mostrar/ocultar botón de scroll según la posición
    window.onscroll = function() {
      const scrollTopBtn = document.getElementById('scroll-top-button');
      
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        scrollTopBtn.style.display = 'flex';
      } else {
        scrollTopBtn.style.display = 'none';
      }
    };

async function generarReporte() {
    saveFormData();

    const { fecha, turno, papelHigienicoQuantities, papelToallaQuantities, personaEncargada, edificio, 
            dynamicLevelQuantities, papelHigienicoSobrante, papelToallaSobrante, 
            papelHigienicoRestante, papelToallaRestante } = formData;

    if (!fecha || !turno || !personaEncargada || !edificio || !formData.formUnlocked) {
        Swal.fire('Advertencia', 'Por favor complete todos los campos iniciales y haga clic en "Avanzar" antes de generar el reporte.', 'warning');
        return;
    }

    Swal.fire({
        title: 'Procesando...',
        html: 'Generando su reporte PDF. Por favor, espere.',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
    });

    // Configuración de estilos
    const styles = {
        title: {
            fontSize: 16,
            bold: true,
            color: [13, 71, 161],
            marginBottom: 8
        },
        subtitle: {
            fontSize: 12,
            bold: true,
            color: [33, 33, 33],
            marginBottom: 6,
            background: [245, 245, 245],
            padding: 3
        },
        tableColors: {
            inventory: { header: [13, 71, 161], body: [255, 255, 255], footer: [227, 242, 253] },
            distribution: { header: [0, 96, 100], body: [255, 255, 255], footer: [224, 242, 241] },
            summary: { header: [49, 27, 146], body: [255, 255, 255], footer: [237, 231, 246] },
            remaining: { header: [183, 28, 28], body: [255, 255, 255], footer: [255, 235, 238] }
        },
        infoText: {
            fontSize: 10,
            color: [33, 33, 33]
        },
        margins: {
            left: 15,
            right: 15,
            top: 20,
            bottom: 20,
            section: 12,
            paragraph: 8
        },
        tableWidth: 180
    };

    // Formatear fecha
    const dateObj = new Date(fecha + 'T00:00:00');
    const formattedDateForFilename = fecha;
    const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    const dayName = days[dateObj.getDay()];
    const formattedDate = `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}`;
    const displayDate = `${dayName, formattedDate}`;

    // Encabezado
    let currentY = styles.margins.top;
    
    doc.setFontSize(styles.title.fontSize);
    doc.setTextColor(...styles.title.color);
    doc.setFont('helvetica', 'bold');
    doc.text("REPORTE DE INVENTARIO PEPS", 105, currentY, { align: 'center' });
    currentY += 10;
    
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.setFont('helvetica', 'normal');
    doc.text("Sistema de Control de Insumos - Pisos Brillantes", 105, currentY, { align: 'center' });
    currentY += 15;

    // Información general
    doc.setFontSize(11);
    doc.setTextColor(40);
    doc.setFont('helvetica', 'bold');
    doc.text("Información del Reporte", styles.margins.left, currentY);
    currentY += 6;
    
    doc.setFontSize(10);
    doc.setTextColor(...styles.infoText.color);
    doc.setFont('helvetica', 'normal');
    
    const infoLines = [
        `• Fecha: ${displayDate}`,
        `• Turno: ${turno}`,
        `• Encargado/a: ${personaEncargada}`,
        `• Edificio: ${edificio}`,
        `• Generado: ${new Date().toLocaleString()}`
    ];
    
    infoLines.forEach(line => {
        doc.text(line, styles.margins.left + 5, currentY);
        currentY += 5;
    });
    
    currentY += styles.margins.section;

    // Cálculos
    const totalPapelHigienicoFixed = papelHigienicoQuantities.reduce((sum, qty) => sum + qty, 0);
    const totalPapelToallaFixed = papelToallaQuantities.reduce((sum, qty) => sum + qty, 0);
    const totalHigienicoDisponible = (papelHigienicoRestante || 0) + totalPapelHigienicoFixed;
    const totalToallaDisponible = (papelToallaRestante || 0) + totalPapelToallaFixed;

    // Función para títulos de sección
    const drawSectionTitle = (title, y) => {
        doc.setFontSize(12);
        doc.setTextColor(33, 33, 33);
        doc.setFont('helvetica', 'bold');
        doc.text(title, styles.margins.left, y);
        
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.3);
        doc.line(styles.margins.left, y + 2, styles.margins.left + 50, y + 2);
        
        return y + styles.margins.paragraph;
    };

    // 1. TABLA DE INVENTARIO (con color en fila final)
    currentY = drawSectionTitle("1. INVENTARIO DE PRODUCTOS", currentY);

    doc.autoTable({
        startY: currentY,
        head: [['Concepto', 'Papel Higiénico', 'Papel Toalla']],
        body: [
            ['Sobrante turno anterior', papelHigienicoRestante || 0, papelToallaRestante || 0],
            ['Requisado turno actual', totalPapelHigienicoFixed, totalPapelToallaFixed],
            ['Total disponible', totalHigienicoDisponible, totalToallaDisponible]
        ],
        styles: {
            fontSize: 10,
            cellPadding: 5,
            overflow: 'linebreak',
            valign: 'middle',
            minCellWidth: 20,
            cellWidth: 'wrap'
        },
        headStyles: {
            fillColor: styles.tableColors.inventory.header,
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center',
            fontSize: 11
        },
        bodyStyles: {
            fillColor: styles.tableColors.inventory.body,
            textColor: 0,
            halign: 'center',
            lineWidth: 0.1,
            lineColor: [220, 220, 220]
        },
didDrawCell: (data) => {
    if (data.section === 'body' && data.row.index === 2) {
        doc.setFillColor(227, 242, 253); // Mantener fondo azul claro
        doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
        // Forzar texto negro y estilo bold para mejor visibilidad
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.text(data.cell.text, data.cell.x + data.cell.width/2, data.cell.y + 7, {
            align: 'center',
            baseline: 'middle'
        });
        return false; // Evitar que autoTable dibuje el texto automáticamente
    }
        },
        columnStyles: {
            0: { cellWidth: 90, halign: 'center', fontStyle: 'bold' }, // Centrado
            1: { cellWidth: 45, halign: 'center' },
            2: { cellWidth: 45, halign: 'center' }
        },
        margin: { left: styles.margins.left, right: styles.margins.right },
        tableWidth: styles.tableWidth,
        theme: 'grid'
    });
    currentY = doc.autoTable.previous.finalY + styles.margins.section;

    // 2. DISTRIBUCIÓN POR NIVELES (se mantiene igual)
    currentY = drawSectionTitle(`2. DISTRIBUCIÓN POR NIVELES - ${edificio.toUpperCase()}`, currentY);

    let grandTotalHigienicoNiveles = 0;
    let grandTotalToallaNiveles = 0;

    if (edificio && dynamicLevelQuantities[edificio]) {
        if (edificio === 'Cuerpos Bajos') {
            const subBuildings = ['CBA', 'CBB', 'CBC'];
            
            subBuildings.forEach(sub => {
                const subBuildingData = dynamicLevelQuantities[edificio][sub] || {higienico: {}, toalla: {}};
                const combinedLevelData = [];
                let subTotalHigienico = 0;
                let subTotalToalla = 0;

                const allLevels = new Set([
                    ...Object.keys(subBuildingData.higienico).filter(key => subBuildingData.higienico[key] > 0).map(key => parseInt(key.split('-')[key.split('-').length - 1])),
                    ...Object.keys(subBuildingData.toalla).filter(key => subBuildingData.toalla[key] > 0).map(key => parseInt(key.split('-')[key.split('-').length - 1]))
                ]);
                const sortedLevels = Array.from(allLevels).sort((a, b) => a - b);

                sortedLevels.forEach(levelIndex => {
                    const safeSubId = sub.replace(/[ #]/g, '');
                    const higienicoItemId = `higienico-${safeSubId}-${levelIndex}`;
                    const toallaItemId = `toalla-${safeSubId}-${levelIndex}`;
                    const phQty = subBuildingData.higienico[higienicoItemId] || 0;
                    const ptQty = subBuildingData.toalla[toallaItemId] || 0;
                    
                    if (phQty > 0 || ptQty > 0) {
                        combinedLevelData.push([`Nivel ${levelIndex}`, phQty, ptQty]);
                        subTotalHigienico += phQty;
                        subTotalToalla += ptQty;
                    }
                });

                if (combinedLevelData.length > 0) {
                    doc.autoTable({
                        startY: currentY,
                        head: [[`${sub} - Nivel`, 'Higiénico', 'Toalla']],
                        body: combinedLevelData,
                        foot: [['Subtotal', subTotalHigienico, subTotalToalla]],
                        styles: {
                            fontSize: 9,
                            cellPadding: 4,
                            overflow: 'linebreak',
                            minCellWidth: 20,
                            cellWidth: 'wrap',
                            lineWidth: 0.1,
                            lineColor: [220, 220, 220]
                        },
                        headStyles: {
                            fillColor: styles.tableColors.distribution.header,
                            textColor: 255,
                            fontStyle: 'bold',
                            halign: 'center',
                            fontSize: 10
                        },
                        bodyStyles: {
                            fillColor: styles.tableColors.distribution.body,
                            textColor: 0,
                            halign: 'center'
                        },
                        footStyles: {
                            fillColor: styles.tableColors.distribution.footer,
                            textColor: 0,
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        columnStyles: {
                            0: { cellWidth: 60, halign: 'center', fontStyle: 'bold' },
                            1: { cellWidth: 60, halign: 'center' },
                            2: { cellWidth: 60, halign: 'center' }
                        },
                        margin: { left: styles.margins.left, right: styles.margins.right },
                        tableWidth: styles.tableWidth,
                        theme: 'grid'
                    });
                    currentY = doc.autoTable.previous.finalY + styles.margins.paragraph;
                }
                grandTotalHigienicoNiveles += subTotalHigienico;
                grandTotalToallaNiveles += subTotalToalla;
            });
        } else {
            const higienicoLevels = dynamicLevelQuantities[edificio].higienico || {};
            const toallaLevels = dynamicLevelQuantities[edificio].toalla || {};
            const combinedLevelData = [];
            let subTotalHigienico = 0;
            let subTotalToalla = 0;

            const allLevels = new Set([
                ...Object.keys(higienicoLevels).filter(key => higienicoLevels[key] > 0).map(key => parseInt(key.split('-')[key.split('-').length - 1])),
                ...Object.keys(toallaLevels).filter(key => toallaLevels[key] > 0).map(key => parseInt(key.split('-')[key.split('-').length - 1]))
            ]);
            const sortedLevels = Array.from(allLevels).sort((a, b) => a - b);

            sortedLevels.forEach(levelIndex => {
                const safeEdificioId = edificio.replace(/[ #]/g, '');
                const higienicoItemId = `higienico-${safeEdificioId}-${levelIndex}`;
                const toallaItemId = `toalla-${safeEdificioId}-${levelIndex}`;
                const phQty = higienicoLevels[higienicoItemId] || 0;
                const ptQty = toallaLevels[toallaItemId] || 0;

                if (phQty > 0 || ptQty > 0) {
                    combinedLevelData.push([`Nivel ${levelIndex}`, phQty, ptQty]);
                    subTotalHigienico += phQty;
                    subTotalToalla += ptQty;
                }
            });

            if (combinedLevelData.length > 0) {
                doc.autoTable({
                    startY: currentY,
                    head: [['Nivel', 'Higiénico', 'Toalla']],
                    body: combinedLevelData,
                    foot: [['Subtotal', subTotalHigienico, subTotalToalla]],
                    styles: {
                        fontSize: 9,
                        cellPadding: 4,
                        overflow: 'linebreak',
                        minCellWidth: 20,
                        cellWidth: 'wrap',
                        lineWidth: 0.1,
                        lineColor: [220, 220, 220]
                    },
                    headStyles: {
                        fillColor: styles.tableColors.distribution.header,
                        textColor: 255,
                        fontStyle: 'bold',
                        halign: 'center',
                        fontSize: 10
                    },
                    bodyStyles: {
                        fillColor: styles.tableColors.distribution.body,
                        textColor: 0,
                        halign: 'center'
                    },
                    footStyles: {
                        fillColor: styles.tableColors.distribution.footer,
                        textColor: 0,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    columnStyles: {
                        0: { cellWidth: 60, halign: 'center', fontStyle: 'bold' }, // Cambiado a centrado
                        1: { cellWidth: 60, halign: 'center' },
                        2: { cellWidth: 60, halign: 'center' }
                    },
                    margin: { left: styles.margins.left, right: styles.margins.right },
                    tableWidth: styles.tableWidth,
                    theme: 'grid'
                });
                currentY = doc.autoTable.previous.finalY + styles.margins.paragraph;
            }
            grandTotalHigienicoNiveles += subTotalHigienico;
            grandTotalToallaNiveles += subTotalToalla;
        }
    }

    // 3. TABLA DE RESUMEN (con "Diferencia" y color)
    currentY = drawSectionTitle("3. RESUMEN DE TOTALES", currentY);

    doc.autoTable({
        startY: currentY,
        head: [['Concepto', 'Papel Higiénico', 'Papel Toalla']],
        body: [
            ['Total disponible', totalHigienicoDisponible, totalToallaDisponible],
            ['Total distribuido', grandTotalHigienicoNiveles, grandTotalToallaNiveles],
            ['Diferencia', totalHigienicoDisponible - grandTotalHigienicoNiveles, totalToallaDisponible - grandTotalToallaNiveles]
        ],
        styles: {
            fontSize: 10,
            cellPadding: 5,
            overflow: 'linebreak',
            valign: 'middle',
            minCellWidth: 20,
            cellWidth: 'wrap',
            lineWidth: 0.1,
            lineColor: [220, 220, 220]
        },
        headStyles: {
            fillColor: styles.tableColors.summary.header,
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center',
            fontSize: 11
        },
        bodyStyles: {
            fillColor: styles.tableColors.summary.body,
            textColor: 0,
            halign: 'center'
        },
didDrawCell: (data) => {
    if (data.section === 'body' && data.row.index === 2) {
        doc.setFillColor(237, 231, 246); // Mantener fondo morado claro
        doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
        // Forzar texto negro y estilo bold para mejor visibilidad
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.text(data.cell.text, data.cell.x + data.cell.width/2, data.cell.y + 7, {
            align: 'center',
            baseline: 'middle'
        });
        return false; // Evitar que autoTable dibuje el texto automáticamente
    }
},
        columnStyles: {
            0: { cellWidth: 90, halign: 'center', fontStyle: 'bold' }, // Centrado
            1: { cellWidth: 45, halign: 'center' },
            2: { cellWidth: 45, halign: 'center' }
        },
        margin: { left: styles.margins.left, right: styles.margins.right },
        tableWidth: styles.tableWidth,
        theme: 'grid'
    });
    currentY = doc.autoTable.previous.finalY + styles.margins.section;

    // 4. TABLA DE PRODUCTO SOBRANTE (nueva tabla)
    currentY = drawSectionTitle("4. PRODUCTO SOBRANTE REGISTRADO", currentY);

    doc.autoTable({
        startY: currentY,
        head: [['Producto', 'Cantidad']],
        body: [
            ['Papel Higiénico', papelHigienicoSobrante || 0],
            ['Papel Toalla', papelToallaSobrante || 0]
        ],
        styles: {
            fontSize: 10,
            cellPadding: 5,
            overflow: 'linebreak',
            valign: 'middle',
            minCellWidth: 20,
            cellWidth: 'wrap',
            lineWidth: 0.1,
            lineColor: [220, 220, 220]
        },
        headStyles: {
            fillColor: styles.tableColors.remaining.header,
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center',
            fontSize: 11
        },
        bodyStyles: {
            fillColor: styles.tableColors.remaining.body,
            textColor: 0,
            halign: 'center'
        },
        columnStyles: {
            0: { cellWidth: 90, halign: 'center', fontStyle: 'bold' }, // Centrado
            1: { cellWidth: 90, halign: 'center' }  // Centrado
        },
        margin: { left: styles.margins.left, right: styles.margins.right },
        tableWidth: styles.tableWidth,
        theme: 'grid'
    });

    // Pie de página
    const pageCount = doc.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.text(`Página ${i} de ${pageCount}`, 105, 285, { align: 'center' });
        
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.3);
        doc.line(styles.margins.left, 287, 200 - styles.margins.right, 287);
        
        doc.text("Sistema de Control de Insumos PEPS - Pisos Brillantes", 105, 290, { align: 'center' });
    }

    // Nombre del archivo
    const filename = `${formattedDateForFilename} - ${edificio} - Turno ${turno}.pdf`;

    const pdfBlob = doc.output('blob');
    Swal.close();

    function tryShareOrDownload() {
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], filename, { type: 'application/pdf' })] })) {
            navigator.share({
                files: [new File([pdfBlob], filename, { type: 'application/pdf' })],
                title: `Reporte de PEPS de Insumos - ${filename.replace('.pdf', '')}`,
                text: `Adjunto el reporte de PEPS de insumos para ${fecha}.`
            })
            .then(() => {
                Swal.fire({
                    icon: 'success',
                    title: '¡Reporte Compartido!',
                    text: 'El PDF ha sido enviado.',
                    confirmButtonColor: '#007bff'
                });
            })
            .catch((error) => {
                console.error('Error al Compartir:', error);
                showDownloadOptions();
            });
        } else {
            showDownloadOptions();
        }
    }

    function showDownloadOptions() {
        Swal.fire({
            title: 'Descargar Reporte',
            html: '¿Desea descargar el reporte PDF?',
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Descargar PDF',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                doc.save(filename);
                Swal.fire('¡Descargado!', 'El PDF se ha descargado.', 'success');
            }
        });
    }
    
    tryShareOrDownload();
}


  </script>
</body>
</html>
