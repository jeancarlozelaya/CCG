<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - Gestión de Aspiradoras</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        /* ESTILOS BASE - MISMOS COLORES QUE EL ORIGINAL DE ASPIRADORAS */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #2ecc71;
            --dark-color: #34495e;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --light-bg: #f5f7fa;
        }

        html, body {
            touch-action: manipulation;
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-color);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            text-align: center;
            padding: 18px 0;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }

        .container-custom {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px 50px 15px;
        }

        .card-custom {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: none;
            margin-bottom: 25px;
            border-top: 5px solid var(--secondary-color);
            padding: 20px;
            height: 100%;
        }

        .btn-custom {
            border: none;
            font-weight: 600;
            padding: 10px 25px;
            font-size: 0.95rem;
            border-radius: 50px;
            transition: var(--transition);
            color: white !important;
            background: linear-gradient(45deg, var(--secondary-color), #5dade2);
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-custom:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }

        .form-control, .form-select {
            border-radius: 8px; padding: 10px 15px; border: 1px solid var(--border-color);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color); box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }

        .kpi-value { font-size: 2.5rem; font-weight: 800; color: var(--primary-color); }
        .kpi-label { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .kpi-icon { font-size: 2rem; color: var(--secondary-color); margin-bottom: 15px; opacity: 0.8; }

        .chart-box { position: relative; height: 300px; width: 100%; }

        .table-responsive { border-radius: 8px; overflow: hidden; }
        .table thead { background-color: var(--primary-color); color: white; }
        
        /* BOTONES DE ACCIÓN */
        .btn-action {
            border: none; border-radius: 50px;
            width: 35px; height: 35px;
            font-size: 0.85rem; margin: 0 2px;
            transition: var(--transition);
            display: inline-flex; justify-content: center; align-items: center;
            color: white;
        }
        .btn-action:hover { transform: translateY(-2px); color: white; }

        .btn-pdf { background: linear-gradient(45deg, var(--accent-color), #e74c3c); }
        .btn-share { background: linear-gradient(45deg, #1abc9c, #16a085); }
        .btn-download { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .btn-delete { background: #7f8c8d; }
        .btn-delete:hover { background: #c0392b; }
        
        /* BOTÓN PARA ELIMINAR DUPLICADOS */
        .btn-danger-custom {
            background: linear-gradient(45deg, var(--accent-color), #c0392b);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 600;
            transition: var(--transition);
        }
        .btn-danger-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }

        /* RANKING */
        .ranking-item { 
            display: flex; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid #eee; 
        }
        .ranking-item:last-child { border-bottom: none; }
        .rank-pos { 
            width: 30px; 
            font-weight: bold; 
            color: #999; 
            font-size: 0.9rem; 
            text-align: center;
        }
        .rank-info { flex-grow: 1; padding-right: 15px; }
        .rank-name { font-weight: 600; color: var(--dark-color); display: block; margin-bottom: 4px; }
        .rank-bar-bg { height: 6px; background: #eee; border-radius: 3px; width: 100%; overflow: hidden; }
        .rank-bar-fill { height: 100%; border-radius: 3px; transition: width 1s ease; }
        .rank-count { min-width: 80px; text-align: right; }
        .badge-count { 
            font-size: 0.9rem; 
            padding: 5px 10px; 
            border-radius: 50px; 
            min-width: 40px; 
            display: inline-block; 
            text-align: center; 
        }
        .bg-high { background-color: var(--success-color); color: white; }
        .bg-mid { background-color: var(--secondary-color); color: white; }
        .bg-low { background-color: var(--warning-color); color: white; }
        .bg-zero { 
            background-color: #e74c3c1a; 
            color: #c0392b; 
            border: 1px solid #e74c3c40; 
        }
        
        /* BADGE PARA DUPLICADOS */
        .badge-duplicate {
            background-color: var(--warning-color);
            color: white;
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 50px;
            margin-left: 8px;
        }

        /* OVERLAY CARGA */
        #overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: none; 
            justify-content: center; 
            align-items: center;
            z-index: 9999; 
            flex-direction: column;
        }
        .spinner {
            width: 60px; 
            height: 60px;
            border: 5px solid rgba(52, 152, 219, 0.2);
            border-radius: 50%; 
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite; 
            margin-bottom: 20px;
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        #loadingMessage { 
            text-align: center; 
            color: var(--dark-color); 
        }
        #loadingMessage h4 { 
            margin: 0 0 10px; 
            font-size: 1.3rem; 
            font-weight: bold; 
        }
        #loadingMessage p { 
            margin: 0; 
            color: #7f8c8d; 
            font-weight: normal; 
        }
        
        /* MODAL PDF */
        .modal-pdf-body {
            height: calc(100vh - 56px); 
            padding: 0;
            overflow: hidden;
            background-color: #525659;
        }
        .modal-pdf-iframe { 
            width: 100%; 
            height: 100%; 
            border: none; 
            display: block; 
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .kpi-value { font-size: 2rem; }
            .kpi-icon { font-size: 1.5rem; }
            .chart-box { height: 250px; }
            .btn-custom { padding: 8px 15px; font-size: 0.9rem; }
        }
        
        @media (max-width: 480px) {
            .header { font-size: 1.2rem; padding: 15px 0; }
            .kpi-value { font-size: 1.8rem; }
            .chart-box { height: 200px; }
        }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Cargando...</h4>
            <p></p>
        </div>
    </div>

    <!-- MODAL PDF -->
    <div class="modal fade" id="modalPDF" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-secondary">
                        <i class="fas fa-file-pdf me-2"></i>Vista Previa del Acta
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body modal-pdf-body">
                    <iframe id="iframePDF" class="modal-pdf-iframe" src=""></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- CABECERA -->
    <div class="header">
        Pisos Brillantes
    </div>

    <div class="container-custom">
        
        <!-- PANEL DE CONTROL -->
        <div class="card-custom">
            <h5 class="mb-3 text-secondary border-bottom pb-2">
                <i class="fas fa-filter me-2"></i>Panel de Control
            </h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Tipo de Movimiento</label>
                    <select id="filtroTipo" class="form-select">
                        <option value="" selected disabled>Seleccionar tipo</option>
                        <option value="salidas">Salidas (Préstamos)</option>
                        <option value="entradas">Entradas (Devoluciones)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Mes</label>
                    <select id="filtroMes" class="form-select"></select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Año</label>
                    <select id="filtroAnio" class="form-select"></select>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-12 text-center">
                    <button class="btn-custom" onclick="consultarDatos()" style="max-width: 300px;">
                        <i class="fas fa-chart-bar me-1"></i> Generar Reporte
                    </button>
                </div>
            </div>
        </div>

        <!-- CONTENIDO DEL DASHBOARD -->
        <div id="dashboardContent" style="display: none;">
            
            <!-- KPI's -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-sign-out-alt"></i></div>
                        <div class="kpi-value" id="kpiTotal">0</div>
                        <div class="kpi-label" id="kpiLabel">Movimientos</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-vacuum"></i></div>
                        <div class="kpi-value" id="kpiAspiradoras">0</div>
                        <div class="kpi-label">Aspiradoras Usadas</div>
                    </div>
                </div>
            </div>

            <!-- GRÁFICOS -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="chart-box">
                            <canvas id="chartMovimientos"></canvas>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Movimientos por día
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="chart-box">
                            <canvas id="chartAspiradoras"></canvas>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="chartAspiradorasLabel">Aspiradoras más usadas (Top 10)</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN DUPLICADOS -->
            <div class="row" id="seccionDuplicados" style="display: none;">
                <div class="col-12">
                    <div class="card-custom border-warning" style="border-top: 5px solid var(--warning-color);">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <h5 class="text-warning mb-2 mb-md-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Registros Duplicados Detectados
                                <span class="badge bg-warning text-dark ms-2" id="contadorDuplicados">0</span>
                            </h5>
                            <button class="btn btn-danger-custom" onclick="confirmarEliminarDuplicados()">
                                <i class="fas fa-trash-alt me-1"></i> Eliminar Todos los Duplicados
                            </button>
                        </div>

                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">#</th>
                                        <th style="width: 120px;">Fecha</th>
                                        <th>Aspiradora</th>
                                        <th>Colaborador</th>
                                        <th>Área</th>
                                        <th class="text-center" style="width: 100px;">Repeticiones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaDuplicadosCuerpo"></tbody>
                            </table>
                            <div id="sinDuplicados" class="text-center p-4 text-muted" style="display:none;">
                                No se encontraron registros duplicados.
                            </div>
                        </div>
                        
                        <div class="mt-3 text-muted small">
                            <i class="fas fa-info-circle me-1"></i>
                            Se consideran duplicados aquellos registros con misma fecha, aspiradora, colaborador y área.
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABLA DETALLADA -->
            <div class="row">
                <div class="col-12">
                    <div class="card-custom">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <h5 class="text-secondary mb-2 mb-md-0">
                                <i class="fas fa-history me-2"></i>Historial de Movimientos
                            </h5>
                            <div class="input-group" style="max-width: 400px; width: 100%;">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" id="filtroTabla" class="form-control border-start-0" placeholder="Buscar por aspiradora, colaborador o área...">
                            </div>
                        </div>

                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th style="width: 120px;">Fecha</th>
                                        <th>Aspiradora</th>
                                        <th>Colaborador</th>
                                        <th>Área</th>
                                        <th class="text-center" style="width: 200px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaCuerpo"></tbody>
                            </table>
                            <div id="sinResultadosFiltro" class="text-center p-4 text-muted" style="display:none;">
                                No se encontraron movimientos con ese filtro.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- FIN DASHBOARD CONTENT -->
        
        <!-- MENSAJE SIN DATOS -->
        <div id="alertNoData" class="alert alert-info text-center mt-4 shadow-sm" style="display:none;">
            <i class="fas fa-database me-2"></i> No existen registros para el mes seleccionado.
        </div>

    </div>

    <script>
        // =========================================================================
        // CONFIGURACIÓN Y VARIABLES GLOBALES
        // =========================================================================
        const URL_SCRIPT_GOOGLE = "https://script.google.com/macros/s/AKfycbzGPVZhBkCWY1slly4ak4e4GlNo8QOj1ElePu406OZLyRf7RWRKyJseny5WyRybnzqg/exec";
        const CONTRASENA_ELIMINAR = "pisos2026";
        
        let chartMovimientos = null;
        let chartAspiradoras = null;
        let datosTablaGlobal = [];
        let datosFiltrados = [];
        let duplicadosDetectados = [];
        let tipoActual = '';
        let mesActual = '';
        let anioActual = '';
        let modalPDF = null;
        
        const mesesNombres = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];
        
        // =========================================================================
        // FUNCIONES DE INICIALIZACIÓN
        // =========================================================================
        
        function focusPDF() {
            const iframe = document.getElementById('iframePDF');
            if (iframe) {
                iframe.focus();
                try {
                    iframe.contentWindow.focus();
                } catch(e) {
                    // Si falla por política de seguridad
                }
            }
        }
        
        window.onload = function() {
            // Inicializar modal PDF
            const modalEl = document.getElementById('modalPDF');
            modalPDF = new bootstrap.Modal(modalEl);
            
            modalEl.addEventListener('shown.bs.modal', function() {
                setTimeout(focusPDF, 100);
            });
            
            // Llenar select de mes
            const selectMes = document.getElementById('filtroMes');
            mesesNombres.forEach((m, i) => {
                let opt = document.createElement('option');
                opt.value = (i + 1).toString().padStart(2, '0');
                opt.text = m;
                selectMes.appendChild(opt);
            });
            
            // Llenar select de año (año actual y anterior)
            const selectAnio = document.getElementById('filtroAnio');
            const currentYear = new Date().getFullYear();
            
            // Solo añadir año actual
            let optCurr = document.createElement('option');
            optCurr.value = currentYear;
            optCurr.text = currentYear;
            optCurr.selected = true;
            selectAnio.appendChild(optCurr);
            
            // Evento para filtro de tabla
            document.getElementById('filtroTabla').addEventListener('keyup', function() {
                filtrarTabla();
            });
            
            // NO cargar datos automáticamente - solo cuando el usuario haga clic en Generar Reporte
        };
        
        // =========================================================================
        // FUNCIONES DE INTERFAZ
        // =========================================================================
        
        function showLoading(mensaje, submensaje = "") {
            const overlay = document.getElementById('overlay');
            const msgTitle = document.querySelector('#loadingMessage h4');
            const msgSub = document.querySelector('#loadingMessage p');
            if(msgTitle) msgTitle.textContent = mensaje;
            if(msgSub) msgSub.textContent = submensaje;
            overlay.style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('overlay').style.display = 'none';
        }
        
        // =========================================================================
        // FUNCIÓN PARA DETECTAR DUPLICADOS
        // =========================================================================
        
        function detectarDuplicados(listaMovimientos) {
            const mapaDuplicados = new Map();
            
            // Crear clave única con fecha + aspiradora + colaborador + área
            listaMovimientos.forEach((item, index) => {
                const clave = `${item.fecha}|${item.aspiradora}|${item.colaborador}|${item.area}`;
                
                if (!mapaDuplicados.has(clave)) {
                    mapaDuplicados.set(clave, {
                        clave: clave,
                        items: [item],
                        indices: [index]
                    });
                } else {
                    const grupo = mapaDuplicados.get(clave);
                    grupo.items.push(item);
                    grupo.indices.push(index);
                }
            });
            
            // Filtrar solo los que tienen más de un elemento
            const duplicados = [];
            for (const [clave, grupo] of mapaDuplicados.entries()) {
                if (grupo.items.length > 1) {
                    // Separar por /
                    const partes = clave.split('|');
                    duplicados.push({
                        fecha: partes[0],
                        aspiradora: partes[1],
                        colaborador: partes[2],
                        area: partes[3],
                        items: grupo.items,
                        indices: grupo.indices,
                        count: grupo.items.length
                    });
                }
            }
            
            return duplicados;
        }
        
        // =========================================================================
        // FUNCIÓN PARA MOSTRAR TABLA DE DUPLICADOS
        // =========================================================================
        
        function mostrarTablaDuplicados(duplicados) {
            const seccionDuplicados = document.getElementById('seccionDuplicados');
            const tablaCuerpo = document.getElementById('tablaDuplicadosCuerpo');
            const sinDuplicados = document.getElementById('sinDuplicados');
            const contador = document.getElementById('contadorDuplicados');
            
            if (duplicados.length === 0) {
                seccionDuplicados.style.display = 'none';
                return;
            }
            
            seccionDuplicados.style.display = 'block';
            contador.textContent = duplicados.length;
            tablaCuerpo.innerHTML = '';
            sinDuplicados.style.display = 'none';
            
            duplicados.forEach((dup, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold">${index + 1}</td>
                    <td class="fw-bold">${dup.fecha}</td>
                    <td>${dup.aspiradora}</td>
                    <td>${dup.colaborador}</td>
                    <td>${dup.area}</td>
                    <td class="text-center">
                        <span class="badge bg-danger">${dup.count} registros</span>
                    </td>
                `;
                tablaCuerpo.appendChild(tr);
            });
            
            // Guardar duplicados en variable global
            duplicadosDetectados = duplicados;
        }
        
        // =========================================================================
        // FUNCIÓN PRINCIPAL PARA CONSULTAR DATOS
        // =========================================================================
        
        function consultarDatos() {
            const tipo = document.getElementById('filtroTipo').value;
            const mesVal = document.getElementById('filtroMes').value;
            const anio = document.getElementById('filtroAnio').value;
            
            if (!tipo) {
                Swal.fire("Selección Requerida", "Por favor selecciona un tipo de movimiento.", "warning");
                return;
            }
            
            if (!mesVal || !anio) {
                Swal.fire("Datos Incompletos", "Por favor selecciona mes y año.", "warning");
                return;
            }
            
            showLoading("Consultando datos...", "Por favor espera un momento");
            
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('seccionDuplicados').style.display = 'none';
            document.getElementById('alertNoData').style.display = 'none';
            
            // Guardar valores actuales
            tipoActual = tipo;
            mesActual = mesVal;
            anioActual = anio;
            
            fetch(URL_SCRIPT_GOOGLE, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: "obtenerDatos", 
                    tipo: tipo, 
                    mes: mesVal, 
                    anio: anio 
                })
            })
            .then(res => res.json())
            .then(data => {
                hideLoading();
                if (data.status === "error") {
                    Swal.fire("Error", data.message, "error");
                    return;
                }
                
                renderizarDashboard(data.data, mesVal, anio, tipo);
                
                if (!data.data.existeHoja || data.data.totalMovimientos === 0) {
                    document.getElementById('alertNoData').style.display = 'block';
                }
            })
            .catch(err => {
                hideLoading();
                Swal.fire("Error", "Problema de conexión con el servidor.", "error");
                console.error("Error:", err);
            });
        }
        
        // =========================================================================
        // FUNCIÓN PARA RENDERIZAR EL DASHBOARD
        // =========================================================================
        
        function renderizarDashboard(data, mesVal, anio, tipo) {
            document.getElementById('dashboardContent').style.display = 'block';
            datosTablaGlobal = data.listaMovimientos || [];
            
            // Procesar datos para asegurar que tengan hora y orden correcto
            if (datosTablaGlobal) {
                datosTablaGlobal.forEach(mov => {
                    // Si no viene hora del servidor, intentar extraerla de fecha_orden
                    if (!mov.hora && mov.fecha_orden) {
                        const fechaObj = new Date(mov.fecha_orden);
                        if (!isNaN(fechaObj.getTime())) {
                            mov.hora = fechaObj.toISOString();
                        }
                    }
                    
                    // Crear fecha_orden_hora combinando fecha y hora
                    if (mov.hora) {
                        mov.fecha_orden_hora = mov.hora;
                    } else if (mov.fecha_orden) {
                        mov.fecha_orden_hora = mov.fecha_orden;
                    } else if (mov.fecha) {
                        // Parsear fecha en formato español (dd/mm/aaaa)
                        const partes = mov.fecha.split('/');
                        if (partes.length === 3) {
                            mov.fecha_orden_hora = new Date(partes[2], partes[1] - 1, partes[0]).toISOString();
                        }
                    }
                });
            }
            
            // Detectar duplicados
            const duplicados = detectarDuplicados(datosTablaGlobal);
            mostrarTablaDuplicados(duplicados);
            
            // Actualizar KPI's según el tipo
            const tipoTexto = tipo === 'salidas' ? 'Salidas' : 'Entradas';
            document.getElementById('kpiLabel').textContent = tipoTexto;
            document.getElementById('kpiTotal').textContent = data.totalMovimientos || 0;
            document.getElementById('kpiAspiradoras').textContent = data.aspiradorasUnicas || 0;
            
            const nombreMes = mesesNombres[parseInt(mesVal) - 1];
            
            // Configuración común para gráficos
            const commonOpts = (titulo) => ({
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { 
                    title: { 
                        display: true, 
                        text: titulo, 
                        font: {size: 14, weight: 'bold'},
                        color: '#2c3e50',
                        padding: {top: 10, bottom: 20}
                    }, 
                    legend: { 
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(44, 62, 80, 0.9)',
                        titleColor: '#ecf0f1',
                        bodyColor: '#ecf0f1',
                        padding: 10,
                        cornerRadius: 6
                    }
                }
            });
            
            // Gráfico de movimientos por día
            const ctxMovimientos = document.getElementById('chartMovimientos');
            if (chartMovimientos) chartMovimientos.destroy();
            
            chartMovimientos = new Chart(ctxMovimientos, {
                type: 'bar',
                data: {
                    labels: data.datosGraficoDia?.labels || [],
                    datasets: [{
                        label: tipoTexto,
                        data: data.datosGraficoDia?.data || [],
                        backgroundColor: tipo === 'salidas' ? 'rgba(231, 76, 60, 0.8)' : 'rgba(46, 204, 113, 0.8)',
                        borderRadius: 4,
                        borderWidth: 1,
                        borderColor: tipo === 'salidas' ? '#c0392b' : '#27ae60'
                    }]
                },
                options: { 
                    ...commonOpts(`${tipoTexto} por Día - ${nombreMes} ${anio}`), 
                    scales: { 
                        x: { 
                            grid: { display: false },
                            title: {
                                display: true, 
                                text: 'Día del mes',
                                font: { weight: 'bold' }
                            } 
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            title: {
                                display: true,
                                text: 'Cantidad de Movimientos',
                                font: { weight: 'bold' }
                            },
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    } 
                }
            });
            
            // Gráfico de aspiradoras - DIFERENTE PARA SALIDAS Y ENTRADAS
            const ctxAspiradoras = document.getElementById('chartAspiradoras');
            if (chartAspiradoras) chartAspiradoras.destroy();
            
            // Cambiar etiqueta según tipo
            document.getElementById('chartAspiradorasLabel').textContent = 
                tipo === 'salidas' ? 'Aspiradoras más usadas (Top 10)' : 'Aspiradoras devueltas (Top 10)';
            
            if (tipo === 'salidas' && data.rankingAspiradoras && data.rankingAspiradoras.length > 0) {
                // Para salidas: Ranking de aspiradoras más usadas
                const rankingTop10 = data.rankingAspiradoras.slice(0, 10);
                
                chartAspiradoras = new Chart(ctxAspiradoras, {
                    type: 'bar',
                    data: {
                        labels: rankingTop10.map(item => item.nombre),
                        datasets: [{
                            label: 'Usos',
                            data: rankingTop10.map(item => item.movimientos),
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                            borderRadius: 4,
                            borderWidth: 1,
                            borderColor: '#2980b9'
                        }]
                    },
                    options: { 
                        ...commonOpts(`Aspiradoras Más Usadas - ${nombreMes} ${anio}`), 
                        indexAxis: 'y',
                        scales: { 
                            x: { 
                                beginAtZero: true,
                                ticks: { stepSize: 1 },
                                title: {
                                    display: true, 
                                    text: 'Cantidad de Usos',
                                    font: { weight: 'bold' }
                                },
                                grid: { color: 'rgba(0,0,0,0.05)' }
                            },
                            y: {
                                ticks: {
                                    autoSkip: false,
                                    maxRotation: 0
                                },
                                grid: { display: false }
                            }
                        } 
                    }
                });
            } else if (tipo === 'entradas') {
                // Para entradas: Mostrar gráfico de devoluciones por aspiradora
                if (data.listaMovimientos && data.listaMovimientos.length > 0) {
                    // Contar devoluciones por aspiradora
                    const conteoDevoluciones = {};
                    data.listaMovimientos.forEach(mov => {
                        const aspiradora = mov.aspiradora;
                        if (!conteoDevoluciones[aspiradora]) {
                            conteoDevoluciones[aspiradora] = 0;
                        }
                        conteoDevoluciones[aspiradora]++;
                    });
                    
                    // Convertir a array y ordenar
                    const rankingDevoluciones = Object.entries(conteoDevoluciones)
                        .map(([nombre, movimientos]) => ({ nombre, movimientos }))
                        .sort((a, b) => b.movimientos - a.movimientos)
                        .slice(0, 10); // Tomar solo top 10
                    
                    if (rankingDevoluciones.length > 0) {
                        chartAspiradoras = new Chart(ctxAspiradoras, {
                            type: 'bar',
                            data: {
                                labels: rankingDevoluciones.map(item => item.nombre),
                                datasets: [{
                                    label: 'Devoluciones',
                                    data: rankingDevoluciones.map(item => item.movimientos),
                                    backgroundColor: 'rgba(46, 204, 113, 0.8)',
                                    borderRadius: 4,
                                    borderWidth: 1,
                                    borderColor: '#27ae60'
                                }]
                            },
                            options: { 
                                ...commonOpts(`Aspiradoras Devueltas - ${nombreMes} ${anio}`), 
                                indexAxis: 'y',
                                scales: { 
                                    x: { 
                                        beginAtZero: true,
                                        ticks: { stepSize: 1 },
                                        title: {
                                            display: true, 
                                            text: 'Cantidad de Devoluciones',
                                            font: { weight: 'bold' }
                                        },
                                        grid: { color: 'rgba(0,0,0,0.05)' }
                                    },
                                    y: {
                                        ticks: {
                                            autoSkip: false,
                                            maxRotation: 0
                                        },
                                        grid: { display: false }
                                    }
                                } 
                            }
                        });
                    } else {
                        // Si no hay datos, mostrar gráfico vacío
                        mostrarGraficoVacio(ctxAspiradoras, `Devoluciones - ${nombreMes} ${anio}`);
                    }
                } else {
                    // Si no hay datos, mostrar gráfico vacío
                    mostrarGraficoVacio(ctxAspiradoras, `Devoluciones - ${nombreMes} ${anio}`);
                }
            }
            
            // Renderizar tabla
            datosFiltrados = [...datosTablaGlobal];
            filtrarTabla();
        }
        
        // =========================================================================
        // FUNCIÓN PARA MOSTRAR GRÁFICO VACÍO
        // =========================================================================
        
        function mostrarGraficoVacio(ctx, titulo) {
            chartAspiradoras = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Sin datos'],
                    datasets: [{
                        label: 'Sin datos',
                        data: [0],
                        backgroundColor: 'rgba(149, 165, 166, 0.3)',
                        borderRadius: 4,
                        borderWidth: 1,
                        borderColor: '#7f8c8d'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: titulo,
                            font: { size: 14, weight: 'bold' },
                            color: '#2c3e50',
                            padding: { top: 10, bottom: 20 }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            max: 1,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        }
                    }
                }
            });
        }
        
        // =========================================================================
        // FUNCIONES PARA FILTRAR TABLA
        // =========================================================================
        
        function filtrarTabla() {
            const textoBusqueda = document.getElementById('filtroTabla').value.toLowerCase();
            
            // Aplicar filtros
            datosFiltrados = datosTablaGlobal.filter(item => {
                // Filtro por texto de búsqueda
                if (textoBusqueda) {
                    const match = 
                        (item.aspiradora && item.aspiradora.toLowerCase().includes(textoBusqueda)) ||
                        (item.colaborador && item.colaborador.toLowerCase().includes(textoBusqueda)) ||
                        (item.area && item.area.toLowerCase().includes(textoBusqueda)) ||
                        (item.fecha && item.fecha.includes(textoBusqueda));
                    
                    if (!match) return false;
                }
                
                return true;
            });
            
            renderizarTabla(datosFiltrados);
        }
        
        // =========================================================================
        // FUNCIÓN PARA RENDERIZAR TABLA
        // =========================================================================
        
        function renderizarTabla(lista) {
            const tbody = document.getElementById('tablaCuerpo');
            const aviso = document.getElementById('sinResultadosFiltro');
            tbody.innerHTML = '';
            
            if (lista.length === 0) {
                aviso.style.display = 'block'; 
                return;
            }
            aviso.style.display = 'none';
            
            // Ordenar por fecha Y hora (más reciente primero)
            lista.sort((a, b) => {
                // Si ya tenemos fecha_orden_hora, usarla (será la más precisa)
                if (a.fecha_orden_hora && b.fecha_orden_hora) {
                    return new Date(b.fecha_orden_hora) - new Date(a.fecha_orden_hora);
                }
                
                // Si no, construir fecha completa a partir de fecha y hora separadas
                let fechaA, fechaB;
                
                if (a.fecha && a.hora) {
                    // Combinar fecha y hora
                    fechaA = new Date(`${a.fecha} ${a.hora}`);
                } else if (a.fecha_orden) {
                    // Usar solo fecha
                    fechaA = new Date(a.fecha_orden);
                } else if (a.fecha) {
                    // Parsear fecha en formato español
                    const partesA = a.fecha.split('/');
                    fechaA = new Date(partesA[2], partesA[1] - 1, partesA[0]);
                } else {
                    fechaA = new Date(0); // Fecha muy antigua
                }
                
                if (b.fecha && b.hora) {
                    fechaB = new Date(`${b.fecha} ${b.hora}`);
                } else if (b.fecha_orden) {
                    fechaB = new Date(b.fecha_orden);
                } else if (b.fecha) {
                    const partesB = b.fecha.split('/');
                    fechaB = new Date(partesB[2], partesB[1] - 1, partesB[2]);
                } else {
                    fechaB = new Date(0);
                }
                
                // Orden descendente (más reciente primero)
                return fechaB - fechaA;
            });
            
            lista.forEach((item, index) => {
                // Botones de acciones
                let botones = '';
                
                if (item.url && item.url.includes('http')) {
                    const btnVer = `<button class="btn btn-action btn-pdf" onclick="verPDF('${item.url}')" title="Ver Acta">
                                        <i class="fas fa-eye"></i>
                                    </button>`;
                    
                    const btnDownload = `<button class="btn btn-action btn-download" onclick="descargarPDF('${item.url}')" title="Descargar">
                                            <i class="fas fa-download"></i>
                                         </button>`;
                    
                    const btnDelete = `<button class="btn btn-action btn-delete" onclick="confirmarEliminar(${index})" title="Eliminar">
                                            <i class="fas fa-trash-alt"></i>
                                       </button>`;
                    
                    botones = `<div class="d-flex justify-content-center">
                                ${btnVer} ${btnDownload} ${btnDelete}
                               </div>`;
                } else {
                    const btnDelete = `<button class="btn btn-action btn-delete" onclick="confirmarEliminar(${index})" title="Eliminar">
                                            <i class="fas fa-trash-alt"></i>
                                       </button>`;
                    
                    botones = `<div class="d-flex justify-content-center">
                                ${btnDelete}
                               </div>`;
                }
                
                // Mostrar hora si está disponible
                let fechaCompleta = item.fecha;
                if (item.hora) {
                    // Formatear hora para mostrar
                    const horaObj = new Date(item.hora);
                    if (!isNaN(horaObj.getTime())) {
                        const horaFormateada = horaObj.toLocaleTimeString('es-ES', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        fechaCompleta = `${item.fecha} ${horaFormateada}`;
                    }
                }
                
                // Verificar si este registro es duplicado
                const esDuplicado = duplicadosDetectados.some(dup => 
                    dup.fecha === item.fecha && 
                    dup.aspiradora === item.aspiradora && 
                    dup.colaborador === item.colaborador && 
                    dup.area === item.area
                );
                
                const badgeDuplicado = esDuplicado ? 
                    `<span class="badge-duplicate"><i class="fas fa-copy me-1"></i>Duplicado</span>` : '';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold">${fechaCompleta}</td>
                    <td class="fw-bold">${item.aspiradora} ${badgeDuplicado}</td>
                    <td>${item.colaborador}</td>
                    <td>${item.area}</td>
                    <td class="text-center">
                        ${botones}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // =========================================================================
        // FUNCIONES PARA MANEJO DE PDF
        // =========================================================================
        
        function verPDF(url) {
            if(!url) return;
            
            // Convertir URL de view a preview para mostrar dentro del iframe
            let previewUrl = url;
            if (url.includes('/view')) {
                previewUrl = url.replace(/\/view.*/, '/preview');
            }
            
            document.getElementById('iframePDF').src = previewUrl;
            modalPDF.show();
        }
        
        function getDriveId(url) {
            if (!url) return null;
            let match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) return match[1];
            match = url.match(/id=([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }
        
        function descargarPDF(url) {
            const id = getDriveId(url);
            if (id) {
                const downloadLink = `https://drive.google.com/uc?export=download&id=${id}`;
                window.open(downloadLink, '_blank');
            } else {
                Swal.fire('Error', 'No se pudo obtener el ID del archivo', 'error');
            }
        }
        
        // =========================================================================
        // FUNCIÓN PARA ELIMINAR REGISTRO INDIVIDUAL
        // =========================================================================
        
        function confirmarEliminar(index) {
            const item = datosFiltrados[index];
            if (!item) return;

            Swal.fire({
                title: 'Eliminar Reporte',
                text: 'Ingresa la contraseña para confirmar la eliminación:',
                input: 'password',
                inputAttributes: {
                    autocapitalize: 'off',
                    placeholder: 'Contraseña'
                },
                showCancelButton: true,
                confirmButtonText: 'Eliminar',
                confirmButtonColor: '#e74c3c',
                cancelButtonText: 'Cancelar',
                allowOutsideClick: false,
                backdrop: `rgba(43, 62, 80, 0.8)`,
                preConfirm: (password) => {
                    if (password !== CONTRASENA_ELIMINAR) {
                        Swal.showValidationMessage('Contraseña incorrecta');
                        return false;
                    }
                    return password;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    ejecutarEliminacion(item);
                }
            });
        }
        
        function ejecutarEliminacion(item) {
            showLoading("Eliminando registro...", "Por favor espera");
            
            fetch(URL_SCRIPT_GOOGLE, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: "eliminarReporte", 
                    tipo: tipoActual, 
                    mes: mesActual, 
                    anio: anioActual,
                    fila: item.fila,
                    url: item.url,
                    contrasena: CONTRASENA_ELIMINAR
                })
            })
            .then(res => res.json())
            .then(data => {
                hideLoading();
                
                if (data.status === "success") {
                    Swal.fire({
                        icon: 'success',
                        title: 'Eliminado',
                        text: data.data.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        // Recargar datos
                        consultarDatos();
                    });
                } else {
                    Swal.fire("Error", data.message, "error");
                }
            })
            .catch(err => {
                hideLoading();
                Swal.fire("Error", "Problema de conexión con el servidor.", "error");
            });
        }
        
        // =========================================================================
        // FUNCIÓN PARA ELIMINAR TODOS LOS DUPLICADOS
        // =========================================================================
        
        function confirmarEliminarDuplicados() {
            if (duplicadosDetectados.length === 0) {
                Swal.fire("Sin duplicados", "No hay registros duplicados para eliminar.", "info");
                return;
            }
            
            // Calcular total de registros a eliminar (todos menos uno por grupo)
            let totalAEliminar = 0;
            duplicadosDetectados.forEach(dup => {
                totalAEliminar += (dup.items.length - 1); // Dejamos uno, eliminamos los demás
            });
            
            Swal.fire({
                title: 'Eliminar Todos los Duplicados',
                html: `Se eliminarán <strong>${totalAEliminar}</strong> registros duplicados.<br><br>
                      <small class="text-muted">Se dejará solo un registro por cada grupo de duplicados.</small><br><br>
                      Ingresa la contraseña para confirmar:`,
                input: 'password',
                inputAttributes: {
                    autocapitalize: 'off',
                    placeholder: 'Contraseña'
                },
                showCancelButton: true,
                confirmButtonText: 'Eliminar Duplicados',
                confirmButtonColor: '#e74c3c',
                cancelButtonText: 'Cancelar',
                allowOutsideClick: false,
                backdrop: `rgba(43, 62, 80, 0.8)`,
                preConfirm: (password) => {
                    if (password !== CONTRASENA_ELIMINAR) {
                        Swal.showValidationMessage('Contraseña incorrecta');
                        return false;
                    }
                    return password;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    ejecutarEliminacionDuplicados();
                }
            });
        }
        
        function ejecutarEliminacionDuplicados() {
            showLoading("Eliminando duplicados...", `Procesando ${duplicadosDetectados.length} grupos de duplicados`);
            
            // Preparar datos para eliminar
            const registrosAEliminar = [];
            
            // Para cada grupo de duplicados, dejamos el primero (más reciente) y eliminamos los demás
            duplicadosDetectados.forEach(grupo => {
                // Ordenar por fecha/hora (más reciente primero)
                const ordenados = [...grupo.items].sort((a, b) => {
                    const fechaA = a.fecha_orden_hora ? new Date(a.fecha_orden_hora) : new Date(0);
                    const fechaB = b.fecha_orden_hora ? new Date(b.fecha_orden_hora) : new Date(0);
                    return fechaB - fechaA; // Descendente
                });
                
                // Dejar el primero (más reciente), eliminar los demás
                for (let i = 1; i < ordenados.length; i++) {
                    registrosAEliminar.push(ordenados[i]);
                }
            });
            
            if (registrosAEliminar.length === 0) {
                hideLoading();
                Swal.fire("Operación completada", "No había duplicados para eliminar.", "success");
                return;
            }
            
            // Enviar solicitud al servidor para eliminar todos los duplicados
            fetch(URL_SCRIPT_GOOGLE, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: "eliminarDuplicados", 
                    tipo: tipoActual, 
                    mes: mesActual, 
                    anio: anioActual,
                    registros: registrosAEliminar.map(r => ({
                        fila: r.fila,
                        url: r.url
                    })),
                    contrasena: CONTRASENA_ELIMINAR
                })
            })
            .then(res => res.json())
            .then(data => {
                hideLoading();
                
                if (data.status === "success") {
                    Swal.fire({
                        icon: 'success',
                        title: 'Duplicados Eliminados',
                        html: `Se eliminaron <strong>${registrosAEliminar.length}</strong> registros duplicados.<br><br>
                              <small class="text-muted">${data.data.message || ''}</small>`,
                        timer: 3000,
                        showConfirmButton: false
                    }).then(() => {
                        // Recargar datos
                        consultarDatos();
                    });
                } else {
                    Swal.fire("Error", data.message, "error");
                }
            })
            .catch(err => {
                hideLoading();
                Swal.fire("Error", "Problema de conexión con el servidor.", "error");
            });
        }

    </script>
</body>
</html>
