
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pisos Brillantes</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Estilos para el bloqueo de contraseña */
    #password-protection {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      flex-direction: column;
    }
    
    #password-form {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
      position: relative;
    }
    
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    #password-input {
      width: 90%;
      padding: 12px;
      margin: 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    #password-submit {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
    }
    
    #password-submit:hover {
      background-color: #0069d9;
    }
    
    #password-error {
      color: #dc3545;
      margin-top: 10px;
      display: none;
    }

    /* Estilos similares a la página de requisición */
    .header {
      background-color: #007BFF;
      color: white;
      text-align: center;
      padding: 15px 0;
      font-size: 1.5em;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-top: 20px;
      font-size: 24px;
      margin-bottom: 30px;
    }
    
    .form-container {
      width: 80%;
      max-width: 1300px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 44px 8px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 0.9em;
    }

    /* Modificación aquí para hacer el encabezado fijo */
    th {
      background-color: #007BFF;
      color: white;
      font-weight: bold;
      position: sticky; /* Hace el encabezado pegajoso */
      top: 0;          /* Lo fija en la parte superior del contenedor de desplazamiento */
      z-index: 10;     /* Asegura que esté por encima del contenido cuando se desplaza */
    }

    th, td {
      padding: 12px 15px;
      text-align: center; /* CENTRADO: Para encabezados y celdas */
      border-bottom: 1px solid #ddd;
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }

    .cantidad-input, .nivel-input { /* MODIFICADO: Eliminado .cuerpos-bajos-select de aquí */
      width: 40px; /* REDUCIDO: Tamaño de las cajas de texto */
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }

    .cuerpos-bajos-select { /* NUEVO: Estilo específico para el select de Cuerpos Bajos */
        width: auto; /* Restaurado a tamaño automático */
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
    }

    .button-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 20px; /* Espacio entre los botones */
    }
    
    .button-container button {
      font-size: 16px;
      padding: 12px 24px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #btn-resumen {
        background-color: #007BFF; /* Color diferente para el botón Resumen */
    }

    #btn-resumen:hover {
        background-color: #0069d9;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .estado-pendiente {
      color: white;
      background-color: #dc3545;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
    }

    .estado-completo {
      color: white;
      background-color: #28a745;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
    }

  /* Contenedor de la tabla para desplazamiento */
  .table-container {
    width: 100%;
    /* overflow-x: visible;  No siempre es necesario, se ajusta con el sticky */
    max-height: 60vh; /* Ajusta la altura máxima para que haya scroll */
    overflow-y: auto; /* Permite el desplazamiento vertical */
  }
  
  /* Estilos para pantallas pequeñas (menos de 768px) */
  @media screen and (max-width: 768px) {
    .table-container {
      overflow-x: auto; /* Activa el desplazamiento horizontal */
      -webkit-overflow-scrolling: touch; /* Mejor desplazamiento en iOS */
    }
    
    /* Opcional: puedes ajustar el tamaño de fuente para móviles */
    table {
      font-size: 0.8em;
    }
    
    th, td {
      padding: 8px 10px;
    }
  }

#overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  flex-direction: column;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(0, 123, 255, 0.2);
  border-radius: 50%;
  border-top-color: #007BFF;
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 20px;
}

#loadingMessage {
  text-align: center;
  color: #333;
  font-family: Arial, sans-serif;
}

#loadingMessage h3 {
  margin: 0 0 10px;
  font-size: 1.2em;
}

#loadingMessage p {
  margin: 0;
  color: #666;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

    .search-container {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
    }
    
    #search-input {
      width: 70%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    #search-input:focus {
      outline: none;
      border-color: #007BFF;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    
    .no-results {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    /* Estilos para el botón "Agregar Más" y la nueva columna */
    .add-more-btn {
      background-color: #28a745; /* Verde */
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      margin-left: 10px;
    }

    .add-more-btn:hover {
      background-color: #218838;
    }

    .delete-entry-btn {
        background-color: #dc3545; /* Rojo */
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85em;
        /* margin-left: 10px; Eliminar para el contenedor flex */
    }

    .delete-entry-btn:hover {
        background-color: #c82333;
    }

    /* Nuevos estilos para los botones de confirmación */
    .confirm-delete-btn {
        background-color: #28a745; /* Verde para Confirmar */
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.1em; /* Un poco más grande para los iconos */
        font-weight: bold;
    }
    .confirm-delete-btn:hover {
        background-color: #218838;
    }
    .cancel-delete-btn {
        background-color: #dc3545; /* Rojo para Cancelar */
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.1em; /* Un poco más grande para los iconos */
        font-weight: bold;
    }
    .cancel-delete-btn:hover {
        background-color: #c82333;
    }


    /* Estilos para las filas adicionales generadas */
    .additional-entry {
        background-color: #e9ecef; /* Un color ligeramente diferente para distinguirlas */
    }

    /* Estilos para los botones +/- */
    .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center; /* CENTRADO: Controles de cantidad */
        gap: 5px; /* Espacio entre el botón y el input */
    }

    .quantity-button {
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        line-height: 1; /* Alineación vertical */
        width: 30px; /* Ancho fijo para botones */
        height: 30px; /* Altura fija para botones */
        display: flex;
        justify-content: center;
        align-items: center;
        flex-shrink: 0; /* Evita que se encojan */
    }

    .quantity-button:hover {
    }

    .quantity-minus-button {
        background-color: #dc3545; /* Rojo */
    }

    .quantity-minus-button:hover {
        background-color: #c82333; /* Rojo más oscuro */
    }

    .quantity-plus-button {
        background-color: #28a745; /* Verde */
    }

    .quantity-plus-button:hover {
        background-color: #218838; /* Verde más oscuro */
    }


    .quantity-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .cantidad-input {
        flex-grow: 0; /* MODIFICADO: Evita que el input crezca */
        min-width: 40px; /* Asegura un ancho mínimo para el input */
        width: 40px; /* MODIFICADO: Ancho fijo para el input de cantidad */
    }

    /* Estilos para la ventana modal de resumen */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 10000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 900px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
    }

    .close-modal-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
    }

    .close-modal-btn:hover,
    .close-modal-btn:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    #resumen-tabla-container {
        max-height: 70vh; /* Altura máxima para la tabla de resumen */
        overflow-y: auto;
        margin-top: 20px;
    }

    #resumen-tabla {
        width: 100%;
        border-collapse: collapse;
    }

    /* Centrar celdas de la tabla de resumen */
    #resumen-tabla th, #resumen-tabla td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center; /* AHORA CENTRADO */
    }

    #resumen-tabla th {
        background-color: #007BFF;
        color: white;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    #resumen-tabla tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    #resumen-tabla tbody tr:hover {
        background-color: #ddd;
    }

    /* Estilos para el campo de búsqueda del resumen */
    .resumen-search-container {
      margin-bottom: 15px;
      text-align: center;
    }

    #resumen-search-input {
      width: 80%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1em;
    }

    /* Estilos para el pie de tabla de resumen */
    #resumen-tabla tfoot {
      font-weight: bold;
      background-color: #e0e0e0;
    }
    #resumen-tabla tfoot td {
      border-top: 2px solid #007BFF;
      padding-top: 10px;
    }

    /* NUEVOS ESTILOS para los totales fuera de la tabla */
    #resumen-totals-section {
        margin-top: 20px;
        /* text-align: right; */ /* Eliminado para permitir text-align: left en product-sums */
        font-weight: bold;
        padding: 10px;
        border-top: 2px solid #007BFF;
        background-color: #e9ecef;
        border-radius: 4px;
        /* INICIO DE CAMBIO: Ocultar por defecto */
        display: none; 
        /* FIN DE CAMBIO */
    }
    
    #resumen-product-sums {
        text-align: left; /* Asegura que la lista de productos esté a la izquierda */
        margin-top: 0px; /* Eliminado el margen superior para que no haya espacio extra */
        font-weight: normal; /* Los items individuales no son tan negrita como el total */
        /* border-top: 1px solid #ccc; */ /* Eliminado el borde superior */
        padding-top: 0px; /* Eliminado el padding superior */
    }
    
    #resumen-product-sums h4 {
        margin-top: 0;
        margin-bottom: 8px;
        color: #333;
        font-size: 1.1em; /* Ligeramente más grande para el título */
    }
    
    #resumen-product-sums p {
        margin: 4px 0;
        padding-left: 10px;
    }

    /* Estilo para centrar el título del modal */
    .modal-title {
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px;
        color: #333;
        font-size: 1.5em;
    }
    /* Estilo para el botón de PDF */
    #btn-generar-pdf {
        background-color: #dc3545; /* Rojo para PDF */
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-left: 10px; /* Espacio para separarlo del filtro */
    }

    #btn-generar-pdf:hover {
        background-color: #c82333;
    }

    /* Estilos para el contenedor de fechas y botón de carga */
    .date-filter-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px; /* Espacio entre los elementos */
        margin-bottom: 20px;
        flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
    }

    .date-filter-container label {
        font-weight: bold;
        color: #333;
    }

    /* ESTILOS DE FECHA MEJORADOS */
    .date-filter-container input[type="date"] {
        padding: 8px 12px;
        border: 1px solid #ccc; /* Cambiado a un gris más neutro */
        border-radius: 6px; /* Ligeramente más redondeado */
        font-size: 1em;
        -webkit-appearance: none; /* Eliminar estilo predeterminado en algunos navegadores */
        -moz-appearance: none;
        appearance: none;
        background-color: #f8f8f8; /* Fondo ligeramente gris */
        cursor: pointer; /* Indica que es clickeable */
        transition: border-color 0.2s ease, box-shadow 0.2s ease; /* Transición suave */
    }

    .date-filter-container input[type="date"]::-webkit-calendar-picker-indicator {
        /* Estilo para el ícono del calendario en navegadores Webkit (Chrome, Edge, Safari) */
        background: none; /* Elimina el fondo por defecto del ícono */
        color: #007BFF; /* Color del ícono */
        font-size: 1.2em; /* Tamaño del ícono */
        cursor: pointer;
        opacity: 1; /* Asegura que sea visible */
        /* Para darle un color azul similar al tema */
        -webkit-filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg); 
        filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg);
    }

    .date-filter-container input[type="date"]:hover {
        border-color: #007BFF; /* Borde azul al pasar el ratón */
    }

    .date-filter-container input[type="date"]:focus {
        outline: none;
        border-color: #007BFF;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); /* Sombra más pronunciada al enfocar */
        background-color: #ffffff; /* Fondo blanco al enfocar */
    }

    #btn-cargar-resumen-fechas {
        background-color: #28a745; /* Verde similar al botón de enviar devoluciones */
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
    }

    #btn-cargar-resumen-fechas:hover {
        background-color: #218838;
    }

    /* Estilos para el botón de gráficos */
    #btn-mostrar-graficos {
        background-color: #6f42c1; /* Color morado para gráficos */
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-left: 10px;
    }

    #btn-mostrar-graficos:hover {
        background-color: #5a32a3;
    }

    /* Estilos para el modal de gráficos */
    #graficosModal {
      display: none;
      position: fixed;
      z-index: 10001; /* Mayor que el modal de resumen */
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }

    .graficos-modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 1200px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
    }

    .graficos-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-top: 20px;
    }

    .grafico-item {
      flex: 1 1 45%;
      min-width: 400px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .grafico-item h3 {
      text-align: center;
      margin-top: 0;
      color: #333;
    }

    .grafico-canvas {
      width: 100% !important;
      height: 300px !important;
    }

    /* Estilos para el selector de tipo de gráfico */
    .chart-type-selector {
      margin-bottom: 20px;
      text-align: center;
    }

    .chart-type-selector select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1em;
      background-color: #f8f8f8;
      cursor: pointer;
    }

    .chart-type-selector select:focus {
      outline: none;
      border-color: #007BFF;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    /* Nuevos estilos para los contenedores de gráficos por edificio y producto */
    .graficos-productos-container, .graficos-edificios-container {
      width: 100%;
      margin-top: 20px;
    }

    .graficos-productos-container h3, .graficos-edificios-container h3 {
      text-align: center;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #007BFF;
      padding-bottom: 5px;
    }

    .graficos-productos-grid, .graficos-edificios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 10px;
    }


.grafico-item {
    flex: 1 1 400px; /* Tamaño mínimo de 400px pero flexible */
    margin: 10px;
    max-width: 45%; /* Máximo 45% del contenedor */
}




.btn-generar-pdf {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s;
    margin-bottom: 15px;
}

.btn-generar-pdf:hover {
    background-color: #c82333;
}

.btn-generar-pdf:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
}


  </style>
</head>
<body>
  <div id="password-protection">
    <div id="password-form">
      <button class="close-btn" onclick="cerrarDialogoContrasena()">&times;</button>
      <h2>Confirmar Acción</h2>
      <p>Ingrese la contraseña para procesar las devoluciones</p>
      <input type="password" id="password-input" placeholder="Contraseña" autocomplete="off">
      <button id="password-submit">Verificar</button>
      <div id="password-error">Contraseña incorrecta. Intente nuevamente.</div>
    </div>
  </div>

  <div id="main-content">
    <div class="header">Pisos Brillantes</div>
    
    <div class="form-container">
      <h1>Devoluciones de Productos</h1>

      <div class="search-container">
        <input type="text" id="search-input" placeholder="Buscar por Edificio o Producto..." oninput="filtrarTabla()" autocomplete="off">
      </div>

      <div id="tabla-devoluciones-container" class="table-container">
          <table id="tabla-devoluciones">
          <thead>
            <tr>
              <th>Edificio</th>
              <th>Producto</th>
              <th>Cantidad Pendiente</th>
              <th>Devolver</th>
              <th>Nivel</th>
              <th>Cuerpos Bajos</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="devoluciones-body">
            </tbody>
        </table>
      </div>

      <div class="button-container">
        <button type="button" id="btn-enviar" disabled onclick="verificarAutenticacion()">Enviar Devoluciones</button>
        <button type="button" id="btn-resumen" onclick="abrirModalResumen()">Resumen</button>
      </div>
    </div>

    <div id="overlay">
      <div class="spinner"></div>
      <div id="loadingMessage">
        <h4>Por favor espera un momento...</h4>
        <p></p>
      </div>
    </div>
  </div>

  <div id="resumenModal" class="modal">
    <div class="modal-content">
      <span class="close-modal-btn" onclick="cerrarModalResumen()">&times;</span>
      <h2 class="modal-title">Resumen de Gasto de Insumos</h2>
      
      <div class="date-filter-container">
        <label for="fecha-inicio-resumen">Desde:</label>
        <input type="date" id="fecha-inicio-resumen">
        <label for="fecha-fin-resumen">Hasta:</label>
        <input type="date" id="fecha-fin-resumen">
        <button type="button" id="btn-cargar-resumen-fechas" onclick="cargarResumenDevoluciones()">Cargar Resumen</button>
        <button type="button" id="btn-generar-pdf" onclick="generarPDFResumen()">Generar PDF</button>

        <button type="button" id="btn-mostrar-graficos" onclick="abrirModalGraficos()">Mostrar Gráficos</button>

      </div>

      <div class="resumen-search-container">
        <input type="text" id="resumen-search-input" placeholder="Filtrar por Edificio, Nivel o Producto (separado por espacios)" oninput="filtrarResumen()" autocomplete="off">
      </div>

      <div id="resumen-tabla-container">
        <table id="resumen-tabla">
          <thead>
            <tr>
              <th>Edificio</th>
              <th>Nivel</th>
              <th>Producto</th>
              <th>Total de Consumo</th>
            </tr>
          </thead>
          <tbody id="resumen-tbody">
            </tbody>
        </table>
      </div>

      <div id="resumen-totals-section">
          <div id="resumen-product-sums">
              </div>
      </div>
    </div>
  </div>

  <!-- Nuevo modal para gráficos -->
  <div id="graficosModal" class="modal">
    <div class="graficos-modal-content">
      <span class="close-modal-btn" onclick="cerrarModalGraficos()">&times;</span>
      <h2 class="modal-title">Gráficos de Consumo</h2>
      
      <div class="chart-type-selector">
        <label for="chart-type">Tipo de Gráfico: </label>
        <select id="chart-type" onchange="actualizarGraficos()">
          <option value="bar">Barras</option>
         <!--  <option value="pie">Torta</option> -->
          <option value="line">Líneas</option>
        </select>
      </div>
      
<div class="graficos-container" style="display: flex; flex-wrap: wrap; justify-content: center;">
        <div class="grafico-item">
          <h3>Consumo por Producto</h3>
          <canvas id="productoChart" class="grafico-canvas"></canvas>
        </div>
        
        <!-- Nuevo contenedor para gráficos por edificio por producto -->
        <div class="graficos-productos-container">
          <h3>Consumo por Edificio (por Producto)</h3>
          <div id="graficos-productos" class="graficos-productos-grid">
            <!-- Los gráficos se generarán dinámicamente aquí -->
          </div>
        </div>
        
        <!-- Nuevo contenedor para gráficos por nivel por edificio -->
        <div class="graficos-edificios-container">
          <h3>Consumo por Nivel (por Edificio)</h3>
          <div id="graficos-edificios" class="graficos-edificios-grid">
            <!-- Los gráficos se generarán dinámicamente aquí -->
          </div>
        </div>
        
        <div class="grafico-item">
          <h3>Consumo Diario</h3>
          <canvas id="diarioChart" class="grafico-canvas"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
  // Variables globales
  let devoluciones = []; // Stores all fetched pending returns (original data from sheet)
  let editedEntries = {}; 
  let entryCounter = 0; // To generate unique IDs for dynamically added entries
  let resumenData = []; // Store the fetched resumen data for filtering
  let filteredResumenData = []; // NUEVO: Para guardar los datos filtrados del resumen
  let allSummaryDates = []; // NUEVO: Para guardar todas las fechas recibidas del resumen del script
  let charts = {}; // Objeto para almacenar las instancias de los gráficos

  const CORRECT_PASSWORD = "macdel1";
  const AUTH_KEY = "pb_auth";
  const AUTH_EXPIRATION_HOURS = 24; // La autenticación dura 24 horas

  // Variables para el control de toques rápidos en el título del modal
  let tapCount = 0;
  let lastTapTime = 0;
  const TAP_THRESHOLD_MS = 500; // Tiempo máximo entre toques para que cuenten como rápidos

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('main-content').style.display = 'block';
    cargarDevolucionesPendientes();

    // INICIO DE CAMBIO: Listener para el título del modal para toques múltiples
    const modalTitle = document.querySelector('.modal-title');
    if (modalTitle) {
      modalTitle.addEventListener('click', function() {
        const currentTime = new Date().getTime();

        if (currentTime - lastTapTime < TAP_THRESHOLD_MS) {
          tapCount++;
          if (tapCount === 15) { // CAMBIADO: 15 toques para activar/desactivar
            const totalsSection = document.getElementById('resumen-totals-section');
            if (totalsSection.style.display === 'none') {
                totalsSection.style.display = 'block';
            } else {
                totalsSection.style.display = 'none';
            }
            tapCount = 0; // Reiniciar el contador después de activar/desactivar
          }
        } else {
          tapCount = 1; // Reiniciar si el tiempo entre toques es demasiado largo
        }
        lastTapTime = currentTime;
      });
    }
    // FIN DE CAMBIO
  });

  // INICIO DE CAMBIO: Listener para la combinación de teclas
  document.addEventListener('keydown', function(event) {
    // Check for Ctrl (or Cmd on Mac) + Shift + S
    if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'S') {
        const totalsSection = document.getElementById('resumen-totals-section');
        if (totalsSection.style.display === 'none') {
            totalsSection.style.display = 'block';
        } else {
            totalsSection.style.display = 'none';
        }
        event.preventDefault(); // Previene el comportamiento por defecto del navegador para esta combinación
    }
  });
  // FIN DE CAMBIO

  function verificarAutenticacion() {
    // Check if any quantity > 0
    const hasValidEntries = Object.values(editedEntries).some(entry => entry.cantidad > 0);

    if (!hasValidEntries) {
      Swal.fire('Advertencia', 'No has ingresado cantidades para devolver (deben ser mayores a 0).', 'warning');
      return;
    }
    
    const authData = obtenerAuthData();
    
    if (authData && authData.authenticated && !haExpiradoAuth(authData.fecha)) {
      enviarDevoluciones();
    } else {
      solicitarContrasena();
    }
  }

  function obtenerAuthData() {
    const authData = localStorage.getItem(AUTH_KEY);
    return authData ? JSON.parse(authData) : null;
  }

  function haExpiradoAuth(fechaAuth) {
    const fechaAuthObj = new Date(fechaAuth);
    const ahora = new Date();
    const diferenciaHoras = (ahora - fechaAuthObj) / (1000 * 60 * 60);
    return diferenciaHoras >= AUTH_EXPIRATION_HOURS;
  }

  function guardarAuthExitosa() {
    const authData = {
      authenticated: true,
      fecha: new Date().toISOString()
    };
    localStorage.setItem(AUTH_KEY, JSON.stringify(authData));
  }

  function solicitarContrasena() {
    const passwordProtection = document.getElementById('password-protection');
    const passwordInput = document.getElementById('password-input');
    const passwordError = document.getElementById('password-error');
    
    passwordProtection.style.display = 'flex';
    passwordInput.value = '';
    passwordInput.focus();
    passwordError.style.display = 'none';
    
    document.getElementById('password-submit').onclick = function() {
      if (passwordInput.value === CORRECT_PASSWORD) {
        guardarAuthExitosa();
        passwordProtection.style.display = 'none';
        enviarDevoluciones();
      } else {
        passwordError.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
      }
    };
    
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('password-submit').click();
      }
    });
  }

  function cerrarDialogoContrasena() {
    document.getElementById('password-protection').style.display = 'none';
  }

  function cargarDevolucionesPendientes() {
    $('#overlay').show();
    $('#devoluciones-body').empty().append('<tr><td colspan="7" style="text-align: center;">Cargando datos...</td></tr>'); // Colspan 7
    
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwQrmkh9WK_cVCPkxEKOmBxwxS1PWF1gPYCQqFzmzNHxQ5aeEsGoAmKZZh87iiQrzwA/exec?action=obtenerDevoluciones";
    
    $.ajax({
      url: scriptUrl,
      type: "GET",
      dataType: "json",
      success: function(data) {
        $('#overlay').hide();
        console.log("Respuesta del servidor:", data); 
        
        if (data.error) {
          mostrarError(data.mensaje || "Error al cargar devoluciones");
          return;
        }
        
        if (!data.devoluciones) {
          mostrarError("Formato de respuesta inválido");
          return;
        }
        
        devoluciones = data.devoluciones;
        mostrarDevolucionesEnUI();
      },
      error: function(xhr, status, error) {
        $('#overlay').hide();
        console.error("Error en la solicitud:", status, error, xhr.responseText);
        
        let errorMsg = "Error al conectar con el servidor";
        try {
          const response = JSON.parse(xhr.responseText);
          errorMsg = response.error || response.mensaje || errorMsg;
        } catch (e) {}
        
        mostrarError(errorMsg);
      }
    });
  }

  function mostrarError(mensaje) {
    $('#devoluciones-body').empty().append(`<tr><td colspan="7" style="text-align: center; color: red;">${mensaje}</td></tr>`); // Colspan 7
    document.getElementById('btn-enviar').disabled = true;
    
    Swal.fire({
      title: 'Error',
      text: mensaje,
      icon: 'error',
      confirmButtonText: 'Entendido'
    });
  }

  function mostrarDevolucionesEnUI() {
    const tbody = $('#devoluciones-body');
    tbody.empty();
    
    if (devoluciones.length === 0) {
      tbody.append('<tr><td colspan="7" class="no-results">No hay devoluciones pendientes</td></tr>'); // Colspan 7
      return;
    }
    
    devoluciones.forEach((devolucion, index) => {
      // Each original row will have at least one entry, indexed as "index-0" 
      const entryId = `${index}-0`; 
      editedEntries[entryId] = { // Initialize the first entry for this row
          rowId: devolucion.rowId,
          originalIndex: index, // Store original index for data lookup
          cantidad: 0,
          nivel: '',
          cuerposBajos: '',
          // Store original data needed for history (even if columns are hidden)
          fechaOriginal: devolucion.fecha,
          horaOriginal: devolucion.hora,
          colaborador: devolucion.colaborador,
          area: devolucion.area, // Aquí 'area' se usará como 'Edificio'
          producto: devolucion.producto,
          cantidadSalida: devolucion.cantidadSalida,
          cantidadDevuelta: devolucion.cantidadDevuelta,
          cantidadPendiente: devolucion.cantidadPendiente,
          estado: devolucion.estado
      };

      appendDevolucionRow(devolucion, index, 0); // Append the initial row
    });
    
    document.getElementById('btn-enviar').disabled = Object.keys(editedEntries).length === 0; // Check initial state
  }

  function appendDevolucionRow(devolucion, originalIndex, entryNumber) {
      const tbody = $('#devoluciones-body');
      const entryId = `${originalIndex}-${entryNumber}`;
      const isCuerposBajos = devolucion.area === 'Cuerpos Bajos';

      const cuerposBajosHtml = isCuerposBajos ? `
        <select class="cuerpos-bajos-select"
                id="select-cuerpos-bajos-${entryId}"
                onchange="manejarInputCuerposBajoss('${entryId}')">
            <option value="">Seleccione</option>
            <option value="CBA" ${editedEntries[entryId].cuerposBajos === 'CBA' ? 'selected' : ''}>CBA</option>
            <option value="CBB" ${editedEntries[entryId].cuerposBajos === 'CBB' ? 'selected' : ''}>CBB</option>
            <option value="CBC" ${editedEntries[entryId].cuerposBajos === 'CBC' ? 'selected' : ''}>CBC</option>
        </select>
      ` : `<span></span>`; // Cambiado de 'N/A' a vacío

      const rowClass = entryNumber > 0 ? 'data-row additional-entry' : 'data-row';

      const rowHtml = `
        <tr id="row-${entryId}" class="${rowClass}" data-original-index="${originalIndex}">
          <td class="edificio">${entryNumber === 0 ? devolucion.area : ''}</td> 
          <td class="producto">${entryNumber === 0 ? devolucion.producto : ''}</td>
          <td>${entryNumber === 0 ? devolucion.cantidadPendiente : ''}</td>
          <td>
            <div class="quantity-controls">
                <button type="button" class="quantity-button quantity-minus-button" onclick="cambiarCantidad('${entryId}', -1, ${devolucion.cantidadPendiente})">-</button>
                <input type="number" 
                       class="cantidad-input" 
                       id="input-cantidad-${entryId}" 
                       min="0" 
                       max="${devolucion.cantidadPendiente}" 
                       value="${editedEntries[entryId].cantidad}"
                       oninput="manejarInputDevolver('${entryId}', ${devolucion.cantidadPendiente})" autocomplete="off">
                <button type="button" class="quantity-button quantity-plus-button" onclick="cambiarCantidad('${entryId}', 1, ${devolucion.cantidadPendiente})">+</button>
            </div>
          </td>
          <td> 
            <input type="text"
                   class="nivel-input"
                   id="input-nivel-${entryId}"
                   min="0"
                   value="${editedEntries[entryId].nivel}"
                   oninput="manejarInputNivel('${entryId}')" autocomplete="off">
          </td>
          <td>${cuerposBajosHtml}</td>
          <td>
            ${entryNumber === 0 ? 
                `<button class="add-more-btn" onclick="agregarMasEntradas(${originalIndex})">Agregar Más</button>` 
                : 
                `
                <div id="action-buttons-container-${entryId}" style="display: flex; gap: 5px; justify-content: center;">
                    <button class="delete-entry-btn" id="delete-btn-${entryId}" onclick="prepararEliminar('${entryId}')">Eliminar</button>
                    <button class="confirm-delete-btn" id="confirm-btn-${entryId}" style="display:none;" onclick="confirmarEliminar('${entryId}')">✓</button>
                    <button class="cancel-delete-btn" id="cancel-btn-${entryId}" style="display:none;" onclick="cancelarEliminar('${entryId}')">✕</button>
                </div>
                `
            }
          </td>
        </tr>
      `;
      // Append the new row after the last entry for this originalIndex
      if (entryNumber === 0) {
          tbody.append(rowHtml);
      } else {
          // Find the last row associated with this originalIndex and insert after it
          $(`#tabla-devoluciones tr[data-original-index='${originalIndex}']`).last().after(rowHtml);
      }
      
  }

  function agregarMasEntradas(originalIndex) {
      const originalDevolucion = devoluciones[originalIndex];
      // Increment the entry counter for this original devolution to create a unique ID
      let nextEntryNumber = 0;
      // Find the highest entry number for this original index
      Object.keys(editedEntries).forEach(key => {
          const [idx, entryNum] = key.split('-');
          if (parseInt(idx) === originalIndex) {
              if (parseInt(entryNum) >= nextEntryNumber) {
                  nextEntryNumber = parseInt(entryNum) + 1;
              }
          }
      });

      const newEntryId = `${originalIndex}-${nextEntryNumber}`;
      editedEntries[newEntryId] = {
          rowId: originalDevolucion.rowId,
          originalIndex: originalIndex,
          cantidad: 0,
          nivel: '',
          cuerposBajos: '',
          // Carry over original data for history
          fechaOriginal: originalDevolucion.fecha,
          horaOriginal: originalDevolucion.hora,
          colaborador: originalDevolucion.colaborador,
          area: originalDevolucion.area,
          producto: originalDevolucion.producto,
          cantidadSalida: originalDevolucion.cantidadSalida,
          cantidadDevuelta: originalDevolucion.cantidadDevuelta,
          cantidadPendiente: originalDevolucion.cantidadPendiente,
          estado: originalDevolucion.estado
      };
      appendDevolucionRow(originalDevolucion, originalIndex, nextEntryNumber);
      // Re-apply filter in case something was searched
      filtrarTabla();
      // Ensure the button is enabled as a new editable entry was added
      document.getElementById('btn-enviar').disabled = false;
  }

  // NUEVA FUNCIÓN: Preparar la eliminación mostrando botones de confirmación
  function prepararEliminar(entryId) {
      document.getElementById(`delete-btn-${entryId}`).style.display = 'none';
      document.getElementById(`confirm-btn-${entryId}`).style.display = 'inline-block';
      document.getElementById(`cancel-btn-${entryId}`).style.display = 'inline-block';
  }

  // NUEVA FUNCIÓN: Confirmar y eliminar la entrada
  function confirmarEliminar(entryId) {
      delete editedEntries[entryId]; // Remove from our tracking object
      $(`#row-${entryId}`).remove(); // Remove from UI
      
      // Check if any entries are left to enable/disable button
      const hasValidEntries = Object.values(editedEntries).some(entry => entry.cantidad > 0);
      document.getElementById('btn-enviar').disabled = !hasValidEntries;

      // No Swal.fire here, silent deletion
  }

  // NUEVA FUNCIÓN: Cancelar la eliminación y restaurar el botón original
  function cancelarEliminar(entryId) {
      document.getElementById(`delete-btn-${entryId}`).style.display = 'inline-block';
      document.getElementById(`confirm-btn-${entryId}`).style.display = 'none';
      document.getElementById(`cancel-btn-${entryId}`).style.display = 'none';
  }


  // MODIFICADO: filtrarTabla para aceptar múltiples términos y buscar en Edificio (antes Área) y Producto
  function filtrarTabla() {
    const searchText = document.getElementById('search-input').value.toLowerCase().trim();
    const keywords = searchText.split(' ').filter(keyword => keyword.length > 0); // Divide por espacios

    const rows = document.querySelectorAll('#devoluciones-body .data-row');
    let hasResults = false;
    
    rows.forEach(row => {
      const originalIndex = row.dataset.originalIndex;
      const entryNumber = parseInt(row.id.split('-')[2]);

      if (entryNumber === 0) { // Solo filtrar basándose en la entrada principal
          // CAMBIADO: de '.area' a '.edificio'
          const edificio = row.querySelector('.edificio').textContent.toLowerCase(); 
          const producto = row.querySelector('.producto').textContent.toLowerCase();
          
          let matches = true;
          if (keywords.length > 0) {
              matches = keywords.every(keyword => 
                  edificio.includes(keyword) || 
                  producto.includes(keyword)
              );
          }

          if (matches) {
            row.style.display = '';
            hasResults = true;
            // También mostrar cualquier entrada adicional asociada
            $(`tr[data-original-index='${originalIndex}'][id^='row-${originalIndex}-']`).show();
          } else {
            row.style.display = 'none';
            // También ocultar cualquier entrada adicional asociada
            $(`tr[data-original-index='${originalIndex}'][id^='row-${originalIndex}-']`).hide();
          }
      }
    });
    
    const noResultsRow = document.querySelector('#devoluciones-body .no-results');
    if (!hasResults && devoluciones.length > 0) {
      if (!noResultsRow) {
        $('#devoluciones-body').append('<tr><td colspan="7" class="no-results">No se encontraron resultados</td></tr>');
      }
    } else if (noResultsRow) {
      noResultsRow.remove();
    }
  }

  // Function to handle quantity input changes for a specific entry
  function manejarInputDevolver(entryId, maxCantidadPendienteOriginal) {
      const input = document.getElementById(`input-cantidad-${entryId}`);
      let proposedValue = parseInt(input.value) || 0;

      if (proposedValue < 0) {
          proposedValue = 0;
      }
      input.value = proposedValue; // Ensure UI reflects valid non-negative number immediately

      const [originalIndexStr] = entryId.split('-');
      const originalIndex = parseInt(originalIndexStr);

      let sumOfQuantitiesExcludingCurrent = 0;
      // Calculate the sum of quantities for all OTHER entries related to the same original item.
      for (const id in editedEntries) {
          if (id === entryId) { // Skip the current entry
              continue;
          }
          const entry = editedEntries[id];
          if (entry.originalIndex === originalIndex) {
              sumOfQuantitiesExcludingCurrent += entry.cantidad;
          }
      }

      const totalAfterProposedChange = sumOfQuantitiesExcludingCurrent + proposedValue;

      if (totalAfterProposedChange > maxCantidadPendienteOriginal) {
          // Calculate the maximum allowed value for the current input
          const allowedValueForCurrentInput = maxCantidadPendienteOriginal - sumOfQuantitiesExcludingCurrent;
          
          // Adjust proposedValue to be within limits, ensuring it's not negative
          proposedValue = Math.max(0, allowedValueForCurrentInput);

          editedEntries[entryId].cantidad = proposedValue;
          input.value = proposedValue; // Update the UI input field with the adjusted value
          
          // La alerta de límite excedido ha sido eliminada por solicitud del usuario
      } else {
          // If within limits, just update the stored quantity
          editedEntries[entryId].cantidad = proposedValue;
      }
      
      actualizarEstadoBotonEnviar();
  }

  // New function to handle +/- button clicks
  function cambiarCantidad(entryId, delta, max) {
      const input = document.getElementById(`input-cantidad-${entryId}`);
      let currentValue = parseInt(input.value) || 0;
      let newValue = currentValue + delta;

      // Temporary update input.value before calling manejarInputDevolver
      input.value = newValue; 
      manejarInputDevolver(entryId, max); // This will handle validation and final value setting
  }


  // MODIFICADO: manejarInputNivel para permitir 'X' o números
  function manejarInputNivel(entryId) {
      const input = document.getElementById(`input-nivel-${entryId}`);
      let value = input.value.trim(); 

      const upperCaseValue = value.toUpperCase();

      if (upperCaseValue === 'X') {
          editedEntries[entryId].nivel = upperCaseValue;
      } else if (value !== '' && isNaN(parseInt(value))) {
          input.value = '';
          editedEntries[entryId].nivel = '';
      } else if (value !== '') {
          value = Math.max(0, parseInt(value)).toString();
          input.value = value;
          editedEntries[entryId].nivel = value;
      } else {
          editedEntries[entryId].nivel = '';
      }
      actualizarEstadoBotonEnviar();
  }

  // New function to handle cuerposBajos select changes for a specific entry
  function manejarInputCuerposBajoss(entryId) {
      const select = document.getElementById(`select-cuerpos-bajos-${entryId}`);
      editedEntries[entryId].cuerposBajos = select.value;
      actualizarEstadoBotonEnviar();
  }

  // Consolidated function to update the send button's state
  function actualizarEstadoBotonEnviar() {
      // The button is enabled if ANY entry has a quantity > 0
      const hasValidEntries = Object.values(editedEntries).some(entry => entry.cantidad > 0);
      document.getElementById('btn-enviar').disabled = !hasValidEntries;
  }

  function enviarDevoluciones() {
      const datosParaEnviar = [];
      let validationError = false;

      // Iterate through all entries in editedEntries
      for (const entryId in editedEntries) {
          const currentEntry = editedEntries[entryId];
          
          const cantidadValida = currentEntry.cantidad > 0;
          const nivelValido = currentEntry.nivel !== '';
          const cuerposBajosValido = currentEntry.area !== 'Cuerpos Bajos' || (currentEntry.area === 'Cuerpos Bajos' && currentEntry.cuerposBajos !== '');

          // MODIFICACIÓN CLAVE AQUÍ: Solo incluir la entrada si tiene cantidad > 0.
          if (cantidadValida) { // Only proceed if quantity is greater than 0
              // Validations for Nivel and Cuerpos Bajos are now dependent on cantidadValida
              if (!nivelValido) { // If cantidad > 0, Nivel must be valid
                  Swal.fire('Advertencia', `Para el producto '${currentEntry.producto}' del área '${currentEntry.area}', ingresó una cantidad para devolver pero no el Nivel en una de las entradas. Por favor, complete la información.`, 'warning');
                  validationError = true;
                  break; 
              }

              if (currentEntry.area === 'Cuerpos Bajos' && !currentEntry.cuerposBajos) { // If area is Cuerpos Bajos and cantidad > 0, Cuerpos Bajos must be valid
                  Swal.fire('Advertencia', `Para el producto '${currentEntry.producto}' del área 'Cuerpos Bajos', por favor, seleccione una opción de Cuerpos Bajos (CBA, CBB, CBC) en una de las entradas.`, 'warning');
                  validationError = true;
                  break; 
              }
              
              // Only add to datosParaEnviar if all conditions are met and it's a valid entry that needs processing
              datosParaEnviar.push({
                  rowId: currentEntry.rowId, // Original rowId from the sheet
                  cantidad: currentEntry.cantidad,
                  nivel: currentEntry.nivel,
                  cuerposBajos: currentEntry.cuerposBajos,
                  // Pass original metadata for history logging (as it's the same for all entries of this rowId)
                  colaborador: currentEntry.colaborador,
                  area: currentEntry.area,
                  producto: currentEntry.producto
              });
          }
      }

      if (validationError) {
          return; // Stop the process due to validation errors
      }

      // NUEVO MENSAJE DE ADVERTENCIA si no hay entradas válidas para enviar
      if (datosParaEnviar.length === 0) {
        Swal.fire('Advertencia', 'No hay devoluciones válidas para enviar. Ingrese una cantidad mayor a 0 para proceder.', 'warning');
        return;
      }

      $('#overlay').show();
      
      const scriptUrl = "https://script.google.com/macros/s/AKfycbyZPzFs6KJcnDL6f-AeC4n0Pz4E0o9tPvq73MYgGVgelWh38xD9_CvhvjbCXmzxkKk/exec";
      
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.name = 'hiddenFrame';
      document.body.appendChild(iframe);
      
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = scriptUrl;
      form.target = 'hiddenFrame';
      
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = 'actualizarDevoluciones';
      form.appendChild(actionInput);
      
      const dataInput = document.createElement('input');
      dataInput.type = 'hidden';
      dataInput.name = 'devoluciones';
      dataInput.value = JSON.stringify(datosParaEnviar);
      form.appendChild(dataInput);
      
      document.body.appendChild(form);
      form.submit();
      
      setTimeout(() => {
          $('#overlay').hide();
          Swal.fire({
              title: '¡Éxito!',
              html: 'Devoluciones registradas correctamente',
              icon: 'success',
              confirmButtonText: 'Aceptar'
          }).then(() => {
              location.reload();
          });
          
          document.body.removeChild(form);
          document.body.removeChild(iframe);
      }, 3000);
  }

  // Funciones para el Modal de Resumen
  function abrirModalResumen() {
      document.getElementById('resumenModal').style.display = 'flex';
      // Limpiar y resetear campos de fecha y el resumen
      $('#resumen-search-input').val('');
      $('#resumen-tbody').empty().append('<tr><td colspan="4" style="text-align: center;">Seleccione un rango de fechas y haga clic en "Cargar Resumen".</td></tr>');
      $('#resumen-product-sums').empty();
      resumenData = [];
      filteredResumenData = [];
      allSummaryDates = [];

      // Establecer fechas por defecto
      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

      // Formatear las fechas para el input[type="date"] (YYYY-MM-DD)
      const formatDate = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      };

      $('#fecha-inicio-resumen').val(formatDate(firstDayOfMonth));
      $('#fecha-fin-resumen').val(formatDate(today));
      
      // INICIO DE CAMBIO: Asegurarse de que la sección de totales esté oculta al abrir el modal
      document.getElementById('resumen-totals-section').style.display = 'none';
      // FIN DE CAMBIO
  }

  function cerrarModalResumen() {
      document.getElementById('resumenModal').style.display = 'none';
  }

function cargarResumenDevoluciones() {
    const fechaInicio = $('#fecha-inicio-resumen').val();
    const fechaFin = $('#fecha-fin-resumen').val();

    if (!fechaInicio || !fechaFin) {
        Swal.fire('Advertencia', 'Por favor, seleccione una fecha de inicio y una fecha de fin.', 'warning');
        return;
    }

    if (new Date(fechaInicio) > new Date(fechaFin)) {
        Swal.fire('Advertencia', 'La fecha de inicio no puede ser posterior a la fecha de fin.', 'warning');
        return;
    }

    const resumenTbody = $('#resumen-tbody');
    // Mostrar spinner de carga debajo de la tabla
    resumenTbody.empty().append(`
        <tr id="loading-row">
            <td colspan="4" style="text-align: center; padding: 20px;">
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div class="spinner" style="margin: 0;"></div>
                    <div style="margin-top: 10px;">Cargando resumen, por favor espere...</div>
                </div>
            </td>
        </tr>
    `);
    
    // Reiniciar el input de búsqueda del resumen
    $('#resumen-search-input').val('');

    const scriptResumenUrl = `https://script.google.com/macros/s/AKfycbwJKU4mJvqMjenGjobggSFmaSPSZgYF8cXzhr82h0Gbq-y3SsSqKqoHj2GU9IhAMw6C/exec?action=obtenerResumen&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`; 
    
    $.ajax({
        url: scriptResumenUrl,
        type: "GET",
        dataType: "json",
        success: function(data) {
            // Eliminar el spinner de carga
            $('#loading-row').remove();
            
            if (data.error) {
                resumenTbody.append(`<tr><td colspan="4" style="text-align: center; color: red;">Error: ${data.mensaje}</td></tr>`);
                Swal.fire('Error', data.mensaje, 'error');
                return;
            }
            if (!data.resumen || data.resumen.length === 0) {
                resumenTbody.append('<tr><td colspan="4" style="text-align: center;">No hay datos en el historial para el rango de fechas seleccionado.</td></tr>');
                $('#resumen-product-sums').empty();
                filteredResumenData = [];
                allSummaryDates = [];
                return;
            }

            resumenData = data.resumen;
            filteredResumenData = [...resumenData];
            allSummaryDates = data.allTransactionDates || [];
            mostrarResumenEnTabla(filteredResumenData);
        },
        error: function(xhr, status, error) {
            // Eliminar el spinner de carga
            $('#loading-row').remove();
            
            resumenTbody.empty().append(`<tr><td colspan="4" style="text-align: center; color: red;">Error al cargar resumen: ${error}</td></tr>`);
            Swal.fire('Error', 'Error al cargar el resumen: ' + error, 'error');
            $('#resumen-product-sums').empty();
            filteredResumenData = [];
            allSummaryDates = [];
        }
    });
}


function mostrarResumenEnTabla(dataToShow) {
    const resumenTbody = $('#resumen-tbody');
    resumenTbody.empty(); // Esto eliminará cualquier spinner existente
    
    let totalGeneral = 0; 
    const productSums = {}; 

    // Sort data first
    dataToShow.sort((a, b) => {
        const areaCompare = a.area.localeCompare(b.area);
        if (areaCompare !== 0) return areaCompare;

        const nivelA = String(a.nivel).toUpperCase();
        const nivelB = String(b.nivel).toUpperCase();

        if (nivelA === 'X' && nivelB !== 'X') return 1;
        if (nivelA !== 'X' && nivelB === 'X') return -1;
        if (nivelA === 'X' && nivelB === 'X') return 0;

        const numNivelA = parseInt(nivelA);
        const numNivelB = parseInt(nivelB);
        if (!isNaN(numNivelA) && !isNaN(numNivelB)) {
            const nivelCompare = numNivelA - numNivelB;
            if (nivelCompare !== 0) return nivelCompare;
        } else if (isNaN(numNivelA) && !isNaN(numNivelB)) {
            return 1; 
        } else if (!isNaN(numNivelA) && isNaN(numNivelB)) {
            return -1; 
        }
        return a.producto.localeCompare(b.producto);
    });

    if (dataToShow.length === 0) {
        resumenTbody.append('<tr><td colspan="4" style="text-align: center;">No se encontraron resultados para el filtro actual.</td></tr>');
    } else {
        dataToShow.forEach(item => {
            resumenTbody.append(`
                <tr>
                    <td>${item.area}</td>
                    <td>${item.nivel === '0' ? 'Sin Nivel' : item.nivel}</td>
                    <td>${item.producto}</td>
                    <td>${item.cantidadTotal}</td>
                </tr>
            `);
            totalGeneral += item.cantidadTotal; 

            if (productSums[item.producto]) {
                productSums[item.producto] += item.cantidadTotal;
            } else {
                productSums[item.producto] = item.cantidadTotal;
            }
        });
    }

    // Update Product Sums display
    const resumenProductSumsDiv = $('#resumen-product-sums');
    resumenProductSumsDiv.empty();
    if (Object.keys(productSums).length > 0) {
        resumenProductSumsDiv.append('<h4>Resumen de Consumo:</h4>');
        for (const product in productSums) {
            resumenProductSumsDiv.append(`<p>${product}: ${productSums[product].toLocaleString('es-HN')} unidades</p>`);
        }
    }
}



function filtrarResumen() {
    const searchText = $('#resumen-search-input').val().toLowerCase().trim();
    const keywords = searchText.split(' ').filter(keyword => keyword.length > 0);

    // No mostrar spinner si estamos filtrando (los datos ya están cargados)
    filteredResumenData = resumenData.filter(item => {
        const area = item.area.toLowerCase();
        const nivel = String(item.nivel).toLowerCase();
        const producto = item.producto.toLowerCase();

        if (keywords.length === 0) return true;

        return keywords.every(keyword =>
            area.includes(keyword) ||
            nivel.includes(keyword) ||
            producto.includes(keyword)
        );
    });
    
    mostrarResumenEnTabla(filteredResumenData);
    
    // Actualizar gráficos si el modal está abierto
    if (document.getElementById('graficosModal').style.display === 'flex') {
        generarGraficos();
    }
}




  // NUEVA FUNCIÓN: Generar PDF del Resumen
  function generarPDFResumen() {
      if (filteredResumenData.length === 0) {
          Swal.fire('Advertencia', 'No hay datos en el resumen para generar un PDF.', 'warning');
          return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Encontrar el rango de fechas de TODAS las transacciones del resumen
      let minDate = null;
      let maxDate = null;

      // Usa allSummaryDates para calcular el rango de fechas
      allSummaryDates.forEach(dateStr => {
          if (dateStr) {
              const currentDate = new Date(dateStr);
              if (!isNaN(currentDate.getTime())) { // Asegurarse de que la fecha es válida
                  if (minDate === null || currentDate < minDate) {
                      minDate = currentDate;
                  }
                  if (maxDate === null || currentDate > maxDate) {
                      maxDate = currentDate;
                  }
              }
          }
      });

      // Función auxiliar para formatear la fecha a DD/MM/YYYY
      const formatDateForPDF = (date) => {
          if (!date) return 'N/A';
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0'); // Meses son 0-indexados
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
      };

      const dateRangeText = (minDate && maxDate) ? 
          `Rango de Fechas: ${formatDateForPDF(minDate)} - ${formatDateForPDF(maxDate)}` :
          'Rango de Fechas no disponible';

      // Función auxiliar para formatear la fecha a DD-MM-YYYY para el nombre del archivo
      const formatDateForFilename = (date) => {
          if (!date) return 'N/A';
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0'); // Meses son 0-indexados
          const year = date.getFullYear();
          return `${day}-${month}-${year}`; // Usamos guiones para el nombre del archivo
      };

      // Obtener las fechas de los inputs para el nombre del archivo
      const fechaInicioInput = document.getElementById('fecha-inicio-resumen').value; // e.g., "2025-07-16"
      const fechaFinInput = document.getElementById('fecha-fin-resumen').value;     // e.g., "2025-07-16"

      // CORRECCIÓN AQUÍ: Parsear la fecha para evitar problemas de zona horaria
      let startDateForFilename = null;
      if (fechaInicioInput) {
          const [year, month, day] = fechaInicioInput.split('-').map(Number);
          startDateForFilename = new Date(year, month - 1, day); // month - 1 porque los meses son 0-indexados
      }

      let endDateForFilename = null;
      if (fechaFinInput) {
          const [year, month, day] = fechaFinInput.split('-').map(Number);
          endDateForFilename = new Date(year, month - 1, day); // month - 1 porque los meses son 0-indexados
      }

      let filename = 'Resumen de Gasto de Insumos';
      if (startDateForFilename && endDateForFilename) {
          filename += ` (${formatDateForFilename(startDateForFilename)} - ${formatDateForFilename(endDateForFilename)})`;
      } else if (startDateForFilename) {
          filename += ` (${formatDateForFilename(startDateForFilename)})`;
      } else if (endDateForFilename) {
          filename += ` (${formatDateForFilename(endDateForFilename)})`;
      }
      filename += '.pdf';


      // Configurar el título del documento
      doc.setFontSize(16);
      doc.text("Resumen de Gasto de Insumos", doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });

      // Añadir el rango de fechas
      doc.setFontSize(10); // Tamaño de fuente más pequeño para la fecha
      doc.text(dateRangeText, doc.internal.pageSize.getWidth() / 2, 22, { align: "center" });


      // Preparar los datos para la tabla
      const headers = [["Edificio", "Nivel", "Producto", "Total de Consumo"]];
      const data = filteredResumenData.map(item => [item.area, item.nivel === '0' ? 'Sin Nivel' : item.nivel, item.producto, item.cantidadTotal]);

      // Generar la tabla con autoTable
      doc.autoTable({
          startY: 30, // Ajustado para dar espacio al rango de fechas
          head: headers,
          body: data,
          theme: 'grid', // Estilo de tabla
          styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak', halign: 'center' }, // Estilos de celda
          headStyles: { fillColor: [0, 123, 255], textColor: 255, fontStyle: 'bold', halign: 'center' }, // Estilos de encabezado
          margin: { top: 20 },
          didDrawPage: function(data) {
              // Footer
              let str = "Página " + doc.internal.getNumberOfPages();
              doc.setFontSize(8);
              doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
          }
      });

      // INICIO DE CAMBIO: Condición para añadir el resumen de consumo al PDF
      const totalsSection = document.getElementById('resumen-totals-section');
      if (totalsSection.style.display !== 'none') { // Solo añadir si la sección está visible
        const finalY = doc.lastAutoTable.finalY + 10; // Obtener la posición final de la tabla
        doc.setFontSize(12);
        doc.text("Resumen de Consumo:", 14, finalY);

        const productSums = {}; // Calcular sumas por producto nuevamente para el PDF
        filteredResumenData.forEach(item => {
            if (productSums[item.producto]) {
                productSums[item.producto] += item.cantidadTotal;
            } else {
                productSums[item.producto] = item.cantidadTotal;
            }
        });

        let currentY = finalY + 7;
        for (const product in productSums) {
            doc.text(`- ${product}: ${productSums[product].toLocaleString('es-HN')} unidades`, 18, currentY);
            currentY += 5;
        }
      }
      // FIN DE CAMBIO

      doc.save(filename); // Se usa el nombre de archivo dinámico
  }

  // Funciones para el modal de gráficos
function abrirModalGraficos() {
    if (filteredResumenData.length === 0) {
        Swal.fire('Advertencia', 'No hay datos en el resumen para generar gráficos. Cargue un resumen primero.', 'warning');
        return;
    }

    // Mostrar modal con estado de carga
    const modal = document.getElementById('graficosModal');
    modal.style.display = 'flex';
    
    // Limpiar contenido anterior y mostrar loader
    const content = document.querySelector('.graficos-modal-content');
    content.innerHTML = `
        <span class="close-modal-btn" onclick="cerrarModalGraficos()">&times;</span>
        <h2 class="modal-title">Gráficos de Consumo</h2>
        <div style="text-align: center; margin-bottom: 20px;">
            <button type="button" id="btn-generar-pdf-graficos" class="btn-generar-pdf" onclick="generarPDFGraficos()">
                Generar PDF de Gráficos
            </button>
        </div>
        <div id="graficos-loading" style="text-align: center; padding: 40px;">
            <div class="spinner" style="margin: 0 auto;"></div>
            <h3 style="margin-top: 20px;">Cargando gráficos, por favor espere...</h3>
        </div>
        <div id="graficos-content" style="display: none;">
            <div class="chart-type-selector">
                <label for="chart-type">Tipo de Gráfico: </label>
                <select id="chart-type" onchange="actualizarGraficos()">
                    <option value="bar">Barras</option>
                    <option value="line">Líneas</option>
                </select>
            </div>
            <div class="graficos-container" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
        </div>
    `;

    // Generar gráficos (esto mostrará el contenido cuando termine)
    generarGraficos();
}



function cerrarModalGraficos() {
    // Destruir los gráficos existentes
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    charts = {};
    
    // Ocultar el modal
    document.getElementById('graficosModal').style.display = 'none';
}

async function generarGraficos() {
    // Obtener elementos del DOM
    const loadingElement = document.getElementById('graficos-loading');
    const contentElement = document.getElementById('graficos-content');
    const graficosContainer = document.querySelector('.graficos-container');
    const pdfButton = document.getElementById('btn-generar-pdf-graficos');
    
    // Mostrar loader y ocultar contenido
    if (loadingElement) loadingElement.style.display = 'block';
    if (contentElement) contentElement.style.display = 'none';
    if (pdfButton) pdfButton.disabled = true;
    
    // Limpiar gráficos existentes
    Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
    });
    charts = {};
    graficosContainer.innerHTML = '';

    try {
        // Obtener datos del resumen y datos diarios en paralelo
        const [datosResumen, datosDiarios] = await Promise.all([
            Promise.resolve(prepararDatosParaGraficos()),
            cargarDatosDiarios()
        ]);

        const chartType = document.getElementById('chart-type').value;

        // Configuración común para tooltips
        const commonTooltipOptions = {
            callbacks: {
                label: function(context) {
                    return `${context.label || context.dataset.label}: ${context.raw} unidades`;
                }
            },
            intersect: false,
            mode: 'index',
            position: 'nearest',
            filter: () => true
        };

        // 1. Gráfico de productos
        const productoDiv = document.createElement('div');
        productoDiv.className = 'grafico-item';
        productoDiv.innerHTML = '<h3>Consumo por Producto</h3><canvas id="productoChart" class="grafico-canvas"></canvas>';
        graficosContainer.appendChild(productoDiv);

        const productoCtx = document.getElementById('productoChart').getContext('2d');
        charts.productoChart = new Chart(productoCtx, {
            type: chartType,
            data: {
                labels: datosResumen.productos.labels,
                datasets: [{
                    label: 'Consumo por Producto',
                    data: datosResumen.productos.data,
                    backgroundColor: generarColores(datosResumen.productos.labels.length),
                    borderColor: '#333',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: chartType === 'pie' ? 'right' : 'top',
                    },
                    tooltip: commonTooltipOptions
                },
                scales: chartType !== 'pie' ? {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cantidad (unidades)'
                        }
                    }
                } : undefined
            }
        });

        // 2. Gráficos por edificio y producto
        for (const producto in datosResumen.edificios) {
            const edificioDiv = document.createElement('div');
            edificioDiv.className = 'grafico-item';
            edificioDiv.innerHTML = `<h3>Consumo en Edificios (${producto})</h3><canvas id="edificioChart-${producto}" class="grafico-canvas"></canvas>`;
            graficosContainer.appendChild(edificioDiv);

            const edificioCtx = document.getElementById(`edificioChart-${producto}`).getContext('2d');
            charts[`edificioChart-${producto}`] = new Chart(edificioCtx, {
                type: chartType,
                data: {
                    labels: datosResumen.edificios[producto].labels,
                    datasets: [{
                        label: `Consumo de ${producto}`,
                        data: datosResumen.edificios[producto].data,
                        backgroundColor: generarColores(datosResumen.edificios[producto].labels.length),
                        borderColor: '#333',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: chartType === 'pie' ? 'right' : 'top',
                        },
                        tooltip: commonTooltipOptions
                    },
                    scales: chartType !== 'pie' ? {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad (unidades)'
                            }
                        }
                    } : undefined
                }
            });
        }

        // 3. Gráficos por nivel, edificio y producto
        for (const edificio in datosResumen.niveles) {
            for (const producto in datosResumen.niveles[edificio]) {
                const nivelDiv = document.createElement('div');
                nivelDiv.className = 'grafico-item';
                nivelDiv.innerHTML = `<h3>Consumo en ${edificio} - ${producto} por Nivel</h3><canvas id="nivelChart-${edificio}-${producto}" class="grafico-canvas"></canvas>`;
                graficosContainer.appendChild(nivelDiv);

                const nivelCtx = document.getElementById(`nivelChart-${edificio}-${producto}`).getContext('2d');
                charts[`nivelChart-${edificio}-${producto}`] = new Chart(nivelCtx, {
                    type: chartType,
                    data: {
                        labels: datosResumen.niveles[edificio][producto].labels,
                        datasets: [{
                            label: `Consumo en ${edificio}`,
                            data: datosResumen.niveles[edificio][producto].data,
                            backgroundColor: generarColores(datosResumen.niveles[edificio][producto].labels.length),
                            borderColor: '#333',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: chartType === 'pie' ? 'right' : 'top',
                            },
                            tooltip: commonTooltipOptions
                        },
                        scales: chartType !== 'pie' ? {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad (unidades)'
                                }
                            }
                        } : undefined
                    }
                });
            }
        }

        // 4. Gráficos diarios por producto
        if (datosDiarios && datosDiarios.length > 0) {
            datosDiarios.forEach(datosProducto => {
                if (datosProducto.datos && datosProducto.datos.length > 0) {
                    const diarioDiv = document.createElement('div');
                    diarioDiv.className = 'grafico-item';
                    diarioDiv.innerHTML = `<h3>Consumo Diario (${datosProducto.producto})</h3><canvas id="diarioChart-${datosProducto.producto}" class="grafico-canvas"></canvas>`;
                    graficosContainer.appendChild(diarioDiv);

                    const diarioCtx = document.getElementById(`diarioChart-${datosProducto.producto}`).getContext('2d');
                    charts[`diarioChart-${datosProducto.producto}`] = new Chart(diarioCtx, {
                        type: 'line',
                        data: {
                            labels: datosProducto.datos.map(d => d.fecha),
                            datasets: [{
                                label: `Consumo Diario ${datosProducto.producto}`,
                                data: datosProducto.datos.map(d => d.cantidad),
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                tooltip: commonTooltipOptions
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Cantidad (unidades)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Fecha'
                                    }
                                }
                            },
                            elements: {
                                point: {
                                    radius: function(context) {
                                        return context.raw > 0 ? 5 : 3;
                                    },
                                    hoverRadius: 7
                                }
                            }
                        }
                    });
                }
            });
        }

        // Ocultar loader y mostrar contenido
        if (loadingElement) loadingElement.style.display = 'none';
        if (contentElement) contentElement.style.display = 'block';
        if (pdfButton) pdfButton.disabled = false;

    } catch (error) {
        console.error('Error al generar gráficos:', error);
        if (loadingElement) {
            loadingElement.innerHTML = '<div style="color: red;">Error al cargar los gráficos. Intente nuevamente.</div>';
        }
        if (pdfButton) pdfButton.disabled = true;
    }
}


function actualizarGraficos() {
    // Mostrar loader y ocultar contenido
    const loadingElement = document.getElementById('graficos-loading');
    const contentElement = document.getElementById('graficos-content');
    
    if (loadingElement) loadingElement.style.display = 'block';
    if (contentElement) contentElement.style.display = 'none';
    
    // Llamar a generarGraficos después de un pequeño retraso para que se vea el loader
    setTimeout(generarGraficos, 100);
}



function prepararDatosParaGraficos() {
    const datos = {
        productos: { labels: [], data: [] },
        edificios: {},    // { producto: { labels: [edificios], data: [] } }
        niveles: {}       // { edificio: { producto: { labels: [niveles], data: [] } }
    };

    // 1. Agrupar datos por producto (total general)
    const productosMap = {};
    filteredResumenData.forEach(item => {
        if (productosMap[item.producto]) {
            productosMap[item.producto] += item.cantidadTotal;
        } else {
            productosMap[item.producto] = item.cantidadTotal;
        }
    });
    datos.productos.labels = Object.keys(productosMap);
    datos.productos.data = Object.values(productosMap);

    // 2. Agrupar datos por edificio (por producto)
    filteredResumenData.forEach(item => {
        if (!datos.edificios[item.producto]) {
            datos.edificios[item.producto] = { labels: [], data: [] };
        }
        
        const edificioIndex = datos.edificios[item.producto].labels.indexOf(item.area);
        if (edificioIndex === -1) {
            datos.edificios[item.producto].labels.push(item.area);
            datos.edificios[item.producto].data.push(item.cantidadTotal);
        } else {
            datos.edificios[item.producto].data[edificioIndex] += item.cantidadTotal;
        }
    });

    // 3. Agrupar datos por nivel (por edificio Y por producto)
    filteredResumenData.forEach(item => {
        // Inicializar estructura para el edificio si no existe
        if (!datos.niveles[item.area]) {
            datos.niveles[item.area] = {};
        }
        
        // Inicializar estructura para el producto dentro del edificio si no existe
        if (!datos.niveles[item.area][item.producto]) {
            datos.niveles[item.area][item.producto] = { labels: [], data: [] };
        }
        
        // Convertir "Sin Nivel" a "0"
        const nivel = !item.nivel || item.nivel === 'Sin Nivel' ? '0' : item.nivel;
        
        const nivelIndex = datos.niveles[item.area][item.producto].labels.indexOf(nivel);
        if (nivelIndex === -1) {
            datos.niveles[item.area][item.producto].labels.push(nivel);
            datos.niveles[item.area][item.producto].data.push(item.cantidadTotal);
        } else {
            datos.niveles[item.area][item.producto].data[nivelIndex] += item.cantidadTotal;
        }
    });

    return datos;
}


function generarColores(cantidad) {
    const colores = [];
    const hueStep = Math.max(1, 360 / Math.max(1, cantidad)); // Evitar división por cero
    
    for (let i = 0; i < cantidad; i++) {
        const hue = i * hueStep;
        colores.push(`hsl(${hue}, 70%, 60%)`);
    }
    
    return colores;
}

  function formatearFechaParaGrafico(fechaISO) {
      if (!fechaISO) return '';
      const fecha = new Date(fechaISO);
      if (isNaN(fecha.getTime())) return fechaISO;
      
      const dia = String(fecha.getDate()).padStart(2, '0');
      const mes = String(fecha.getMonth() + 1).padStart(2, '0');
      return `${dia}/${mes}`;
  }

  // Las funciones de formateo de fecha/hora ya no se necesitan para mostrar, pero se mantienen por si acaso.
  function formatearFecha(fechaISO) {
    if (!fechaISO) return '';
    const fecha = new Date(fechaISO);
    if (isNaN(fecha.getTime())) return fechaISO;
    
    const año = fecha.getFullYear();
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const dia = String(fecha.getDate()).padStart(2, '0');
    
    return `${año}-${mes}-${dia}`;
  }

  function formatearHora(fechaISO) {
    if (!fechaISO) return '';
    const fecha = new Date(fechaISO);
    if (isNaN(fecha.getTime())) return fechaISO;
    
    const horas = String(fecha.getHours()).padStart(2, '0');
    const minutos = String(fecha.getMinutes()).padStart(2, '0');
    const segundos = String(fecha.getSeconds()).padStart(2, '0');
    
    return `${horas}:${minutos}:${segundos}`;
  }



function cargarDatosDiarios() {
    const fechaInicio = $('#fecha-inicio-resumen').val();
    const fechaFin = $('#fecha-fin-resumen').val();
    const filtro = $('#resumen-search-input').val() || '';

    if (!fechaInicio || !fechaFin) {
        return Promise.resolve(null);
    }

    return new Promise((resolve, reject) => {
        const scriptDiarioUrl = `https://script.google.com/macros/s/AKfycbwJbg1Fm8kJycqc0LCyNcVkMQxsyDspmKI6Yo99ktVogwDPTMBeGCpCtPFna7CjsGqGGg/exec?action=obtenerDatosDiarios&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}&filtro=${encodeURIComponent(filtro)}`;
        
        $.ajax({
            url: scriptDiarioUrl,
            type: "GET",
            dataType: "json",
            success: function(data) {
                if (data.error) {
                    console.error("Error al cargar datos diarios:", data.mensaje);
                    reject(data.mensaje);
                } else {
                    resolve(data.datosDiarios);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error en la solicitud de datos diarios:", error);
                reject(error);
            }
        });
    });
}


function generarPDFGraficos() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm'
    });

    // 1. Configuración inicial
    const margin = 10;
    const spacing = 10;
    const chartWidth = (doc.internal.pageSize.getWidth() - (2 * margin) - spacing) / 2;
    const chartHeight = 60;
    const maxTitleLines = 2; // Máximo de líneas para títulos

    // 2. Función para preparar imagen del gráfico con valores
    const prepareChartImage = (canvas, chart) => {
        const originalWidth = canvas.width;
        const originalHeight = canvas.height;
        
        // Canvas temporal con mayor resolución
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = originalWidth * 2;
        tempCanvas.height = originalHeight * 2;
        
        // Aplicar suavizado
        tempCtx.imageSmoothingEnabled = true;
        tempCtx.imageSmoothingQuality = 'high';
        tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);

        // Agregar valores a las barras
        if (chart.config.type === 'bar') {
            tempCtx.font = 'bold 14px Arial';
            tempCtx.fillStyle = '#333';
            tempCtx.textAlign = 'center';
            
            chart.data.datasets.forEach(dataset => {
                dataset.data.forEach((value, index) => {
                    if (value > 0) {
                        const meta = chart.getDatasetMeta(0);
                        const bar = meta.data[index];
                        
                        // Fondo para el texto
                        tempCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                        const textWidth = tempCtx.measureText(value).width + 8;
                        tempCtx.fillRect(
                            bar.x * 2 - textWidth/2, 
                            bar.y * 2 - 16, 
                            textWidth, 
                            18
                        );
                        
                        // Texto del valor
                        tempCtx.fillStyle = '#333';
                        tempCtx.fillText(value, bar.x * 2, bar.y * 2 - 5);
                    }
                });
            });
        }
        
        return tempCanvas.toDataURL('image/png');
    };

    // 3. Función para dividir títulos en múltiples líneas
    const wrapText = (text, maxWidth) => {
        const words = text.split(' ');
        const lines = [];
        let currentLine = words[0];
        
        for (let i = 1; i < words.length; i++) {
            const word = words[i];
            const width = doc.getStringUnitWidth(currentLine + ' ' + word) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            
            if (width < maxWidth) {
                currentLine += ' ' + word;
            } else {
                lines.push(currentLine);
                currentLine = word;
            }
            
            // Limitar a máximo de líneas
            if (lines.length >= maxTitleLines - 1) {
                break;
            }
        }
        
        lines.push(currentLine);
        return lines;
    };

    // 4. Función para formatear fechas
    const formatDateForFilename = (dateStr) => {
        if (!dateStr) return '';
        const [year, month, day] = dateStr.split('-');
        return `${day}-${month}-${year}`;
    };

    // 5. Función principal para agregar gráficos al PDF
    const addChartToPDF = (canvas, title, chart, x, y) => {
        // Procesar el título
        const maxTitleWidth = chartWidth - 4;
        let titleLines = wrapText(title, maxTitleWidth);
        
        // Acortar título si es muy largo
        if (titleLines.length > maxTitleLines) {
            titleLines = titleLines.slice(0, maxTitleLines);
            titleLines[maxTitleLines - 1] = titleLines[maxTitleLines - 1].substring(0, 30) + '...';
        }

        // Agregar título
        doc.setFontSize(9);
        titleLines.forEach((line, i) => {
            doc.text(line, x + chartWidth / 2, y + 3 + (i * 4), { align: 'center' });
        });

        // Agregar imagen del gráfico
        const imgData = prepareChartImage(canvas, chart);
        const chartY = y + (titleLines.length * 4) + 2;
        
        doc.roundedRect(
            x, 
            chartY, 
            chartWidth, 
            chartHeight, 
            2, 2, 'S'
        );
        
        doc.addImage(imgData, 'PNG', 
            x + 2, 
            chartY + 2, 
            chartWidth - 4, 
            chartHeight - 4
        );

        return titleLines.length * 4 + chartHeight + 5;
    };

    // 6. Configuración del documento
    doc.setFontSize(16);
    doc.text("Resumen de Gasto de Insumos", doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });

    // Obtener fechas del filtro
    const fechaInicio = $('#fecha-inicio-resumen').val();
    const fechaFin = $('#fecha-fin-resumen').val();

    if (fechaInicio || fechaFin) {
        doc.setFontSize(10);
        const dateRangeText = `Período: ${formatDateForFilename(fechaInicio) || 'Inicio'} al ${formatDateForFilename(fechaFin) || 'Fin'}`;
        doc.text(dateRangeText, doc.internal.pageSize.getWidth() / 2, 22, { align: "center" });
    }

    // 7. Procesamiento de los gráficos
    let yPosition = 30;
    const chartIds = Object.keys(charts);

    for (let i = 0; i < chartIds.length; i += 2) {
        const chartId1 = chartIds[i];
        const chart1 = charts[chartId1];
        const canvas1 = document.getElementById(chartId1);
        
        const chartId2 = chartIds[i + 1];
        const chart2 = charts[chartId2];
        const canvas2 = chartId2 ? document.getElementById(chartId2) : null;

        // Calcular espacio necesario
        const title1 = canvas1?.parentElement.querySelector('h3')?.textContent || `Gráfico ${i + 1}`;
        const title2 = canvas2?.parentElement.querySelector('h3')?.textContent || `Gráfico ${i + 2}`;
        
        const titleLines1 = wrapText(title1, chartWidth);
        const titleLines2 = canvas2 ? wrapText(title2, chartWidth) : [];
        
        const neededHeight = Math.max(
            titleLines1.length * 4 + chartHeight + 5,
            titleLines2.length * 4 + chartHeight + 5
        );

        // Verificar espacio en página
        if (yPosition + neededHeight > doc.internal.pageSize.getHeight() - margin) {
            doc.addPage();
            yPosition = margin;
        }

        // Agregar primer gráfico
        if (canvas1 && chart1) {
            const heightUsed = addChartToPDF(canvas1, title1, chart1, margin, yPosition);
            
            // Agregar segundo gráfico si existe
            if (canvas2 && chart2) {
                addChartToPDF(canvas2, title2, chart2, margin + chartWidth + spacing, yPosition);
            }
            
            yPosition += neededHeight + 5;
        }
    }

    // 8. Guardar el PDF
    const filename = `Resumen de Gasto de Insumos (${formatDateForFilename(fechaInicio)} - ${formatDateForFilename(fechaFin)}).pdf`;
    doc.save(filename);
}


</script>
</body>
</html>
