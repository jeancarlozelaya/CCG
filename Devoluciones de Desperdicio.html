<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pisos Brillantes</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    /* Estilos para el bloqueo de contraseña */
    #password-protection {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      flex-direction: column;
    }
    
    #password-form {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
      position: relative;
    }
    
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    #password-input {
      width: 90%;
      padding: 12px;
      margin: 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    #password-submit {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
    }
    
    #password-submit:hover {
      background-color: #0069d9;
    }
    
    #password-error {
      color: #dc3545;
      margin-top: 10px;
      display: none;
    }

    /* Estilos similares a la página de requisición */
    .header {
      background-color: #007BFF;
      color: white;
      text-align: center;
      padding: 15px 0;
      font-size: 1.5em;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-top: 20px;
      font-size: 24px;
      margin-bottom: 30px;
    }
    
    .form-container {
      width: 80%;
      max-width: 1300px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 44px 8px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 0.9em;
    }

    th, td {
      padding: 12px 15px;
      text-align: center; /* CENTRADO: Para encabezados y celdas */
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #007BFF;
      color: white;
      font-weight: bold;
    }

    tr:hover {
      background-color: #f5f5f5;
    }

    .cantidad-input, .nivel-input { /* MODIFICADO: Eliminado .cuerpos-bajos-select de aquí */
      width: 40px; /* REDUCIDO: Tamaño de las cajas de texto */
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
    }

    .cuerpos-bajos-select { /* NUEVO: Estilo específico para el select de Cuerpos Bajos */
        width: auto; /* Restaurado a tamaño automático */
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
    }

    .button-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    
    .button-container button {
      font-size: 16px;
      padding: 12px 24px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .estado-pendiente {
      color: white;
      background-color: #dc3545;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
    }

    .estado-completo {
      color: white;
      background-color: #28a745;
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
    }

  /* Contenedor de la tabla para desplazamiento */
  .table-container {
    width: 100%;
    overflow-x: visible; /* Por defecto sin barra de desplazamiento */
  }
  
  /* Estilos para pantallas pequeñas (menos de 768px) */
  @media screen and (max-width: 768px) {
    .table-container {
      overflow-x: auto; /* Activa el desplazamiento horizontal */
      -webkit-overflow-scrolling: touch; /* Mejor desplazamiento en iOS */
    }
    
    /* Opcional: puedes ajustar el tamaño de fuente para móviles */
    table {
      font-size: 0.8em;
    }
    
    th, td {
      padding: 8px 10px;
    }
  }

#overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  flex-direction: column;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 5px solid rgba(0, 123, 255, 0.2);
  border-radius: 50%;
  border-top-color: #007BFF;
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 20px;
}

#loadingMessage {
  text-align: center;
  color: #333;
  font-family: Arial, sans-serif;
}

#loadingMessage h3 {
  margin: 0 0 10px;
  font-size: 1.2em;
}

#loadingMessage p {
  margin: 0;
  color: #666;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}




    .search-container {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
    }
    
    #search-input {
      width: 70%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    #search-input:focus {
      outline: none;
      border-color: #007BFF;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    
    .no-results {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    /* Estilos para el botón "Agregar Más" y la nueva columna */
    .add-more-btn {
      background-color: #28a745; /* Verde */
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      margin-left: 10px;
    }

    .add-more-btn:hover {
      background-color: #218838;
    }

    .delete-entry-btn {
        background-color: #dc3545; /* Rojo */
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85em;
        /* margin-left: 10px; Eliminar para el contenedor flex */
    }

    .delete-entry-btn:hover {
        background-color: #c82333;
    }

    /* Nuevos estilos para los botones de confirmación */
    .confirm-delete-btn {
        background-color: #28a745; /* Verde para Confirmar */
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.1em; /* Un poco más grande para los iconos */
        font-weight: bold;
    }
    .confirm-delete-btn:hover {
        background-color: #218838;
    }
    .cancel-delete-btn {
        background-color: #dc3545; /* Rojo para Cancelar */
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.1em; /* Un poco más grande para los iconos */
        font-weight: bold;
    }
    .cancel-delete-btn:hover {
        background-color: #c82333;
    }


    /* Estilos para las filas adicionales generadas */
    .additional-entry {
        background-color: #e9ecef; /* Un color ligeramente diferente para distinguirlas */
    }

    /* Estilos para los botones +/- */
    .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center; /* CENTRADO: Controles de cantidad */
        gap: 5px; /* Espacio entre el botón y el input */
    }

    .quantity-button {
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        line-height: 1; /* Alineación vertical */
        width: 30px; /* Ancho fijo para botones */
        height: 30px; /* Altura fija para botones */
        display: flex;
        justify-content: center;
        align-items: center;
        flex-shrink: 0; /* Evita que se encojan */
    }

    .quantity-button:hover {
    }

    .quantity-minus-button {
        background-color: #dc3545; /* Rojo */
    }

    .quantity-minus-button:hover {
        background-color: #c82333; /* Rojo más oscuro */
    }

    .quantity-plus-button {
        background-color: #28a745; /* Verde */
    }

    .quantity-plus-button:hover {
        background-color: #218838; /* Verde más oscuro */
    }


    .quantity-button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .cantidad-input {
        flex-grow: 0; /* MODIFICADO: Evita que el input crezca */
        min-width: 40px; /* Asegura un ancho mínimo para el input */
        width: 40px; /* MODIFICADO: Ancho fijo para el input de cantidad */
    }
  </style>
</head>
<body>
  <div id="password-protection">
    <div id="password-form">
      <button class="close-btn" onclick="cerrarDialogoContrasena()">&times;</button>
      <h2>Confirmar Acción</h2>
      <p>Ingrese la contraseña para procesar las devoluciones</p>
      <input type="password" id="password-input" placeholder="Contraseña">
      <button id="password-submit">Verificar</button>
      <div id="password-error">Contraseña incorrecta. Intente nuevamente.</div>
    </div>
  </div>

  <div id="main-content">
    <div class="header">Pisos Brillantes</div>
    
    <div class="form-container">
      <h1>Devoluciones de Productos</h1>

      <div class="search-container">
        <input type="text" id="search-input" placeholder="Buscar por Área o Producto..." oninput="filtrarTabla()">
      </div>

      <div id="tabla-devoluciones-container" class="table-container">
          <table id="tabla-devoluciones">
          <thead>
            <tr>
              <th>Área</th>
              <th>Producto</th>
              <th>Cantidad Pendiente</th>
              <th>Devolver</th>
              <th>Nivel</th>
              <th>Cuerpos Bajos</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="devoluciones-body">
            </tbody>
        </table>
      </div>

      <div class="button-container">
        <button type="button" id="btn-enviar" disabled onclick="verificarAutenticacion()">Enviar Devoluciones</button>
      </div>
    </div>

    <div id="overlay">
      <div class="spinner"></div>
      <div id="loadingMessage">
        <h4>Por favor espera un momento...</h4>
        <p></p>
      </div>
    </div>
  </div>

<script>
  // Variables globales
  let devoluciones = []; // Stores all fetched pending returns (original data from sheet)
  let editedEntries = {}; 
  let entryCounter = 0; // To generate unique IDs for dynamically added entries

  const CORRECT_PASSWORD = "macdel1";
  const AUTH_KEY = "pb_auth";
  const AUTH_EXPIRATION_HOURS = 24; // La autenticación dura 24 horas

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('main-content').style.display = 'block';
    cargarDevolucionesPendientes();
  });

  function verificarAutenticacion() {
    // Check if any quantity > 0, or level/cuerposBajos are filled
    const hasValidEntries = Object.values(editedEntries).some(entry => 
        (entry.cantidad > 0) || (entry.nivel !== '') || (entry.area === 'Cuerpos Bajos' && entry.cuerposBajos !== '')
    );

    if (!hasValidEntries) {
      Swal.fire('Advertencia', 'No has ingresado cantidades, niveles o selecciones de Cuerpos Bajos para devolver en ninguna entrada.', 'warning');
      return;
    }
    
    const authData = obtenerAuthData();
    
    if (authData && authData.authenticated && !haExpiradoAuth(authData.fecha)) {
      enviarDevoluciones();
    } else {
      solicitarContrasena();
    }
  }

  function obtenerAuthData() {
    const authData = localStorage.getItem(AUTH_KEY);
    return authData ? JSON.parse(authData) : null;
  }

  function haExpiradoAuth(fechaAuth) {
    const fechaAuthObj = new Date(fechaAuth);
    const ahora = new Date();
    const diferenciaHoras = (ahora - fechaAuthObj) / (1000 * 60 * 60);
    return diferenciaHoras >= AUTH_EXPIRATION_HOURS;
  }

  function guardarAuthExitosa() {
    const authData = {
      authenticated: true,
      fecha: new Date().toISOString()
    };
    localStorage.setItem(AUTH_KEY, JSON.stringify(authData));
  }

  function solicitarContrasena() {
    const passwordProtection = document.getElementById('password-protection');
    const passwordInput = document.getElementById('password-input');
    const passwordError = document.getElementById('password-error');
    
    passwordProtection.style.display = 'flex';
    passwordInput.value = '';
    passwordInput.focus();
    passwordError.style.display = 'none';
    
    document.getElementById('password-submit').onclick = function() {
      if (passwordInput.value === CORRECT_PASSWORD) {
        guardarAuthExitosa();
        passwordProtection.style.display = 'none';
        enviarDevoluciones();
      } else {
        passwordError.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
      }
    };
    
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('password-submit').click();
      }
    });
  }

  function cerrarDialogoContrasena() {
    document.getElementById('password-protection').style.display = 'none';
  }

  function cargarDevolucionesPendientes() {
    $('#overlay').show();
    $('#devoluciones-body').empty().append('<tr><td colspan="7" style="text-align: center;">Cargando datos...</td></tr>'); // Colspan 7
    
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwQrmkh9WK_cVCPkxEKOmBxwxS1PWF1gPYCQqFzmzNHxQ5aeEsGoAmKZZh87iiQrzwA/exec?action=obtenerDevoluciones";
    
    $.ajax({
      url: scriptUrl,
      type: "GET",
      dataType: "json",
      success: function(data) {
        $('#overlay').hide();
        console.log("Respuesta del servidor:", data); 
        
        if (data.error) {
          mostrarError(data.mensaje || "Error al cargar devoluciones");
          return;
        }
        
        if (!data.devoluciones) {
          mostrarError("Formato de respuesta inválido");
          return;
        }
        
        devoluciones = data.devoluciones;
        mostrarDevolucionesEnUI();
      },
      error: function(xhr, status, error) {
        $('#overlay').hide();
        console.error("Error en la solicitud:", status, error, xhr.responseText);
        
        let errorMsg = "Error al conectar con el servidor";
        try {
          const response = JSON.parse(xhr.responseText);
          errorMsg = response.error || response.mensaje || errorMsg;
        } catch (e) {}
        
        mostrarError(errorMsg);
      }
    });
  }

  function mostrarError(mensaje) {
    $('#devoluciones-body').empty().append(`<tr><td colspan="7" style="text-align: center; color: red;">${mensaje}</td></tr>`); // Colspan 7
    document.getElementById('btn-enviar').disabled = true;
    
    Swal.fire({
      title: 'Error',
      text: mensaje,
      icon: 'error',
      confirmButtonText: 'Entendido'
    });
  }

  function mostrarDevolucionesEnUI() {
    const tbody = $('#devoluciones-body');
    tbody.empty();
    
    if (devoluciones.length === 0) {
      tbody.append('<tr><td colspan="7" class="no-results">No hay devoluciones pendientes</td></tr>'); // Colspan 7
      return;
    }
    
    devoluciones.forEach((devolucion, index) => {
      // Each original row will have at least one entry, indexed as "index-0"
      const entryId = `${index}-0`; 
      editedEntries[entryId] = { // Initialize the first entry for this row
          rowId: devolucion.rowId,
          originalIndex: index, // Store original index for data lookup
          cantidad: 0,
          nivel: '',
          cuerposBajos: '',
          // Store original data needed for history (even if columns are hidden)
          fechaOriginal: devolucion.fecha,
          horaOriginal: devolucion.hora,
          colaborador: devolucion.colaborador,
          area: devolucion.area,
          producto: devolucion.producto,
          cantidadSalida: devolucion.cantidadSalida,
          cantidadDevuelta: devolucion.cantidadDevuelta,
          cantidadPendiente: devolucion.cantidadPendiente,
          estado: devolucion.estado
      };

      appendDevolucionRow(devolucion, index, 0); // Append the initial row
    });
    
    document.getElementById('btn-enviar').disabled = Object.keys(editedEntries).length === 0; // Check initial state
  }

  function appendDevolucionRow(devolucion, originalIndex, entryNumber) {
      const tbody = $('#devoluciones-body');
      const entryId = `${originalIndex}-${entryNumber}`;
      const isCuerposBajos = devolucion.area === 'Cuerpos Bajos';

      const cuerposBajosHtml = isCuerposBajos ? `
        <select class="cuerpos-bajos-select"
                id="select-cuerpos-bajos-${entryId}"
                onchange="manejarInputCuerposBajoss('${entryId}')">
            <option value="">Seleccione</option>
            <option value="CBA" ${editedEntries[entryId].cuerposBajos === 'CBA' ? 'selected' : ''}>CBA</option>
            <option value="CBB" ${editedEntries[entryId].cuerposBajos === 'CBB' ? 'selected' : ''}>CBB</option>
            <option value="CBC" ${editedEntries[entryId].cuerposBajos === 'CBC' ? 'selected' : ''}>CBC</option>
        </select>
      ` : `<span></span>`; // Cambiado de 'N/A' a vacío

      const rowClass = entryNumber > 0 ? 'data-row additional-entry' : 'data-row';

      const rowHtml = `
        <tr id="row-${entryId}" class="${rowClass}" data-original-index="${originalIndex}">
          <td class="area">${entryNumber === 0 ? devolucion.area : ''}</td>
          <td class="producto">${entryNumber === 0 ? devolucion.producto : ''}</td>
          <td>${entryNumber === 0 ? devolucion.cantidadPendiente : ''}</td>
          <td>
            <div class="quantity-controls">
                <button type="button" class="quantity-button quantity-minus-button" onclick="cambiarCantidad('${entryId}', -1, ${devolucion.cantidadPendiente})">-</button>
                <input type="number" 
                       class="cantidad-input" 
                       id="input-cantidad-${entryId}" 
                       min="0" 
                       max="${devolucion.cantidadPendiente}" 
                       value="${editedEntries[entryId].cantidad}"
                       oninput="manejarInputDevolver('${entryId}', ${devolucion.cantidadPendiente})">
                <button type="button" class="quantity-button quantity-plus-button" onclick="cambiarCantidad('${entryId}', 1, ${devolucion.cantidadPendiente})">+</button>
            </div>
          </td>
          <td> 
            <input type="number"
                   class="nivel-input"
                   id="input-nivel-${entryId}"
                   min="0"
                   value="${editedEntries[entryId].nivel}"
                   oninput="manejarInputNivel('${entryId}')">
          </td>
          <td>${cuerposBajosHtml}</td>
          <td>
            ${entryNumber === 0 ? 
                `<button class="add-more-btn" onclick="agregarMasEntradas(${originalIndex})">Agregar Más</button>` 
                : 
                `
                <div id="action-buttons-container-${entryId}" style="display: flex; gap: 5px; justify-content: center;">
                    <button class="delete-entry-btn" id="delete-btn-${entryId}" onclick="prepararEliminar('${entryId}')">Eliminar</button>
                    <button class="confirm-delete-btn" id="confirm-btn-${entryId}" style="display:none;" onclick="confirmarEliminar('${entryId}')">✓</button>
                    <button class="cancel-delete-btn" id="cancel-btn-${entryId}" style="display:none;" onclick="cancelarEliminar('${entryId}')">✕</button>
                </div>
                `
            }
          </td>
        </tr>
      `;
      // Append the new row after the last entry for this originalIndex
      if (entryNumber === 0) {
          tbody.append(rowHtml);
      } else {
          // Find the last row associated with this originalIndex and insert after it
          $(`#tabla-devoluciones tr[data-original-index='${originalIndex}']`).last().after(rowHtml);
      }
      
  }

  function agregarMasEntradas(originalIndex) {
      const originalDevolucion = devoluciones[originalIndex];
      // Increment the entry counter for this original devolution to create a unique ID
      let nextEntryNumber = 0;
      // Find the highest entry number for this original index
      Object.keys(editedEntries).forEach(key => {
          const [idx, entryNum] = key.split('-');
          if (parseInt(idx) === originalIndex) {
              if (parseInt(entryNum) >= nextEntryNumber) {
                  nextEntryNumber = parseInt(entryNum) + 1;
              }
          }
      });

      const newEntryId = `${originalIndex}-${nextEntryNumber}`;
      editedEntries[newEntryId] = {
          rowId: originalDevolucion.rowId,
          originalIndex: originalIndex,
          cantidad: 0,
          nivel: '',
          cuerposBajos: '',
          // Carry over original data for history
          fechaOriginal: originalDevolucion.fecha,
          horaOriginal: originalDevolucion.hora,
          colaborador: originalDevolucion.colaborador,
          area: originalDevolucion.area,
          producto: originalDevolucion.producto,
          cantidadSalida: originalDevolucion.cantidadSalida,
          cantidadDevuelta: originalDevolucion.cantidadDevuelta,
          cantidadPendiente: originalDevolucion.cantidadPendiente,
          estado: originalDevolucion.estado
      };
      appendDevolucionRow(originalDevolucion, originalIndex, nextEntryNumber);
      // Re-apply filter in case something was searched
      filtrarTabla();
      // Ensure the button is enabled as a new editable entry was added
      document.getElementById('btn-enviar').disabled = false;
  }

  // NUEVA FUNCIÓN: Preparar la eliminación mostrando botones de confirmación
  function prepararEliminar(entryId) {
      document.getElementById(`delete-btn-${entryId}`).style.display = 'none';
      document.getElementById(`confirm-btn-${entryId}`).style.display = 'inline-block';
      document.getElementById(`cancel-btn-${entryId}`).style.display = 'inline-block';
  }

  // NUEVA FUNCIÓN: Confirmar y eliminar la entrada
  function confirmarEliminar(entryId) {
      delete editedEntries[entryId]; // Remove from our tracking object
      $(`#row-${entryId}`).remove(); // Remove from UI
      
      // Check if any entries are left to enable/disable button
      const hasValidEntries = Object.values(editedEntries).some(entry => 
        (entry.cantidad > 0) || (entry.nivel !== '') || (entry.area === 'Cuerpos Bajos' && entry.cuerposBajos !== '')
      );
      document.getElementById('btn-enviar').disabled = !hasValidEntries;

      // No Swal.fire here, silent deletion
  }

  // NUEVA FUNCIÓN: Cancelar la eliminación y restaurar el botón original
  function cancelarEliminar(entryId) {
      document.getElementById(`delete-btn-${entryId}`).style.display = 'inline-block';
      document.getElementById(`confirm-btn-${entryId}`).style.display = 'none';
      document.getElementById(`cancel-btn-${entryId}`).style.display = 'none';
  }


  function filtrarTabla() {
    const searchText = document.getElementById('search-input').value.toLowerCase();
    const rows = document.querySelectorAll('#devoluciones-body .data-row');
    let hasResults = false;
    
    rows.forEach(row => {
      // Only check the original row's text content for filtering.
      // Additional entries (entryNumber > 0) will follow the visibility of their parent.
      const originalIndex = row.dataset.originalIndex;
      const entryNumber = parseInt(row.id.split('-')[2]); // Get the entry number from ID like "row-X-Y"

      if (entryNumber === 0) { // Only filter based on the main entry
          const area = row.querySelector('.area').textContent.toLowerCase();
          const producto = row.querySelector('.producto').textContent.toLowerCase();
          
          // Updated search to only use area or product, as collaborator is hidden
          if (area.includes(searchText) || producto.includes(searchText)) {
            row.style.display = '';
            hasResults = true;
            // Also show any associated additional entries
            $(`tr[data-original-index='${originalIndex}'][id^='row-${originalIndex}-']`).show();
          } else {
            row.style.display = 'none';
            // Also hide any associated additional entries
            $(`tr[data-original-index='${originalIndex}'][id^='row-${originalIndex}-']`).hide();
          }
      }
    });
    
    const noResultsRow = document.querySelector('#devoluciones-body .no-results');
    if (!hasResults && devoluciones.length > 0) { // Only show no results if there were items to begin with
      if (!noResultsRow) {
        $('#devoluciones-body').append('<tr><td colspan="7" class="no-results">No se encontraron resultados</td></tr>'); // Colspan 7
      }
    } else if (noResultsRow) {
      noResultsRow.remove();
    }
  }

  // Function to handle quantity input changes for a specific entry
  function manejarInputDevolver(entryId, maxCantidadPendienteOriginal) {
      const input = document.getElementById(`input-cantidad-${entryId}`);
      let proposedValue = parseInt(input.value) || 0;

      if (proposedValue < 0) {
          proposedValue = 0;
      }
      input.value = proposedValue; // Ensure UI reflects valid non-negative number immediately

      const [originalIndexStr] = entryId.split('-');
      const originalIndex = parseInt(originalIndexStr);

      let sumOfQuantitiesExcludingCurrent = 0;
      // Calculate the sum of quantities for all OTHER entries related to the same original item.
      for (const id in editedEntries) {
          if (id === entryId) { // Skip the current entry
              continue;
          }
          const entry = editedEntries[id];
          if (entry.originalIndex === originalIndex) {
              sumOfQuantitiesExcludingCurrent += entry.cantidad;
          }
      }

      const totalAfterProposedChange = sumOfQuantitiesExcludingCurrent + proposedValue;

      if (totalAfterProposedChange > maxCantidadPendienteOriginal) {
          // Calculate the maximum allowed value for the current input
          const allowedValueForCurrentInput = maxCantidadPendienteOriginal - sumOfQuantitiesExcludingCurrent;
          
          // Adjust proposedValue to be within limits, ensuring it's not negative
          proposedValue = Math.max(0, allowedValueForCurrentInput);

          editedEntries[entryId].cantidad = proposedValue;
          input.value = proposedValue; // Update the UI input field with the adjusted value
          
          // La alerta de límite excedido ha sido eliminada por solicitud del usuario
      } else {
          // If within limits, just update the stored quantity
          editedEntries[entryId].cantidad = proposedValue;
      }
      
      actualizarEstadoBotonEnviar();
  }

  // New function to handle +/- button clicks
  function cambiarCantidad(entryId, delta, max) {
      const input = document.getElementById(`input-cantidad-${entryId}`);
      let currentValue = parseInt(input.value) || 0;
      let newValue = currentValue + delta;

      // Temporary update input.value before calling manejarInputDevolver
      input.value = newValue; 
      manejarInputDevolver(entryId, max); // This will handle validation and final value setting
  }


  // Function to handle nivel input changes for a specific entry
  function manejarInputNivel(entryId) {
      const input = document.getElementById(`input-nivel-${entryId}`);
      let value = input.value.trim(); 

      if (value !== '' && isNaN(parseInt(value))) {
        input.value = '';
        value = '';
      } else if (value !== '') {
        value = Math.max(0, parseInt(value)).toString();
        input.value = value;
      }

      editedEntries[entryId].nivel = value;
      actualizarEstadoBotonEnviar();
  }

  // New function to handle cuerposBajos select changes for a specific entry
  function manejarInputCuerposBajoss(entryId) {
      const select = document.getElementById(`select-cuerpos-bajos-${entryId}`);
      editedEntries[entryId].cuerposBajos = select.value;
      actualizarEstadoBotonEnviar();
  }

  // Consolidated function to update the send button's state
  function actualizarEstadoBotonEnviar() {
      const hasValidEntries = Object.values(editedEntries).some(entry => 
          (entry.cantidad > 0) || (entry.nivel !== '') || (entry.area === 'Cuerpos Bajos' && entry.cuerposBajos !== '')
      );
      document.getElementById('btn-enviar').disabled = !hasValidEntries;
  }

  function enviarDevoluciones() {
      const datosParaEnviar = [];
      let validationError = false;

      // Iterate through all entries in editedEntries
      for (const entryId in editedEntries) {
          const currentEntry = editedEntries[entryId];
          
          const cantidadValida = currentEntry.cantidad > 0;
          const nivelValido = currentEntry.nivel !== '';
          const cuerposBajosValido = currentEntry.area !== 'Cuerpos Bajos' || (currentEntry.area === 'Cuerpos Bajos' && currentEntry.cuerposBajos !== '');

          // If this specific entry has any data, validate it
          if (cantidadValida || nivelValido || (currentEntry.area === 'Cuerpos Bajos' && currentEntry.cuerposBajos !== '')) {
              if (cantidadValida && !nivelValido) {
                  Swal.fire('Advertencia', `Para el producto '${currentEntry.producto}' del área '${currentEntry.area}', ingresó una cantidad para devolver pero no el Nivel en una de las entradas. Por favor, complete la información.`, 'warning');
                  validationError = true;
                  break; 
              }

              if (currentEntry.area === 'Cuerpos Bajos' && !currentEntry.cuerposBajos) {
                  Swal.fire('Advertencia', `Para el producto '${currentEntry.producto}' del área 'Cuerpos Bajos', por favor, seleccione una opción de Cuerpos Bajos (CBA, CBB, CBC) en una de las entradas.`, 'warning');
                  validationError = true;
                  break; 
              }
              
              // Only add to datosParaEnviar if it's a valid entry that needs processing
              datosParaEnviar.push({
                  rowId: currentEntry.rowId, // Original rowId from the sheet
                  cantidad: currentEntry.cantidad,
                  nivel: currentEntry.nivel,
                  cuerposBajos: currentEntry.cuerposBajos,
                  // Pass original metadata for history logging (as it's the same for all entries of this rowId)
                  colaborador: currentEntry.colaborador,
                  area: currentEntry.area,
                  producto: currentEntry.producto
              });
          }
      }

      if (validationError) {
          return; // Stop the process due to validation errors
      }

      if (datosParaEnviar.length === 0) {
        Swal.fire('Advertencia', 'No hay devoluciones válidas para enviar. Ingrese una cantidad mayor a 0, un nivel o seleccione una opción de Cuerpos Bajos donde aplique.', 'warning');
        return;
      }

      $('#overlay').show();
      
      const scriptUrl = "https://script.google.com/macros/s/AKfycbyZPzFs6KJcnDL6f-AeC4n0Pz4E0o9tPvq73MYgGVgelWh38xD9_CvhvjbCXmzxkKk/exec";
      
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.name = 'hiddenFrame';
      document.body.appendChild(iframe);
      
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = scriptUrl;
      form.target = 'hiddenFrame';
      
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = 'actualizarDevoluciones';
      form.appendChild(actionInput);
      
      const dataInput = document.createElement('input');
      dataInput.type = 'hidden';
      dataInput.name = 'devoluciones';
      dataInput.value = JSON.stringify(datosParaEnviar);
      form.appendChild(dataInput);
      
      document.body.appendChild(form);
      form.submit();
      
      setTimeout(() => {
          $('#overlay').hide();
          Swal.fire({
              title: '¡Éxito!',
              html: 'Devoluciones registradas correctamente',
              icon: 'success',
              confirmButtonText: 'Aceptar'
          }).then(() => {
              location.reload();
          });
          
          document.body.removeChild(form);
          document.body.removeChild(iframe);
      }, 3000);
  }

  // Las funciones de formateo de fecha/hora ya no se necesitan para mostrar, pero se mantienen por si acaso.
  function formatearFecha(fechaISO) {
    if (!fechaISO) return '';
    const fecha = new Date(fechaISO);
    if (isNaN(fecha.getTime())) return fechaISO;
    
    const año = fecha.getFullYear();
    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
    const dia = String(fecha.getDate()).padStart(2, '0');
    
    return `${año}-${mes}-${dia}`;
  }

  function formatearHora(fechaISO) {
    if (!fechaISO) return '';
    const fecha = new Date(fechaISO);
    if (isNaN(fecha.getTime())) return fechaISO;
    
    const horas = String(fecha.getHours()).padStart(2, '0');
    const minutos = String(fecha.getMinutes()).padStart(2, '0');
    const segundos = String(fecha.getSeconds()).padStart(2, '0');
    
    return `${horas}:${minutos}:${segundos}`;
  }
</script>
</body>
</html>
