<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pisos Brillantes - Devoluciones</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --text-color: #333;
      --border-color: #ddd;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: var(--text-color);
      line-height: 1.6;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
      color: white;
      text-align: center;
      padding: 18px 0;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: var(--shadow);
      position: relative;
    }

    .form-container {
      width: 90%;
      max-width: 1300px;
      margin: 25px auto;
      padding: 25px;
      background-color: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 25px;
      font-size: 1.8rem;
      position: relative;
      padding-bottom: 10px;
    }

    h1:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background-color: var(--secondary-color);
      border-radius: 2px;
    }

    .search-container {
      margin: 20px 0;
      position: relative;
    }

    #search-input {
      width: 100%;
      padding: 14px 20px;
      padding-left: 45px;
      font-size: 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: white;
      transition: var(--transition);
    }

    #search-input:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      outline: none;
    }

    .search-container:before {
      content: '\f002';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #aaa;
      z-index: 2;
    }

    /* Estilos para la tabla de devoluciones */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 0.9em;
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th, td {
      padding: 12px 15px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
    }
    
    tr:hover {
      background-color: #f5f5f5;
    }

    .cantidad-input, .nivel-input {
      width: 40px;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      text-align: center;
    }

    .cuerpos-bajos-select {
      width: auto;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      text-align: center;
    }

    .button-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 20px;
    }
    
    .button-container button {
      font-size: 16px;
      padding: 12px 24px;
      background-color: var(--success-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
    }

    #btn-resumen {
      background-color: var(--secondary-color);
    }

    #btn-resumen:hover {
      background-color: #0069d9;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* Contenedor de la tabla para desplazamiento */
    .table-container {
      width: 100%;
      max-height: 60vh;
      overflow-y: auto;
    }
    
    /* Estilos para pantallas pequeñas (menos de 768px) */
    @media screen and (max-width: 768px) {
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      table {
        font-size: 0.8em;
      }
      
      th, td {
        padding: 8px 10px;
      }
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(52, 152, 219, 0.2);
      border-radius: 50%;
      border-top-color: var(--secondary-color);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #loadingMessage {
      text-align: center;
      color: var(--dark-color);
    }

    #loadingMessage h4 {
      margin: 0 0 10px;
      font-size: 1.3rem;
    }

    #loadingMessage p {
      margin: 0;
      color: #7f8c8d;
    }

    .no-results {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    /* Estilos para el botón "Agregar Más" y la nueva columna */
    .add-more-btn {
      background-color: var(--success-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      margin-left: 10px;
      transition: var(--transition);
    }

    .add-more-btn:hover {
      background-color: #218838;
    }

    .delete-entry-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
      transition: var(--transition);
    }

    .delete-entry-btn:hover {
      background-color: #c82333;
    }

    /* Nuevos estilos para los botones de confirmación */
    .confirm-delete-btn {
      background-color: var(--success-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      transition: var(--transition);
    }
    
    .confirm-delete-btn:hover {
      background-color: #218838;
    }
    
    .cancel-delete-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      transition: var(--transition);
    }
    
    .cancel-delete-btn:hover {
      background-color: #c82333;
    }

    /* Estilos para las filas adicionales generadas */
    .additional-entry {
      background-color: #e9ecef;
    }

    /* Estilos para los botones +/- */
    .quantity-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .quantity-button {
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      line-height: 1;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
      transition: var(--transition);
    }

    .quantity-minus-button {
      background-color: var(--accent-color);
    }

    .quantity-minus-button:hover {
      background-color: #c82333;
    }

    .quantity-plus-button {
      background-color: var(--success-color);
    }

    .quantity-plus-button:hover {
      background-color: #218838;
    }

    .quantity-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .cantidad-input {
      flex-grow: 0;
      min-width: 40px;
      width: 40px;
    }

    /* Estilos para el bloqueo de contraseña */
    #password-protection {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      flex-direction: column;
    }
    
    #password-form {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
      position: relative;
    }
    
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
      transition: var(--transition);
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    #password-input {
      width: 90%;
      padding: 12px;
      margin: 15px 0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 16px;
    }
    
    #password-submit {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      transition: var(--transition);
    }
    
    #password-submit:hover {
      background-color: #0069d9;
    }
    
    #password-error {
      color: var(--accent-color);
      margin-top: 10px;
      display: none;
    }

    /* Media queries para responsividad */
    @media (max-width: 768px) {
      .form-container {
        width: 95%;
        padding: 15px;
        margin: 15px auto;
      }
      
      h1 {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 480px) {
      #search-input {
        padding: 12px 15px;
        padding-left: 40px;
      }
    }
  </style>
</head>
<body>
  <div id="password-protection">
    <div id="password-form">
      <button class="close-btn" onclick="cerrarDialogoContrasena()">&times;</button>
      <h2>Confirmar Acción</h2>
      <p>Ingrese la contraseña para procesar las devoluciones</p>
      <input type="password" id="password-input" placeholder="Contraseña" autocomplete="off">
      <button id="password-submit">Verificar</button>
      <div id="password-error">Contraseña incorrecta. Intente nuevamente.</div>
    </div>
  </div>

  <div id="main-content">
    <div class="header">Pisos Brillantes</div>
    
    <div class="form-container">
      <h1>Devoluciones de Insumos</h1>

      <div class="search-container">
        <input type="text" id="search-input" placeholder="Buscar por Edificio o Producto..." oninput="filtrarTabla()" autocomplete="off">
      </div>

      <div id="tabla-devoluciones-container" class="table-container">
          <table id="tabla-devoluciones">
          <thead>
            <tr>
              <th>Edificio</th>
              <th>Producto</th>
              <th>Cantidad Pendiente</th>
              <th>Devolver</th>
              <th>Nivel</th>
              <th>Cuerpos Bajos</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="devoluciones-body">
            </tbody>
        </table>
      </div>

      <div class="button-container">
        <button type="button" id="btn-enviar" disabled onclick="verificarAutenticacion()">Enviar Devoluciones</button>
      </div>
    </div>

    <div id="overlay">
      <div class="spinner"></div>
      <div id="loadingMessage">
        <h4>Por favor espera un momento...</h4>
        <p></p>
      </div>
    </div>
  </div>

<script>
  // Variables globales
  let devoluciones = []; // Stores all fetched pending returns (original data from sheet)
  let editedEntries = {}; 
  let entryCounter = 0; // To generate unique IDs for dynamically added entries

  const CORRECT_PASSWORD = "macdel1";
  const AUTH_KEY = "pb_auth";
  const AUTH_EXPIRATION_HOURS = 24; // La autenticación dura 24 horas

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('main-content').style.display = 'block';
    cargarDevolucionesPendientes();
  });

  function verificarAutenticacion() {
    // Check if any quantity > 0
    const hasValidEntries = Object.values(editedEntries).some(entry => entry.cantidad > 0);

    if (!hasValidEntries) {
      Swal.fire('Advertencia', 'No has ingresado cantidades para devolver (deben ser mayores a 0).', 'warning');
      return;
    }
    
    const authData = obtenerAuthData();
    
    if (authData && authData.authenticated && !haExpiradoAuth(authData.fecha)) {
      enviarDevoluciones();
    } else {
      solicitarContrasena();
    }
  }

  function obtenerAuthData() {
    const authData = localStorage.getItem(AUTH_KEY);
    return authData ? JSON.parse(authData) : null;
  }

  function haExpiradoAuth(fechaAuth) {
    const fechaAuthObj = new Date(fechaAuth);
    const ahora = new Date();
    const diferenciaHoras = (ahora - fechaAuthObj) / (1000 * 60 * 60);
    return diferenciaHoras >= AUTH_EXPIRATION_HOURS;
  }

  function guardarAuthExitosa() {
    const authData = {
      authenticated: true,
      fecha: new Date().toISOString()
    };
    localStorage.setItem(AUTH_KEY, JSON.stringify(authData));
  }

  function solicitarContrasena() {
    const passwordProtection = document.getElementById('password-protection');
    const passwordInput = document.getElementById('password-input');
    const passwordError = document.getElementById('password-error');
    
    passwordProtection.style.display = 'flex';
    passwordInput.value = '';
    passwordInput.focus();
    passwordError.style.display = 'none';
    
    document.getElementById('password-submit').onclick = function() {
      if (passwordInput.value === CORRECT_PASSWORD) {
        guardarAuthExitosa();
        passwordProtection.style.display = 'none';
        enviarDevoluciones();
      } else {
        passwordError.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
      }
    };
    
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('password-submit').click();
      }
    });
  }

  function cerrarDialogoContrasena() {
    document.getElementById('password-protection').style.display = 'none';
  }

  function cargarDevolucionesPendientes() {
    $('#overlay').show();
    $('#devoluciones-body').empty().append('<tr><td colspan="7" style="text-align: center;">Cargando datos...</td></tr>'); // Colspan 7
    
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwQrmkh9WK_cVCPkxEKOmBxwxS1PWF1gPYCQqFzmzNHxQ5aeEsGoAmKZZh87iiQrzwA/exec?action=obtenerDevoluciones";
    
    $.ajax({
      url: scriptUrl,
      type: "GET",
      dataType: "json",
      success: function(data) {
        $('#overlay').hide();
        console.log("Respuesta del servidor:", data); 
        
        if (data.error) {
          mostrarError(data.mensaje || "Error al cargar devoluciones");
          return;
        }
        
        if (!data.devoluciones) {
          mostrarError("Formato de respuesta inválido");
          return;
        }
        
        devoluciones = data.devoluciones;
        mostrarDevolucionesEnUI();
      },
      error: function(xhr, status, error) {
        $('#overlay').hide();
        console.error("Error en la solicitud:", status, error, xhr.responseText);
        
        let errorMsg = "Error al conectar con el servidor";
        try {
          const response = JSON.parse(xhr.responseText);
          errorMsg = response.error || response.mensaje || errorMsg;
        } catch (e) {}
        
        mostrarError(errorMsg);
      }
    });
  }

  function mostrarError(mensaje) {
    $('#devoluciones-body').empty().append(`<tr><td colspan="7" style="text-align: center; color: red;">${mensaje}</td></tr>`); // Colspan 7
    document.getElementById('btn-enviar').disabled = true;
    
    Swal.fire({
      title: 'Error',
      text: mensaje,
      icon: 'error',
      confirmButtonText: 'Entendido'
    });
  }

  function mostrarDevolucionesEnUI() {
    const tbody = $('#devoluciones-body');
    tbody.empty();
    
    if (devoluciones.length === 0) {
      tbody.append('<tr><td colspan="7" class="no-results">No hay devoluciones pendientes</td></tr>'); // Colspan 7
      return;
    }
    
    devoluciones.forEach((devolucion, index) => {
      // Each original row will have at least one entry, indexed as "index-0" 
      const entryId = `${index}-0`; 
      editedEntries[entryId] = { // Initialize the first entry for this row
          rowId: devolucion.rowId,
          originalIndex: index, // Store original index for data lookup
          cantidad: 0,
          nivel: '',
          cuerposBajos: '',
          // Store original data needed for history (even if columns are hidden)
          fechaOriginal: devolucion.fecha,
          horaOriginal: devolucion.hora,
          colaborador: devolucion.colaborador,
          area: devolucion.area, // Aquí 'area' se usará como 'Edificio'
          producto: devolucion.producto,
          cantidadSalida: devolucion.cantidadSalida,
          cantidadDevuelta: devolucion.cantidadDevuelta,
          cantidadPendiente: devolucion.cantidadPendiente,
          estado: devolucion.estado
      };

      appendDevolucionRow(devolucion, index, 0); // Append the initial row
    });
    
    document.getElementById('btn-enviar').disabled = Object.keys(editedEntries).length === 0; // Check initial state
  }

  function appendDevolucionRow(devolucion, originalIndex, entryNumber) {
      const tbody = $('#devoluciones-body');
      const entryId = `${originalIndex}-${entryNumber}`;
      const isCuerposBajos = devolucion.area === 'Cuerpos Bajos';

      const cuerposBajosHtml = isCuerposBajos ? `
        <select class="cuerpos-bajos-select"
                id="select-cuerpos-bajos-${entryId}"
                onchange="manejarInputCuerposBajoss('${entryId}')">
            <option value="">Seleccione</option>
            <option value="CBA" ${editedEntries[entryId].cuerposBajos === 'CBA' ? 'selected' : ''}>CBA</option>
            <option value="CBB" ${editedEntries[entryId].cuerposBajos === 'CBB' ? 'selected' : ''}>CBB</option>
            <option value="CBC" ${editedEntries[entryId].cuerposBajos === 'CBC' ? 'selected' : ''}>CBC</option>
        </select>
      ` : `<span></span>`; // Cambiado de 'N/A' a vacío

      const rowClass = entryNumber > 0 ? 'data-row additional-entry' : 'data-row';

      const rowHtml = `
        <tr id="row-${entryId}" class="${rowClass}" data-original-index="${originalIndex}">
          <td class="edificio">${entryNumber === 0 ? devolucion.area : ''}</td> 
          <td class="producto">${entryNumber === 0 ? devolucion.producto : ''}</td>
          <td>${entryNumber === 0 ? devolucion.cantidadPendiente : ''}</td>
          <td>
            <div class="quantity-controls">
                <button type="button" class="quantity-button quantity-minus-button" onclick="cambiarCantidad('${entryId}', -1, ${devolucion.cantidadPendiente})">-</button>
                <input type="number" 
                       class="cantidad-input" 
                       id="input-cantidad-${entryId}" 
                       min="0" 
                       max="${devolucion.cantidadPendiente}" 
                       value="${editedEntries[entryId].cantidad}"
                       oninput="manejarInputDevolver('${entryId}', ${devolucion.cantidadPendiente})" autocomplete="off">
                <button type="button" class="quantity-button quantity-plus-button" onclick="cambiarCantidad('${entryId}', 1, ${devolucion.cantidadPendiente})">+</button>
            </div>
          </td>
          <td> 
            <input type="text"
                   class="nivel-input"
                   id="input-nivel-${entryId}"
                   min="0"
                   value="${editedEntries[entryId].nivel}"
                   oninput="manejarInputNivel('${entryId}')" autocomplete="off">
          </td>
          <td>${cuerposBajosHtml}</td>
          <td>
            ${entryNumber === 0 ? 
                `<button class="add-more-btn" onclick="agregarMasEntradas(${originalIndex})">Agregar Más</button>` 
                : 
                `
                <div id="action-buttons-container-${entryId}" style="display: flex; gap: 5px; justify-content: center;">
                    <button class="delete-entry-btn" id="delete-btn-${entryId}" onclick="prepararEliminar('${entryId}')">Eliminar</button>
                    <button class="confirm-delete-btn" id="confirm-btn-${entryId}" style="display:none;" onclick="confirmarEliminar('${entryId}')">✓</button>
                    <button class="cancel-delete-btn" id="cancel-btn-${entryId}" style="display:none;" onclick="cancelarEliminar('${entryId}')">✕</button>
                </div>
                `
            }
          </td>
        </tr>
      `;
      // Append the new row after the last entry for this originalIndex
      if (entryNumber === 0) {
          tbody.append(rowHtml);
      } else {
          // Find the last row associated with this originalIndex and insert after it
          $(`#tabla-devoluciones tr[data-original-index='${originalIndex}']`).last().after(rowHtml);
      }
      
  }

  function agregarMasEntradas(originalIndex) {
      const originalDevolucion = devoluciones[originalIndex];
      // Increment the entry counter for this original devolution to create a unique ID
      let nextEntryNumber = 0;
      // Find the highest entry number for this original index
      Object.keys(editedEntries).forEach(key => {
          const [idx, entryNum] = key.split('-');
          if (parseInt(idx) === originalIndex) {
              if (parseInt(entryNum) >= nextEntryNumber) {
                  nextEntryNumber = parseInt(entryNum) + 1;
              }
          }
      });

      const newEntryId = `${originalIndex}-${nextEntryNumber}`;
      editedEntries[newEntryId] = {
          rowId: originalDevolucion.rowId,
          originalIndex: originalIndex,
          cantidad: 0,
          nivel: '',
          cuerposBajos: '',
          // Carry over original data for history
          fechaOriginal: originalDevolucion.fecha,
          horaOriginal: originalDevolucion.hora,
          colaborador: originalDevolucion.colaborador,
          area: originalDevolucion.area,
          producto: originalDevolucion.producto,
          cantidadSalida: originalDevolucion.cantidadSalida,
          cantidadDevuelta: originalDevolucion.cantidadDevuelta,
          cantidadPendiente: originalDevolucion.cantidadPendiente,
          estado: originalDevolucion.estado
      };
      appendDevolucionRow(originalDevolucion, originalIndex, nextEntryNumber);
      // Re-apply filter in case something was searched
      filtrarTabla();
      // Ensure the button is enabled as a new editable entry was added
      document.getElementById('btn-enviar').disabled = false;
  }

  // NUEVA FUNCIÓN: Preparar la eliminación mostrando botones de confirmación
  function prepararEliminar(entryId) {
      document.getElementById(`delete-btn-${entryId}`).style.display = 'none';
      document.getElementById(`confirm-btn-${entryId}`).style.display = 'inline-block';
      document.getElementById(`cancel-btn-${entryId}`).style.display = 'inline-block';
  }

  // NUEVA FUNCIÓN: Confirmar y eliminar la entrada
  function confirmarEliminar(entryId) {
      delete editedEntries[entryId]; // Remove from our tracking object
      $(`#row-${entryId}`).remove(); // Remove from UI
      
      // Check if any entries are left to enable/disable button
      const hasValidEntries = Object.values(editedEntries).some(entry => entry.cantidad > 0);
      document.getElementById('btn-enviar').disabled = !hasValidEntries;

      // No Swal.fire here, silent deletion
  }

  // NUEVA FUNCIÓN: Cancelar la eliminación y restaurar el botón original
  function cancelarEliminar(entryId) {
      document.getElementById(`delete-btn-${entryId}`).style.display = 'inline-block';
      document.getElementById(`confirm-btn-${entryId}`).style.display = 'none';
      document.getElementById(`cancel-btn-${entryId}`).style.display = 'none';
  }


  // MODIFICADO: filtrarTabla para aceptar múltiples términos y buscar en Edificio (antes Área) y Producto
  function filtrarTabla() {
    const searchText = document.getElementById('search-input').value.toLowerCase().trim();
    const keywords = searchText.split(' ').filter(keyword => keyword.length > 0); // Divide por espacios

    const rows = document.querySelectorAll('#devoluciones-body .data-row');
    let hasResults = false;
    
    rows.forEach(row => {
      const originalIndex = row.dataset.originalIndex;
      const entryNumber = parseInt(row.id.split('-')[2]);

      if (entryNumber === 0) { // Solo filtrar basándose en la entrada principal
          // CAMBIADO: de '.area' a '.edificio'
          const edificio = row.querySelector('.edificio').textContent.toLowerCase(); 
          const producto = row.querySelector('.producto').textContent.toLowerCase();
          
          let matches = true;
          if (keywords.length > 0) {
              matches = keywords.every(keyword => 
                  edificio.includes(keyword) || 
                  producto.includes(keyword)
              );
          }

          if (matches) {
            row.style.display = '';
            hasResults = true;
            // También mostrar cualquier entrada adicional asociada
            $(`tr[data-original-index='${originalIndex}'][id^='row-${originalIndex}-']`).show();
          } else {
            row.style.display = 'none';
            // También ocultar cualquier entrada adicional asociada
            $(`tr[data-original-index='${originalIndex}'][id^='row-${originalIndex}-']`).hide();
          }
      }
    });
    
    const noResultsRow = document.querySelector('#devoluciones-body .no-results');
    if (!hasResults && devoluciones.length > 0) {
      if (!noResultsRow) {
        $('#devoluciones-body').append('<tr><td colspan="7" class="no-results">No se encontraron resultados</td></tr>');
      }
    } else if (noResultsRow) {
      noResultsRow.remove();
    }
  }

  // Function to handle quantity input changes for a specific entry
  function manejarInputDevolver(entryId, maxCantidadPendienteOriginal) {
      const input = document.getElementById(`input-cantidad-${entryId}`);
      let proposedValue = parseInt(input.value) || 0;

      if (proposedValue < 0) {
          proposedValue = 0;
      }
      input.value = proposedValue; // Ensure UI reflects valid non-negative number immediately

      const [originalIndexStr] = entryId.split('-');
      const originalIndex = parseInt(originalIndexStr);

      let sumOfQuantitiesExcludingCurrent = 0;
      // Calculate the sum of quantities for all OTHER entries related to the same original item.
      for (const id in editedEntries) {
          if (id === entryId) { // Skip the current entry
              continue;
          }
          const entry = editedEntries[id];
          if (entry.originalIndex === originalIndex) {
              sumOfQuantitiesExcludingCurrent += entry.cantidad;
          }
      }

      const totalAfterProposedChange = sumOfQuantitiesExcludingCurrent + proposedValue;

      if (totalAfterProposedChange > maxCantidadPendienteOriginal) {
          // Calculate the maximum allowed value for the current input
          const allowedValueForCurrentInput = maxCantidadPendienteOriginal - sumOfQuantitiesExcludingCurrent;
          
          // Adjust proposedValue to be within limits, ensuring it's not negative
          proposedValue = Math.max(0, allowedValueForCurrentInput);

          editedEntries[entryId].cantidad = proposedValue;
          input.value = proposedValue; // Update the UI input field with the adjusted value
          
          // La alerta de límite excedido ha sido eliminada por solicitud del usuario
      } else {
          // If within limits, just update the stored quantity
          editedEntries[entryId].cantidad = proposedValue;
      }
      
      actualizarEstadoBotonEnviar();
  }

  // New function to handle +/- button clicks
  function cambiarCantidad(entryId, delta, max) {
      const input = document.getElementById(`input-cantidad-${entryId}`);
      let currentValue = parseInt(input.value) || 0;
      let newValue = currentValue + delta;

      // Temporary update input.value before calling manejarInputDevolver
      input.value = newValue; 
      manejarInputDevolver(entryId, max); // This will handle validation and final value setting
  }


  // MODIFICADO: manejarInputNivel para permitir 'X' o números
  function manejarInputNivel(entryId) {
      const input = document.getElementById(`input-nivel-${entryId}`);
      let value = input.value.trim(); 

      const upperCaseValue = value.toUpperCase();

      if (upperCaseValue === 'X') {
          editedEntries[entryId].nivel = upperCaseValue;
      } else if (value !== '' && isNaN(parseInt(value))) {
          input.value = '';
          editedEntries[entryId].nivel = '';
      } else if (value !== '') {
          value = Math.max(0, parseInt(value)).toString();
          input.value = value;
          editedEntries[entryId].nivel = value;
      } else {
          editedEntries[entryId].nivel = '';
      }
      actualizarEstadoBotonEnviar();
  }

  // New function to handle cuerposBajos select changes for a specific entry
  function manejarInputCuerposBajoss(entryId) {
      const select = document.getElementById(`select-cuerpos-bajos-${entryId}`);
      editedEntries[entryId].cuerposBajos = select.value;
      actualizarEstadoBotonEnviar();
  }

  // Consolidated function to update the send button's state
  function actualizarEstadoBotonEnviar() {
      // The button is enabled if ANY entry has a quantity > 0
      const hasValidEntries = Object.values(editedEntries).some(entry => entry.cantidad > 0);
      document.getElementById('btn-enviar').disabled = !hasValidEntries;
  }

  // MODIFICADO: enviarDevoluciones para enviar un array de entradas
  function enviarDevoluciones() {
      const datosParaEnviar = [];
      let validationError = false;

      // Iterate through all entries in editedEntries
      for (const entryId in editedEntries) {
          const currentEntry = editedEntries[entryId];
          
          const cantidadValida = currentEntry.cantidad > 0;
          const nivelValido = currentEntry.nivel !== '';
          const cuerposBajosValido = currentEntry.area !== 'Cuerpos Bajos' || (currentEntry.area === 'Cuerpos Bajos' && currentEntry.cuerposBajos !== '');

          // MODIFICACIÓN CLAVE AQUÍ: Solo incluir la entrada si tiene cantidad > 0.
          if (cantidadValida) { // Only proceed if quantity is greater than 0
              // Validations for Nivel and Cuerpos Bajos are now dependent on cantidadValida
              if (!nivelValido) { // If cantidad > 0, Nivel must be valid
                  Swal.fire('Advertencia', `Para el producto '${currentEntry.producto}' del área '${currentEntry.area}', ingresó una cantidad para devolver pero no el Nivel en una de las entradas. Por favor, complete la información.`, 'warning');
                  validationError = true;
                  break; 
              }

              if (currentEntry.area === 'Cuerpos Bajos' && !currentEntry.cuerposBajos) { // If area is Cuerpos Bajos and cantidad > 0, Cuerpos Bajos must be valid
                  Swal.fire('Advertencia', `Para el producto '${currentEntry.producto}' del área 'Cuerpos Bajos', por favor, seleccione una opción de Cuerpos Bajos (CBA, CBB, CBC) en una de las entradas.`, 'warning');
                  validationError = true;
                  break; 
              }
              
              // Only add to datosParaEnviar if all conditions are met and it's a valid entry that needs processing
              datosParaEnviar.push({
                  rowId: currentEntry.rowId, // Original rowId from the sheet
                  cantidad: currentEntry.cantidad,
                  nivel: currentEntry.nivel,
                  cuerposBajos: currentEntry.cuerposBajos,
                  // Pass original metadata for history logging (as it's the same for all entries of this rowId)
                  colaborador: currentEntry.colaborador,
                  area: currentEntry.area,
                  producto: currentEntry.producto
              });
          }
      }

      if (validationError) {
          return; // Stop the process due to validation errors
      }

      // NUEVO MENSAJE DE ADVERTENCIA si no hay entradas válidas para enviar
      if (datosParaEnviar.length === 0) {
        Swal.fire('Advertencia', 'No hay devoluciones válidas para enviar. Ingrese una cantidad mayor a 0 para proceder.', 'warning');
        return;
      }

      $('#overlay').show();
      
      const scriptUrl = "https://script.google.com/macros/s/AKfycbyZPzFs6KJcnDL6f-AeC4n0Pz4E0o9tPvq73MYgGVgelWh38xD9_CvhvjbCXmzxkKk/exec";
      
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.name = 'hiddenFrame';
      document.body.appendChild(iframe);
      
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = scriptUrl;
      form.target = 'hiddenFrame';
      
      const actionInput = document.createElement('input');
      actionInput.type = 'hidden';
      actionInput.name = 'action';
      actionInput.value = 'actualizarDevoluciones';
      form.appendChild(actionInput);
      
      const dataInput = document.createElement('input');
      dataInput.type = 'hidden';
      dataInput.name = 'devoluciones';
      dataInput.value = JSON.stringify(datosParaEnviar);
      form.appendChild(dataInput);
      
      document.body.appendChild(form);
      form.submit();
      
      setTimeout(() => {
          $('#overlay').hide();
          Swal.fire({
              title: '¡Éxito!',
              html: 'Devoluciones registradas correctamente',
              icon: 'success',
              confirmButtonText: 'Aceptar'
          }).then(() => {
              location.reload();
          });
          
          document.body.removeChild(form);
          document.body.removeChild(iframe);
      }, 3000);
  }
</script>
</body>
</html>