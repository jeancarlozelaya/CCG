<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empleados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --warning-color: #f39c12;
        --dark-color: #34495e;
        --text-color: #333;
        --border-color: #ddd;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
        color: var(--text-color);
        line-height: 1.6;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        text-align: center;
        padding: 18px 0;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: var(--shadow);
        position: relative;
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 25px;
        font-size: 1.8rem;
        position: relative;
        padding-bottom: 10px;
        font-weight: bold;
    }

    h1:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background-color: var(--secondary-color);
        border-radius: 2px;
    }

    .container {
        max-width: 1200px;
        margin: 25px auto;
        padding: 0 15px;
    }

    .card {
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: none;
        margin-bottom: 25px;
    }

    .card-header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 18px 25px;
        font-weight: 600;
        font-size: 1.1rem;
        position: relative;
        overflow: hidden;
    }

    .card-header:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
    }

    .nav-tabs .nav-link {
        color: var(--dark-color);
        font-weight: 500;
        border: none;
        padding: 12px 20px;
    }

    .nav-tabs .nav-link.active {
        color: var(--secondary-color);
        border-bottom: 3px solid var(--secondary-color);
        background-color: transparent;
    }

    .tab-content {
        padding: 25px;
        background-color: white;
        border-radius: 0 0 12px 12px;
    }

    /* Estilo uniforme para todos los títulos de sección */
    .tab-title {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
        padding: 20px 0;
        position: relative;
    }

    .tab-title h2 {
        font-size: 1.5rem; /* Tamaño reducido */
        font-weight: 700;
        margin: 0;
        display: inline-block;
        padding: 0 25px;
        position: relative;
    }

    .tab-title h2:after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        border-radius: 2px;
    }

    .tab-title h2:before {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        right: 0;
        height: 1px;
        background-color: var(--border-color);
    }

    .stat-card {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 15px;
        transition: var(--transition);
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-card .icon {
        font-size: 1.8rem;
        margin-bottom: 10px;
    }

    .stat-card h3 {
        font-size: 1.5rem;
        margin-bottom: 5px;
        font-weight: 700;
    }

    .stat-card p {
        color: #7f8c8d;
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }

    .table th {
        background-color: var(--primary-color);
        color: white;
        border: none;
    }

    .table td {
        vertical-align: middle;
    }
    
    .table td ul {
        padding-left: 18px;
        margin-bottom: 0;
    }

    .btn-action {
        padding: 5px 10px;
        margin: 0 2px;
        font-size: 0.85rem;
    }

    .btn-edit {
        background-color: var(--warning-color);
        border-color: var(--warning-color);
        color: white;
    }

    .btn-delete {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }

    .search-container {
        position: relative;
        margin-bottom: 20px;
    }

    .search-container i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
    }

    .search-container input {
        padding-left: 40px;
    }

    #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        display: none; /* Oculto por defecto */
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(52, 152, 219, 0.2);
        border-radius: 50%;
        border-top-color: var(--secondary-color);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    #loadingMessage {
        text-align: center;
        color: var(--dark-color);
    }

    #loadingMessage h4 {
        margin: 0 0 10px;
        font-size: 1.3rem;
        font-weight: bold;
    }

    #loadingMessage p {
        margin: 0;
        color: #7f8c8d;
        font-weight: normal;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .date-range-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .date-range-container .form-group {
        flex: 1;
        min-width: 200px;
    }

    .autocomplete-container {
        position: relative;
    }

    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .autocomplete-item:hover {
        background-color: #f5f5f5;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .rotacion-periodos {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .periodo-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .periodo-card h4 {
        font-size: 1.1rem;
        margin-bottom: 10px;
    }

    .periodo-card .porcentaje {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .periodo-card .detalle {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .ausencias-stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 25px;
    }

    /* Estilos mejorados para botones principales */
    .btn-primary, .btn-success {
        border: none;
        font-weight: 600;
        padding: 12px 30px;
        font-size: 1rem;
        border-radius: 50px;
        min-width: 200px;
        transition: var(--transition);
        color: white !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .btn-primary {
        background: linear-gradient(45deg, var(--secondary-color), #5dade2);
    }

    .btn-success {
        background: linear-gradient(45deg, #2ecc71, #58d68d);
    }

    .btn-primary:hover, .btn-success:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    #btn-agregar-colaborador, #btn-agregar-ausencia {
        min-width: 150px;
    }

    .cumpleanero-card {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        border-top: 5px solid var(--primary-color);
    }
    .cumpleanero-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.12);
        border-top-color: var(--secondary-color);
    }
    .cumpleanero-img-container {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 0 auto 15px auto;
        border: 5px solid #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f0f0f0;
        overflow: hidden;
    }
    .cumpleanero-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .cumpleanero-img-icon {
        font-size: 60px;
        color: #ccc;
    }
    .cumpleanero-info h5 {
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 5px;
    }
    .cumpleanero-info p {
        color: #7f8c8d;
        font-weight: 500;
        margin-bottom: 0;
    }
    .cumpleanero-info .badge {
        font-size: 0.9rem;
        padding: 5px 10px;
        background-color: var(--secondary-color) !important;
    }

    .resumen-disciplina-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s ease;
    }
    .resumen-disciplina-item:hover {
        background-color: #f5f5f5;
    }
    .resumen-disciplina-item:last-child {
        border-bottom: none;
    }
    .resumen-disciplina-img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 15px;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .resumen-disciplina-info {
        flex-grow: 1;
    }
    .resumen-disciplina-info h6 {
        margin-bottom: 2px;
        font-weight: bold;
    }


    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr 1fr;
        }
        .rotacion-periodos {
            grid-template-columns: 1fr 1fr;
        }
        .ausencias-stats {
            grid-template-columns: 1fr;
        }
        .date-range-container {
            flex-direction: column;
        }
        .date-range-container .form-group {
            min-width: 100%;
        }
        .date-range-container .btn {
            width: 100%;
        }
        .tab-title h2 {
            font-size: 1.3rem;
            padding: 0 18px;
        }
        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .nav-tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .nav-item {
            flex-shrink: 0;
        }
    }

    @media (max-width: 576px) {
        h1 {
            font-size: 1.5rem;
        }
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        .rotacion-periodos {
            grid-template-columns: 1fr;
        }
        .nav-tabs .nav-link {
            padding: 10px 15px;
            font-size: 0.9rem;
        }
        .tab-content {
            padding: 15px;
        }
        .tab-title h2 {
            font-size: 1.2rem;
            padding: 0 15px;
        }
        .btn-primary, .btn-success {
            min-width: 100%;
            padding: 10px 25px;
            font-size: 1rem;
        }
    }
 
    .btn-photo {
        background-color: #17a2b8;
        border-color: #17a2b8;
        color: white;
    }

    .btn-action {
        padding: 5px 10px;
        margin: 0 2px;
        font-size: 0.85rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 8px;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(52, 152, 219, 0.05);
        transform: scale(1.01);
        transition: var(--transition);
    }
    
    .formulario-item {
        border: 1px solid var(--border-color);
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        position: relative;
        background-color: #fdfdfd;
    }

    .btn-quitar-item {
        position: absolute;
        top: 10px;
        right: 10px;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

</style>
</head>
<body>
    <div id="main-content" style="display: none;">
        <div class="header">Pisos Brillantes</div>
        <div class="container">
            <h1>Gestión de Empleados</h1>

            <div class="card">
                <div class="card-body p-0">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                                <i class="fas fa-home me-2"></i>Dashboard
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="registrar-tab" data-bs-toggle="tab" data-bs-target="#registrar" type="button" role="tab" aria-controls="registrar" aria-selected="false">
                                <i class="fas fa-user-plus me-2"></i>Registrar Colaborador
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="activos-tab" data-bs-toggle="tab" data-bs-target="#activos" type="button" role="tab" aria-controls="activos" aria-selected="false">
                                <i class="fas fa-users me-2"></i>Personal Activo
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="rotacion-tab" data-bs-toggle="tab" data-bs-target="#rotacion" type="button" role="tab" aria-controls="rotacion" aria-selected="false">
                                <i class="fas fa-chart-line me-2"></i>Tasa de Rotación
                            </button>
                        </li>
                         <li class="nav-item" role="presentation">
                            <button class="nav-link" id="registrar-ausencia-tab" data-bs-toggle="tab" data-bs-target="#registrar-ausencia" type="button" role="tab" aria-controls="registrar-ausencia" aria-selected="false">
                                <i class="fas fa-user-clock me-2"></i>Registrar Ausencia
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ausencias-tab" data-bs-toggle="tab" data-bs-target="#ausencias" type="button" role="tab" aria-controls="ausencias" aria-selected="false">
                                <i class="fas fa-clock me-2"></i>Historial Ausencias
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="disciplina-tab" data-bs-toggle="tab" data-bs-target="#disciplina" type="button" role="tab" aria-controls="disciplina" aria-selected="false">
                                <i class="fas fa-gavel me-2"></i>Historial de Disciplina
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cumpleaneros-tab" data-bs-toggle="tab" data-bs-target="#cumpleaneros" type="button" role="tab" aria-controls="cumpleaneros" aria-selected="false">
                                <i class="fas fa-birthday-cake me-2"></i>Cumpleañeros
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                            <div class="tab-title">
                                <h2>Resumen de Colaboradores</h2>
                            </div>
                            
                            <div class="dashboard-grid">
                                <div class="stat-card" style="background-color: #e8f4fd;">
                                    <div class="icon text-primary">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h3 id="total-activos">0</h3>
                                    <p>Total de Activos</p>
                                </div>

                                <div class="stat-card" style="background-color: #f4ecf7;">
                                    <div class="icon text-info">
                                        <i class="fas fa-user-clock"></i>
                                    </div>
                                    <h3 id="ausencias-hoy">0</h3>
                                    <p>Ausencias Hoy</p>
                                </div>
                                
                                <div class="stat-card" style="background-color: #e8f8f5;">
                                    <div class="icon text-success">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <h3 id="presentes-hoy">0</h3>
                                    <p>Presentes Hoy</p>
                                </div>

                                <div class="stat-card" style="background-color: #e8f6f3;">
                                    <div class="icon text-success">
                                        <i class="fas fa-male"></i>
                                    </div>
                                    <h3 id="total-hombres">0</h3>
                                    <p>Hombres</p>
                                </div>
                                
                                <div class="stat-card" style="background-color: #fdedec;">
                                    <div class="icon text-danger">
                                        <i class="fas fa-female"></i>
                                    </div>
                                    <h3 id="total-mujeres">0</h3>
                                    <p>Mujeres</p>
                                </div>
                                
                                <div class="stat-card" style="background-color: #fef9e7;">
                                    <div class="icon text-warning">
                                        <i class="fas fa-birthday-cake"></i>
                                    </div>
                                    <h3 id="edad-promedio">0</h3>
                                    <p>Edad Promedio</p>
                                </div>
                                
                                <div class="stat-card" style="background-color: #fff3cd;">
                                    <div class="icon text-warning">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <h3 id="rotacion-mes-dashboard">0%</h3>
                                    <p>Rotación del Mes</p>
                                </div>

                                <div class="stat-card" style="background-color: #d1ecf1;">
                                    <div class="icon text-info">
                                        <i class="fas fa-calendar-day"></i>
                                    </div>
                                    <h3 id="ausentismo-mes-dashboard">0%</h3>
                                    <p>% Ausentismo del Mes</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    Últimos 5 Ingresos Registrados
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="tabla-ultimos-ingresos">
                                            <thead>
                                                <tr>
                                                    <th>Fecha</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Fecha Nacimiento</th>
                                                    <th>Sexo</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    Últimos 5 Egresos Registrados
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="tabla-ultimos-egresos">
                                            <thead>
                                                <tr>
                                                    <th>Fecha Egreso</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Razón</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="registrar" role="tabpanel" aria-labelledby="registrar-tab">
                            <div class="tab-title">
                                <h2>Registrar Nuevo Colaborador</h2>
                            </div>
                            
                            <form id="form-registrar-colaborador">
                                <div id="contenedor-formularios-colaborador">
                                    <div class="formulario-item">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="fecha-inicio" class="form-label">Fecha de Inicio</label>
                                                <input type="date" class="form-control fecha-inicio" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="nombre-completo" class="form-label">Nombre Completo</label>
                                                <input type="text" class="form-control nombre-completo" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="identidad" class="form-label">Identidad</label>
                                                <input type="text" class="form-control identidad" placeholder="0000-0000-00000" pattern="\d{4}-\d{4}-\d{5}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="fecha-nacimiento" class="form-label">Fecha de Nacimiento (Opcional)</label>
                                                <input type="date" class="form-control fecha-nacimiento">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="sexo" class="form-label">Sexo</label>
                                                <select class="form-select sexo" required>
                                                    <option value="">Seleccionar...</option>
                                                    <option value="Masculino">Masculino</option>
                                                    <option value="Femenino">Femenino</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="row align-items-center">
                                                    <div class="col-md-7">
                                                        <label for="foto-colaborador" class="form-label">Foto (opcional)</label>
                                                        <input type="file" class="form-control foto-colaborador" accept="image/*" onchange="mostrarVistaPreviaFoto(this)">
                                                        <div class="form-text">JPG, PNG. Máx 5MB</div>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <div class="vista-previa-container mt-2 mt-md-0 text-center"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-center mt-4">
                                    <button type="button" class="btn btn-success" id="btn-agregar-colaborador"><i class="fas fa-plus me-2"></i>Agregar</button>
                                    <button type="button" class="btn btn-primary" id="btn-registrar-colaborador">Registrar Colaboradores</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="tab-pane fade" id="activos" role="tabpanel" aria-labelledby="activos-tab">
                            <div class="tab-title">
                                <h2>Personal Activo</h2>
                            </div>
                            
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" id="buscador-activos" placeholder="Buscar por nombre o identidad...">
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tabla-activos">
                                    <thead>
                                        <tr>
                                            <th>Fecha Inicio</th>
                                            <th>Nombre</th>
                                            <th>Identidad</th>
                                            <th>Fecha Nacimiento</th>
                                            <th>Sexo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="rotacion" role="tabpanel" aria-labelledby="rotacion-tab">
                            <div class="tab-title">
                                <h2>Tasa de Rotación</h2>
                            </div>
                            
                            <div class="rotacion-periodos">
                                <div class="periodo-card">
                                    <h4>Rotación General</h4>
                                    <div class="porcentaje" id="rotacion-general">0%</div>
                                    <div class="detalle" id="detalle-general">0 egresos</div>
                                </div>
                                <div class="periodo-card">
                                    <h4>Rotación del Mes</h4>
                                    <div class="porcentaje" id="rotacion-mes">0%</div>
                                    <div class="detalle" id="detalle-mes">0 egresos</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h4>Últimos 3 Meses</h4>
                                    <div class="porcentaje" id="rotacion-3meses">0%</div>
                                    <div class="detalle" id="detalle-3meses">0 egresos</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <h4>Últimos 6 Meses</h4>
                                    <div class="porcentaje" id="rotacion-6meses">0%</div>
                                    <div class="detalle" id="detalle-6meses">0 egresos</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <h4>Últimos 12 Meses</h4>
                                    <div class="porcentaje" id="rotacion-12meses">0%</div>
                                    <div class="detalle" id="detalle-12meses">0 egresos</div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">
                                    Motivos de Egreso
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-mes-egresos" class="form-select" style="width: auto;"></select>
                                        <select id="filtro-ano-egresos" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-egresos" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoEgresosMotivoActual"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoEgresosMotivoHistorico"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4" id="contenedorGraficoFiltradoEgresos" style="display: none;">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoEgresosMotivoFiltrado"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    Historial de Egresos
                                </div>
                                <div class="card-body">
                                    <div class="date-range-container">
                                        <div class="form-group">
                                            <label for="fecha-inicio-personalizado" class="form-label">Filtrar desde</label>
                                            <input type="date" class="form-control" id="fecha-inicio-personalizado">
                                        </div>
                                        <div class="form-group">
                                            <label for="fecha-fin-personalizado" class="form-label">Filtrar hasta</label>
                                            <input type="date" class="form-control" id="fecha-fin-personalizado">
                                        </div>
                                        <div class="form-group d-flex align-items-end">
                                            <button type="button" class="btn btn-primary" id="btn-calcular-rotacion-personalizado">Filtrar</button>
                                        </div>
                                    </div>
                                    
                                    <div class="search-container mt-4">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control" id="buscador-egresos" placeholder="Buscar por nombre, identidad o motivo...">
                                    </div>
                                    
                                    <div class="table-responsive mt-3">
                                        <table class="table table-striped table-hover" id="tabla-egresos">
                                            <thead>
                                                <tr>
                                                    <th>Fecha Egreso</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Razón</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="registrar-ausencia" role="tabpanel" aria-labelledby="registrar-ausencia-tab">
                            <div class="tab-title">
                                <h2>Registrar Nueva Ausencia</h2>
                            </div>
                             <div class="card mb-4">
                                <div class="card-body">
                                    <form id="form-registrar-ausencia">
                                        <div id="contenedor-formularios-ausencia">
                                            <div class="formulario-item">
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Fecha de Ausencia</label>
                                                        <input type="date" class="form-control fecha-ausencia" required>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Días de Ausencia</label>
                                                        <input type="number" class="form-control dias-incapacidad" value="1" min="1" required>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Colaborador</label>
                                                        <div class="autocomplete-container">
                                                            <input type="text" class="form-control colaborador-ausencia" placeholder="Escriba el nombre..." required>
                                                            <div class="autocomplete-list"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Motivo</label>
                                                        <select class="form-select motivo-ausencia" required>
                                                            <option value="">Seleccionar...</option>
                                                            <option value="Incapacidad">Incapacidad</option>
                                                            <option value="Permiso">Permiso</option>
                                                            <option value="Falta Injustificada">Falta Injustificada</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Observaciones</label>
                                                        <textarea class="form-control observaciones-ausencia" rows="1"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid gap-2 d-md-flex justify-content-center mt-4">
                                            <button type="button" class="btn btn-success" id="btn-agregar-ausencia"><i class="fas fa-plus me-2"></i>Agregar</button>
                                            <button type="button" class="btn btn-primary" id="btn-registrar-ausencia">Registrar Ausencias</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="ausencias" role="tabpanel" aria-labelledby="ausencias-tab">
                            <div class="tab-title">
                                <h2>Historial de Ausencias</h2>
                            </div>
                            
                            <div class="rotacion-periodos">
                                <div class="periodo-card">
                                    <h4>Ausentismo Histórico</h4>
                                    <div class="porcentaje" id="ausentismo-historico">0%</div>
                                </div>
                                <div class="periodo-card">
                                    <h4>Ausentismo del Mes</h4>
                                    <div class="porcentaje" id="ausentismo-mes">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h4>Últimos 3 Meses</h4>
                                    <div class="porcentaje" id="ausentismo-3meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <h4>Últimos 6 Meses</h4>
                                    <div class="porcentaje" id="ausentismo-6meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <h4>Últimos 12 Meses</h4>
                                    <div class="porcentaje" id="ausentismo-12meses">0%</div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    Ausencias por Día
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-mes-grafico" class="form-select" style="width: auto;"></select>
                                        <select id="filtro-ano-grafico" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-grafico" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="graficoAusencias"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    Distribución de Ausencias por Motivo
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoAusenciasMotivoActual"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoAusenciasMotivoHistorico"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4" id="contenedorGraficoFiltradoAusencias" style="display: none;">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoAusenciasMotivoFiltrado"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                                    
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Historial de Ausencias</span>
                                </div>
                                <div class="card-body">
                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control" id="buscador-ausencias" placeholder="Buscar por nombre, identidad, motivo...">
                                    </div>
                                    
                                    <div class="table-responsive mt-3">
                                        <table class="table table-striped table-hover" id="tabla-ausencias">
                                            <thead>
                                                <tr>
                                                    <th>Fecha Inicio</th>
                                                    <th>Fecha Fin</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Motivo</th>
                                                    <th>Días</th>
                                                    <th>Observaciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="disciplina" role="tabpanel" aria-labelledby="disciplina-tab">
                            <div class="tab-title">
                                <h2>Historial de Disciplina</h2>
                            </div>
                            
                            <div class="rotacion-periodos">
                                <div class="periodo-card">
                                    <h4>% Histórico</h4>
                                    <div class="porcentaje" id="disciplina-historico">0%</div>
                                </div>
                                <div class="periodo-card">
                                    <h4>% del Mes</h4>
                                    <div class="porcentaje" id="disciplina-mes">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h4>% Últimos 3 Meses</h4>
                                    <div class="porcentaje" id="disciplina-3meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <h4>% Últimos 6 Meses</h4>
                                    <div class="porcentaje" id="disciplina-6meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <h4>% Últimos 12 Meses</h4>
                                    <div class="porcentaje" id="disciplina-12meses">0%</div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">Acciones Disciplinarias por Día</div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-mes-disciplina" class="form-select" style="width: auto;"></select>
                                        <select id="filtro-ano-disciplina" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-disciplina-grafico" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="graficoDisciplinaPorDia"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">Distribución de Faltas por Motivo</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoDisciplinaMotivoActual"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoDisciplinaMotivoHistorico"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4" id="contenedorGraficoFiltradoDisciplina" style="display: none;">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoDisciplinaMotivoFiltrado"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Historial de Acciones Disciplinarias</span>
                                    <button class="btn btn-primary btn-sm" id="btn-resumen-disciplina">
                                        <i class="fas fa-users-cog me-2"></i>Ver Resumen por Colaborador
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control" id="buscador-disciplina" placeholder="Buscar por nombre o identidad...">
                                    </div>
                                    <div class="table-responsive mt-3">
                                        <table class="table table-striped table-hover" id="tabla-disciplina">
                                            <thead>
                                                <tr>
                                                    <th>Fecha de la Falta</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Faltas Cometidas</th>
                                                    <th>Observaciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="tab-pane fade" id="cumpleaneros" role="tabpanel" aria-labelledby="cumpleaneros-tab">
                            <div class="tab-title">
                                <h2>Cumpleañeros del Mes</h2>
                            </div>
                            <div id="contenedor-cumpleaneros" class="row">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Por favor espera un momento...</h4>
            <p></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        let colaboradoresActivos = [];
        let colaboradoresIngresos = [];
        let colaboradoresEgresos = [];
        let ausencias = [];
        let disciplina = [];
        let nombresActivos = [];
        let graficoAusencias = null;
        let graficoAusenciasMotivoActual = null;
        let graficoAusenciasMotivoHistorico = null;
        let graficoAusenciasMotivoFiltrado = null;
        let graficoEgresosMotivoActual = null;
        let graficoEgresosMotivoHistorico = null;
        let graficoEgresosMotivoFiltrado = null;
        
        let graficoDisciplinaPorDia = null;
        let graficoDisciplinaMotivoActual = null;
        let graficoDisciplinaMotivoHistorico = null;
        let graficoDisciplinaMotivoFiltrado = null;

        // URLs de los scripts de Google Apps Script
        const SCRIPT_URL_OBTENER = "https://script.google.com/macros/s/AKfycbwV6UwcNpiC5FAahk3YPuOS-JSm7Fta5bNW_UoOwvqywTiS-a8LSqAMT32PKM1ydQJs/exec";
        const SCRIPT_URL_ENVIAR = "https://script.google.com/macros/s/AKfycbwP81lGExHp4d9tPRhNNgJ5rlcgXIXj2AsNDNTFcd8Gzdhujy_2UEO0x016YrccFMxU/exec";

        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
        });

        function checkSession() {
            const sessionKey = 'passwordSessionTimestamp';
            const sessionStart = localStorage.getItem(sessionKey);

            if (sessionStart) {
                const twentyFourHours = 24 * 60 * 60 * 1000;
                const timeElapsed = new Date().getTime() - parseInt(sessionStart, 10);

                if (timeElapsed < twentyFourHours) {
                    document.getElementById('main-content').style.display = 'block';
                    initializeApp();
                    return;
                }
            }
            promptForPassword();
        }

        function promptForPassword() {
            Swal.fire({
                title: 'Acceso Restringido',
                html: 'Por favor, ingrese la contraseña para continuar.',
                input: 'password',
                inputPlaceholder: 'Contraseña',
                confirmButtonText: 'Ingresar',
                allowOutsideClick: false,
                allowEscapeKey: false,
                backdrop: `rgba(43, 62, 80, 0.8)`,
                preConfirm: (password) => {
                    if (password !== 'macdel1') {
                        Swal.showValidationMessage('Contraseña incorrecta');
                        return false;
                    }
                    return password;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.setItem('passwordSessionTimestamp', new Date().getTime().toString());
                    document.getElementById('main-content').style.display = 'block';
                    initializeApp();
                }
            });
        }
        
        function initializeApp() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;
            
            document.querySelector(".fecha-inicio").value = todayStr;
            document.querySelector(".fecha-ausencia").value = todayStr;
            
            cargarTodosLosDatos();
            configurarEventos();
        }

        function cargarTodosLosDatos() {
            $('#overlay').css('display', 'flex'); 
            
            $.get(SCRIPT_URL_OBTENER, function(data) {
                $('#overlay').hide();
                if (data.error) {
                    Swal.fire('Error', 'No se pudieron cargar los datos: ' + data.mensaje, 'error');
                    return;
                }
                
                colaboradoresActivos = (data.activos || []).map(corregirFecha);
                colaboradoresIngresos = (data.ingresos || []).map(corregirFecha);
                colaboradoresEgresos = (data.egresos || []).map(corregirFecha);
                ausencias = (data.ausencias || []).map(corregirFecha);
                disciplina = (data.disciplina || []).map(corregirFecha);
                
                nombresActivos = colaboradoresActivos.map(col => col.nombre);
                
                actualizarDashboard();
                mostrarColaboradoresActivos();
                calcularRotacionGeneral();
                calcularRotacionPeriodos();
                mostrarEgresos(colaboradoresEgresos);
                
                const hoy = new Date();
                
                // Pestaña Ausencias
                mostrarAusencias();
                calcularEstadisticasAusencias();
                popularFiltrosGrafico('#filtro-mes-grafico', '#filtro-ano-grafico', ausencias, 'fecha');
                crearGraficoAusencias(hoy.getFullYear(), hoy.getMonth());
                crearGraficoAusenciasMotivoActual();
                crearGraficoAusenciasMotivoHistorico();

                // Pestaña Disciplina
                mostrarHistorialDisciplina();
                calcularEstadisticasDisciplina();
                popularFiltrosGrafico('#filtro-mes-disciplina', '#filtro-ano-disciplina', disciplina, 'fechaFalta');
                crearGraficoDisciplinaPorDia(hoy.getFullYear(), hoy.getMonth());
                crearGraficoDisciplinaMotivoActual();
                crearGraficoDisciplinaMotivoHistorico();
                
                // Otros
                popularFiltrosGrafico('#filtro-mes-egresos', '#filtro-ano-egresos', colaboradoresEgresos, 'fechaEgreso');
                crearGraficoEgresosMotivoActual();
                crearGraficoEgresosMotivoHistorico();
                mostrarCumpleanerosDelMes();
                
            }).fail(function(jqXHR, textStatus, errorThrown) {
                $('#overlay').hide();
                Swal.fire('Error', 'No se pudo conectar al servidor o hubo un error de red. ' + textStatus + ': ' + errorThrown, 'error');
            });
        }

        function corregirFecha(item) {
            const propiedadesFecha = ['fechaInicio', 'fechaNacimiento', 'fechaEgreso', 'fecha', 'fechaFin', 'fechaFalta', 'fechaLlamadoAtencion'];
            propiedadesFecha.forEach(prop => {
                if (item[prop] && typeof item[prop] === 'string' && item[prop].includes('T')) {
                    const fecha = new Date(item[prop]);
                    item[prop] = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`;
                }
            });
            return item;
        }
        
        function configurarEventos() {
            $('#btn-registrar-colaborador').on('click', registrarColaborador);
            $('#btn-agregar-colaborador').on('click', agregarFormularioColaborador);
            $(document).on('click', '.btn-quitar-item-colaborador', function() { $(this).closest('.formulario-item').remove(); });
            $(document).on('input', '.identidad', function() { formatearIdentidad(this); });
            $('#btn-registrar-ausencia').on('click', registrarAusencia);
            $('#btn-agregar-ausencia').on('click', agregarFormularioAusencia);
            $(document).on('click', '.btn-quitar-item-ausencia', function() { $(this).closest('.formulario-item').remove(); });

            $('#buscador-activos').on('input', filtrarActivos);
            $('#buscador-egresos').on('input', filtrarEgresos);
            $('#buscador-ausencias').on('input', filtrarAusencias);
            $('#buscador-disciplina').on('input', filtrarDisciplina); 
            
            $('#btn-calcular-rotacion-personalizado').on('click', calcularRotacionPersonalizado);
            $('#btn-resumen-disciplina').on('click', mostrarResumenDisciplina);

            $('#btn-filtrar-grafico').on('click', function() {
                const ano = parseInt($('#filtro-ano-grafico').val());
                const mes = parseInt($('#filtro-mes-grafico').val());
                crearGraficoAusencias(ano, mes);
                $('#contenedorGraficoFiltradoAusencias').toggle(ano !== new Date().getFullYear() || mes !== new Date().getMonth());
                if ($('#contenedorGraficoFiltradoAusencias').is(':visible')) {
                    crearGraficoAusenciasMotivoFiltrado(ano, mes);
                }
            });

            $('#btn-filtrar-disciplina-grafico').on('click', function() {
                const ano = parseInt($('#filtro-ano-disciplina').val());
                const mes = parseInt($('#filtro-mes-disciplina').val());
                crearGraficoDisciplinaPorDia(ano, mes);
                $('#contenedorGraficoFiltradoDisciplina').toggle(ano !== new Date().getFullYear() || mes !== new Date().getMonth());
                if ($('#contenedorGraficoFiltradoDisciplina').is(':visible')) {
                    crearGraficoDisciplinaMotivoFiltrado(ano, mes);
                }
            });

            $('#btn-filtrar-egresos').on('click', function() {
                const ano = parseInt($('#filtro-ano-egresos').val());
                const mes = parseInt($('#filtro-mes-egresos').val());
                $('#contenedorGraficoFiltradoEgresos').toggle(ano !== new Date().getFullYear() || mes !== new Date().getMonth());
                 if ($('#contenedorGraficoFiltradoEgresos').is(':visible')) {
                    crearGraficoEgresosMotivoFiltrado(ano, mes);
                }
            });
            
            $(document).on('input', '.colaborador-ausencia', function() {
                const input = $(this), valor = input.val().toLowerCase(), autocompleteList = input.next('.autocomplete-list');
                if (valor.length < 2) { autocompleteList.hide(); return; }
                const sugerencias = nombresActivos.filter(nombre => nombre.toLowerCase().includes(valor));
                autocompleteList.empty().toggle(sugerencias.length > 0);
                sugerencias.forEach(sug => autocompleteList.append(`<div class="autocomplete-item">${sug}</div>`));
            });

            $(document).on('click', '.autocomplete-item', function() {
                const item = $(this);
                item.closest('.autocomplete-container').find('.colaborador-ausencia').val(item.text());
                item.closest('.autocomplete-list').hide();
            });

            $(document).on('click', (e) => { if (!$(e.target).closest('.autocomplete-container').length) $('.autocomplete-list').hide(); });
        }
        
        function agregarFormularioColaborador() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;
            
            const nuevoFormulario = `
                <div class="formulario-item">
                    <button type="button" class="btn btn-danger btn-quitar-item btn-quitar-item-colaborador" title="Quitar registro"><i class="fas fa-times"></i></button>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha de Inicio</label>
                            <input type="date" class="form-control fecha-inicio" value="${todayStr}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control nombre-completo" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Identidad</label>
                            <input type="text" class="form-control identidad" placeholder="0000-0000-00000" pattern="\\d{4}-\\d{4}-\\d{5}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fecha de Nacimiento (Opcional)</label>
                            <input type="date" class="form-control fecha-nacimiento">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sexo</label>
                            <select class="form-select sexo" required>
                                <option value="">Seleccionar...</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Femenino">Femenino</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="row align-items-center">
                                <div class="col-md-7">
                                    <label class="form-label">Foto (opcional)</label>
                                    <input type="file" class="form-control foto-colaborador" accept="image/*" onchange="mostrarVistaPreviaFoto(this)">
                                    <div class="form-text">JPG, PNG. Máx 5MB</div>
                                </div>
                                <div class="col-md-5">
                                    <div class="vista-previa-container mt-2 mt-md-0 text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            $('#contenedor-formularios-colaborador').append(nuevoFormulario);
        }

        function registrarColaborador() {
            let colaboradoresParaRegistrar = [];
            let esValido = true;
            const identidadRegex = /^\d{4}-\d{4}-\d{5}$/;
            let identidadesEnLote = new Set();

            $('#contenedor-formularios-colaborador .formulario-item').each(function(index) {
                const item = $(this);
                const fechaInicio = item.find('.fecha-inicio').val();
                const nombre = item.find('.nombre-completo').val();
                const identidad = item.find('.identidad').val();
                const fechaNacimiento = item.find('.fecha-nacimiento').val() || ''; 
                const sexo = item.find('.sexo').val();
                const fotoInput = item.find('.foto-colaborador')[0];

                if (!fechaInicio || !nombre || !identidad || !sexo) {
                    Swal.fire('Error', `Por favor complete todos los campos obligatorios para el colaborador #${index + 1}.`, 'error');
                    esValido = false;
                    return false;
                }
                if (!identidadRegex.test(identidad)) {
                    Swal.fire('Error', `El formato de identidad para el colaborador #${index + 1} es incorrecto.`, 'error');
                    esValido = false;
                    return false;
                }
                if (colaboradoresActivos.some(col => col.identidad === identidad) || identidadesEnLote.has(identidad)) {
                    Swal.fire('Error', `La identidad '${identidad}' del colaborador #${index + 1} ya está registrada o duplicada en este lote.`, 'error');
                    esValido = false;
                    return false;
                }
                identidadesEnLote.add(identidad);
                colaboradoresParaRegistrar.push({ fechaInicio, nombre, identidad, fechaNacimiento, sexo, fotoInput });
            });

            if (!esValido || colaboradoresParaRegistrar.length === 0) return;

            Swal.fire({
                title: '¿Está seguro?',
                html: `Se registrarán <strong>${colaboradoresParaRegistrar.length}</strong> nuevos colaboradores.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, registrar',
                cancelButtonText: 'No, cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#overlay').css('display', 'flex');
                    const colaboradoresSinFoto = colaboradoresParaRegistrar.map(({ fotoInput, ...resto }) => resto);

                    $.post(SCRIPT_URL_ENVIAR, {
                        accion: 'registrar_colaboradores_masivo',
                        datos: JSON.stringify(colaboradoresSinFoto)
                    }, function(response) {
                        if (response === 'Éxito') {
                            const promesasFotos = colaboradoresParaRegistrar
                                .filter(col => col.fotoInput.files[0])
                                .map(col => subirFoto(col, col.fotoInput.files[0], false));

                            Promise.all(promesasFotos)
                                .then(() => {
                                    $('#overlay').hide();
                                    Swal.fire('Éxito', 'Colaboradores registrados correctamente.', 'success').then(() => {
                                        $('#contenedor-formularios-colaborador').empty();
                                        agregarFormularioColaborador();
                                        cargarTodosLosDatos();
                                    });
                                })
                                .catch(error => {
                                    $('#overlay').hide();
                                    Swal.fire('Advertencia', `Colaboradores registrados, pero hubo un error al subir algunas fotos: ${error}`, 'warning').then(() => {
                                        cargarTodosLosDatos();
                                    });
                                });
                        } else {
                            $('#overlay').hide();
                            Swal.fire('Error', 'Hubo un problema al registrar: ' + response, 'error');
                        }
                    }).fail(() => {
                        $('#overlay').hide();
                        Swal.fire('Error', 'Error de conexión al registrar.', 'error');
                    });
                }
            });
        }
        
        function agregarFormularioAusencia() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;

            const nuevoFormulario = `
                <div class="formulario-item">
                    <button type="button" class="btn btn-danger btn-quitar-item btn-quitar-item-ausencia" title="Quitar registro"><i class="fas fa-times"></i></button>
                    <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label">Fecha de Ausencia</label><input type="date" class="form-control fecha-ausencia" value="${todayStr}" required></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Días de Ausencia</label><input type="number" class="form-control dias-incapacidad" value="1" min="1" required></div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Colaborador</label>
                            <div class="autocomplete-container">
                                <input type="text" class="form-control colaborador-ausencia" placeholder="Escriba el nombre..." required>
                                <div class="autocomplete-list"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Motivo</label>
                            <select class="form-select motivo-ausencia" required>
                                <option value="">Seleccionar...</option><option value="Incapacidad">Incapacidad</option><option value="Permiso">Permiso</option><option value="Falta Injustificada">Falta Injustificada</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3"><label class="form-label">Observaciones</label><textarea class="form-control observaciones-ausencia" rows="1"></textarea></div>
                    </div>
                </div>`;
            $('#contenedor-formularios-ausencia').append(nuevoFormulario);
        }

        function registrarAusencia() {
            let ausenciasParaRegistrar = [], esValido = true;
            $('#contenedor-formularios-ausencia .formulario-item').each(function(index) {
                const item = $(this), fecha = item.find('.fecha-ausencia').val(), diasIncapacidad = parseInt(item.find('.dias-incapacidad').val()), colaborador = item.find('.colaborador-ausencia').val(), motivo = item.find('.motivo-ausencia').val(), observaciones = item.find('.observaciones-ausencia').val();
                if (!fecha || !diasIncapacidad || !colaborador || !motivo) { Swal.fire('Error', `Complete campos obligatorios para ausencia #${index + 1}.`, 'error'); esValido = false; return false; }
                if (!colaboradoresActivos.some(col => col.nombre.toLowerCase() === colaborador.toLowerCase())) { Swal.fire('Error', `Colaborador '${colaborador}' (ausencia #${index + 1}) no es activo.`, 'error'); esValido = false; return false; }
                const fechaInicio = new Date(fecha), fechaFin = new Date(fechaInicio);
                fechaFin.setDate(fechaFin.getDate() + diasIncapacidad - 1);
                ausenciasParaRegistrar.push({ fecha, fechaFin: fechaFin.toISOString().split('T')[0], diasIncapacidad, colaborador, motivo, observaciones });
            });
            if (!esValido || ausenciasParaRegistrar.length === 0) return;
            Swal.fire({ title: '¿Está seguro?', html: `Se registrarán <strong>${ausenciasParaRegistrar.length}</strong> ausencias.`, icon: 'question', showCancelButton: true, confirmButtonText: 'Sí, registrar', cancelButtonText: 'No, cancelar' }).then((result) => {
                if (result.isConfirmed) {
                    $('#overlay').css('display', 'flex');
                    $.post(SCRIPT_URL_ENVIAR, { accion: 'registrar_ausencias_masivo', datos: JSON.stringify(ausenciasParaRegistrar) }, (response) => {
                        $('#overlay').hide();
                        if (response === 'Éxito') Swal.fire('Éxito', 'Ausencias registradas.', 'success').then(() => { $('#contenedor-formularios-ausencia').empty(); agregarFormularioAusencia(); cargarTodosLosDatos(); });
                        else Swal.fire('Error', `Error al registrar ausencias: ${response}`, 'error');
                    }).fail(() => { $('#overlay').hide(); Swal.fire('Error', 'Error de conexión.', 'error'); });
                }
            });
        }
        
        function actualizarDashboard() {
            $('#total-activos').text(colaboradoresActivos.length);
            const hombres = colaboradoresActivos.filter(c => c.sexo === 'Masculino').length;
            $('#total-hombres').text(hombres);
            $('#total-mujeres').text(colaboradoresActivos.length - hombres);
            let sumaEdades = 0, colaboradoresConEdad = 0;
            colaboradoresActivos.forEach(col => {
                if (col.fechaNacimiento) {
                    const hoy = new Date(), fechaNac = new Date(col.fechaNacimiento);
                    let edad = hoy.getFullYear() - fechaNac.getFullYear();
                    const m = hoy.getMonth() - fechaNac.getMonth();
                    if (m < 0 || (m === 0 && hoy.getDate() < fechaNac.getDate())) edad--;
                    sumaEdades += edad;
                    colaboradoresConEdad++;
                }
            });
            $('#edad-promedio').text(colaboradoresConEdad > 0 ? Math.round(sumaEdades / colaboradoresConEdad) : 0);
            const hoyStr = new Date().toISOString().split('T')[0];
            const ausenciasHoy = ausencias.filter(a => hoyStr >= a.fecha && hoyStr <= (a.fechaFin || a.fecha)).length;
            $('#ausencias-hoy').text(ausenciasHoy);
            $('#presentes-hoy').text(colaboradoresActivos.length - ausenciasHoy);
            const inicioMes = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const egresosMes = colaboradoresEgresos.filter(e => new Date(e.fechaEgreso) >= inicioMes);
            $('#rotacion-mes-dashboard').text(calcularPorcentajeRotacion(egresosMes).porcentaje + '%');
            const ultimosIngresos = [...colaboradoresIngresos].sort((a, b) => new Date(b.fechaInicio) - new Date(a.fechaInicio)).slice(0, 5);
            const tablaUltimosIngresos = $('#tabla-ultimos-ingresos tbody').empty();
            ultimosIngresos.forEach(ing => tablaUltimosIngresos.append(`<tr><td>${formatearFecha(ing.fechaInicio)}</td><td>${ing.nombre}</td><td>${ing.identidad}</td><td>${formatearFecha(ing.fechaNacimiento)}</td><td>${ing.sexo}</td></tr>`));
            const ultimosEgresos = [...colaboradoresEgresos].sort((a, b) => new Date(b.fechaEgreso) - new Date(a.fechaEgreso)).slice(0, 5);
            const tablaUltimosEgresos = $('#tabla-ultimos-egresos tbody').empty();
            ultimosEgresos.forEach(eg => tablaUltimosEgresos.append(`<tr><td>${formatearFecha(eg.fechaEgreso)}</td><td>${eg.nombre}</td><td>${eg.identidad}</td><td>${eg.razon}</td></tr>`));
        }

        function mostrarColaboradoresActivos() {
            const tablaActivos = $('#tabla-activos tbody').empty();
            colaboradoresActivos.forEach((col, index) => {
                tablaActivos.append(`
                    <tr>
                        <td>${formatearFecha(col.fechaInicio)}</td><td>${col.nombre}</td><td>${col.identidad}</td><td>${formatearFecha(col.fechaNacimiento)}</td><td>${col.sexo}</td>
                        <td>
                            <button class="btn btn-info btn-sm btn-action btn-photo" data-index="${index}" title="Ver Foto"><i class="fas fa-camera"></i></button>
                            <button class="btn btn-warning btn-sm btn-action btn-edit" data-index="${index}" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger btn-sm btn-action btn-delete" data-index="${index}" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`);
            });
            $('.btn-photo').on('click', function() { mostrarFoto(colaboradoresActivos[$(this).data('index')]); });
            $('.btn-edit').on('click', function() { editarColaborador($(this).data('index')); });
            $('.btn-delete').on('click', function() { eliminarColaborador($(this).data('index')); });
        }

        function filtrarActivos() {
            const texto = $('#buscador-activos').val().toLowerCase();
            $('#tabla-activos tbody tr').each(function() {
                const nombre = $(this).find('td:eq(1)').text().toLowerCase(), identidad = $(this).find('td:eq(2)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto) || identidad.includes(texto));
            });
        }

        function editarColaborador(index) {
            const colaborador = colaboradoresActivos[index];
            Swal.fire({
                title: 'Editar Colaborador',
                html: `<form id="form-editar-colaborador">
                        <div class="mb-3 text-start"><label class="form-label">Fecha de Inicio</label><input type="date" class="form-control" id="editar-fecha-inicio" value="${colaborador.fechaInicio}" required></div>
                        <div class="mb-3 text-start"><label class="form-label">Nombre</label><input type="text" class="form-control" id="editar-nombre" value="${colaborador.nombre}" required></div>
                        <div class="mb-3 text-start"><label class="form-label">Identidad</label><input type="text" class="form-control" id="editar-identidad" value="${colaborador.identidad}" pattern="\\d{4}-\\d{4}-\\d{5}" required></div>
                        <div class="mb-3 text-start"><label class="form-label">Nacimiento</label><input type="date" class="form-control" id="editar-fecha-nacimiento" value="${colaborador.fechaNacimiento || ''}"></div>
                        <div class="mb-3 text-start"><label class="form-label">Sexo</label><select class="form-select" id="editar-sexo" required><option value="Masculino" ${colaborador.sexo === 'Masculino' ? 'selected' : ''}>Masculino</option><option value="Femenino" ${colaborador.sexo === 'Femenino' ? 'selected' : ''}>Femenino</option></select></div>
                        <div class="mb-3 text-start"><label class="form-label">Foto</label><input type="file" class="form-control" id="editar-foto" accept="image/*" onchange="mostrarVistaPreviaEdicion(this)">${colaborador.fotoUrl ? `<div class="mt-2"><img src="${colaborador.fotoUrl}" style="max-width: 100px; border-radius: 5px;" onerror="this.style.display='none'"></div>` : ''}</div>
                    </form>`,
                showCancelButton: true, confirmButtonText: 'Guardar', cancelButtonText: 'Cancelar', width: '600px',
                preConfirm: () => {
                    const datos = { fechaInicio: $('#editar-fecha-inicio').val(), nombre: $('#editar-nombre').val(), identidad: $('#editar-identidad').val(), fechaNacimiento: $('#editar-fecha-nacimiento').val() || '', sexo: $('#editar-sexo').val(), foto: $('#editar-foto')[0].files[0] };
                    if (!datos.fechaInicio || !datos.nombre || !datos.identidad || !datos.sexo) { Swal.showValidationMessage('Complete campos obligatorios'); return false; }
                    if (!/^\d{4}-\d{4}-\d{5}$/.test(datos.identidad)) { Swal.showValidationMessage('Formato de identidad incorrecto'); return false; }
                    return datos;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#overlay').css('display', 'flex');
                    const { foto, ...datosNuevos } = result.value;
                    $.post(SCRIPT_URL_ENVIAR, { accion: 'editar_colaborador', colaboradorOriginal: JSON.stringify(colaborador), datosNuevos: JSON.stringify(datosNuevos) }, (response) => {
                        if (response === 'Éxito') {
                            if (foto) {
                                subirFoto(datosNuevos, foto, true).then(() => { $('#overlay').hide(); Swal.fire('Éxito', 'Colaborador actualizado.', 'success').then(cargarTodosLosDatos); }).catch(error => { $('#overlay').hide(); Swal.fire('Advertencia', 'Datos actualizados, pero error al subir foto: ' + error, 'warning').then(cargarTodosLosDatos); });
                            } else { $('#overlay').hide(); Swal.fire('Éxito', 'Colaborador actualizado.', 'success').then(cargarTodosLosDatos); }
                        } else { $('#overlay').hide(); Swal.fire('Error', 'Error al actualizar: ' + response, 'error'); }
                    }).fail(() => { $('#overlay').hide(); Swal.fire('Error', 'Error de conexión.', 'error'); });
                }
            });
        }
        
        function eliminarColaborador(index) {
            const colaborador = colaboradoresActivos[index];
            Swal.fire({ title: '¿Está seguro?', text: `¿Desea eliminar a ${colaborador.nombre}?`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Sí, eliminar', cancelButtonText: 'No, cancelar' }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Fecha y Razón de Egreso',
                        html: `<input type="date" class="form-control mb-3" id="fecha-egreso" value="${new Date().toISOString().split('T')[0]}" required>
                            <select id="razon-egreso" class="form-select"><option value="" selected disabled>Seleccione motivo...</option><option>Denegación de Período de Prueba</option><option>Abandono</option><option>Renuncia</option><option>Despido</option></select>`,
                        showCancelButton: true, confirmButtonText: 'Confirmar Egreso',
                        preConfirm: () => {
                            const fechaEgreso = $('#fecha-egreso').val(), razon = $('#razon-egreso').val();
                            if (!fechaEgreso || !razon) { Swal.showValidationMessage('Complete todos los campos'); return false; }
                            return { fechaEgreso, razon };
                        }
                    }).then((egresoResult) => {
                        if (egresoResult.isConfirmed) {
                            $('#overlay').css('display', 'flex');
                            $.post(SCRIPT_URL_ENVIAR, { accion: 'eliminar_colaborador', colaborador: JSON.stringify(colaborador), ...egresoResult.value }, (response) => {
                                $('#overlay').hide();
                                if (response === 'Éxito') Swal.fire('Éxito', 'Colaborador eliminado.', 'success').then(cargarTodosLosDatos);
                                else Swal.fire('Error', `Error al eliminar: ${response}`, 'error');
                            }).fail(() => { $('#overlay').hide(); Swal.fire('Error', 'Error de conexión.', 'error'); });
                        }
                    });
                }
            });
        }

        function calcularRotacionGeneral() {
            const { porcentaje, egresos } = calcularPorcentajeRotacion(colaboradoresEgresos);
            $('#rotacion-general').text(porcentaje + '%');
            $('#detalle-general').text(egresos + ' egresos');
        }

        function calcularRotacionPeriodos() {
            const hoy = new Date();
            [{ id: 'mes', meses: 0 }, { id: '3meses', meses: 3 }, { id: '6meses', meses: 6 }, { id: '12meses', meses: 12 }].forEach(p => {
                const fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth() - p.meses, 1);
                const egresosPeriodo = colaboradoresEgresos.filter(e => new Date(e.fechaEgreso) >= fechaInicio);
                const { porcentaje, egresos } = calcularPorcentajeRotacion(egresosPeriodo);
                $(`#rotacion-${p.id}`).text(porcentaje + '%');
                $(`#detalle-${p.id}`).text(egresos + ' egresos');
            });
        }

        function calcularPorcentajeRotacion(egresosPeriodo) {
            const totalActivos = colaboradoresActivos.length, totalEgresos = egresosPeriodo.length;
            const porcentaje = (totalActivos + totalEgresos > 0) ? (totalEgresos / (totalActivos + totalEgresos)) * 100 : 0;
            return { porcentaje: porcentaje.toFixed(2), egresos: totalEgresos };
        }

        function calcularRotacionPersonalizado() {
            const inicio = $('#fecha-inicio-personalizado').val(), fin = $('#fecha-fin-personalizado').val();
            let egresosPeriodo = colaboradoresEgresos;
            if (inicio && fin) egresosPeriodo = egresosPeriodo.filter(e => e.fechaEgreso >= inicio && e.fechaEgreso <= fin);
            else if (inicio) egresosPeriodo = egresosPeriodo.filter(e => e.fechaEgreso >= inicio);
            else if (fin) egresosPeriodo = egresosPeriodo.filter(e => e.fechaEgreso <= fin);
            mostrarEgresos(egresosPeriodo);
        }

        function mostrarEgresos(egresos) {
            const tablaEgresos = $('#tabla-egresos tbody').empty();
            if (egresos.length === 0) { tablaEgresos.append('<tr><td colspan="5" class="text-center">No hay egresos que mostrar.</td></tr>'); return; }
            [...egresos].sort((a, b) => new Date(b.fechaEgreso) - new Date(a.fechaEgreso)).forEach(e => {
                tablaEgresos.append(`<tr data-identidad="${e.identidad}" data-fechaegreso="${e.fechaEgreso}"><td>${formatearFecha(e.fechaEgreso)}</td><td>${e.nombre}</td><td>${e.identidad}</td><td>${e.razon}</td><td>${e.fotoUrl ? `<button class="btn btn-info btn-sm btn-action btn-photo-egreso" title="Ver Foto"><i class="fas fa-camera"></i></button>` : ''}</td></tr>`);
            });
            $('.btn-photo-egreso').off('click').on('click', function() {
                const row = $(this).closest('tr'), id = row.data('identidad'), fecha = row.data('fechaegreso');
                const egresoData = colaboradoresEgresos.find(e => e.identidad === id && e.fechaEgreso === fecha);
                if(egresoData) mostrarFoto(egresoData);
            });
        }

        function filtrarEgresos() {
            const texto = $('#buscador-egresos').val().toLowerCase();
            $('#tabla-egresos tbody tr').each(function() {
                const nombre = $(this).find('td:eq(1)').text().toLowerCase(), id = $(this).find('td:eq(2)').text().toLowerCase(), motivo = $(this).find('td:eq(3)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto) || id.includes(texto) || motivo.includes(texto));
            });
        }

        function mostrarAusencias() {
            const tablaAusencias = $('#tabla-ausencias tbody').empty();
            if (ausencias.length === 0) { tablaAusencias.append('<tr><td colspan="7" class="text-center">No hay ausencias</td></tr>'); return; }
            [...ausencias].reverse().forEach(a => {
                tablaAusencias.append(`<tr><td>${formatearFecha(a.fecha)}</td><td>${formatearFecha(a.fechaFin || a.fecha)}</td><td>${a.nombre}</td><td>${a.identidad}</td><td>${a.motivo}</td><td>${calcularDiasAusencia(a.fecha, a.fechaFin || a.fecha)}</td><td>${a.observaciones || ''}</td></tr>`);
            });
        }

        function calcularDiasAusencia(inicio, fin) { return Math.round((new Date(fin) - new Date(inicio)) / 864e5) + 1; }

        function filtrarAusencias() {
            const texto = $('#buscador-ausencias').val().toLowerCase();
            $('#tabla-ausencias tbody tr').each(function() {
                const nombre = $(this).find('td:eq(2)').text().toLowerCase(), id = $(this).find('td:eq(3)').text().toLowerCase(), motivo = $(this).find('td:eq(4)').text().toLowerCase(), obs = $(this).find('td:eq(6)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto) || id.includes(texto) || motivo.includes(texto) || obs.includes(texto));
            });
        }

        // --- INICIO FUNCIONES PARA DISCIPLINA ---

        function mostrarHistorialDisciplina() {
            const tablaDisciplina = $('#tabla-disciplina tbody').empty();
            if (disciplina.length === 0) {
                tablaDisciplina.append('<tr><td colspan="5" class="text-center">No hay registros de disciplina.</td></tr>');
                return;
            }
            const disciplinaOrdenada = [...disciplina].sort((a, b) => new Date(b.fechaFalta) - new Date(a.fechaFalta));

            disciplinaOrdenada.forEach((registro) => {
                const faltasLista = registro.descripcionFaltas.split('; ').map(falta => `<li>${falta}</li>`).join('');
                tablaDisciplina.append(`
                    <tr>
                        <td>${formatearFecha(registro.fechaFalta)}</td>
                        <td>${registro.nombre}</td>
                        <td>${registro.identidad}</td>
                        <td><ul>${faltasLista}</ul></td>
                        <td>${registro.observaciones}</td>
                    </tr>`);
            });
        }
        
        function mostrarResumenDisciplina() {
            if (disciplina.length === 0) {
                Swal.fire('Sin Datos', 'No hay acciones disciplinarias registradas para mostrar un resumen.', 'info');
                return;
            }

            const conteo = {};
            disciplina.forEach(reg => {
                if (!conteo[reg.identidad]) {
                    const colaboradorInfo = colaboradoresIngresos.find(c => c.identidad === reg.identidad) || { nombre: reg.nombre, identidad: reg.identidad, fotoUrl: '' };
                    conteo[reg.identidad] = {
                        nombre: colaboradorInfo.nombre,
                        identidad: colaboradorInfo.identidad,
                        fotoUrl: colaboradorInfo.fotoUrl,
                        count: 0
                    };
                }
                conteo[reg.identidad].count++;
            });

            const sorted = Object.values(conteo).sort((a, b) => b.count - a.count);
            
            const modalHtml = `
                <div class="mb-3 px-2">
                    <input type="text" id="filtro-resumen-disciplina" class="form-control" placeholder="Buscar por nombre o identidad...">
                </div>
                <div id="resumen-lista-colaboradores" style="max-height: 400px; overflow-y: auto; text-align: left;">
                </div>`;

            function renderResumenList(items) {
                const container = $('#resumen-lista-colaboradores');
                container.empty();
                if (items.length === 0) {
                    container.html('<p class="text-center text-muted mt-3">No se encontraron colaboradores.</p>');
                    return;
                }
                let listHtml = '';
                items.forEach(item => {
                    let color;
                    if (item.count === 1) color = "info";
                    else if (item.count === 2) color = "warning";
                    else if (item.count === 3) color = "danger";
                    else color = "dark";
                    
                    const fotoSrc = item.fotoUrl || `https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random`;
                    listHtml += `
                        <div class="resumen-disciplina-item" data-identidad="${item.identidad}" style="cursor: pointer;">
                            <img src="${fotoSrc}" class="resumen-disciplina-img" onerror="this.src='https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random'">
                            <div class="resumen-disciplina-info">
                                <h6>${item.nombre}</h6>
                                <span class="badge bg-${color}">${item.count} Acción(es)</span>
                            </div>
                        </div>`;
                });
                container.html(listHtml);
            }

            Swal.fire({
                title: 'Resumen por Colaborador',
                html: modalHtml,
                width: '700px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    renderResumenList(sorted);
                    $('#filtro-resumen-disciplina').on('input', function() {
                        const query = $(this).val().toLowerCase();
                        const filtered = sorted.filter(item =>
                            item.nombre.toLowerCase().includes(query) || item.identidad.toLowerCase().includes(query)
                        );
                        renderResumenList(filtered);
                    });

                    $(document).on('click', '.resumen-disciplina-item', function() {
                        const identidad = $(this).data('identidad');
                        mostrarDetalleDisciplinaColaborador(identidad);
                    });
                },
                willClose: () => {
                    $(document).off('click', '.resumen-disciplina-item');
                }
            });
        }

        function mostrarDetalleDisciplinaColaborador(identidad) {
            const historial = disciplina.filter(d => d.identidad === identidad).sort((a,b) => new Date(b.fechaFalta) - new Date(a.fechaFalta));
            const colaborador = colaboradoresIngresos.find(c => c.identidad === identidad) || { nombre: 'N/A', identidad: identidad, fotoUrl: '' };

            let historialHtml = '<div style="max-height: 300px; overflow-y: auto; text-align: left; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">';
            if (historial.length > 0) {
                historial.forEach((reg, index) => {
                    historialHtml += `
                        <div class="mb-2">
                            <strong>${formatearFecha(reg.fechaFalta)}:</strong>
                            <ul class="mb-1 mt-1">
                                ${reg.descripcionFaltas.split('; ').map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            ${reg.observaciones ? `<small class="d-block text-muted"><em>Observación: ${reg.observaciones}</em></small>` : ''}
                        </div>
                        ${index < historial.length - 1 ? '<hr class="my-2">' : ''}
                    `;
                });
            } else {
                historialHtml += '<p class="text-center text-muted">No se encontraron registros.</p>';
            }
            historialHtml += '</div>';
            
            const fotoSrc = colaborador.fotoUrl || `https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random`;
            const detailModalHtml = `
                <div class="d-flex justify-content-start mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-volver-resumen">
                        <i class="fas fa-arrow-left me-1"></i> Volver al Resumen
                    </button>
                </div>
                <div class="text-center mb-3">
                    <img src="${fotoSrc}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #dee2e6;" onerror="this.src='https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random'">
                    <h5 class="mt-2 mb-0">${colaborador.nombre}</h5>
                    <span class="badge bg-secondary">${colaborador.identidad}</span>
                    <p class="mt-2">Total de acciones: <strong>${historial.length}</strong></p>
                </div>
                ${historialHtml}
            `;

            Swal.fire({
                title: 'Detalle de Faltas',
                html: detailModalHtml,
                width: '600px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    document.getElementById('btn-volver-resumen').addEventListener('click', () => {
                        Swal.close();
                        mostrarResumenDisciplina();
                    });
                }
            });
        }


        function filtrarDisciplina() {
            const texto = $('#buscador-disciplina').val().toLowerCase();
            $('#tabla-disciplina tbody tr').each(function() {
                const nombre = $(this).find('td:eq(1)').text().toLowerCase(), identidad = $(this).find('td:eq(2)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto) || identidad.includes(texto));
            });
        }
        
        function calcularEstadisticasDisciplina() {
            const totalActivos = colaboradoresActivos.length;
            if (totalActivos === 0 && disciplina.length === 0) {
                 $('.rotacion-periodos .porcentaje').text('0%');
                 return;
            }

            const hoy = new Date();
            const periodos = [{ id: 'mes', meses: 0 }, { id: '3meses', meses: 3 }, { id: '6meses', meses: 6 }, { id: '12meses', meses: 12 }];
            periodos.forEach(p => {
                const fechaInicio = p.meses === 0 ? new Date(hoy.getFullYear(), hoy.getMonth(), 1) : new Date(hoy.getFullYear(), hoy.getMonth() - p.meses, 1);
                const accionesPeriodo = disciplina.filter(d => new Date(d.fechaFalta) >= fechaInicio).length;
                const porcentaje = totalActivos > 0 ? ((accionesPeriodo / totalActivos) * 100).toFixed(2) : '0.00';
                $(`#disciplina-${p.id}`).text(porcentaje + '%');
            });
            
            const totalAccionesHistorico = disciplina.length;
            const porcentajeHistorico = totalActivos > 0 ? ((totalAccionesHistorico / totalActivos) * 100).toFixed(2) : '0.00';
            $('#disciplina-historico').text(porcentajeHistorico + '%');
        }

        function crearGraficoDisciplinaPorDia(ano, mes) {
            if (graficoDisciplinaPorDia) graficoDisciplinaPorDia.destroy();
            const ctx = document.getElementById('graficoDisciplinaPorDia').getContext('2d');
            const diasEnMes = new Date(ano, mes + 1, 0).getDate();
            const labels = Array.from({ length: diasEnMes }, (_, i) => `${i + 1}/${mes + 1}`);
            const datos = Array(diasEnMes).fill(0);

            disciplina.forEach(d => {
                const fechaFalta = new Date(d.fechaFalta + 'T00:00:00');
                if (fechaFalta.getMonth() === mes && fechaFalta.getFullYear() === ano) {
                    datos[fechaFalta.getDate() - 1]++;
                }
            });
            
            const nombreMes = new Date(ano, mes).toLocaleString('es-ES', { month: 'long' });
            graficoDisciplinaPorDia = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: `Acciones por día en ${nombreMes} ${ano}`, data: datos, borderColor: '#c0392b', backgroundColor: 'rgba(192, 57, 43, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }
        
        function crearGraficoDisciplinaMotivo(canvasId, targetData) {
             const conteo = {};
             targetData.forEach(reg => {
                reg.descripcionFaltas.split('; ').forEach(falta => {
                    if(falta) conteo[falta] = (conteo[falta] || 0) + 1;
                });
             });
             const labels = Object.keys(conteo);
             const data = Object.values(conteo);
             
             const ctx = document.getElementById(canvasId).getContext('2d');
             return new Chart(ctx, {
                type: 'pie',
                data: { labels, datasets: [{ data, backgroundColor: ['#e74c3c', '#f1c40f', '#3498db', '#9b59b6', '#2ecc71', '#e67e22', '#1abc9c', '#2c3e50', '#7f8c8d'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Distribución por Motivo' } } }
            });
        }

        function crearGraficoDisciplinaMotivoActual() {
            if (graficoDisciplinaMotivoActual) graficoDisciplinaMotivoActual.destroy();
            const hoy = new Date(), mesActual = hoy.getMonth(), anoActual = hoy.getFullYear();
            const datosMes = disciplina.filter(d => {
                const fecha = new Date(d.fechaFalta + 'T00:00:00');
                return fecha.getMonth() === mesActual && fecha.getFullYear() === anoActual;
            });
            graficoDisciplinaMotivoActual = crearGraficoDisciplinaMotivo('graficoDisciplinaMotivoActual', datosMes);
            graficoDisciplinaMotivoActual.options.plugins.title.text = 'Distribución (Mes Actual)';
            graficoDisciplinaMotivoActual.update();
        }

        function crearGraficoDisciplinaMotivoHistorico() {
            if (graficoDisciplinaMotivoHistorico) graficoDisciplinaMotivoHistorico.destroy();
            graficoDisciplinaMotivoHistorico = crearGraficoDisciplinaMotivo('graficoDisciplinaMotivoHistorico', disciplina);
            graficoDisciplinaMotivoHistorico.options.plugins.title.text = 'Distribución (Histórica)';
            graficoDisciplinaMotivoHistorico.update();
        }

        function crearGraficoDisciplinaMotivoFiltrado(ano, mes) {
            if (graficoDisciplinaMotivoFiltrado) graficoDisciplinaMotivoFiltrado.destroy();
            const datosFiltrados = disciplina.filter(d => {
                const fecha = new Date(d.fechaFalta + 'T00:00:00');
                return fecha.getMonth() === mes && fecha.getFullYear() === ano;
            });
            graficoDisciplinaMotivoFiltrado = crearGraficoDisciplinaMotivo('graficoDisciplinaMotivoFiltrado', datosFiltrados);
            const nombreMes = new Date(ano, mes).toLocaleString('es-ES', { month: 'long' });
            graficoDisciplinaMotivoFiltrado.options.plugins.title.text = `Distribución (${nombreMes} ${ano})`;
            graficoDisciplinaMotivoFiltrado.update();
        }
        
        function calcularEstadisticasAusencias() {
            const hoy = new Date();
            const periodos = [{ id: 'mes', meses: 0 }, { id: '3meses', meses: 3 }, { id: '6meses', meses: 6 }, { id: '12meses', meses: 12 }];
            periodos.forEach(p => {
                const fechaFinPeriodo = new Date(hoy), fechaInicioPeriodo = (p.meses === 0) ? new Date(hoy.getFullYear(), hoy.getMonth(), 1) : new Date(hoy.getFullYear(), hoy.getMonth() - p.meses + 1, 1);
                let diasAusentePeriodo = 0;
                ausencias.forEach(a => { for (let d = new Date(a.fecha); d <= new Date(a.fechaFin || a.fecha); d.setDate(d.getDate() + 1)) if (d >= fechaInicioPeriodo && d <= fechaFinPeriodo) diasAusentePeriodo++; });
                const diasLaborablesPosibles = colaboradoresActivos.length * 22 * (p.meses === 0 ? 1 : p.meses);
                const porcentaje = diasLaborablesPosibles > 0 ? ((diasAusentePeriodo / diasLaborablesPosibles) * 100).toFixed(2) : '0.00';
                $(`#ausentismo-${p.id}`).text(porcentaje + '%');
                if(p.id === 'mes') $('#ausentismo-mes-dashboard').text(porcentaje + '%');
            });
            let totalDiasAusenciasHistorico = 0;
            ausencias.forEach(a => { totalDiasAusenciasHistorico += calcularDiasAusencia(a.fecha, a.fechaFin || a.fecha); });
            let totalDiasLaborablesPosiblesHistorico = 0;
            [...colaboradoresIngresos].forEach(col => {
                const fechaInicio = new Date(col.fechaInicio), egreso = colaboradoresEgresos.find(e => e.identidad === col.identidad);
                let fechaFin = egreso ? new Date(egreso.fechaEgreso) : new Date(hoy);
                if (fechaFin > hoy) fechaFin = new Date(hoy);
                if (fechaFin >= fechaInicio) {
                    let mesesDeTrabajo = (fechaFin.getFullYear() - fechaInicio.getFullYear()) * 12 - fechaInicio.getMonth() + fechaFin.getMonth();
                    totalDiasLaborablesPosiblesHistorico += (mesesDeTrabajo < 0 ? 0 : mesesDeTrabajo + 1) * 22;
                }
            });
            $('#ausentismo-historico').text(totalDiasLaborablesPosiblesHistorico > 0 ? ((totalDiasAusenciasHistorico / totalDiasLaborablesPosiblesHistorico) * 100).toFixed(2) + '%' : '0.00%');
        }

        function popularFiltrosGrafico(mesSelector, anoSelector, datos, fechaKey = 'fecha') {
            const filtroMes = $(mesSelector), filtroAno = $(anoSelector);
            filtroMes.empty(); filtroAno.empty();
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            meses.forEach((mes, i) => filtroMes.append(`<option value="${i}">${mes}</option>`));
            const anos = [...new Set(datos.map(d => d[fechaKey] ? new Date(d[fechaKey]).getFullYear() : null).filter(Boolean))];
            if (!anos.includes(new Date().getFullYear())) anos.push(new Date().getFullYear());
            anos.sort((a,b) => b-a).forEach(ano => filtroAno.append(`<option value="${ano}">${ano}</option>`));
            const hoy = new Date();
            filtroMes.val(hoy.getMonth());
            filtroAno.val(hoy.getFullYear());
        }

        function crearGraficoAusencias(ano, mes) {
            if (graficoAusencias) graficoAusencias.destroy();
            const ctx = document.getElementById('graficoAusencias').getContext('2d'), diasEnMes = new Date(ano, mes + 1, 0).getDate();
            const labels = Array.from({ length: diasEnMes }, (_, i) => `${i + 1}/${mes + 1}`), datosAusentes = Array(diasEnMes).fill(0);
            ausencias.forEach(a => { for (let d = new Date(a.fecha); d <= new Date(a.fechaFin || a.fecha); d.setDate(d.getDate() + 1)) if (d.getMonth() === mes && d.getFullYear() === ano) datosAusentes[d.getDate() - 1]++; });
            const nombreMes = new Date(ano, mes).toLocaleString('es-ES', { month: 'long' });
            graficoAusencias = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: `Ausentes por día en ${nombreMes} ${ano}`, data: datosAusentes, borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
        }
        
        function crearGraficoAusenciasMotivo(canvasId, targetData) {
            const conteo = {};
            targetData.forEach(a => { conteo[a.motivo] = (conteo[a.motivo] || 0) + 1; });
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, { type: 'pie', data: { labels: Object.keys(conteo), datasets: [{ data: Object.values(conteo), backgroundColor: ['#3498db', '#f1c40f', '#e74c3c', '#9b59b6', '#2ecc71'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Distribución' } } } });
        }

        function crearGraficoAusenciasMotivoActual() {
            if (graficoAusenciasMotivoActual) graficoAusenciasMotivoActual.destroy();
            const hoy = new Date(), mesActual = hoy.getMonth(), anoActual = hoy.getFullYear();
            const datosMes = ausencias.filter(a => { const fecha = new Date(a.fecha); return fecha.getMonth() === mesActual && fecha.getFullYear() === anoActual; });
            graficoAusenciasMotivoActual = crearGraficoAusenciasMotivo('graficoAusenciasMotivoActual', datosMes);
            graficoAusenciasMotivoActual.options.plugins.title.text = 'Distribución (Mes Actual)';
            graficoAusenciasMotivoActual.update();
        }

        function crearGraficoAusenciasMotivoHistorico() {
            if (graficoAusenciasMotivoHistorico) graficoAusenciasMotivoHistorico.destroy();
            graficoAusenciasMotivoHistorico = crearGraficoAusenciasMotivo('graficoAusenciasMotivoHistorico', ausencias);
            graficoAusenciasMotivoHistorico.options.plugins.title.text = 'Distribución (Histórica)';
            graficoAusenciasMotivoHistorico.update();
        }
        
        function crearGraficoAusenciasMotivoFiltrado(ano, mes) {
            if (graficoAusenciasMotivoFiltrado) graficoAusenciasMotivoFiltrado.destroy();
            const datosFiltrados = ausencias.filter(a => { const fecha = new Date(a.fecha); return fecha.getMonth() === mes && fecha.getFullYear() === ano; });
            graficoAusenciasMotivoFiltrado = crearGraficoAusenciasMotivo('graficoAusenciasMotivoFiltrado', datosFiltrados);
            graficoAusenciasMotivoFiltrado.options.plugins.title.text = `Distribución (${new Date(ano, mes).toLocaleString('es-ES', { month: 'long' })} ${ano})`;
            graficoAusenciasMotivoFiltrado.update();
        }
        
        function crearGraficoEgresosMotivoActual() {
            if(graficoEgresosMotivoActual) graficoEgresosMotivoActual.destroy();
            const hoy = new Date(), mesActual = hoy.getMonth(), anoActual = hoy.getFullYear();
            const egresosMes = colaboradoresEgresos.filter(e => { const fecha = new Date(e.fechaEgreso); return fecha.getMonth() === mesActual && fecha.getFullYear() === anoActual; });
            const conteo = {}; egresosMes.forEach(e => { conteo[e.razon] = (conteo[e.razon] || 0) + 1; });
            const ctx = document.getElementById('graficoEgresosMotivoActual').getContext('2d');
            graficoEgresosMotivoActual = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(conteo), datasets: [{ data: Object.values(conteo), backgroundColor: ['#2980b9', '#c0392b', '#f39c12', '#8e44ad', '#27ae60'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Egresos (Mes Actual)' } } } });
        }

        function crearGraficoEgresosMotivoHistorico() {
            if (graficoEgresosMotivoHistorico) graficoEgresosMotivoHistorico.destroy();
            const conteo = {}; colaboradoresEgresos.forEach(e => { conteo[e.razon] = (conteo[e.razon] || 0) + 1; });
            const ctx = document.getElementById('graficoEgresosMotivoHistorico').getContext('2d');
            graficoEgresosMotivoHistorico = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(conteo), datasets: [{ data: Object.values(conteo), backgroundColor: ['#2980b9', '#c0392b', '#f39c12', '#8e44ad', '#27ae60'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Egresos (Histórico)' } } } });
        }

        function crearGraficoEgresosMotivoFiltrado(ano, mes) {
            if(graficoEgresosMotivoFiltrado) graficoEgresosMotivoFiltrado.destroy();
            const egresosFiltrados = colaboradoresEgresos.filter(e => { const fecha = new Date(e.fechaEgreso); return fecha.getMonth() === mes && fecha.getFullYear() === ano; });
            const conteo = {}; egresosFiltrados.forEach(e => { conteo[e.razon] = (conteo[e.razon] || 0) + 1; });
            const ctx = document.getElementById('graficoEgresosMotivoFiltrado').getContext('2d');
            graficoEgresosMotivoFiltrado = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(conteo), datasets: [{ data: Object.values(conteo), backgroundColor: ['#2980b9', '#c0392b', '#f39c12', '#8e44ad', '#27ae60'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: `Egresos (${new Date(ano, mes).toLocaleString('es-ES', { month: 'long' })} ${ano})` } } } });
        }
        
        function mostrarCumpleanerosDelMes() {
            const mesActual = new Date().getMonth();
            const cumpleaneros = colaboradoresActivos.filter(col => col.fechaNacimiento && new Date(col.fechaNacimiento + 'T00:00:00').getMonth() === mesActual)
                .sort((a, b) => new Date(a.fechaNacimiento + 'T00:00:00').getDate() - new Date(b.fechaNacimiento + 'T00:00:00').getDate());
            const contenedor = $('#contenedor-cumpleaneros').empty();
            if (cumpleaneros.length > 0) {
                 cumpleaneros.forEach(col => {
                    const dia = new Date(col.fechaNacimiento + 'T00:00:00').getDate();
                    const fotoHtml = col.fotoUrl ? `<img src="${col.fotoUrl}" class="cumpleanero-img" alt="${col.nombre}">` : `<i class="fas fa-user-circle cumpleanero-img-icon"></i>`;
                    contenedor.append(`<div class="col-lg-3 col-md-4 col-sm-6 mb-4"><div class="cumpleanero-card"><div class="cumpleanero-img-container">${fotoHtml}</div><div class="cumpleanero-info"><h5>${col.nombre}</h5><p><span class="badge">${dia} de ${new Date(2000, mesActual).toLocaleString('es-ES', { month: 'long' })}</span></p></div></div></div>`);
                 });
            } else { contenedor.append('<div class="col-12"><p class="text-center text-muted">No hay cumpleaños este mes.</p></div>'); }
        }

        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            const fecha = new Date(fechaStr + 'T00:00:00');
            return isNaN(fecha.getTime()) ? fechaStr : `${String(fecha.getUTCDate()).padStart(2, '0')}/${String(fecha.getUTCMonth() + 1).padStart(2, '0')}/${fecha.getUTCFullYear()}`;
        }

        function formatearIdentidad(input) {
            let valor = input.value.replace(/\D/g, '').substring(0, 13);
            if (valor.length > 8) valor = `${valor.substring(0, 8)}-${valor.substring(8)}`;
            if (valor.length > 4) valor = `${valor.substring(0, 4)}-${valor.substring(4)}`;
            input.value = valor;
        }
        
        function subirFoto(colaborador, archivo, esEdicion = false) {
            return new Promise((resolve, reject) => {
                if (!archivo) resolve(null);
                if (archivo.size > 5 * 1024 * 1024) reject('El archivo es demasiado grande (máx 5MB).');
                const reader = new FileReader();
                reader.onload = e => { $.post(SCRIPT_URL_ENVIAR, { accion: 'subir_foto', colaborador: JSON.stringify(colaborador), archivo: e.target.result.split(',')[1], esEdicion }, r => (r === 'Éxito') ? resolve('Éxito') : reject('Error: ' + r)).fail((j, t) => reject('Error: ' + t)); };
                reader.onerror = () => reject('Error al leer archivo');
                reader.readAsDataURL(archivo);
            });
        }
        
        function mostrarFoto(colaborador) {
            const content = colaborador.fotoUrl ? `<img src="${colaborador.fotoUrl}" style="width: 200px; height: 200px; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML = '<div class=\\'text-center\\'><i class=\\'fas fa-user-circle\\' style=\\'font-size: 120px;\\'></i><p>Error al cargar.</p></div>';">` : `<i class="fas fa-user-circle" style="font-size: 120px;"></i><p>No hay foto.</p>`;
            Swal.fire({ title: colaborador.nombre, html: `<div class="text-center">${content}<p class="mt-3"><strong>ID:</strong> ${colaborador.identidad}</p></div>`, confirmButtonText: 'Cerrar', width: 'auto' });
        }

        function mostrarVistaPreviaFoto(input) {
            const container = $(input).closest('.row').find('.vista-previa-container').empty();
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { container.html(`<div style="position: relative; display: inline-block;"><img src="${e.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 5px;"><button type="button" class="btn btn-danger btn-sm" onclick="quitarVistaPrevia(this)" style="position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center;"><i class="fas fa-times"></i></button></div>`); };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function quitarVistaPrevia(button) {
            const container = $(button).closest('.vista-previa-container');
            container.closest('.row').find('.foto-colaborador').val('');
            container.empty();
        }

        function mostrarVistaPreviaEdicion(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    let vistaPrevia = document.getElementById('vista-previa-foto-editar');
                    if (!vistaPrevia) { vistaPrevia = document.createElement('div'); vistaPrevia.id = 'vista-previa-foto-editar'; vistaPrevia.style.marginTop = '10px'; input.parentNode.appendChild(vistaPrevia); }
                    vistaPrevia.innerHTML = `<p>Nueva foto:</p><img src="${e.target.result}" style="max-width: 120px; border-radius: 5px;"><button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="quitarVistaPreviaEdicion()">Cancelar</button>`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function quitarVistaPreviaEdicion() {
            const vistaPrevia = document.getElementById('vista-previa-foto-editar'), inputFoto = document.getElementById('editar-foto');
            if (vistaPrevia) vistaPrevia.remove();
            if (inputFoto) inputFoto.value = '';
        }

    </script>
</body>
</html>
