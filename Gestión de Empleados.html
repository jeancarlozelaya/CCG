<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empleados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --warning-color: #f39c12;
        --dark-color: #34495e;
        --text-color: #333;
        --border-color: #ddd;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
        color: var(--text-color);
        line-height: 1.6;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        text-align: center;
        padding: 18px 0;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: var(--shadow);
        position: relative;
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 25px;
        font-size: 1.8rem;
        position: relative;
        padding-bottom: 10px;
        font-weight: bold;
    }

    h1:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background-color: var(--secondary-color);
        border-radius: 2px;
    }

    .container {
        max-width: 1200px;
        margin: 25px auto;
        padding: 0 15px;
    }

    .card {
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: none;
        margin-bottom: 25px;
    }

    .card-header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 18px 25px;
        font-weight: 600;
        font-size: 1.1rem;
        position: relative;
        overflow: hidden;
    }

    .card-header:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
    }

    .nav-tabs .nav-link {
        color: var(--dark-color);
        font-weight: 500;
        border: none;
        padding: 12px 20px;
    }

    .nav-tabs .nav-link.active {
        color: var(--secondary-color);
        border-bottom: 3px solid var(--secondary-color);
        background-color: transparent;
    }

    .tab-content {
        padding: 25px;
        background-color: white;
        border-radius: 0 0 12px 12px;
    }

    /* Estilo uniforme para todos los títulos de sección */
    .tab-title {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
        padding: 20px 0;
        position: relative;
    }

    .tab-title h2 {
        font-size: 1.5rem; /* Tamaño reducido */
        font-weight: 700;
        margin: 0;
        display: inline-block;
        padding: 0 25px;
        position: relative;
    }

    .tab-title h2:after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        border-radius: 2px;
    }

    .tab-title h2:before {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        right: 0;
        height: 1px;
        background-color: var(--border-color);
    }

    .stat-card {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 15px;
        transition: var(--transition);
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-card .icon {
        font-size: 1.8rem;
        margin-bottom: 10px;
    }

    .stat-card h3 {
        font-size: 1.5rem;
        margin-bottom: 5px;
        font-weight: 700;
    }

    .stat-card p {
        color: #7f8c8d;
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }

    .table th {
        background-color: var(--primary-color);
        color: white;
        border: none;
    }

    .table td {
        vertical-align: middle;
    }

    .btn-action {
        padding: 5px 10px;
        margin: 0 2px;
        font-size: 0.85rem;
    }

    .btn-edit {
        background-color: var(--warning-color);
        border-color: var(--warning-color);
        color: white;
    }

    .btn-delete {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }

    .search-container {
        position: relative;
        margin-bottom: 20px;
    }

    .search-container i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
    }

    .search-container input {
        padding-left: 40px;
    }

    #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(52, 152, 219, 0.2);
        border-radius: 50%;
        border-top-color: var(--secondary-color);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    #loadingMessage {
        text-align: center;
        color: var(--dark-color);
    }

    #loadingMessage h4 {
        margin: 0 0 10px;
        font-size: 1.3rem;
        font-weight: bold;
    }

    #loadingMessage p {
        margin: 0;
        color: #7f8c8d;
        font-weight: normal;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .date-range-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .date-range-container .form-group {
        flex: 1;
        min-width: 200px;
    }

    .autocomplete-container {
        position: relative;
    }

    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .autocomplete-item:hover {
        background-color: #f5f5f5;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .rotacion-periodos {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .periodo-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .periodo-card h4 {
        font-size: 1.1rem;
        margin-bottom: 10px;
    }

    .periodo-card .porcentaje {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .periodo-card .detalle {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .ausencias-stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 25px;
    }

    /* Estilos mejorados para botones principales */
    .btn-primary {
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        border: none;
        font-weight: 600;
        padding: 12px 30px;
        font-size: 1.1rem;
        border-radius: 8px;
        min-width: 200px;
        transition: var(--transition);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .rotacion-periodos {
            grid-template-columns: 1fr 1fr;
        }
        
        .ausencias-stats {
            grid-template-columns: 1fr;
        }
        
        .date-range-container {
            flex-direction: column;
        }
        
        .date-range-container .form-group {
            min-width: 100%;
        }
        
        .tab-title h2 {
            font-size: 1.3rem;
            padding: 0 18px;
        }
    }

    @media (max-width: 576px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        
        .rotacion-periodos {
            grid-template-columns: 1fr;
        }
        
        .nav-tabs .nav-link {
            padding: 10px 15px;
            font-size: 0.9rem;
        }
        
        .tab-content {
            padding: 15px;
        }
        
        .tab-title h2 {
            font-size: 1.2rem;
            padding: 0 15px;
        }

        .btn-primary {
            min-width: 180px;
            padding: 10px 25px;
            font-size: 1rem;
        }
    }
 
    .btn-photo {
        background-color: #17a2b8;
        border-color: #17a2b8;
        color: white;
    }

    .btn-action {
        padding: 5px 10px;
        margin: 0 2px;
        font-size: 0.85rem;
    }

    /* Estilos para las vistas previas de fotos */
    #vista-previa-foto, #vista-previa-foto-editar {
        transition: all 0.3s ease;
    }

    #vista-previa-foto img, #vista-previa-foto-editar img {
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Estilos adicionales para mejoras visuales */
    .form-label {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 8px;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(52, 152, 219, 0.05);
        transform: scale(1.01);
        transition: var(--transition);
    }
</style>
</head>
<body>
    <div class="header">Pisos Brillantes</div>
    <div class="container">
        <h1>Gestión de Empleados</h1>

        <div class="card">
            <div class="card-body p-0">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                            <i class="fas fa-home me-2"></i>Dashboard
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="registrar-tab" data-bs-toggle="tab" data-bs-target="#registrar" type="button" role="tab" aria-controls="registrar" aria-selected="false">
                            <i class="fas fa-user-plus me-2"></i>Registrar Colaborador
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="activos-tab" data-bs-toggle="tab" data-bs-target="#activos" type="button" role="tab" aria-controls="activos" aria-selected="false">
                            <i class="fas fa-users me-2"></i>Personal Activo
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rotacion-tab" data-bs-toggle="tab" data-bs-target="#rotacion" type="button" role="tab" aria-controls="rotacion" aria-selected="false">
                            <i class="fas fa-chart-line me-2"></i>Tasa de Rotación
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ausencias-tab" data-bs-toggle="tab" data-bs-target="#ausencias" type="button" role="tab" aria-controls="ausencias" aria-selected="false">
                            <i class="fas fa-clock me-2"></i>Ausencias
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="myTabContent">
                    <!-- Dashboard Tab -->
                    <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                        <div class="tab-title">
                            <h2>Resumen de Colaboradores</h2>
                        </div>
                        
                        <div class="dashboard-grid">
                            <div class="stat-card" style="background-color: #e8f4fd;">
                                <div class="icon text-primary">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h3 id="total-activos">0</h3>
                                <p>Total de Activos</p>
                            </div>

                            <div class="stat-card" style="background-color: #f4ecf7;">
                                <div class="icon text-info">
                                    <i class="fas fa-user-clock"></i>
                                </div>
                                <h3 id="ausencias-hoy">0</h3>
                                <p>Ausencias Hoy</p>
                            </div>
                            
                            <div class="stat-card" style="background-color: #e8f8f5;">
                                <div class="icon text-success">
                                    <i class="fas fa-user-check"></i>
                                </div>
                                <h3 id="presentes-hoy">0</h3>
                                <p>Presentes Hoy</p>
                            </div>

                            <div class="stat-card" style="background-color: #e8f6f3;">
                                <div class="icon text-success">
                                    <i class="fas fa-male"></i>
                                </div>
                                <h3 id="total-hombres">0</h3>
                                <p>Hombres</p>
                            </div>
                            
                            <div class="stat-card" style="background-color: #fdedec;">
                                <div class="icon text-danger">
                                    <i class="fas fa-female"></i>
                                </div>
                                <h3 id="total-mujeres">0</h3>
                                <p>Mujeres</p>
                            </div>
                            
                            <div class="stat-card" style="background-color: #fef9e7;">
                                <div class="icon text-warning">
                                    <i class="fas fa-birthday-cake"></i>
                                </div>
                                <h3 id="edad-promedio">0</h3>
                                <p>Edad Promedio</p>
                            </div>
                            


                            <div class="stat-card" style="background-color: #fff3cd;">
                                <div class="icon text-warning">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <h3 id="rotacion-mes-dashboard">0%</h3>
                                <p>Rotación del Mes</p>
                            </div>

                            <div class="stat-card" style="background-color: #d1ecf1;">
                                <div class="icon text-info">
                                    <i class="fas fa-calendar-times"></i>
                                </div>
                                <h3 id="rotacion-general-dashboard">0</h3>
                                <p>Ausencias del Mes</p>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                Últimos Ingresos Registrados
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="tabla-ultimos-ingresos">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Nombre</th>
                                                <th>Identidad</th>
                                                <th>Fecha Nacimiento</th>
                                                <th>Sexo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Los datos se cargarán dinámicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Registrar Colaborador Tab -->
                    <div class="tab-pane fade" id="registrar" role="tabpanel" aria-labelledby="registrar-tab">
                        <div class="tab-title">
                            <h2>Registrar Nuevo Colaborador</h2>
                        </div>
                        
                        <form id="form-registrar-colaborador">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fecha-inicio" class="form-label">Fecha de Inicio</label>
                                    <input type="date" class="form-control" id="fecha-inicio" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="nombre-completo" class="form-label">Nombre Completo</label>
                                    <input type="text" class="form-control" id="nombre-completo" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="identidad" class="form-label">Identidad</label>
                                    <input type="text" class="form-control" id="identidad" placeholder="0000-0000-00000" pattern="\d{4}-\d{4}-\d{5}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="fecha-nacimiento" class="form-label">Fecha de Nacimiento</label>
                                    <input type="date" class="form-control" id="fecha-nacimiento" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="sexo" class="form-label">Sexo</label>
                                    <select class="form-select" id="sexo" required>
                                        <option value="">Seleccionar...</option>
                                        <option value="Masculino">Masculino</option>
                                        <option value="Femenino">Femenino</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="foto-colaborador" class="form-label">Foto (opcional)</label>
                                    <input type="file" class="form-control" id="foto-colaborador" accept="image/*" onchange="mostrarVistaPreviaFoto(this)">
                                    <div class="form-text">Formatos aceptados: JPG, PNG, GIF. Tamaño máximo: 5MB</div>
                                    <!-- Aquí se mostrará la vista previa -->
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-center">
                                <button type="button" class="btn btn-primary" id="btn-registrar-colaborador">Registrar Colaborador</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Personal Activo Tab -->
                    <div class="tab-pane fade" id="activos" role="tabpanel" aria-labelledby="activos-tab">
                        <div class="tab-title">
                            <h2>Personal Activo</h2>
                        </div>
                        
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" class="form-control" id="buscador-activos" placeholder="Buscar por nombre...">
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="tabla-activos">
                                <thead>
                                    <tr>
                                        <th>Fecha Inicio</th>
                                        <th>Nombre</th>
                                        <th>Identidad</th>
                                        <th>Fecha Nacimiento</th>
                                        <th>Sexo</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Tasa de Rotación Tab -->
                    <div class="tab-pane fade" id="rotacion" role="tabpanel" aria-labelledby="rotacion-tab">
                        <div class="tab-title">
                            <h2>Tasa de Rotación</h2>
                        </div>
                        
                        <div class="rotacion-periodos">
                            <div class="periodo-card">
                                <h4>Rotación General</h4>
                                <div class="porcentaje" id="rotacion-general">0%</div>
                                <div class="detalle" id="detalle-general">0 egresos</div>
                            </div>
                            <div class="periodo-card">
                                <h4>Rotación del Mes</h4>
                                <div class="porcentaje" id="rotacion-mes">0%</div>
                                <div class="detalle" id="detalle-mes">0 egresos</div>
                            </div>
                            <div class="periodo-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <h4>Últimos 3 Meses</h4>
                                <div class="porcentaje" id="rotacion-3meses">0%</div>
                                <div class="detalle" id="detalle-3meses">0 egresos</div>
                            </div>
                            <div class="periodo-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <h4>Últimos 6 Meses</h4>
                                <div class="porcentaje" id="rotacion-6meses">0%</div>
                                <div class="detalle" id="detalle-6meses">0 egresos</div>
                            </div>
                            <div class="periodo-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                <h4>Últimos 12 Meses</h4>
                                <div class="porcentaje" id="rotacion-12meses">0%</div>
                                <div class="detalle" id="detalle-12meses">0 egresos</div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                Calcular Rotación por Período Personalizado
                            </div>
                            <div class="card-body">
                                <div class="date-range-container">
                                    <div class="form-group">
                                        <label for="fecha-inicio-personalizado" class="form-label">Fecha Inicio</label>
                                        <input type="date" class="form-control" id="fecha-inicio-personalizado">
                                    </div>
                                    <div class="form-group">
                                        <label for="fecha-fin-personalizado" class="form-label">Fecha Fin</label>
                                        <input type="date" class="form-control" id="fecha-fin-personalizado">
                                    </div>
                                    <div class="form-group d-flex align-items-end">
                                        <button type="button" class="btn btn-primary" id="btn-calcular-rotacion-personalizado">Calcular</button>
                                    </div>
                                </div>
                                
                                <div class="search-container mt-4">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control" id="buscador-egresos" placeholder="Buscar egresos...">
                                </div>
                                
                                <div class="table-responsive mt-3">
                                    <table class="table table-striped table-hover" id="tabla-egresos">
                                        <thead>
                                            <tr>
                                                <th>Fecha Egreso</th>
                                                <th>Nombre</th>
                                                <th>Identidad</th>
                                                <th>Fecha Nacimiento</th>
                                                <th>Sexo</th>
                                                <th>Razón</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Los datos se cargarán dinámicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ausencias Tab -->
                    <div class="tab-pane fade" id="ausencias" role="tabpanel" aria-labelledby="ausencias-tab">
                        <div class="tab-title">
                            <h2>Registro de Ausencias</h2>
                        </div>
                        
                        <div class="ausencias-stats">
                            <div class="stat-card" style="background-color: #e8f4fd;">
                                <div class="icon text-primary">
                                    <i class="fas fa-calendar-times"></i>
                                </div>
                                <h3 id="porcentaje-ausencias-mes">0%</h3>
                                <p>Ausencias del Mes</p>
                            </div>
                            
                            <div class="stat-card" style="background-color: #fef9e7;">
                                <div class="icon text-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h3 id="total-ausencias-mes">0</h3>
                                <p>Total Ausencias (Mes)</p>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header">
                                Gráfico de Ausencias del Mes
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="graficoAusencias"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                Registrar Nueva Ausencia
                            </div>
                            <div class="card-body">
                                <form id="form-registrar-ausencia">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="fecha-ausencia" class="form-label">Fecha de Ausencia</label>
                                            <input type="date" class="form-control" id="fecha-ausencia" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="dias-incapacidad" class="form-label">Días de Ausencia</label>
                                            <input type="number" class="form-control" id="dias-incapacidad" value="1" min="1" required>
                                            <div class="form-text">Número de días que estará ausente</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="colaborador-ausencia" class="form-label">Colaborador</label>
                                            <div class="autocomplete-container">
                                                <input type="text" class="form-control" id="colaborador-ausencia" placeholder="Escriba el nombre..." required>
                                                <div class="autocomplete-list" id="autocomplete-list"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="motivo-ausencia" class="form-label">Motivo</label>
                                            <select class="form-select" id="motivo-ausencia" required>
                                                <option value="">Seleccionar...</option>
                                                <option value="Enfermedad">Enfermedad</option>
                                                <option value="Permiso">Permiso</option>
                                                <option value="Falta Injustificada">Falta Injustificada</option>
                                                <option value="Incapacidad">Incapacidad</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="observaciones-ausencia" class="form-label">Observaciones</label>
                                            <textarea class="form-control" id="observaciones-ausencia" rows="1"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2 d-md-flex justify-content-center">
                                        <button type="button" class="btn btn-primary" id="btn-registrar-ausencia">Registrar Ausencia</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Historial de Ausencias</span>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="btn-ver-ausencias">Ver Todas las Ausencias</button>
                            </div>
                            <div class="card-body">
                                <div class="search-container">
                                    <i class="fas fa-search"></i>
                                    <input type="text" class="form-control" id="buscador-ausencias" placeholder="Buscar ausencias...">
                                </div>
                                
                                <div class="table-responsive mt-3">
                                    <table class="table table-striped table-hover" id="tabla-ausencias">
                                        <thead>
                                            <tr>
                                                <th>Fecha Inicio</th>
                                                <th>Fecha Fin</th>
                                                <th>Nombre</th>
                                                <th>Identidad</th>
                                                <th>Motivo</th>
                                                <th>Días</th>
                                                <th>Observaciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Los datos se cargarán dinámicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay de carga -->
    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Por favor espera un momento...</h4>
            <p></p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        let colaboradoresActivos = [];
        let colaboradoresIngresos = [];
        let colaboradoresEgresos = [];
        let ausencias = [];
        let nombresActivos = [];
        let graficoAusencias = null;

        // URLs de los scripts de Google Apps Script
        const SCRIPT_URL_OBTENER = "https://script.google.com/macros/s/AKfycbwV6UwcNpiC5FAahk3YPuOS-JSm7Fta5bNW_UoOwvqywTiS-a8LSqAMT32PKM1ydQJs/exec";
        const SCRIPT_URL_ENVIAR = "https://script.google.com/macros/s/AKfycbwP81lGExHp4d9tPRhNNgJ5rlcgXIXj2AsNDNTFcd8Gzdhujy_2UEO0x016YrccFMxU/exec";

        // Configuración inicial al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Establecer fechas actuales
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = yyyy + '-' + mm + '-' + dd;
            
            document.getElementById("fecha-inicio").value = todayStr;
            document.getElementById("fecha-ausencia").value = todayStr;
            
            // Cargar todos los datos desde Google Sheets
            cargarTodosLosDatos();
            
            // Configurar eventos
            configurarEventos();
        });

        // Función para cargar todos los datos desde Google Sheets
        function cargarTodosLosDatos() {
            $('#overlay').show();
            
            $.get(SCRIPT_URL_OBTENER, function(data) {
                $('#overlay').hide();
                
                if (data.error) {
                    Swal.fire('Error', 'No se pudieron cargar los datos: ' + data.mensaje, 'error');
                    return;
                }
                
                colaboradoresActivos = data.activos || [];
                colaboradoresIngresos = data.ingresos || [];
                colaboradoresEgresos = data.egresos || [];
                ausencias = data.ausencias || [];
                
                // Corregir formato de fechas (evitar resta de un día)
                colaboradoresActivos = colaboradoresActivos.map(corregirFecha);
                colaboradoresIngresos = colaboradoresIngresos.map(corregirFecha);
                colaboradoresEgresos = colaboradoresEgresos.map(corregirFecha);
                ausencias = ausencias.map(corregirFecha);
                
                // Extraer nombres de colaboradores activos para autocompletado
                nombresActivos = colaboradoresActivos.map(col => col.nombre);
                
                // Actualizar la interfaz con los datos
                actualizarDashboard();
                mostrarColaboradoresActivos();
                calcularRotacionGeneral();
                calcularRotacionPeriodos();
                mostrarAusencias();
                calcularEstadisticasAusencias();
                crearGraficoAusencias();
                
            }).fail(function(jqXHR, textStatus, errorThrown) {
                $('#overlay').hide();
                Swal.fire('Error', 'No se pudo conectar al servidor o hubo un error de red. ' + textStatus + ': ' + errorThrown, 'error');
                console.error("Error en la solicitud AJAX:", jqXHR, textStatus, errorThrown);
            });
        }

        // Función para corregir formato de fechas
        function corregirFecha(item) {
            const propiedadesFecha = ['fechaInicio', 'fechaNacimiento', 'fechaEgreso', 'fecha', 'fechaFin'];
            
            propiedadesFecha.forEach(prop => {
                if (item[prop] && typeof item[prop] === 'string') {
                    // Si la fecha viene en formato ISO con problema de zona horaria
                    if (item[prop].includes('T')) {
                        const fecha = new Date(item[prop]);
                        // NO sumar días - usar la fecha directamente
                        const año = fecha.getFullYear();
                        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                        const dia = String(fecha.getDate()).padStart(2, '0');
                        item[prop] = `${año}-${mes}-${dia}`;
                    }
                }
            });
            
            return item;
        }

        // Función para configurar eventos
        function configurarEventos() {
            // Registrar colaborador
            $('#btn-registrar-colaborador').on('click', registrarColaborador);
            
            // Buscadores
            $('#buscador-activos').on('input', filtrarActivos);
            $('#buscador-egresos').on('input', filtrarEgresos);
            $('#buscador-ausencias').on('input', filtrarAusencias);
            
            // Calcular rotación por período personalizado
            $('#btn-calcular-rotacion-personalizado').on('click', calcularRotacionPersonalizado);
            
            // Registrar ausencia
            $('#btn-registrar-ausencia').on('click', registrarAusencia);
            
            // Ver todas las ausencias
            $('#btn-ver-ausencias').on('click', function() {
                mostrarAusencias();
            });
            
            // Formatear identidad
            $('#identidad').on('input', function() {
                formatearIdentidad(this);
            });
            
            // Autocompletado para colaborador en ausencias
            $('#colaborador-ausencia').on('input', function() {
                const valor = $(this).val().toLowerCase();
                const autocompleteList = $('#autocomplete-list');
                
                if (valor.length < 2) {
                    autocompleteList.hide();
                    return;
                }
                
                const sugerencias = nombresActivos.filter(nombre => 
                    nombre.toLowerCase().includes(valor)
                );
                
                if (sugerencias.length === 0) {
                    autocompleteList.hide();
                    return;
                }
                
                autocompleteList.empty();
                sugerencias.forEach(sugerencia => {
                    autocompleteList.append(`<div class="autocomplete-item">${sugerencia}</div>`);
                });
                
                autocompleteList.show();
            });
            
            // Seleccionar elemento de autocompletado
            $(document).on('click', '.autocomplete-item', function() {
                $('#colaborador-ausencia').val($(this).text());
                $('#autocomplete-list').hide();
            });
            
            // Ocultar autocompletado al hacer clic fuera
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.autocomplete-container').length) {
                    $('#autocomplete-list').hide();
                }
            });
        }

        // Función para actualizar el dashboard
        function actualizarDashboard() {
            // Total de activos
            $('#total-activos').text(colaboradoresActivos.length);
            
            // Hombres y mujeres
            const hombres = colaboradoresActivos.filter(col => col.sexo === 'Masculino').length;
            const mujeres = colaboradoresActivos.filter(col => col.sexo === 'Femenino').length;
            
            $('#total-hombres').text(hombres);
            $('#total-mujeres').text(mujeres);
            
            // Edad promedio
            let sumaEdades = 0;
            colaboradoresActivos.forEach(col => {
                if (col.fechaNacimiento) {
                    const fechaNac = new Date(col.fechaNacimiento);
                    const hoy = new Date();
                    let edad = hoy.getFullYear() - fechaNac.getFullYear();
                    const mes = hoy.getMonth() - fechaNac.getMonth();
                    if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                        edad--;
                    }
                    sumaEdades += edad;
                }
            });
            
            const edadPromedio = colaboradoresActivos.length > 0 ? 
                Math.round(sumaEdades / colaboradoresActivos.length) : 0;
            $('#edad-promedio').text(edadPromedio);
            
            // Ausencias del día actual (solo las activas hoy)
            const hoy = new Date().toISOString().split('T')[0];
            const ausenciasHoy = ausencias.filter(ausencia => {
                const fechaInicio = new Date(ausencia.fecha);
                const fechaFin = ausencia.fechaFin ? new Date(ausencia.fechaFin) : new Date(ausencia.fecha);
                const hoyDate = new Date(hoy);
                
                return hoyDate >= fechaInicio && hoyDate <= fechaFin;
            }).length;
            
            $('#ausencias-hoy').text(ausenciasHoy);
            
            // Presentes hoy
            const presentesHoy = colaboradoresActivos.length - ausenciasHoy;
            $('#presentes-hoy').text(presentesHoy);

            // Rotación del mes en dashboard
            const inicioMes = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const egresosMes = colaboradoresEgresos.filter(egreso => {
                const fechaEgreso = new Date(egreso.fechaEgreso);
                return fechaEgreso >= inicioMes;
            });
            const rotacionMes = calcularPorcentajeRotacion(egresosMes);
            $('#rotacion-mes-dashboard').text(rotacionMes.porcentaje + '%');
            
            // Ausencias del mes en dashboard
            const ausenciasMes = ausencias.filter(ausencia => {
                const fechaInicio = new Date(ausencia.fecha);
                return fechaInicio.getMonth() === new Date().getMonth() && 
                       fechaInicio.getFullYear() === new Date().getFullYear();
            }).length;
            
            $('#rotacion-general-dashboard').text(ausenciasMes);
            
            // Últimos ingresos (últimos 5)
            const ultimosIngresos = [...colaboradoresIngresos].reverse().slice(0, 5);
            const tablaUltimosIngresos = $('#tabla-ultimos-ingresos tbody');
            tablaUltimosIngresos.empty();
            
            ultimosIngresos.forEach(ingreso => {
                tablaUltimosIngresos.append(`
                    <tr>
                        <td>${formatearFecha(ingreso.fechaInicio)}</td>
                        <td>${ingreso.nombre}</td>
                        <td>${ingreso.identidad}</td>
                        <td>${formatearFecha(ingreso.fechaNacimiento)}</td>
                        <td>${ingreso.sexo}</td>
                    </tr>
                `);
            });
        }

        // Función para mostrar colaboradores activos
        function mostrarColaboradoresActivos() {
            const tablaActivos = $('#tabla-activos tbody');
            tablaActivos.empty();
            
            colaboradoresActivos.forEach((col, index) => {
                tablaActivos.append(`
                    <tr>
                        <td>${formatearFecha(col.fechaInicio)}</td>
                        <td>${col.nombre}</td>
                        <td>${col.identidad}</td>
                        <td>${formatearFecha(col.fechaNacimiento)}</td>
                        <td>${col.sexo}</td>
                        <td>
                            <button class="btn btn-info btn-sm btn-action btn-photo" data-index="${index}" title="Ver Foto">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button class="btn btn-warning btn-sm btn-action btn-edit" data-index="${index}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm btn-action btn-delete" data-index="${index}" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // Configurar eventos para botones
            $('.btn-photo').on('click', function() {
                const index = $(this).data('index');
                mostrarFoto(colaboradoresActivos[index]);
            });
            
            $('.btn-edit').on('click', function() {
                const index = $(this).data('index');
                editarColaborador(index);
            });
            
            $('.btn-delete').on('click', function() {
                const index = $(this).data('index');
                eliminarColaborador(index);
            });
        }

        // Función para filtrar activos
        function filtrarActivos() {
            const texto = $('#buscador-activos').val().toLowerCase();
            $('#tabla-activos tbody tr').each(function() {
                const nombre = $(this).find('td:eq(1)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto));
            });
        }

        // Función para registrar un nuevo colaborador
        function registrarColaborador() {
            const fechaInicio = $('#fecha-inicio').val();
            const nombre = $('#nombre-completo').val();
            const identidad = $('#identidad').val();
            const fechaNacimiento = $('#fecha-nacimiento').val();
            const sexo = $('#sexo').val();
            const foto = $('#foto-colaborador')[0].files[0];
            
            // Validar campos obligatorios
            if (!fechaInicio || !nombre || !identidad || !fechaNacimiento || !sexo) {
                Swal.fire('Error', 'Por favor complete todos los campos obligatorios.', 'error');
                return;
            }
            
            // Validar formato de identidad
            const identidadRegex = /^\d{4}-\d{4}-\d{5}$/;
            if (!identidadRegex.test(identidad)) {
                Swal.fire('Error', 'El formato de identidad debe ser 0000-0000-00000.', 'error');
                return;
            }
            
            // Validar: Verificar si ya existe un colaborador con la misma identidad
            const colaboradorExistente = colaboradoresActivos.some(col => 
                col.identidad === identidad
            );
            
            if (colaboradorExistente) {
                Swal.fire('Error', 'Ya existe un colaborador registrado con esta identidad.', 'error');
                return;
            }
            
            // Mostrar confirmación
            Swal.fire({
                title: '¿Está seguro?',
                html: `¿Desea registrar a este colaborador?<br>
                      <strong>Nombre:</strong> ${nombre}<br>
                      <strong>Identidad:</strong> ${identidad}<br>
                      ${foto ? '<strong>Con foto:</strong> Sí' : '<strong>Con foto:</strong> No'}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, registrar',
                cancelButtonText: 'No, cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#overlay').show();
                    
                    // Primero registrar el colaborador
                    $.post(SCRIPT_URL_ENVIAR, {
                        accion: 'registrar_colaborador',
                        fechaInicio: fechaInicio,
                        nombre: nombre,
                        identidad: identidad,
                        fechaNacimiento: fechaNacimiento,
                        sexo: sexo
                    }, function(response) {
                        if (response === 'Éxito') {
                            // Si hay foto, subirla
                            if (foto) {
                                const colaborador = { nombre, identidad };
                                subirFoto(colaborador, foto, false)
                                    .then(() => {
                                        $('#overlay').hide();
                                        Swal.fire('Éxito', 'Colaborador registrado correctamente con foto.', 'success').then(() => {
                                            // Limpiar formulario COMPLETO incluyendo vista previa
                                            $('#form-registrar-colaborador')[0].reset();
                                            quitarVistaPrevia();
                                            cargarTodosLosDatos();
                                        });
                                    })
                                    .catch(error => {
                                        $('#overlay').hide();
                                        Swal.fire('Éxito', 'Colaborador registrado pero hubo un error al subir la foto: ' + error, 'warning').then(() => {
                                            $('#form-registrar-colaborador')[0].reset();
                                            quitarVistaPrevia();
                                            cargarTodosLosDatos();
                                        });
                                    });
                            } else {
                                $('#overlay').hide();
                                Swal.fire('Éxito', 'Colaborador registrado correctamente.', 'success').then(() => {
                                    $('#form-registrar-colaborador')[0].reset();
                                    quitarVistaPrevia();
                                    cargarTodosLosDatos();
                                });
                            }
                        } else {
                            $('#overlay').hide();
                            Swal.fire('Error', 'Hubo un problema al registrar el colaborador: ' + response, 'error');
                        }
                    }).fail(function() {
                        $('#overlay').hide();
                        Swal.fire('Error', 'Error de conexión al registrar el colaborador.', 'error');
                    });
                }
            });
        }

        // Función para editar colaborador
        function editarColaborador(index) {
            const colaborador = colaboradoresActivos[index];
            
            Swal.fire({
                title: 'Editar Colaborador',
                html: `
                    <form id="form-editar-colaborador">
                        <div class="mb-3">
                            <label for="editar-fecha-inicio" class="form-label">Fecha de Inicio</label>
                            <input type="date" class="form-control" id="editar-fecha-inicio" value="${colaborador.fechaInicio}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editar-nombre" class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="editar-nombre" value="${colaborador.nombre}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editar-identidad" class="form-label">Identidad</label>
                            <input type="text" class="form-control" id="editar-identidad" value="${colaborador.identidad}" pattern="\\d{4}-\\d{4}-\\d{5}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editar-fecha-nacimiento" class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="editar-fecha-nacimiento" value="${colaborador.fechaNacimiento}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editar-sexo" class="form-label">Sexo</label>
                            <select class="form-select" id="editar-sexo" required>
                                <option value="Masculino" ${colaborador.sexo === 'Masculino' ? 'selected' : ''}>Masculino</option>
                                <option value="Femenino" ${colaborador.sexo === 'Femenino' ? 'selected' : ''}>Femenino</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editar-foto" class="form-label">Foto (opcional)</label>
                            <input type="file" class="form-control" id="editar-foto" accept="image/*" onchange="mostrarVistaPreviaEdicion(this)">
                            <div class="form-text">Seleccione una nueva foto para actualizar</div>
                            ${colaborador.fotoUrl ? `
                            <div class="mt-2">
                                <strong>Foto actual:</strong><br>
                                <img src="${colaborador.fotoUrl}" alt="Foto actual" 
                                     style="max-width: 100px; max-height: 100px; border-radius: 5px; margin-top: 5px;"
                                     onerror="this.style.display='none'">
                            </div>
                            ` : ''}
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Guardar Cambios',
                cancelButtonText: 'Cancelar',
                width: '600px',
                preConfirm: () => {
                    const fechaInicio = document.getElementById('editar-fecha-inicio').value;
                    const nombre = document.getElementById('editar-nombre').value;
                    const identidad = document.getElementById('editar-identidad').value;
                    const fechaNacimiento = document.getElementById('editar-fecha-nacimiento').value;
                    const sexo = document.getElementById('editar-sexo').value;
                    const foto = document.getElementById('editar-foto').files[0];
                    
                    if (!fechaInicio || !nombre || !identidad || !fechaNacimiento || !sexo) {
                        Swal.showValidationMessage('Por favor complete todos los campos obligatorios');
                        return false;
                    }
                    
                    const identidadRegex = /^\d{4}-\d{4}-\d{5}$/;
                    if (!identidadRegex.test(identidad)) {
                        Swal.showValidationMessage('El formato de identidad debe ser 0000-0000-00000');
                        return false;
                    }
                    
                    return { fechaInicio, nombre, identidad, fechaNacimiento, sexo, foto };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // MOSTRAR CONFIRMACIÓN ANTES DE GUARDAR
                    Swal.fire({
                        title: '¿Está seguro?',
                        text: '¿Desea guardar los cambios? Esta acción sobrescribirá la información actual.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, guardar cambios',
                        cancelButtonText: 'No, cancelar'
                    }).then((confirmResult) => {
                        if (confirmResult.isConfirmed) {
                            $('#overlay').show();
                            
                            const datos = result.value;
                            
                            // Primero editar el colaborador
                            $.post(SCRIPT_URL_ENVIAR, {
                                accion: 'editar_colaborador',
                                colaboradorOriginal: JSON.stringify(colaborador),
                                datosNuevos: JSON.stringify(datos)
                            }, function(response) {
                                if (response === 'Éxito') {
                                    // Si hay foto nueva, subirla
                                    if (datos.foto) {
                                        const nuevoColaborador = { 
                                            nombre: datos.nombre, 
                                            identidad: datos.identidad 
                                        };
                                        subirFoto(nuevoColaborador, datos.foto, true)
                                            .then(() => {
                                                $('#overlay').hide();
                                                Swal.fire('Éxito', 'Colaborador actualizado correctamente con nueva foto.', 'success').then(() => {
                                                    cargarTodosLosDatos();
                                                });
                                            })
                                            .catch(error => {
                                                $('#overlay').hide();
                                                Swal.fire('Éxito', 'Colaborador actualizado pero hubo un error al subir la nueva foto: ' + error, 'warning').then(() => {
                                                    cargarTodosLosDatos();
                                                });
                                            });
                                    } else {
                                        $('#overlay').hide();
                                        Swal.fire('Éxito', 'Colaborador actualizado correctamente.', 'success').then(() => {
                                            cargarTodosLosDatos();
                                        });
                                    }
                                } else {
                                    $('#overlay').hide();
                                    Swal.fire('Error', 'Hubo un problema al actualizar el colaborador: ' + response, 'error');
                                }
                            }).fail(function() {
                                $('#overlay').hide();
                                Swal.fire('Error', 'Error de conexión al actualizar el colaborador.', 'error');
                            });
                        }
                    });
                }
            });
        }

        // Función para eliminar colaborador
        function eliminarColaborador(index) {
            const colaborador = colaboradoresActivos[index];
            
            Swal.fire({
                title: '¿Está seguro?',
                text: `¿Desea eliminar a ${colaborador.nombre}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'No, cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Solicitar fecha de egreso
                    Swal.fire({
                        title: 'Fecha de Egreso',
                        html: `
                            <input type="date" class="form-control" id="fecha-egreso" value="${new Date().toISOString().split('T')[0]}" required>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Continuar',
                        cancelButtonText: 'Cancelar',
                        preConfirm: () => {
                            const fechaEgreso = document.getElementById('fecha-egreso').value;
                            if (!fechaEgreso) {
                                Swal.showValidationMessage('Por favor seleccione la fecha de egreso');
                                return false;
                            }
                            return fechaEgreso;
                        }
                    }).then((fechaResult) => {
                        if (fechaResult.isConfirmed) {
                            const fechaEgreso = fechaResult.value;
                            
                            // Mostrar opciones de razón de egreso
                            Swal.fire({
                                title: 'Razón de Egreso',
                                input: 'select',
                                inputOptions: {
                                    'Denegación de Período de Prueba': 'Denegación de Período de Prueba',
                                    'Abandono': 'Abandono',
                                    'Renuncia': 'Renuncia',
                                    'Despido': 'Despido'
                                },
                                inputPlaceholder: 'Seleccione una razón',
                                showCancelButton: true,
                                confirmButtonText: 'Confirmar',
                                cancelButtonText: 'Cancelar',
                                inputValidator: (value) => {
                                    if (!value) {
                                        return 'Debe seleccionar una razón';
                                    }
                                }
                            }).then((razonResult) => {
                                if (razonResult.isConfirmed) {
                                    const razon = razonResult.value;
                                    
                                    $('#overlay').show();
                                    
                                    $.post(SCRIPT_URL_ENVIAR, {
                                        accion: 'eliminar_colaborador',
                                        colaborador: JSON.stringify(colaborador),
                                        fechaEgreso: fechaEgreso,
                                        razon: razon
                                    }, function(response) {
                                        $('#overlay').hide();
                                        
                                        if (response === 'Éxito') {
                                            Swal.fire('Éxito', 'Colaborador eliminado correctamente.', 'success').then(() => {
                                                // Recargar datos
                                                cargarTodosLosDatos();
                                            });
                                        } else {
                                            Swal.fire('Error', 'Hubo un problema al eliminar el colaborador: ' + response, 'error');
                                        }
                                    }).fail(function() {
                                        $('#overlay').hide();
                                        Swal.fire('Error', 'Error de conexión al eliminar el colaborador.', 'error');
                                    });
                                }
                            });
                        }
                    });
                }
            });
        }

        // Función para calcular rotación general
        function calcularRotacionGeneral() {
            const rotacionGeneral = calcularPorcentajeRotacion(colaboradoresEgresos);
            $('#rotacion-general').text(rotacionGeneral.porcentaje + '%');
            $('#detalle-general').text(rotacionGeneral.egresos + ' egresos');
        }

        // Función para calcular rotación por períodos
        function calcularRotacionPeriodos() {
            const hoy = new Date();
            
            // Mes actual
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const egresosMes = colaboradoresEgresos.filter(egreso => {
                const fechaEgreso = new Date(egreso.fechaEgreso);
                return fechaEgreso >= inicioMes;
            });
            const rotacionMes = calcularPorcentajeRotacion(egresosMes);
            $('#rotacion-mes').text(rotacionMes.porcentaje + '%');
            $('#detalle-mes').text(rotacionMes.egresos + ' egresos');
            
            // Últimos 3 meses
            const inicio3Meses = new Date(hoy.getFullYear(), hoy.getMonth() - 3, 1);
            const egresos3Meses = colaboradoresEgresos.filter(egreso => {
                const fechaEgreso = new Date(egreso.fechaEgreso);
                return fechaEgreso >= inicio3Meses;
            });
            const rotacion3Meses = calcularPorcentajeRotacion(egresos3Meses);
            $('#rotacion-3meses').text(rotacion3Meses.porcentaje + '%');
            $('#detalle-3meses').text(rotacion3Meses.egresos + ' egresos');
            
            // Últimos 6 meses
            const inicio6Meses = new Date(hoy.getFullYear(), hoy.getMonth() - 6, 1);
            const egresos6Meses = colaboradoresEgresos.filter(egreso => {
                const fechaEgreso = new Date(egreso.fechaEgreso);
                return fechaEgreso >= inicio6Meses;
            });
            const rotacion6Meses = calcularPorcentajeRotacion(egresos6Meses);
            $('#rotacion-6meses').text(rotacion6Meses.porcentaje + '%');
            $('#detalle-6meses').text(rotacion6Meses.egresos + ' egresos');
            
            // Últimos 12 meses
            const inicio12Meses = new Date(hoy.getFullYear() - 1, hoy.getMonth(), 1);
            const egresos12Meses = colaboradoresEgresos.filter(egreso => {
                const fechaEgreso = new Date(egreso.fechaEgreso);
                return fechaEgreso >= inicio12Meses;
            });
            const rotacion12Meses = calcularPorcentajeRotacion(egresos12Meses);
            $('#rotacion-12meses').text(rotacion12Meses.porcentaje + '%');
            $('#detalle-12meses').text(rotacion12Meses.egresos + ' egresos');
        }

        // Función auxiliar para calcular porcentaje de rotación
        function calcularPorcentajeRotacion(egresosPeriodo) {
            const totalActivos = colaboradoresActivos.length;
            const totalEgresosPeriodo = egresosPeriodo.length;
            
            let porcentaje = 0;
            if (totalActivos + totalEgresosPeriodo > 0) {
                porcentaje = (totalEgresosPeriodo / (totalActivos + totalEgresosPeriodo)) * 100;
            }
            
            return {
                porcentaje: porcentaje.toFixed(2),
                egresos: totalEgresosPeriodo
            };
        }

        // Función para calcular rotación por período personalizado
        function calcularRotacionPersonalizado() {
            const fechaInicio = $('#fecha-inicio-personalizado').val();
            const fechaFin = $('#fecha-fin-personalizado').val();
            
            if (!fechaInicio || !fechaFin) {
                Swal.fire('Error', 'Por favor seleccione ambas fechas.', 'error');
                return;
            }
            
            const egresosPeriodo = colaboradoresEgresos.filter(egreso => {
                const fechaEgreso = new Date(egreso.fechaEgreso);
                const inicio = new Date(fechaInicio);
                const fin = new Date(fechaFin);
                
                return fechaEgreso >= inicio && fechaEgreso <= fin;
            });
            
            mostrarEgresos(egresosPeriodo);
        }

        // Función para mostrar egresos
        function mostrarEgresos(egresos) {
            const tablaEgresos = $('#tabla-egresos tbody');
            tablaEgresos.empty();
            
            if (egresos.length === 0) {
                tablaEgresos.append('<tr><td colspan="6" class="text-center">No hay egresos en el período seleccionado</td></tr>');
                return;
            }
            
            egresos.forEach(egreso => {
                tablaEgresos.append(`
                    <tr>
                        <td>${formatearFecha(egreso.fechaEgreso)}</td>
                        <td>${egreso.nombre}</td>
                        <td>${egreso.identidad}</td>
                        <td>${formatearFecha(egreso.fechaNacimiento)}</td>
                        <td>${egreso.sexo}</td>
                        <td>${egreso.razon}</td>
                    </tr>
                `);
            });
        }

        // Función para filtrar egresos
        function filtrarEgresos() {
            const texto = $('#buscador-egresos').val().toLowerCase();
            $('#tabla-egresos tbody tr').each(function() {
                const nombre = $(this).find('td:eq(1)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto));
            });
        }

        // Función para registrar ausencia
        function registrarAusencia() {
            const fecha = $('#fecha-ausencia').val();
            const diasIncapacidad = parseInt($('#dias-incapacidad').val());
            const colaborador = $('#colaborador-ausencia').val();
            const motivo = $('#motivo-ausencia').val();
            const observaciones = $('#observaciones-ausencia').val();
            
            // Validar campos
            if (!fecha || !diasIncapacidad || !colaborador || !motivo) {
                Swal.fire('Error', 'Por favor complete todos los campos obligatorios.', 'error');
                return;
            }
            
            // Verificar que el colaborador existe en activos
            const colaboradorExiste = colaboradoresActivos.some(col => 
                col.nombre.toLowerCase() === colaborador.toLowerCase()
            );
            
            if (!colaboradorExiste) {
                Swal.fire('Error', 'El colaborador no se encuentra en la lista de activos.', 'error');
                return;
            }
            
            // Validar: Verificar si ya existe una ausencia para esta persona en estas fechas
            const fechaInicio = new Date(fecha);
            const fechaFin = new Date(fechaInicio);
            fechaFin.setDate(fechaFin.getDate() + diasIncapacidad - 1);
            
            const ausenciaExistente = ausencias.some(ausencia => {
                if (ausencia.nombre.toLowerCase() !== colaborador.toLowerCase()) {
                    return false;
                }
                
                const ausenciaInicio = new Date(ausencia.fecha);
                const ausenciaFin = ausencia.fechaFin ? new Date(ausencia.fechaFin) : new Date(ausencia.fecha);
                
                // Verificar superposición de fechas
                return (fechaInicio <= ausenciaFin && fechaFin >= ausenciaInicio);
            });
            
            if (ausenciaExistente) {
                Swal.fire('Error', 'Ya existe una ausencia registrada para esta persona en el período seleccionado.', 'error');
                return;
            }
            
            const fechaFinStr = fechaFin.toISOString().split('T')[0];
            
            // Mostrar confirmación antes de registrar
            Swal.fire({
                title: '¿Está seguro?',
                html: `¿Desea registrar la ausencia para <strong>${colaborador}</strong>?<br>
                      <strong>Fecha:</strong> ${formatearFecha(fecha)}<br>
                      <strong>Días:</strong> ${diasIncapacidad}<br>
                      <strong>Motivo:</strong> ${motivo}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, registrar',
                cancelButtonText: 'No, cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#overlay').show();
                    
                    $.post(SCRIPT_URL_ENVIAR, {
                        accion: 'registrar_ausencia',
                        fecha: fecha,
                        fechaFin: fechaFinStr,
                        diasIncapacidad: diasIncapacidad,
                        colaborador: colaborador,
                        motivo: motivo,
                        observaciones: observaciones
                    }, function(response) {
                        $('#overlay').hide();
                        
                        if (response === 'Éxito') {
                            Swal.fire('Éxito', 'Ausencia registrada correctamente.', 'success').then(() => {
                                // Limpiar formulario pero mantener la fecha actual del sistema
                                $('#form-registrar-ausencia')[0].reset();
                                
                                // Restablecer la fecha actual del sistema
                                const today = new Date();
                                const yyyy = today.getFullYear();
                                const mm = String(today.getMonth() + 1).padStart(2, '0');
                                const dd = String(today.getDate()).padStart(2, '0');
                                const todayStr = yyyy + '-' + mm + '-' + dd;
                                
                                $('#fecha-ausencia').val(todayStr);
                                $('#dias-incapacidad').val(1);
                                
                                // Recargar datos
                                cargarTodosLosDatos();
                            });
                        } else {
                            Swal.fire('Error', 'Hubo un problema al registrar la ausencia: ' + response, 'error');
                        }
                    }).fail(function() {
                        $('#overlay').hide();
                        Swal.fire('Error', 'Error de conexión al registrar la ausencia.', 'error');
                    });
                }
            });
        }

        // Función para mostrar ausencias
        function mostrarAusencias() {
            const tablaAusencias = $('#tabla-ausencias tbody');
            tablaAusencias.empty();
            
            if (ausencias.length === 0) {
                tablaAusencias.append('<tr><td colspan="7" class="text-center">No hay ausencias registradas</td></tr>');
                return;
            }
            
            // Ordenar por fecha (más recientes primero)
            const ausenciasOrdenadas = [...ausencias].reverse();
            
            ausenciasOrdenadas.forEach(ausencia => {
                const fechaFin = ausencia.fechaFin || ausencia.fecha;
                const dias = calcularDiasAusencia(ausencia.fecha, fechaFin);
                
                tablaAusencias.append(`
                    <tr>
                        <td>${formatearFecha(ausencia.fecha)}</td>
                        <td>${formatearFecha(fechaFin)}</td>
                        <td>${ausencia.nombre}</td>
                        <td>${ausencia.identidad}</td>
                        <td>${ausencia.motivo}</td>
                        <td>${dias}</td>
                        <td>${ausencia.observaciones || ''}</td>
                    </tr>
                `);
            });
        }

        // Función para calcular días de ausencia
        function calcularDiasAusencia(fechaInicio, fechaFin) {
            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFin);
            const diferencia = fin.getTime() - inicio.getTime();
            return Math.floor(diferencia / (1000 * 60 * 60 * 24)) + 1;
        }

        // Función para filtrar ausencias
        function filtrarAusencias() {
            const texto = $('#buscador-ausencias').val().toLowerCase();
            $('#tabla-ausencias tbody tr').each(function() {
                const nombre = $(this).find('td:eq(2)').text().toLowerCase();
                const identidad = $(this).find('td:eq(3)').text().toLowerCase();
                const motivo = $(this).find('td:eq(4)').text().toLowerCase();
                
                // Buscar en nombre, identidad y motivo
                $(this).toggle(
                    nombre.includes(texto) || 
                    identidad.includes(texto) || 
                    motivo.includes(texto)
                );
            });
        }

        // Función para calcular estadísticas de ausencias
        function calcularEstadisticasAusencias() {
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const añoActual = hoy.getFullYear();
            
            // Ausencias del mes actual (que se solapan con el mes actual)
            const ausenciasMes = ausencias.filter(ausencia => {
                const fechaInicio = new Date(ausencia.fecha);
                const fechaFin = ausencia.fechaFin ? new Date(ausencia.fechaFin) : new Date(ausencia.fecha);
                
                return (fechaInicio.getMonth() === mesActual && fechaInicio.getFullYear() === añoActual) ||
                       (fechaFin.getMonth() === mesActual && fechaFin.getFullYear() === añoActual) ||
                       (fechaInicio <= new Date(añoActual, mesActual + 1, 0) && fechaFin >= new Date(añoActual, mesActual, 1));
            });
            
            // Total de días de ausencia en el mes
            let totalDiasAusencias = 0;
            
            ausenciasMes.forEach(ausencia => {
                const fechaInicio = new Date(ausencia.fecha);
                const fechaFin = ausencia.fechaFin ? new Date(ausencia.fechaFin) : new Date(ausencia.fecha);
                
                // Calcular días de esta ausencia que caen en el mes actual
                const inicioMes = new Date(añoActual, mesActual, 1);
                const finMes = new Date(añoActual, mesActual + 1, 0);
                
                let diasEnMes = 0;
                for (let d = new Date(fechaInicio); d <= fechaFin; d.setDate(d.getDate() + 1)) {
                    if (d >= inicioMes && d <= finMes) {
                        diasEnMes++;
                    }
                }
                
                totalDiasAusencias += diasEnMes;
            });
            
            // Porcentaje de ausencias del mes
            const totalDiasLaborables = 22;
            const totalPosiblesAusencias = colaboradoresActivos.length * totalDiasLaborables;
            const porcentajeAusencias = totalPosiblesAusencias > 0 ? 
                (totalDiasAusencias / totalPosiblesAusencias * 100).toFixed(2) : 0;
            
            $('#porcentaje-ausencias-mes').text(porcentajeAusencias + '%');
            $('#total-ausencias-mes').text(totalDiasAusencias);
            
            // Actualizar también en el dashboard
            $('#rotacion-general-dashboard').text(totalDiasAusencias);
        }

        // Función para crear gráfico de ausencias
        function crearGraficoAusencias() {
            const ctx = document.getElementById('graficoAusencias').getContext('2d');
            
            // Destruir gráfico anterior si existe
            if (graficoAusencias) {
                graficoAusencias.destroy();
            }
            
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const añoActual = hoy.getFullYear();
            const diasEnMes = new Date(añoActual, mesActual + 1, 0).getDate();
            
            // Preparar datos para el gráfico
            const labels = [];
            const datosAusentes = [];
            
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const fecha = new Date(añoActual, mesActual, dia);
                // Formatear fecha correctamente para comparación
                const fechaStr = fecha.toISOString().split('T')[0];
                labels.push(`${dia}/${mesActual + 1}`);
                
                // Contar ausencias para este día
                const ausenciasDia = ausencias.filter(ausencia => {
                    const fechaInicio = new Date(ausencia.fecha);
                    const fechaFin = ausencia.fechaFin ? new Date(ausencia.fechaFin) : new Date(ausencia.fecha);
                    
                    // Asegurar que las fechas estén en el mismo formato
                    const inicioStr = fechaInicio.toISOString().split('T')[0];
                    const finStr = fechaFin.toISOString().split('T')[0];
                    const diaStr = fecha.toISOString().split('T')[0];
                    
                    // Verificar si este día está dentro del rango de ausencia
                    return diaStr >= inicioStr && diaStr <= finStr;
                }).length;
                
                datosAusentes.push(ausenciasDia);
            }
            
            graficoAusencias = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ausentes',
                            data: datosAusentes,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Ausencias del Mes Actual'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Días del Mes'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cantidad de Ausentes'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Función auxiliar para formatear fechas
        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            
            // Si ya está en formato DD/MM/YYYY, devolverlo tal cual
            if (typeof fechaStr === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(fechaStr)) {
                return fechaStr;
            }
            
            const fecha = new Date(fechaStr + 'T00:00:00'); // Forzar hora media noche UTC
            if (isNaN(fecha.getTime())) return fechaStr;
            
            // Usar métodos getUTC para consistencia
            const dia = String(fecha.getUTCDate()).padStart(2, '0');
            const mes = String(fecha.getUTCMonth() + 1).padStart(2, '0');
            const año = fecha.getUTCFullYear();
            
            return `${dia}/${mes}/${año}`;
        }

        // Función para formatear identidad
        function formatearIdentidad(input) {
            let valor = input.value.replace(/\D/g, '');
            
            if (valor.length > 13) {
                valor = valor.substring(0, 13);
            }
            
            if (valor.length > 8) {
                valor = valor.substring(0, 8) + '-' + valor.substring(8);
            }
            if (valor.length > 4) {
                valor = valor.substring(0, 4) + '-' + valor.substring(4);
            }
            
            input.value = valor;
        }

        // Función para subir foto de colaborador
        function subirFoto(colaborador, archivo, esEdicion = false) {
            return new Promise((resolve, reject) => {
                if (!archivo) {
                    resolve(null);
                    return;
                }
                
                // Validar tipo de archivo
                const tiposPermitidos = ['image/jpeg', 'image/png', 'image/gif'];
                if (!tiposPermitidos.includes(archivo.type)) {
                    reject('Tipo de archivo no permitido. Use JPG, PNG o GIF.');
                    return;
                }
                
                // Validar tamaño (5MB máximo)
                if (archivo.size > 5 * 1024 * 1024) {
                    reject('El archivo es demasiado grande. Máximo 5MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result.split(',')[1];
                    
                    console.log('Subiendo foto para:', colaborador.nombre);
                    
                    $.post(SCRIPT_URL_ENVIAR, {
                        accion: 'subir_foto',
                        colaborador: JSON.stringify(colaborador),
                        archivo: base64,
                        esEdicion: esEdicion
                    }, function(response) {
                        if (response === 'Éxito') {
                            console.log('Foto subida exitosamente');
                            resolve('Éxito');
                        } else {
                            console.error('Error al subir foto:', response);
                            reject('Error al subir foto: ' + response);
                        }
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error('Error de conexión:', textStatus, errorThrown);
                        reject('Error de conexión al subir foto: ' + textStatus);
                    });
                };
                
                reader.onerror = function() {
                    console.error('Error al leer el archivo');
                    reject('Error al leer el archivo');
                };
                
                reader.readAsDataURL(archivo);
            });
        }

        // Función para mostrar foto de colaborador
        function mostrarFoto(colaborador) {
            console.log('Mostrando foto para:', colaborador.nombre);
            
            if (!colaborador.fotoUrl || colaborador.fotoUrl.trim() === '') {
                Swal.fire({
                    title: `Foto de ${colaborador.nombre}`,
                    html: `
                        <div class="text-center">
                            <i class="fas fa-user-circle" style="font-size: 120px; color: #ccc;"></i>
                            <p class="mt-3">No hay foto disponible</p>
                            <p><strong>Identidad:</strong> ${colaborador.identidad}</p>
                        </div>
                    `,
                    confirmButtonText: 'Cerrar',
                    width: '300px'
                });
                return;
            }
            
            let fotoUrl = colaborador.fotoUrl;
            
            // Convertir URL de Drive si es necesario
            if (fotoUrl.includes('drive.google.com')) {
                const match = fotoUrl.match(/[\/?]([a-zA-Z0-9_-]{25,})/);
                if (match && match[1]) {
                    fotoUrl = 'https://lh3.googleusercontent.com/d/' + match[1] + '=s1000';
                }
            }
            
            console.log('URL final de la foto:', fotoUrl);
            
            Swal.fire({
                title: `Foto de ${colaborador.nombre}`,
                html: `
                    <div class="text-center">
                        <img src="${fotoUrl}" 
                             alt="Foto de ${colaborador.nombre}" 
                             style="max-width: 100%; max-height: 500px; border-radius: 10px; border: 2px solid #ddd;"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk2OTY5NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yIGNhcmdhbmRvIGZvdG88L3RleHQ+PC9zdmc+';">
                        <div class="mt-3">
                            <p><strong>Identidad:</strong> ${colaborador.identidad}</p>
                            <p><strong>Nombre:</strong> ${colaborador.nombre}</p>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Cerrar',
                width: '550px'
            });
        }

        // Función para mostrar vista previa de la foto
        function mostrarVistaPreviaFoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Crear o actualizar la vista previa
                    let vistaPrevia = document.getElementById('vista-previa-foto');
                    if (!vistaPrevia) {
                        vistaPrevia = document.createElement('div');
                        vistaPrevia.id = 'vista-previa-foto';
                        vistaPrevia.style.marginTop = '10px';
                        vistaPrevia.style.textAlign = 'center';
                        input.parentNode.appendChild(vistaPrevia);
                    }
                    
                    vistaPrevia.innerHTML = `
                        <div style="border: 2px dashed #ddd; border-radius: 10px; padding: 10px; display: inline-block;">
                            <img src="${e.target.result}" alt="Vista previa" 
                                 style="max-width: 150px; max-height: 150px; border-radius: 5px;">
                            <p style="margin-top: 5px; font-size: 12px; color: #666;">Vista previa</p>
                            <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="quitarVistaPrevia()">
                                <i class="fas fa-times"></i> Quitar
                            </button>
                        </div>
                    `;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Función para mostrar vista previa en edición
        function mostrarVistaPreviaEdicion(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Crear o actualizar la vista previa
                    let vistaPrevia = document.getElementById('vista-previa-foto-editar');
                    if (!vistaPrevia) {
                        vistaPrevia = document.createElement('div');
                        vistaPrevia.id = 'vista-previa-foto-editar';
                        vistaPrevia.style.marginTop = '10px';
                        vistaPrevia.style.textAlign = 'center';
                        input.parentNode.appendChild(vistaPrevia);
                    }
                    
                    vistaPrevia.innerHTML = `
                        <div style="border: 2px dashed #007bff; border-radius: 10px; padding: 10px; display: inline-block; background-color: #f8f9fa;">
                            <p style="margin: 0; font-size: 12px; color: #007bff; font-weight: bold;">Nueva foto seleccionada:</p>
                            <img src="${e.target.result}" alt="Vista previa nueva foto" 
                                 style="max-width: 120px; max-height: 120px; border-radius: 5px; margin-top: 5px;">
                            <p style="margin-top: 5px; font-size: 11px; color: #666;">Reemplazará la foto actual</p>
                            <button type="button" class="btn btn-sm btn-outline-danger mt-1" onclick="quitarVistaPreviaEdicion()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    `;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Función para quitar la vista previa
        function quitarVistaPrevia() {
            const vistaPrevia = document.getElementById('vista-previa-foto');
            const inputFoto = document.getElementById('foto-colaborador');
            
            if (vistaPrevia) {
                vistaPrevia.remove();
            }
            if (inputFoto) {
                inputFoto.value = '';
            }
        }

        // Función para quitar vista previa en edición
        function quitarVistaPreviaEdicion() {
            const vistaPrevia = document.getElementById('vista-previa-foto-editar');
            const inputFoto = document.getElementById('editar-foto');
            
            if (vistaPrevia) {
                vistaPrevia.remove();
            }
            if (inputFoto) {
                inputFoto.value = '';
            }
        }
    </script>
</body>
</html>