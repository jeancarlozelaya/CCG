<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empleados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --warning-color: #f39c12;
        --success-color: #2ecc71;
        --dark-color: #34495e;
        --text-color: #333;
        --border-color: #ddd;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
        --light-yellow: #fff9e6; /* Amarillo claro para ausencias */
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
        color: var(--text-color);
        line-height: 1.6;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        text-align: center;
        padding: 18px 0;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: var(--shadow);
        position: relative;
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 25px;
        font-size: 1.8rem;
        position: relative;
        padding-bottom: 10px;
        font-weight: bold;
    }

    h1:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background-color: var(--secondary-color);
        border-radius: 2px;
    }

    .container {
        max-width: 1200px;
        margin: 25px auto;
        padding: 0 15px;
    }

    .card {
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: none;
        margin-bottom: 25px;
    }

    .card-header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 18px 25px;
        font-weight: 600;
        font-size: 1.1rem;
        position: relative;
        overflow: hidden;
    }

    .card-header:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--secondary-color), var(--accent-color));
    }

    .card-header-warning {
        background: linear-gradient(135deg, var(--warning-color), #f7b733);
    }
    .card-header-danger {
        background: linear-gradient(135deg, var(--accent-color), #c0392b);
    }

    .nav-tabs .nav-link {
        color: var(--dark-color);
        font-weight: 500;
        border: none;
        padding: 12px 20px;
    }

    .nav-tabs .nav-link.active {
        color: var(--secondary-color);
        border-bottom: 3px solid var(--secondary-color);
        background-color: transparent;
    }
    
    .nav-tabs .dropdown-menu {
        margin-top: -1px;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }
    
    .nav-tabs .dropdown-item {
        font-weight: 500;
        color: var(--dark-color);
    }

    .nav-tabs .dropdown-item:active, .nav-tabs .dropdown-item.active {
        color: var(--secondary-color);
        background-color: #f0f8ff;
    }

    .tab-content {
        padding: 25px;
        background-color: white;
        border-radius: 0 0 12px 12px;
    }

    /* Estilo uniforme para todos los títulos de sección */
    .tab-title {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
        padding: 20px 0;
        position: relative;
    }

    .tab-title h2 {
        font-size: 1.5rem; /* Tamaño reducido */
        font-weight: 700;
        margin: 0;
        display: inline-block;
        padding: 0 25px;
        position: relative;
    }

    .tab-title h2:after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        border-radius: 2px;
    }

    .tab-title h2:before {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        right: 0;
        height: 1px;
        background-color: var(--border-color);
    }

    .stat-card {
        text-align: center;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 15px;
        transition: var(--transition);
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-card .icon {
        font-size: 1.8rem;
        margin-bottom: 10px;
    }

    .stat-card h3 {
        font-size: 1.5rem;
        margin-bottom: 5px;
        font-weight: 700;
    }

    .stat-card p {
        color: #7f8c8d;
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .table-responsive {
        border-radius: 8px;
        overflow-x: auto; /* CORRECCIÓN: Permitir scroll horizontal */
    }

    .table th {
        background-color: var(--primary-color);
        color: white;
        border: none;
    }

    .table td {
        vertical-align: middle;
    }
    
    .table td ul {
        padding-left: 18px;
        margin-bottom: 0;
    }

    .btn-action {
        padding: 5px 10px;
        margin: 0 2px;
        font-size: 0.85rem;
    }

    .btn-edit {
        background-color: var(--warning-color);
        border-color: var(--warning-color);
        color: white;
    }

    .btn-delete {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }

    .search-container {
        position: relative;
        margin-bottom: 20px;
    }

    .search-container i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
    }

    .search-container input {
        padding-left: 40px;
    }

    #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        display: none; /* Oculto por defecto */
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(52, 152, 219, 0.2);
        border-radius: 50%;
        border-top-color: var(--secondary-color);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    #loadingMessage {
        text-align: center;
        color: var(--dark-color);
    }

    #loadingMessage h4 {
        margin: 0 0 10px;
        font-size: 1.3rem;
        font-weight: bold;
    }

    #loadingMessage p {
        margin: 0;
        color: #7f8c8d;
        font-weight: normal;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .date-range-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .date-range-container .form-group {
        flex: 1;
        min-width: 200px;
    }

    .autocomplete-container {
        position: relative;
    }

    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .autocomplete-item:hover {
        background-color: #f5f5f5;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .rotacion-periodos {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .periodo-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
    }

    .periodo-card h4 {
        font-size: 1.1rem;
        margin-bottom: 10px;
    }

    .periodo-card .porcentaje {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .periodo-card .detalle {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .ausencias-stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 25px;
    }

    /* CORRECCIÓN: Estilos para botones principales (SOLO en formularios) */
    #form-registrar-colaborador .btn-primary, #form-registrar-colaborador .btn-success,
    #form-registrar-ausencia .btn-primary, #form-registrar-ausencia .btn-success,
    #form-registrar-incidente .btn-primary, #form-registrar-incidente .btn-success {
        border: none;
        font-weight: 600;
        padding: 12px 30px;
        font-size: 1rem;
        border-radius: 50px;
        min-width: 150px; /* Reducido para móviles */
        transition: var(--transition);
        color: white !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        flex-grow: 1;
    }

    .btn-primary {
        background: linear-gradient(45deg, var(--secondary-color), #5dade2);
    }

    .btn-success {
        background: linear-gradient(45deg, #2ecc71, #58d68d);
    }

    #form-registrar-colaborador .btn-primary:hover, #form-registrar-colaborador .btn-success:hover,
    #form-registrar-ausencia .btn-primary:hover, #form-registrar-ausencia .btn-success:hover,
    #form-registrar-incidente .btn-primary:hover, #form-registrar-incidente .btn-success:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    #btn-agregar-colaborador, #btn-agregar-ausencia {
        min-width: 150px;
    }
    
    .btn-historial {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        color: white;
    }

/* --- INICIO ESTILOS CUMPLEAÑEROS MEJORADOS --- */
.cumpleanero-card {
    background: linear-gradient(145deg, #ffffff, #f7f9fc); /* Fondo blanco con sutil gradiente */
    border-radius: 15px;
    box-shadow: 0 8px 15px rgba(44, 62, 80, 0.08); /* Sombra más suave */
    padding: 25px 20px; /* Más padding */
    text-align: center;
    transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); /* Transición más suave */
    border: 1px solid #e8eef3; /* Borde sutil */
    position: relative; /* Para posibles elementos decorativos */
    overflow: hidden; /* Para elementos decorativos */
    height: 100%; /* Asegura altura uniforme en la fila */
}

/* Efecto hover mejorado */
.cumpleanero-card:hover {
    transform: translateY(-10px) scale(1.02); /* Levanta y agranda un poco */
    box-shadow: 0 15px 25px rgba(52, 152, 219, 0.15); /* Sombra azulada */
    border-color: var(--secondary-color);
}

/* Contenedor de imagen */
.cumpleanero-img-container {
    width: 100px; /* Ligeramente más pequeño */
    height: 100px;
    border-radius: 50%;
    margin: 0 auto 20px auto; /* Más margen inferior */
    border: 4px solid var(--secondary-color); /* Borde azul */
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #f0f0f0;
    overflow: hidden;
    position: relative; /* Para el icono de cámara si no hay foto */
}

/* Imagen */
.cumpleanero-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Icono si no hay foto */
.cumpleanero-img-icon {
    font-size: 50px;
    color: #bdc3c7; /* Gris más claro */
}

/* Información */
.cumpleanero-info h5 {
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 8px; /* Más espacio */
    font-size: 1.1rem;
    /* Permitir seleccionar */
    -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text;
}

/* Fecha (párrafo) */
.cumpleanero-info p {
    color: var(--secondary-color); /* Color azul */
    font-weight: 600; /* Más grueso */
    margin-bottom: 0;
    font-size: 0.95rem; /* Ligeramente más grande */
}

/* Icono de pastel junto a la fecha */
.cumpleanero-info .fa-birthday-cake {
    margin-right: 5px; /* Espacio antes de la fecha */
    color: var(--warning-color); /* Color naranja/amarillo */
}
/* --- FIN ESTILOS CUMPLEAÑEROS MEJORADOS --- */


    .resumen-disciplina-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s ease;
    }
    .resumen-disciplina-item:hover {
        background-color: #f5f5f5;
    }
    .resumen-disciplina-item:last-child {
        border-bottom: none;
    }
    .resumen-disciplina-img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 15px;
        object-fit: cover;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .resumen-disciplina-info {
        flex-grow: 1;
    }
    .resumen-disciplina-info h6 {
        margin-bottom: 2px;
        font-weight: bold;
    }
    
    #contenedor-vencimientos .resumen-disciplina-item:hover,
    #contenedor-contratos-vencidos .resumen-disciplina-item:hover {
        cursor: pointer;
    }

/* Estilos Planilla */

    /* Limita la altura de la tabla planilla para activar el encabezado pegajoso */
    #planilla .table-responsive {
        max-height: 70vh; /* 70% de la altura de la ventana */
        overflow-y: auto;
    }

    #tabla-planilla {
        white-space: nowrap;
    }
    #tabla-planilla th, #tabla-planilla td {
        text-align: center;
        vertical-align: middle;
        min-width: 50px;
        padding: 0.5rem 0.25rem;
    }
    
    /* --- INICIA EL CÓDIGO CORREGIDO --- */

    /* 1. Columna de Nombres (Cuerpo) - VISIBLE y Fija */
    #tabla-planilla td:first-child {
        text-align: left;
        min-width: 200px;
        position: sticky;
        left: 0;
        background-color: white; /* Vuelve a ser blanco */
        z-index: 2; 
        border-right: 2px solid var(--border-color); /* Vuelve el borde */
        /* Se quita color: transparent y user-select: none */
    }

    /* 2. Fondo para TODAS las celdas del encabezado (MENOS la primera columna) */
    #tabla-planilla thead th {
        background-color: var(--primary-color);
        color: white;
    }

    /* 3. Fila 1 (Días) - Fija arriba */
    #tabla-planilla thead tr:first-child th {
        position: sticky;
        top: 0;
        z-index: 1; 
    }
    
    /* 4. Celda A2 (Segunda fila, primera celda) - Fija, pero TRANSPARENTE */
    #tabla-planilla thead tr:nth-child(2) th:first-child {
        position: sticky;
        left: 0;
        z-index: 2; 
        min-width: 200px;
        text-align: left;
        background-color: transparent !important; /* Transparente */
        color: transparent;                      /* Oculta el texto */
        border-right: none;                      /* Sin borde */
        user-select: none;
    }

    /* 5. Celda A1 (Esquina superior) - Fija, pero TRANSPARENTE */
    #tabla-planilla thead tr:first-child th:first-child {
        left: 0; 
        z-index: 3; /* Encima de todo */
        min-width: 200px;
        text-align: left;
        background-color: transparent !important; /* Transparente */
        color: transparent;                      /* Oculta el texto */
        border-right: none;                      /* Sin borde */
        user-select: none;
    }
    
    /* --- TERMINA EL CÓDIGO CORREGIDO --- */


    #tabla-planilla td.asistencia { 
        color: white; 
        background-color: var(--success-color); 
        font-weight: bold; 
    }
    #tabla-planilla td.incapacidad,
    #tabla-planilla td.falta,
    #tabla-planilla td.permiso,
    #tabla-planilla td.nuevo-ingreso {
        background-color: var(--light-yellow); 
        color: #665200; 
        font-weight: bold; 
    }
    #tabla-planilla td.egreso-cell {
        background-color: var(--light-yellow);
        color: #333;
        font-style: italic;
        font-size: 0.9em;
        text-align: center;
    }
    
    .planilla-simbologia {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        font-size: 0.9rem;
    }
    .planilla-simbologia span {
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
    }
    .simb-asistencia { background-color: var(--success-color); color: white; }
    .simb-ausencia { background-color: var(--light-yellow); color: #665200; border: 1px solid #ffeeba; }
    .simb-egreso { background-color: var(--light-yellow); color: #333; border: 1px solid #ffeeba; }


    @media (max-width: 768px) {
        .dashboard-grid { 
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
        }
        .rotacion-periodos { 
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
        }
        .ausencias-stats {
            grid-template-columns: 1fr;
        }
        .date-range-container {
            flex-direction: column;
        }
        .date-range-container .form-group {
            min-width: 100%;
        }
        .date-range-container .btn {
            width: 100%;
        }
        .tab-title h2 {
            font-size: 1.3rem;
            padding: 0 18px;
        }
        .nav-tabs {
             flex-wrap: wrap; /* CORRECCIÓN: Permitir que las pestañas pasen a la siguiente línea */
        }
    }

    @media (max-width: 576px) {
        h1 {
            font-size: 1.5rem;
        }
        .nav-tabs .nav-link {
            padding: 10px 15px;
            font-size: 0.9rem;
        }
        .tab-content {
            padding: 15px;
        }
        .tab-title h2 {
            font-size: 1.2rem;
            padding: 0 15px;
        }
        /* CORRECCIÓN: Botones de formulario en una fila */
/* Regla 1 (MODIFICADA) */
    #form-registrar-colaborador .d-flex, #form-registrar-ausencia .d-flex, #form-registrar-incidente .d-flex { /* <-- Añadido #form-registrar-incidente */
        flex-direction: row;
    }
    /* Regla 2 (MODIFICADA) */
    #form-registrar-colaborador .btn, #form-registrar-ausencia .btn, #form-registrar-incidente .btn { /* <-- Añadido #form-registrar-incidente */
        min-width: 0;
        flex-grow: 1; /* Permite que los botones compartan el espacio */
        font-size: 0.9rem;
        padding: 10px 5px;
    }
        #btn-agregar-colaborador, #btn-agregar-ausencia {
            min-width: 0;
        }
    }
 
    .btn-photo {
        background-color: #17a2b8;
        border-color: #17a2b8;
        color: white;
    }
    
    .btn-reingreso {
        background-color: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }
    
    .btn-historial {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
        color: white;
    }

    .btn-action {
        padding: 5px 10px;
        margin: 0 2px;
        font-size: 0.85rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 8px;
    }

    #tabla-colaboradores-egresados tr {
        cursor: default; /* Quitado el cursor pointer de la fila */
    }

    .table-hover tbody tr:not(.no-hover):hover {
        background-color: rgba(52, 152, 219, 0.05);
        transform: scale(1.01);
        transition: var(--transition);
        cursor: pointer;
    }
    
    .formulario-item {
        border: 1px solid var(--border-color);
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        position: relative;
        background-color: #fdfdfd;
    }

    .btn-quitar-item {
        position: absolute;
        top: 10px;
        right: 10px;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .evaluacion-detalle-item {
        background-color: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 0 8px 8px 0;
    }
    .evaluacion-detalle-item h6 {
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 10px;
    }
     .evaluacion-detalle-item p {
        margin-bottom: 8px;
        font-size: 0.9rem;
     }
     .evaluacion-detalle-item p strong {
        color: var(--dark-color);
     }
     .evaluacion-detalle-item .no-info {
        font-style: italic;
        color: #7f8c8d;
     }





.btn-refresh-tab {
    position: absolute;
    top: 15px; /* Ajusta según el padding de .tab-title */
    right: 15px; /* Ajusta según el padding */
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    line-height: 1; /* Asegura que el ícono esté centrado */
    font-size: 0.9rem;
    border-color: var(--secondary-color);
    color: var(--secondary-color);
}

.btn-refresh-tab:hover {
    background-color: var(--secondary-color);
    color: white;
}

/* Ajuste para móviles */
@media (max-width: 576px) {
    .btn-refresh-tab {
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
    }
}


/* Permitir la selección de texto dentro de las tablas */
.table td, .table th {
    -webkit-user-select: text; /* Para Safari */
    -moz-user-select: text;    /* Para Firefox */
    -ms-user-select: text;     /* Para Internet Explorer/Edge */
    user-select: text;         /* Estándar */
}


/* Estilo para filas con información pendiente (ej. sin foto) */
.fila-incompleta td {
    /* !important es necesario para anular los colores de .table-striped */
    background-color: #f8d7da !important; 
    color: #721c24 !important; 
}



/* Estilos para la vista de miniaturas (Grid) */
#grid-activos {
    /* El display: none; inicial está en el HTML */
}

.empleado-card-mini {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    background-color: #fff;
    transition: var(--transition);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    display: flex; /* Usar flexbox para alinear contenido */
    flex-direction: column; /* Apilar elementos verticalmente */
    height: 100%; /* Asegurar que todas las tarjetas tengan la misma altura */
}

.empleado-card-mini:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
}

.empleado-card-mini .img-container {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    margin: 0 auto 10px auto;
    overflow: hidden;
    background-color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0; /* Evitar que se encoja */
}

.empleado-card-mini img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.empleado-card-mini .img-container i {
    font-size: 40px;
    color: #ccc;
}

.empleado-card-mini h6 {
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 3px;
    word-wrap: break-word; /* Evitar que nombres largos se desborden */
    flex-grow: 1; /* Empuja los botones hacia abajo */
    /* Permitir seleccionar el nombre */
    -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text;
}

.empleado-card-mini p {
    font-size: 0.8rem;
    color: #7f8c8d;
    margin-bottom: 10px;
    /* Permitir seleccionar la identidad */
     -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text;
}
/* Contenedor para los botones de acción */
.empleado-card-mini .actions {
    margin-top: auto; /* Empuja los botones al final de la tarjeta */
    padding-top: 10px; /* Espacio sobre los botones */
    border-top: 1px solid #eee; /* Línea separadora */
}
/* Ajustar tamaño y margen de botones en la tarjeta */
.empleado-card-mini .btn-action {
    padding: 3px 7px;
    font-size: 0.75rem;
    margin: 2px 1px;
}


/* ... (Estilos de planilla-simbologia) ... */
    .simb-egreso { background-color: var(--light-yellow); color: #333; border: 1px solid #ffeeba; }

    /* --- INICIO: NUEVO CSS PARA SIMBOLOGÍA INCIDENTES --- */
    .incidentes-simbologia {
        display: flex;
        flex-wrap: wrap;
        gap: 10px; /* Reducido para más items */
        justify-content: center;
        font-size: 0.85rem; /* Ligeramente más pequeño */
        margin-bottom: 25px; /* Espacio antes de los gráficos */
    }
    .incidentes-simbologia span {
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: bold;
        color: white; /* Texto blanco para todos */
    }
    .simb-fat { background-color: #e74c3c; } /* Rojo */
    .simb-lwc { background-color: #e67e22; } /* Naranja Oscuro */
    .simb-mtc { background-color: #f39c12; } /* Naranja/Amarillo */
    .simb-fac { background-color: #3498db; } /* Azul */
    .simb-nm { background-color: #2ecc71;  } /* Verde */
    /* --- FIN: NUEVO CSS --- */




/* --- INICIO: NUEVO CSS PARA MAPA CORPORAL --- */
#body-map-container {
    position: relative;
    max-width: 300px; /* Ancho máximo del mapa */
    min-height: 450px; /* Altura para que quepa la imagen */
    margin: 0 auto; /* Centrar el mapa */
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: #f8f9fa;
}

.body-map-image {
    width: 100%;
    height: auto;
    display: block;
    opacity: 0.5; /* Hacemos la imagen de fondo un poco tenue */
}

/* Estilo base para un "hotspot" (punto de calor) */
.hotspot {
    position: absolute;
    width: 30px;
    height: 30px;
    background-color: rgba(231, 76, 60, 0.8); /* Rojo con opacidad */
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    
    /* Ocultos por defecto, se mostrarán con JS */
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.hotspot.active {
    opacity: 1;
    transform: scale(1);
}

/* Posiciones (ajustadas a una imagen de diagrama estándar) */
#hotspot-cabeza { top: 7%; left: 42%; }
#hotspot-ojos { top: 10%; left: 42%; } /* Cerca de cabeza */
#hotspot-torso { top: 30%; left: 42%; }
#hotspot-brazo-izquierdo { top: 28%; left: 20%; }
#hotspot-brazo-derecho { top: 28%; left: 65%; }
#hotspot-mano-izquierda { top: 45%; left: 10%; }
#hotspot-mano-derecha { top: 45%; left: 75%; }
#hotspot-pierna-izquierda { top: 60%; left: 30%; }
#hotspot-pierna-derecha { top: 60%; left: 55%; }
#hotspot-pie-izquierdo { top: 85%; left: 25%; }
#hotspot-pie-derecho { top: 85%; left: 60%; }
#hotspot-otro { top: 5%; left: 5%; width: auto; padding: 0 5px; border-radius: 5px; }

/* --- FIN: NUEVO CSS PARA MAPA CORPORAL --- */




</style>
</head>
<body>
    <div id="main-content" style="display: none;">
        <div class="header">Pisos Brillantes</div>
        <div class="container">
            <h1>Gestión de Empleados</h1>

            <div class="card">
                <div class="card-body p-0">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
                                <i class="fas fa-home me-2"></i>Dashboard
                            </button>
                        </li>

                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
                                <i class="fas fa-users me-2"></i>Colaboradores
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" id="registrar-tab-dd" data-bs-toggle="tab" href="#registrar" role="tab" aria-controls="registrar"><i class="fas fa-user-plus me-2"></i>Registrar Colaborador</a></li>
                                <li><a class="dropdown-item" id="activos-tab-dd" data-bs-toggle="tab" href="#activos" role="tab" aria-controls="activos"><i class="fas fa-address-book me-2"></i>Personal Activo</a></li>
                                <li><a class="dropdown-item" id="planilla-tab-dd" data-bs-toggle="tab" href="#planilla" role="tab" aria-controls="planilla"><i class="fas fa-calendar-alt me-2"></i>Planilla Quincenal</a></li>



                                <li><a class="dropdown-item" id="vencimientos-tab-dd" data-bs-toggle="tab" href="#vencimientos" role="tab" aria-controls="vencimientos"><i class="fas fa-file-signature me-2"></i>Vencimiento de Contratos</a></li>
                                <li><a class="dropdown-item" id="egresados-tab-dd" data-bs-toggle="tab" href="#egresados" role="tab" aria-controls="egresados"><i class="fas fa-user-slash me-2"></i>Colaboradores Egresados</a></li>
                                <li><a class="dropdown-item" id="rotacion-tab-dd" data-bs-toggle="tab" href="#rotacion" role="tab" aria-controls="rotacion"><i class="fas fa-chart-line me-2"></i>Tasa de Rotación</a></li>

                            </ul>
                        </li>
                        
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
                                <i class="fas fa-clock me-2"></i>Ausentismo
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" id="registrar-ausencia-tab-dd" data-bs-toggle="tab" href="#registrar-ausencia" role="tab" aria-controls="registrar-ausencia"><i class="fas fa-user-clock me-2"></i>Registrar Ausencia</a></li>
                                <li><a class="dropdown-item" id="ausencias-tab-dd" data-bs-toggle="tab" href="#ausencias" role="tab" aria-controls="ausencias"><i class="fas fa-history me-2"></i>Historial de Ausencias</a></li>
                            </ul>
                        </li>

                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
                                <i class="fas fa-clipboard-check me-2"></i>Desempeño
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" id="disciplina-tab-dd" data-bs-toggle="tab" href="#disciplina" role="tab" aria-controls="disciplina"><i class="fas fa-gavel me-2"></i>Historial de Disciplina</a></li>
                                <li><a class="dropdown-item" id="evaluaciones-tab-dd" data-bs-toggle="tab" href="#evaluaciones" role="tab" aria-controls="evaluaciones"><i class="fas fa-chart-bar me-2"></i>Historial de Evaluaciones</a></li>
                            </ul>
                        </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
                            <i class="fas fa-exclamation-triangle me-2"></i>Incidentes
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" id="registrar-incidente-tab-dd" data-bs-toggle="tab" href="#registrar-incidente" role="tab" aria-controls="registrar-incidente"><i class="fas fa-edit me-2"></i>Registrar Incidente</a></li>
                            <li><a class="dropdown-item" id="historial-incidentes-tab-dd" data-bs-toggle="tab" href="#historial-incidentes" role="tab" aria-controls="historial-incidentes"><i class="fas fa-history me-2"></i>Historial de Incidentes</a></li>
                        </ul>
                    </li>
                    <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cumpleaneros-tab" data-bs-toggle="tab" data-bs-target="#cumpleaneros" type="button" role="tab" aria-controls="cumpleaneros" aria-selected="false">
                                <i class="fas fa-birthday-cake me-2"></i>Cumpleañeros
                            </button>
                        </li>

                    </ul>
                    
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                            <div class="tab-title">
                                <h2>Resumen de Colaboradores</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>


                            </div>
                            
                            <div class="dashboard-grid">
                                <div class="stat-card" style="background-color: #e8f4fd;">
                                    <div class="icon text-primary">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <h3 id="total-activos">0</h3>
                                    <p>Total de Activos</p>
                                </div>

                                <div class="stat-card" style="background-color: #f4ecf7;">
                                    <div class="icon text-info">
                                        <i class="fas fa-user-clock"></i>
                                    </div>
                                    <h3 id="ausencias-hoy">0</h3>
                                    <p>Ausencias Hoy</p>
                                </div>
                                
                                <div class="stat-card" style="background-color: #e8f8f5;">
                                    <div class="icon text-success">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <h3 id="presentes-hoy">0</h3>
                                    <p>Presentes Hoy</p>
                                </div>

                                <div class="stat-card" style="background-color: #e8f6f3;">
                                    <div class="icon text-success">
                                        <i class="fas fa-male"></i>
                                    </div>
                                    <h3 id="total-hombres">0</h3>
                                    <p>Hombres</p>
                                </div>
                                
                                <div class="stat-card" style="background-color: #fdedec;">
                                    <div class="icon text-danger">
                                        <i class="fas fa-female"></i>
                                    </div>
                                    <h3 id="total-mujeres">0</h3>
                                    <p>Mujeres</p>
                                </div>
                                
                                <div class="stat-card" style="background-color: #fef9e7;">
                                    <div class="icon text-warning">
                                        <i class="fas fa-birthday-cake"></i>
                                    </div>
                                    <h3 id="edad-promedio">0</h3>
                                    <p>Edad Promedio</p>
                                </div>
                                
                                <div class="stat-card" style="background-color: #fff3cd;">
                                    <div class="icon text-warning">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <h3 id="rotacion-mes-dashboard">0%</h3>
                                    <p>Rotación del Mes</p>
                                </div>

                                <div class="stat-card" style="background-color: #d1ecf1;">
                                    <div class="icon text-info">
                                        <i class="fas fa-calendar-day"></i>
                                    </div>
                                    <h3 id="ausentismo-mes-dashboard">0%</h3>
                                    <p>% Ausentismo del Mes</p>
                                </div>

                                <div class="stat-card" style="background-color: #f8d7da;">
                                    <div class="icon text-danger">
                                        <i class="fas fa-gavel"></i>
                                    </div>
                                    <h3 id="disciplina-mes-dashboard">0%</h3>
                                    <p>% Acciones Disciplinarias (Mes)</p>
                                </div>

                                <div class="stat-card" style="background-color: #d4edda;">
                                    <div class="icon text-success">
                                        <i class="fas fa-clipboard-check"></i>
                                    </div>
                                    <h3 id="evaluacion-mes-dashboard">0%</h3>
                                    <p>% Aprobación Evaluaciones (Mes)</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    Últimos 5 Ingresos Registrados
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="tabla-ultimos-ingresos">
                                            <thead>
                                                <tr>
                                                    <th>Fecha</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Fecha Nacimiento</th>
                                                    <th>Sexo</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    Últimos 5 Egresos Registrados
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="tabla-ultimos-egresos">
                                            <thead>
                                                <tr>
                                                    <th>Fecha Egreso</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Razón</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="registrar" role="tabpanel" aria-labelledby="registrar-tab-dd">
                            <div class="tab-title">
                                <h2>Registrar Nuevo Colaborador</h2>
                            </div>
                            
                            <form id="form-registrar-colaborador">
                                <div id="contenedor-formularios-colaborador">
                                    <div class="formulario-item">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="fecha-inicio" class="form-label">Fecha de Inicio</label>
                                                <input type="date" class="form-control fecha-inicio" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="nombre-completo" class="form-label">Nombre Completo</label>
                                                <input type="text" class="form-control nombre-completo" required>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="identidad" class="form-label">Identidad</label>
                                                <input type="text" class="form-control identidad" placeholder="0000-0000-00000" pattern="\d{4}-\d{4}-\d{5}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="fecha-nacimiento" class="form-label">Fecha de Nacimiento (Opcional)</label>
                                                <input type="date" class="form-control fecha-nacimiento">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="sexo" class="form-label">Sexo</label>
                                                <select class="form-select sexo" required>
                                                    <option value="">Seleccionar...</option>
                                                    <option value="Masculino">Masculino</option>
                                                    <option value="Femenino">Femenino</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="row align-items-center">
                                                    <div class="col-md-7">
                                                        <label for="foto-colaborador" class="form-label">Foto (opcional)</label>
                                                        <input type="file" class="form-control foto-colaborador" accept="image/*" onchange="mostrarVistaPreviaFoto(this)" capture="environment">
                                                        <div class="form-text">JPG, PNG. Máx 5MB</div>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <div class="vista-previa-container mt-2 mt-md-0 text-center"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-center gap-2 mt-4">
                                    <button type="button" class="btn btn-success" id="btn-agregar-colaborador"><i class="fas fa-plus me-2"></i>Agregar</button>
                                    <button type="button" class="btn btn-primary" id="btn-registrar-colaborador">Registrar Colaboradores</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="tab-pane fade" id="activos" role="tabpanel" aria-labelledby="activos-tab-dd">
                            <div class="tab-title">
                                <h2>Personal Activo</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>

                            </div>
                            
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" id="buscador-activos" placeholder="Buscar por nombre o identidad...">
                            </div>
                            
<div class="d-flex justify-content-end mb-3">
    <div class="btn-group" role="group" aria-label="Cambiar vista">
        <button type="button" class="btn btn-outline-primary active btn-vista" data-vista="tabla" title="Vista de Tabla">
            <i class="fas fa-list"></i>
        </button>
        <button type="button" class="btn btn-outline-primary btn-vista" data-vista="grid" title="Vista de Miniaturas">
            <i class="fas fa-th-large"></i>
        </button>
    </div>
</div>



                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tabla-activos">
                                    <thead>
                                        <tr>
                                            <th>Fecha Inicio</th>
                                            <th>Nombre</th>
                                            <th>Identidad</th>
                                            <th>Fecha Nacimiento</th>
                                            <th>Sexo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody class="no-hover">
                                    </tbody>
                                </table>
                            </div>
<div id="grid-activos" class="row g-3" style="display: none;">
    </div>



                        </div>

                        <div class="tab-pane fade" id="vencimientos" role="tabpanel" aria-labelledby="vencimientos-tab-dd">
                             <div class="tab-title">
                                <h2>Vencimiento de Contratos</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>

                            </div>
                            <p class="text-center text-muted mb-4">A continuación se muestran los contratos activos por vencer o ya vencidos.</p>
                            
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" id="buscador-vencimientos" placeholder="Buscar por nombre o identidad...">
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header card-header-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Contratos por Vencer (Próximos 30 días)
                                </div>
                                <div id="contenedor-vencimientos" class="card-body">
                                    </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header card-header-danger">
                                    <i class="fas fa-exclamation-circle me-2"></i>Contratos Vencidos (Requieren Acción)
                                </div>
                                <div id="contenedor-contratos-vencidos" class="card-body">
                                    </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="rotacion" role="tabpanel" aria-labelledby="rotacion-tab-dd">
                            <div class="tab-title">
                                <h2>Tasa de Rotación</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>

                            </div>
                            
                            <div class="rotacion-periodos">
                                <div class="periodo-card">
                                    <h4>Rotación General</h4>
                                    <div class="porcentaje" id="rotacion-general">0%</div>
                                    <div class="detalle" id="detalle-general">0 egresos</div>
                                </div>
                                <div class="periodo-card">
                                    <h4>Rotación del Mes</h4>
                                    <div class="porcentaje" id="rotacion-mes">0%</div>
                                    <div class="detalle" id="detalle-mes">0 egresos</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h4>Últimos 3 Meses</h4>
                                    <div class="porcentaje" id="rotacion-3meses">0%</div>
                                    <div class="detalle" id="detalle-3meses">0 egresos</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <h4>Últimos 6 Meses</h4>
                                    <div class="porcentaje" id="rotacion-6meses">0%</div>
                                    <div class="detalle" id="detalle-6meses">0 egresos</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <h4>Últimos 12 Meses</h4>
                                    <div class="porcentaje" id="rotacion-12meses">0%</div>
                                    <div class="detalle" id="detalle-12meses">0 egresos</div>
                                </div>
                            </div>
                            
                             <div class="card mb-4">
                                <div class="card-header">Egresos por Mes</div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-ano-rotacion" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-rotacion-grafico" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="graficoRotacionAnual"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    Motivos de Egreso
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-mes-egresos" class="form-select" style="width: auto;"></select>
                                        <select id="filtro-ano-egresos" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-egresos" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoEgresosMotivoActual"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoEgresosMotivoHistorico"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4" id="contenedorGraficoFiltradoEgresos" style="display: none;">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoEgresosMotivoFiltrado"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    Historial de Egresos
                                </div>
                                <div class="card-body">
                                    <div class="date-range-container">
                                        <div class="form-group">
                                            <label for="fecha-inicio-personalizado" class="form-label">Filtrar desde</label>
                                            <input type="date" class="form-control" id="fecha-inicio-personalizado">
                                        </div>
                                        <div class="form-group">
                                            <label for="fecha-fin-personalizado" class="form-label">Filtrar hasta</label>
                                            <input type="date" class="form-control" id="fecha-fin-personalizado">
                                        </div>
                                        <div class="form-group d-flex align-items-end">
                                            <button type="button" class="btn btn-primary btn-sm" id="btn-calcular-rotacion-personalizado">Filtrar</button>
                                        </div>
                                    </div>
                                    
                                    <div class="search-container mt-4">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control" id="buscador-egresos" placeholder="Buscar por nombre, identidad o motivo...">
                                    </div>
                                    
                                    <div class="table-responsive mt-3">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Fecha Egreso</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Razón</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla-egresos" class="no-hover">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="egresados" role="tabpanel" aria-labelledby="egresados-tab-dd">
                             <div class="tab-title">
                                <h2>Colaboradores Egresados</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>

                            </div>
                            <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" id="buscador-egresados-tabla" placeholder="Buscar por nombre o identidad...">
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Fecha Egreso</th>
                                            <th>Nombre</th>
                                            <th>Identidad</th>
                                            <th>Razón</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-colaboradores-egresados" class="no-hover">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="planilla" role="tabpanel" aria-labelledby="planilla-tab-dd">
                            <div class="tab-title">
                                <h2>Planilla Quincenal</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>


                            </div>
                            
                            <div class="row justify-content-center mb-3">
                                <div class="col-md-4">
                                    <label for="planilla-date-picker" class="form-label">Seleccionar Fecha para Quincena:</label>
                                    <input type="date" class="form-control" id="planilla-date-picker">
                                </div>
                            </div>
                            
                             <div class="search-container">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" id="buscador-planilla" placeholder="Buscar por nombre...">
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="tabla-planilla">
                                    <thead class="table-primary">
                                        </thead>
                                    <tbody>
                                        </tbody>
                                </table>
                            </div>
                            
                            <div id="planilla-simbologia" class="mt-4">
                                </div>
                        </div>
                        
                        <div class="tab-pane fade" id="registrar-ausencia" role="tabpanel" aria-labelledby="registrar-ausencia-tab-dd">
                            <div class="tab-title">
                                <h2>Registrar Nueva Ausencia</h2>
                            </div>
                             <div class="card mb-4">
                                <div class="card-body">
                                    <form id="form-registrar-ausencia">
                                        <div id="contenedor-formularios-ausencia">
                                            <div class="formulario-item">
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Fecha de Ausencia</label>
                                                        <input type="date" class="form-control fecha-ausencia" required>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Días de Ausencia</label>
                                                        <input type="number" class="form-control dias-incapacidad" value="1" min="1" required>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label class="form-label">Colaborador</label>
                                                        <div class="autocomplete-container">
                                                            <input type="text" class="form-control colaborador-ausencia" placeholder="Escriba el nombre..." required>
                                                            <div class="autocomplete-list"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Motivo</label>
                                                        <select class="form-select motivo-ausencia" required>
                                                            <option value="">Seleccionar...</option>
                                                            <option value="Incapacidad">Incapacidad</option>
                                                            <option value="Permiso">Permiso</option>
                                                            <option value="Falta Injustificada">Falta Injustificada</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Observaciones</label>
                                                        <textarea class="form-control observaciones-ausencia" rows="1"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex flex-wrap justify-content-center gap-2 mt-4">
                                            <button type="button" class="btn btn-success" id="btn-agregar-ausencia"><i class="fas fa-plus me-2"></i>Agregar</button>
                                            <button type="button" class="btn btn-primary" id="btn-registrar-ausencia">Registrar Ausencias</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="ausencias" role="tabpanel" aria-labelledby="ausencias-tab-dd">
                            <div class="tab-title">
                                <h2>Historial de Ausencias</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>

                            </div>
                            
                            <div class="rotacion-periodos">
                                <div class="periodo-card">
                                    <h4>Ausentismo Histórico</h4>
                                    <div class="porcentaje" id="ausentismo-historico">0%</div>
                                </div>
                                <div class="periodo-card">
                                    <h4>Ausentismo del Mes</h4>
                                    <div class="porcentaje" id="ausentismo-mes">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h4>Últimos 3 Meses</h4>
                                    <div class="porcentaje" id="ausentismo-3meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <h4>Últimos 6 Meses</h4>
                                    <div class="porcentaje" id="ausentismo-6meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <h4>Últimos 12 Meses</h4>
                                    <div class="porcentaje" id="ausentismo-12meses">0%</div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    Ausencias por Día
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-mes-grafico" class="form-select" style="width: auto;"></select>
                                        <select id="filtro-ano-grafico" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-grafico" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="graficoAusencias"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    Distribución de Ausencias por Motivo
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoAusenciasMotivoActual"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoAusenciasMotivoHistorico"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4" id="contenedorGraficoFiltradoAusencias" style="display: none;">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoAusenciasMotivoFiltrado"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                                    
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Historial de Ausencias</span>
                                    <button class="btn btn-primary btn-sm" id="btn-resumen-ausencias">
                                        <i class="fas fa-user-clock me-2"></i>Ver Resumen por Colaborador
                                    </button>
                                </div>
                                <div class="card-body">

<div class="date-range-container">
    <div class="form-group">
        <label for="fecha-inicio-ausencias" class="form-label">Filtrar desde</label>
        <input type="date" class="form-control" id="fecha-inicio-ausencias">
    </div>
    <div class="form-group">
        <label for="fecha-fin-ausencias" class="form-label">Filtrar hasta</label>
        <input type="date" class="form-control" id="fecha-fin-ausencias">
    </div>
    <div class="form-group d-flex align-items-end">
        <button type="button" class="btn btn-primary btn-sm" id="btn-filtrar-ausencias-personalizado">Filtrar</button>
    </div>
</div>




                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control" id="buscador-ausencias" placeholder="Buscar por nombre, identidad, motivo...">
                                    </div>
                                    
                                    <div class="table-responsive mt-3">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Fecha Inicio</th>
                                                    <th>Fecha Fin</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Motivo</th>
                                                    <th>Días</th>
                                                    <th>Observaciones</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla-ausencias" class="no-hover">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="disciplina" role="tabpanel" aria-labelledby="disciplina-tab-dd">
                            <div class="tab-title">
                                <h2>Historial de Disciplina</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>


                            </div>
                            
                            <div class="rotacion-periodos">
                                <div class="periodo-card">
                                    <h4>% de Acciones Disciplinarias Histórico</h4>
                                    <div class="porcentaje" id="disciplina-historico">0%</div>
                                </div>
                                <div class="periodo-card">
                                    <h4>% de Acciones Disciplinarias del Mes</h4>
                                    <div class="porcentaje" id="disciplina-mes">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h4>% de Acciones Disciplinarias 3 Meses</h4>
                                    <div class="porcentaje" id="disciplina-3meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <h4>% de Acciones Disciplinarias 6 Meses</h4>
                                    <div class="porcentaje" id="disciplina-6meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <h4>% de Acciones Disciplinarias 12 Meses</h4>
                                    <div class="porcentaje" id="disciplina-12meses">0%</div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">Acciones Disciplinarias por Día</div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-mes-disciplina" class="form-select" style="width: auto;"></select>
                                        <select id="filtro-ano-disciplina" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-disciplina-grafico" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="graficoDisciplinaPorDia"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">Distribución de Faltas por Motivo</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoDisciplinaMotivoActual"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoDisciplinaMotivoHistorico"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4" id="contenedorGraficoFiltradoDisciplina" style="display: none;">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoDisciplinaMotivoFiltrado"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Historial de Acciones Disciplinarias</span>
                                    <button class="btn btn-primary btn-sm" id="btn-resumen-disciplina">
                                        <i class="fas fa-users-cog me-2"></i>Ver Resumen por Colaborador
                                    </button>
                                </div>
                                <div class="card-body">

<div class="date-range-container">
    <div class="form-group">
        <label for="fecha-inicio-disciplina" class="form-label">Filtrar desde</label>
        <input type="date" class="form-control" id="fecha-inicio-disciplina">
    </div>
    <div class="form-group">
        <label for="fecha-fin-disciplina" class="form-label">Filtrar hasta</label>
        <input type="date" class="form-control" id="fecha-fin-disciplina">
    </div>
    <div class="form-group d-flex align-items-end">
        <button type="button" class="btn btn-primary btn-sm" id="btn-filtrar-disciplina-personalizado">Filtrar</button>
    </div>
</div>


                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control" id="buscador-disciplina" placeholder="Buscar por nombre o identidad...">
                                    </div>
                                    <div class="table-responsive mt-3">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Fecha de la Falta</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Faltas Cometidas</th>
                                                    <th>Observaciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla-disciplina" class="no-hover">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="evaluaciones" role="tabpanel" aria-labelledby="evaluaciones-tab-dd">
                            <div class="tab-title">
                                <h2>Historial de Evaluaciones</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>

                            </div>
                            
                            <div class="rotacion-periodos">
                                <div class="periodo-card">
                                    <h4>% Aprob. Histórico</h4>
                                    <div class="porcentaje" id="evaluacion-aprobacion-historico">0%</div>
                                </div>
                                <div class="periodo-card">
                                    <h4>% Aprob. del Mes</h4>
                                    <div class="porcentaje" id="evaluacion-aprobacion-mes">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h4>% Aprob. Últimos 3 Meses</h4>
                                    <div class="porcentaje" id="evaluacion-aprobacion-3meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <h4>% Aprob. Últimos 6 Meses</h4>
                                    <div class="porcentaje" id="evaluacion-aprobacion-6meses">0%</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <h4>% Aprob. Últimos 12 Meses</h4>
                                    <div class="porcentaje" id="evaluacion-aprobacion-12meses">0%</div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header">Progreso Anual de Evaluaciones (Nota Promedio)</div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-ano-evaluaciones-grafico" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-evaluaciones-grafico" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="chart-container" style="height: 350px;">
                                        <canvas id="graficoEvaluacionesAnual"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">Distribución de Desempeño</div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoEvaluacionesDesempenoActual"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoEvaluacionesDesempenoHistorico"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-4">
                                <div class="card-header card-header-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Alerta de Bajo Rendimiento
                                </div>
                                <div id="contenedor-bajo-rendimiento" class="card-body">
                                    </div>
                            </div>

                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Historial de Evaluaciones Realizadas</span>
                                    <button class="btn btn-primary btn-sm" id="btn-resumen-evaluaciones">
                                        <i class="fas fa-chart-bar me-2"></i>Ver Resumen por Colaborador
                                    </button>
                                </div>
                                <div class="card-body">

<div class="date-range-container">
    <div class="form-group">
        <label for="fecha-inicio-evaluaciones" class="form-label">Filtrar desde</label>
        <input type="date" class="form-control" id="fecha-inicio-evaluaciones">
    </div>
    <div class="form-group">
        <label for="fecha-fin-evaluaciones" class="form-label">Filtrar hasta</label>
        <input type="date" class="form-control" id="fecha-fin-evaluaciones">
    </div>
    <div class="form-group d-flex align-items-end">
        <button type="button" class="btn btn-primary btn-sm" id="btn-filtrar-evaluaciones-personalizado">Filtrar</button>
    </div>
</div>



                                    <div class="search-container">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control" id="buscador-evaluaciones" placeholder="Buscar por nombre o identidad...">
                                    </div>
                                    <div class="table-responsive mt-3">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Fecha de Evaluación</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Nota Final</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla-evaluaciones" class="no-hover">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>


<div class="tab-pane fade" id="registrar-incidente" role="tabpanel" aria-labelledby="registrar-incidente-tab-dd">
                            <div class="tab-title">
                                <h2>Registrar Nuevo Incidente</h2>
                            </div>
                             <div class="card mb-4">
                                <div class="card-body">
                                    <form id="form-registrar-incidente">
                                        <div id="contenedor-formularios-incidente">
                                            
                                            <div class="formulario-item">
                                                <button type="button" class="btn btn-danger btn-quitar-item btn-quitar-item-incidente" title="Quitar registro"><i class="fas fa-times"></i></button>
                                                
                                                <input type="hidden" class="form-control identidad-incidente" required>

                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Fecha de Incidente</label>
                                                        <input type="date" class="form-control fecha-incidente" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Colaborador</label>
                                                        <div class="autocomplete-container">
                                                            <input type="text" class="form-control colaborador-incidente" placeholder="Escriba el nombre..." required>
                                                            <div class="autocomplete-list"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Parte Afectada (Opcional)</label>
                                                        <div class="border p-2 rounded" style="max-height: 150px; overflow-y: auto;">
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Cabeza" id="parte-cabeza">
                                                              <label class="form-check-label" for="parte-cabeza">Cabeza</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Ojos" id="parte-ojos">
                                                              <label class="form-check-label" for="parte-ojos">Ojos</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Torso" id="parte-torso">
                                                              <label class="form-check-label" for="parte-torso">Torso</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Brazo Izquierdo" id="parte-brazo-izq">
                                                              <label class="form-check-label" for="parte-brazo-izq">Brazo Izquierdo</label>
                                                            </div>
                                                             <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Brazo Derecho" id="parte-brazo-der">
                                                              <label class="form-check-label" for="parte-brazo-der">Brazo Derecho</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Mano Izquierda" id="parte-mano-izq">
                                                              <label class="form-check-label" for="parte-mano-izq">Mano Izquierda</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Mano Derecha" id="parte-mano-der">
                                                              <label class="form-check-label" for="parte-mano-der">Mano Derecha</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Pierna Izquierda" id="parte-pierna-izq">
                                                              <label class="form-check-label" for="parte-pierna-izq">Pierna Izquierda</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Pierna Derecha" id="parte-pierna-der">
                                                              <label class="form-check-label" for="parte-pierna-der">Pierna Derecha</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Pie Izquierdo" id="parte-pie-izq">
                                                              <label class="form-check-label" for="parte-pie-izq">Pie Izquierdo</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Pie Derecho" id="parte-pie-der">
                                                              <label class="form-check-label" for="parte-pie-der">Pie Derecho</label>
                                                            </div>
                                                            <div class="form-check">
                                                              <input class="form-check-input parte-afectada-check" type="checkbox" value="Otro" id="parte-otro">
                                                              <label class="form-check-label" for="parte-otro">Otro</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label class="form-label">Categoría SISO</label>
                                                        <select class="form-select categoria-siso-incidente" required>
                                                            <option value="">Seleccionar...</option>
                                                            <option value="FAT">FAT: Fatalidades</option>
                                                            <option value="LWC">LWC: Incidentes con pérdida de tiempo</option>
                                                            <option value="MTC">MTC: Incidentes de tratamiento médico</option>
                                                            <option value="FAC">FAC: Incidentes de primeros auxilios</option>
                                                            <option value="N-M">N-M: Casi Incidentes</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-12 mb-3">
                                                        <label class="form-label">Causa del Incidente</label>
                                                        <textarea class="form-control causa-incidente" rows="2" required></textarea>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12 mb-3">
                                                        <label class="form-label">Descripción del incidente</label>
                                                        <textarea class="form-control descripcion-incidente" rows="2" required></textarea>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12 mb-3">
                                                        <label class="form-label">Medidas Implementadas (Opcional)</label>
                                                        <textarea class="form-control medidas-incidente" rows="2"></textarea>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                        
<div class="d-flex justify-content-center gap-2 mt-4">
    <button type="button" class="btn btn-success" id="btn-agregar-incidente"><i class="fas fa-plus me-2"></i>Agregar</button>
    <button type="button" class="btn btn-primary" id="btn-registrar-incidente">Registrar Incidentes</button>
</div>
                                    </form>
                                </div>
                            </div>
                        </div>


<div class="tab-pane fade" id="historial-incidentes" role="tabpanel" aria-labelledby="historial-incidentes-tab-dd">
                            <div class="tab-title">
                                <h2>Historial de Incidentes</h2>
                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            
                            <div class="rotacion-periodos">
                                <div class="periodo-card" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);">
                                    <h4>Días sin Incidentes</h4>
                                    <div class="porcentaje" id="dias-sin-incidentes">0</div>
                                </div>
                                <div class="periodo-card">
                                    <h4>Total Incidentes</h4>
                                    <div class="porcentaje" id="incidentes-historico">0</div>
                                </div>
                                <div class="periodo-card">
                                    <h4>Incidentes del Mes</h4>
                                    <div class="porcentaje" id="incidentes-mes">0</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <h4>Últimos 3 Meses</h4>
                                    <div class="porcentaje" id="incidentes-3meses">0</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <h4>Últimos 6 Meses</h4>
                                    <div class="porcentaje" id="incidentes-6meses">0</div>
                                </div>
                                <div class="periodo-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <h4>Últimos 12 Meses</h4>
                                    <div class="porcentaje" id="incidentes-12meses">0</div>
                                </div>
                            </div>
                            
                             <div class="card mb-4">
                                <div class="card-header">Incidentes por Mes</div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-ano-incidentes" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-incidentes-grafico" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="graficoIncidentesAnual"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-header">
                                    Partes del Cuerpo Afectadas (Histórico)
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-5 col-lg-4">
                                            <h6 class="text-center">Mapa de Incidentes</h6>
                                            <div id="body-map-container">
                                                <img src="https://img.freepik.com/vector-gratis/anatomia-humana-sobre-fondo-blanco_1308-68254.jpg?ga=GA1.1.1526998125.1753243981&semt=ais_hybrid&w=740&q=80" alt="Diagrama corporal" class="body-map-image">
                                                
                                                <div class="hotspot" id="hotspot-cabeza" title="Cabeza">0</div>
                                                <div class="hotspot" id="hotspot-ojos" title="Ojos">0</div>
                                                <div class="hotspot" id="hotspot-torso" title="Torso">0</div>
                                                <div class="hotspot" id="hotspot-brazo-izquierdo" title="Brazo Izquierdo">0</div>
                                                <div class="hotspot" id="hotspot-brazo-derecho" title="Brazo Derecho">0</div>
                                                <div class="hotspot" id="hotspot-mano-izquierda" title="Mano Izquierda">0</div>
                                                <div class="hotspot" id="hotspot-mano-derecha" title="Mano Derecha">0</div>
                                                <div class="hotspot" id="hotspot-pierna-izquierda" title="Pierna Izquierda">0</div>
                                                <div class="hotspot" id="hotspot-pierna-derecha" title="Pierna Derecha">0</div>
                                                <div class="hotspot" id="hotspot-pie-izquierdo" title="Pie Izquierdo">0</div>
                                                <div class="hotspot" id="hotspot-pie-derecho" title="Pie Derecho">0</div>
                                                <div class="hotspot" id="hotspot-otro" title="Otro">0</div>
                                            </div>
                                        </div>
                                        <div class="col-md-7 col-lg-8">
                                            <h6 class="text-center">Conteo por Parte Afectada</h6>
                                            <div class="chart-container" style="height: 450px;">
                                                <canvas id="graficoPartesCuerpo"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-4">
                                <div class="card-header">
                                    Pirámide de Incidentabilidad (Categoría SISO)
                                </div>
                                <div class="card-body">
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <select id="filtro-mes-incidentes" class="form-select" style="width: auto;"></select>
                                        <select id="filtro-ano-incidentes-pie" class="form-select" style="width: auto;"></select>
                                        <button id="btn-filtrar-incidentes-pie" class="btn btn-primary btn-sm">Filtrar</button>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoIncidentesCategoriaActual"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoIncidentesCategoriaHistorico"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-4" id="contenedorGraficoFiltradoIncidentes" style="display: none;">
                                            <div class="chart-container" style="height: 350px;">
                                                <canvas id="graficoIncidentesCategoriaFiltrado"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="incidentes-simbologia" class="mt-4">
                                </div>
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Historial de Incidentes</span>
                                    <button class="btn btn-primary btn-sm" id="btn-resumen-incidentes">
                                        <i class="fas fa-users me-2"></i>Ver Resumen por Colaborador
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="date-range-container">
                                        <div class="form-group">
                                            <label for="fecha-inicio-incidentes" class="form-label">Filtrar desde</label>
                                            <input type="date" class="form-control" id="fecha-inicio-incidentes">
                                        </div>
                                        <div class="form-group">
                                            <label for="fecha-fin-incidentes" class="form-label">Filtrar hasta</label>
                                            <input type="date" class="form-control" id="fecha-fin-incidentes">
                                        </div>
                                        <div class="form-group d-flex align-items-end">
                                            <button type="button" class="btn btn-primary btn-sm" id="btn-filtrar-incidentes-personalizado">Filtrar</button>
                                        </div>
                                    </div>
                                    
                                    <div class="search-container mt-4">
                                        <i class="fas fa-search"></i>
                                        <input type="text" class="form-control" id="buscador-incidentes" placeholder="Buscar por nombre, identidad, categoría...">
                                    </div>
                                    
                                    <div class="table-responsive mt-3">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Fecha</th>
                                                    <th>Nombre</th>
                                                    <th>Identidad</th>
                                                    <th>Categoría</th>
                                                    <th>Descripción</th>
                                                    <th>Parte Afectada</th>
                                                    <th>Causa</th>
                                                    <th>Medidas</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tabla-incidentes" class="no-hover">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>



                    <div class="tab-pane fade" id="cumpleaneros" role="tabpanel" aria-labelledby="cumpleaneros-tab">
                            <div class="tab-title">
                                <h2>Cumpleañeros del Mes</h2>

                                <button class="btn btn-outline-secondary btn-sm btn-refresh-tab" title="Actualizar esta pestaña">
                                <div id="contenedor-formularios-colaborador">
                                    <i class="fas fa-sync-alt"></i>
                                </button>

                            </div>
                            <div id="contenedor-cumpleaneros" class="row">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Por favor espera un momento...</h4>
            <p></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        let colaboradoresActivos = [];
        let colaboradoresIngresos = [];
        let colaboradoresEgresos = [];
        let ausencias = [];
        let disciplina = [];
        let evaluaciones = [];
        let nombresActivos = [];

        // Gráficos Ausencias
        let graficoAusencias = null;
        let graficoAusenciasMotivoActual = null;
        let graficoAusenciasMotivoHistorico = null;
        let graficoAusenciasMotivoFiltrado = null;
        
        // Gráficos Egresos
        let graficoEgresosMotivoActual = null;
        let graficoEgresosMotivoHistorico = null;
        let graficoEgresosMotivoFiltrado = null;
        let graficoRotacionAnual = null;
        
        // Gráficos Disciplina
        let graficoDisciplinaPorDia = null;
        let graficoDisciplinaMotivoActual = null;
        let graficoDisciplinaMotivoHistorico = null;
        let graficoDisciplinaMotivoFiltrado = null;

        // Gráficos Evaluaciones
        let graficoEvaluacionesAnual = null;
        let graficoEvaluacionesDesempenoActual = null;
        let graficoEvaluacionesDesempenoHistorico = null;
        let graficoProgresoColaborador = null;

// Gráficos Incidentes // <-- AÑADIDO
    let graficoIncidentesAnual = null;
    let graficoIncidentesCategoriaActual = null;
    let graficoIncidentesCategoriaHistorico = null;
    let graficoIncidentesCategoriaFiltrado = null;
    let graficoPartesCuerpo = null;


        // URLs de los scripts de Google Apps Script
        const SCRIPT_URL_OBTENER = "https://script.google.com/macros/s/AKfycbwV6UwcNpiC5FAahk3YPuOS-JSm7Fta5bNW_UoOwvqywTiS-a8LSqAMT32PKM1ydQJs/exec";
        const SCRIPT_URL_ENVIAR = "https://script.google.com/macros/s/AKfycbwP81lGExHp4d9tPRhNNgJ5rlcgXIXj2AsNDNTFcd8Gzdhujy_2UEO0x016YrccFMxU/exec";

        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
        });

        function checkSession() {
            const sessionKey = 'passwordSessionTimestamp';
            const sessionStart = localStorage.getItem(sessionKey);

            if (sessionStart) {
                const twentyFourHours = 24 * 60 * 60 * 1000;
                const timeElapsed = new Date().getTime() - parseInt(sessionStart, 10);

                if (timeElapsed < twentyFourHours) {
                    document.getElementById('main-content').style.display = 'block';
                    initializeApp();
                    return;
                }
            }
            promptForPassword();
        }

        function promptForPassword() {
            Swal.fire({
                title: 'Acceso Restringido',
                html: 'Por favor, ingrese la contraseña para continuar.',
                input: 'password',
                inputPlaceholder: 'Contraseña',
                confirmButtonText: 'Ingresar',
                allowOutsideClick: false,
                allowEscapeKey: false,
                backdrop: `rgba(43, 62, 80, 0.8)`,
                preConfirm: (password) => {
                    if (password !== 'macdel1') {
                        Swal.showValidationMessage('Contraseña incorrecta');
                        return false;
                    }
                    return password;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.setItem('passwordSessionTimestamp', new Date().getTime().toString());
                    document.getElementById('main-content').style.display = 'block';
                    initializeApp();
                }
            });
        }
        
function initializeApp() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;

    document.querySelector(".fecha-inicio").value = todayStr;
    document.querySelector(".fecha-ausencia").value = todayStr;
    document.getElementById('planilla-date-picker').value = todayStr;
    document.querySelector(".fecha-incidente").value = todayStr; // <-- AÑADIDO

    cargarTodosLosDatos();
    configurarEventos();

    // --- INICIO DE MODIFICACIÓN: Recordar vista ---
    // Obtener la vista guardada o usar 'tabla' por defecto
    const vistaPreferida = localStorage.getItem('vistaActivosPreferida') || 'tabla';
    // Aplicar la vista preferida al cargar la página
    toggleVistaActivos(vistaPreferida);
    // --- FIN DE MODIFICACIÓN ---
}


function cargarTodosLosDatos() {
    refrescarDatosGlobales(function() {
        // Esta es la parte de "renderizado" que estaba antes en cargarTodosLosDatos
        const hoy = new Date();
        const yyyy = hoy.getFullYear();
        const mm = String(hoy.getMonth() + 1).padStart(2, '0');
        const dd = String(hoy.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        actualizarDashboard();
        mostrarColaboradoresActivos();
        calcularRotacionGeneral();
        calcularRotacionPeriodos();
        mostrarEgresos(colaboradoresEgresos);
        actualizarVencimientosContrato();
        mostrarColaboradoresEgresados();
        generarPlanilla(todayStr);

        // Pestaña Ausencias
        mostrarAusencias();
        calcularEstadisticasAusencias();
        popularFiltrosGrafico('#filtro-mes-grafico', '#filtro-ano-grafico', ausencias, 'fecha');
        crearGraficoAusencias(hoy.getFullYear(), hoy.getMonth());
        crearGraficoAusenciasMotivoActual();
        crearGraficoAusenciasMotivoHistorico();

        // Pestaña Disciplina
        mostrarHistorialDisciplina();
        calcularEstadisticasDisciplina();
        popularFiltrosGrafico('#filtro-mes-disciplina', '#filtro-ano-disciplina', disciplina, 'fechaFalta');
        crearGraficoDisciplinaPorDia(hoy.getFullYear(), hoy.getMonth());
        crearGraficoDisciplinaMotivoActual();
        crearGraficoDisciplinaMotivoHistorico();

        // Pestaña Evaluaciones
        calcularEstadisticasEvaluaciones();
        actualizarAlertasBajoRendimiento();
        popularFiltrosGraficoAnual('#filtro-ano-evaluaciones-grafico', evaluaciones, 'fechaEvaluacion');
        crearGraficoEvaluacionesAnual(hoy.getFullYear());
        crearGraficoEvaluacionesDesempenoActual();
        crearGraficoEvaluacionesDesempenoHistorico();
        mostrarHistorialEvaluaciones();

        // Pestaña Incidentes 
        calcularEstadisticasIncidentes();
        generarSimbologiaIncidentes(); 
        popularFiltrosGraficoAnual('#filtro-ano-incidentes', incidentes, 'fechaIncidente');
        crearGraficoIncidentesAnual(hoy.getFullYear());
        crearGraficoPartesCuerpo(); // <-- AÑADIDO (Req 3)
        popularFiltrosGrafico('#filtro-mes-incidentes', '#filtro-ano-incidentes-pie', incidentes, 'fechaIncidente');
        crearGraficoIncidentesCategoriaActual();
        crearGraficoIncidentesCategoriaHistorico();
        mostrarHistorialIncidentes();
        // --- FIN AÑADIDO ---

        // Pestaña Rotación
        popularFiltrosGrafico('#filtro-mes-egresos', '#filtro-ano-egresos', colaboradoresEgresos, 'fechaEgreso');
        popularFiltrosGraficoAnual('#filtro-ano-rotacion', colaboradoresEgresos, 'fechaEgreso');
        crearGraficoRotacionAnual(hoy.getFullYear());
        crearGraficoEgresosMotivoActual();
        crearGraficoEgresosMotivoHistorico();
        mostrarCumpleanerosDelMes();
    });
}

        function corregirFecha(item) {
            const propiedadesFecha = ['fechaInicio', 'fechaNacimiento', 'fechaEgreso', 'fecha', 'fechaFin', 'fechaFalta', 'fechaLlamadoAtencion', 'fechaEvaluacion'];
            propiedadesFecha.forEach(prop => {
                if (item[prop] && typeof item[prop] === 'string' && item[prop].includes('T')) {
                    const fecha = new Date(item[prop]);
                    item[prop] = `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`;
                }
            });
            return item;
        }
        
function configurarEventos() {
    // --- Eventos Generales y Formularios ---
    $('#btn-registrar-colaborador').on('click', registrarColaborador);
    $('#btn-agregar-colaborador').on('click', agregarFormularioColaborador);
    $(document).on('click', '.btn-quitar-item-colaborador', function() { $(this).closest('.formulario-item').remove(); });
    $(document).on('input', '.identidad', function() { formatearIdentidad(this); }); // Aplica a todos los inputs .identidad
    $('#btn-registrar-ausencia').on('click', registrarAusencia);
    $('#btn-agregar-ausencia').on('click', agregarFormularioAusencia);
    $(document).on('click', '.btn-quitar-item-ausencia', function() { $(this).closest('.formulario-item').remove(); });

    // INICIO: Incidentes Form Events
    $('#btn-registrar-incidente').on('click', registrarIncidente);
    $('#btn-agregar-incidente').on('click', agregarFormularioIncidente);
    $(document).on('click', '.btn-quitar-item-incidente', function() { $(this).closest('.formulario-item').remove(); });
    // FIN: Incidentes Form Events

    // --- Buscadores ---
    $('#buscador-activos').on('input', filtrarActivos);
    $('#buscador-egresos').on('input', filtrarEgresos);
    $('#buscador-egresados-tabla').on('input', filtrarEgresadosTabla);
    $('#buscador-ausencias').on('input', filtrarAusencias);
    $('#buscador-disciplina').on('input', filtrarDisciplina);
    $('#buscador-evaluaciones').on('input', filtrarEvaluaciones);
    $('#buscador-vencimientos').on('input', filtrarVencimientos);
    $('#buscador-planilla').on('input', filtrarPlanilla);
    $('#buscador-incidentes').on('input', filtrarIncidentesTabla);

    // --- Otros Eventos (Planilla, Rotación, Resúmenes) ---
    $('#planilla-date-picker').on('change', function() { generarPlanilla(this.value); });
    $('#btn-calcular-rotacion-personalizado').on('click', calcularRotacionPersonalizado);
    $('#btn-resumen-disciplina').on('click', mostrarResumenDisciplina);
    $('#btn-resumen-evaluaciones').on('click', mostrarResumenEvaluaciones);
    $('#btn-resumen-ausencias').on('click', mostrarResumenAusencias);
    $('#btn-resumen-incidentes').on('click', mostrarResumenIncidentes);

    // --- Filtros de Gráficos ---
    $('#btn-filtrar-grafico').on('click', function() {
        const ano = parseInt($('#filtro-ano-grafico').val());
        const mes = parseInt($('#filtro-mes-grafico').val());
        crearGraficoAusencias(ano, mes);
        $('#contenedorGraficoFiltradoAusencias').toggle(ano !== new Date().getFullYear() || mes !== new Date().getMonth());
        if ($('#contenedorGraficoFiltradoAusencias').is(':visible')) {
            crearGraficoAusenciasMotivoFiltrado(ano, mes);
        }
    });
    $('#btn-filtrar-disciplina-grafico').on('click', function() {
        const ano = parseInt($('#filtro-ano-disciplina').val());
        const mes = parseInt($('#filtro-mes-disciplina').val());
        crearGraficoDisciplinaPorDia(ano, mes);
        $('#contenedorGraficoFiltradoDisciplina').toggle(ano !== new Date().getFullYear() || mes !== new Date().getMonth());
        if ($('#contenedorGraficoFiltradoDisciplina').is(':visible')) {
            crearGraficoDisciplinaMotivoFiltrado(ano, mes);
        }
    });
    $('#btn-filtrar-evaluaciones-grafico').on('click', function() {
        const ano = parseInt($('#filtro-ano-evaluaciones-grafico').val());
        crearGraficoEvaluacionesAnual(ano);
    });
    $('#btn-filtrar-rotacion-grafico').on('click', function() {
        const ano = parseInt($('#filtro-ano-rotacion').val());
        crearGraficoRotacionAnual(ano);
    });
    $('#btn-filtrar-egresos').on('click', function() {
        const ano = parseInt($('#filtro-ano-egresos').val());
        const mes = parseInt($('#filtro-mes-egresos').val());
        $('#contenedorGraficoFiltradoEgresos').toggle(ano !== new Date().getFullYear() || mes !== new Date().getMonth());
         if ($('#contenedorGraficoFiltradoEgresos').is(':visible')) {
            crearGraficoEgresosMotivoFiltrado(ano, mes);
        }
    });
    // INICIO: Incidentes Chart Filters
    $('#btn-filtrar-incidentes-grafico').on('click', function() {
        const ano = parseInt($('#filtro-ano-incidentes').val());
        crearGraficoIncidentesAnual(ano);
    });
    $('#btn-filtrar-incidentes-pie').on('click', function() {
        const ano = parseInt($('#filtro-ano-incidentes-pie').val());
        const mes = parseInt($('#filtro-mes-incidentes').val());
        $('#contenedorGraficoFiltradoIncidentes').toggle(ano !== new Date().getFullYear() || mes !== new Date().getMonth());
         if ($('#contenedorGraficoFiltradoIncidentes').is(':visible')) {
            crearGraficoIncidentesCategoriaFiltrado(ano, mes);
        }
    });
    // FIN: Incidentes Chart Filters

    // --- Autocompletado ---
    $(document).on('input', '.colaborador-ausencia, .colaborador-incidente', function() {
        const input = $(this), valor = input.val().toLowerCase(), autocompleteList = input.next('.autocomplete-list');
        if (valor.length < 1) { autocompleteList.hide(); return; }
        if (!nombresActivos || nombresActivos.length === 0) return;
        const sugerencias = nombresActivos.filter(nombre => nombre.toLowerCase().includes(valor));
        autocompleteList.empty().toggle(sugerencias.length > 0);
        sugerencias.forEach(sug => autocompleteList.append(`<div class="autocomplete-item">${sug}</div>`));
    });
    $(document).on('click', '.autocomplete-item', function() {
        const item = $(this);
        const nombreSeleccionado = item.text();
        const container = item.closest('.autocomplete-container');
        container.find('.colaborador-ausencia, .colaborador-incidente').val(nombreSeleccionado);
        item.closest('.autocomplete-list').hide();
        const colaboradorInfo = colaboradoresActivos.find(col => col.nombre === nombreSeleccionado);
        if (colaboradorInfo) {
            const formularioItem = item.closest('.formulario-item');
            if (formularioItem.length) {
                formularioItem.find('.identidad-incidente').val(colaboradorInfo.identidad);
            }
        }
    });
    $(document).on('click', (e) => {
        if (!$(e.target).closest('.autocomplete-container').length) {
            $('.autocomplete-list').hide();
        }
    });

    // --- Sincronizar Dropdowns y Tabs ---
    $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        let targetId = $(e.target).attr("href");
        $('.dropdown-item').removeClass('active');
        $(`.dropdown-item[href="${targetId}"]`).addClass('active');
    });

    // --- Clic en Vencimientos ---
    $(document).on('click', '#contenedor-vencimientos .resumen-disciplina-item, #contenedor-contratos-vencidos .resumen-disciplina-item', function() {
        const identidad = $(this).data('identidad');
        mostrarDetalleColaboradorCompleto(identidad);
    });

    // --- Filtros de Fecha Personalizados ---
    $('#btn-filtrar-ausencias-personalizado').on('click', filtrarAusenciasPersonalizado);
    $('#btn-filtrar-disciplina-personalizado').on('click', filtrarDisciplinaPersonalizado);
    $('#btn-filtrar-evaluaciones-personalizado').on('click', filtrarEvaluacionesPersonalizado);
    $('#btn-filtrar-incidentes-personalizado').on('click', filtrarIncidentesPersonalizado);

    // --- Botón Refrescar Pestaña ---
    $(document).on('click', '.btn-refresh-tab', actualizarTabActual);

    // --- Editar Ausencia ---
    $(document).on('click', '.btn-edit-ausencia', function() {
        const identidad = $(this).data('identidad');
        const fecha = $(this).data('fecha');
        const ausenciaOriginal = ausencias.find(a => a.identidad === identidad && a.fecha === fecha);
        if (ausenciaOriginal) abrirModalEditarAusencia(ausenciaOriginal);
        else Swal.fire('Error', 'No se pudo encontrar el registro de ausencia original.', 'error');
    });

    // --- INICIO: Editar Incidente (NUEVO BLOQUE) ---
    $(document).on('click', '.btn-edit-incidente', function() {
        const identidad = $(this).data('identidad');
        const fecha = $(this).data('fecha');
        // Buscar el incidente en la variable global 'incidentes'
        const incidenteOriginal = incidentes.find(i => i.identidad === identidad && i.fechaIncidente === fecha);
        if (incidenteOriginal) {
            abrirModalEditarIncidente(incidenteOriginal); // Llamar a la nueva función
        } else {
            Swal.fire('Error', 'No se pudo encontrar el registro de incidente original.', 'error');
        }
    });
    // --- FIN: Editar Incidente ---

    // --- Editar Egreso ---
    $(document).on('click', '#egresados .btn-edit-egreso', function(e) {
        e.stopPropagation();
        const identidad = $(this).data('identidad');
        const fechaEgreso = $(this).data('fechaegreso');
        const egresoOriginal = colaboradoresEgresos.find(eg => eg.identidad === identidad && eg.fechaEgreso === fechaEgreso);
        if (egresoOriginal) abrirModalEditarEgreso(egresoOriginal);
        else Swal.fire('Error', 'No se pudo encontrar el registro de egreso original.', 'error');
    });

    // --- Cambiar Vista (Activos) ---
    $('#activos .btn-vista').on('click', function() {
        const vistaSeleccionada = $(this).data('vista');
        toggleVistaActivos(vistaSeleccionada);
    });

    // --- Botones de Acción (Delegados desde #myTabContent) ---
    const tabContent = $('#myTabContent');
    tabContent.on('click', '#activos .btn-photo, #egresados .btn-photo-egresado', function(e) {
        e.stopPropagation();
        const identidad = $(this).data('identidad');
        const esEgresado = $(this).hasClass('btn-photo-egresado');
        const fuenteDatos = esEgresado ? colaboradoresEgresos : colaboradoresActivos;
        const fechaRef = esEgresado ? $(this).data('fechaegreso') : null;
        const colaboradorData = fuenteDatos.find(c => c.identidad === identidad && (!esEgresado || !fechaRef || c.fechaEgreso === fechaRef));
        if (colaboradorData) mostrarFoto(colaboradorData);
    });
    tabContent.on('click', '#activos .btn-edit', function(e) {
        e.stopPropagation();
        const identidad = $(this).data('identidad');
        const index = colaboradoresActivos.findIndex(c => c.identidad === identidad);
        if (index !== -1) editarColaborador(index); // Asume que editarColaborador usa index global
    });
    tabContent.on('click', '#activos .btn-delete', function(e) {
        e.stopPropagation();
        const identidad = $(this).data('identidad');
        const index = colaboradoresActivos.findIndex(c => c.identidad === identidad);
        if (index !== -1) eliminarColaborador(index); // Asume que eliminarColaborador usa index global
    });
    tabContent.on('click', '#activos .btn-historial, #egresados .btn-historial-egresado', function(e) {
        e.stopPropagation();
        const identidad = $(this).data('identidad');
        const esEgresado = $(this).hasClass('btn-historial-egresado');
        if (esEgresado) mostrarDetalleEgresado(identidad);
        else mostrarDetalleColaboradorCompleto(identidad, false);
    });
    tabContent.on('click', '#egresados .btn-reingreso', function(e) {
         e.stopPropagation();
         const identidad = $(this).closest('.empleado-item, tr').data('identidad');
         const egresado = colaboradoresEgresos.find(eg => eg.identidad === identidad);
         if (egresado) reingresarColaborador(egresado);
     });
}


/**
 * Abre un modal (SweetAlert) para editar un registro de incidente existente.
 * @param {object} incidenteOriginal - El objeto de incidente de la variable global 'incidentes'.
 */
function abrirModalEditarIncidente(incidenteOriginal) {

    // --- Generar el dropdown de colaboradores activos ---
    let opcionesColaboradores = '';
    colaboradoresActivos.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(col => {
        opcionesColaboradores += `<option value="${col.identidad}" ${col.identidad === incidenteOriginal.identidad ? 'selected' : ''}>
            ${col.nombre}
        </option>`;
    });

    // --- Generar checkboxes para partes afectadas ---
    const partesCuerpo = ["Cabeza", "Ojos", "Torso", "Brazo Izquierdo", "Brazo Derecho", "Mano Izquierda", "Mano Derecha", "Pierna Izquierda", "Pierna Derecha", "Pie Izquierdo", "Pie Derecho", "Otro"];
    let checkboxesHtml = '';
    const partesSeleccionadasOriginal = incidenteOriginal.parteAfectada ? incidenteOriginal.parteAfectada.split('; ') : [];

    partesCuerpo.forEach((parte, index) => {
        const id = `edit-parte-${parte.toLowerCase().replace(/[^a-z0-9]/gi, '-')}`; // Crear ID único
        const isChecked = partesSeleccionadasOriginal.includes(parte) ? 'checked' : '';
        checkboxesHtml += `
            <div class="form-check form-check-inline">
              <input class="form-check-input edit-parte-afectada-check" type="checkbox" value="${parte}" id="${id}" ${isChecked}>
              <label class="form-check-label" for="${id}">${parte}</label>
            </div>`;
    });

    Swal.fire({
        title: 'Editar Incidente',
        html: `
            <div class="text-start">

                <div class="mb-3">
                    <label for="editar-fecha-incidente" class="form-label">Fecha de Incidente</label>
                    <input type="date" class="form-control" id="editar-fecha-incidente" value="${incidenteOriginal.fechaIncidente}" required>
                </div>

                <div class="mb-3">
                    <label for="editar-colaborador-incidente" class="form-label">Colaborador</label>
                    <select class="form-select" id="editar-colaborador-incidente" required>
                        <option value="">Seleccionar...</option>
                        ${opcionesColaboradores}
                    </select>
                </div>

                 <div class="mb-3">
                    <label class="form-label">Parte Afectada (Opcional)</label>
                    <div class="border p-2 rounded" style="max-height: 150px; overflow-y: auto;">
                        ${checkboxesHtml}
                    </div>
                 </div>

                <div class="mb-3">
                    <label for="editar-categoria-siso" class="form-label">Categoría SISO</label>
                    <select class="form-select" id="editar-categoria-siso" required>
                        <option value="FAT" ${incidenteOriginal.categoriaSiso === 'FAT' ? 'selected' : ''}>FAT: Fatalidades</option>
                        <option value="LWC" ${incidenteOriginal.categoriaSiso === 'LWC' ? 'selected' : ''}>LWC: Incidentes con pérdida de tiempo</option>
                        <option value="MTC" ${incidenteOriginal.categoriaSiso === 'MTC' ? 'selected' : ''}>MTC: Incidentes de tratamiento médico</option>
                        <option value="FAC" ${incidenteOriginal.categoriaSiso === 'FAC' ? 'selected' : ''}>FAC: Incidentes de primeros auxilios</option>
                        <option value="N-M" ${incidenteOriginal.categoriaSiso === 'N-M' ? 'selected' : ''}>N-M: Casi Incidentes</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="editar-causa-incidente" class="form-label">Causa del Incidente</label>
                    <textarea class="form-control" id="editar-causa-incidente" rows="2" required>${incidenteOriginal.causa || ''}</textarea>
                </div>

                <div class="mb-3">
                    <label for="editar-descripcion-incidente" class="form-label">Descripción del incidente</label>
                    <textarea class="form-control" id="editar-descripcion-incidente" rows="2" required>${incidenteOriginal.descripcion || ''}</textarea>
                </div>

                <div class="mb-3">
                    <label for="editar-medidas-incidente" class="form-label">Medidas Implementadas (Opcional)</label>
                    <textarea class="form-control" id="editar-medidas-incidente" rows="2">${incidenteOriginal.medidas || ''}</textarea>
                </div>
            </div>`,
        showCancelButton: true,
        confirmButtonText: 'Guardar Cambios',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            const nuevaIdentidad = $('#editar-colaborador-incidente').val();
            const fechaIncidente = $('#editar-fecha-incidente').val();
            const categoriaSiso = $('#editar-categoria-siso').val();
            const causa = $('#editar-causa-incidente').val();
            const descripcion = $('#editar-descripcion-incidente').val();
            const medidas = $('#editar-medidas-incidente').val();

            // Leer checkboxes seleccionados
            const partesAfectadasArray = [];
            $('.edit-parte-afectada-check:checked').each(function() {
                partesAfectadasArray.push($(this).val());
            });
            const parteAfectada = partesAfectadasArray.join('; ');

            if (!nuevaIdentidad || !fechaIncidente || !categoriaSiso || !causa || !descripcion ) {
                Swal.showValidationMessage('Fecha, Colaborador, Categoría, Causa y Descripción son obligatorios.');
                return false;
            }

            const nuevoColaboradorInfo = colaboradoresActivos.find(col => col.identidad === nuevaIdentidad);
            if (!nuevoColaboradorInfo) {
                Swal.showValidationMessage('El colaborador seleccionado no es válido.');
                return false;
            }

            const datosNuevos = {
                // Info del nuevo colaborador (por si cambia)
                nombre: nuevoColaboradorInfo.nombre,
                identidad: nuevoColaboradorInfo.identidad,

                // Info del incidente
                fechaIncidente,
                categoriaSiso,
                causa,
                descripcion,
                medidas: medidas || '',
                parteAfectada: parteAfectada || '' // Enviar vacío si no se seleccionó nada
            };

            return { datosNuevos };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const { datosNuevos } = result.value;

            $('#overlay').css('display', 'flex');
            $.post(SCRIPT_URL_ENVIAR, {
                accion: 'editar_incidente',
                // La clave original NO cambia (identidad + fecha de incidente original)
                incidenteOriginal: JSON.stringify({
                    identidad: incidenteOriginal.identidad,
                    fechaIncidente: incidenteOriginal.fechaIncidente
                }),
                datosNuevos: JSON.stringify(datosNuevos), // Coma corregida aquí
            }, function(response) {
                $('#overlay').hide();
                if (response === 'Éxito') {
                    Swal.fire('Éxito', 'Incidente actualizado correctamente.', 'success').then(() => {
                        actualizarTabActual();
                    });
                } else {
                    Swal.fire('Error', 'Hubo un problema al actualizar: ' + response, 'error');
                }
            }).fail(() => {
                $('#overlay').hide();
                Swal.fire('Error', 'Error de conexión al actualizar.', 'error');
            }); // Cierre del .fail()
        } // Cierre del if(result.isConfirmed)
    }); // Cierre del .then() que sigue a Swal.fire({...})
}



/**
 * Cambia entre la vista de tabla y la vista de miniaturas para la pestaña de Activos.
 * @param {string} vista - 'tabla' o 'grid'.
 */
function toggleVistaActivos(vista) {
    if (vista === 'tabla') {
        $('#tabla-activos').closest('.table-responsive').show();
        $('#grid-activos').hide();
        $('.btn-vista[data-vista="tabla"]').addClass('active');
        $('.btn-vista[data-vista="grid"]').removeClass('active');
    } else { // Asumimos 'grid'
        $('#tabla-activos').closest('.table-responsive').hide();
        $('#grid-activos').show();
        $('.btn-vista[data-vista="tabla"]').removeClass('active');
        $('.btn-vista[data-vista="grid"]').addClass('active');
    }
    // --- INICIO DE MODIFICACIÓN: Guardar preferencia ---
    localStorage.setItem('vistaActivosPreferida', vista);
    // --- FIN DE MODIFICACIÓN ---
}


/**
 * Abre un modal (SweetAlert) para editar un registro de ausencia existente.
 * @param {object} ausenciaOriginal - El objeto de ausencia de la variable global 'ausencias'.
 */
function abrirModalEditarAusencia(ausenciaOriginal) {
    
    // --- NUEVO: Generar el dropdown de colaboradores ---
    // Crear la lista de opciones de colaboradores activos
    let opcionesColaboradores = '';
    colaboradoresActivos.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(col => {
        opcionesColaboradores += `<option value="${col.identidad}" ${col.identidad === ausenciaOriginal.identidad ? 'selected' : ''}>
            ${col.nombre}
        </option>`;
    });
    // --- FIN NUEVO ---

    Swal.fire({
        title: 'Editar Ausencia',
        html: `
            <div class="text-start">
                
                <div class="mb-3">
                    <label for="editar-colaborador-ausencia" class="form-label">Colaborador</label>
                    <select class="form-select" id="editar-colaborador-ausencia" required>
                        <option value="">Seleccionar...</option>
                        ${opcionesColaboradores}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editar-fecha-ausencia" class="form-label">Fecha de Inicio</label>
                    <input type="date" class="form-control" id="editar-fecha-ausencia" value="${ausenciaOriginal.fecha}" required>
                </div>
                
                <div class="mb-3">
                    <label for="editar-dias-ausencia" class="form-label">Días de Ausencia</label>
                    <input type="number" class="form-control" id="editar-dias-ausencia" min="1" value="${ausenciaOriginal.diasIncapacidad || 1}" required>
                </div>
                
                <div class="mb-3">
                    <label for="editar-motivo-ausencia" class="form-label">Motivo</label>
                    <select class="form-select" id="editar-motivo-ausencia" required>
                        <option value="Incapacidad" ${ausenciaOriginal.motivo === 'Incapacidad' ? 'selected' : ''}>Incapacidad</option>
                        <option value="Permiso" ${ausenciaOriginal.motivo === 'Permiso' ? 'selected' : ''}>Permiso</option>
                        <option value="Falta Injustificada" ${ausenciaOriginal.motivo === 'Falta Injustificada' ? 'selected' : ''}>Falta Injustificada</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="editar-obs-ausencia" class="form-label">Observaciones</label>
                    <textarea class="form-control" id="editar-obs-ausencia" rows="2">${ausenciaOriginal.observaciones || ''}</textarea>
                </div>
            </div>`,
        showCancelButton: true,
        confirmButtonText: 'Guardar Cambios',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            // --- INICIO DE MODIFICACIÓN ---
            const nuevaIdentidad = $('#editar-colaborador-ausencia').val(); // Leer la identidad del select
            const fecha = $('#editar-fecha-ausencia').val();
            const diasIncapacidad = parseInt($('#editar-dias-ausencia').val());
            const motivo = $('#editar-motivo-ausencia').val();
            const observaciones = $('#editar-obs-ausencia').val();

            if (!nuevaIdentidad || !fecha || !diasIncapacidad || diasIncapacidad < 1) {
                Swal.showValidationMessage('Colaborador, fecha y días (1 o más) son obligatorios.');
                return false;
            }

            // Buscar la info completa del *nuevo* colaborador
            const nuevoColaboradorInfo = colaboradoresActivos.find(col => col.identidad === nuevaIdentidad);
            if (!nuevoColaboradorInfo) {
                // Esto no debería pasar si el select está bien, pero es buena validación
                Swal.showValidationMessage('El colaborador seleccionado no es válido.');
                return false;
            }
            
            // Calcular nueva fecha fin
            const fechaInicio = new Date(fecha + 'T00:00:00');
            const fechaFin = new Date(fechaInicio);
            fechaFin.setDate(fechaFin.getDate() + diasIncapacidad - 1);
            const fechaFinStr = fechaFin.toISOString().split('T')[0];

            const datosNuevos = {
                // Info del nuevo colaborador
                nombre: nuevoColaboradorInfo.nombre,
                identidad: nuevoColaboradorInfo.identidad,
                fechaNacimiento: nuevoColaboradorInfo.fechaNacimiento || '', // Asegurar que no sea undefined
                sexo: nuevoColaboradorInfo.sexo,
                
                // Info de la ausencia
                fecha,
                diasIncapacidad,
                motivo,
                observaciones,
                fechaFin: fechaFinStr
            };
            // --- FIN DE MODIFICACIÓN ---
            
            return { datosNuevos };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const { datosNuevos } = result.value;
            
            $('#overlay').css('display', 'flex');
            $.post(SCRIPT_URL_ENVIAR, {
                accion: 'editar_ausencia',
                // La clave original NO cambia (identidad + fecha de inicio original)
                ausenciaOriginal: JSON.stringify({
                    identidad: ausenciaOriginal.identidad,
                    fecha: ausenciaOriginal.fecha 
                }),
                datosNuevos: JSON.stringify(datosNuevos)
            }, function(response) {
                $('#overlay').hide();
                if (response === 'Éxito') {
                    Swal.fire('Éxito', 'Ausencia actualizada correctamente.', 'success').then(() => {
                        actualizarTabActual(); 
                    });
                } else {
                    Swal.fire('Error', 'Hubo un problema al actualizar: ' + response, 'error');
                }
            }).fail(() => {
                $('#overlay').hide();
                Swal.fire('Error', 'Error de conexión al actualizar.', 'error');
            });
        }
    });
}



        
function agregarFormularioColaborador() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;
    
    const nuevoFormulario = `
        <div class="formulario-item">
            <button type="button" class="btn btn-danger btn-quitar-item btn-quitar-item-colaborador" title="Quitar registro"><i class="fas fa-times"></i></button>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha de Inicio</label>
                    <input type="date" class="form-control fecha-inicio" value="${todayStr}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" class="form-control nombre-completo" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Identidad</label>
                    <input type="text" class="form-control identidad" placeholder="0000-0000-00000" pattern="\\d{4}-\\d{4}-\\d{5}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha de Nacimiento (Opcional)</label>
                    <input type="date" class="form-control fecha-nacimiento">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Sexo</label>
                    <select class="form-select sexo" required>
                        <option value="">Seleccionar...</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="row align-items-center">
                        <div class="col-md-7">
                            <label class="form-label">Foto (opcional)</label>
                            <input type="file" class="form-control foto-colaborador" accept="image/*" onchange="mostrarVistaPreviaFoto(this)" capture="environment">
                            <div class="form-text">JPG, PNG. Máx 5MB</div>
                        </div>
                        <div class="col-md-5">
                            <div class="vista-previa-container mt-2 mt-md-0 text-center"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    $('#contenedor-formularios-colaborador').append(nuevoFormulario);
}



        function registrarColaborador() {
            let colaboradoresParaRegistrar = [];
            let esValido = true;
            const identidadRegex = /^\d{4}-\d{4}-\d{5}$/;
            let identidadesEnLote = new Set();

            $('#contenedor-formularios-colaborador .formulario-item').each(function(index) {
                const item = $(this);
                const fechaInicio = item.find('.fecha-inicio').val();
                const nombre = item.find('.nombre-completo').val();
                const identidad = item.find('.identidad').val();
                const fechaNacimiento = item.find('.fecha-nacimiento').val() || ''; 
                const sexo = item.find('.sexo').val();
                const fotoInput = item.find('.foto-colaborador')[0];

                if (!fechaInicio || !nombre || !identidad || !sexo) {
                    Swal.fire('Error', `Por favor complete todos los campos obligatorios para el colaborador #${index + 1}.`, 'error');
                    esValido = false;
                    return false;
                }
                if (!identidadRegex.test(identidad)) {
                    Swal.fire('Error', `El formato de identidad para el colaborador #${index + 1} es incorrecto.`, 'error');
                    esValido = false;
                    return false;
                }
                if (colaboradoresActivos.some(col => col.identidad === identidad) || identidadesEnLote.has(identidad)) {
                    Swal.fire('Error', `La identidad '${identidad}' del colaborador #${index + 1} ya está registrada o duplicada en este lote.`, 'error');
                    esValido = false;
                    return false;
                }
                identidadesEnLote.add(identidad);
                colaboradoresParaRegistrar.push({ fechaInicio, nombre, identidad, fechaNacimiento, sexo, fotoInput });
            });

            if (!esValido || colaboradoresParaRegistrar.length === 0) return;

            Swal.fire({
                title: '¿Está seguro?',
                html: `Se registrarán <strong>${colaboradoresParaRegistrar.length}</strong> nuevos colaboradores.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, registrar',
                cancelButtonText: 'No, cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#overlay').css('display', 'flex');
                    const colaboradoresSinFoto = colaboradoresParaRegistrar.map(({ fotoInput, ...resto }) => resto);

                    $.post(SCRIPT_URL_ENVIAR, {
                        accion: 'registrar_colaboradores_masivo',
                        datos: JSON.stringify(colaboradoresSinFoto)
                    }, function(response) {
                        if (response === 'Éxito') {
                            const promesasFotos = colaboradoresParaRegistrar
                                .filter(col => col.fotoInput.files[0])
                                .map(col => subirFoto(col, col.fotoInput.files[0], false));

                            Promise.all(promesasFotos)
                                .then(() => {
                                    $('#overlay').hide();
                                    Swal.fire('Éxito', 'Colaboradores registrados correctamente.', 'success').then(() => {
                                        $('#contenedor-formularios-colaborador').empty();
                                        agregarFormularioColaborador();
                                        cargarTodosLosDatos();
                                    });
                                })
                                .catch(error => {
                                    $('#overlay').hide();
                                    Swal.fire('Advertencia', `Colaboradores registrados, pero hubo un error al subir algunas fotos: ${error}`, 'warning').then(() => {
                                        cargarTodosLosDatos();
                                    });
                                });
                        } else {
                            $('#overlay').hide();
                            Swal.fire('Error', 'Hubo un problema al registrar: ' + response, 'error');
                        }
                    }).fail(() => {
                        $('#overlay').hide();
                        Swal.fire('Error', 'Error de conexión al registrar.', 'error');
                    });
                }
            });
        }
        
        function agregarFormularioAusencia() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${dd}`;

            const nuevoFormulario = `
                <div class="formulario-item">
                    <button type="button" class="btn btn-danger btn-quitar-item btn-quitar-item-ausencia" title="Quitar registro"><i class="fas fa-times"></i></button>
                    <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label">Fecha de Ausencia</label><input type="date" class="form-control fecha-ausencia" value="${todayStr}" required></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Días de Ausencia</label><input type="number" class="form-control dias-incapacidad" value="1" min="1" required></div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Colaborador</label>
                            <div class="autocomplete-container">
                                <input type="text" class="form-control colaborador-ausencia" placeholder="Escriba el nombre..." required>
                                <div class="autocomplete-list"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Motivo</label>
                            <select class="form-select motivo-ausencia" required>
                                <option value="">Seleccionar...</option><option value="Incapacidad">Incapacidad</option><option value="Permiso">Permiso</option><option value="Falta Injustificada">Falta Injustificada</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3"><label class="form-label">Observaciones</label><textarea class="form-control observaciones-ausencia" rows="1"></textarea></div>
                    </div>
                </div>`;
            $('#contenedor-formularios-ausencia').append(nuevoFormulario);
        }

function registrarAusencia() {
    let ausenciasParaRegistrar = [], esValido = true;
    
    $('#contenedor-formularios-ausencia .formulario-item').each(function(index) {
        const item = $(this);
        const fecha = item.find('.fecha-ausencia').val();
        const diasIncapacidad = parseInt(item.find('.dias-incapacidad').val());
        const colaborador = item.find('.colaborador-ausencia').val();
        const motivo = item.find('.motivo-ausencia').val();
        const observaciones = item.find('.observaciones-ausencia').val();

        if (!fecha || !diasIncapacidad || !colaborador || !motivo) { 
            Swal.fire('Error', `Complete campos obligatorios para ausencia #${index + 1}.`, 'error'); 
            esValido = false; 
            return false; 
        }

        const colaboradorInfo = colaboradoresActivos.find(col => col.nombre.toLowerCase() === colaborador.toLowerCase());
        
        if (!colaboradorInfo) { 
            Swal.fire('Error', `Colaborador '${colaborador}' (ausencia #${index + 1}) no es activo.`, 'error'); 
            esValido = false; 
            return false; 
        }
        
        const identidad = colaboradorInfo.identidad;
        const fechaInicio = new Date(fecha + 'T00:00:00');
        const fechaFin = new Date(fechaInicio);
        fechaFin.setDate(fechaFin.getDate() + diasIncapacidad - 1);
        const fechaFinStr = fechaFin.toISOString().split('T')[0];

        // --- INICIO DE NUEVA VALIDACIÓN ---
        let hayDuplicado = false;
        for (let d = new Date(fechaInicio); d <= fechaFin; d.setDate(d.getDate() + 1)) {
            const fechaActualStr = d.toISOString().split('T')[0];

            // 1. Revisar en la base de datos (array 'ausencias')
            const duplicadoExistente = ausencias.some(a => 
                a.identidad === identidad &&
                fechaActualStr >= a.fecha && 
                fechaActualStr <= (a.fechaFin || a.fecha)
            );

            // 2. Revisar en el lote actual que se está registrando
            const duplicadoEnLote = ausenciasParaRegistrar.some(a => 
                a.identidad === identidad &&
                fechaActualStr >= a.fecha && 
                fechaActualStr <= a.fechaFin
            );

            if (duplicadoExistente || duplicadoEnLote) {
                Swal.fire('Error de Duplicado', `Ya existe una ausencia registrada para '${colaborador}' el día ${formatearFecha(fechaActualStr)}.`, 'error');
                esValido = false;
                hayDuplicado = true;
                return false; // Sale del bucle forEach del formulario
            }
        }
        if (hayDuplicado) return false;
        // --- FIN DE NUEVA VALIDACIÓN ---

        ausenciasParaRegistrar.push({ fecha, fechaFin: fechaFinStr, diasIncapacidad, colaborador, identidad, motivo, observaciones });
    });
    
    if (!esValido || ausenciasParaRegistrar.length === 0) return;
    
    Swal.fire({ 
        title: '¿Está seguro?', 
        html: `Se registrarán <strong>${ausenciasParaRegistrar.length}</strong> ausencias.`, 
        icon: 'question', 
        showCancelButton: true, 
        confirmButtonText: 'Sí, registrar', 
        cancelButtonText: 'No, cancelar' 
    }).then((result) => {
        if (result.isConfirmed) {
            // Quitamos 'identidad' del objeto a enviar, ya que el servidor lo resuelve por 'colaborador' (nombre)
            const datosParaEnviar = ausenciasParaRegistrar.map(({ identidad, ...resto }) => resto);

            $('#overlay').css('display', 'flex');
            $.post(SCRIPT_URL_ENVIAR, { 
                accion: 'registrar_ausencias_masivo', 
                datos: JSON.stringify(datosParaEnviar) 
            }, (response) => {
                $('#overlay').hide();
                if (response === 'Éxito') {
                    Swal.fire('Éxito', 'Ausencias registradas.', 'success').then(() => { 
                        $('#contenedor-formularios-ausencia').empty(); 
                        agregarFormularioAusencia(); 
                        cargarTodosLosDatos(); 
                    });
                } else {
                    Swal.fire('Error', `Error al registrar ausencias: ${response}`, 'error');
                }
            }).fail(() => { 
                $('#overlay').hide(); 
                Swal.fire('Error', 'Error de conexión.', 'error'); 
            });
        }
    });
}

        
        function actualizarDashboard() {
            $('#total-activos').text(colaboradoresActivos.length);
            const hombres = colaboradoresActivos.filter(c => c.sexo === 'Masculino').length;
            $('#total-hombres').text(hombres);
            $('#total-mujeres').text(colaboradoresActivos.length - hombres);
            let sumaEdades = 0, colaboradoresConEdad = 0;
            colaboradoresActivos.forEach(col => {
                if (col.fechaNacimiento) {
                    const hoy = new Date(), fechaNac = new Date(col.fechaNacimiento);
                    let edad = hoy.getFullYear() - fechaNac.getFullYear();
                    const m = hoy.getMonth() - fechaNac.getMonth();
                    if (m < 0 || (m === 0 && hoy.getDate() < fechaNac.getDate())) edad--;
                    sumaEdades += edad;
                    colaboradoresConEdad++;
                }
            });
            $('#edad-promedio').text(colaboradoresConEdad > 0 ? Math.round(sumaEdades / colaboradoresConEdad) : 0);
            const hoy = new Date();
            const yyyy = hoy.getFullYear();
            const mm = String(hoy.getMonth() + 1).padStart(2, '0');
            const dd = String(hoy.getDate()).padStart(2, '0');
            const hoyStr = `${yyyy}-${mm}-${dd}`;
            const ausenciasHoy = ausencias.filter(a => hoyStr >= a.fecha && hoyStr <= (a.fechaFin || a.fecha)).length;
            $('#ausencias-hoy').text(ausenciasHoy);
            $('#presentes-hoy').text(colaboradoresActivos.length - ausenciasHoy);
            const inicioMes = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const egresosMes = colaboradoresEgresos.filter(e => new Date(e.fechaEgreso) >= inicioMes);
            $('#rotacion-mes-dashboard').text(calcularPorcentajeRotacion(egresosMes).porcentaje + '%');
            
            // Nuevos KPIs para Dashboard
            const totalActivos = colaboradoresActivos.length;
            if (totalActivos > 0) {
                const accionesMes = disciplina.filter(d => new Date(d.fechaFalta) >= inicioMes).length;
                $('#disciplina-mes-dashboard').text(((accionesMes / totalActivos) * 100).toFixed(2) + '%');

                const evaluacionesMes = evaluaciones.filter(e => new Date(e.fechaEvaluacion) >= inicioMes);
                if (evaluacionesMes.length > 0) {
                    const aprobadasMes = evaluacionesMes.filter(e => parseFloat(e.notaFinal) >= 70).length;
                    $('#evaluacion-mes-dashboard').text(((aprobadasMes / evaluacionesMes.length) * 100).toFixed(2) + '%');
                } else {
                    $('#evaluacion-mes-dashboard').text('0.00%');
                }
            } else {
                $('#disciplina-mes-dashboard').text('0.00%');
                $('#evaluacion-mes-dashboard').text('0.00%');
            }


            const ultimosIngresos = [...colaboradoresIngresos].sort((a, b) => new Date(b.fechaInicio) - new Date(a.fechaInicio)).slice(0, 5);
            const tablaUltimosIngresos = $('#tabla-ultimos-ingresos tbody').empty();
            ultimosIngresos.forEach(ing => tablaUltimosIngresos.append(`<tr><td>${formatearFecha(ing.fechaInicio)}</td><td>${ing.nombre}</td><td>${ing.identidad}</td><td>${formatearFecha(ing.fechaNacimiento)}</td><td>${ing.sexo}</td></tr>`));
            const ultimosEgresos = [...colaboradoresEgresos].sort((a, b) => new Date(b.fechaEgreso) - new Date(a.fechaEgreso)).slice(0, 5);
            const tablaUltimosEgresos = $('#tabla-ultimos-egresos tbody').empty();
            ultimosEgresos.forEach(eg => tablaUltimosEgresos.append(`<tr><td>${formatearFecha(eg.fechaEgreso)}</td><td>${eg.nombre}</td><td>${eg.identidad}</td><td>${eg.razon}</td></tr>`));
        }

function mostrarColaboradoresActivos() {
    const tablaActivosBody = $('#tabla-activos tbody').empty();
    const gridActivosContainer = $('#grid-activos').empty();

    // --- INICIO DE MODIFICACIÓN: Ordenar alfabéticamente ---
    // Crear una copia ordenada del array antes de iterar
    const colaboradoresOrdenados = [...colaboradoresActivos].sort((a, b) => a.nombre.localeCompare(b.nombre));
    // --- FIN DE MODIFICACIÓN ---

    // Usar colaboradoresOrdenados en lugar de colaboradoresActivos
    colaboradoresOrdenados.forEach((col, index) => { // 'index' ya no corresponde al original, cuidado si se usa

        let filaClase = 'no-hover';
        let fotoPendienteHtml = `<i class="fas fa-user-circle"></i>`; // Icono por defecto tarjeta
        if (!col.fotoUrl || col.fotoUrl.trim() === '') {
            filaClase = 'no-hover fila-incompleta';
        }

        // --- Generar Fila de Tabla ---
        // IMPORTANTE: Los data-index ya no son útiles aquí si la lista está ordenada.
        // Usaremos data-identidad en su lugar para buscar al editar/eliminar.
        tablaActivosBody.append(`
            <tr class="${filaClase}" data-identidad="${col.identidad}">
                <td>${formatearFecha(col.fechaInicio)}</td>
                <td>${col.nombre}</td>
                <td>${col.identidad}</td>
                <td>${formatearFecha(col.fechaNacimiento)}</td>
                <td>${col.sexo}</td>
                <td>
                    <button class="btn btn-secondary btn-sm btn-action btn-historial" data-identidad="${col.identidad}" title="Ver Historial"><i class="fas fa-history"></i></button>
                    <button class="btn btn-info btn-sm btn-action btn-photo" data-identidad="${col.identidad}" title="Ver Foto"><i class="fas fa-camera"></i></button>
                    <button class="btn btn-warning btn-sm btn-action btn-edit" data-identidad="${col.identidad}" title="Editar"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger btn-sm btn-action btn-delete" data-identidad="${col.identidad}" title="Eliminar"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`);

        // --- Generar Tarjeta de Miniatura ---
        const fotoHtml = col.fotoUrl
            ? `<img src="${col.fotoUrl}" alt="${col.nombre}" onerror="this.parentElement.innerHTML = '<i class=\\'fas fa-user-circle\\'></i>';">`
            : fotoPendienteHtml;

        gridActivosContainer.append(`
            <div class="col-lg-2 col-md-3 col-sm-4 col-6 empleado-card-grid-item" data-identidad="${col.identidad}">
                <div class="empleado-card-mini">
                    <div class="img-container">${fotoHtml}</div>
                    <h6>${col.nombre}</h6>
                    <p>${col.identidad}</p>
                    <div class="actions">
                        <button class="btn btn-secondary btn-sm btn-action btn-historial" data-identidad="${col.identidad}" title="Ver Historial"><i class="fas fa-history"></i></button>
                        <button class="btn btn-info btn-sm btn-action btn-photo" data-identidad="${col.identidad}" title="Ver Foto"><i class="fas fa-camera"></i></button>
                        <button class="btn btn-warning btn-sm btn-action btn-edit" data-identidad="${col.identidad}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm btn-action btn-delete" data-identidad="${col.identidad}" title="Eliminar"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>`);
    });

    // Los eventos ya están configurados con delegación en configurarEventos
}





function filtrarActivos() {
    const texto = $('#buscador-activos').val().toLowerCase();

    // Filtrar Tabla
    $('#tabla-activos tbody tr').each(function() {
        const nombre = $(this).find('td:eq(1)').text().toLowerCase();
        const identidad = $(this).find('td:eq(2)').text().toLowerCase();
        $(this).toggle(nombre.includes(texto) || identidad.includes(texto));
    });

    // Filtrar Grid
    $('#grid-activos .empleado-card-grid-item').each(function() {
        const nombre = $(this).find('h6').text().toLowerCase();
        const identidad = $(this).find('p').text().toLowerCase();
        // Usamos .parent() si el filtro aplica a la columna (col-...)
        $(this).toggle(nombre.includes(texto) || identidad.includes(texto));
    });
}

function editarColaborador(index) {
    const colaborador = colaboradoresActivos[index];
    Swal.fire({
        title: 'Editar Colaborador',
        html: `<form id="form-editar-colaborador">
                <div class="mb-3 text-start"><label class="form-label">Fecha de Inicio</label><input type="date" class="form-control" id="editar-fecha-inicio" value="${colaborador.fechaInicio}" required></div>
                <div class="mb-3 text-start"><label class="form-label">Nombre</label><input type="text" class="form-control" id="editar-nombre" value="${colaborador.nombre}" required></div>
                <div class="mb-3 text-start"><label class="form-label">Identidad</label><input type="text" class="form-control" id="editar-identidad" value="${colaborador.identidad}" pattern="\\d{4}-\\d{4}-\\d{5}" required></div>
                <div class="mb-3 text-start"><label class="form-label">Nacimiento</label><input type="date" class="form-control" id="editar-fecha-nacimiento" value="${colaborador.fechaNacimiento || ''}"></div>
                <div class="mb-3 text-start"><label class="form-label">Sexo</label><select class="form-select" id="editar-sexo" required><option value="Masculino" ${colaborador.sexo === 'Masculino' ? 'selected' : ''}>Masculino</option><option value="Femenino" ${colaborador.sexo === 'Femenino' ? 'selected' : ''}>Femenino</option></select></div>
                <div class="mb-3 text-start">
                    <div class="row align-items-center">
                        <div class="col-md-7">
                            <label for="editar-foto" class="form-label">Foto (opcional)</label>
                            <input type="file" class="form-control" id="editar-foto" accept="image/*" onchange="mostrarVistaPreviaEdicion(this)" capture="environment">
                            <div class="form-text">JPG, PNG. Máx 5MB</div>
                            ${colaborador.fotoUrl ? `<div class="mt-2"><small>Foto actual:</small><br><img src="${colaborador.fotoUrl}" style="max-width: 80px; border-radius: 5px;" onerror="this.style.display='none'"></div>` : ''}
                        </div>
                        <div class="col-md-5">
                            <div id="vista-previa-edicion-container" class="vista-previa-container mt-2 mt-md-0 text-center"></div>
                        </div>
                    </div>
                </div>
            </form>`,
        showCancelButton: true, confirmButtonText: 'Guardar', cancelButtonText: 'Cancelar', width: '600px',
        preConfirm: () => {
            const datos = { fechaInicio: $('#editar-fecha-inicio').val(), nombre: $('#editar-nombre').val(), identidad: $('#editar-identidad').val(), fechaNacimiento: $('#editar-fecha-nacimiento').val() || '', sexo: $('#editar-sexo').val(), foto: $('#editar-foto')[0].files[0] };
            if (!datos.fechaInicio || !datos.nombre || !datos.identidad || !datos.sexo) { Swal.showValidationMessage('Complete campos obligatorios'); return false; }
            if (!/^\d{4}-\d{4}-\d{5}$/.test(datos.identidad)) { Swal.showValidationMessage('Formato de identidad incorrecto'); return false; }
            return datos;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            $('#overlay').css('display', 'flex');
            const { foto, ...datosNuevos } = result.value;
            $.post(SCRIPT_URL_ENVIAR, { accion: 'editar_colaborador', colaboradorOriginal: JSON.stringify(colaborador), datosNuevos: JSON.stringify(datosNuevos) }, (response) => {
                if (response === 'Éxito') {
                    if (foto) {
                        subirFoto(datosNuevos, foto, true).then(() => { $('#overlay').hide(); Swal.fire('Éxito', 'Colaborador actualizado.', 'success').then(cargarTodosLosDatos); }).catch(error => { $('#overlay').hide(); Swal.fire('Advertencia', 'Datos actualizados, pero error al subir foto: ' + error, 'warning').then(cargarTodosLosDatos); });
                    } else { $('#overlay').hide(); Swal.fire('Éxito', 'Colaborador actualizado.', 'success').then(cargarTodosLosDatos); }
                } else { $('#overlay').hide(); Swal.fire('Error', 'Error al actualizar: ' + response, 'error'); }
            }).fail(() => { $('#overlay').hide(); Swal.fire('Error', 'Error de conexión.', 'error'); });
        }
    });
}

        
        function eliminarColaborador(index) {
            const colaborador = colaboradoresActivos[index];
            Swal.fire({ title: '¿Está seguro?', text: `¿Desea eliminar a ${colaborador.nombre}?`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Sí, eliminar', cancelButtonText: 'No, cancelar' }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Fecha y Razón de Egreso',
                        html: `<input type="date" class="form-control mb-3" id="fecha-egreso" value="${new Date().toISOString().split('T')[0]}" required>
                            <select id="razon-egreso" class="form-select">
                                <option value="" selected disabled>Seleccione motivo...</option>
                                <option>Fin de Contrato</option>
                                <option>Denegación de Período de Prueba</option>
                                <option>Abandono</option>
                                <option>Renuncia</option>
                                <option>Despido</option>
                            </select>`,
                        showCancelButton: true, confirmButtonText: 'Confirmar Egreso',
                        preConfirm: () => {
                            const fechaEgreso = $('#fecha-egreso').val(), razon = $('#razon-egreso').val();
                            if (!fechaEgreso || !razon) { Swal.showValidationMessage('Complete todos los campos'); return false; }
                            return { fechaEgreso, razon };
                        }
                    }).then((egresoResult) => {
                        if (egresoResult.isConfirmed) {
                            $('#overlay').css('display', 'flex');
                            $.post(SCRIPT_URL_ENVIAR, { accion: 'eliminar_colaborador', colaborador: JSON.stringify(colaborador), ...egresoResult.value }, (response) => {
                                $('#overlay').hide();
                                if (response === 'Éxito') Swal.fire('Éxito', 'Colaborador eliminado.', 'success').then(cargarTodosLosDatos);
                                else Swal.fire('Error', `Error al eliminar: ${response}`, 'error');
                            }).fail(() => { $('#overlay').hide(); Swal.fire('Error', 'Error de conexión.', 'error'); });
                        }
                    });
                }
            });
        }

        function calcularRotacionGeneral() {
            const { porcentaje, egresos } = calcularPorcentajeRotacion(colaboradoresEgresos);
            $('#rotacion-general').text(porcentaje + '%');
            $('#detalle-general').text(egresos + ' egresos');
        }

        function calcularRotacionPeriodos() {
            const hoy = new Date();
            [{ id: 'mes', meses: 0 }, { id: '3meses', meses: 3 }, { id: '6meses', meses: 6 }, { id: '12meses', meses: 12 }].forEach(p => {
                const fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth() - p.meses, 1);
                const egresosPeriodo = colaboradoresEgresos.filter(e => new Date(e.fechaEgreso) >= fechaInicio);
                const { porcentaje, egresos } = calcularPorcentajeRotacion(egresosPeriodo);
                $(`#rotacion-${p.id}`).text(porcentaje + '%');
                $(`#detalle-${p.id}`).text(egresos + ' egresos');
            });
        }

        function calcularPorcentajeRotacion(egresosPeriodo) {
            const totalActivos = colaboradoresActivos.length, totalEgresos = egresosPeriodo.length;
            const porcentaje = (totalActivos + totalEgresos > 0) ? (totalEgresos / (totalActivos + totalEgresos)) * 100 : 0;
            return { porcentaje: porcentaje.toFixed(2), egresos: totalEgresos };
        }

        function calcularRotacionPersonalizado() {
            const inicio = $('#fecha-inicio-personalizado').val(), fin = $('#fecha-fin-personalizado').val();
            let egresosPeriodo = colaboradoresEgresos;
            if (inicio && fin) egresosPeriodo = egresosPeriodo.filter(e => e.fechaEgreso >= inicio && e.fechaEgreso <= fin);
            else if (inicio) egresosPeriodo = egresosPeriodo.filter(e => e.fechaEgreso >= inicio);
            else if (fin) egresosPeriodo = egresosPeriodo.filter(e => e.fechaEgreso <= fin);
            mostrarEgresos(egresosPeriodo);
        }

function mostrarEgresos(egresos) {
    const tablaEgresos = $('#tabla-egresos').empty();
    
    // --- MODIFICACIÓN: Colspan cambiado de 5 a 4 ---
    if (egresos.length === 0) { 
        tablaEgresos.append('<tr><td colspan="4" class="text-center">No hay egresos que mostrar.</td></tr>'); 
        return; 
    }
    
    [...egresos].sort((a, b) => new Date(b.fechaEgreso) - new Date(a.fechaEgreso)).forEach(e => {
        // --- MODIFICACIÓN: Se eliminó la última celda (<td>...</td>) que contenía las acciones ---
        tablaEgresos.append(`<tr data-identidad="${e.identidad}" data-fechaegreso="${e.fechaEgreso}"><td>${formatearFecha(e.fechaEgreso)}</td><td>${e.nombre}</td><td>${e.identidad}</td><td>${e.razon}</td></tr>`);
    });
    
    // --- MODIFICACIÓN: Se eliminó el event listener para '.btn-photo-egreso' ---
    // (La función .off('click').on('click'...) que estaba aquí se ha borrado)
}



        function filtrarEgresos() {
            const texto = $('#buscador-egresos').val().toLowerCase();
            $('#tabla-egresos tr').each(function() {
                const nombre = $(this).find('td:eq(1)').text().toLowerCase(), id = $(this).find('td:eq(2)').text().toLowerCase(), motivo = $(this).find('td:eq(3)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto) || id.includes(texto) || motivo.includes(texto));
            });
        }
        
        function actualizarVencimientosContrato() {
            const containerPorVencer = $('#contenedor-vencimientos');
            const containerVencidos = $('#contenedor-contratos-vencidos');
            containerPorVencer.empty();
            containerVencidos.empty();

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            const limite30Dias = new Date();
            limite30Dias.setDate(hoy.getDate() + 30);

            let empleadosPorVencer = [];
            let empleadosVencidos = [];

            colaboradoresActivos.forEach(col => {
                const fechaInicio = new Date(col.fechaInicio + 'T00:00:00');
                const fechaVencimiento = new Date(fechaInicio);
                fechaVencimiento.setMonth(fechaInicio.getMonth() + 6);
                fechaVencimiento.setDate(fechaVencimiento.getDate() - 1); // Restar un día

                const diasRestantes = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));

                if (diasRestantes < 0) {
                    empleadosVencidos.push({ ...col, fechaVencimiento, diasRestantes });
                } else if (diasRestantes <= 30) {
                    empleadosPorVencer.push({ ...col, fechaVencimiento, diasRestantes });
                }
            });

            // Ordenar listas
            empleadosPorVencer.sort((a, b) => a.diasRestantes - b.diasRestantes);
            empleadosVencidos.sort((a, b) => a.diasRestantes - b.diasRestantes); // De más antiguo a más reciente

            // Popular "Por Vencer"
            if (empleadosPorVencer.length === 0) {
                containerPorVencer.html('<div class="text-center p-3 text-success"><i class="fas fa-check-circle fa-2x mb-2"></i><p class="mb-0">¡Todo en orden! Ningún contrato vence en los próximos 30 días.</p></div>');
            } else {
                let listHtml = '';
                empleadosPorVencer.forEach(item => {
                    let color = 'bg-info text-dark';
                    if (item.diasRestantes <= 7) color = 'bg-danger';
                    else if (item.diasRestantes <= 15) color = 'bg-warning text-dark';
                    
                    const fotoSrc = item.fotoUrl || `https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random`;
                    listHtml += `
                        <div class="resumen-disciplina-item" data-identidad="${item.identidad}" style="cursor: pointer;">
                            <img src="${fotoSrc}" class="resumen-disciplina-img" onerror="this.src='https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random'">
                            <div class="resumen-disciplina-info">
                                <h6>${item.nombre}</h6>
                                <p class="mb-0 small"><strong>Vence:</strong> ${formatearFecha(item.fechaVencimiento.toISOString().split('T')[0])}</p>
                            </div>
                            <span class="badge ${color}">${item.diasRestantes} día(s) restante(s)</span>
                        </div>`;
                });
                containerPorVencer.html(listHtml);
            }

            // Popular "Vencidos"
            if (empleadosVencidos.length === 0) {
                containerVencidos.html('<div class="text-center p-3 text-muted"><i class="fas fa-info-circle fa-2x mb-2"></i><p class="mb-0">No hay contratos vencidos pendientes de acción.</p></div>');
            } else {
                let listHtml = '';
                empleadosVencidos.forEach(item => {
                    const fotoSrc = item.fotoUrl || `https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random`;
                    listHtml += `
                        <div class="resumen-disciplina-item" data-identidad="${item.identidad}" style="cursor: pointer;">
                            <img src="${fotoSrc}" class="resumen-disciplina-img" onerror="this.src='https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random'">
                            <div class="resumen-disciplina-info">
                                <h6>${item.nombre}</h6>
                                <p class="mb-0 small"><strong>Venció:</strong> ${formatearFecha(item.fechaVencimiento.toISOString().split('T')[0])}</p>
                            </div>
                            <span class="badge bg-danger">Vencido (${Math.abs(item.diasRestantes)} día(s))</span>
                        </div>`;
                });
                containerVencidos.html(listHtml);
            }
        }


        function filtrarVencimientos() {
            const texto = $('#buscador-vencimientos').val().toLowerCase();
            $('#contenedor-vencimientos .resumen-disciplina-item, #contenedor-contratos-vencidos .resumen-disciplina-item').each(function() {
                const nombre = $(this).find('h6').text().toLowerCase();
                const identidad = $(this).data('identidad').toLowerCase();
                $(this).toggle(nombre.includes(texto) || identidad.includes(texto));
            });
        }
        
function mostrarColaboradoresEgresados() {
    const tablaEgresados = $('#tabla-colaboradores-egresados').empty();
    if (colaboradoresEgresos.length === 0) {
        tablaEgresados.append('<tr><td colspan="5" class="text-center">No hay colaboradores egresados.</td></tr>');
        return;
    }

    [...colaboradoresEgresos].sort((a,b) => new Date(b.fechaEgreso) - new Date(a.fechaEgreso)).forEach(egreso => {
        // --- INICIO DE MODIFICACIÓN ---
        // Se eliminó la condición (egreso.fotoUrl ? ... : '').
        // Ahora, el botón de foto se crea siempre.
        const fotoButtonHtml = `<button class="btn btn-info btn-sm btn-action btn-photo-egresado" data-identidad="${egreso.identidad}" data-fechaegreso="${egreso.fechaEgreso}" title="Ver Foto"><i class="fas fa-camera"></i></button>`;

        const fila = `
            <tr data-identidad="${egreso.identidad}">
                <td>${formatearFecha(egreso.fechaEgreso)}</td>
                <td>${egreso.nombre}</td>
                <td>${egreso.identidad}</td>
                <td>${egreso.razon}</td>
                <td>
                    ${fotoButtonHtml} <button class="btn btn-secondary btn-sm btn-action btn-historial-egresado" title="Ver Historial"><i class="fas fa-history"></i></button>
                    <button class="btn btn-success btn-sm btn-action btn-reingreso" title="Reingresar Colaborador"><i class="fas fa-user-plus"></i></button>
                </td>
            </tr>`;
        // --- FIN DE MODIFICACIÓN ---
        tablaEgresados.append(fila);
    });
    
    // Evento para el botón de historial (existente)
    $('.btn-historial-egresado').on('click', function(e) {
        e.stopPropagation();
        const identidad = $(this).closest('tr').data('identidad');
        mostrarDetalleEgresado(identidad);
    });

    // Evento para el botón de reingreso (existente)
    $('.btn-reingreso').on('click', function(e) {
        e.stopPropagation();
        const identidad = $(this).closest('tr').data('identidad');
        const egresado = colaboradoresEgresos.find(e => e.identidad === identidad);
        if (egresado) reingresarColaborador(egresado);
    });
    
    // Evento para el botón de foto (existente, sin cambios)
    $('.btn-photo-egresado').on('click', function(e) {
        e.stopPropagation();
        const row = $(this).closest('tr');
        const id = row.data('identidad');
        // Usamos la fecha de egreso para asegurar que sea el registro correcto
        const fecha = $(this).data('fechaegreso'); 
        const egresoData = colaboradoresEgresos.find(e => e.identidad === id && e.fechaEgreso === fecha);
        if(egresoData) mostrarFoto(egresoData);
    });
}

        
        function filtrarEgresadosTabla() {
            const texto = $('#buscador-egresados-tabla').val().toLowerCase();
            $('#tabla-colaboradores-egresados tr').each(function() {
                const nombre = $(this).find('td:eq(1)').text().toLowerCase();
                const identidad = $(this).find('td:eq(2)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto) || identidad.includes(texto));
            });
        }
        
        function mostrarDetalleEgresado(identidad) {
            mostrarDetalleColaboradorCompleto(identidad, true);
        }
        
        // Función unificada para mostrar historial (activos y egresados)
        function mostrarDetalleColaboradorCompleto(identidad, esEgresado = false) {
            const colaborador = esEgresado 
                ? colaboradoresEgresos.find(c => c.identidad === identidad)
                : colaboradoresActivos.find(c => c.identidad === identidad);
            
            if (!colaborador) return;

            const historialAusencias = ausencias.filter(d => d.identidad === identidad).sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            const historialDisciplina = disciplina.filter(d => d.identidad === identidad).sort((a,b) => new Date(b.fechaFalta) - new Date(a.fechaFalta));
            const historialEvaluaciones = evaluaciones.filter(d => d.identidad === identidad).sort((a,b) => new Date(a.fechaEvaluacion) - new Date(b.fechaEvaluacion));

            let historialHtml = '<div style="max-height: 400px; overflow-y: auto; text-align: left;">';

            historialHtml += '<h5><i class="fas fa-clock me-2"></i>Historial de Ausencias</h5>';
            if (historialAusencias.length > 0) {
                historialHtml += '<ul>';
                historialAusencias.forEach(a => {
                    historialHtml += `<li>${formatearFecha(a.fecha)} (${a.diasIncapacidad || 1} día(s)): ${a.motivo}</li>`;
                });
                historialHtml += '</ul>';
            } else {
                historialHtml += '<p class="text-muted small">Sin ausencias registradas.</p>';
            }

            historialHtml += '<h5 class="mt-3"><i class="fas fa-gavel me-2"></i>Historial de Disciplina</h5>';
            if (historialDisciplina.length > 0) {
                historialHtml += '<ul>';
                historialDisciplina.forEach(d => {
                    historialHtml += `<li>${formatearFecha(d.fechaFalta)}: ${d.descripcionFaltas}</li>`;
                });
                historialHtml += '</ul>';
            } else {
                historialHtml += '<p class="text-muted small">Sin acciones disciplinarias registradas.</p>';
            }

            historialHtml += '<h5 class="mt-3"><i class="fas fa-chart-bar me-2"></i>Historial de Evaluaciones</h5>';
            if (historialEvaluaciones.length > 0) {
                 historialHtml += '<div class="chart-container" style="height: 250px;"><canvas id="graficoProgresoCompleto"></canvas></div>';
                 historialEvaluaciones.forEach(reg => { // De más reciente a más antigua
                    const hasInfo = reg.observaciones || reg.compromiso || reg.recomendaciones;
                    const aspectosMejorarHtml = generarHtmlAspectosMejorar(reg);
                    historialHtml += `
                        <div class="evaluacion-detalle-item">
                            <h6><i class="fas fa-calendar-alt me-2"></i>Evaluación del ${formatearFecha(reg.fechaEvaluacion)} (Nota: ${reg.notaFinal})</h6>`;
                    if (hasInfo) {
                        historialHtml += `
                            ${reg.observaciones ? `<p><strong>Observaciones:</strong> ${reg.observaciones}</p>` : ''}
                            ${reg.compromiso ? `<p><strong>Compromiso de Mejora:</strong> ${reg.compromiso}</p>` : ''}
                            ${reg.recomendaciones ? `<p><strong>Recomendaciones:</strong> ${reg.recomendaciones}</p>` : ''}`;
                    }
                    historialHtml += aspectosMejorarHtml;
                    if (!hasInfo && !aspectosMejorarHtml) {
                        historialHtml += `<p class="no-info">No se especificó información adicional.</p>`;
                    }
                    historialHtml += '</div>';
                });
            } else {
                historialHtml += '<p class="text-muted small">Sin evaluaciones registradas.</p>';
            }
            historialHtml += '</div>';
            
            const fotoSrc = colaborador.fotoUrl || `https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random`;
            let infoHeader = esEgresado ?
                `<p class="mt-2">Fecha de Egreso: <strong>${formatearFecha(colaborador.fechaEgreso)}</strong><br>Razón: <strong>${colaborador.razon}</strong></p>` :
                `<p class="mt-2">Fecha de Inicio: <strong>${formatearFecha(colaborador.fechaInicio)}</strong></p>`;

            const detailModalHtml = `
                <div class="text-center mb-3">
                    <img src="${fotoSrc}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #dee2e6;" onerror="this.src='https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random'">
                    <h5 class="mt-2 mb-0">${colaborador.nombre}</h5>
                    <span class="badge bg-secondary">${colaborador.identidad}</span>
                    ${infoHeader}
                </div>
                ${historialHtml}
            `;

            Swal.fire({
                title: 'Historial del Colaborador',
                html: detailModalHtml,
                width: '800px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    if (historialEvaluaciones.length > 0) {
                        const ctx = document.getElementById('graficoProgresoCompleto').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: [...historialEvaluaciones].sort((a,b) => new Date(a.fechaEvaluacion) - new Date(b.fechaEvaluacion)).map(e => formatearFecha(e.fechaEvaluacion)),
                                datasets: [{
                                    label: 'Nota Final',
                                    data: [...historialEvaluaciones].sort((a,b) => new Date(a.fechaEvaluacion) - new Date(b.fechaEvaluacion)).map(e => e.notaFinal),
                                    borderColor: '#3498db',
                                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                                    fill: true,
                                    tension: 0.1
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                        });
                    }
                }
            });
        }
        
        function reingresarColaborador(colaborador) {
            Swal.fire({
                title: 'Reingresar Colaborador',
                text: `¿Está seguro que desea reingresar a ${colaborador.nombre}?`,
                icon: 'question',
                html: `<p>Por favor, confirme la nueva fecha de inicio para ${colaborador.nombre}.</p>
                       <input type="date" id="fecha-reingreso" class="form-control mt-2" value="${new Date().toISOString().split('T')[0]}">`,
                showCancelButton: true,
                confirmButtonText: 'Sí, reingresar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const fechaReingreso = document.getElementById('fecha-reingreso').value;
                    if (!fechaReingreso) {
                        Swal.showValidationMessage('Por favor, seleccione una fecha de reingreso.');
                        return false;
                    }
                    return fechaReingreso;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#overlay').css('display', 'flex');
                    $.post(SCRIPT_URL_ENVIAR, {
                        accion: 'reingresar_colaborador',
                        colaborador: JSON.stringify(colaborador),
                        fechaReingreso: result.value
                    }, function(response) {
                        $('#overlay').hide();
                        if (response === 'Éxito') {
                            Swal.fire('¡Éxito!', `${colaborador.nombre} ha sido reingresado.`, 'success').then(() => {
                                cargarTodosLosDatos();
                            });
                        } else {
                            Swal.fire('Error', 'Hubo un problema al reingresar: ' + response, 'error');
                        }
                    }).fail(() => {
                        $('#overlay').hide();
                        Swal.fire('Error', 'Error de conexión al reingresar.', 'error');
                    });
                }
            });
        }


function mostrarAusencias(datos) {
    const datosAMostrar = datos || ausencias;
    const tablaAusencias = $('#tabla-ausencias').empty();
    if (datosAMostrar.length === 0) { 
        // MODIFICACIÓN: Colspan cambiado de 7 a 8
        tablaAusencias.append('<tr><td colspan="8" class="text-center">No hay ausencias para el filtro seleccionado.</td></tr>'); 
        return; 
    }
    [...datosAMostrar].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(a => {
        // MODIFICACIÓN: Añadir celda de Acciones y botón
        tablaAusencias.append(`
            <tr class="no-hover">
                <td>${formatearFecha(a.fecha)}</td>
                <td>${formatearFecha(a.fechaFin || a.fecha)}</td>
                <td>${a.nombre}</td>
                <td>${a.identidad}</td>
                <td>${a.motivo}</td>
                <td>${a.diasIncapacidad || 1}</td>
                <td>${a.observaciones || ''}</td>
                <td>
                    <button class="btn btn-warning btn-sm btn-action btn-edit-ausencia" 
                            data-identidad="${a.identidad}" 
                            data-fecha="${a.fecha}" 
                            title="Editar Ausencia">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>`);
    });
    // El event listener se manejará en configurarEventos
}



        function filtrarAusencias() {
            const texto = $('#buscador-ausencias').val().toLowerCase();
            $('#tabla-ausencias tr').each(function() {
                const nombre = $(this).find('td:eq(2)').text().toLowerCase(), id = $(this).find('td:eq(3)').text().toLowerCase(), motivo = $(this).find('td:eq(4)').text().toLowerCase(), obs = $(this).find('td:eq(6)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto) || id.includes(texto) || motivo.includes(texto) || obs.includes(texto));
            });
        }

        // --- INICIO FUNCIONES PARA DISCIPLINA ---
function mostrarHistorialDisciplina(datos) {
    const datosAMostrar = datos || disciplina;
    const tablaDisciplina = $('#tabla-disciplina').empty();
    if (datosAMostrar.length === 0) {
        tablaDisciplina.append('<tr><td colspan="5" class="text-center">No hay registros de disciplina para el filtro seleccionado.</td></tr>');
        return;
    }
    const disciplinaOrdenada = [...datosAMostrar].sort((a, b) => new Date(b.fechaFalta) - new Date(a.fechaFalta));

    disciplinaOrdenada.forEach((registro) => {
        const faltasLista = registro.descripcionFaltas.split('; ').map(falta => `<li>${falta}</li>`).join('');
        tablaDisciplina.append(`
            <tr>
                <td>${formatearFecha(registro.fechaFalta)}</td>
                <td>${registro.nombre}</td>
                <td>${registro.identidad}</td>
                <td><ul>${faltasLista}</ul></td>
                <td>${registro.observaciones}</td>
            </tr>`);
    });
}

        
        function mostrarResumenDisciplina() {
            if (disciplina.length === 0) {
                Swal.fire('Sin Datos', 'No hay acciones disciplinarias registradas para mostrar un resumen.', 'info');
                return;
            }

            const conteo = {};
            disciplina.forEach(reg => {
                // Solo contar si el colaborador está activo
                if (colaboradoresActivos.some(activo => activo.identidad === reg.identidad)) {
                    if (!conteo[reg.identidad]) {
                        const colaboradorInfo = colaboradoresActivos.find(c => c.identidad === reg.identidad);
                        conteo[reg.identidad] = {
                            nombre: colaboradorInfo.nombre,
                            identidad: colaboradorInfo.identidad,
                            fotoUrl: colaboradorInfo.fotoUrl,
                            count: 0
                        };
                    }
                    conteo[reg.identidad].count++;
                }
            });

            const sorted = Object.values(conteo).sort((a, b) => b.count - a.count);
            
            const modalHtml = `
                <div class="mb-3 px-2">
                    <input type="text" id="filtro-resumen-disciplina" class="form-control" placeholder="Buscar por nombre o identidad...">
                </div>
                <div id="resumen-lista-colaboradores" style="max-height: 400px; overflow-y: auto; text-align: left;">
                </div>`;

            function renderResumenList(items) {
                const container = $('#resumen-lista-colaboradores');
                container.empty();
                if (items.length === 0) {
                    container.html('<p class="text-center text-muted mt-3">No se encontraron colaboradores activos con acciones disciplinarias.</p>');
                    return;
                }
                let listHtml = '';
                items.forEach(item => {
                    let color;
                    if (item.count === 1) color = "info";
                    else if (item.count === 2) color = "warning";
                    else if (item.count >= 3) color = "danger";
                    
                    const fotoSrc = item.fotoUrl || `https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random`;
                    listHtml += `
                        <div class="resumen-disciplina-item" data-identidad="${item.identidad}" style="cursor: pointer;">
                            <img src="${fotoSrc}" class="resumen-disciplina-img" onerror="this.src='https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random'">
                            <div class="resumen-disciplina-info">
                                <h6>${item.nombre}</h6>
                                <span class="badge bg-${color}">${item.count} Acción(es)</span>
                            </div>
                        </div>`;
                });
                container.html(listHtml);
            }

            Swal.fire({
                title: 'Resumen por Colaborador Activo',
                html: modalHtml,
                width: '700px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    renderResumenList(sorted);
                    $('#filtro-resumen-disciplina').on('input', function() {
                        const query = $(this).val().toLowerCase();
                        const filtered = sorted.filter(item =>
                            item.nombre.toLowerCase().includes(query) || item.identidad.toLowerCase().includes(query)
                        );
                        renderResumenList(filtered);
                    });

                    $(document).on('click', '.resumen-disciplina-item', function() {
                        const identidad = $(this).data('identidad');
                        mostrarDetalleDisciplinaColaborador(identidad);
                    });
                },
                willClose: () => {
                    $(document).off('click', '.resumen-disciplina-item');
                }
            });
        }

        function mostrarDetalleDisciplinaColaborador(identidad) {
            const historial = disciplina.filter(d => d.identidad === identidad).sort((a,b) => new Date(b.fechaFalta) - new Date(a.fechaFalta));
            const colaborador = colaboradoresActivos.find(c => c.identidad === identidad) || { nombre: 'N/A', identidad: identidad, fotoUrl: '' };

            let historialHtml = '<div style="max-height: 300px; overflow-y: auto; text-align: left; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">';
            if (historial.length > 0) {
                historial.forEach((reg, index) => {
                    historialHtml += `
                        <div class="mb-2">
                            <strong>${formatearFecha(reg.fechaFalta)}:</strong>
                            <ul class="mb-1 mt-1">
                                ${reg.descripcionFaltas.split('; ').map(f => `<li>${f}</li>`).join('')}
                            </ul>
                            ${reg.observaciones ? `<small class="d-block text-muted"><em>Observación: ${reg.observaciones}</em></small>` : ''}
                        </div>
                        ${index < historial.length - 1 ? '<hr class="my-2">' : ''}
                    `;
                });
            } else {
                historialHtml += '<p class="text-center text-muted">No se encontraron registros.</p>';
            }
            historialHtml += '</div>';
            
            const fotoSrc = colaborador.fotoUrl || `https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random`;
            const detailModalHtml = `
                <div class="d-flex justify-content-start mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-volver-resumen">
                        <i class="fas fa-arrow-left me-1"></i> Volver al Resumen
                    </button>
                </div>
                <div class="text-center mb-3">
                    <img src="${fotoSrc}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #dee2e6;" onerror="this.src='https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random'">
                    <h5 class="mt-2 mb-0">${colaborador.nombre}</h5>
                    <span class="badge bg-secondary">${colaborador.identidad}</span>
                    <p class="mt-2">Total de acciones: <strong>${historial.length}</strong></p>
                </div>
                ${historialHtml}
            `;

            Swal.fire({
                title: 'Detalle de Faltas',
                html: detailModalHtml,
                width: '600px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    const volverBtn = Swal.getPopup().querySelector('#btn-volver-resumen');
                    if (volverBtn) {
                        volverBtn.addEventListener('click', () => {
                            Swal.close();
                            mostrarResumenDisciplina();
                        });
                    }
                }
            });
        }

        function filtrarDisciplina() {
            const texto = $('#buscador-disciplina').val().toLowerCase();
            $('#tabla-disciplina tr').each(function() {
                const nombre = $(this).find('td:eq(1)').text().toLowerCase(), identidad = $(this).find('td:eq(2)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto) || identidad.includes(texto));
            });
        }
        
        function calcularEstadisticasDisciplina() {
            const totalActivos = colaboradoresActivos.length;
            if (totalActivos === 0 && disciplina.length === 0) {
                 $('.rotacion-periodos .porcentaje').text('0%');
                 return;
            }

            const hoy = new Date();
            const periodos = [{ id: 'mes', meses: 0 }, { id: '3meses', meses: 3 }, { id: '6meses', meses: 6 }, { id: '12meses', meses: 12 }];
            periodos.forEach(p => {
                const fechaInicio = p.meses === 0 ? new Date(hoy.getFullYear(), hoy.getMonth(), 1) : new Date(hoy.getFullYear(), hoy.getMonth() - p.meses, 1);
                const accionesPeriodo = disciplina.filter(d => new Date(d.fechaFalta) >= fechaInicio).length;
                const porcentaje = totalActivos > 0 ? ((accionesPeriodo / totalActivos) * 100).toFixed(2) : '0.00';
                $(`#disciplina-${p.id}`).text(porcentaje + '%');
            });
            
            const totalAccionesHistorico = disciplina.length;
            const porcentajeHistorico = totalActivos > 0 ? ((totalAccionesHistorico / totalActivos) * 100).toFixed(2) : '0.00';
            $('#disciplina-historico').text(porcentajeHistorico + '%');
        }

        function crearGraficoDisciplinaPorDia(ano, mes) {
            if (graficoDisciplinaPorDia) graficoDisciplinaPorDia.destroy();
            const ctx = document.getElementById('graficoDisciplinaPorDia').getContext('2d');
            const diasEnMes = new Date(ano, mes + 1, 0).getDate();
            const labels = Array.from({ length: diasEnMes }, (_, i) => `${i + 1}/${mes + 1}`);
            const datos = Array(diasEnMes).fill(0);

            disciplina.forEach(d => {
                const fechaFalta = new Date(d.fechaFalta + 'T00:00:00');
                if (fechaFalta.getMonth() === mes && fechaFalta.getFullYear() === ano) {
                    datos[fechaFalta.getDate() - 1]++;
                }
            });
            
            const nombreMes = new Date(ano, mes).toLocaleString('es-ES', { month: 'long' });
            graficoDisciplinaPorDia = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: `Acciones por día en ${nombreMes} ${ano}`, data: datos, borderColor: '#c0392b', backgroundColor: 'rgba(192, 57, 43, 0.1)', fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }
        
        function crearGraficoDisciplinaMotivo(canvasId, targetData) {
             const conteo = {};
             targetData.forEach(reg => {
                reg.descripcionFaltas.split('; ').forEach(falta => {
                    if(falta) conteo[falta] = (conteo[falta] || 0) + 1;
                });
             });
             const labels = Object.keys(conteo);
             const data = Object.values(conteo);
             
             const ctx = document.getElementById(canvasId).getContext('2d');
             return new Chart(ctx, {
                type: 'pie',
                data: { labels, datasets: [{ data, backgroundColor: ['#e74c3c', '#f1c40f', '#3498db', '#9b59b6', '#2ecc71', '#e67e22', '#1abc9c', '#2c3e50', '#7f8c8d'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Distribución por Motivo' } } }
            });
        }

        function crearGraficoDisciplinaMotivoActual() {
            if (graficoDisciplinaMotivoActual) graficoDisciplinaMotivoActual.destroy();
            const hoy = new Date(), mesActual = hoy.getMonth(), anoActual = hoy.getFullYear();
            const datosMes = disciplina.filter(d => {
                const fecha = new Date(d.fechaFalta + 'T00:00:00');
                return fecha.getMonth() === mesActual && fecha.getFullYear() === anoActual;
            });
            graficoDisciplinaMotivoActual = crearGraficoDisciplinaMotivo('graficoDisciplinaMotivoActual', datosMes);
            graficoDisciplinaMotivoActual.options.plugins.title.text = 'Distribución (Mes Actual)';
            graficoDisciplinaMotivoActual.update();
        }

        function crearGraficoDisciplinaMotivoHistorico() {
            if (graficoDisciplinaMotivoHistorico) graficoDisciplinaMotivoHistorico.destroy();
            graficoDisciplinaMotivoHistorico = crearGraficoDisciplinaMotivo('graficoDisciplinaMotivoHistorico', disciplina);
            graficoDisciplinaMotivoHistorico.options.plugins.title.text = 'Distribución (Histórica)';
            graficoDisciplinaMotivoHistorico.update();
        }

        function crearGraficoDisciplinaMotivoFiltrado(ano, mes) {
            if (graficoDisciplinaMotivoFiltrado) graficoDisciplinaMotivoFiltrado.destroy();
            const datosFiltrados = disciplina.filter(d => {
                const fecha = new Date(d.fechaFalta + 'T00:00:00');
                return fecha.getMonth() === mes && fecha.getFullYear() === ano;
            });
            graficoDisciplinaMotivoFiltrado = crearGraficoDisciplinaMotivo('graficoDisciplinaMotivoFiltrado', datosFiltrados);
            const nombreMes = new Date(ano, mes).toLocaleString('es-ES', { month: 'long' });
            graficoDisciplinaMotivoFiltrado.options.plugins.title.text = `Distribución (${nombreMes} ${ano})`;
            graficoDisciplinaMotivoFiltrado.update();
        }
        
function calcularEstadisticasAusencias() {
    const hoy = new Date();
    const periodos = [{ id: 'mes', meses: 0 }, { id: '3meses', meses: 3 }, { id: '6meses', meses: 6 }, { id: '12meses', meses: 12 }];
    
    periodos.forEach(p => {
        const fechaFinPeriodo = new Date(hoy);
        const fechaInicioPeriodo = (p.meses === 0) 
            ? new Date(hoy.getFullYear(), hoy.getMonth(), 1) 
            : new Date(hoy.getFullYear(), hoy.getMonth() - p.meses + 1, 1);
        
        let diasAusentePeriodo = 0;
        ausencias.forEach(a => { 
            const fechaAusenciaInicio = new Date(a.fecha + 'T00:00:00');
            const fechaAusenciaFin = new Date((a.fechaFin || a.fecha) + 'T00:00:00');
            
            for (let d = new Date(fechaAusenciaInicio); d <= fechaAusenciaFin; d.setDate(d.getDate() + 1)) {
                if (d >= fechaInicioPeriodo && d <= fechaFinPeriodo) {
                    diasAusentePeriodo++; 
                }
            }
        });
        
        const diasLaborablesPosibles = colaboradoresActivos.length * 22 * (p.meses === 0 ? 1 : p.meses);
        const porcentaje = diasLaborablesPosibles > 0 ? ((diasAusentePeriodo / diasLaborablesPosibles) * 100).toFixed(2) : '0.00';
        $(`#ausentismo-${p.id}`).text(porcentaje + '%');
        if(p.id === 'mes') $('#ausentismo-mes-dashboard').text(porcentaje + '%');
    });

    // --- LÓGICA HISTÓRICA CORREGIDA ---
    let totalDiasAusenciasHistorico = 0;
    ausencias.forEach(a => { 
        totalDiasAusenciasHistorico += (a.diasIncapacidad || 1); 
    });

    // Construir una lista maestra de todos los que han sido contratados (activos + egresados)
    // Asumimos que 'activos' y 'egresados' son listas distintas.
    const todosLosEmpleadosHistorial = [...colaboradoresActivos];
    colaboradoresEgresos.forEach(eg => {
        if (!todosLosEmpleadosHistorial.some(act => act.identidad === eg.identidad)) {
            // Asegurarnos que el egresado tiene fecha de inicio, si no, no podemos calcular
            if (eg.fechaInicio) {
                todosLosEmpleadosHistorial.push(eg);
            }
        }
    });

    let totalDiasLaborablesPosiblesHistorico = 0;
    
    todosLosEmpleadosHistorial.forEach(col => {
        const fechaInicio = new Date(col.fechaInicio + 'T00:00:00');
        // El 'egreso' solo aplica a los de la lista de 'colaboradoresEgresos'
        const egreso = colaboradoresEgresos.find(e => e.identidad === col.identidad);
        let fechaFin = egreso ? new Date(egreso.fechaEgreso + 'T00:00:00') : new Date(hoy);

        if (fechaFin > hoy) fechaFin = new Date(hoy);

        if (fechaFin >= fechaInicio) {
            let mesesDeTrabajo = (fechaFin.getFullYear() - fechaInicio.getFullYear()) * 12 - fechaInicio.getMonth() + fechaFin.getMonth();
            totalDiasLaborablesPosiblesHistorico += (mesesDeTrabajo < 0 ? 0 : mesesDeTrabajo + 1) * 22;
        }
    });

    $('#ausentismo-historico').text(totalDiasLaborablesPosiblesHistorico > 0 ? ((totalDiasAusenciasHistorico / totalDiasLaborablesPosiblesHistorico) * 100).toFixed(2) + '%' : '0.00%');
}


        function popularFiltrosGrafico(mesSelector, anoSelector, datos, fechaKey = 'fecha') {
            const filtroMes = $(mesSelector), filtroAno = $(anoSelector);
            filtroMes.empty(); filtroAno.empty();
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            meses.forEach((mes, i) => filtroMes.append(`<option value="${i}">${mes}</option>`));
            const anos = [...new Set(datos.map(d => d[fechaKey] ? new Date(d[fechaKey]).getFullYear() : null).filter(Boolean))];
            if (!anos.includes(new Date().getFullYear())) anos.push(new Date().getFullYear());
            anos.sort((a,b) => b-a).forEach(ano => filtroAno.append(`<option value="${ano}">${ano}</option>`));
            const hoy = new Date();
            filtroMes.val(hoy.getMonth());
            filtroAno.val(hoy.getFullYear());
        }

function crearGraficoAusencias(ano, mes) {
    // Destruir gráfico anterior si existe
    const chartInstance = Chart.getChart('graficoAusencias');
    if (chartInstance) {
        chartInstance.destroy();
    }

    const ctx = document.getElementById('graficoAusencias').getContext('2d');
    // Usar UTC para obtener el número de días del mes correctamente
    const diasEnMes = new Date(Date.UTC(ano, mes + 1, 0)).getUTCDate();
    const labels = Array.from({ length: diasEnMes }, (_, i) => `${i + 1}/${mes + 1}`);
    const datosAusentes = Array(diasEnMes).fill(0);

    ausencias.forEach(a => {
        // Crear fechas explícitamente en UTC agregando 'Z' (Zulu time)
        try { // Añadir try-catch por si alguna fecha está mal formateada
            const fechaInicioAbs = new Date(a.fecha + 'T00:00:00Z');
            const fechaFinAbs = new Date((a.fechaFin || a.fecha) + 'T00:00:00Z');

            // Asegurarse que las fechas sean válidas antes de iterar
            if (isNaN(fechaInicioAbs.getTime()) || isNaN(fechaFinAbs.getTime())) {
                console.warn("Fecha inválida encontrada para ausencia:", a);
                return; // Saltar esta ausencia si las fechas no son válidas
            }

            // Iterar usando métodos UTC
            for (let d = new Date(fechaInicioAbs); d <= fechaFinAbs; d.setUTCDate(d.getUTCDate() + 1)) {
                // Comparar usando métodos UTC
                if (d.getUTCMonth() === mes && d.getUTCFullYear() === ano) {
                    // Usar el día UTC para el índice (restando 1 porque es base 0)
                    const dayIndex = d.getUTCDate() - 1;
                    // Comprobación de límites (seguridad extra)
                    if (dayIndex >= 0 && dayIndex < diasEnMes) {
                         datosAusentes[dayIndex]++;
                    }
                }
            }
        } catch (error) {
             console.error("Error procesando fecha de ausencia:", a, error);
        }
    });

    // Usar UTC también para el nombre del mes para consistencia
    const nombreMes = new Date(Date.UTC(ano, mes)).toLocaleString('es-ES', { month: 'long', timeZone: 'UTC' });
    graficoAusencias = new Chart(ctx, { // Reasignar a la variable global
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: `Ausentes por día en ${nombreMes} ${ano}`,
                data: datosAusentes,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });
}

        
function crearGraficoAusenciasMotivo(canvasId, targetData) {
    const conteo = {};
    targetData.forEach(a => { 
        // --- INICIO DE MODIFICACIÓN ---
        // Sumar los días de la ausencia (o 1 si no está definido)
        conteo[a.motivo] = (conteo[a.motivo] || 0) + (parseInt(a.diasIncapacidad) || 1); 
        // --- FIN DE MODIFICACIÓN ---
    });
    const ctx = document.getElementById(canvasId).getContext('2d');
    // Destruir gráfico anterior si existe para evitar solapamientos
    const chartInstance = Chart.getChart(canvasId);
    if (chartInstance) {
        chartInstance.destroy();
    }
    // Crear el nuevo gráfico
    return new Chart(ctx, { 
        type: 'pie', 
        data: { 
            labels: Object.keys(conteo), 
            datasets: [{ 
                data: Object.values(conteo), 
                backgroundColor: ['#3498db', '#f1c40f', '#e74c3c', '#9b59b6', '#2ecc71'] 
            }] 
        }, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'top' }, 
                title: { display: true, text: 'Distribución por Días Ausentes' } // Título ajustado
            } 
        } 
    });
}



        function crearGraficoAusenciasMotivoActual() {
            if (graficoAusenciasMotivoActual) graficoAusenciasMotivoActual.destroy();
            const hoy = new Date(), mesActual = hoy.getMonth(), anoActual = hoy.getFullYear();
            const datosMes = ausencias.filter(a => { const fecha = new Date(a.fecha); return fecha.getMonth() === mesActual && fecha.getFullYear() === anoActual; });
            graficoAusenciasMotivoActual = crearGraficoAusenciasMotivo('graficoAusenciasMotivoActual', datosMes);
            graficoAusenciasMotivoActual.options.plugins.title.text = 'Distribución (Mes Actual)';
            graficoAusenciasMotivoActual.update();
        }

        function crearGraficoAusenciasMotivoHistorico() {
            if (graficoAusenciasMotivoHistorico) graficoAusenciasMotivoHistorico.destroy();
            graficoAusenciasMotivoHistorico = crearGraficoAusenciasMotivo('graficoAusenciasMotivoHistorico', ausencias);
            graficoAusenciasMotivoHistorico.options.plugins.title.text = 'Distribución (Histórica)';
            graficoAusenciasMotivoHistorico.update();
        }
        
        function crearGraficoAusenciasMotivoFiltrado(ano, mes) {
            if (graficoAusenciasMotivoFiltrado) graficoAusenciasMotivoFiltrado.destroy();
            const datosFiltrados = ausencias.filter(a => { const fecha = new Date(a.fecha); return fecha.getMonth() === mes && fecha.getFullYear() === ano; });
            graficoAusenciasMotivoFiltrado = crearGraficoAusenciasMotivo('graficoAusenciasMotivoFiltrado', datosFiltrados);
            graficoAusenciasMotivoFiltrado.options.plugins.title.text = `Distribución (${new Date(ano, mes).toLocaleString('es-ES', { month: 'long' })} ${ano})`;
            graficoAusenciasMotivoFiltrado.update();
        }
        
        // --- INICIO FUNCIONES PARA RESUMEN DE AUSENCIAS ---
        function mostrarResumenAusencias() {
            if (ausencias.length === 0) {
                Swal.fire('Sin Datos', 'No hay ausencias registradas para mostrar un resumen.', 'info');
                return;
            }

            const conteo = {};
            ausencias.forEach(reg => {
                if (colaboradoresActivos.some(activo => activo.identidad === reg.identidad)) {
                    if (!conteo[reg.identidad]) {
                        const colaboradorInfo = colaboradoresActivos.find(c => c.identidad === reg.identidad);
                        conteo[reg.identidad] = {
                            nombre: colaboradorInfo.nombre,
                            identidad: colaboradorInfo.identidad,
                            fotoUrl: colaboradorInfo.fotoUrl,
                            totalDias: 0
                        };
                    }
                    conteo[reg.identidad].totalDias += (reg.diasIncapacidad || 1);
                }
            });

            const sorted = Object.values(conteo).sort((a, b) => b.totalDias - a.totalDias);
            
            const modalHtml = `
                <div class="mb-3 px-2">
                    <input type="text" id="filtro-resumen-ausencias" class="form-control" placeholder="Buscar por nombre o identidad...">
                </div>
                <div id="resumen-lista-colaboradores" style="max-height: 400px; overflow-y: auto; text-align: left;"></div>`;

            function renderResumenList(items) {
                const container = $('#resumen-lista-colaboradores');
                container.empty();
                if (items.length === 0) {
                    container.html('<p class="text-center text-muted mt-3">No se encontraron colaboradores activos con ausencias.</p>');
                    return;
                }
                let listHtml = '';
                items.forEach(item => {
                    let color;
                    if (item.totalDias <= 2) color = "info";
                    else if (item.totalDias <= 5) color = "warning";
                    else color = "danger";
                    
                    const fotoSrc = item.fotoUrl || `https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random`;
                    listHtml += `
                        <div class="resumen-disciplina-item" data-identidad="${item.identidad}" style="cursor: pointer;">
                            <img src="${fotoSrc}" class="resumen-disciplina-img" onerror="this.src='https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random'">
                            <div class="resumen-disciplina-info">
                                <h6>${item.nombre}</h6>
                                <span class="badge bg-${color}">${item.totalDias} día(s) ausente(s)</span>
                            </div>
                        </div>`;
                });
                container.html(listHtml);
            }

            Swal.fire({
                title: 'Resumen de Ausencias por Colaborador Activo',
                html: modalHtml,
                width: '700px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    renderResumenList(sorted);
                    $('#filtro-resumen-ausencias').on('input', function() {
                        const query = $(this).val().toLowerCase();
                        const filtered = sorted.filter(item =>
                            item.nombre.toLowerCase().includes(query) || item.identidad.toLowerCase().includes(query)
                        );
                        renderResumenList(filtered);
                    });

                    $(document).on('click', '.resumen-disciplina-item', function() {
                        const identidad = $(this).data('identidad');
                        mostrarDetalleAusenciasColaborador(identidad);
                    });
                },
                willClose: () => {
                    $(document).off('click', '.resumen-disciplina-item');
                }
            });
        }
        
        function mostrarDetalleAusenciasColaborador(identidad) {
            const historial = ausencias.filter(d => d.identidad === identidad).sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            const colaborador = colaboradoresActivos.find(c => c.identidad === identidad) || { nombre: 'N/A', identidad: identidad, fotoUrl: '' };
            const totalDias = historial.reduce((sum, current) => sum + (current.diasIncapacidad || 1), 0);

            let historialHtml = '<div style="max-height: 300px; overflow-y: auto; text-align: left; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">';
            if (historial.length > 0) {
                historial.forEach((reg, index) => {
                    const fechaFin = reg.fechaFin && reg.fechaFin !== reg.fecha ? ` al ${formatearFecha(reg.fechaFin)}` : '';
                    historialHtml += `
                        <div class="mb-2">
                            <strong>${formatearFecha(reg.fecha)}${fechaFin}:</strong>
                            <ul class="mb-1 mt-1">
                                <li>Motivo: ${reg.motivo}</li>
                                <li>Días: ${reg.diasIncapacidad || 1}</li>
                            </ul>
                            ${reg.observaciones ? `<small class="d-block text-muted"><em>Observación: ${reg.observaciones}</em></small>` : ''}
                        </div>
                        ${index < historial.length - 1 ? '<hr class="my-2">' : ''}
                    `;
                });
            } else {
                historialHtml += '<p class="text-center text-muted">No se encontraron registros de ausencia.</p>';
            }
            historialHtml += '</div>';
            
            const fotoSrc = colaborador.fotoUrl || `https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random`;
            const detailModalHtml = `
                <div class="d-flex justify-content-start mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-volver-resumen-ausencias">
                        <i class="fas fa-arrow-left me-1"></i> Volver al Resumen
                    </button>
                </div>
                <div class="text-center mb-3">
                    <img src="${fotoSrc}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #dee2e6;" onerror="this.src='https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random'">
                    <h5 class="mt-2 mb-0">${colaborador.nombre}</h5>
                    <span class="badge bg-secondary">${colaborador.identidad}</span>
                    <p class="mt-2">Total de días ausente: <strong>${totalDias}</strong></p>
                </div>
                ${historialHtml}
            `;

            Swal.fire({
                title: 'Detalle de Ausencias',
                html: detailModalHtml,
                width: '600px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    const volverBtn = Swal.getPopup().querySelector('#btn-volver-resumen-ausencias');
                    if(volverBtn) {
                        volverBtn.addEventListener('click', () => {
                            Swal.close();
                            mostrarResumenAusencias();
                        });
                    }
                }
            });
        }
        
        function crearGraficoEgresosMotivoActual() {
            if(graficoEgresosMotivoActual) graficoEgresosMotivoActual.destroy();
            const hoy = new Date(), mesActual = hoy.getMonth(), anoActual = hoy.getFullYear();
            const egresosMes = colaboradoresEgresos.filter(e => { const fecha = new Date(e.fechaEgreso); return fecha.getMonth() === mesActual && fecha.getFullYear() === anoActual; });
            const conteo = {}; egresosMes.forEach(e => { conteo[e.razon] = (conteo[e.razon] || 0) + 1; });
            const ctx = document.getElementById('graficoEgresosMotivoActual').getContext('2d');
            graficoEgresosMotivoActual = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(conteo), datasets: [{ data: Object.values(conteo), backgroundColor: ['#2980b9', '#c0392b', '#f39c12', '#8e44ad', '#27ae60'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Egresos (Mes Actual)' } } } });
        }

        function crearGraficoEgresosMotivoHistorico() {
            if (graficoEgresosMotivoHistorico) graficoEgresosMotivoHistorico.destroy();
            const conteo = {}; colaboradoresEgresos.forEach(e => { conteo[e.razon] = (conteo[e.razon] || 0) + 1; });
            const ctx = document.getElementById('graficoEgresosMotivoHistorico').getContext('2d');
            graficoEgresosMotivoHistorico = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(conteo), datasets: [{ data: Object.values(conteo), backgroundColor: ['#2980b9', '#c0392b', '#f39c12', '#8e44ad', '#27ae60'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Egresos (Histórico)' } } } });
        }

        function crearGraficoEgresosMotivoFiltrado(ano, mes) {
            if(graficoEgresosMotivoFiltrado) graficoEgresosMotivoFiltrado.destroy();
            const egresosFiltrados = colaboradoresEgresos.filter(e => { const fecha = new Date(e.fechaEgreso); return fecha.getMonth() === mes && fecha.getFullYear() === ano; });
            const conteo = {}; egresosFiltrados.forEach(e => { conteo[e.razon] = (conteo[e.razon] || 0) + 1; });
            const ctx = document.getElementById('graficoEgresosMotivoFiltrado').getContext('2d');
            graficoEgresosMotivoFiltrado = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(conteo), datasets: [{ data: Object.values(conteo), backgroundColor: ['#2980b9', '#c0392b', '#f39c12', '#8e44ad', '#27ae60'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: `Egresos (${new Date(ano, mes).toLocaleString('es-ES', { month: 'long' })} ${ano})` } } } });
        }
        
        function crearGraficoRotacionAnual(ano) {
            if (graficoRotacionAnual) graficoRotacionAnual.destroy();
            const ctx = document.getElementById('graficoRotacionAnual').getContext('2d');
            const labels = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
            const datos = Array(12).fill(0);

            colaboradoresEgresos.forEach(e => {
                const fechaEgreso = new Date(e.fechaEgreso + 'T00:00:00');
                if (fechaEgreso.getFullYear() === ano) {
                    datos[fechaEgreso.getMonth()]++;
                }
            });

            graficoRotacionAnual = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Egresos por Mes en ${ano}`,
                        data: datos,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }
        
        // --- INICIO FUNCIONES PARA EVALUACIONES ---
        const CRITERIOS_EVALUACION = {
            productividad: ["Capacidad del empleado para completar las tareas de limpieza asignadas en el tiempo estipulado.", "Medición de la eficiencia en la realización de las labores diarias.", "Revisión de la calidad de la limpieza realizada en las áreas asignadas.", "Observación de la atención al detalle y la capacidad para mantener los estándares de limpieza requeridos.", "Evaluación del uso adecuado de productos de limpieza y equipos.", "Minimización del desperdicio y cuidado de los recursos proporcionados.", "Tiene la capacidad y autonomía para realizar las tareas asignadas de forma independiente sin necesidad de supervisión constante."],
            iniciativa: ["Se muestra asequible al cambio.", "Se anticipa a las dificultades.", "Tiene gran capacidad para resolver problemas.", "Muestra aptitud para integrarse al equipo.", "Se identifica fácilmente con los objetivos del equipo.", "Planifica sus actividades.", "Se preocupa por alcanzar las metas.", "Mantiene un seguimiento efectivo y preciso de los registros proporcionados para documentar sus actividades diarias en el trabajo."],
            conducta: ["Registro de la puntualidad y asistencia del empleado.", "Manejo de ausencias y justificaciones en caso de retrasos.", "Observación de la actitud del empleado hacia el trabajo y sus compañeros.", "Colaboración con el equipo y disposición para realizar tareas adicionales cuando sea necesario.", "Respeto y seguimiento de las normas de seguridad, higiene y procedimientos establecidos.", "Adherencia a las políticas internas del proyecto.", "Evita los conflictos dentro del trabajo."]
        };

        function popularFiltrosGraficoAnual(selector, datos, fechaKey) {
            const filtroAno = $(selector);
            filtroAno.empty();
            const anos = [...new Set(datos.map(d => d[fechaKey] ? new Date(d[fechaKey]).getFullYear() : null).filter(Boolean))];
            if (!anos.includes(new Date().getFullYear())) anos.push(new Date().getFullYear());
            anos.sort((a, b) => b - a).forEach(ano => filtroAno.append(`<option value="${ano}">${ano}</option>`));
            filtroAno.val(new Date().getFullYear());
        }

        function calcularEstadisticasEvaluaciones() {
            const APROBACION_THRESHOLD = 70;
            const hoy = new Date();
            const periodos = [
                { id: 'mes', meses: 0 }, 
                { id: '3meses', meses: 3 }, 
                { id: '6meses', meses: 6 }, 
                { id: '12meses', meses: 12 }
            ];

            periodos.forEach(p => {
                const fechaInicio = p.meses === 0 ? new Date(hoy.getFullYear(), hoy.getMonth(), 1) : new Date(hoy.getFullYear(), hoy.getMonth() - p.meses, 1);
                const evaluacionesPeriodo = evaluaciones.filter(e => new Date(e.fechaEvaluacion) >= fechaInicio);
                const aprobadas = evaluacionesPeriodo.filter(e => parseFloat(e.notaFinal) >= APROBACION_THRESHOLD).length;
                const total = evaluacionesPeriodo.length;
                const porcentaje = total > 0 ? ((aprobadas / total) * 100).toFixed(2) : '0.00';
                $(`#evaluacion-aprobacion-${p.id}`).text(porcentaje + '%');
            });

            const aprobadasHistorico = evaluaciones.filter(e => parseFloat(e.notaFinal) >= APROBACION_THRESHOLD).length;
            const totalHistorico = evaluaciones.length;
            const porcentajeHistorico = totalHistorico > 0 ? ((aprobadasHistorico / totalHistorico) * 100).toFixed(2) : '0.00';
            $('#evaluacion-aprobacion-historico').text(porcentajeHistorico + '%');
        }

        function crearGraficoEvaluacionesAnual(ano) {
            if (graficoEvaluacionesAnual) graficoEvaluacionesAnual.destroy();
            const ctx = document.getElementById('graficoEvaluacionesAnual').getContext('2d');
            const labels = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
            const sumasNotas = Array(12).fill(0);
            const conteos = Array(12).fill(0);

            evaluaciones.forEach(e => {
                const fecha = new Date(e.fechaEvaluacion + 'T00:00:00');
                if (fecha.getFullYear() === ano) {
                    const mes = fecha.getMonth();
                    sumasNotas[mes] += parseFloat(e.notaFinal);
                    conteos[mes]++;
                }
            });

            const promedios = sumasNotas.map((suma, i) => conteos[i] > 0 ? (suma / conteos[i]).toFixed(2) : 0);

            graficoEvaluacionesAnual = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Nota Promedio Mensual ${ano}`,
                        data: promedios,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(41, 128, 185, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Nota Promedio' } } }
                }
            });
        }

        function crearGraficoDesempenoHelper(canvasId, targetData, title) {
            const categorias = {
                'Sobresaliente (90-100)': 0,
                'Bueno (80-89)': 0,
                'Satisfactorio (70-79)': 0,
                'Necesita Mejora (60-69)': 0,
                'Insatisfactorio (<60)': 0
            };

            targetData.forEach(e => {
                const nota = parseFloat(e.notaFinal);
                if (nota >= 90) categorias['Sobresaliente (90-100)']++;
                else if (nota >= 80) categorias['Bueno (80-89)']++;
                else if (nota >= 70) categorias['Satisfactorio (70-79)']++;
                else if (nota >= 60) categorias['Necesita Mejora (60-69)']++;
                else categorias['Insatisfactorio (<60)']++;
            });
            
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        data: Object.values(categorias),
                        backgroundColor: ['#2ecc71', '#3498db', '#f1c40f', '#e67e22', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, title: { display: true, text: title } }
                }
            });
        }

        function crearGraficoEvaluacionesDesempenoActual() {
            if (graficoEvaluacionesDesempenoActual) graficoEvaluacionesDesempenoActual.destroy();
            const hoy = new Date(), mesActual = hoy.getMonth(), anoActual = hoy.getFullYear();
            const datosMes = evaluaciones.filter(e => {
                const fecha = new Date(e.fechaEvaluacion + 'T00:00:00');
                return fecha.getMonth() === mesActual && fecha.getFullYear() === anoActual;
            });
            graficoEvaluacionesDesempenoActual = crearGraficoDesempenoHelper('graficoEvaluacionesDesempenoActual', datosMes, 'Desempeño del Mes Actual');
        }

        function crearGraficoEvaluacionesDesempenoHistorico() {
            if (graficoEvaluacionesDesempenoHistorico) graficoEvaluacionesDesempenoHistorico.destroy();
            graficoEvaluacionesDesempenoHistorico = crearGraficoDesempenoHelper('graficoEvaluacionesDesempenoHistorico', evaluaciones, 'Desempeño Histórico');
        }

function mostrarHistorialEvaluaciones(datos) {
    const datosAMostrar = datos || evaluaciones;
    const tabla = $('#tabla-evaluaciones').empty();
    if (datosAMostrar.length === 0) {
        tabla.append('<tr><td colspan="4" class="text-center">No hay evaluaciones para el filtro seleccionado.</td></tr>');
        return;
    }
    const evaluacionesOrdenadas = [...datosAMostrar].sort((a, b) => new Date(b.fechaEvaluacion) - new Date(a.fechaEvaluacion));
    evaluacionesOrdenadas.forEach(e => {
        tabla.append(`
            <tr>
                <td>${formatearFecha(e.fechaEvaluacion)}</td>
                <td>${e.nombre}</td>
                <td>${e.identidad}</td>
                <td>${e.notaFinal}</td>
            </tr>`);
    });
}        
        function filtrarEvaluaciones() {
            const texto = $('#buscador-evaluaciones').val().toLowerCase();
            $('#tabla-evaluaciones tr').each(function() {
                const nombre = $(this).find('td:eq(1)').text().toLowerCase();
                const identidad = $(this).find('td:eq(2)').text().toLowerCase();
                $(this).toggle(nombre.includes(texto) || identidad.includes(texto));
            });
        }
        
        function mostrarResumenEvaluaciones() {
             if (evaluaciones.length === 0) {
                Swal.fire('Sin Datos', 'No hay evaluaciones registradas para mostrar un resumen.', 'info');
                return;
            }

            const conteo = {};
            evaluaciones.forEach(reg => {
                if (colaboradoresActivos.some(activo => activo.identidad === reg.identidad)) {
                    if (!conteo[reg.identidad]) {
                        const colaboradorInfo = colaboradoresActivos.find(c => c.identidad === reg.identidad);
                        conteo[reg.identidad] = {
                            nombre: colaboradorInfo.nombre,
                            identidad: colaboradorInfo.identidad,
                            fotoUrl: colaboradorInfo.fotoUrl,
                            count: 0
                        };
                    }
                    conteo[reg.identidad].count++;
                }
            });

            const sorted = Object.values(conteo).sort((a, b) => b.count - a.count);
            
            const modalHtml = `
                <div class="mb-3 px-2">
                    <input type="text" id="filtro-resumen-evaluaciones" class="form-control" placeholder="Buscar por nombre o identidad...">
                </div>
                <div id="resumen-lista-colaboradores" style="max-height: 400px; overflow-y: auto; text-align: left;"></div>`;

            function renderResumenList(items) {
                const container = $('#resumen-lista-colaboradores');
                container.empty();
                if (items.length === 0) {
                    container.html('<p class="text-center text-muted mt-3">No se encontraron colaboradores activos con evaluaciones.</p>');
                    return;
                }
                let listHtml = '';
                items.forEach(item => {
                    const fotoSrc = item.fotoUrl || `https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random`;
                    listHtml += `
                        <div class="resumen-disciplina-item" data-identidad="${item.identidad}" style="cursor: pointer;">
                            <img src="${fotoSrc}" class="resumen-disciplina-img" onerror="this.src='https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random'">
                            <div class="resumen-disciplina-info">
                                <h6>${item.nombre}</h6>
                                <span class="badge bg-primary">${item.count} Evaluación(es)</span>
                            </div>
                        </div>`;
                });
                container.html(listHtml);
            }

            Swal.fire({
                title: 'Resumen de Evaluaciones por Colaborador Activo',
                html: modalHtml,
                width: '700px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    renderResumenList(sorted);
                    $('#filtro-resumen-evaluaciones').on('input', function() {
                        const query = $(this).val().toLowerCase();
                        const filtered = sorted.filter(item =>
                            item.nombre.toLowerCase().includes(query) || item.identidad.toLowerCase().includes(query)
                        );
                        renderResumenList(filtered);
                    });

                    $(document).on('click', '.resumen-disciplina-item', function() {
                        const identidad = $(this).data('identidad');
                        mostrarDetalleEvaluacionesColaborador(identidad);
                    });
                },
                willClose: () => {
                    $(document).off('click', '.resumen-disciplina-item');
                }
            });
        }
        
        function generarHtmlAspectosMejorar(reg) {
            let html = '';
            const areas = {
                Productividad: { puntos: reg.puntosProductividad, criterios: CRITERIOS_EVALUACION.productividad, mejoras: [] },
                Iniciativa: { puntos: reg.puntosIniciativa, criterios: CRITERIOS_EVALUACION.iniciativa, mejoras: [] },
                'Conducta Laboral': { puntos: reg.puntosConducta, criterios: CRITERIOS_EVALUACION.conducta, mejoras: [] }
            };

            for (const area in areas) {
                if (areas[area].puntos) {
                    areas[area].puntos.forEach((punto, index) => {
                        if (punto < 2) {
                            areas[area].mejoras.push(areas[area].criterios[index]);
                        }
                    });
                }
            }

            let hayMejoras = false;
            for (const area in areas) {
                if (areas[area].mejoras.length > 0) {
                    if (!hayMejoras) {
                        html += `<p class="mt-3"><strong>Aspectos a Mejorar:</strong></p><div style="text-align: left; font-size: 0.85rem;">`;
                        hayMejoras = true;
                    }
                    html += `<strong>${area}:</strong><ul>`;
                    areas[area].mejoras.forEach(mejora => {
                        html += `<li>${mejora}</li>`;
                    });
                    html += `</ul>`;
                }
            }

            if (hayMejoras) {
                html += `</div>`;
            }

            return html;
        }

        function mostrarDetalleEvaluacionesColaborador(identidad) {
            const historial = evaluaciones.filter(e => e.identidad === identidad).sort((a,b) => new Date(b.fechaEvaluacion) - new Date(a.fechaEvaluacion));
            const colaborador = colaboradoresActivos.find(c => c.identidad === identidad) || { nombre: 'N/A', identidad: identidad, fotoUrl: '' };

            let historialComentariosHtml = '<div id="evaluacion-detalles-container" style="max-height: 250px; overflow-y: auto; text-align: left; padding: 10px; margin-top: 20px;">';
            if (historial.length > 0) {
                historial.forEach(reg => {
                    const hasInfo = reg.observaciones || reg.compromiso || reg.recomendaciones;
                    const aspectosMejorarHtml = generarHtmlAspectosMejorar(reg);
                    historialComentariosHtml += `
                        <div class="evaluacion-detalle-item">
                            <h6><i class="fas fa-calendar-alt me-2"></i>Evaluación del ${formatearFecha(reg.fechaEvaluacion)}</h6>`;
                    if (hasInfo) {
                        historialComentariosHtml += `
                            ${reg.observaciones ? `<p><strong>Observaciones:</strong> ${reg.observaciones}</p>` : ''}
                            ${reg.compromiso ? `<p><strong>Compromiso de Mejora:</strong> ${reg.compromiso}</p>` : ''}
                            ${reg.recomendaciones ? `<p><strong>Recomendaciones:</strong> ${reg.recomendaciones}</p>` : ''}`;
                    }
                    
                    historialComentariosHtml += aspectosMejorarHtml;

                    if (!hasInfo && !aspectosMejorarHtml) {
                        historialComentariosHtml += `<p class="no-info">No se especificó información adicional para esta evaluación.</p>`;
                    }
                    historialComentariosHtml += '</div>';
                });
            } else {
                historialComentariosHtml += '<p class="text-center text-muted">No se encontraron detalles de evaluaciones.</p>';
            }
            historialComentariosHtml += '</div>';

            const fotoSrc = colaborador.fotoUrl || `https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random`;
            const detailModalHtml = `
                <div class="d-flex justify-content-start mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-volver-resumen-evaluaciones">
                        <i class="fas fa-arrow-left me-1"></i> Volver al Resumen
                    </button>
                </div>
                <div class="text-center mb-3">
                    <img src="${fotoSrc}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #dee2e6;" onerror="this.src='https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random'">
                    <h5 class="mt-2 mb-0">${colaborador.nombre}</h5>
                    <span class="badge bg-secondary">${colaborador.identidad}</span>
                </div>
                <div class="chart-container" style="height: 300px;"><canvas id="graficoProgresoColaborador"></canvas></div>
                ${historialComentariosHtml}
            `;

            Swal.fire({
                title: 'Progreso de Evaluaciones',
                html: detailModalHtml,
                width: '800px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    const volverBtn = Swal.getPopup().querySelector('#btn-volver-resumen-evaluaciones');
                    if(volverBtn) {
                        volverBtn.addEventListener('click', () => {
                            Swal.close();
                            mostrarResumenEvaluaciones();
                        });
                    }

                    if (graficoProgresoColaborador) graficoProgresoColaborador.destroy();
                    const ctx = document.getElementById('graficoProgresoColaborador').getContext('2d');
                    
                    const historialAscendente = [...historial].reverse();

                    graficoProgresoColaborador = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: historialAscendente.map(e => formatearFecha(e.fechaEvaluacion)),
                            datasets: [{
                                label: 'Nota Final',
                                data: historialAscendente.map(e => e.notaFinal),
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                                fill: true,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, max: 100 } }
                        }
                    });
                }
            });
        }
        
        function mostrarDetalleColaboradorCompleto(identidad, esEgresado = false) {
            const colaborador = esEgresado 
                ? colaboradoresEgresos.find(c => c.identidad === identidad)
                : colaboradoresActivos.find(c => c.identidad === identidad);
            
            if (!colaborador) return;

            const historialAusencias = ausencias.filter(d => d.identidad === identidad).sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
            const historialDisciplina = disciplina.filter(d => d.identidad === identidad).sort((a,b) => new Date(b.fechaFalta) - new Date(a.fechaFalta));
            const historialEvaluaciones = evaluaciones.filter(d => d.identidad === identidad).sort((a,b) => new Date(a.fechaEvaluacion) - new Date(b.fechaEvaluacion));

            let historialHtml = '<div style="max-height: 400px; overflow-y: auto; text-align: left;">';

            historialHtml += '<h5><i class="fas fa-clock me-2"></i>Historial de Ausencias</h5>';
            if (historialAusencias.length > 0) {
                historialHtml += '<ul>';
                historialAusencias.forEach(a => {
                    historialHtml += `<li>${formatearFecha(a.fecha)} (${a.diasIncapacidad || 1} día(s)): ${a.motivo}</li>`;
                });
                historialHtml += '</ul>';
            } else {
                historialHtml += '<p class="text-muted small">Sin ausencias registradas.</p>';
            }

            historialHtml += '<h5 class="mt-3"><i class="fas fa-gavel me-2"></i>Historial de Disciplina</h5>';
            if (historialDisciplina.length > 0) {
                historialHtml += '<ul>';
                historialDisciplina.forEach(d => {
                    historialHtml += `<li>${formatearFecha(d.fechaFalta)}: ${d.descripcionFaltas}</li>`;
                });
                historialHtml += '</ul>';
            } else {
                historialHtml += '<p class="text-muted small">Sin acciones disciplinarias registradas.</p>';
            }

            historialHtml += '<h5 class="mt-3"><i class="fas fa-chart-bar me-2"></i>Historial de Evaluaciones</h5>';
            if (historialEvaluaciones.length > 0) {
                 historialHtml += '<div class="chart-container" style="height: 250px;"><canvas id="graficoProgresoCompleto"></canvas></div>';
                 historialEvaluaciones.forEach(reg => { // De más reciente a más antigua
                    const hasInfo = reg.observaciones || reg.compromiso || reg.recomendaciones;
                    const aspectosMejorarHtml = generarHtmlAspectosMejorar(reg);
                    historialHtml += `
                        <div class="evaluacion-detalle-item">
                            <h6><i class="fas fa-calendar-alt me-2"></i>Evaluación del ${formatearFecha(reg.fechaEvaluacion)} (Nota: ${reg.notaFinal})</h6>`;
                    if (hasInfo) {
                        historialHtml += `
                            ${reg.observaciones ? `<p><strong>Observaciones:</strong> ${reg.observaciones}</p>` : ''}
                            ${reg.compromiso ? `<p><strong>Compromiso de Mejora:</strong> ${reg.compromiso}</p>` : ''}
                            ${reg.recomendaciones ? `<p><strong>Recomendaciones:</strong> ${reg.recomendaciones}</p>` : ''}`;
                    }
                    historialHtml += aspectosMejorarHtml;
                    if (!hasInfo && !aspectosMejorarHtml) {
                        historialHtml += `<p class="no-info">No se especificó información adicional.</p>`;
                    }
                    historialHtml += '</div>';
                });
            } else {
                historialHtml += '<p class="text-muted small">Sin evaluaciones registradas.</p>';
            }
            historialHtml += '</div>';
            
            const fotoSrc = colaborador.fotoUrl || `https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random`;
            let infoHeader = esEgresado ?
                `<p class="mt-2">Fecha de Egreso: <strong>${formatearFecha(colaborador.fechaEgreso)}</strong><br>Razón: <strong>${colaborador.razon}</strong></p>` :
                `<p class="mt-2">Fecha de Inicio: <strong>${formatearFecha(colaborador.fechaInicio)}</strong></p>`;

            const detailModalHtml = `
                <div class="text-center mb-3">
                    <img src="${fotoSrc}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #dee2e6;" onerror="this.src='https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random'">
                    <h5 class="mt-2 mb-0">${colaborador.nombre}</h5>
                    <span class="badge bg-secondary">${colaborador.identidad}</span>
                    ${infoHeader}
                </div>
                ${historialHtml}
            `;

            Swal.fire({
                title: 'Historial del Colaborador',
                html: detailModalHtml,
                width: '800px',
                showCloseButton: true,
                showConfirmButton: false,
                didOpen: () => {
                    if (historialEvaluaciones.length > 0) {
                        const ctx = document.getElementById('graficoProgresoCompleto').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: [...historialEvaluaciones].sort((a,b) => new Date(a.fechaEvaluacion) - new Date(b.fechaEvaluacion)).map(e => formatearFecha(e.fechaEvaluacion)),
                                datasets: [{
                                    label: 'Nota Final',
                                    data: [...historialEvaluaciones].sort((a,b) => new Date(a.fechaEvaluacion) - new Date(b.fechaEvaluacion)).map(e => e.notaFinal),
                                    borderColor: '#3498db',
                                    backgroundColor: 'rgba(52, 152, 219, 0.2)',
                                    fill: true,
                                    tension: 0.1
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                        });
                    }
                }
            });
        }

        function actualizarAlertasBajoRendimiento() {
            const container = $('#contenedor-bajo-rendimiento');
            container.empty();
            const ultimasEvaluaciones = {};

            evaluaciones.forEach(ev => {
                if (!ultimasEvaluaciones[ev.identidad] || new Date(ev.fechaEvaluacion) > new Date(ultimasEvaluaciones[ev.identidad].fechaEvaluacion)) {
                    ultimasEvaluaciones[ev.identidad] = ev;
                }
            });

            const empleadosBajoRendimiento = Object.values(ultimasEvaluaciones)
                .filter(e => parseFloat(e.notaFinal) < 70)
                .sort((a, b) => parseFloat(a.notaFinal) - parseFloat(b.notaFinal));

            if (empleadosBajoRendimiento.length === 0) {
                container.html('<div class="text-center p-3 text-success"><i class="fas fa-check-circle fa-2x mb-2"></i><p class="mb-0">¡Excelente! Ningún colaborador presenta bajo rendimiento en su última evaluación.</p></div>');
                return;
            }

            let listHtml = '';
            empleadosBajoRendimiento.forEach(item => {
                const colaboradorInfo = colaboradoresActivos.find(c => c.identidad === item.identidad) || { nombre: item.nombre, fotoUrl: '' };
                const nota = parseFloat(item.notaFinal);
                let color = 'bg-danger';
                let texto = 'Insatisfactorio';
                if (nota >= 60) {
                    color = 'bg-warning text-dark';
                    texto = 'Necesita Mejora';
                }

                const fotoSrc = colaboradorInfo.fotoUrl || `https://ui-avatars.com/api/?name=${colaboradorInfo.nombre.replace(/\s/g, "+")}&background=random`;
                listHtml += `
                    <div class="resumen-disciplina-item">
                        <img src="${fotoSrc}" class="resumen-disciplina-img" onerror="this.src='https://ui-avatars.com/api/?name=${colaboradorInfo.nombre.replace(/\s/g, "+")}&background=random'">
                        <div class="resumen-disciplina-info">
                            <h6>${colaboradorInfo.nombre}</h6>
                            <p class="mb-0 small">Última evaluación: ${formatearFecha(item.fechaEvaluacion)}</p>
                        </div>
                        <span class="badge ${color}">${texto}: ${item.notaFinal}</span>
                    </div>`;
            });
            container.html(listHtml);
        }


function mostrarCumpleanerosDelMes() {
    const mesActual = new Date().getMonth();
    const cumpleaneros = colaboradoresActivos.filter(col => col.fechaNacimiento && new Date(col.fechaNacimiento + 'T00:00:00').getMonth() === mesActual)
        .sort((a, b) => new Date(a.fechaNacimiento + 'T00:00:00').getDate() - new Date(b.fechaNacimiento + 'T00:00:00').getDate());
    const contenedor = $('#contenedor-cumpleaneros').empty();
    
    if (cumpleaneros.length > 0) {
         cumpleaneros.forEach(col => {
            const dia = new Date(col.fechaNacimiento + 'T00:00:00').getDate();
            const nombreMes = new Date(2000, mesActual).toLocaleString('es-ES', { month: 'long' }); // Nombre completo del mes
            const fotoHtml = col.fotoUrl ? `<img src="${col.fotoUrl}" class="cumpleanero-img" alt="${col.nombre}">` : `<i class="fas fa-user-circle cumpleanero-img-icon"></i>`;
            
            // --- INICIO DE MODIFICACIÓN ---
            // Se usa <p> para la fecha y se añade icono
            contenedor.append(`
                <div class="col-lg-3 col-md-4 col-sm-6 col-6 mb-4 d-flex align-items-stretch"> 
                    <div class="cumpleanero-card">
                        <div class="cumpleanero-img-container">${fotoHtml}</div>
                        <div class="cumpleanero-info">
                            <h5>${col.nombre}</h5>
                            <p>
                                <i class="fas fa-birthday-cake"></i> ${dia} de ${nombreMes}
                            </p>
                        </div>
                    </div>
                </div>`);
             // --- FIN DE MODIFICACIÓN --- (Se añadió d-flex y align-items-stretch a la columna para igualar alturas si varían)
         });
    } else { 
        contenedor.append('<div class="col-12"><p class="text-center text-muted">No hay cumpleaños este mes.</p></div>'); 
    }
}

        
        // --- INICIO FUNCIONES PLANILLA ---
        function generarPlanilla(fechaStr) {
            const fecha = new Date(fechaStr + 'T00:00:00');
            const dia = fecha.getDate();
            const mes = fecha.getMonth();
            const ano = fecha.getFullYear();

            let inicioQuincena, finQuincena;
            if (dia <= 15) {
                inicioQuincena = new Date(ano, mes, 1);
                finQuincena = new Date(ano, mes, 15);
            } else {
                inicioQuincena = new Date(ano, mes, 16);
                finQuincena = new Date(ano, mes + 1, 0); // Último día del mes
            }

            const diasArray = [];
            for (let d = new Date(inicioQuincena); d <= finQuincena; d.setDate(d.getDate() + 1)) {
                diasArray.push(new Date(d));
            }

            const diasSemana = ['D', 'L', 'M', 'Mi', 'J', 'V', 'S'];
            const thead = $('#tabla-planilla thead').empty();
            let headerRow1 = '<tr><th class="table-dark" style="min-width: 200px;">Colaborador</th>';
            let headerRow2 = '<tr><th class="table-dark" style="min-width: 200px;"></th>';
            
            diasArray.forEach(d => {
                headerRow1 += `<th class="table-dark">${d.getDate()}</th>`;
                headerRow2 += `<th class="table-dark">${diasSemana[d.getDay()]}</th>`;
            });
            headerRow1 += '</tr>';
            headerRow2 += '</tr>';
            thead.html(headerRow1 + headerRow2);

            const tbody = $('#tabla-planilla tbody').empty();
            
            // 1. Obtener todos los colaboradores que estuvieron activos o egresaron DURANTE esta quincena
            let colaboradoresPlanilla = [];
            colaboradoresActivos.forEach(col => {
                const fechaInicio = new Date(col.fechaInicio + 'T00:00:00');
                if (fechaInicio <= finQuincena) { // Si ingresó antes de que terminara la quincena
                    colaboradoresPlanilla.push(col);
                }
            });
            
            colaboradoresEgresos.forEach(eg => {
                const fechaInicio = new Date(eg.fechaInicio + 'T00:00:00');
                const fechaEgreso = new Date(eg.fechaEgreso + 'T00:00:00');
                // Si ingresó antes de que terminara la quincena Y egresó después de que iniciara
                if (fechaInicio <= finQuincena && fechaEgreso >= inicioQuincena) {
                    if (!colaboradoresPlanilla.some(c => c.identidad === eg.identidad)) {
                        colaboradoresPlanilla.push(eg);
                    }
                }
            });
            
            colaboradoresPlanilla.sort((a, b) => a.nombre.localeCompare(b.nombre));

            colaboradoresPlanilla.forEach(col => {
                let filaHtml = `<tr data-nombre="${col.nombre}"><td>${col.nombre}</td>`;
                const egresadoInfo = colaboradoresEgresos.find(e => e.identidad === col.identidad);
                const fechaInicio = new Date(col.fechaInicio + 'T00:00:00');
                let egresoFlag = false;

                for (let i = 0; i < diasArray.length; i++) {
                    const fechaDia = diasArray[i];
                    if (egresoFlag) break;

                    let celda = '';

                    // Comprobar Egreso
                    if (egresadoInfo) {
                        const fechaEgreso = new Date(egresadoInfo.fechaEgreso + 'T00:00:00');
                        if (fechaDia >= fechaEgreso) {
                            const colspan = diasArray.length - i;
                            celda = `<td colspan="${colspan}" class="egreso-cell">${egresadoInfo.razon}</td>`;
                            egresoFlag = true;
                        }
                    }

                    // Comprobar Nuevo Ingreso
                    if (!egresoFlag && fechaDia < fechaInicio) {
                        celda = '<td class="nuevo-ingreso">NI</td>';
                    }
                    
                    // Comprobar Ausencia
                    if (!egresoFlag && !celda) {
                        const ausencia = ausencias.find(a => 
                            a.identidad === col.identidad &&
                            fechaDia >= new Date(a.fecha + 'T00:00:00') &&
                            fechaDia <= new Date((a.fechaFin || a.fecha) + 'T00:00:00') // Usar fechaFin si existe
                        );
                        if (ausencia) {
                            if (ausencia.motivo === 'Incapacidad') celda = '<td class="incapacidad">I</td>';
                            else if (ausencia.motivo === 'Falta Injustificada') celda = '<td class="falta">NSP</td>';
                            else if (ausencia.motivo === 'Permiso') celda = '<td class="permiso">P</td>';
                        }
                    }

                    // Marcar Asistencia (Default)
                    if (!egresoFlag && !celda) {
                        celda = '<td class="asistencia">✔</td>';
                    }
                    
                    filaHtml += celda;
                }
                filaHtml += '</tr>';
                tbody.append(filaHtml);
            });
            
            generarSimbologiaPlanilla();
        }
        
        function filtrarPlanilla() {
            const texto = $('#buscador-planilla').val().toLowerCase();
            $('#tabla-planilla tbody tr').each(function() {
                const nombre = $(this).data('nombre').toLowerCase();
                $(this).toggle(nombre.includes(texto));
            });
        }
        
        function generarSimbologiaPlanilla() {
            const simbologia = [
                { clase: 'simb-asistencia', texto: '✔ = Asistencia' },
                { clase: 'simb-ausencia', texto: 'I = Incapacidad' },
                { clase: 'simb-ausencia', texto: 'P = Permiso' },
                { clase: 'simb-ausencia', texto: 'NSP = No Se Presentó' },
                { clase: 'simb-ausencia', texto: 'NI = Nuevo Ingreso' },
                { clase: 'simb-egreso', texto: 'Motivo de Egreso' }
            ];
            
            let html = '<h6 class="text-center">Simbología</h6><div class="planilla-simbologia">';
            simbologia.forEach(s => {
                html += `<span class="${s.clase}">${s.texto}</span>`;
            });
            html += '</div>';
            $('#planilla-simbologia').html(html);
        }

        function formatearFecha(fechaStr) {
            if (!fechaStr) return '';
            const fecha = new Date(fechaStr + 'T00:00:00');
            return isNaN(fecha.getTime()) ? fechaStr : `${String(fecha.getUTCDate()).padStart(2, '0')}/${String(fecha.getUTCMonth() + 1).padStart(2, '0')}/${fecha.getUTCFullYear()}`;
        }

        function formatearIdentidad(input) {
            let valor = input.value.replace(/\D/g, '').substring(0, 13);
            if (valor.length > 8) valor = `${valor.substring(0, 8)}-${valor.substring(8)}`;
            if (valor.length > 4) valor = `${valor.substring(0, 4)}-${valor.substring(4)}`;
            input.value = valor;
        }
        
        function subirFoto(colaborador, archivo, esEdicion = false) {
            return new Promise((resolve, reject) => {
                if (!archivo) resolve(null);
                if (archivo.size > 5 * 1024 * 1024) reject('El archivo es demasiado grande (máx 5MB).');
                const reader = new FileReader();
                reader.onload = e => { $.post(SCRIPT_URL_ENVIAR, { accion: 'subir_foto', colaborador: JSON.stringify(colaborador), archivo: e.target.result.split(',')[1], esEdicion }, r => (r === 'Éxito') ? resolve('Éxito') : reject('Error: ' + r)).fail((j, t) => reject('Error: ' + t)); };
                reader.onerror = () => reject('Error al leer archivo');
                reader.readAsDataURL(archivo);
            });
        }
        
        function mostrarFoto(colaborador) {
            const content = colaborador.fotoUrl ? `<img src="${colaborador.fotoUrl}" style="width: 200px; height: 200px; border-radius: 50%; object-fit: cover;" onerror="this.parentElement.innerHTML = '<div class=\\'text-center\\'><i class=\\'fas fa-user-circle\\' style=\\'font-size: 120px;\\'></i><p>Error al cargar.</p></div>';">` : `<i class="fas fa-user-circle" style="font-size: 120px;"></i><p>No hay foto.</p>`;
            Swal.fire({ title: colaborador.nombre, html: `<div class="text-center">${content}<p class="mt-3"><strong>ID:</strong> ${colaborador.identidad}</p></div>`, confirmButtonText: 'Cerrar', width: 'auto' });
        }

        function mostrarVistaPreviaFoto(input) {
            const container = $(input).closest('.row').find('.vista-previa-container').empty();
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { container.html(`<div style="position: relative; display: inline-block;"><img src="${e.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 5px;"><button type="button" class="btn btn-danger btn-sm" onclick="quitarVistaPrevia(this)" style="position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center;"><i class="fas fa-times"></i></button></div>`); };
                reader.readAsDataURL(input.files[0]);
            }
        }
        function quitarVistaPrevia(button) {
            const container = $(button).closest('.vista-previa-container');
            container.closest('.row').find('.foto-colaborador').val('');
            container.empty();
        }

        function mostrarVistaPreviaEdicion(input) {
            const container = $('#vista-previa-edicion-container');
            container.empty();
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    container.html(`
                        <div style="position: relative; display: inline-block;">
                            <img src="${e.target.result}" style="max-width: 100px; max-height: 100px; border-radius: 5px;">
                            <button type="button" class="btn btn-danger btn-sm" onclick="quitarVistaPreviaEdicion(this)" style="position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function quitarVistaPreviaEdicion(button) {
            $('#editar-foto').val('');
            $(button).closest('.vista-previa-container').empty();
        }



function filtrarAusenciasPersonalizado() {
    const inicio = $('#fecha-inicio-ausencias').val();
    const fin = $('#fecha-fin-ausencias').val();
    let ausenciasFiltradas = ausencias;

    if (inicio && fin) {
        // --- INICIO DE LÓGICA CORREGIDA ---
        // Queremos ausencias (A) que se solapen con el rango del filtro (F).
        // Un solapamiento ocurre si:
        // (Inicio de A <= Fin de F) Y (Fin de A >= Inicio de F)
        ausenciasFiltradas = ausencias.filter(a => {
            const absenceStart = a.fecha;
            // Usar 'fechaFin' si existe; si no, es una ausencia de un día (usar 'fecha')
            const absenceEnd = a.fechaFin || a.fecha; 
            
            return absenceStart <= fin && absenceEnd >= inicio;
        });
        // --- FIN DE LÓGICA CORREGIDA ---

    } else if (inicio) {
        // Si solo hay fecha "Desde", queremos cualquier ausencia que
        // termine (absenceEnd) en o después de esa fecha.
        ausenciasFiltradas = ausencias.filter(a => {
            const absenceEnd = a.fechaFin || a.fecha;
            return absenceEnd >= inicio;
        });

    } else if (fin) {
        // Si solo hay fecha "Hasta", queremos cualquier ausencia que
        // comience (absenceStart) en o antes de esa fecha.
        ausenciasFiltradas = ausencias.filter(a => a.fecha <= fin);
    }
    
    // Si no hay 'inicio' ni 'fin', 'ausenciasFiltradas' sigue siendo igual a 'ausencias' (muestra todo).
    
    mostrarAusencias(ausenciasFiltradas);
}


function filtrarDisciplinaPersonalizado() {
    const inicio = $('#fecha-inicio-disciplina').val();
    const fin = $('#fecha-fin-disciplina').val();
    let disciplinaFiltrada = disciplina;

    if (inicio && fin) {
        disciplinaFiltrada = disciplina.filter(d => d.fechaFalta >= inicio && d.fechaFalta <= fin);
    } else if (inicio) {
        disciplinaFiltrada = disciplina.filter(d => d.fechaFalta >= inicio);
    } else if (fin) {
        disciplinaFiltrada = disciplina.filter(d => d.fechaFalta <= fin);
    }

    mostrarHistorialDisciplina(disciplinaFiltrada);
}

function filtrarEvaluacionesPersonalizado() {
    const inicio = $('#fecha-inicio-evaluaciones').val();
    const fin = $('#fecha-fin-evaluaciones').val();
    let evaluacionesFiltradas = evaluaciones;

    if (inicio && fin) {
        evaluacionesFiltradas = evaluaciones.filter(e => e.fechaEvaluacion >= inicio && e.fechaEvaluacion <= fin);
    } else if (inicio) {
        evaluacionesFiltradas = evaluaciones.filter(e => e.fechaEvaluacion >= inicio);
    } else if (fin) {
        evaluacionesFiltradas = evaluaciones.filter(e => e.fechaEvaluacion <= fin);
    }

    mostrarHistorialEvaluaciones(evaluacionesFiltradas);
}


function refrescarDatosGlobales(onSuccessCallback) {
    $('#overlay').css('display', 'flex');

    $.get(SCRIPT_URL_OBTENER, function(data) {
        $('#overlay').hide();
        if (data.error) {
            Swal.fire('Error', 'No se pudieron cargar los datos: ' + data.mensaje, 'error');
            return;
        }

        // Actualizar todas las variables globales
        colaboradoresActivos = (data.activos || []).map(corregirFecha);
        colaboradoresIngresos = (data.ingresos || []).map(corregirFecha);
        colaboradoresEgresos = (data.egresos || []).map(corregirFecha);
        ausencias = (data.ausencias || []).map(corregirFecha);
        disciplina = (data.disciplina || []).map(corregirFecha);
        evaluaciones = (data.evaluaciones || []).map(corregirFecha);
        incidentes = (data.incidentes || []).map(corregirFecha); // <-- AÑADIDO

        nombresActivos = colaboradoresActivos.map(col => col.nombre);

        // Ejecutar el callback (las funciones de renderizado)
        if (onSuccessCallback) {
            onSuccessCallback();
        }

    }).fail(function(jqXHR, textStatus, errorThrown) {
        $('#overlay').hide();
        Swal.fire('Error', 'No se pudo conectar al servidor o hubo un error de red. ' + textStatus + ': ' + errorThrown, 'error');
    });
}


function actualizarTabActual() {
    const tabActivaId = $('.tab-pane.fade.show.active').attr('id');

    refrescarDatosGlobales(function() {
        // Una vez que los datos globales están frescos,
        // llamamos solo a las funciones de renderizado necesarias
        const hoy = new Date();

        switch (tabActivaId) {
            case 'dashboard':
                actualizarDashboard();
                break;
            case 'registrar':
                // No necesita refrescar datos, es un formulario
                // Las variables (ej. nombresActivos) ya se actualizaron
                break;
            case 'activos':
                mostrarColaboradoresActivos();
                break;
            case 'vencimientos':
                actualizarVencimientosContrato();
                break;
            case 'rotacion':
                calcularRotacionGeneral();
                calcularRotacionPeriodos();
                mostrarEgresos(colaboradoresEgresos);
                popularFiltrosGrafico('#filtro-mes-egresos', '#filtro-ano-egresos', colaboradoresEgresos, 'fechaEgreso');
                popularFiltrosGraficoAnual('#filtro-ano-rotacion', colaboradoresEgresos, 'fechaEgreso');
                crearGraficoRotacionAnual(hoy.getFullYear());
                crearGraficoEgresosMotivoActual();
                crearGraficoEgresosMotivoHistorico();
                break;
            case 'egresados':
                mostrarColaboradoresEgresados();
                break;
            case 'planilla':
                const fechaPlanilla = document.getElementById('planilla-date-picker').value || new Date().toISOString().split('T')[0];
                generarPlanilla(fechaPlanilla);
                break;
            case 'registrar-ausencia':
                // No necesita refrescar datos, es un formulario
                // Las variables (ej. nombresActivos) ya se actualizaron
                break;
            case 'ausencias':
                mostrarAusencias(); // Mostrar tabla principal
                filtrarAusenciasPersonalizado(); // Aplicar filtros si existen
                calcularEstadisticasAusencias();
                popularFiltrosGrafico('#filtro-mes-grafico', '#filtro-ano-grafico', ausencias, 'fecha');
                crearGraficoAusencias(hoy.getFullYear(), hoy.getMonth());
                crearGraficoAusenciasMotivoActual();
                crearGraficoAusenciasMotivoHistorico();
                break;
            case 'disciplina':
                mostrarHistorialDisciplina(); // Mostrar tabla principal
                filtrarDisciplinaPersonalizado(); // Aplicar filtros si existen
                calcularEstadisticasDisciplina();
                popularFiltrosGrafico('#filtro-mes-disciplina', '#filtro-ano-disciplina', disciplina, 'fechaFalta');
                crearGraficoDisciplinaPorDia(hoy.getFullYear(), hoy.getMonth());
                crearGraficoDisciplinaMotivoActual();
                crearGraficoDisciplinaMotivoHistorico();
                break;
            case 'evaluaciones':
                mostrarHistorialEvaluaciones(); // Mostrar tabla principal
                filtrarEvaluacionesPersonalizado(); // Aplicar filtros si existen
                calcularEstadisticasEvaluaciones();
                actualizarAlertasBajoRendimiento();
                popularFiltrosGraficoAnual('#filtro-ano-evaluaciones-grafico', evaluaciones, 'fechaEvaluacion');
                crearGraficoEvaluacionesAnual(hoy.getFullYear());
                crearGraficoEvaluacionesDesempenoActual();
                crearGraficoEvaluacionesDesempenoHistorico();
                break;
            
            // INICIO: Casos Incidentes 
            case 'registrar-incidente':
                // No necesita refrescar datos, es un formulario
                break;
            case 'historial-incidentes':
                mostrarHistorialIncidentes();
                filtrarIncidentesPersonalizado();
                calcularEstadisticasIncidentes();
                generarSimbologiaIncidentes(); 
                popularFiltrosGraficoAnual('#filtro-ano-incidentes', incidentes, 'fechaIncidente');
                crearGraficoIncidentesAnual(hoy.getFullYear());
                crearGraficoPartesCuerpo(); // <-- AÑADIDO (Req 3)
                popularFiltrosGrafico('#filtro-mes-incidentes', '#filtro-ano-incidentes-pie', incidentes, 'fechaIncidente'); 
                crearGraficoIncidentesCategoriaActual();
                crearGraficoIncidentesCategoriaHistorico();
                break;
            // FIN: Casos Incidentes

            case 'cumpleaneros':
                mostrarCumpleanerosDelMes();
                break;
        }

        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: 'Pestaña actualizada',
            showConfirmButton: false,
            timer: 1500
        });
    });
}


// --- INICIO FUNCIONES PARA INCIDENTES ---

function agregarFormularioIncidente() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;

    // Generar IDs únicos para los checkboxes del nuevo formulario
    const formIndex = $('#contenedor-formularios-incidente .formulario-item').length; // Índice basado en 0

    const nuevoFormulario = `
        <div class="formulario-item">
            <button type="button" class="btn btn-danger btn-quitar-item btn-quitar-item-incidente" title="Quitar registro"><i class="fas fa-times"></i></button>
            
            <input type="hidden" class="form-control identidad-incidente" required>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha de Incidente</label>
                    <input type="date" class="form-control fecha-incidente" value="${todayStr}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Colaborador</label>
                    <div class="autocomplete-container">
                        <input type="text" class="form-control colaborador-incidente" placeholder="Escriba el nombre..." required>
                        <div class="autocomplete-list"></div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Parte Afectada (Opcional)</label>
                    <div class="border p-2 rounded" style="max-height: 150px; overflow-y: auto;">
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Cabeza" id="parte-cabeza-${formIndex}">
                          <label class="form-check-label" for="parte-cabeza-${formIndex}">Cabeza</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Ojos" id="parte-ojos-${formIndex}">
                          <label class="form-check-label" for="parte-ojos-${formIndex}">Ojos</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Torso" id="parte-torso-${formIndex}">
                          <label class="form-check-label" for="parte-torso-${formIndex}">Torso</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Brazo Izquierdo" id="parte-brazo-izq-${formIndex}">
                          <label class="form-check-label" for="parte-brazo-izq-${formIndex}">Brazo Izquierdo</label>
                        </div>
                         <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Brazo Derecho" id="parte-brazo-der-${formIndex}">
                          <label class="form-check-label" for="parte-brazo-der-${formIndex}">Brazo Derecho</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Mano Izquierda" id="parte-mano-izq-${formIndex}">
                          <label class="form-check-label" for="parte-mano-izq-${formIndex}">Mano Izquierda</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Mano Derecha" id="parte-mano-der-${formIndex}">
                          <label class="form-check-label" for="parte-mano-der-${formIndex}">Mano Derecha</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Pierna Izquierda" id="parte-pierna-izq-${formIndex}">
                          <label class="form-check-label" for="parte-pierna-izq-${formIndex}">Pierna Izquierda</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Pierna Derecha" id="parte-pierna-der-${formIndex}">
                          <label class="form-check-label" for="parte-pierna-der-${formIndex}">Pierna Derecha</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Pie Izquierdo" id="parte-pie-izq-${formIndex}">
                          <label class="form-check-label" for="parte-pie-izq-${formIndex}">Pie Izquierdo</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Pie Derecho" id="parte-pie-der-${formIndex}">
                          <label class="form-check-label" for="parte-pie-der-${formIndex}">Pie Derecho</label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input parte-afectada-check" type="checkbox" value="Otro" id="parte-otro-${formIndex}">
                          <label class="form-check-label" for="parte-otro-${formIndex}">Otro</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Categoría SISO</label>
                    <select class="form-select categoria-siso-incidente" required>
                        <option value="">Seleccionar...</option>
                        <option value="FAT">FAT: Fatalidades</option>
                        <option value="LWC">LWC: Incidentes con pérdida de tiempo</option>
                        <option value="MTC">MTC: Incidentes de tratamiento médico</option>
                        <option value="FAC">FAC: Incidentes de primeros auxilios</option>
                        <option value="N-M">N-M: Casi Incidentes</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Causa del Incidente</label>
                    <textarea class="form-control causa-incidente" rows="2" required></textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Descripción del incidente</label>
                    <textarea class="form-control descripcion-incidente" rows="2" required></textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label class="form-label">Medidas Implementadas (Opcional)</label>
                    <textarea class="form-control medidas-incidente" rows="2"></textarea>
                </div>
            </div>
        </div>`;
    $('#contenedor-formularios-incidente').append(nuevoFormulario);
}




function registrarIncidente() {
    let incidentesParaRegistrar = [];
    let esValido = true;
    
    $('#contenedor-formularios-incidente .formulario-item').each(function(index) {
        const item = $(this);
        const fechaIncidente = item.find('.fecha-incidente').val();
        const nombre = item.find('.colaborador-incidente').val();
        const identidad = item.find('.identidad-incidente').val(); 
        const descripcion = item.find('.descripcion-incidente').val();
        
        // --- INICIO: CAMBIO Req 1 (Leer checkboxes) ---
        const partesAfectadasArray = [];
        item.find('.parte-afectada-check:checked').each(function() {
            partesAfectadasArray.push($(this).val());
        });
        const parteAfectada = partesAfectadasArray.join('; '); // Unir con "; "
        // --- FIN: CAMBIO Req 1 ---
        
        const causa = item.find('.causa-incidente').val(); 
        const medidas = item.find('.medidas-incidente').val(); 
        const categoriaSiso = item.find('.categoria-siso-incidente').val(); 

        // Validación actualizada (parteAfectada ya no es obligatoria)
        if (!fechaIncidente || !nombre || !identidad || !descripcion || !causa || !categoriaSiso) { 
            Swal.fire('Error', `Complete todos los campos obligatorios para el incidente #${index + 1}.`, 'error'); 
            esValido = false; 
            return false; 
        }
        
        const colaboradorInfo = colaboradoresActivos.find(col => col.nombre === nombre && col.identidad === identidad);
        if (!colaboradorInfo) {
            Swal.fire('Error', `El colaborador '${nombre}' (incidente #${index + 1}) no es un colaborador activo válido o la identidad no coincide. Por favor, selecciónelo de la lista.`, 'error'); 
            esValido = false; 
            return false; 
        }

        incidentesParaRegistrar.push({ 
            fechaIncidente, 
            nombre, 
            identidad, 
            descripcion, 
            parteAfectada: parteAfectada, // Enviamos el string (puede estar vacío)
            causa, 
            medidas: medidas || '', 
            categoriaSiso 
        });
    });
    
    if (!esValido || incidentesParaRegistrar.length === 0) return;
    
    Swal.fire({ 
        title: '¿Está seguro?', 
        html: `Se registrarán <strong>${incidentesParaRegistrar.length}</strong> incidentes.`, 
        icon: 'question', 
        showCancelButton: true, 
        confirmButtonText: 'Sí, registrar', 
        cancelButtonText: 'No, cancelar' 
    }).then((result) => {
        if (result.isConfirmed) {
            $('#overlay').css('display', 'flex');
            $.post(SCRIPT_URL_ENVIAR, { 
                accion: 'registrar_incidentes_masivo', 
                datos: JSON.stringify(incidentesParaRegistrar) 
            }, (response) => {
                $('#overlay').hide();
                if (response === 'Éxito') {
                    Swal.fire('Éxito', 'Incidentes registrados.', 'success').then(() => { 
                        $('#contenedor-formularios-incidente').empty(); 
                        agregarFormularioIncidente(); 
                        cargarTodosLosDatos(); 
                    });
                } else {
                    Swal.fire('Error', `Error al registrar incidentes: ${response}`, 'error');
                }
            }).fail(() => { 
                $('#overlay').hide(); 
                Swal.fire('Error', 'Error de conexión.', 'error'); 
            });
        }
    });
}


function calcularEstadisticasIncidentes() {
    const totalHistorico = incidentes.length;
    $('#incidentes-historico').text(totalHistorico);

    // Calcular días sin incidentes
    if (totalHistorico > 0) {
        // Ordenar incidentes por fecha, de más antigua a más reciente
        const incidentesOrdenados = [...incidentes].sort((a, b) => new Date(a.fechaIncidente) - new Date(b.fechaIncidente));
        const ultimaFechaStr = incidentesOrdenados[incidentesOrdenados.length - 1].fechaIncidente;
        const ultimaFecha = new Date(ultimaFechaStr + 'T00:00:00');
        
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);

        // Asegurarse de que la última fecha no sea en el futuro
        if (ultimaFecha > hoy) {
            $('#dias-sin-incidentes').text('?'); // Indica datos futuros
        } else {
            const diffTime = Math.abs(hoy - ultimaFecha);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Usar floor para contar días completos
            $('#dias-sin-incidentes').text(diffDays);
        }
    } else {
         // Si no hay incidentes, calcular desde el inicio del primer empleado
        if (colaboradoresIngresos.length > 0) {
            const ingresosOrdenados = [...colaboradoresIngresos].sort((a, b) => new Date(a.fechaInicio) - new Date(b.fechaInicio));
            const primeraFechaStr = ingresosOrdenados[0].fechaInicio;
            const primeraFecha = new Date(primeraFechaStr + 'T00:00:00');
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
             if (primeraFecha > hoy) {
                 $('#dias-sin-incidentes').text('0');
             } else {
                const diffTime = Math.abs(hoy - primeraFecha);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                $('#dias-sin-incidentes').text(diffDays);
             }
        } else {
            $('#dias-sin-incidentes').text('---'); // No hay datos
        }
    }

    const hoy = new Date();
    const periodos = [{ id: 'mes', meses: 0 }, { id: '3meses', meses: 3 }, { id: '6meses', meses: 6 }, { id: '12meses', meses: 12 }];
    
    periodos.forEach(p => {
        // Corrección: para 3, 6, 12 meses, debe ser p.meses, no p.meses-1, para incluir el mes actual.
        const fechaInicio = p.meses === 0 ? new Date(hoy.getFullYear(), hoy.getMonth(), 1) : new Date(hoy.getFullYear(), hoy.getMonth() - p.meses + 1, 1);
        const incidentesPeriodo = incidentes.filter(i => new Date(i.fechaIncidente + 'T00:00:00') >= fechaInicio).length;
        $(`#incidentes-${p.id}`).text(incidentesPeriodo);
    });
}


function crearGraficoIncidentesAnual(ano) {
    if (graficoIncidentesAnual) graficoIncidentesAnual.destroy();
    const ctx = document.getElementById('graficoIncidentesAnual').getContext('2d');
    const labels = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    const datos = Array(12).fill(0);

    incidentes.forEach(i => {
        const fechaIncidente = new Date(i.fechaIncidente + 'T00:00:00');
        if (fechaIncidente.getFullYear() === ano) {
            datos[fechaIncidente.getMonth()]++;
        }
    });

    graficoIncidentesAnual = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `Incidentes por Mes en ${ano}`,
                data: datos,
                borderColor: '#f39c12',
                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
}


function crearGraficoIncidentesCategoria(canvasId, targetData) {
     // (Req 2.1) Sobre el gráfico de pirámide:
     // Chart.js no tiene un tipo "pirámide" nativo. La visualización profesional
     // estándar para este tipo de datos (que se asemeja a una pirámide)
     // es un gráfico de barras horizontal. Lo implementaré de esa manera.
     
     const conteo = {};
     // Definir el orden deseado (de más grave a menos grave)
     const labelsOrdenados = ["FAT", "LWC", "MTC", "FAC", "N-M"];
     const ordenCategorias = { "FAT": 0, "LWC": 0, "MTC": 0, "FAC": 0, "N-M": 0 };
     
     targetData.forEach(i => {
        if (ordenCategorias.hasOwnProperty(i.categoriaSiso)) {
            ordenCategorias[i.categoriaSiso]++;
        }
     });
     
     // Mapear los datos en el orden definido
     const data = labelsOrdenados.map(label => ordenCategorias[label]);
     
     // Colores (de más grave a menos grave)
     const backgroundColors = ['#e74c3c', '#e67e22', '#f39c12', '#3498db', '#2ecc71'];

     const ctx = document.getElementById(canvasId).getContext('2d');
     // Destruir gráfico anterior
     const chartInstance = Chart.getChart(canvasId);
     if (chartInstance) {
        chartInstance.destroy();
     }

     return new Chart(ctx, {
        type: 'bar', // <-- CAMBIADO A GRÁFICO DE BARRAS
        data: { 
            labels: labelsOrdenados, // Eje Y
            datasets: [{ 
                data: data, // Eje X
                backgroundColor: backgroundColors 
            }] 
        },
        options: { 
            indexAxis: 'y', // <-- HACE EL GRÁFICO HORIZONTAL
            responsive: true, 
            maintainAspectRatio: false,
            scales: {
                x: { // Eje X (conteo)
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1 // Solo números enteros
                    }
                }
            },
            plugins: { 
                legend: { display: false }, // La leyenda es redundante
                title: { display: true, text: 'Distribución por Categoría' } 
            } 
        }
    });
}

// --- INICIO: NUEVAS FUNCIONES (Req 2.2 y 3.1) ---

function generarSimbologiaIncidentes() {
    const simbologia = [
        { clase: 'simb-fat', texto: 'FAT: Fatalidades' },
        { clase: 'simb-lwc', texto: 'LWC: Pérdida de tiempo' },
        { clase: 'simb-mtc', texto: 'MTC: Tratamiento médico' },
        { clase: 'simb-fac', texto: 'FAC: Primeros auxilios' },
        { clase: 'simb-nm', texto: 'N-M: Casi Incidentes' }
    ];
    
    let html = '<h6 class="text-center">Simbología de Incidentes</h6><div class="incidentes-simbologia">';
    simbologia.forEach(s => {
        html += `<span class="${s.clase}">${s.texto}</span>`;
    });
    html += '</div>';
    $('#incidentes-simbologia').html(html);
}

function mostrarResumenIncidentes() {
    if (incidentes.length === 0) {
        Swal.fire('Sin Datos', 'No hay incidentes registrados para mostrar un resumen.', 'info');
        return;
    }

    const conteo = {};
    incidentes.forEach(reg => {
        // Solo contar si el colaborador está activo
        if (colaboradoresActivos.some(activo => activo.identidad === reg.identidad)) {
            if (!conteo[reg.identidad]) {
                const colaboradorInfo = colaboradoresActivos.find(c => c.identidad === reg.identidad);
                conteo[reg.identidad] = {
                    nombre: colaboradorInfo.nombre,
                    identidad: colaboradorInfo.identidad,
                    fotoUrl: colaboradorInfo.fotoUrl,
                    count: 0,
                    categorias: {} // Para rastrear tipos de incidentes
                };
            }
            conteo[reg.identidad].count++;
            // Contar categorías
            const cat = reg.categoriaSiso;
            conteo[reg.identidad].categorias[cat] = (conteo[reg.identidad].categorias[cat] || 0) + 1;
        }
    });

    const sorted = Object.values(conteo).sort((a, b) => b.count - a.count);
    
    const modalHtml = `
        <div class="mb-3 px-2">
            <input type="text" id="filtro-resumen-incidentes" class="form-control" placeholder="Buscar por nombre o identidad...">
        </div>
        <div id="resumen-lista-colaboradores" style="max-height: 400px; overflow-y: auto; text-align: left;">
        </div>`;

    function renderResumenList(items) {
        const container = $('#resumen-lista-colaboradores');
        container.empty();
        if (items.length === 0) {
            container.html('<p class="text-center text-muted mt-3">No se encontraron colaboradores activos con incidentes registrados.</p>');
            return;
        }
        let listHtml = '';
        items.forEach(item => {
            let color = "warning"; // Default
            if (item.categorias['FAT'] || item.categorias['LWC']) color = "danger";
            else if (item.categorias['MTC']) color = "warning";
            else if (item.categorias['FAC'] || item.categorias['N-M']) color = "info";
            
            const fotoSrc = item.fotoUrl || `https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random`;
            listHtml += `
                <div class="resumen-disciplina-item" data-identidad="${item.identidad}" style="cursor: pointer;">
                    <img src="${fotoSrc}" class="resumen-disciplina-img" onerror="this.src='https://ui-avatars.com/api/?name=${item.nombre.replace(/\s/g, "+")}&background=random'">
                    <div class="resumen-disciplina-info">
                        <h6>${item.nombre}</h6>
                        <span class="badge bg-${color}">${item.count} Incidente(s)</span>
                    </div>
                </div>`;
        });
        container.html(listHtml);
    }

    Swal.fire({
        title: 'Resumen de Incidentes por Colaborador Activo',
        html: modalHtml,
        width: '700px',
        showCloseButton: true,
        showConfirmButton: false,
        didOpen: () => {
            renderResumenList(sorted);
            $('#filtro-resumen-incidentes').on('input', function() {
                const query = $(this).val().toLowerCase();
                const filtered = sorted.filter(item =>
                    item.nombre.toLowerCase().includes(query) || item.identidad.toLowerCase().includes(query)
                );
                renderResumenList(filtered);
            });

            $(document).on('click', '.resumen-disciplina-item', function() {
                const identidad = $(this).data('identidad');
                mostrarDetalleIncidentesColaborador(identidad);
            });
        },
        willClose: () => {
            $(document).off('click', '.resumen-disciplina-item');
        }
    });
}

function mostrarDetalleIncidentesColaborador(identidad) {
    const historial = incidentes.filter(d => d.identidad === identidad).sort((a,b) => new Date(b.fechaIncidente) - new Date(a.fechaIncidente));
    const colaborador = colaboradoresActivos.find(c => c.identidad === identidad) || { nombre: 'N/A', identidad: identidad, fotoUrl: '' };

    let historialHtml = '<div style="max-height: 300px; overflow-y: auto; text-align: left; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">';
    if (historial.length > 0) {
        historial.forEach((reg, index) => {
            
            let badgeColor = 'secondary';
            if (reg.categoriaSiso === 'FAT' || reg.categoriaSiso === 'LWC') badgeColor = 'danger';
            else if (reg.categoriaSiso === 'MTC') badgeColor = 'warning text-dark';
            else if (reg.categoriaSiso === 'FAC') badgeColor = 'info';
            else if (reg.categoriaSiso === 'N-M') badgeColor = 'success';
            
            // --- INICIO: CAMBIO Req 1 (Mostrar partes afectadas) ---
            let partesHtml = '';
            if (reg.parteAfectada && reg.parteAfectada.length > 0) {
                partesHtml = `<li><strong>Parte(s) Afectada(s):</strong> ${reg.parteAfectada.replace(/; /g, ', ')}</li>`;
            }
            // --- FIN: CAMBIO Req 1 ---

            historialHtml += `
                <div class="mb-2">
                    <strong>${formatearFecha(reg.fechaIncidente)}:</strong> <span class="badge bg-${badgeColor}">${reg.categoriaSiso}</span>
                    <ul class="mb-1 mt-1" style="font-size: 0.9rem;">
                        <li><strong>Descripción:</strong> ${reg.descripcion}</li>
                        <li><strong>Causa:</strong> ${reg.causa}</li>
                        ${partesHtml} ${reg.medidas ? `<li><strong>Medidas:</strong> ${reg.medidas}</li>` : ''}
                    </ul>
                </div>
                ${index < historial.length - 1 ? '<hr class="my-2">' : ''}
            `;
        });
    } else {
        historialHtml += '<p class="text-center text-muted">No se encontraron registros de incidentes.</p>';
    }
    historialHtml += '</div>';
    
    const fotoSrc = colaborador.fotoUrl || `https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random`;
    const detailModalHtml = `
        <div class="d-flex justify-content-start mb-3">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-volver-resumen-incidentes">
                <i class="fas fa-arrow-left me-1"></i> Volver al Resumen
            </button>
        </div>
        <div class="text-center mb-3">
            <img src="${fotoSrc}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #dee2e6;" onerror="this.src='https://ui-avatars.com/api/?name=${colaborador.nombre.replace(/\s/g, "+")}&background=random'">
            <h5 class="mt-2 mb-0">${colaborador.nombre}</h5>
            <span class="badge bg-secondary">${colaborador.identidad}</span>
            <p class="mt-2">Total de incidentes: <strong>${historial.length}</strong></p>
        </div>
        ${historialHtml}
    `;

    Swal.fire({
        title: 'Detalle de Incidentes',
        html: detailModalHtml,
        width: '600px',
        showCloseButton: true,
        showConfirmButton: false,
        didOpen: () => {
            const volverBtn = Swal.getPopup().querySelector('#btn-volver-resumen-incidentes');
            if (volverBtn) {
                volverBtn.addEventListener('click', () => {
                    Swal.close();
                    mostrarResumenIncidentes();
                });
            }
        }
    });
}



// --- INICIO: NUEVA FUNCIÓN (Req 3) ---

    function crearGraficoPartesCuerpo() {
        if (graficoPartesCuerpo) {
            graficoPartesCuerpo.destroy();
        }

        const conteo = {};
        // 1. Contar todas las partes del cuerpo
        incidentes.forEach(inc => {
            if (inc.parteAfectada && inc.parteAfectada.length > 0) {
                const partesArray = inc.parteAfectada.split('; ');
                partesArray.forEach(parte => {
                    // Normalizar (ej. "brazo izquierdo" y "Brazo Izquierdo" son lo mismo)
                    const parteNormalizada = parte.trim(); 
                    if (parteNormalizada) {
                        conteo[parteNormalizada] = (conteo[parteNormalizada] || 0) + 1;
                    }
                });
            }
        });

        // 2. Ordenar de más afectado a menos afectado
        const sortedPartes = Object.entries(conteo).sort(([,a],[,b]) => b - a);
        const labels = sortedPartes.map(entry => entry[0]);
        const data = sortedPartes.map(entry => entry[1]);

        // 3. Crear el Gráfico de Barras
        const ctx = document.getElementById('graficoPartesCuerpo').getContext('2d');
        graficoPartesCuerpo = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Conteo de Incidentes',
                    data: data,
                    backgroundColor: 'rgba(230, 126, 34, 0.7)',
                    borderColor: 'rgba(211, 84, 0, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', // Horizontal
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // 4. Actualizar el Mapa Corporal (Hotspots)
        actualizarBodyMap(conteo);
    }

    function actualizarBodyMap(conteo) {
        // Objeto para mapear los strings a los IDs de los hotspots
        const mapIds = {
            'Cabeza': '#hotspot-cabeza',
            'Ojos': '#hotspot-ojos',
            'Torso': '#hotspot-torso',
            'Brazo Izquierdo': '#hotspot-brazo-izquierdo',
            'Brazo Derecho': '#hotspot-brazo-derecho',
            'Mano Izquierda': '#hotspot-mano-izquierda',
            'Mano Derecha': '#hotspot-mano-derecha',
            'Pierna Izquierda': '#hotspot-pierna-izquierda',
            'Pierna Derecha': '#hotspot-pierna-derecha',
            'Pie Izquierdo': '#hotspot-pie-izquierdo',
            'Pie Derecho': '#hotspot-pie-derecho',
            'Otro': '#hotspot-otro'
        };

        // Resetear todos los hotspots
        $('.hotspot').removeClass('active').text('0');

        // Activar y poner conteo
        for (const parte in conteo) {
            if (mapIds[parte]) {
                const hotspotId = mapIds[parte];
                const count = conteo[parte];
                $(hotspotId).addClass('active').text(count);
                $(hotspotId).attr('title', `${parte}: ${count} incidente(s)`); // Actualizar tooltip
            }
        }
    }

    // --- FIN: NUEVA FUNCIÓN (Req 3) ---


// --- FIN FUNCIONES NUEVAS ---



function crearGraficoIncidentesCategoriaActual() {
    if (graficoIncidentesCategoriaActual) graficoIncidentesCategoriaActual.destroy();
    const hoy = new Date(), mesActual = hoy.getMonth(), anoActual = hoy.getFullYear();
    const datosMes = incidentes.filter(i => {
        const fecha = new Date(i.fechaIncidente + 'T00:00:00');
        return fecha.getMonth() === mesActual && fecha.getFullYear() === anoActual;
    });
    graficoIncidentesCategoriaActual = crearGraficoIncidentesCategoria('graficoIncidentesCategoriaActual', datosMes);
    graficoIncidentesCategoriaActual.options.plugins.title.text = 'Distribución (Mes Actual)';
    graficoIncidentesCategoriaActual.update();
}

function crearGraficoIncidentesCategoriaHistorico() {
    if (graficoIncidentesCategoriaHistorico) graficoIncidentesCategoriaHistorico.destroy();
    graficoIncidentesCategoriaHistorico = crearGraficoIncidentesCategoria('graficoIncidentesCategoriaHistorico', incidentes);
    graficoIncidentesCategoriaHistorico.options.plugins.title.text = 'Distribución (Histórica)';
    graficoIncidentesCategoriaHistorico.update();
}

function crearGraficoIncidentesCategoriaFiltrado(ano, mes) {
    if (graficoIncidentesCategoriaFiltrado) graficoIncidentesCategoriaFiltrado.destroy();
    const datosFiltrados = incidentes.filter(i => {
        const fecha = new Date(i.fechaIncidente + 'T00:00:00');
        return fecha.getMonth() === mes && fecha.getFullYear() === ano;
    });
    graficoIncidentesCategoriaFiltrado = crearGraficoIncidentesCategoria('graficoIncidentesCategoriaFiltrado', datosFiltrados);
    const nombreMes = new Date(ano, mes).toLocaleString('es-ES', { month: 'long' });
    graficoIncidentesCategoriaFiltrado.options.plugins.title.text = `Distribución (${nombreMes} ${ano})`;
    graficoIncidentesCategoriaFiltrado.update();
}

function mostrarHistorialIncidentes(datos) {
    const datosAMostrar = datos || incidentes;
    const tabla = $('#tabla-incidentes').empty();
    if (datosAMostrar.length === 0) {
        // --- Colspan ajustado a 9 ---
        tabla.append('<tr><td colspan="9" class="text-center">No hay incidentes para el filtro seleccionado.</td></tr>');
        return;
    }
    [...datosAMostrar].sort((a, b) => new Date(b.fechaIncidente) - new Date(a.fechaIncidente)).forEach(i => {

        let partesHtml = '';
        if (i.parteAfectada && i.parteAfectada.length > 0) {
            const partesArray = i.parteAfectada.split('; ');
            partesHtml = '<ul>' + partesArray.map(p => `<li>${p}</li>`).join('') + '</ul>';
        } else {
            partesHtml = '';
        }

        // --- INICIO: Botón Editar añadido ---
        tabla.append(`
            <tr class="no-hover">
                <td>${formatearFecha(i.fechaIncidente)}</td>
                <td>${i.nombre}</td>
                <td>${i.identidad}</td>
                <td>${i.categoriaSiso}</td>
                <td>${i.descripcion}</td>
                <td>${partesHtml}</td>
                <td>${i.causa}</td>
                <td>${i.medidas || ''}</td>
                <td>
                    <button class="btn btn-warning btn-sm btn-action btn-edit-incidente"
                            data-identidad="${i.identidad}"
                            data-fecha="${i.fechaIncidente}"
                            title="Editar Incidente">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>`);
        // --- FIN: Botón Editar añadido ---
    });
    // El event listener se manejará en configurarEventos
}


function filtrarIncidentesTabla() {
    const texto = $('#buscador-incidentes').val().toLowerCase();
    $('#tabla-incidentes tr').each(function() {
        const nombre = $(this).find('td:eq(1)').text().toLowerCase();
        const identidad = $(this).find('td:eq(2)').text().toLowerCase();
        const categoria = $(this).find('td:eq(3)').text().toLowerCase();
        const descripcion = $(this).find('td:eq(4)').text().toLowerCase();
        const parteAfectada = $(this).find('td:eq(5)').text().toLowerCase(); // <-- AÑADIDO
        $(this).toggle(
            nombre.includes(texto) || 
            identidad.includes(texto) || 
            categoria.includes(texto) || 
            descripcion.includes(texto) ||
            parteAfectada.includes(texto) // <-- AÑADIDO
        );
    });
}


function filtrarIncidentesPersonalizado() {
    const inicio = $('#fecha-inicio-incidentes').val();
    const fin = $('#fecha-fin-incidentes').val();
    let incidentesFiltrados = incidentes;

    if (inicio && fin) {
        incidentesFiltrados = incidentes.filter(i => i.fechaIncidente >= inicio && i.fechaIncidente <= fin);
    } else if (inicio) {
        incidentesFiltrados = incidentes.filter(i => i.fechaIncidente >= inicio);
    } else if (fin) {
        incidentesFiltrados = incidentes.filter(i => i.fechaIncidente <= fin);
    }

    mostrarHistorialIncidentes(incidentesFiltrados);
}

// --- FIN FUNCIONES PARA INCIDENTES ---

    </script>
</body>
</html>
