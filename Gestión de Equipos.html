<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pisos Brillantes</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .header {
        background-color: #007BFF;
        color: white;
        text-align: center;
        padding: 15px 0;
        font-size: 1.5em;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    }

    @media screen and (max-width: 600px) {
        .back-button {
            font-size: 0.9em;
            padding: 12px 18px;
            top: 57px;
            left: 0px;
        }
    }

    @media screen and (display-mode: standalone) {
        body {
            margin: 0;
            padding: 0;
        }
    }

    .form-container label {
        display: block;
        margin: 10px 0 5px;
        font-size: 14px;
        color: #555;
    }

    .form-container select, .form-container input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ddd;
        box-sizing: border-box;
        transition: all 0.3s ease;
    }

    .form-container select:focus, .form-container input:focus {
        border-color: #007bff;
        outline: none;
    }

    .form-container input[type="date"] {
        padding: 12px;
    }

    .form-container .select-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    h1 {
        text-align: center;
        color: #333;
        margin-top: 20px;
        font-size: 24px;
        margin-bottom: 30px;
    }

    .form-container {
        width: 80%;
        max-width: 900px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .equipo {
        margin-bottom: 20px;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        background-color: #f9f9f9;
        cursor: pointer;
        transition: background-color 0.3s;
        border: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        font-weight: bold;
    }

    .equipo:hover {
        background-color: #e0e0e0;
    }

    .equipo img {
        width: 40px;
        height: 40px;
        object-fit: contain;
        pointer-events: none;
    }

    .equipo label {
        display: block;
        color: #333;
        flex-grow: 1;
    }

    .disponible {
        color: green;
    }

    .no-disponible {
        color: red;
        font-size: 11px;
        font-weight: normal;
    }

    .equipos-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }

    #solicitar {
        background-color: #28a745;
    }

    #devolver {
        background-color: #dc3545;
    }

    #solicitar, #devolver {
        margin-top: 0;
        margin-right: 10px;
        padding: 10px 20px;
        width: 100%;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: inline-block;
    }

    #solicitar:disabled, #devolver:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .button-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }

    .button-container button {
        font-size: 16px;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 45%;
        box-sizing: border-box;
    }

    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    @media (max-width: 768px) {
        .equipo {
            font-size: 12px;
        }

        .equipos-container {
            grid-template-columns: repeat(2, 1fr);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background-color: white;
            padding: 15px 0;
        }

        .equipo {
            width: calc(50% - 7.5px);
            box-sizing: border-box;
        }
    }

    .swal-content {
        font-size: 0.9em;
        line-height: 1.4;
    }

    .swal-button, .swal-button-cancel {
        font-size: 0.9em;
        padding: 10px 20px;
        min-width: 100px;
        text-align: center;
    }

    .swal-popup {
        width: 300px;
        max-width: 90%;
    }

    .swal-button {
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
    }

    .swal-button-cancel {
        background-color: #f5f5f5;
        color: #333;
        border: none;
        border-radius: 4px;
    }

    .question-container {
        margin-bottom: 20px;
        text-align: left;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
        transition: border-color 0.3s;
        box-sizing: border-box;
    }

    .question-container:hover {
        border-color: #007BFF;
    }

    .question-container input[type="date"],
    .question-container select {
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 5px;
        width: 100%;
        font-size: 16px;
        background-color: #f9f9f9;
        color: #333;
        transition: border-color 0.3s;
        box-sizing: border-box;
        margin-top: 5px;
    }

    .question-container input[type="date"]:focus,
    .question-container select:focus {
        border-color: #007BFF;
        outline: none;
    }

    .question-container label {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
        display: block;
    }

    .question-container select:disabled, .question-container input:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .search-container {
        margin: 20px 0;
        width: 100%;
    }

    #buscador {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
        margin-bottom: 15px;
    }

    #buscador:focus {
        border-color: #007bff;
        outline: none;
    }

    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(0, 123, 255, 0.2);
        border-radius: 50%;
        border-top-color: #007BFF;
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    #loadingMessage {
        text-align: center;
        color: #333;
        font-family: Arial, sans-serif;
    }

    #loadingMessage h3 {
        margin: 0 0 10px;
        font-size: 1.2em;
    }

    #loadingMessage p {
        margin: 0;
        color: #666;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .category-separator {
        width: 100%;
        clear: both;
        text-align: left;
        margin: 15px 0 5px 0;
        padding: 8px 15px;
        background-color: #f0f0f0;
        border-radius: 5px;
        font-size: 1.1em;
        grid-column: 1 / -1;
        flex-basis: 100%;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .category-separator strong {
        flex-grow: 1;
    }

    .category-separator .toggle-icon {
        margin-left: 10px;
        transition: transform 0.3s ease;
    }

    .category-separator.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .scroll-button {
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s ease, transform 0.3s ease;
        position: fixed;
        right: 20px;
        z-index: 1000;
    }

    .scroll-button:hover {
        background-color: #0056b3;
        transform: scale(1.1);
    }

    #scroll-top-button {
        top: 20px;
    }

    #scroll-bottom-button {
        bottom: 20px;
    }

    @media (max-width: 600px) {
        .scroll-button {
            width: 40px;
            height: 40px;
            font-size: 1.3em;
            right: 15px;
        }
        #scroll-top-button {
            top: 15px;
        }
        #scroll-bottom-button {
            bottom: 15px;
        }
    }

    .checklist-container {
        max-height: 50vh;
        overflow-y: auto;
        margin: 15px 0;
        text-align: left;
    }

    .checklist-item {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px;
    }

    .checklist-item label {
        font-size: 14px;
        color: #333;
        flex-grow: 1;
    }

    .checklist-image-container {
        text-align: center;
        margin-bottom: 20px;
    }

    .checklist-image-container img {
        max-width: 120px;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .checklist-buttons {
        display: flex;
        gap: 10px;
    }

    /* Nuevos estilos para los botones del checklist */
    .check-button, .x-button {
        width: 50px; /* Ancho ajustado para el texto */
        height: 30px;
        border-radius: 4px; /* Esquinas ligeramente redondeadas */
        font-weight: bold;
        cursor: pointer;
        border: 1px solid #ccc;
        transition: all 0.2s ease;
    }

    .check-button {
        background-color: #f0f0f0;
        color: #333;
    }
    
    .check-button.selected {
        background-color: green;
        color: white;
        border-color: green;
    }

    .x-button {
        background-color: #f0f0f0;
        color: #333;
    }
    
    .x-button.selected {
        background-color: red;
        color: black;
        border-color: red;
    }
    
    /* Estilos para los botones de modo Salidas/Entradas */
    .modo-buttons {
        display: flex;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 6px;
        overflow: hidden;
    }

    .modo-button {
        flex: 1;
        padding: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        background-color: #f0f0f0;
        color: #555;
        border: none;
        outline: none;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .modo-button.activo {
        background-color: #007BFF;
        color: white;
    }

    .modo-button:hover:not(.activo) {
        background-color: #e0e0e0;
    }

    /* Estilo para el contenedor de la firma */
    .firma-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 5px;
        background-color: #fff;
        /* Aseguramos que haya suficiente espacio para el canvas más grande */
        min-height: 200px; /* o más, dependiendo de tus necesidades */
    }

    /* Botones debajo del lienzo */
    .firma-buttons {
        margin-top: 10px;
    }

    /* Estilo para el botón de limpiar */
    .firma-buttons button {
        background-color: #f44336;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .firma-buttons button:hover {
        background-color: #d32f2f;
    }

    .icon-button {
        background: #f8f9fa;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 5px;
        cursor: pointer;
        font-size: 18px;
        color: #333;
    }

    .icon-button.active {
        background: #007bff;
        color: #fff;
    }

    .icon-button:hover {
        background: #e2e6ea;
    }

    /* Oculta los botones excepto el de limpiar */
    #toggleEraser, #undo, #redo {
        display: none;
    }
    
    /* Opcional: Ajusta el espaciado si es necesario */
    .firma-buttons {
        justify-content: center;
    }

    /* Estilo mejorado para el área de carga de imágenes */
    .file-upload {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        width: 100%;
        padding: 30px 20px;
        background: #f0f8ff;
        border: 2px dashed #007BFF;
        border-radius: 12px;
        text-align: center;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
        box-sizing: border-box;
        color: #007BFF;
        transition: all 0.3s ease;
    }

    .file-upload:hover {
        background-color: #e6f3ff;
        border-color: #0056b3;
    }

    .file-upload i {
        font-size: 2.5em;
        margin-bottom: 10px;
        color: #007BFF;
    }

    .file-upload-text {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .file-upload-subtext {
        font-size: 0.85em;
        color: #666;
    }

    .file-upload input[type="file"] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    /* Estilo para el contenedor de vista previa */
    .image-preview {
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        border: 0px solid #ccc;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        box-sizing: border-box;
        margin-top: 15px;
    }

    .image-preview-item {
        position: relative;
        width: 85px;
        height: 85px;
        overflow: hidden;
        border-radius: 5px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .delete-icon {
        position: absolute;
        top: 5px;
        left: 5px;
        width: 20px;
        height: 20px;
        background: rgba(255, 0, 0, 0.8);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .image-preview-item:hover .delete-icon {
        opacity: 1;
    }

    /* Estilos para autocomplete */
    .autocomplete-container {
        position: relative;
        width: 100%;
    }

    #colaborador {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #ddd;
        box-sizing: border-box;
        transition: all 0.3s ease;
    }

    #colaborador:focus {
        border-color: #007bff;
        outline: none;
    }

    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        display: none;
    }

    .autocomplete-suggestion {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .autocomplete-suggestion:hover {
        background-color: #f0f8ff;
    }

    .autocomplete-suggestion.highlighted {
        background-color: #e6f2ff;
    }
</style>
</head>
<body>
    <div class="header">Pisos Brillantes</div>

    <div class="form-container">
        <h1>Gestión de Equipos</h1>

        <div class="modo-buttons">
            <button id="btnSalidas" class="modo-button activo" onclick="cambiarModo('salidas')">Salidas</button>
            <button id="btnEntradas" class="modo-button inactivo" onclick="cambiarModo('entradas')">Entradas</button>
        </div>

        <div class="question-container">
            <div>
                <label for="fecha"><strong>Fecha:</strong></label>
                <input type="date" id="fecha" name="fecha">
            </div>

            <label for="colaborador"><strong>Colaborador:</strong></label>
            <div class="autocomplete-container">
                <input type="text" id="colaborador" name="colaborador" placeholder="Escribe el nombre del colaborador" autocomplete="off">
                <div class="autocomplete-suggestions" id="colaborador-suggestions"></div>
            </div>

            <label for="area"><strong>Destino:</strong></label>
            <select id="area" name="area">
                <option value="">Seleccionar área</option>
            </select>
        </div>

        <label><strong id="titulo-equipos">Seleccione el equipo a prestar:</strong></label>

        <form id="formulario">
            <div class="search-container">
                <input type="text" id="buscador" placeholder="Buscar equipos...">
            </div>

            <div class="equipos-container" id="equipos"></div>
            <br>

<div class="question-container" id="adjunto4Container">
    <label for="adjunto4"><strong>Evidencia (Fotos):</strong></label>
    <div class="file-upload" id="drag-area4" onclick="document.getElementById('adjunto4').click()">
        <input type="file" id="adjunto4" name="adjunto4" accept="image/*" multiple capture="environment">
        <i class="fas fa-camera"></i>
        <div class="file-upload-text">Toca aquí para tomar fotos</div>
        <div class="file-upload-subtext">o arrastra imágenes a este área</div>
    </div>
    <div id="preview4" class="image-preview"></div>
</div>


<div class="question-container">
    <label for="firma">Firma del Responsable:</label>
    <div id="firmaContainer" class="firma-container">
        <canvas id="firmaCanvas" width="400" height="200" style="border: 1px solid #ccc;"></canvas>
    </div>
    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
        <button type="button" id="toggleEraser" title="Borrador" class="icon-button">
            <i class="fas fa-eraser"></i>
        </button>
        <button type="button" id="undo" title="Deshacer" class="icon-button">
            <i class="fas fa-undo"></i>
        </button>
        <button type="button" id="redo" title="Rehacer" class="icon-button">
            <i class="fas fa-redo"></i>
        </button>
        <button type="button" id="clearSignature" title="Limpiar" class="icon-button">
            <i class="fas fa-trash-alt"></i>
        </button>
    </div>
</div>



            <div class="button-container">
                <button type="button" id="solicitar" disabled onclick="solicitarEquipo()">Solicitar Equipo</button>
                <button type="button" id="devolver" disabled onclick="devolverEquipo()" style="display: none;">Devolver Equipo</button>
            </div>
        </form>
    </div>

<div id="overlay">
    <div class="spinner"></div>
    <div id="loadingMessage">
        <h4>Por favor espera un momento...</h4>
        <p></p>
    </div>
</div>

<button class="scroll-button" id="scroll-top-button" onclick="scrollToTop()" title="Ir al inicio">&#9650;</button>
<button class="scroll-button" id="scroll-bottom-button" onclick="scrollToBottom()" title="Ir al final">&#9660;</button>

<script>
    jQuery.fn.firstUntil = function(selector) {
        const result = $();
        this.each(function() {
            let next = $(this).next();
            while (next.length && !next.is(selector)) {
                result.add(next);
                next = next.next();
            }
        });
        return result;
    };

    let equipos = [];
    let colaboradores = [];
    let areas = ["Bodega"];
    let equipoSeleccionado = null;
    let categoriaSeleccionada = "";
    let modoActual = "salidas";
    let ultimaTransaccion = null;

    const checklistsPreOperativos = {
        "aspiradoras": [
            "La aspiradora está limpia por fuera",
            "El cable de alimentación está en buen estado",
            "La bolsa o depósito está vacío",
            "Los filtros están limpios",
            "Las ruedas giran correctamente",
            "No hay obstrucciones en la manguera",
            "Todos los accesorios están presentes",
            "Funciona correctamente al encenderla"
        ],
        "pulidoras": [
            "La pulidora está limpia por fuera",
            "El cable de alimentación está en buen estado",
            "El disco de pulido está en buen estado",
            "El mecanismo de velocidad funciona correctamente",
            "El interruptor de encendido funciona",
            "La base gira libremente sin ruidos extraños",
            "El mango ajustable está firme",
            "Todos los accesorios están presentes"
        ],
        "hidrolavadoras": [
            "La hidrolavadora está limpia por fuera",
            "Nivel de combustible suficiente",
            "Manguera de alta presión en buen estado",
            "Boquilla de spray funciona correctamente",
            "Filtro de agua limpio y sin obstrucciones",
            "Conexiones de agua sin fugas",
            "Interruptor de encendido funciona",
            "Nivel de aceite del motor verificado"
        ]
    };

    const checklistsPostOperativos = {
        "aspiradoras": [
            "La aspiradora fue limpiada después de su uso",
            "El cable de alimentación está en buen estado",
            "El bolsa o depósito fue vaciado y limpiado",
            "Los filtros fueron revisados y limpiados",
            "Las ruedas giran correctamente sin daños",
            "No hay obstrucciones en la manguera",
            "Todos los accesorios fueron devueltos",
            "La aspiradora funciona correctamente"
        ],
        "pulidoras": [
            "La pulidora fue limpiada después de su uso",
            "El cable de alimentación está en buen estado",
            "El disco de pulido fue revisado y reemplazado si es necesario",
            "El mecanismo de velocidad funciona correctamente",
            "El interruptor de encendido funciona",
            "La base gira libremente sin ruidos extraños",
            "El mango ajustable está firme y en buen estado",
            "Todos los accesorios fueron devueltos"
        ],
        "hidrolavadoras": [
            "La hidrolavadora fue limpiada después de su uso",
            "Se verificó el nivel de combustible restante",
            "Manguera de alta presión en buen estado sin fugas",
            "Boquilla de spray funciona correctamente",
            "Filtro de agua limpio y sin obstrucciones",
            "Conexiones de agua fueron revisadas y ajustadas",
            "Interruptor de encendido funciona correctamente",
            "Nivel de aceite del motor verificado y completado"
        ]
    };

    document.addEventListener('DOMContentLoaded', function() {
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var dd = String(today.getDate()).padStart(2, '0');
        document.getElementById("fecha").value = yyyy + '-' + mm + '-' + dd;

        cargarTodosLosDatos();
        configurarEventos();

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
        });

        document.querySelectorAll('img').forEach(img => {
            img.addEventListener('dragstart', function(e) {
                e.preventDefault();
            });
        });
    });

    function cambiarModo(modo) {
        modoActual = modo;
        equipoSeleccionado = null;
        $('.equipo').css('border-color', '#ddd').css('background-color', '#f9f9f9');
        $('#colaborador').val('').prop('disabled', false);
        $('#area').val('').prop('disabled', false);
        $('#buscador').prop('disabled', false).val('');

        if (modo === 'salidas') {
            $('#btnSalidas').removeClass('inactivo').addClass('activo');
            $('#btnEntradas').removeClass('activo').addClass('inactivo');
            $('#solicitar').show();
            $('#devolver').hide();
            $('#titulo-equipos').text('Seleccione el equipo a prestar:');
        } else {
            $('#btnSalidas').removeClass('activo').addClass('inactivo');
            $('#btnEntradas').removeClass('inactivo').addClass('activo');
            $('#solicitar').hide();
            $('#devolver').show();
            $('#titulo-equipos').text('Seleccione el equipo a devolver:');
        }

        mostrarEquiposEnUI();
        verificarFormulario();
    }

    function cargarTodosLosDatos() {
        $('#overlay').show();
        const scriptURL = "https://script.google.com/macros/s/AKfycbxbiQDZcTJA2I9XknV-VF-3E9NdK_b8xq-8fc4LkZ4jh5n4jkJQz0_UlB_zbKpHSJGl/exec";

        $.get(scriptURL, function(data) {
            $('#overlay').hide();
            if (data.error) {
                Swal.fire('Error', 'No se pudieron cargar los datos: ' + data.mensaje, 'error');
                return;
            }
            equipos = data.equipos;
            colaboradores = data.colaboradores;
            data.areas.forEach(area => {
                if (!areas.includes(area)) {
                    areas.push(area);
                }
            });

            mostrarEquiposEnUI();
            llenarSelects();
        }).fail(function(jqXHR, textStatus, errorThrown) {
            $('#overlay').hide();
            Swal.fire('Error', 'No se pudo conectar al servidor o hubo un error de red. ' + textStatus + ': ' + errorThrown, 'error');
            console.error("Error en la solicitud AJAX:", jqXHR, textStatus, errorThrown);
        });
    }

    function llenarSelects() {
        const colaboradorSelect = $('#colaborador');
        const areaSelect = $('#area');
        colaboradorSelect.find('option:not(:first)').remove();
        areaSelect.find('option:not(:first)').remove();
        colaboradores.forEach(col => {
            colaboradorSelect.append(`<option value="${col}">${col}</option>`);
        });
        areas.forEach(area => {
            areaSelect.append(`<option value="${area}">${area}</option>`);
        });
    }

    function mostrarEquiposEnUI() {
        const equiposContainer = $('#equipos');
        equiposContainer.empty();

        equipos.forEach((equipo, index) => {
            if (equipo.nombre.startsWith("-")) {
                let categoryName = equipo.nombre.substring(1).trim();
                equiposContainer.append(`
                    <div class="category-separator">
                        <strong>${categoryName}</strong> <span class="toggle-icon">&#9660;</span>
                    </div>
                `);
                return;
            }

            if (modoActual === "salidas" && !equipo.disponible) {
                return;
            }

            if (modoActual === "entradas" && equipo.disponible) {
                return;
            }

            let estadoClass = equipo.disponible ? 'disponible' : 'no-disponible';
            let estadoText = equipo.disponible ? 'Disponible' : `Ocupada por: ${equipo.asignadoA}`;

            let equipoHtml = `
                <div class="equipo" id="equipo-${index}" onclick="seleccionarEquipo(${index})">
                    <img src="${equipo.imagen || ''}" alt="${equipo.nombre}" onerror="this.style.display='none'">
                    <label>${equipo.nombre}</label>
                    <span class="${estadoClass}">${estadoText}</span>
                </div>
            `;

            equiposContainer.append(equipoHtml);

            if (!equipo.disponible && modoActual === "salidas") {
                $(`#equipo-${index}`).css('opacity', '0.6').css('cursor', 'not-allowed');
            }
        });

        $('.category-separator').on('click', function() {
            const $separator = $(this);
            const $toggleIcon = $separator.find('.toggle-icon');
            const $equiposToToggle = $separator.nextUntil('.category-separator');
            $equiposToToggle.toggle();
            $separator.toggleClass('collapsed');
            if ($separator.hasClass('collapsed')) {
                $toggleIcon.html('&#9658;');
            } else {
                $toggleIcon.html('&#9660;');
            }
        });
    }

    function configurarEventos() {
        $('#buscador').on('input', filtrarEquipos);
        $("#fecha, #colaborador, #area").on("change", verificarFormulario);
    }

    function filtrarEquipos() {
        const textoBusqueda = $('#buscador').val().toLowerCase();
        if (textoBusqueda === '') {
            $('.equipo').show();
            $('.category-separator').show().removeClass('collapsed').find('.toggle-icon').html('&#9660;');
            return;
        }

        $('.equipo').hide();
        $('.category-separator').hide();

        $('.equipo').each(function() {
            const nombreEquipo = $(this).find('label').text().toLowerCase();
            if (nombreEquipo.includes(textoBusqueda)) {
                $(this).show();
                $(this).prevAll('.category-separator:first').show().removeClass('collapsed').find('.toggle-icon').html('&#9660;');
            }
        });
    }

    function determinarCategoria(equipoIndex) {
        let categoria = "";
        for (let i = equipoIndex; i >= 0; i--) {
            if (equipos[i].nombre.startsWith("-")) {
                categoria = equipos[i].nombre.substring(1).trim().toLowerCase();
                break;
            }
        }
        return categoria;
    }

    function seleccionarEquipo(index) {
        const equipo = equipos[index];
        if (!equipo.disponible && modoActual === "salidas") {
            return;
        }

        $('.equipo').css('border-color', '#ddd').css('background-color', '#f9f9f9');
        $(`#equipo-${index}`).css('border-color', '#007BFF').css('background-color', '#e6f0ff');
        equipoSeleccionado = equipo;
        categoriaSeleccionada = determinarCategoria(index);

        if (modoActual === "entradas") {
            $('#buscador').prop('disabled', true);
            $('#colaborador').prop('disabled', true);
            $('#area').prop('disabled', true).val("Bodega");
            if (equipoSeleccionado.asignadoA) {
                $('#colaborador').val(equipoSeleccionado.asignadoA);
            }
        }

        verificarFormulario();
    }

    function isCanvasBlank(canvas) {
        const context = canvas.getContext('2d', {
            willReadFrequently: true
        });
        const pixelBuffer = new Uint32Array(
            context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
        );
        return !pixelBuffer.some(color => color !== 0);
    }

    function verificarFormulario() {
        let fecha = $("#fecha").val();
        let colaborador = $("#colaborador").val();
        let area = $("#area").val();
        const hayFotos = selectedFiles.preview4.length > 0;
        const hayFirma = !isCanvasBlank(document.getElementById('firmaCanvas'));
        
        // Validar que el colaborador ingresado existe en la lista
        const colaboradorValido = allColaboradores.includes(colaborador);
        
        if (fecha && colaborador && area && equipoSeleccionado && hayFotos && hayFirma && colaboradorValido) {
            if (modoActual === "salidas") {
                $("#solicitar").prop("disabled", false);
            } else {
                $("#devolver").prop("disabled", false);
            }
        } else {
            $("#solicitar").prop("disabled", true);
            $("#devolver").prop("disabled", true);
        }
        
        // Cambiar el color del borde según si es válido o no
        if (colaborador && !colaboradorValido) {
            $("#colaborador").css("border-color", "red");
        } else {
            $("#colaborador").css("border-color", colaborador ? "#28a745" : "#ddd");
        }
    }

    function seleccionarBoton(event) {
        const button = $(event.target);
        const parent = button.closest('.checklist-item');
        parent.find('.check-button, .x-button').removeClass('selected');
        button.addClass('selected');
        const todosSeleccionados = verificarChecklistCompleto();
        if (Swal.getConfirmButton()) {
            Swal.getConfirmButton().disabled = !todosSeleccionados;
        }
    }

    function generarChecklistHTML(checklist, tipo) {
        let titulo = tipo === 'pre' ? 'Checklist Preoperativo' : 'Checklist Postoperativo';

        let checklistHTML = `
            <div class="checklist-image-container">
                <img src="${equipoSeleccionado.imagen}" alt="${equipoSeleccionado.nombre}">
            </div>
            <div class="checklist-container">
                <h4 style="margin-bottom: 15px; color: #007BFF;">${titulo}</h4>
        `;

        checklist.forEach((item, i) => {
            checklistHTML += `
                <div class="checklist-item" id="item-${i}">
                    <label>${item}</label>
                    <div class="checklist-buttons">
                        <button type="button" class="check-button" data-value="✔" onclick="seleccionarBoton(event)">Sí</button>
                        <button type="button" class="x-button" data-value="X" onclick="seleccionarBoton(event)">No</button>
                    </div>
                </div>
            `;
        });

        checklistHTML += `</div>`;
        return checklistHTML;
    }

    function verificarChecklistCompleto() {
        const items = $('.checklist-item');
        let todosSeleccionados = true;
        items.each(function() {
            const isSelected = $(this).find('.check-button.selected, .x-button.selected').length > 0;
            if (!isSelected) {
                todosSeleccionados = false;
                return false;
            }
        });
        return todosSeleccionados;
    }

    function solicitarEquipo() {
        let fecha = $('#fecha').val();
        let colaborador = $('#colaborador').val();
        let area = $('#area').val();
        const checklist = checklistsPreOperativos[categoriaSeleccionada] || checklistsPreOperativos["aspiradoras"];
        
        Swal.fire({
            title: 'Checklist Preoperativo',
            html: generarChecklistHTML(checklist, 'pre'),
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Confirmar y Solicitar',
            cancelButtonText: 'Cancelar',
            width: '600px',
            didOpen: () => {
                const todosSeleccionados = verificarChecklistCompleto();
                Swal.getConfirmButton().disabled = !todosSeleccionados;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const checklistRespuestas = [];
                $('.checklist-item').each(function() {
                    const selectedButton = $(this).find('.selected');
                    checklistRespuestas.push(selectedButton.data('value'));
                });

                ultimaTransaccion = {
                    fecha: fecha,
                    colaborador: colaborador,
                    area: area,
                    equipo: equipoSeleccionado.nombre,
                    categoria: categoriaSeleccionada,
                    tipo: 'salidas',
                    checklist: checklist.map((item, i) => ({
                        item: item,
                        respuesta: checklistRespuestas[i]
                    }))
                };
                
                Swal.fire({
                    title: 'Confirmar Préstamo',
                    html: `
                        <div style="text-align: left;">
                            <p><strong>Fecha:</strong> ${fecha}</p>
                            <p><strong>Colaborador:</strong> ${colaborador}</p>
                            <p><strong>Área:</strong> ${area}</p>
                            <p><strong>Equipo:</strong> ${equipoSeleccionado.nombre}</p>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, enviar',
                    cancelButtonText: 'No, revisar',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    width: '500px'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#overlay').show();
                        const scriptURL = "https://script.google.com/macros/s/AKfycbweOAqrT8cQuoW9xPbWBwOyLxbORFTT6HaStsNUz7i9ySkTRlElJIirZwcoGC-l8Sb-/exec";
                        $.ajax({
                            url: scriptURL,
                            type: "POST",
                            data: {
                                fecha: fecha,
                                colaborador: colaborador,
                                area: area,
                                equipo: equipoSeleccionado.nombre,
                                categoria: categoriaSeleccionada,
                                retornable: equipoSeleccionado.devolucion,
                                checklist: JSON.stringify(checklistRespuestas)
                            },
                            success: function(response) {
                                $('#overlay').hide();
Swal.fire({
    title: '¡Éxito!',
    html: `
        <div style="text-align: center;">
            <p style="font-size: 1.1em; margin-bottom: 15px;">Préstamo registrado correctamente</p>
            <div style="color: #28a745; font-size: 2em;">
                <i class="fas fa-check-circle"></i>
            </div>
            <button id="generarPdfBtn" class="swal2-confirm swal2-styled" style="background-color: #007bff; margin-top: 15px;">Generar y Compartir PDF</button>
        </div>
    `,
    icon: 'success',
    showConfirmButton: false,
    showCloseButton: true, // Esto añade el botón 'X' para cerrar
    allowOutsideClick: false, // ¡Este es el cambio!
    didOpen: () => {
        $('#generarPdfBtn').on('click', () => {
            generarPDF();
        });
    }
}).then((result) => {
    // Si el usuario hace clic en la 'X' para cerrar
    if (result.dismiss === Swal.DismissReason.close) {
        location.reload();
    }
});
                            },
                            error: function(xhr, status, error) {
                                $('#overlay').hide();
                                Swal.fire('Error', 'Hubo un problema al registrar el préstamo. Por favor inténtalo nuevamente.', 'error');
                            }
                        });
                    }
                });
            }
        });
    }

    function devolverEquipo() {
        let fecha = $('#fecha').val();
        let colaborador = $('#colaborador').val();
        let area = $('#area').val();
        const checklist = checklistsPostOperativos[categoriaSeleccionada] || checklistsPostOperativos["aspiradoras"];

        Swal.fire({
            title: 'Checklist Postoperativo',
            html: generarChecklistHTML(checklist, 'post'),
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Confirmar Devolución',
            cancelButtonText: 'Cancelar',
            width: '600px',
            didOpen: () => {
                const todosSeleccionados = verificarChecklistCompleto();
                Swal.getConfirmButton().disabled = !todosSeleccionados;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const checklistRespuestas = [];
                $('.checklist-item').each(function() {
                    const selectedButton = $(this).find('.selected');
                    checklistRespuestas.push(selectedButton.data('value'));
                });

                ultimaTransaccion = {
                    fecha: fecha,
                    colaborador: colaborador,
                    area: area,
                    equipo: equipoSeleccionado.nombre,
                    categoria: categoriaSeleccionada,
                    tipo: 'entradas',
                    checklist: checklist.map((item, i) => ({
                        item: item,
                        respuesta: checklistRespuestas[i]
                    }))
                };

                Swal.fire({
                    title: 'Confirmar Devolución',
                    html: `
                        <div style="text-align: left;">
                            <p><strong>Fecha:</strong> ${fecha}</p>
                            <p><strong>Colaborador:</strong> ${colaborador}</p>
                            <p><strong>Área:</strong> ${area}</p>
                            <p><strong>Equipo:</strong> ${equipoSeleccionado.nombre}</p>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, devolver',
                    cancelButtonText: 'No, revisar',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    width: '500px'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#overlay').show();
                        const scriptURL = "https://script.google.com/macros/s/AKfycbw4OfK5DQQqbiro8olfyb8MvjQnOHGZBoELkTBJnOYS2GMpkr8yFrJJASiAiAxxePGfzA/exec";
                        $.ajax({
                            url: scriptURL,
                            type: "POST",
                            data: {
                                fecha: fecha,
                                colaborador: colaborador,
                                area: area,
                                equipo: equipoSeleccionado.nombre,
                                categoria: categoriaSeleccionada,
                                checklist: JSON.stringify(checklistRespuestas),
                                tipo: 'devolucion'
                            },
                            success: function(response) {
                                $('#overlay').hide();
Swal.fire({
    title: '¡Éxito!',
    html: `
        <div style="text-align: center;">
            <p style="font-size: 1.1em; margin-bottom: 15px;">Devolución registrada correctamente</p>
            <div style="color: #28a745; font-size: 2em;">
                <i class="fas fa-check-circle"></i>
            </div>
            <button id="generarPdfBtn" class="swal2-confirm swal2-styled" style="background-color: #007bff; margin-top: 15px;">Generar y Compartir PDF</button>
        </div>
    `,
    icon: 'success',
    showConfirmButton: false,
    showCloseButton: true,
    allowOutsideClick: false, // ¡Este es el cambio!
    didOpen: () => {
        $('#generarPdfBtn').on('click', () => {
            generarPDF();
        });
    }
}).then((result) => {
    // Si el usuario hace clic en la 'X' para cerrar
    if (result.dismiss === Swal.DismissReason.close) {
        location.reload();
    }
});
                            },
                            error: function(xhr, status, error) {
                                $('#overlay').hide();
                                Swal.fire('Error', 'Hubo un problema al registrar la devolución. Por favor inténtalo nuevamente.', 'error');
                            }
                        });
                    }
                });
            }
        });
    }

    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function scrollToBottom() {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    // Funciones agregadas para el manejo de imágenes y PDF
    const selectedFiles = {
        preview3: [],
        preview4: []
    };

    function handleFileInput(event, previewId) {
        const files = event.target.files;
        const previewContainer = document.getElementById(previewId);

        Array.from(files).forEach((file) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.classList.add('image-preview-item');
                div.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div class="delete-icon" onclick="deleteImage('${previewId}', ${selectedFiles[previewId].length})">×</div>
                `;
                previewContainer.appendChild(div);

                selectedFiles[previewId].push(file);
                verificarFormulario();
            };
            reader.readAsDataURL(file);
        });
        event.target.value = "";
    }

    function deleteImage(previewId, index) {
        const previewContainer = document.getElementById(previewId);

        if (previewContainer.children[index]) {
            previewContainer.removeChild(previewContainer.children[index]);
            selectedFiles[previewId].splice(index, 1);

            Array.from(previewContainer.children).forEach((child, newIndex) => {
                const deleteIcon = child.querySelector('.delete-icon');
                if (deleteIcon) {
                    deleteIcon.setAttribute('onclick', `deleteImage('${previewId}', ${newIndex})`);
                }
            });
            verificarFormulario();
        }
    }

    document.getElementById('adjunto4').addEventListener('change', (e) => handleFileInput(e, 'preview4'));
    document.getElementById('drag-area4').addEventListener('dragover', (event) => {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('drag-area4').style.backgroundColor = "#e0f7ff";
    });
    document.getElementById('drag-area4').addEventListener('dragleave', (event) => {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById('drag-area4').style.backgroundColor = "#f0f8ff";
    });
    document.getElementById('drag-area4').addEventListener('drop', (event) => {
        event.preventDefault();
        event.stopPropagation();
        const files = event.dataTransfer.files;
        handleFileInput({
            target: {
                files
            }
        }, 'preview4');
    });

    async function compressImage(file, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 600;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(dataUrl);
                };
                img.src = event.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function addPhotoSection(doc, title, files, startY) {
        if (files.length === 0) return startY;
        let currentY = startY;
        const pageHeight = doc.internal.pageSize.getHeight();
        const spaceNeeded = 10 + 10 + 40;
        if (currentY + spaceNeeded > pageHeight - 10) {
            doc.addPage();
            currentY = 15;
        }
        doc.setFontSize(14);
        doc.setFont("times", "bold");
        doc.text(title, 10, currentY);
        currentY += 10;
        const imgWidth = 60;
        const imgHeight = 40;
        const marginX = 15;
        const spacingX = 65;
        const spacingY = 45;
        let currentX = marginX;
        let imagesInRow = 0;
        for (const file of files) {
            const imgData = await compressImage(file, 0.5);
            if (imagesInRow === 3) {
                imagesInRow = 0;
                currentX = marginX;
                currentY += spacingY;
            }
            if (currentY + imgHeight > pageHeight - 10) {
                doc.addPage();
                currentY = 15;
                currentX = marginX;
                imagesInRow = 0;
            }
            doc.addImage(imgData, 'JPEG', currentX, currentY, imgWidth, imgHeight);
            currentX += spacingX;
            imagesInRow++;
        }
        return currentY + spacingY;
    }


async function generarPDF() {
    const {
        jsPDF
    } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        format: 'letter',
        unit: 'mm'
    });
    doc.setFont("times", "normal");
    const tipoMovimiento = ultimaTransaccion.tipo === 'salidas' ? 'Acta de Compromiso' : 'Acta de Recepción';
    const tituloChecklist = ultimaTransaccion.tipo === 'salidas' ? 'Checklist Preoperativo' : 'Checklist Postoperativo';
    const now = new Date();
    const horaGeneracion = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
    const [yyyy, mm, dd] = ultimaTransaccion.fecha.split('-');
    const meses = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];
    const mesTexto = meses[parseInt(mm) - 1];
    let y = 15;
    const margin = 15;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const textWidth = pageWidth - (2 * margin);
    doc.setFontSize(16);
    doc.setTextColor(34, 49, 63);
    doc.setFont("times", "bold");
    doc.text(tipoMovimiento, pageWidth / 2, y, {
        align: 'center'
    });
    y += 8;
    doc.setDrawColor(200, 200, 200);
    doc.line(margin, y, pageWidth - margin, y);
    y += 10;
    doc.setFontSize(12);
    doc.setTextColor(50, 50, 50);
    doc.setFont("times", "normal");

    if (ultimaTransaccion.tipo === 'salidas') {
        const textoCompleto = `Yo ${ultimaTransaccion.colaborador} mediante la presente Acta de Compromiso hago constar que en esta fecha estoy recibiendo el equipo ${ultimaTransaccion.equipo}, el cual será utilizado para el desempeño de mis funciones.`;
        const lineas = doc.splitTextToSize(textoCompleto, textWidth);
        doc.text(lineas, margin, y);
        y += (lineas.length * 6) + 4;
        doc.setFont("times", "bold");
        const textoCompromiso = "Habiendo recibido me comprometo a lo siguiente:";
        doc.text(textoCompromiso, margin, y);
        y += 7;
        doc.setFont("times", "normal");
        const compromisos = [
            "- Cuidar y hacer buen uso del mismo, durante el tiempo que este bajo mi cargo en beneficio de las actividades del negocio.",
            "- En caso de accidente, daño por mal uso y cualquier que bajo mi uso dañe el equipo se procederá a realizar la deducción del valor completo proporcionando uno nuevo.",
            "- Me comprometo a cuidar todos y cada uno de los componentes del equipo."
        ];
        compromisos.forEach(compromiso => {
            const splitText = doc.splitTextToSize(compromiso, textWidth - 5);
            doc.text(splitText, margin + 5, y);
            y += (splitText.length * 5) + 3;
        });
        y += 5;
        const textoFinal = `Firmo la presente en la ciudad de Tegucigalpa a los ${dd} días del mes de ${mesTexto} del ${yyyy}.`;
        const lineasFinal = doc.splitTextToSize(textoFinal, textWidth);
        doc.text(lineasFinal, margin, y);
        y += (lineasFinal.length * 6) + 10;
    } else if (ultimaTransaccion.tipo === 'entradas') {
        const textoCompleto = `Yo ${ultimaTransaccion.colaborador} mediante la presente Acta de Recepción hago constar que en esta fecha estoy entregando el equipo ${ultimaTransaccion.equipo}, el cual fue utilizado para el desempeño de mis funciones y ahora estoy retornando.`;
        const lineas = doc.splitTextToSize(textoCompleto, textWidth);
        doc.text(lineas, margin, y);
        y += (lineas.length * 6) + 4;
        doc.setFont("times", "bold");
        const textoDeclaracion = "Al entregarla declaro lo siguiente:";
        doc.text(textoDeclaracion, margin, y);
        y += 7;
        doc.setFont("times", "normal");
        const declaraciones = [
            "- El equipo se encuentra en las mismas condiciones en las que me fue entregado.",
            "- Fui responsable y cuidadoso en el uso del equipo y todos sus componentes.",
            "- Cualquier daño, accidente o mal uso fue reportado en tiempo y forma."
        ];
        declaraciones.forEach(declaracion => {
            const splitText = doc.splitTextToSize(declaracion, textWidth - 5);
            doc.text(splitText, margin + 5, y);
            y += (splitText.length * 5) + 3;
        });
        y += 5;
        const textoFinal = `Firmo la presente en la ciudad de Tegucigalpa a los ${dd} días del mes de ${mesTexto} del ${yyyy}.`;
        const lineasFinal = doc.splitTextToSize(textoFinal, textWidth);
        doc.text(lineasFinal, margin, y);
        y += (lineasFinal.length * 6) + 10;
    }

    const canvasFirma = document.getElementById('firmaCanvas');
    const firmaDataUrl = canvasFirma.toDataURL('image/png');
    const firmaWidth = 60;
    const firmaHeight = 25;
    const firmaX = (pageWidth - firmaWidth) / 2;
    doc.addImage(firmaDataUrl, 'PNG', firmaX, y, firmaWidth, firmaHeight);
    y += firmaHeight + 2;
    doc.line(firmaX, y, firmaX + firmaWidth, y);
    y += 4;
    doc.setFontSize(12);
    doc.setTextColor(80, 80, 80);
    doc.setFont("times", "bold");
    doc.text(ultimaTransaccion.colaborador, pageWidth / 2, y, {
        align: 'center'
    });
    y += 10;
    doc.line(margin, y, pageWidth - margin, y);
    y += 8;
    doc.setFontSize(14);
    doc.setTextColor(34, 49, 63);
    doc.setFont("times", "bold");
    doc.text(tituloChecklist, margin, y);
    y += 6;
    const tableColumn = ["Punto de Verificación", "Sí", "No"];
    const tableRows = ultimaTransaccion.checklist.map(item => {
        const si = item.respuesta === "✔" ? "X" : "";
        const no = item.respuesta === "X" ? "X" : "";
        return [item.item, si, no];
    });
    const espacioDisponible = pageHeight - y - 15;
    const alturaPorFila = 5;
    const alturaEncabezado = 8;
    const alturaTotalTabla = alturaEncabezado + (tableRows.length * alturaPorFila);
    let fontSize = 9;
    let cellPadding = 2;
    let rowHeight = 5;
    if (alturaTotalTabla > espacioDisponible) {
        fontSize = 8;
        cellPadding = 1.5;
        rowHeight = 4;
    }
    const colWidth = (pageWidth - (2 * margin) - 24) / 1.5;
    doc.autoTable({
        startY: y,
        head: [tableColumn],
        body: tableRows,
        theme: 'grid',
        headStyles: {
            fillColor: [0, 123, 255],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: fontSize,
            font: "times",
            cellPadding: cellPadding,
            minCellHeight: rowHeight
        },
        styles: {
            fontSize: fontSize,
            cellPadding: cellPadding,
            textColor: [50, 50, 50],
            lineColor: [200, 200, 200],
            lineWidth: 0.1,
            font: "times",
            minCellHeight: rowHeight
        },
        columnStyles: {
            0: {
                cellWidth: colWidth,
                fontStyle: 'bold'
            },
            1: {
                cellWidth: 12,
                halign: 'center'
            },
            2: {
                cellWidth: 12,
                halign: 'center'
            }
        },
        margin: {
            top: y,
            left: margin,
            right: margin
        },
        tableWidth: 'wrap',
        pageBreak: 'avoid'
    });

    // Llamada a la nueva función para añadir las fotos
    let photosSectionY = doc.autoTable.previous.finalY + 15;
    photosSectionY = await addPhotoSection(doc, "Evidencia:", selectedFiles.preview4, photosSectionY);

    const tipoMovimientoNombre = ultimaTransaccion.tipo === 'salidas' ? 'Salida' : 'Entrada';
    const pdfName = `${dd}-${mm}-${yyyy} - ${tipoMovimientoNombre} - ${ultimaTransaccion.equipo} - ${ultimaTransaccion.colaborador}.pdf`;
    const pdfBlob = doc.output('blob');
    const pdfFile = new File([pdfBlob], pdfName, {
        type: 'application/pdf'
    });
    if (navigator.canShare && navigator.canShare({
            files: [pdfFile]
        })) {
        try {
            await navigator.share({
                files: [pdfFile],
                title: pdfName,
                text: `Comparto el documento de ${tipoMovimientoNombre} para el equipo ${ultimaTransaccion.equipo}.`
            });
        } catch (error) {
            console.error('Error al compartir el archivo:', error);
            // Agregado: Ignora el error de 'AbortError' que ocurre al cancelar
            if (error.name !== 'AbortError') {
                Swal.fire('Error', 'No se pudo compartir el archivo. ' + error.message, 'error');
            }
        }
    } else {
        doc.save(pdfName);
    }
}


    let isDrawing = false;
    let isErasing = false;
    let lastX = 0;
    let lastY = 0;
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    const undoStack = [];
    const redoStack = [];

    function saveToUndoStack() {
        undoStack.push(canvas.toDataURL());
        redoStack.length = 0;
    }

    function undo() {
        if (undoStack.length > 0) {
            saveToRedoStack();
            const lastState = undoStack.pop();
            const img = new Image();
            img.src = lastState;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            const lastState = redoStack.pop();
            undoStack.push(canvas.toDataURL());
            const img = new Image();
            img.src = lastState;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
        }
    }

    function saveToRedoStack() {
        redoStack.push(canvas.toDataURL());
    }

    function getCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        if (e.touches) {
            return {
                x: (e.touches[0].clientX - rect.left) * scaleX,
                y: (e.touches[0].clientY - rect.top) * scaleY
            };
        }
        return {
            x: (e.offsetX) * scaleX,
            y: (e.offsetY) * scaleY
        };
    }

    document.getElementById("toggleEraser").addEventListener("click", () => {
        isErasing = !isErasing;
        document.getElementById("toggleEraser").classList.toggle("active");
    });

    canvas.addEventListener("mousemove", (e) => {
        if (!isDrawing) return;
        const {
            x,
            y
        } = getCoordinates(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = isErasing ? "#FFF" : "#000";
        ctx.lineWidth = isErasing ? 10 : 4;
        ctx.stroke();
        lastX = x;
        lastY = y;
    });

    canvas.addEventListener("mousedown", (e) => {
        saveToUndoStack();
        isDrawing = true;
        const {
            x,
            y
        } = getCoordinates(e);
        lastX = x;
        lastY = y;
    });

    canvas.addEventListener("mouseup", () => {
        isDrawing = false;
        verificarFormulario(); // Nuevo: verifica el formulario al terminar de dibujar
    });
    canvas.addEventListener("mouseout", () => (isDrawing = false));
    document.getElementById("undo").addEventListener("click", undo);
    document.getElementById("redo").addEventListener("click", redo);
    document.getElementById("clearSignature").addEventListener("click", () => {
        localStorage.removeItem('canvasState');
        saveToUndoStack();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        verificarFormulario(); // Nuevo: verifica el formulario al limpiar
    });

    canvas.addEventListener("touchstart", (e) => {
        e.preventDefault();
        saveToUndoStack();
        isDrawing = true;
        const {
            x,
            y
        } = getCoordinates(e);
        lastX = x;
        lastY = y;
    });

    canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        if (!isDrawing) return;
        const {
            x,
            y
        } = getCoordinates(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = isErasing ? "#FFF" : "#000";
        ctx.lineWidth = isErasing ? 10 : 2;
        ctx.stroke();
        lastX = x;
        lastY = y;
    });

    canvas.addEventListener("touchend", (e) => {
        e.preventDefault();
        isDrawing = false;
        verificarFormulario(); // Nuevo: verifica el formulario al terminar de dibujar en móvil
    });

    canvas.addEventListener("touchcancel", (e) => {
        e.preventDefault();
        isDrawing = false;
    });

    function resizeCanvas() {
        const currentDrawing = canvas.toDataURL();
        const container = canvas.parentElement;
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        const rect = container.getBoundingClientRect();
        const newWidth = rect.width;
        const newHeight = rect.height;
        if (canvas.width !== newWidth || canvas.height !== newHeight) {
            canvas.width = newWidth;
            canvas.height = newHeight;
            const img = new Image();
            img.src = currentDrawing;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
        }
    }

    window.addEventListener("load", resizeCanvas);
    window.addEventListener("resize", resizeCanvas);

    function saveCanvasState() {
        const canvasData = canvas.toDataURL();
        localStorage.setItem('canvasState', canvasData);
    }

    function restoreCanvasState() {
        const canvasData = localStorage.getItem('canvasState');
        if (canvasData) {
            const img = new Image();
            img.src = canvasData;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
        }
    }
    canvas.addEventListener('click', restoreCanvasState);
    document.querySelectorAll('input, textarea').forEach(element => {
        element.addEventListener('focus', () => {
            saveCanvasState();
        });
    });



    // Nuevas variables para el autocomplete
    let allColaboradores = [];
    let selectedColaboradorIndex = -1;
    let filteredColaboradores = [];

    document.addEventListener('DOMContentLoaded', function() {
        // Código existente...
        
        // Inicializar eventos para el autocomplete
        initAutocomplete();
    });

    function initAutocomplete() {
        const input = document.getElementById('colaborador');
        const suggestionsContainer = document.getElementById('colaborador-suggestions');
        
        input.addEventListener('input', function(e) {
            const value = e.target.value.toLowerCase();
            filteredColaboradores = allColaboradores.filter(col => 
                col.toLowerCase().includes(value)
            );
            
            showSuggestions(filteredColaboradores);
            verificarFormulario();
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlightSuggestion('down');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlightSuggestion('up');
            } else if (e.key === 'Enter') {
                e.preventDefault();
                selectHighlightedSuggestion();
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
        
        input.addEventListener('blur', function() {
            // Ocultar sugerencias después de un pequeño retraso para permitir la selección
            setTimeout(hideSuggestions, 200);
        });
        
        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                hideSuggestions();
            }
        });
    }
    
    function showSuggestions(suggestions) {
        const suggestionsContainer = document.getElementById('colaborador-suggestions');
        suggestionsContainer.innerHTML = '';
        
        if (suggestions.length === 0) {
            hideSuggestions();
            return;
        }
        
        suggestions.forEach((suggestion, index) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-suggestion';
            div.textContent = suggestion;
            div.dataset.index = index;
            
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                selectSuggestion(suggestion);
            });
            
            div.addEventListener('mouseover', function() {
                highlightSuggestionIndex(index);
            });
            
            suggestionsContainer.appendChild(div);
        });
        
        suggestionsContainer.style.display = 'block';
        selectedColaboradorIndex = -1;
    }
    
    function hideSuggestions() {
        const suggestionsContainer = document.getElementById('colaborador-suggestions');
        suggestionsContainer.style.display = 'none';
        selectedColaboradorIndex = -1;
    }
    
    function highlightSuggestion(direction) {
        const suggestions = document.querySelectorAll('.autocomplete-suggestion');
        if (suggestions.length === 0) return;
        
        // Remover highlight actual
        suggestions.forEach(s => s.classList.remove('highlighted'));
        
        if (direction === 'down') {
            selectedColaboradorIndex = (selectedColaboradorIndex + 1) % suggestions.length;
        } else {
            selectedColaboradorIndex = (selectedColaboradorIndex - 1 + suggestions.length) % suggestions.length;
        }
        
        suggestions[selectedColaboradorIndex].classList.add('highlighted');
        suggestions[selectedColaboradorIndex].scrollIntoView({ block: 'nearest' });
    }
    
    function highlightSuggestionIndex(index) {
        const suggestions = document.querySelectorAll('.autocomplete-suggestion');
        suggestions.forEach(s => s.classList.remove('highlighted'));
        selectedColaboradorIndex = index;
        
        if (index >= 0 && index < suggestions.length) {
            suggestions[index].classList.add('highlighted');
        }
    }
    
    function selectHighlightedSuggestion() {
        if (selectedColaboradorIndex >= 0 && filteredColaboradores[selectedColaboradorIndex]) {
            selectSuggestion(filteredColaboradores[selectedColaboradorIndex]);
        }
    }
    
    function selectSuggestion(suggestion) {
        document.getElementById('colaborador').value = suggestion;
        hideSuggestions();
        verificarFormulario();
    }

    function llenarSelects() {
        // Ya no usamos el select de colaborador, pero mantenemos la variable allColaboradores
        allColaboradores = colaboradores;
        
        const areaSelect = $('#area');
        areaSelect.find('option:not(:first)').remove();
        areas.forEach(area => {
            areaSelect.append(`<option value="${area}">${area}</option>`);
        });
    }


</script>
</body>
</html>
