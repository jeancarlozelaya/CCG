<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pisos Brillantes</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --light-color: #ecf0f1;
        --dark-color: #34495e;
        --text-color: #333;
        --border-color: #ddd;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
        color: var(--text-color);
        line-height: 1.6;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        text-align: center;
        padding: 18px 0;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: var(--shadow);
        position: relative;
    }

    .form-container {
        width: 90%;
        max-width: 1000px;
        margin: 25px auto;
        padding: 25px;
        background-color: white;
        border-radius: 12px;
        box-shadow: var(--shadow);
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 25px;
        font-size: 1.8rem;
        position: relative;
        padding-bottom: 10px;
    }

    h1:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background-color: var(--secondary-color);
        border-radius: 2px;
    }

    .modo-buttons {
        display: flex;
        margin-bottom: 25px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
    }

    .modo-button {
        flex: 1;
        padding: 14px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        background-color: #f0f0f0;
        color: #555;
        border: none;
        outline: none;
        transition: var(--transition);
    }

    .modo-button.activo {
        background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
        color: white;
    }

    .modo-button:hover:not(.activo) {
        background-color: #e0e0e0;
    }

    .question-container {
        margin-bottom: 25px;
        padding: 20px;
        border-radius: 8px;
        background-color: #f8f9fa;
        border-left: 4px solid var(--secondary-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .question-container label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark-color);
    }

    .question-container input,
    .question-container select,
    .question-container textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 16px;
        transition: var(--transition);
        background-color: white;
    }

    .question-container input:focus,
    .question-container select:focus,
    .question-container textarea:focus {
        border-color: var(--secondary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .question-container select:disabled, 
    .question-container input:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .search-container {
        margin: 20px 0;
        position: relative;
    }

    #buscador {
        width: 100%;
        padding: 14px 20px;
        padding-left: 45px;
        font-size: 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: white;
        transition: var(--transition);
    }

    #buscador:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        outline: none;
    }

    .search-container:before {
        content: '\f002';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
        z-index: 2;
    }

    .category-separator {
        width: 100%;
        text-align: left;
        margin: 20px 0 10px 0;
        padding: 12px 20px;
        background: linear-gradient(to right, var(--primary-color), var(--dark-color));
        color: white;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        grid-column: 1 / -1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .category-separator:hover {
        background: linear-gradient(to right, var(--dark-color), var(--primary-color));
    }

    .category-separator .toggle-icon {
        transition: transform 0.3s ease;
    }

    .category-separator.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .equipos-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .equipo {
        background-color: white;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        transition: var(--transition);
        border: 1px solid #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        height: 100%;
        cursor: pointer;
    }

    .equipo:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-color: var(--secondary-color);
    }

    .equipo img {
        width: 50px;
        height: 50px;
        object-fit: contain;
        margin-bottom: 12px;
        pointer-events: none;
    }

    .equipo label {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--dark-color);
        font-size: 15px;
    }

    .disponible {
        color: var(--success-color);
        font-weight: 600;
    }

    .no-disponible {
        color: var(--accent-color);
        font-weight: 600;
        font-size: 0.85rem;
    }

    .image-preview {
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        box-sizing: border-box;
        margin-top: 15px;
    }

    .image-preview-item {
        position: relative;
        width: 85px;
        height: 85px;
        overflow: hidden;
        border-radius: 5px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .delete-icon {
        position: absolute;
        top: 5px;
        left: 5px;
        width: 20px;
        height: 20px;
        background: rgba(231, 76, 60, 0.8);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .image-preview-item:hover .delete-icon {
        opacity: 1;
    }

    .firma-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 15px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background-color: #fff;
        min-height: 200px;
    }

    .firma-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .icon-button {
        background: #f8f9fa;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 16px;
        color: #333;
        transition: var(--transition);
    }

    .icon-button.active {
        background: var(--secondary-color);
        color: #fff;
        border-color: var(--secondary-color);
    }

    .icon-button:hover {
        background: #e2e6ea;
    }

    #toggleEraser, #undo, #redo {
        display: none;
    }

    .button-container {
        display: flex;
        justify-content: center;
        margin-top: 25px;
        gap: 15px;
    }

    /* NUEVO BOTÓN UNIFICADO */
    #btnConfirmar {
        background: linear-gradient(to right, var(--success-color), #27ae60);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 14px 30px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 300px;
    }

    #btnConfirmar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    #btnConfirmar:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }


    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(52, 152, 219, 0.2);
        border-radius: 50%;
        border-top-color: var(--secondary-color);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    #loadingMessage {
        text-align: center;
        color: var(--dark-color);
    }

    #loadingMessage h4 {
        margin: 0 0 10px;
        font-size: 1.3rem;
    }

    #loadingMessage p {
        margin: 0;
        color: #7f8c8d;
    }

    .scroll-button {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: fixed;
        right: 25px;
        z-index: 1000;
    }

    .scroll-button:hover {
        background-color: var(--primary-color);
        transform: scale(1.1);
    }

    #scroll-top-button {
        top: 25px;
    }

    #scroll-bottom-button {
        bottom: 25px;
    }

    /* Estilos para autocomplete */
    .autocomplete-container {
        position: relative;
        width: 100%;
    }

    #colaborador {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 15px;
        font-size: 16px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-sizing: border-box;
        transition: var(--transition);
    }

    #colaborador:focus {
        border-color: var(--secondary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        display: none;
    }

    .autocomplete-suggestion {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: var(--transition);
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .autocomplete-suggestion:hover,
    .autocomplete-suggestion.highlighted {
        background-color: #f0f8ff;
    }

    /* --- NUEVOS ESTILOS PARA CHECKLIST INTEGRADO --- */
    #checklist-section {
        margin-top: 25px;
        padding: 20px;
        border-top: 2px solid var(--secondary-color);
        background: #fdfdfd;
        border-radius: 8px;
    }
    
    .checklist-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--border-color);
    }

    .checklist-title {
        color: var(--primary-color);
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    .checklist-subtitle {
        color: var(--dark-color);
        font-size: 1rem;
        font-weight: normal;
    }
    /* --- FIN NUEVOS ESTILOS --- */


    /* Estilos para checklist (ITEMS) */
    .checklist-container {
        max-height: 50vh;
        overflow-y: auto;
        margin: 15px 0;
        text-align: left;
        padding-right: 12px;
    }

    .checklist-container::-webkit-scrollbar {
        width: 8px;
    }

    .checklist-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .checklist-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .checklist-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .checklist-item {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column; 
        align-items: flex-start; 
        justify-content: space-between;
        padding: 12px; 
        gap: 10px;
        background: #f9f9f9;
        border-radius: 6px;
        border: 1px solid #eee;
    }

    .checklist-item label {
        font-size: 13px;
        color: #333;
        flex-grow: 1;
        margin-right: 10px;
        line-height: 1.3;
        word-wrap: break-word;
        overflow-wrap: break-word;
        font-weight: 600; 
    }

    .checklist-buttons {
        display: flex;
        gap: 4px;
        width: 100%; 
    }

    .check-button, .x-button {
        flex: 1; 
        height: 32px;
        border-radius: 3px;
        font-weight: bold;
        cursor: pointer;
        border: 1px solid #ccc;
        transition: all 0.2s ease;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 2px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.1;
        word-break: break-word;
        text-align: center;
    }

    .check-button {
        background-color: #f0f0f0;
        color: #333;
    }

    .check-button.selected {
        background-color: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }

    .x-button {
        background-color: #f0f0f0;
        color: #333;
    }

    .x-button.selected {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    
    /* --- ESTILOS PARA FOTOS DENTRO DEL CHECKLIST --- */
    .checklist-item-fotos {
        width: 100%;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }

    .foto-button {
        background: #f0f8ff;
        border: 1px dashed var(--secondary-color);
        color: var(--secondary-color);
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: var(--transition);
        width: 100%;
    }

    .foto-button:hover {
        background: #e6f3ff;
    }

    .foto-button i {
        margin-right: 5px;
    }

    .foto-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }

    /* Re-usamos el estilo de preview, pero ajustamos el tamaño */
    .foto-preview .image-preview-item {
        width: 60px;
        height: 60px;
    }

    .foto-preview .delete-icon {
        font-size: 12px;
        width: 18px;
        height: 18px;
    }
    /* --- FIN ESTILOS FOTOS CHECKLIST --- */


    /* Indicador de progreso */
    .progress-container {
        margin: 15px 0;
        background-color: #f0f0f0;
        border-radius: 10px;
        height: 10px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .progress-text {
        text-align: center;
        font-size: 0.9rem;
        color: var(--dark-color);
        margin-top: 5px;
    }

    /* Mejoras para la firma en móviles */
    #firmaCanvas {
        width: 100% !important;
        height: 200px !important;
        background: white;
        border: 1px solid #ccc;
        touch-action: none;
        -ms-touch-action: none;
    }

    .firma-container {
        position: relative;
        overflow: hidden;
    }

    /* Prevenir selección de texto en el canvas */
    #firmaCanvas {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* Botones de herramientas siempre visibles en móviles */
    @media (max-width: 768px) {
        #toggleEraser, #undo, #redo {
            display: block !important;
        }
        
        .firma-buttons {
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .icon-button {
            min-width: 44px; /* Tamaño mínimo para touch */
            min-height: 44px;
        }
    }

    @media (max-width: 768px) {
        .form-container {
            width: 95%;
            padding: 15px;
            margin: 15px auto;
        }
        
        .equipos-container {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        
        .equipo {
            padding: 12px;
        }
        
        .equipo img {
            width: 40px;
            height: 40px;
        }
        
        .category-separator {
            padding: 10px 15px;
            font-size: 1rem;
        }
        
        .scroll-button {
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            right: 15px;
        }
        
        #scroll-top-button {
            top: 15px;
        }
        
        #scroll-bottom-button {
            bottom: 15px;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        .button-container {
            flex-direction: column;
            align-items: center;
        }
        
        #btnConfirmar {
            width: 100%;
        }

        .checklist-item {
            flex-direction: column;
            align-items: flex-start;
        }

        .checklist-buttons {
            width: 100%;
            justify-content: space-between;
            margin-top: 8px;
        }

        .check-button, .x-button {
            flex: 1;
            max-width: 48%;
        }
    }

    @media (max-width: 480px) {
        .equipos-container {
            grid-template-columns: 1fr 1fr;
        }
        
        .question-container {
            padding: 15px;
        }
        
        #buscador {
            padding: 12px 15px;
            padding-left: 40px;
        }
        
        .modo-button {
            padding: 12px;
            font-size: 14px;
        }

        .checklist-title {
            font-size: 1.3rem;
        }

        .checklist-subtitle {
            font-size: 0.9rem;
        }
    }


    /* Botón flotante único para actas pendientes */
    #acta-pendiente-button {
        background-color: var(--warning-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: none;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: fixed;
        left: 25px;
        top: 80px;
        z-index: 1000;
    }

    #acta-pendiente-button:hover {
        background-color: #e67e22;
        transform: scale(1.1);
    }

    #acta-pendiente-button.pendiente {
        display: flex;
        animation: pulse 2s infinite;
    }

    #acta-pendiente-button .badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: var(--accent-color);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 0.8em;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
        }
    }

    /* Ajustes para móviles */
    @media (max-width: 768px) {
        #acta-pendiente-button {
            width: 55px;
            height: 55px;
            font-size: 1.3em;
            left: 15px;
            top: 70px;
        }

        #acta-pendiente-button .badge {
            width: 22px;
            height: 22px;
            font-size: 0.7em;
        }
    }

</style>
</head>
<body>
    <div class="header">Pisos Brillantes</div>
    
    <div class="form-container">
        <h1>Gestión de Equipos</h1>

        <div class="modo-buttons" id="modo-buttons">
            <button id="btnSalidas" class="modo-button activo" onclick="cambiarModo('salidas')">Salidas</button>
            <button id="btnEntradas" class="modo-button inactivo" onclick="cambiarModo('entradas')">Entradas</button>
        </div>

        <div class="question-container">
            <div>
                <label for="fecha"><strong>Fecha:</strong></label>
                <input type="date" id="fecha" name="fecha" class="auto-save">
            </div>

            <label for="colaborador"><strong>Colaborador:</strong></label>
            <div class="autocomplete-container">
                <input type="text" id="colaborador" name="colaborador" placeholder="Escribe el nombre del colaborador" autocomplete="off" class="auto-save">
                <div class="autocomplete-suggestions" id="colaborador-suggestions"></div>
            </div>

            <label for="area"><strong>Destino:</strong></label>
            <select id="area" name="area" class="auto-save">
                <option value="">Seleccionar área</option>
            </select>
        </div>

        <label><strong id="titulo-equipos">Seleccione el equipo a prestar:</strong></label>

        <form id="formulario">
            <div class="search-container">
                <input type="text" id="buscador" placeholder="Buscar equipos...">
            </div>

            <div class="equipos-container" id="equipos"></div>
            <br>

            <div id="checklist-section" style="display: none;">
                <div class="checklist-header">
                    <h2 class="checklist-title" id="checklistTitulo">Checklist Preoperativo</h2>
                    <p class="checklist-subtitle" id="checklistSubtitulo">Para: <span id="checklistEquipoNombre"></span></p>
                </div>
    
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0% completado</div>
    
                <div id="checklistContainer" class="checklist-container"></div>
    
                <div class="question-container" style="margin-top: 20px;">
                    <label for="checklistObservaciones"><strong>Observaciones:</strong></label>
                    <textarea id="checklistObservaciones" rows="3" placeholder="Escribe aquí cualquier observación adicional..." style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: vertical;" class="auto-save"></textarea>
                </div>
            </div>


            <div class="question-container">
                <label for="firma">Firma del Responsable:</label>
                <div id="firmaContainer" class="firma-container">
                    <canvas id="firmaCanvas" width="400" height="200" style="border: 1px solid #ccc;"></canvas>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                    <button type="button" id="toggleEraser" title="Borrador" class="icon-button">
                        <i class="fas fa-eraser"></i>
                    </button>
                    <button type="button" id="undo" title="Deshacer" class="icon-button">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button type="button" id="redo" title="Rehacer" class="icon-button">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button type="button" id="clearSignature" title="Limpiar" class="icon-button">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>

            <div class="button-container">
                <button type="button" id="btnConfirmar" onclick="validarFormularioCompleto()">Registrar Movimiento</button>
            </div>
        </form>

        </div>

    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Por favor espera un momento...</h4>
            <p></p>
        </div>
    </div>



    <button class="scroll-button" id="acta-pendiente-button" onclick="mostrarTodasLasActas()" title="Actas pendientes">
        <i class="fa-solid fa-download"></i>
        <span class="badge">0</span>
    </button>
    
    <button class="scroll-button" id="clear-session-button" onclick="confirmClearSession()" title="Borrar Sesión Actual y Empezar de Nuevo" style="bottom: 85px; background-color: var(--accent-color); display: none;">
        <i class="fa-solid fa-broom"></i>
    </button>


<script>
    // Extensión jQuery para navegación entre elementos
    jQuery.fn.firstUntil = function(selector) {
        const result = $();
        this.each(function() {
            let next = $(this).next();
            while (next.length && !next.is(selector)) {
                result.add(next);
                next = next.next();
            }
        });
        return result;
    };

    // === INICIO: VARIABLES GLOBALES Y CONSTANTES PARA PERSISTENCIA ===

    const SESSION_KEY = 'equiposSessionData'; 
    const DB_NAME = 'EquiposImageDB';       
    const STORE_NAME = 'checklistImages';                
    let db; // Variable global para la base de datos
    let isDbInitialized = false;

    // Variables globales (EXISTENTES)
    let equipos = [];
    let colaboradores = [];
    let areas = ["Bodega"];
    let equipoSeleccionado = null;
    let modoActual = "salidas";
    let ultimaTransaccion = null;
    let checklistEstado = {}; // {respuestas: [], fotos: {0: [id1, ...], 1: [...]}, observaciones: ""}
    let allColaboradores = [];

    // Constante para el número máximo de PDFs a guardar
    const MAX_PDFS_ALMACENADOS = 5;

    // Variables de Autocomplete
    let selectedColaboradorIndex = -1;
    let filteredColaboradores = [];

    // Checklists preoperativos y postoperativos (SIN CAMBIOS)
    const checklistsPreOperativos = {
        "aspiradoras": [
            "¿La aspiradora está limpia por fuera?",
            "¿El cable de alimentación no tiene cortes y no presenta daños?",
            "¿El Adaptador de Clavija (EUR - EUA) está presente?",
            "¿Las clavijas (pines) de los cables no presentan dobleces, rupturas o daños preexistentes?",
            "¿El seguro de presión está en buen estado, y asegura que la tapa encaje correctamente con el cuerpo de la aspiradora?",
            "¿El filtro de cartucho está presente, limpio y en buen estado?",
            "¿La bolsa de membrana está presente, en buen estado y bien colocada?",
            "¿La bolsa o saco de filtro está presente, no está llena ni dañada?",
            "¿El depósito de metal está vacío y limpio?",
            "¿La manguera de aspiración está presente y no presenta daños?",
            "¿La junta de sellado (o anillo de goma) de la manguera de aspiración está presente?",
            "¿La manguera de aspiración está libre de basura y no está atascada?",
            "¿Los dos tubos de aspiración están presentes y no presentan daños?",
            "¿Los tubos de aspiración están libres de basura y no están atascados?",
            "¿La boquilla de aspiración está limpia y en buen estado?",
            "¿Las ruedas giran bien y el estribo de empuje está en buen estado?",
            "¿La aspiradora enciende y aspira con fuerza cuando la activas?"
        ],
        "pulidoras": [
            "La pulidora está limpia por fuera",
            "El cable de alimentación está en buen estado",
            "El disco de pulido está en buen estado",
            "El mecanismo de velocidad funciona correctamente",
            "El interruptor de encendido funciona",
            "La base gira libremente sin ruidos extraños",
            "El mango ajustable está firme",
            "Todos los accesorios están presentes"
        ],
        "hidrolavadoras": [
            "La hidrolavadora está limpia por fuera",
            "Nivel de combustible suficiente",
            "Manguera de alta presión en buen estado",
            "Boquilla de spray funciona correctamente",
            "Filtro de agua limpio y sin obstrucciones",
            "Conexiones de agua sin fugas",
            "Interruptor de encendido funciona",
            "Nivel de aceite del motor verificado"
        ]
    };

    const checklistsPostOperativos = {
        "aspiradoras": [
            "¿La aspiradora está limpia por fuera?",
            "¿El cable de alimentación no tiene cortes, no presenta daños, y está bien guardado?",
            "¿El Adaptador de Clavija (EUR - EUA) está presente?",
            "¿Las clavijas (pines) de los cables no presentan nuevos dobleces, rupturas o daños?",
            "¿El seguro de presión no presenta daños, y asegura que la tapa encaje correctamente con el cuerpo de la aspiradora?",
            "¿El filtro de cartucho se limpió (si es necesario) y se revisó su estado?",
            "¿La bolsa de membrana está presente, y no presenta daños?",
            "¿La bolsa o saco de filtro se revisó y, si era necesario, se reemplazó?",
            "¿El depósito de metal esta vació y limpio?",
            "¿La manguera de aspiración está presente, libre de basura, sin daños y sin atascos?",
            "¿La junta de sellado (o anillo de goma) de la manguera ha sido devuelta?",
            "¿Los dos tubos de aspiración están presentes, libres de basura, sin daños y sin atascos?",
            "¿La boquilla de aspiración está limpia y en buen estado?",
            "¿Las ruedas giran bien y el estribo de empuje está en buen estado?"
        ],
        "pulidoras": [
            "La pulidora fue limpiada después de su uso",
            "El cable de alimentación está en buen estado",
            "El disco de pulido fue revisado y reemplazado si es necesario",
            "El mecanismo de velocidad funciona correctamente",
            "El interruptor de encendido funciona",
            "La base gira libremente sin ruidos extraños",
            "El mango ajustable está firme y en buen estado",
            "Todos los accesorios fueron devueltos"
        ],
        "hidrolavadoras": [
            "La hidrolavadora fue limpiada después de su uso",
            "Se verificó el nivel de combustible restante",
            "Manguera de alta presión en buen estado sin fugas",
            "Boquilla de spray funciona correctamente",
            "Filtro de agua limpio y sin obstrucciones",
            "Conexiones de agua fueron revisadas y ajustadas",
            "Interruptor de encendido funciona correctamente",
            "Nivel de aceite del motor verificado y completado"
        ]
    };
    
    // === FIN: VARIABLES GLOBALES Y CONSTANTES PARA PERSISTENCIA ===


    // === INICIO: LÓGICA DE INDEXEDDB ===

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                }
            };
            request.onsuccess = function(event) {
                db = event.target.result;
                isDbInitialized = true;
                console.log('IndexedDB abierta correctamente');
                resolve(db);
            };
            request.onerror = function(event) {
                console.error('Error al abrir IndexedDB:', event.target.error);
                Swal.fire('Error Crítico', 'No se pudo iniciar la base de datos local para fotos. La página no funcionará correctamente.', 'error');
                reject(event.target.error);
            };
        });
    }
    
    /**
     * Recupera una imagen de la DB usando su ID.
     */
    function getImageFromDB(id) {
        return new Promise((resolve, reject) => {
            if (!db) { reject('La base de datos no está inicializada.'); return; }
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(id);
            request.onsuccess = (event) => {
                const result = event.target.result;
                // Devolvemos la DataURL que es el campo 'image' del objeto almacenado
                resolve(result ? result.image : null); 
            };
            request.onerror = (event) => reject(event.target.error);
        });
    }

    function saveImageToDB(base64Data) {
        return new Promise((resolve, reject) => {
            if (!db) { reject('La base de datos no está inicializada.'); return; }
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.add({ image: base64Data });
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });
    }

    function deleteImageFromDB(id) {
        return new Promise((resolve, reject) => {
            if (!db) { reject('La base de datos no está inicializada.'); return; }
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject(event.target.error);
        });
    }

    function clearImageDB() {
        return new Promise((resolve, reject) => {
            if (!db) { reject('La base de datos no está inicializada.'); return; }
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.clear();
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject(event.target.error);
        });
    }

    // === FIN: LÓGICA DE INDEXEDDB ===


    // === INICIO: LÓGICA DE SESIÓN (AUTOGUARDADO Y RECUPERACIÓN) ===

    function saveSession() {
        const colaboradorVal = $('#colaborador').val();
        const areaVal = $('#area').val();
        
        // 1. CORRECCIÓN: Evitar guardar una sesión vacía (soluciona Issue 1 anterior)
        if (!equipoSeleccionado && !colaboradorVal && !areaVal) {
             localStorage.removeItem(SESSION_KEY);
             document.getElementById('clear-session-button').style.display = 'none';
             return; 
        }
        
        // Aseguramos que la firma se guarde antes de la sesión
        const canvas = document.getElementById('firmaCanvas');
        const firmaData = isCanvasBlank(canvas) ? null : canvas.toDataURL();
        
        // Guardamos las fotos del checklist como IDs si la DB está inicializada
        let fotosParaGuardar = {};
        if (isDbInitialized) {
            // El estado ya usa IDs si se inicializó correctamente
            fotosParaGuardar = checklistEstado.fotos; 
        } else {
            // Si la DB falló, guardamos la estructura, pero las fotos son dataURLs (menos robusto)
            fotosParaGuardar = checklistEstado.fotos; 
        }

        const sessionData = {
            modoActual: modoActual,
            fecha: $('#fecha').val(),
            colaborador: colaboradorVal,
            area: areaVal,
            equipoSeleccionadoNombre: equipoSeleccionado ? equipoSeleccionado.nombre : null,
            
            // Checklist: respuestas, observaciones y fotos (IDs)
            checklistEstado: {
                respuestas: checklistEstado.respuestas || [],
                observaciones: $('#checklistObservaciones').val() || "",
                fotos: fotosParaGuardar || {}
            },
            
            // Firma (DataURL)
            firmaData: firmaData,
            
            // Estado del canvas para deshacer/rehacer (Opcional, pero para consistencia)
            undoStackLength: undoStack.length,
            redoStackLength: redoStack.length
        };
        
        localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
        document.getElementById('clear-session-button').style.display = 'flex'; // Mostrar botón de limpieza manual
    }


    async function loadSession() {
        const dataString = localStorage.getItem(SESSION_KEY);
        if (!dataString) return;
        
        try {
            const data = JSON.parse(dataString);
            
            // Capturamos la fecha actual (la que se cargó por defecto en DOMContentLoaded)
            const defaultDate = document.getElementById("fecha").value; 
            
            // 1. Cargar datos de formulario
            $('#fecha').val(data.fecha || defaultDate); 
            $('#colaborador').val(data.colaborador);
            $('#area').val(data.area);
            
            // 2. Cambiar modo
            if (data.modoActual) {
                // Usamos la función original de cambiarModo, pero evitamos el autoguardado inicial
                const oldModo = modoActual;
                modoActual = data.modoActual; // Establecer globalmente antes de llamar
                
                // Actualizar botones (la lógica de la función cambiarModo se encargará del resto)
                if (modoActual === 'salidas') {
                    $('#btnSalidas').removeClass('inactivo').addClass('activo');
                    $('#btnEntradas').removeClass('activo').addClass('inactivo');
                    $('#titulo-equipos').text('Seleccione el equipo a prestar:');
                } else {
                    $('#btnSalidas').removeClass('activo').addClass('inactivo');
                    $('#btnEntradas').removeClass('inactivo').addClass('activo');
                    $('#titulo-equipos').text('Seleccione el equipo a devolver:');
                }
                
                // La lógica de mostrarEquiposEnUI se llama después de cargar todos los datos
                // Se cargará al final de DOMContentLoaded
            }

            // 3. Cargar Equipo Seleccionado (Necesitamos la lista `equipos` cargada)
            if (data.equipoSeleccionadoNombre && equipos.length > 0) {
                const index = equipos.findIndex(e => e.nombre === data.equipoSeleccionadoNombre);
                if (index !== -1) {
                    equipoSeleccionado = equipos[index];
                    // Resaltar en la UI (se hace en mostrarEquiposEnUI, pero lo forzamos aquí)
                    setTimeout(() => {
                         $(`#equipo-${index}`).css('border-color', '#007BFF').css('background-color', '#e6f0ff');
                         if (modoActual === "entradas") {
                            $('#buscador').prop('disabled', true);
                            $('#fecha').prop('disabled', true);
                            $('#colaborador').prop('disabled', true);
                            $('#area').prop('disabled', true).val("Bodega");
                            if (equipoSeleccionado.asignadoA) {
                                // Mantenemos el nombre del colaborador guardado en la sesión, si existe
                                if (!data.colaborador) {
                                    $('#colaborador').val(equipoSeleccionado.asignadoA);
                                }
                            }
                        }
                    }, 500); // Pequeño delay para asegurar que el DOM de equipos se renderizó
                }
            }

            // 4. Cargar Checklist
            if (data.checklistEstado) {
                checklistEstado = data.checklistEstado;
                
                // Si hay un equipo seleccionado, mostramos y restauramos el checklist
                if (equipoSeleccionado) {
                    await restaurarChecklistCompleto(checklistEstado);
                }
            }
            
            // 5. Cargar Firma
            if (data.firmaData) {
                const img = new Image();
                img.src = data.firmaData;
                img.onload = () => {
                    const canvas = document.getElementById("firmaCanvas");
                    const ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Restaurar stacks de deshacer/rehacer (si se guardaron)
                    undoStack.length = data.undoStackLength || 0;
                    redoStack.length = data.redoStackLength || 0;
                    updateButtonStates();
                    verificarFormulario();
                };
            }
            
            verificarFormulario(); // Actualizar estilos finales
            document.getElementById('clear-session-button').style.display = 'flex'; // Mostrar botón de limpieza manual
            
        } catch (e) {
            console.error("Error al cargar sesión (datos corruptos):", e);
            await clearSession();
        }
    }
    
    /**
     * Reune toda la lógica para restaurar el checklist (UI y Fotos).
     */
    async function restaurarChecklistCompleto(estado) {
        if (!equipoSeleccionado) return;
        
        const tipo = modoActual === 'salidas' ? 'pre' : 'post';
        const categoriaSeleccionada = determinarCategoria(equipos.findIndex(e => e.nombre === equipoSeleccionado.nombre));
        const checklistData = tipo === 'pre' ? 
            (checklistsPreOperativos[categoriaSeleccionada] || checklistsPreOperativos["aspiradoras"]) :
            (checklistsPostOperativos[categoriaSeleccionada] || checklistsPostOperativos["aspiradoras"]);

        // 1. Generar UI del checklist
        generarChecklistUI(checklistData); 
        
        // 2. Restaurar respuestas de botones
        restaurarEstadoChecklist(estado.respuestas || []);
        
        // 3. Restaurar observaciones
        $('#checklistObservaciones').val(estado.observaciones || '');
        
        // 4. Restaurar fotos (desde IndexedDB usando los IDs guardados)
        if (estado.fotos && isDbInitialized) {
            const fotosPromesas = Object.keys(estado.fotos).map(async (index) => {
                const ids = estado.fotos[index] || [];
                const restoredDataUrls = [];
                const validIds = [];
                for (const id of ids) {
                    // Obtener la imagen de la DB
                    const dataUrl = await getImageFromDB(id); 
                    if (dataUrl) {
                        // Aquí no necesitamos la dataUrl, solo necesitamos 
                        // que los IDs sigan siendo los mismos en el estado.
                        validIds.push(id);
                    } else {
                        console.warn(`ID de foto ${id} no encontrado. Eliminando del estado.`);
                    }
                }
                // Actualizar el array de IDs del estado (limpia IDs no encontrados)
                checklistEstado.fotos[index] = validIds; 
                await renderizarPreviews(index); // Renderiza las previews usando los IDs válidos
            });
            await Promise.all(fotosPromesas);
        } else if (estado.fotos) {
             // Si la DB falló, restauramos fotos usando los dataURLs (si se guardaron así)
             for (const index in estado.fotos) {
                 await renderizarPreviews(index); 
             }
        }
        
        // 5. Actualizar progreso final
        actualizarProgresoChecklist();
        $('#checklist-section').show();
    }


    async function clearSession() {
        localStorage.removeItem(SESSION_KEY);
        
        checklistEstado = {};
        
        // Limpiar formulario
        $('#fecha').val('');
        $('#colaborador').val('');
        $('#area').val('');
        equipoSeleccionado = null;
        ocultarChecklist();
        
        // Limpiar firma
        clearSignature();

        if (db) {
            try {
                await clearImageDB();
                console.log("IndexedDB de imágenes limpiada.");
            } catch (error) {
                console.error("No se pudo limpiar la IndexedDB:", error);
                Swal.fire('Error', 'No se pudo limpiar la base de datos de fotos.', 'warning');
            }
        }
        
        mostrarEquiposEnUI(); // Refrescar equipos
        cambiarModo('salidas'); // Volver al modo inicial
        
        // Al limpiar, forzamos la fecha a la de hoy nuevamente para consistencia
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var dd = String(today.getDate()).padStart(2, '0');
        document.getElementById("fecha").value = yyyy + '-' + mm + '-' + dd;
        
        // Ocultar botón de limpieza
        document.getElementById('clear-session-button').style.display = 'none';
    }

    // FUNCIÓN DE CONFIRMACIÓN CON DOBLE ADVERTENCIA (CORREGIDO)
    function confirmClearSession() {
        Swal.fire({
            title: '¿Limpiar Formulario?',
            text: "Esta acción eliminará el progreso actual y la sesión autoguardada. ¿Deseas continuar?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, borrar todo',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#e74c3c'
        }).then((result) => {
            if (result.isConfirmed) {
                // INICIO: SEGUNDA ADVERTENCIA (COMO AL CARGAR LA PÁGINA)
                Swal.fire({
                    title: '¿Estás 100% seguro?',
                    html: "Esta acción es irreversible y todo su progreso se perderá.",
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, borrar todo',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#e74c3c'
                }).then(async (deleteResult) => {
                    if (deleteResult.isConfirmed) {
                        await clearSession();
                        Swal.fire('Eliminado', 'Se ha borrado el progreso anterior.', 'success');
                    }
                    // Si cancela la segunda, se cierra este diálogo y vuelve al estado anterior
                });
                // FIN: SEGUNDA ADVERTENCIA
            }
        });
    }


    async function checkForSavedSession() {
        return new Promise((resolve) => {
            if (localStorage.getItem(SESSION_KEY)) {
                Swal.fire({
                    title: 'Trabajo Pendiente',
                    text: 'Detectamos un trabajo de gestión que no fue enviado. ¿Deseas recuperarlo?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, recuperar',
                    cancelButtonText: 'No, empezar de cero',
                    allowOutsideClick: false
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        await loadSession();
                        Swal.fire('¡Listo!', 'Tu sesión ha sido restaurada.', 'success');
                    } else if (result.isDismissed) { 
                        Swal.fire({
                            title: '¿Estás 100% seguro?',
                            html: "Esta acción es irreversible y todo su progreso se perderá.",
                            icon: 'error',
                            showCancelButton: true,
                            confirmButtonText: 'Sí, borrar todo',
                            cancelButtonText: 'Cancelar',
                            confirmButtonColor: '#e74c3c'
                        }).then(async (deleteResult) => {
                            if (deleteResult.isConfirmed) {
                                await clearSession();
                                Swal.fire('Eliminado', 'Se ha borrado el progreso anterior.', 'success');
                            } else {
                                await loadSession();
                                Swal.fire('¡Restaurado!', 'Tu sesión ha sido restaurada.', 'success');
                            }
                            resolve();
                        });
                        return;
                    }
                    resolve();
                });
            } else {
                resolve();
            }
        });
    }

    // === FIN: LÓGICA DE SESIÓN ===


    // ===== CÓDIGO MEJORADO PARA LA FIRMA =====
    let isDrawing = false;
    let isErasing = false;
    let lastX = 0;
    let lastY = 0;
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    const undoStack = [];
    const redoStack = [];

    // Configuración inicial del canvas
    function initializeCanvas() {
        canvas.width = 400;
        canvas.height = 200;
        ctx.strokeStyle = "#000000";
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // Función mejorada para obtener coordenadas
    function getCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        if (e.touches && e.touches.length > 0) {
            return {
                x: (e.touches[0].clientX - rect.left) * scaleX,
                y: (e.touches[0].clientY - rect.top) * scaleY
            };
        } else if (e.offsetX !== undefined) {
            return {
                x: e.offsetX * scaleX,
                y: e.offsetY * scaleY
            };
        } else if (e.clientX !== undefined) {
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }
        
        return { x: 0, y: 0 };
    }

    // Función para empezar a dibujar
    function startDrawing(e) {
        e.preventDefault();
        saveToUndoStack(); // Guardamos el estado ANTES de dibujar
        isDrawing = true;
        const { x, y } = getCoordinates(e);
        lastX = x;
        lastY = y;
        
        ctx.beginPath();
        ctx.arc(x, y, ctx.lineWidth/2, 0, Math.PI * 2);
        ctx.fillStyle = isErasing ? "#FFFFFF" : "#000000";
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    // Función para dibujar
    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        
        const { x, y } = getCoordinates(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = isErasing ? "#FFFFFF" : "#000000";
        ctx.lineWidth = isErasing ? 20 : 4;
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    }

    // Función para terminar de dibujar
    function stopDrawing() {
        if (isDrawing) {
            isDrawing = false;
            // Guardamos la sesión después de una pausa para no sobrecargar el storage
            setTimeout(saveSession, 500); 
            setTimeout(verificarFormulario, 50); // Verificar después de una pausa
        }
    }

    // Stack functions
    function saveToUndoStack() {
        undoStack.push(canvas.toDataURL());
        redoStack.length = 0;
        updateButtonStates();
    }

    function undo() {
        if (undoStack.length > 0) {
            redoStack.push(canvas.toDataURL());
            const lastState = undoStack.pop();
            const img = new Image();
            img.src = lastState;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                verificarFormulario();
                saveSession();
            };
            updateButtonStates();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            undoStack.push(canvas.toDataURL());
            const lastState = redoStack.pop();
            const img = new Image();
            img.src = lastState;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                verificarFormulario();
                saveSession();
            };
            updateButtonStates();
        }
    }

    function updateButtonStates() {
        document.getElementById("undo").style.display = undoStack.length > 0 ? "block" : "none";
        document.getElementById("redo").style.display = redoStack.length > 0 ? "block" : "none";
    }

    // Limpiar firma - MEJORADA
    function clearSignature() {
        saveToUndoStack();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        setTimeout(() => {
            verificarFormulario();
            saveSession();
        }, 100);
        
        updateButtonStates();
    }

    // CONFIGURACIÓN DE EVENTOS MEJORADA
    function setupSignatureEvents() {
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseout", stopDrawing);
        
        canvas.addEventListener("touchstart", function(e) {
            startDrawing(e);
            e.preventDefault();
        }, { passive: false });
        
        canvas.addEventListener("touchmove", function(e) {
            draw(e);
            e.preventDefault();
        }, { passive: false });
        
        canvas.addEventListener("touchend", stopDrawing);
        canvas.addEventListener("touchcancel", stopDrawing);
        
        document.getElementById("toggleEraser").addEventListener("click", function() {
            isErasing = !isErasing;
            this.classList.toggle("active");
            this.innerHTML = isErasing ? 
                '<i class="fas fa-pen"></i>' : 
                '<i class="fas fa-eraser"></i>';
        });
        
        document.getElementById("undo").addEventListener("click", undo);
        document.getElementById("redo").addEventListener("click", redo);
        document.getElementById("clearSignature").addEventListener("click", clearSignature);
        
        canvas.addEventListener("contextmenu", function(e) { e.preventDefault(); });
        
        canvas.style.touchAction = "none";
        canvas.style.msTouchAction = "none";
    }

    // VERIFICAR SI EL CANVAS ESTÁ VACÍO
    function isCanvasBlank(canvas) {
        try {
            const context = canvas.getContext('2d');
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const pixelBuffer = new Uint32Array(imageData.data.buffer);
            
            let nonWhitePixels = 0;
            for (let i = 0; i < pixelBuffer.length; i++) {
                if (pixelBuffer[i] !== 0xFFFFFFFF && pixelBuffer[i] !== 0x00000000) {
                    nonWhitePixels++;
                }
            }
            const hasContent = nonWhitePixels > 100;
            return !hasContent;
            
        } catch (error) {
            console.error('Error al verificar canvas:', error);
            return true;
        }
    }


    // === INICIO: DOMContentLoaded y Inicialización ===
    
    document.addEventListener('DOMContentLoaded', async function() {
        
        // 1. Inicializar DB y Canvas
        await initDB();
        initializeCanvas();
        setupSignatureEvents();
        
        // 2. Establecer fecha actual (Siempre se ejecuta antes de loadSession)
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var dd = String(today.getDate()).padStart(2, '0');
        
        // Establecer la fecha actual de inmediato (si está vacía), 
        // para que 'loadSession' pueda usarla como fallback.
        if (document.getElementById("fecha").value === '') {
            document.getElementById("fecha").value = yyyy + '-' + mm + '-' + dd;
        }


        // 3. Cargar datos remotos
        await cargarTodosLosDatos();
        
        // 4. Revisar sesión guardada
        await checkForSavedSession();

        // 5. Configurar Eventos de Formulario (Autoguardado)
        configurarEventos();

        // 6. Configurar eventos de autocompletado
        initAutocomplete();
        
        // 7. Mostrar botón de actas pendientes
        mostrarBotonesActasPendientes();
        
        // Mostrar botones de herramientas de firma
        document.getElementById("toggleEraser").style.display = "block";
        document.getElementById("undo").style.display = "none";
        document.getElementById("redo").style.display = "none";

        // 8. Ocultar el botón de limpieza si no hay sesión
        if (!localStorage.getItem(SESSION_KEY)) {
             document.getElementById('clear-session-button').style.display = 'none';
        }
    });

    // === FIN: DOMContentLoaded y Inicialización ===

    // ===== RESTO DEL CÓDIGO DE LA APLICACIÓN (ADAPTADO) =====
    
    // Función de autoguardado para los campos principales
    // Se usa 'input' para campos de texto y 'change' para select/date
    function configurarEventos() {
        $('#buscador').on('input', filtrarEquipos);
        $("#fecha, #colaborador, #area").on("change input", function() {
             verificarFormulario(); 
             saveSession();
        });
        $("#checklistObservaciones").on("input", function() {
             guardarEstadoChecklist(); 
             saveSession();
        });
        
        // Eventos para modo
        $('#btnSalidas').on('click', function() { cambiarModo('salidas'); saveSession(); });
        $('#btnEntradas').on('click', function() { cambiarModo('entradas'); saveSession(); });
    }

    function cambiarModo(modo) {
        checklistEstado = {};
        ocultarChecklist(); 
        modoActual = modo;
        equipoSeleccionado = null;
        $('.equipo').css('border-color', '#ddd').css('background-color', '#f9f9f9');
        
        $('#buscador').val('');
        
        if (modo === 'salidas') {
            $('#btnSalidas').removeClass('inactivo').addClass('activo');
            $('#btnEntradas').removeClass('activo').addClass('inactivo');
            $('#titulo-equipos').text('Seleccione el equipo a prestar:');
            
            $('#fecha').prop('disabled', false);
            $('#colaborador').prop('disabled', false).val('');
            $('#area').prop('disabled', false).val('');
            $('#buscador').prop('disabled', false);
            
        } else {
            $('#btnSalidas').removeClass('activo').addClass('inactivo');
            $('#btnEntradas').removeClass('inactivo').addClass('activo');
            $('#titulo-equipos').text('Seleccione el equipo a devolver:');
            
            $('#fecha').prop('disabled', true);
            $('#colaborador').prop('disabled', true).val('');
            $('#area').prop('disabled', true).val('Bodega');
            $('#buscador').prop('disabled', false);
        }

        mostrarEquiposEnUI();
        verificarFormulario();
        // El autoguardado se maneja en el listener de los botones.
    }

    async function cargarTodosLosDatos() {
        $('#overlay').show();
        $('#loadingMessage p').text('Cargando la lista de equipos y colaboradores desde el servidor...');

        const scriptURL = "https://script.google.com/macros/s/AKfycbxbiQDZcTJA2I9XknV-VF-3E9NdK_b8xq-8fc4LkZ4jh5n4jkJQz0_UlB_zbKpHSJGl/exec";

        try {
            const data = await $.get(scriptURL);
            $('#overlay').hide();
            
            if (data.error) {
                Swal.fire('Error', 'No se pudieron cargar los datos: ' + data.mensaje, 'error');
                return;
            }
            
            equipos = data.equipos;
            colaboradores = data.colaboradores;
            data.areas.forEach(area => {
                if (!areas.includes(area)) {
                    areas.push(area);
                }
            });

            mostrarEquiposEnUI();
            llenarSelects();
            
        } catch (error) {
            $('#overlay').hide();
            Swal.fire('Error', 'No se pudo conectar al servidor o hubo un error de red.', 'error');
            console.error("Error en la solicitud AJAX:", error);
        }
    }

    function llenarSelects() {
        allColaboradores = colaboradores;
        
        const areaSelect = $('#area');
        areaSelect.find('option:not(:first)').remove();
        areas.forEach(area => {
            areaSelect.append(`<option value="${area}">${area}</option>`);
        });
    }

    function mostrarEquiposEnUI() {
        const equiposContainer = $('#equipos');
        equiposContainer.empty();

        equipos.forEach((equipo, index) => {
            if (equipo.nombre.startsWith("-")) {
                let categoryName = equipo.nombre.substring(1).trim();
                equiposContainer.append(`
                    <div class="category-separator">
                        <strong>${categoryName}</strong> <span class="toggle-icon">&#9660;</span>
                    </div>
                `);
                return;
            }

            if (modoActual === "salidas" && !equipo.disponible) {
                return;
            }

            if (modoActual === "entradas" && equipo.disponible) {
                return;
            }

            let estadoClass = equipo.disponible ? 'disponible' : 'no-disponible';
            let estadoText = equipo.disponible ? 'Disponible' : `Ocupada por: ${equipo.asignadoA}`;
            
            // Determinar si es el equipo seleccionado para marcarlo
            let isSelected = equipoSeleccionado && equipoSeleccionado.nombre === equipo.nombre;
            let borderStyle = isSelected ? 'border-color: #007BFF; background-color: #e6f0ff;' : '';

            let equipoHtml = `
                <div class="equipo" id="equipo-${index}" data-index="${index}" onclick="seleccionarEquipo(${index})" style="${borderStyle}">
                    <img src="${equipo.imagen || ''}" alt="${equipo.nombre}" onerror="this.style.display='none'">
                    <label>${equipo.nombre}</label>
                    <span class="${estadoClass}">${estadoText}</span>
                </div>
            `;

            equiposContainer.append(equipoHtml);

            if (!equipo.disponible && modoActual === "salidas") {
                $(`#equipo-${index}`).css('opacity', '0.6').css('cursor', 'not-allowed');
            }
        });

        $('.category-separator').off('click').on('click', function() {
            const $separator = $(this);
            const $toggleIcon = $separator.find('.toggle-icon');
            const $equiposToToggle = $separator.nextUntil('.category-separator');
            $equiposToToggle.toggle();
            $separator.toggleClass('collapsed');
            if ($separator.hasClass('collapsed')) {
                $toggleIcon.html('&#9658;');
            } else {
                $toggleIcon.html('&#9660;');
            }
        });
    }

    function filtrarEquipos() {
        const textoBusqueda = $('#buscador').val().toLowerCase();
        
        $('.equipo, .category-separator').hide();

        $('.equipo').each(function() {
            const nombreEquipo = $(this).find('label').text().toLowerCase();
            if (nombreEquipo.includes(textoBusqueda)) {
                $(this).show();
                // Mostrar el separador de categoría anterior
                $(this).prevAll('.category-separator:first').show().removeClass('collapsed').find('.toggle-icon').html('&#9660;');
            }
        });
        
        if (textoBusqueda === '') {
            mostrarEquiposEnUI(); // Restaura la vista normal si se limpia el buscador
        }
    }

    function determinarCategoria(equipoIndex) {
        let categoria = "";
        for (let i = equipoIndex; i >= 0; i--) {
            if (equipos[i].nombre.startsWith("-")) {
                categoria = equipos[i].nombre.substring(1).trim().toLowerCase();
                break;
            }
        }
        return categoria;
    }

    function seleccionarEquipo(index) {
        const equipo = equipos[index];
        if (!equipo.disponible && modoActual === "salidas") {
            return;
        }

        // 1. Resetear y guardar el equipo seleccionado
        checklistEstado = { fotos: {} }; // Inicializar checklistEstado
        ocultarChecklist();
        equipoSeleccionado = equipo;

        // 2. Resaltar en UI
        $('.equipo').css('border-color', '#ddd').css('background-color', '#f9f9f9');
        $(`#equipo-${index}`).css('border-color', '#007BFF').css('background-color', '#e6f0ff');
        
        // 3. Bloquear/Rellenar campos en modo "entradas"
        if (modoActual === "entradas") {
            $('#buscador').prop('disabled', true);
            $('#fecha').prop('disabled', true);
            $('#colaborador').prop('disabled', true);
            $('#area').prop('disabled', true).val("Bodega");
            if (equipoSeleccionado.asignadoA) {
                $('#colaborador').val(equipoSeleccionado.asignadoA);
            }
        } else {
            // Limpiar campos en modo "salidas" al cambiar de equipo
            $('#colaborador').prop('disabled', false).val('');
            $('#area').prop('disabled', false).val('');
        }

        // 4. Mostrar Checklist
        mostrarChecklist(); 
        
        // 5. Autoguardado
        saveSession();
    }

    function verificarFormulario() {
        // La función original solo verifica la firma y el colaborador (adaptado)
        let colaborador = $("#colaborador").val();
        const canvas = document.getElementById('firmaCanvas');
        const hayFirma = !isCanvasBlank(canvas);
        
        let colaboradorValido = true;
        if (modoActual === "salidas") {
            colaboradorValido = allColaboradores.includes(colaborador);
        } else {
            colaboradorValido = colaborador !== '';
        }

        if (modoActual === "salidas") {
            if (colaborador && !colaboradorValido) {
                $("#colaborador").css("border-color", "red");
            } else {
                $("#colaborador").css("border-color", colaborador ? "#28a745" : "#ddd");
            }
        }
        
        if (hayFirma) {
            canvas.style.borderColor = "#28a745";
            canvas.style.borderWidth = "2px";
        } else {
            canvas.style.borderColor = "#ddd";
            canvas.style.borderWidth = "1px";
        }
    }

    // --- FUNCIONES DE CHECKLIST INTEGRADAS (ADAPTADAS PARA DB) ---

    function ocultarChecklist() {
        $('#checklist-section').hide();
        $('#checklistContainer').empty();
        $('#checklistObservaciones').val('');
        $('#progressBar').css('width', '0%');
        $('#progressText').text('0% completado');
        // Limpiar el estado de fotos al ocultar
        checklistEstado = { fotos: {} }; 
    }

    function mostrarChecklist() {
        if (!equipoSeleccionado) {
            ocultarChecklist();
            return;
        }

        const tipo = modoActual === 'salidas' ? 'pre' : 'post';
        const categoriaSeleccionada = determinarCategoria(equipos.findIndex(e => e.nombre === equipoSeleccionado.nombre));
        
        const titulo = tipo === 'pre' ? 'Checklist Preoperativo' : 'Checklist Postoperativo';
        const subtitulo = tipo === 'pre' ? 'Verificación antes del uso' : 'Verificación después del uso';
        
        $('#checklistTitulo').text(titulo);
        $('#checklistSubtitulo').html(`${subtitulo} - Para: <strong>${equipoSeleccionado.nombre}</strong>`);
        
        const checklistData = tipo === 'pre' ? 
            (checklistsPreOperativos[categoriaSeleccionada] || checklistsPreOperativos["aspiradoras"]) :
            (checklistsPostOperativos[categoriaSeleccionada] || checklistsPostOperativos["aspiradoras"]);
        
        generarChecklistUI(checklistData);
        
        if (checklistEstado.respuestas) {
            restaurarEstadoChecklist(checklistEstado.respuestas);
        }
        
        const observacionesTextarea = document.getElementById('checklistObservaciones');
        if (observacionesTextarea && checklistEstado.observaciones !== undefined) {
            observacionesTextarea.value = checklistEstado.observaciones;
        } else if (observacionesTextarea) {
            observacionesTextarea.value = '';
        }
        
        if (observacionesTextarea) {
            observacionesTextarea.removeEventListener('input', guardarEstadoChecklist);
            observacionesTextarea.addEventListener('input', function() {
                guardarEstadoChecklist(); 
                saveSession();
            });
        }
        
        actualizarProgresoChecklist();
        $('#checklist-section').show();
    }


    function restaurarEstadoChecklist(respuestasGuardadas) {
        const items = document.querySelectorAll('.checklist-item');
        items.forEach((item, index) => {
            if (respuestasGuardadas[index]) {
                const respuesta = respuestasGuardadas[index];
                item.querySelector('.check-button').classList.remove('selected');
                item.querySelector('.x-button').classList.remove('selected');
                if (respuesta === '✔') {
                    item.querySelector('.check-button').classList.add('selected');
                } else if (respuesta === 'X') {
                    item.querySelector('.x-button').classList.add('selected');
                }
            }
        });
    }

    function generarChecklistUI(checklist) {
        const container = document.getElementById('checklistContainer');
        if (!container) { return; }
        
        container.innerHTML = '';

        if (!checklistEstado.fotos) { checklistEstado.fotos = {}; }
        
        checklist.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'checklist-item';

            if (!checklistEstado.fotos[index]) { checklistEstado.fotos[index] = []; }
            
            const numFotos = (checklistEstado.fotos[index] || []).length;

            itemDiv.innerHTML = `
                <label>${item}</label>
                <div class="checklist-buttons">
                    <button type="button" class="check-button" onclick="seleccionarRespuesta(${index}, '✔')">Cumple</button>
                    <button type="button" class="x-button" onclick="seleccionarRespuesta(${index}, 'X')">No<br>Cumple</button>
                </div>
                
                <div class="checklist-item-fotos">
                    <button type="button" class="foto-button" onclick="abrirInputFoto(${index})">
                        <i class="fas fa-camera"></i> Añadir Foto (<span id="foto-count-${index}">${numFotos}</span>)
                    </button>
                    <input type="file" id="foto-input-${index}" accept="image/*" capture="environment" style="display: none;" onchange="manejarInputFoto(event, ${index})">
                    <div class="foto-preview" id="foto-preview-${index}">
                        </div>
                </div>
            `;
            container.appendChild(itemDiv);

            // Renderizar las previews existentes (llama a renderizarPreviews)
            renderizarPreviews(index); 
        });
    }

    function seleccionarRespuesta(index, respuesta) {
        const item = document.querySelectorAll('.checklist-item')[index];
        
        item.querySelectorAll('.check-button, .x-button').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        if (respuesta === '✔') {
            item.querySelector('.check-button').classList.add('selected');
        } else {
            item.querySelector('.x-button').classList.add('selected');
        }
        
        guardarEstadoChecklist();
        actualizarProgresoChecklist();
        saveSession(); // Autoguardado al seleccionar respuesta
    }

    function guardarEstadoChecklist() {
        const respuestas = [];
        document.querySelectorAll('.checklist-item').forEach(item => {
            const selectedButton = item.querySelector('.selected');
            respuestas.push(selectedButton ? 
                (selectedButton.classList.contains('check-button') ? '✔' : 'X') : '');
        });
        
        const observacionesTextarea = document.getElementById('checklistObservaciones');
        const observaciones = observacionesTextarea ? observacionesTextarea.value : '';
        
        checklistEstado.respuestas = respuestas;
        checklistEstado.observaciones = observaciones;
    }

    function actualizarProgresoChecklist() {
        const items = document.querySelectorAll('.checklist-item');
        const totalItems = items.length;
        let itemsCompletados = 0;
        
        if (!checklistEstado.fotos) { checklistEstado.fotos = {}; }

        items.forEach((item, index) => {
            const botonSeleccionado = item.querySelector('.selected') !== null;
            const hayFotos = checklistEstado.fotos[index] && checklistEstado.fotos[index].length > 0;
            
            if (botonSeleccionado && hayFotos) {
                itemsCompletados++;
            }
        });

        const porcentaje = totalItems > 0 ? Math.round((itemsCompletados / totalItems) * 100) : 0;
        
        document.getElementById('progressBar').style.width = porcentaje + '%';
        document.getElementById('progressText').textContent = porcentaje + '% completado';
    }


    // --- NUEVAS FUNCIONES DE VALIDACIÓN Y ENVÍO ---

    function validarFormularioCompleto() {
        // 1. Validar datos principales
        let fecha = $("#fecha").val();
        let colaborador = $("#colaborador").val();
        let area = $("#area").val();
        
        let colaboradorValido = true;
        if (modoActual === "salidas") {
            colaboradorValido = allColaboradores.includes(colaborador);
        } else {
            colaboradorValido = colaborador !== '';
        }

        if (!fecha || !colaborador || !area || !colaboradorValido) {
            Swal.fire('Datos Incompletos', 'Por favor completa los campos de Fecha, Colaborador (válido) y Destino.', 'warning');
            return;
        }

        if (!equipoSeleccionado) {
            Swal.fire('Equipo no seleccionado', 'Por favor selecciona un equipo.', 'warning');
            return;
        }
        
        // 2. Validar Checklist
        const items = document.querySelectorAll('.checklist-item');
        const totalItems = items.length;
        let itemsCompletados = 0;
        
        if (!checklistEstado.fotos) checklistEstado.fotos = {};

        items.forEach((item, index) => {
            const botonSeleccionado = item.querySelector('.selected') !== null;
            const hayFotos = checklistEstado.fotos[index] && checklistEstado.fotos[index].length > 0;
            if (botonSeleccionado && hayFotos) {
                itemsCompletados++;
            }
        });

        if (itemsCompletados !== totalItems) {
            Swal.fire('Checklist Incompleto', 'Debes completar todos los puntos del checklist, incluyendo al menos una foto por cada item.', 'warning');
            return;
        }

        // 3. Validar Firma
        const canvasFirma = document.getElementById('firmaCanvas');
        if (isCanvasBlank(canvasFirma)) {
            Swal.fire('Firma Faltante', 'La firma del responsable es obligatoria.', 'warning');
            return;
        }

        // 4. Si todo está OK, construir objeto y mostrar confirmación
        const categoriaSeleccionada = determinarCategoria(equipos.findIndex(e => e.nombre === equipoSeleccionado.nombre));
        
        ultimaTransaccion = {
            fecha: fecha,
            colaborador: colaborador,
            area: area,
            equipo: equipoSeleccionado.nombre,
            categoria: categoriaSeleccionada,
            tipo: modoActual
        };
        
        mostrarConfirmacionFinal();
    }


    function mostrarConfirmacionFinal() {
        const tipoMovimiento = ultimaTransaccion.tipo === 'salidas' ? 'préstamo' : 'devolución';
        const textoAccion = ultimaTransaccion.tipo === 'salidas' ? 'solicitar' : 'devolver';
        
        const observaciones = document.getElementById('checklistObservaciones').value;
        
        Swal.fire({
            title: `Confirmar ${tipoMovimiento}`,
            html: `
                <div style="text-align: left;">
                    <p><strong>Fecha:</strong> ${ultimaTransaccion.fecha}</p>
                    <p><strong>Colaborador:</strong> ${ultimaTransaccion.colaborador}</p>
                    <p><strong>Área:</strong> ${ultimaTransaccion.area}</p>
                    <p><strong>Equipo:</strong> ${ultimaTransaccion.equipo}</p>
                    ${observaciones ? `<p><strong>Observaciones:</strong> ${observaciones}</p>` : ''}
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: `Sí, ${textoAccion}`,
            cancelButtonText: 'No, revisar',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            width: '500px'
        }).then((result) => {
            if (result.isConfirmed) {
                procesarYEnviarDatos();
            } else {
                console.log('Usuario decidió revisar.');
            }
        });
    }

    async function procesarYEnviarDatos() {
        // 1. Recolectar datos finales del checklist
        const checklistRespuestas = [];
        document.querySelectorAll('.checklist-item').forEach(item => {
            const selectedButton = item.querySelector('.selected');
            checklistRespuestas.push(selectedButton ? 
                (selectedButton.classList.contains('check-button') ? '✔' : 'X') : '');
        });
        
        const observaciones = document.getElementById('checklistObservaciones').value;
        
        const checklistDataConfig = ultimaTransaccion.tipo === 'salidas' ? 
            (checklistsPreOperativos[ultimaTransaccion.categoria] || checklistsPreOperativos["aspiradoras"]) :
            (checklistsPostOperativos[ultimaTransaccion.categoria] || checklistsPostOperativos["aspiradoras"]);

        ultimaTransaccion.checklist = checklistRespuestas.map((respuesta, index) => {
            return {
                item: checklistDataConfig[index],
                respuesta: respuesta
            };
        });
        
        ultimaTransaccion.observaciones = observaciones;
        
        // 2. Preparar fotos: convertir IDs a DataURLs (Solo las necesarias para el PDF)
        $('#loadingMessage p').text('Preparando fotos para el reporte...');
        
        const fotosFinales = {};
        const fotosPromesas = Object.keys(checklistEstado.fotos).map(async (index) => {
            const ids = checklistEstado.fotos[index] || [];
            if (ids.length > 0) {
                fotosFinales[index] = [];
                for (const id of ids) {
                    const dataUrl = await getImageFromDB(id); 
                    if (dataUrl) {
                        fotosFinales[index].push(dataUrl);
                    }
                }
            }
        });
        await Promise.all(fotosPromesas);
        ultimaTransaccion.fotosChecklist = fotosFinales;


        // 3. Mostrar Overlay
        $('#overlay').show();
        $('#loadingMessage p').text('Registrando movimiento en el servidor...');
        
        // 4. Enviar AJAX a Google Apps Script
        const scriptURL = ultimaTransaccion.tipo === 'salidas' ? 
            "https://script.google.com/macros/s/AKfycbweOAqrT8cQuoW9xPbWBwOyLxbORFTT6HaStsNUz7i9ySkTRlElJIirZwcoGC-l8Sb-/exec" :
            "https://script.google.com/macros/s/AKfycbw4OfK5DQQqbiro8olfyb8MvjQnOHGZBoELkTBJnOYS2GMpkr8yFrJJASiAiAxxePGfzA/exec";
        
        const data = {
            fecha: ultimaTransaccion.fecha,
            colaborador: ultimaTransaccion.colaborador,
            area: ultimaTransaccion.area,
            equipo: ultimaTransaccion.equipo,
            categoria: ultimaTransaccion.categoria,
            checklist: JSON.stringify(checklistRespuestas), // Solo las respuestas (✔/X/NA) para la hoja de cálculo
            observaciones: ultimaTransaccion.observaciones
        };
        
        if (ultimaTransaccion.tipo === 'salidas') {
            const equipoData = equipos.find(e => e.nombre === ultimaTransaccion.equipo);
            data.retornable = equipoData ? equipoData.devolucion : 'Sí';
        } else {
            data.tipo = 'devolucion';
        }
        
        $.ajax({
            url: scriptURL,
            type: "POST",
            data: data,
            success: function(response) {
                // No ocultar overlay todavía
                $('#loadingMessage p').text('Generando documento PDF...');
                
                // --- MANTENEMOS EL PROGRESO EN PANTALLA ---
                generarPDF().then(() => {
                    // La sesión y el progreso se mantienen en el formulario.
                    $('#overlay').hide();
                }).catch(pdfError => {
                    console.error("Error al generar o guardar PDF:", pdfError);
                    Swal.fire('Advertencia', 'Transacción registrada, pero hubo un error al generar el PDF. Puedes intentarlo de nuevo desde Actas Pendientes.', 'warning');
                    $('#overlay').hide();
                });
                // -------------------------------------------------------------------
            },
            error: function(xhr, status, error) {
                $('#overlay').hide();
                Swal.fire('Error', `Hubo un problema al registrar la transacción. Por favor inténtalo nuevamente. Error: ${error}`, 'error');
            }
        });
    }

    // Funciones auxiliares (scroll)
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function scrollToBottom() {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    // Funciones para el manejo de imágenes y PDF
    
    // Función para convertir archivo a base64 (adaptada de Reporte de Supervisión)
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

    // Función de compresión (SIN CAMBIOS)
    async function compressImage(file, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 600;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(dataUrl);
                };
                img.src = event.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    /* --- NUEVAS FUNCIONES PARA FOTOS DEL CHECKLIST (ADAPTADAS PARA DB) --- */

    function abrirInputFoto(index) {
        document.getElementById(`foto-input-${index}`).click();
    }

    async function manejarInputFoto(event, index) {
        if (!isDbInitialized) {
            Swal.fire('Error', 'Base de datos de fotos no inicializada.', 'error');
            return;
        }

        const files = event.target.files;
        if (!files || files.length === 0) return;

        const file = files[0];
        
        // 1. Mostrar Spinner
        const previewContainer = document.getElementById(`foto-preview-${index}`);
        const tempSpinner = $(`<div class="image-preview-item text-center p-2" style="width: 60px; height: 60px;"><div class="spinner" style="width: 20px; height: 20px; border: 2px solid rgba(52, 152, 219, 0.2); border-top-color: var(--secondary-color);"></div></div>`);
        previewContainer.appendChild(tempSpinner[0]);

        try {
            // 2. Comprimir y obtener DataURL
            const base64Data = await compressImage(file, 0.5); 
            
            // 3. Guardar en IndexedDB y obtener ID
            const newId = await saveImageToDB(base64Data);

            // 4. Actualizar estado y UI
            if (!checklistEstado.fotos) { checklistEstado.fotos = {}; }
            if (!checklistEstado.fotos[index]) { checklistEstado.fotos[index] = []; }

            checklistEstado.fotos[index].push(newId); // Guardamos el ID
            
            // Re-renderizar las previews (usando el ID recién guardado)
            await renderizarPreviews(index); 
            
            // Eliminar spinner y autoguardar
            tempSpinner.remove();
            actualizarProgresoChecklist();
            saveSession(); 
            
            event.target.value = ""; 

        } catch (error) {
            console.error("Error al procesar/guardar la imagen:", error);
            tempSpinner.remove();
            Swal.fire('Error', 'No se pudo procesar o guardar la imagen.', 'error');
        }
    }

    /**
     * Dibuja las vistas previas de las fotos para un ítem específico usando IDs de la DB.
     */
    async function renderizarPreviews(index) {
        const previewContainer = document.getElementById(`foto-preview-${index}`);
        if (!previewContainer) return; 

        previewContainer.innerHTML = '';
        const idArray = checklistEstado.fotos[index] || [];
        
        const fragment = document.createDocumentFragment();
        
        for (const id of idArray) {
            const base64String = await getImageFromDB(id);
            if (base64String) {
                const div = document.createElement("div");
                div.classList.add("image-preview-item");
                // La función deleteImageChecklist debe usar el ID de la DB
                div.innerHTML = `
                    <img src="${base64String}" alt="Preview ${id}">
                    <div class="delete-icon" onclick="deleteImageChecklist(this, ${index}, ${id})">×</div>
                `;
                fragment.appendChild(div);
            } else {
                 console.warn(`Image ID ${id} no encontrado en DB.`);
                 // Si no se encuentra, la eliminamos del estado
                 checklistEstado.fotos[index] = checklistEstado.fotos[index].filter(dbId => dbId !== id);
                 saveSession();
            }
        }

        previewContainer.appendChild(fragment);
        
        const countSpan = document.getElementById(`foto-count-${index}`);
        if (countSpan) {
            countSpan.textContent = idArray.length;
        }
        
        // Es importante llamar a esta función para que se actualice el progreso después de renderizar.
        actualizarProgresoChecklist(); 
    }

    /**
     * Elimina una foto del estado y de IndexedDB.
     */
    async function deleteImageChecklist(buttonElement, index, id) {
        if (!isDbInitialized) { Swal.fire('Error', 'La base de datos no está lista.', 'error'); return; }
        
        const item = buttonElement.closest('.image-preview-item');
        if (item) {
            item.remove();
        }

        try {
            await deleteImageFromDB(id);
            
            if (checklistEstado.fotos[index]) {
                // Eliminar el ID del estado
                checklistEstado.fotos[index] = checklistEstado.fotos[index].filter(dbId => dbId !== id);
                
                // Actualizar contador y re-renderizar para reflejar el cambio
                const countSpan = document.getElementById(`foto-count-${index}`);
                if (countSpan) {
                    countSpan.textContent = checklistEstado.fotos[index].length;
                }
                
                actualizarProgresoChecklist();
                saveSession();
            }
        } catch (error) {
            console.error("Error eliminando imagen de DB:", error);
            Swal.fire('Error', 'No se pudo eliminar la imagen.', 'error');
        }
    }

    /**
     * Función para añadir las fotos del checklist al PDF.
     */
    async function addChecklistPhotosToPDF(doc, startY) {
        let currentY = startY;
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        const pageWidth = doc.internal.pageSize.getWidth();

        const fotosChecklist = ultimaTransaccion.fotosChecklist || {};
        const todasLasFotos = Object.values(fotosChecklist).flat();

        if (todasLasFotos.length === 0) {
            return startY;
        }

        if (currentY + 20 > pageHeight - margin) {
            doc.addPage();
            currentY = 15;
        }
        doc.setFontSize(14);
        doc.setFont("times", "bold");
        doc.text("Evidencia Fotográfica", pageWidth / 2, currentY, { align: 'center' });
        currentY += 10;

        const imgWidth = 60;
        const imgHeight = 40;
        const spacingX = 65;
        const spacingY = 45;
        let currentX = margin;
        let imagesInRow = 0;

        for (const dataUrl of todasLasFotos) {
            if (imagesInRow === 3) {
                imagesInRow = 0;
                currentX = margin;
                currentY += spacingY;
            }
            if (currentY + imgHeight > pageHeight - margin) {
                doc.addPage();
                currentY = 15;
                currentX = margin;
                imagesInRow = 0;
            }
            
            try {
                // Ya son DataURLs comprimidos de la DB
                doc.addImage(dataUrl, 'JPEG', currentX, currentY, imgWidth, imgHeight); 
            } catch(e) {
                doc.text("Error al cargar foto", currentX, currentY + (imgHeight/2));
            }
            
            currentX += spacingX;
            imagesInRow++;
        }
        currentY += spacingY; 

        return currentY;
    }

    /* --- FIN NUEVAS FUNCIONES FOTOS --- */


    async function generarPDF() {
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            format: 'letter',
            unit: 'mm'
        });
        
        doc.setFont("times", "normal");
        const tipoMovimiento = ultimaTransaccion.tipo === 'salidas' ? 'Acta de Compromiso' : 'Acta de Recepción';
        const tituloChecklist = ultimaTransaccion.tipo === 'salidas' ? 'Checklist Preoperativo' : 'Checklist Postoperativo';
        const now = new Date();
        const [yyyy, mm, dd] = ultimaTransaccion.fecha.split('-');
        const meses = [
            "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
        ];
        const mesTexto = meses[parseInt(mm) - 1];
        let y = 15;
        const margin = 15;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const textWidth = pageWidth - (2 * margin);
        
        // Encabezado
        doc.setFontSize(16);
        doc.setTextColor(34, 49, 63);
        doc.setFont("times", "bold");
        doc.text(tipoMovimiento, pageWidth / 2, y, { align: 'center' });
        y += 8;
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, y, pageWidth - margin, y);
        y += 10;
        doc.setFontSize(12);
        doc.setTextColor(50, 50, 50);
        doc.setFont("times", "normal");

        // Contenido del acta
        if (ultimaTransaccion.tipo === 'salidas') {
            const textoCompleto = `Yo ${ultimaTransaccion.colaborador} mediante la presente Acta de Compromiso hago constar que en esta fecha estoy recibiendo el equipo ${ultimaTransaccion.equipo}, el cual será utilizado para el desempeño de mis funciones.`;
            const lineas = doc.splitTextToSize(textoCompleto, textWidth);
            doc.text(lineas, margin, y);
            y += (lineas.length * 6) + 4;
            
            doc.setFont("times", "bold");
            const textoCompromiso = "Habiendo recibido me comprometo a lo siguiente:";
            doc.text(textoCompromiso, margin, y);
            y += 7;
            
            doc.setFont("times", "normal");
            const compromisos = [
                "- Cuidar y hacer buen uso del mismo, durante el tiempo que este bajo mi cargo en beneficio de las actividades del negocio.",
                "- En caso de accidente, daño por mal uso y cualquier que bajo mi uso dañe el equipo se procederá a realizar la deducción del valor completo proporcionando uno nuevo.",
                "- Me comprometo a cuidar todos y cada uno de los componentes del equipo."
            ];
            
            compromisos.forEach(compromiso => {
                const splitText = doc.splitTextToSize(compromiso, textWidth - 5);
                doc.text(splitText, margin + 5, y);
                y += (splitText.length * 5) + 3;
            });
            
            y += 5;
            const textoFinal = `Firmo la presente en la ciudad de Tegucigalpa a los ${dd} días del mes de ${mesTexto} del ${yyyy}.`;
            const lineasFinal = doc.splitTextToSize(textoFinal, textWidth);
            doc.text(lineasFinal, margin, y);
            y += (lineasFinal.length * 6) + 10;
        } else if (ultimaTransaccion.tipo === 'entradas') {
            const textoCompleto = `Yo ${ultimaTransaccion.colaborador} mediante la presente Acta de Recepción hago constar que en esta fecha estoy entregando el equipo ${ultimaTransaccion.equipo}, el cual fue utilizado para el desempeño de mis funciones y ahora estoy retornando.`;
            const lineas = doc.splitTextToSize(textoCompleto, textWidth);
            doc.text(lineas, margin, y);
            y += (lineas.length * 6) + 4;
            
            doc.setFont("times", "bold");
            const textoDeclaracion = "Al entregarla declaro lo siguiente:";
            doc.text(textoDeclaracion, margin, y);
            y += 7;
            
            doc.setFont("times", "normal");
            const declaraciones = [
                "- El equipo se encuentra en las mismas condiciones en las que me fue entregado.",
                "- Fui responsable y cuidadoso en el uso del equipo y todos sus componentes.",
                "- Cualquier daño, accidente o mal uso fue reportado en tiempo y forma."
            ];
            
            declaraciones.forEach(declaracion => {
                const splitText = doc.splitTextToSize(declaracion, textWidth - 5);
                doc.text(splitText, margin + 5, y);
                y += (splitText.length * 5) + 3;
            });
            
            y += 5;
            const textoFinal = `Firmo la presente en la ciudad de Tegucigalpa a los ${dd} días del mes de ${mesTexto} del ${yyyy}.`;
            const lineasFinal = doc.splitTextToSize(textoFinal, textWidth);
            doc.text(lineasFinal, margin, y);
            y += (lineasFinal.length * 6) + 10;
        }

        // Firma
        const canvasFirma = document.getElementById('firmaCanvas');
        const firmaDataUrl = canvasFirma.toDataURL('image/png');
        const firmaWidth = 60;
        const firmaHeight = 25;
        const firmaX = (pageWidth - firmaWidth) / 2;
        
        // Agregar firma
        doc.addImage(firmaDataUrl, 'PNG', firmaX, y, firmaWidth, firmaHeight);
        y += firmaHeight + 2;
        doc.line(firmaX, y, firmaX + firmaWidth, y);
        y += 4;
        doc.setFontSize(12);
        doc.setTextColor(80, 80, 80);
        doc.setFont("times", "bold");
        doc.text(ultimaTransaccion.colaborador, pageWidth / 2, y, { align: 'center' });
        y += 10;
        doc.line(margin, y, pageWidth - margin, y);
        y += 8;

        // Para checklists largos (más de 8 ítems), comenzar en nueva página
        if (ultimaTransaccion.checklist.length > 8) {
            doc.addPage();
            y = 15;
        }

        // Checklist
        doc.setFontSize(14);
        doc.setTextColor(34, 49, 63);
        doc.setFont("times", "bold");
        doc.text(tituloChecklist, pageWidth / 2, y, { align: 'center' });
        y += 8;
        
        // Colores para la tabla de checklist
        const tableColumn = ["Punto de Verificación", "Cumple", "No Cumple"];
        const tableRows = ultimaTransaccion.checklist.map(item => {
            const cumple = item.respuesta === "✔" ? { content: "X", styles: { fillColor: [46, 204, 113], textColor: [255, 255, 255], fontStyle: 'bold' } } : "";
            const noCumple = item.respuesta === "X" ? { content: "X", styles: { fillColor: [231, 76, 60], textColor: [255, 255, 255], fontStyle: 'bold' } } : "";
            return [item.item, cumple, noCumple];
        });
        
        let fontSize = 9;
        let cellPadding = 2;
        let rowHeight = 5;
        
        if (ultimaTransaccion.checklist.length > 10) {
            fontSize = 8;
            cellPadding = 1.5;
            rowHeight = 4;
        }
        
        const anchoDisponible = pageWidth - (2 * margin);
        const col1Width = anchoDisponible * 0.75;
        const col2Width = (anchoDisponible - col1Width) / 2;
        const col3Width = col2Width;
        
        doc.autoTable({
            startY: y,
            head: [tableColumn],
            body: tableRows,
            theme: 'grid',
            tableWidth: anchoDisponible,
            margin: { 
                left: margin, 
                right: margin,
                top: y
            },
            headStyles: {
                fillColor: [0, 123, 255],
                textColor: [255, 255, 255],
                fontStyle: 'bold',
                fontSize: fontSize,
                font: "times",
                cellPadding: cellPadding,
                minCellHeight: rowHeight,
                halign: 'center'
            },
            styles: {
                fontSize: fontSize,
                cellPadding: cellPadding,
                textColor: [50, 50, 50],
                lineColor: [200, 200, 200],
                lineWidth: 0.1,
                font: "times",
                minCellHeight: rowHeight
            },
            columnStyles: {
                0: {
                    cellWidth: col1Width,
                    fontStyle: 'bold',
                    halign: 'left',
                    cellPadding: {left: 3, right: 3, top: cellPadding, bottom: cellPadding}
                },
                1: {
                    cellWidth: col2Width,
                    halign: 'center',
                    cellPadding: {left: 1, right: 1, top: cellPadding, bottom: cellPadding}
                },
                2: {
                    cellWidth: col3Width,
                    halign: 'center',
                    cellPadding: {left: 1, right: 1, top: cellPadding, bottom: cellPadding}
                }
            },
            pageBreak: 'auto',
            showHead: 'everyPage',
            tableLineWidth: 0.1,
            tableLineColor: [200, 200, 200]
        });

        // Añadir observaciones si existen
        let currentY = doc.autoTable.previous.finalY + 10;
        
        if (ultimaTransaccion.observaciones && ultimaTransaccion.observaciones.trim() !== '') {
            if (currentY + 30 > pageHeight) {
                doc.addPage();
                currentY = 15;
            }
            
            doc.setFontSize(12);
            doc.setTextColor(34, 49, 63);
            doc.setFont("times", "bold");
            doc.text("Observaciones:", margin, currentY);
            currentY += 5;
            
            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);
            doc.setFont("times", "normal");
            
            const observacionesLines = doc.splitTextToSize(ultimaTransaccion.observaciones, textWidth);
            doc.text(observacionesLines, margin, currentY);
            currentY += (observacionesLines.length * 4) + 10;
        }

        // --- SECCIÓN DE FOTOS MODIFICADA ---
        const fotosAgregadas = ultimaTransaccion.fotosChecklist && Object.keys(ultimaTransaccion.fotosChecklist).some(key => ultimaTransaccion.fotosChecklist[key].length > 0);
        
        if (fotosAgregadas) {
            if (currentY + 60 > pageHeight) { // Estimado
                doc.addPage();
                currentY = 15;
            }
            currentY = await addChecklistPhotosToPDF(doc, currentY);
        }
        // --- FIN SECCIÓN DE FOTOS ---

        const tipoMovimientoNombre = ultimaTransaccion.tipo === 'salidas' ? 'Salida' : 'Entrada';
        const pdfName = `${dd}-${mm}-${yyyy} - ${tipoMovimientoNombre} - ${ultimaTransaccion.equipo} - ${ultimaTransaccion.colaborador}.pdf`;
        const pdfBlob = doc.output('blob');
        const pdfFile = new File([pdfBlob], pdfName, { type: 'application/pdf' });
        
        const pdfData = {
            name: pdfName,
            tipo: ultimaTransaccion.tipo,
            equipo: ultimaTransaccion.equipo,
            colaborador: ultimaTransaccion.colaborador,
            fecha: ultimaTransaccion.fecha
        };
        
        const exito = await guardarPDFEnStorage(pdfBlob, pdfData);
        
        if (!exito) {
            Swal.fire('Advertencia', 'Transacción registrada, pero hubo un error al guardar el PDF. No podrás compartirlo más tarde.', 'warning');
        }
        
        // Mostrar SweetAlert con opciones de compartir y descargar
        Swal.fire({
            title: '¡Éxito!',
            html: `
                <div style="text-align: center;">
                    <p style="font-size: 1.1em; margin-bottom: 15px;">${ultimaTransaccion.tipo === 'salidas' ? 'Préstamo' : 'Devolución'} registrada correctamente</p>
                    <div style="color: #28a745; font-size: 2em; margin-bottom: 15px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                        <strong>Equipo:</strong> ${ultimaTransaccion.equipo}<br>
                        <strong>Colaborador:</strong> ${ultimaTransaccion.colaborador}<br>
                        <strong>Fecha:</strong> ${ultimaTransaccion.fecha}
                    </p>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">¿Qué deseas hacer con el PDF?</p>
                    <div style="display: flex; justify-content: center; gap: 10px;">
                        <button id="sharePdfBtn" class="swal2-confirm swal2-styled" style="background-color: #007bff;">
                            <i class="fas fa-share-alt"></i> Compartir
                        </button>
                        <button id="downloadPdfBtn" class="swal2-cancel swal2-styled" style="background-color: #6c757d;">
                            <i class="fas fa-download"></i> Descargar
                        </button>
                    </div>
                    <p style="font-size: 0.8em; color: #888; margin-top: 15px;">
                        <i class="fas fa-info-circle"></i> El PDF también se ha guardado localmente para acceso futuro. **El progreso se mantiene en pantalla.**
                    </p>
                </div>
            `,
            icon: 'success',
            showConfirmButton: false,
            showCloseButton: true,
            allowOutsideClick: false,
            didOpen: () => {
                document.getElementById('sharePdfBtn').addEventListener('click', async function() {
                    try {
                        if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                            await navigator.share({
                                files: [pdfFile],
                                title: pdfName,
                                text: `Comparto el documento de ${tipoMovimientoNombre} para el equipo ${ultimaTransaccion.equipo}.`
                            });
                        } else {
                            doc.save(pdfName);
                        }
                    } catch (error) {
                        console.error('Error al compartir el archivo:', error);
                        if (error.name !== 'AbortError') {
                            doc.save(pdfName);
                        }
                    }
                });
                
                document.getElementById('downloadPdfBtn').addEventListener('click', function() {
                    doc.save(pdfName);
                });
            }
        }).then((result) => {
            // Se mantiene el progreso.
        });
    }


    // Función para guardar múltiples PDFs (SIN CAMBIOS)
    async function guardarPDFEnStorage(pdfBlob, pdfData) {
        
        try {
            let pdfsExistentes = JSON.parse(localStorage.getItem('pdfsAlmacenados') || '[]');

            const nuevoPDF = {
                id: 'pdf_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                name: pdfData.name,
                tipo: pdfData.tipo,
                equipo: pdfData.equipo,
                colaborador: pdfData.colaborador,
                fecha: pdfData.fecha,
                timestamp: Date.now(),
                size: pdfBlob.size
            };

            try {
                const reader = new FileReader();
                nuevoPDF.data = await new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(pdfBlob);
                });
                nuevoPDF.error = null;
            } catch (error) {
                nuevoPDF.data = null;
                nuevoPDF.error = 'solo_metadatos';
            }

            pdfsExistentes.unshift(nuevoPDF);

            if (pdfsExistentes.length > MAX_PDFS_ALMACENADOS) {
                pdfsExistentes.splice(MAX_PDFS_ALMACENADOS);
            }

            localStorage.setItem('pdfsAlmacenados', JSON.stringify(pdfsExistentes));
            
            mostrarBotonesActasPendientes();
            return true;

        } catch (error) {
            console.error('❌ Error crítico al guardar PDF:', error);
            return false;
        }
    }

    // Funciones para Autocomplete (SIN CAMBIOS)
    function initAutocomplete() {
        const input = document.getElementById('colaborador');
        
        input.addEventListener('input', function(e) {
            const value = e.target.value.toLowerCase();
            filteredColaboradores = allColaboradores.filter(col => 
                col.toLowerCase().includes(value)
            );
            
            showSuggestions(filteredColaboradores);
            verificarFormulario();
            saveSession(); // Autoguardado en input
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlightSuggestion('down');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlightSuggestion('up');
            } else if (e.key === 'Enter') {
                e.preventDefault();
                selectHighlightedSuggestion();
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
        
        input.addEventListener('blur', function() {
            setTimeout(hideSuggestions, 200);
        });
        
        document.addEventListener('click', function(e) {
            const suggestionsContainer = document.getElementById('colaborador-suggestions');
            if (!input.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                hideSuggestions();
            }
        });
    }
    
    function showSuggestions(suggestions) {
        const suggestionsContainer = document.getElementById('colaborador-suggestions');
        suggestionsContainer.innerHTML = '';
        
        if (suggestions.length === 0) {
            hideSuggestions();
            return;
        }
        
        suggestions.forEach((suggestion, index) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-suggestion';
            div.textContent = suggestion;
            div.dataset.index = index;
            
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                selectSuggestion(suggestion);
            });
            
            div.addEventListener('mouseover', function() {
                highlightSuggestionIndex(index);
            });
            
            suggestionsContainer.appendChild(div);
        });
        
        suggestionsContainer.style.display = 'block';
        selectedColaboradorIndex = -1;
    }
    
    function hideSuggestions() {
        const suggestionsContainer = document.getElementById('colaborador-suggestions');
        suggestionsContainer.style.display = 'none';
        selectedColaboradorIndex = -1;
    }
    
    function highlightSuggestion(direction) {
        const suggestions = document.querySelectorAll('.autocomplete-suggestion');
        if (suggestions.length === 0) return;
        
        suggestions.forEach(s => s.classList.remove('highlighted'));
        
        if (direction === 'down') {
            selectedColaboradorIndex = (selectedColaboradorIndex + 1) % suggestions.length;
        } else {
            selectedColaboradorIndex = (selectedColaboradorIndex - 1 + suggestions.length) % suggestions.length;
        }
        
        suggestions[selectedColaboradorIndex].classList.add('highlighted');
        suggestions[selectedColaboradorIndex].scrollIntoView({ block: 'nearest' });
    }
    
    function highlightSuggestionIndex(index) {
        const suggestions = document.querySelectorAll('.autocomplete-suggestion');
        suggestions.forEach(s => s.classList.remove('highlighted'));
        selectedColaboradorIndex = index;
        
        if (index >= 0 && index < suggestions.length) {
            suggestions[index].classList.add('highlighted');
        }
    }
    
    function selectHighlightedSuggestion() {
        if (selectedColaboradorIndex >= 0 && filteredColaboradores[selectedColaboradorIndex]) {
            selectSuggestion(filteredColaboradores[selectedColaboradorIndex]);
        }
    }
    
    function selectSuggestion(suggestion) {
        document.getElementById('colaborador').value = suggestion;
        hideSuggestions();
        verificarFormulario();
        saveSession(); // Autoguardado al seleccionar
    }

    // Funciones de Actas Pendientes (SIN CAMBIOS)
    function mostrarBotonesActasPendientes() {
        const pdfsAlmacenados = JSON.parse(localStorage.getItem('pdfsAlmacenados') || '[]');
        const boton = document.getElementById('acta-pendiente-button');
        const badge = boton.querySelector('.badge');
        
        if (pdfsAlmacenados.length > 0) {
            boton.classList.add('pendiente');
            boton.style.display = 'flex';
            badge.textContent = pdfsAlmacenados.length;
            boton.title = `Tienes ${pdfsAlmacenados.length} acta(s) pendiente(s)`;
        } else {
            boton.classList.remove('pendiente');
            boton.style.display = 'none';
        }
    }

    function mostrarTodasLasActas() {
        const pdfsAlmacenados = JSON.parse(localStorage.getItem('pdfsAlmacenados') || '[]');
        
        if (pdfsAlmacenados.length === 0) {
            Swal.fire('Información', 'No hay actas pendientes por compartir', 'info');
            return;
        }
        
        let htmlContent = `
            <div style="text-align: center;">
                <p style="font-size: 1.2em; margin-bottom: 15px; color: #28a745;">
                    <i class="fas fa-files"></i> Actas Recientes (${pdfsAlmacenados.length})
                </p>
                <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
        `;
        
        pdfsAlmacenados.forEach((pdf, index) => {
            const fecha = new Date(pdf.timestamp).toLocaleString();
            const tipoTexto = pdf.tipo === 'salidas' ? 'Salida' : 'Entrada';
            const tienePDF = pdf.data && !pdf.error;
            const esReciente = (Date.now() - pdf.timestamp) < (24 * 60 * 60 * 1000); 
            
            htmlContent += `
                <div style="border: 2px solid ${esReciente ? '#28a745' : '#6c757d'}; border-radius: 10px; padding: 15px; margin-bottom: 12px; text-align: left; background-color: ${tienePDF ? '#f8fff8' : '#fff8f8'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <strong style="font-size: 1.1em;">${pdf.equipo}</strong>
                            <span style="background-color: ${tipoTexto === 'Salida' ? '#007bff' : '#28a745'}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; margin-left: 10px;">${tipoTexto}</span>
                        </div>
                        <span style="font-size: 0.8em; color: #6c757d;">#${index + 1}</span>
                    </div>
                    
                    <div style="font-size: 0.9em; color: #555; margin-bottom: 8px;">
                        <div><strong>Colaborador:</strong> ${pdf.colaborador}</div>
                        <div><strong>Generado:</strong> ${fecha}</div>
                    </div>
                    
                    ${!tienePDF ? 
                        '<div style="color: #dc3545; font-size: 0.8em; margin-bottom: 10px;"><i class="fas fa-exclamation-triangle"></i> Archivo PDF no disponible (demasiado grande)</div>' 
                        : ''
                    }
                    
                    <div style="display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                        <button onclick="compartirActa(${index})" class="swal2-confirm swal2-styled" style="background-color: #007bff; font-size: 12px; padding: 8px 12px; min-width: 110px;">
                            <i class="fas fa-share-alt"></i> Compartir
                        </button>
                        <button onclick="descargarActa(${index})" class="swal2-confirm swal2-styled" style="background-color: #28a745; font-size: 12px; padding: 8px 12px; min-width: 110px;">
                            <i class="fas fa-download"></i> Descargar
                        </button>

                        <button onclick="eliminarActa(${index})" class="swal2-cancel swal2-styled" style="background-color: #dc3545; font-size: 12px; padding: 8px 12px; min-width: 110px;">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            `;
        });
        
        htmlContent += `
                </div>
                <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button id="eliminarTodasBtn" class="swal2-cancel swal2-styled" style="background-color: #dc3545; font-size: 12px; padding: 10px 15px;">
                        <i class="fas fa-trash-alt"></i> Eliminar todas (${pdfsAlmacenados.length})
                    </button>
                    <button id="cerrarDialogoBtn" class="swal2-confirm swal2-styled" style="background-color: #6c757d; font-size: 12px; padding: 10px 15px;">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        `;
        
        Swal.fire({
            html: htmlContent,
            icon: 'info',
            showConfirmButton: false,
            showCloseButton: true,
            allowOutsideClick: false,
            width: '95%',
            maxWidth: '700px',
            didOpen: () => {
                document.getElementById('eliminarTodasBtn').addEventListener('click', function() {
                    Swal.fire({
                        title: '¿Eliminar todas las actas?',
                        html: `
                            <div style="text-align: center;">
                                <p style="color: #dc3545; font-size: 3em; margin: 10px 0;">⚠️</p>
                                <p>Esta acción eliminará <strong>${pdfsAlmacenados.length} actas</strong> permanentemente.</p>
                                <p>¿Estás seguro de que quieres continuar?</p>
                            </div>
                        `,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Sí, eliminar todas',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            localStorage.removeItem('pdfsAlmacenados');
                            mostrarBotonesActasPendientes();
                            Swal.fire('Eliminadas', `Se eliminaron ${pdfsAlmacenados.length} actas`, 'success').then(() => {
                                Swal.close();
                            });
                        }
                    });
                });
                
                document.getElementById('cerrarDialogoBtn').addEventListener('click', function() {
                    Swal.close();
                });
            }
        });
    }

    function descargarActa(indice) {
        const pdfsAlmacenados = JSON.parse(localStorage.getItem('pdfsAlmacenados') || '[]');
        
        if (indice >= pdfsAlmacenados.length) {
            Swal.fire('Error', 'No se encontró el acta solicitada', 'error');
            return;
        }
        
        const pdfData = pdfsAlmacenados[indice];
        
        if (!pdfData.data || pdfData.error) {
            Swal.fire('Información', 'El archivo PDF no está disponible para descargar', 'info');
            return;
        }
        
        try {
            const base64Data = pdfData.data.split(',')[1];
            const byteString = atob(base64Data);
            const mimeString = pdfData.data.split(',')[0].split(':')[1].split(';')[0];
            
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            
            const blob = new Blob([ab], { type: mimeString });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = pdfData.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(link.href), 100);
            
            Swal.fire('Éxito', 'Acta descargada correctamente', 'success');
            
        } catch (error) {
            console.error('Error al descargar acta:', error);
            Swal.fire('Error', 'No se pudo descargar el acta', 'error');
        }
    }

    async function compartirActa(indice) {
        const pdfsAlmacenados = JSON.parse(localStorage.getItem('pdfsAlmacenados') || '[]');
        
        if (indice >= pdfsAlmacenados.length) {
            Swal.fire('Error', 'No se encontró el acta solicitada', 'error');
            return;
        }
        
        const pdfData = pdfsAlmacenados[indice];
        
        if (!pdfData.data || pdfData.error) {
            Swal.fire('Información', 'El archivo PDF no está disponible para compartir', 'info');
            return;
        }
        
        try {
            const base64Data = pdfData.data.split(',')[1];
            const byteString = atob(base64Data);
            const mimeString = pdfData.data.split(',')[0].split(':')[1].split(';')[0];
            
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            
            const blob = new Blob([ab], { type: mimeString });
            const pdfFile = new File([blob], pdfData.name, { type: 'application/pdf' });
            
            if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                await navigator.share({
                    files: [pdfFile],
                    title: pdfData.name,
                    text: `Comparto el documento de ${pdfData.tipo === 'salidas' ? 'Salida' : 'Entrada'} para el equipo ${pdfData.equipo}.`
                });
                Swal.fire('Éxito', 'Acta compartida correctamente', 'success');
            } else {
                descargarActa(indice);
            }
            
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Error al compartir acta:', error);
                Swal.fire('Error', 'No se pudo compartir el acta', 'error');
            }
        }
    }

    function eliminarActa(indice) {
        const pdfsAlmacenados = JSON.parse(localStorage.getItem('pdfsAlmacenados') || '[]');
        
        if (indice >= pdfsAlmacenados.length) {
            Swal.fire('Error', 'No se encontró el acta solicitada', 'error');
            return;
        }
        
        const pdfData = pdfsAlmacenados[indice];
        
        Swal.fire({
            title: '¿Eliminar esta acta?',
            html: `
                <div style="text-align: left;">
                    <p>¿Estás seguro de que quieres eliminar esta acta?</p>
                    <p><strong>Equipo:</strong> ${pdfData.equipo}</p>
                    <p><strong>Colaborador:</strong> ${pdfData.colaborador}</p>
                    <p><strong>Fecha:</strong> ${pdfData.fecha}</p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                pdfsAlmacenados.splice(indice, 1);
                localStorage.setItem('pdfsAlmacenados', JSON.stringify(pdfsAlmacenados));
                mostrarBotonesActasPendientes();
                Swal.fire('Eliminada', 'El acta ha sido eliminada', 'success').then(() => {
                    if (Swal.isVisible()) {
                        Swal.close();
                        setTimeout(() => {
                            mostrarTodasLasActas();
                        }, 300);
                    }
                });
            }
        });
    }

</script>
</body>
</html>
