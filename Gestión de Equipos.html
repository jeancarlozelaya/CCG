<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pisos Brillantes</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --light-color: #ecf0f1;
        --dark-color: #34495e;
        --text-color: #333;
        --border-color: #ddd;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f7fa;
    color: var(--text-color);
    line-height: 1.6;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    touch-action: pan-x pan-y;
    overflow-x: hidden;
    width: 100%;
    min-height: 100vh;
}

html, body {
    touch-action: manipulation;
    overflow-x: hidden;
    width: 100%;
    min-height: 100vh;
}

    .header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        text-align: center;
        padding: 18px 0;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: var(--shadow);
        position: relative;
    }

    .form-container {
        width: 90%;
        max-width: 1200px;
        margin: 25px auto;
        padding: 25px;
        background-color: white;
        border-radius: 12px;
        box-shadow: var(--shadow);
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 25px;
        font-size: 1.8rem;
        position: relative;
        padding-bottom: 10px;
    }

    h1:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background-color: var(--secondary-color);
        border-radius: 2px;
    }

    .modo-buttons {
        display: flex;
        margin-bottom: 25px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
    }

    .modo-button {
        flex: 1;
        padding: 14px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        background-color: #f0f0f0;
        color: #555;
        border: none;
        outline: none;
        transition: var(--transition);
    }

    .modo-button.activo {
        background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
        color: white;
    }

    .modo-button:hover:not(.activo) {
        background-color: #e0e0e0;
    }

    .question-container {
        margin-bottom: 25px;
        padding: 20px;
        border-radius: 8px;
        background-color: #f8f9fa;
        border-left: 4px solid var(--secondary-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .question-container label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark-color);
    }

    .question-container input,
    .question-container select,
    .question-container textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 16px;
        transition: var(--transition);
        background-color: white;
    }

    .question-container input:focus,
    .question-container select:focus,
    .question-container textarea:focus {
        border-color: var(--secondary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .question-container select:disabled, 
    .question-container input:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .search-container {
        margin: 20px 0;
        position: relative;
    }

    #buscador {
        width: 100%;
        padding: 14px 20px;
        padding-left: 45px;
        font-size: 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: white;
        transition: var(--transition);
    }

    #buscador:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        outline: none;
    }

    .search-container:before {
        content: '\f002';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
        z-index: 2;
    }

    .category-separator {
        width: 100%;
        text-align: left;
        margin: 20px 0 10px 0;
        padding: 12px 20px;
        background: linear-gradient(to right, var(--primary-color), var(--dark-color));
        color: white;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        grid-column: 1 / -1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: var(--transition);
    }

    .category-separator:hover {
        background: linear-gradient(to right, var(--dark-color), var(--primary-color));
    }

    .category-separator .toggle-icon {
        transition: transform 0.3s ease;
    }

    .category-separator.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }

    .equipos-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .equipo {
        background-color: white;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        transition: var(--transition);
        border: 1px solid #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        height: 100%;
        cursor: pointer;
    }

    .equipo:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-color: var(--secondary-color);
    }

    .equipo img {
        width: 50px;
        height: 50px;
        object-fit: contain;
        margin-bottom: 12px;
        pointer-events: none;
    }

    .equipo label {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--dark-color);
        font-size: 15px;
    }

    .disponible {
        color: var(--success-color);
        font-weight: 600;
    }

    .no-disponible {
        color: var(--accent-color);
        font-weight: 600;
        font-size: 0.85rem;
    }

    .image-preview {
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        box-sizing: border-box;
        margin-top: 15px;
        border: 1px dashed var(--border-color);
        border-radius: 8px;
        background-color: #f8f9fa;
    }

    .image-preview.empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100px;
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .image-preview.empty.drag-over {
        background-color: rgba(52, 152, 219, 0.1) !important;
        border-color: #3498db !important;
    }

    .image-preview.empty.drag-over .fa-cloud-upload-alt {
        color: #3498db;
    }

    .image-preview.empty.drag-over strong {
        color: #3498db;
    }

    .image-preview-text {
        text-align: center;
        color: #6c757d;
        font-size: 14px;
        line-height: 1.5;
    }

    .image-preview-text strong {
        display: block;
        margin-bottom: 5px;
        font-size: 16px;
        color: #495057;
        font-weight: 600;
    }

    .image-preview-text .fa-cloud-upload-alt {
        margin-bottom: 8px;
        color: #adb5bd;
        opacity: 0.7;
        font-size: 32px;
    }

    .image-preview-item {
        position: relative;
        width: 85px;
        height: 85px;
        overflow: hidden;
        border-radius: 5px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .image-preview-item:hover {
        transform: translateY(-3px);
    }

    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .delete-icon {
        display: none !important;
    }

    .firma-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 15px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background-color: #fff;
        min-height: 200px;
    }

    .firma-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .icon-button {
        background: #f8f9fa;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 16px;
        color: #333;
        transition: var(--transition);
    }

    .icon-button.active {
        background: var(--secondary-color);
        color: #fff;
        border-color: var(--secondary-color);
    }

    .icon-button:hover {
        background: #e2e6ea;
    }

    #toggleEraser, #undo, #redo {
        display: none;
    }

    .button-container {
        display: flex;
        justify-content: center;
        margin-top: 25px;
        gap: 15px;
    }

    #btnConfirmar {
        background: linear-gradient(to right, var(--success-color), #27ae60);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 14px 30px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 300px;
    }

    #btnConfirmar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    #btnConfirmar:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
    }

    .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(52, 152, 219, 0.2);
        border-radius: 50%;
        border-top-color: var(--secondary-color);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    #loadingMessage {
        text-align: center;
        color: var(--dark-color);
    }

    #loadingMessage h4 {
        margin: 0 0 10px;
        font-size: 1.3rem;
    }

    #loadingMessage p {
        margin: 0;
        color: #7f8c8d;
    }

    .scroll-button {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: fixed;
        right: 25px;
        z-index: 1000;
    }

    .scroll-button:hover {
        background-color: var(--primary-color);
        transform: scale(1.1);
    }

    #scroll-top-button {
        top: 25px;
    }

    #scroll-bottom-button {
        bottom: 25px;
    }

    .autocomplete-container {
        position: relative;
        width: 100%;
    }

    #colaborador {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 15px;
        font-size: 16px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-sizing: border-box;
        transition: var(--transition);
    }

    #colaborador:focus {
        border-color: var(--secondary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        display: none;
    }

    .autocomplete-suggestion {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: var(--transition);
    }

    .autocomplete-suggestion:last-child {
        border-bottom: none;
    }

    .autocomplete-suggestion:hover,
    .autocomplete-suggestion.highlighted {
        background-color: #f0f8ff;
    }

    #checklist-section {
        margin-top: 25px;
        padding: 20px;
        border-top: 2px solid var(--secondary-color);
        background: #fdfdfd;
        border-radius: 8px;
    }
    
    .checklist-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--border-color);
    }

    .checklist-title {
        color: var(--primary-color);
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    .checklist-subtitle {
        color: var(--dark-color);
        font-size: 1rem;
        font-weight: normal;
    }

    .checklist-container {
        max-height: 50vh;
        overflow-y: auto;
        margin: 15px 0;
        text-align: left;
        padding-right: 12px;
    }

    .checklist-container::-webkit-scrollbar {
        width: 8px;
    }

    .checklist-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .checklist-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .checklist-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .checklist-item {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column; 
        align-items: flex-start; 
        justify-content: space-between;
        padding: 12px; 
        gap: 10px;
        background: #f9f9f9;
        border-radius: 6px;
        border: 1px solid #eee;
    }

    .checklist-item label {
        font-size: 13px;
        color: #333;
        flex-grow: 1;
        margin-right: 10px;
        line-height: 1.3;
        word-wrap: break-word;
        overflow-wrap: break-word;
        font-weight: 600; 
    }

    .checklist-buttons {
        display: flex;
        gap: 4px;
        width: 100%; 
    }

    .check-button, .x-button {
        flex: 1; 
        height: 32px;
        border-radius: 3px;
        font-weight: bold;
        cursor: pointer;
        border: 1px solid #ccc;
        transition: all 0.2s ease;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 2px;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.1;
        word-break: break-word;
        text-align: center;
    }

    .check-button {
        background-color: #f0f0f0;
        color: #333;
    }

    .check-button.selected {
        background-color: var(--success-color);
        color: white;
        border-color: var(--success-color);
    }

    .x-button {
        background-color: #f0f0f0;
        color: #333;
    }

    .x-button.selected {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    
    .checklist-item-fotos {
        width: 100%;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
    }

    .foto-button {
        background: #f0f8ff;
        border: 1px dashed var(--secondary-color);
        color: var(--secondary-color);
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: var(--transition);
        width: 100%;
    }

    .foto-button:hover {
        background: #e6f3ff;
    }

    .foto-button i {
        margin-right: 5px;
    }

    .foto-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }

    .foto-preview .image-preview-item {
        width: 60px;
        height: 60px;
    }

    .progress-container {
        margin: 15px 0;
        background-color: #f0f0f0;
        border-radius: 10px;
        height: 10px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .progress-text {
        text-align: center;
        font-size: 0.9rem;
        color: var(--dark-color);
        margin-top: 5px;
    }

    #firmaCanvas {
        width: 100% !important;
        height: 200px !important;
        background: white;
        border: 1px solid #ccc;
        touch-action: none;
        -ms-touch-action: none;
    }

    .firma-container {
        position: relative;
        overflow: hidden;
    }

    #firmaCanvas {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    @media (max-width: 768px) {
        #toggleEraser, #undo, #redo {
            display: block !important;
        }
        
        .firma-buttons {
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .icon-button {
            min-width: 44px;
            min-height: 44px;
        }
    }

    @media (max-width: 768px) {
        .form-container {
            width: 95%;
            padding: 15px;
            margin: 15px auto;
        }
        
        .equipos-container {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }
        
        .equipo {
            padding: 12px;
        }
        
        .equipo img {
            width: 40px;
            height: 40px;
        }
        
        .category-separator {
            padding: 10px 15px;
            font-size: 1rem;
        }
        
        .scroll-button {
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            right: 15px;
        }
        
        #scroll-top-button {
            top: 15px;
        }
        
        #scroll-bottom-button {
            bottom: 15px;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        .button-container {
            flex-direction: column;
            align-items: center;
        }
        
        #btnConfirmar {
            width: 100%;
        }

        .checklist-item {
            flex-direction: column;
            align-items: flex-start;
        }

        .checklist-buttons {
            width: 100%;
            justify-content: space-between;
            margin-top: 8px;
        }

        .check-button, .x-button {
            flex: 1;
            max-width: 48%;
        }
    }

    @media (max-width: 480px) {
        .equipos-container {
            grid-template-columns: 1fr 1fr;
        }
        
        .question-container {
            padding: 15px;
        }
        
        #buscador {
            padding: 12px 15px;
            padding-left: 40px;
        }
        
        .modo-button {
            padding: 12px;
            font-size: 14px;
        }

        .checklist-title {
            font-size: 1.3rem;
        }

        .checklist-subtitle {
            font-size: 0.9rem;
        }
    }

    #clear-session-button {
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: none;
        justify-content: center;
        align-items: center;
        font-size: 1.5em;
        cursor: pointer;
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: fixed;
        left: 25px;
        top: 80px;
        z-index: 1000;
    }

    #clear-session-button:hover {
        background-color: #e67e22;
        transform: scale(1.1);
    }

    #btn-sync-manager {
        position: fixed;
        top: 25px;
        right: 25px;
        width: 65px;
        height: 65px;
        background: linear-gradient(45deg, var(--secondary-color), #2980b9);
        color: white;
        border: none;
        border-radius: 50%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        z-index: 9999;
        font-size: 1.8rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: none;
        align-items: center;
        justify-content: center;
    }

    #btn-sync-manager:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    }

    #btn-sync-manager .badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: var(--accent-color);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 0.8em;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .btn-sync-pendiente {
        animation: pulse 2s infinite;
    }

    .lista-scrollable {
        max-height: 350px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background-color: #fff;
    }

    .toolbar-lista {
        background-color: #f8f9fa;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-bottom: none;
        border-top-left-radius: 0.25rem;
        border-top-right-radius: 0.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cursor-pointer { cursor: pointer; }

    #syncTabs .nav-link {
        background-color: #e9ecef;
        color: #7f8c8d;
        border: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
        margin-right: 4px;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s ease;
    }

    #syncTabs .nav-link:hover {
        background-color: #dde1e3;
        color: #2c3e50;
    }

    #syncTabs .nav-link.active {
        background-color: #ffffff !important;
        color: #2c3e50 !important;
        font-weight: bold;
        border-color: #dee2e6 #dee2e6 #fff;
        border-top: 4px solid #3498db;
        transform: translateY(1px);
    }

    #syncTabs {
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
        padding-top: 10px;
        padding-left: 10px;
        padding-right: 10px;
    }

    .photo-preview-modal .modal-dialog {
        max-width: 100%;
        height: 100vh;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .photo-preview-modal .modal-content {
        height: 100vh;
        width: 100vw;
        border-radius: 0;
        background-color: rgba(0, 0, 0, 0.95);
        border: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
    }

    .photo-preview-modal .modal-header {
        border-bottom: 1px solid #333;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        z-index: 10001;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 15px 20px;
        height: 60px;
        display: flex;
        align-items: center;
    }

    .photo-preview-modal .modal-body {
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 0, 0.95);
        overflow: hidden;
        height: 100vh;
        width: 100vw;
        touch-action: pan-x pan-y;
    }

    .photo-preview-modal .modal-footer {
        border-top: 1px solid #333;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 10001;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px;
        height: 100px;
        display: flex;
        justify-content: center;
        gap: 20px;
    }

    .photo-preview-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-bottom: 120px;
    }

    .photo-view {
        width: 100vw;
        height: calc(100vh - 240px);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
    }

    .photo-view img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.3s ease;
    }

    .photo-info {
        position: absolute;
        top: 80px;
        left: 0;
        right: 0;
        text-align: center;
        color: white;
        font-size: 16px;
        padding: 10px 20px;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10002;
    }

    .photo-navigation {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 10002;
    }

    .nav-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0.7;
    }

    .nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        opacity: 1;
        transform: scale(1.1);
    }

    .nav-btn:active {
        transform: scale(0.95);
    }

    .nav-btn.disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .nav-btn.disabled:hover {
        background-color: rgba(0, 0, 0, 0.5);
        transform: none;
    }

    .photo-counter {
        position: absolute;
        top: 80px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10002;
    }

    .photo-actions {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .photo-action-btn {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid white;
        border-radius: 25px;
        padding: 8px 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .photo-action-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .photo-action-btn.delete {
        background-color: rgba(239, 83, 80, 0.2);
        border-color: #ef5350;
    }

    .photo-action-btn.delete:hover {
        background-color: rgba(239, 83, 80, 0.4);
    }

    .photo-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 18px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .photo-loading .spinner-border {
        width: 50px;
        height: 50px;
    }

    .photo-thumbnails-container {
        position: absolute;
        bottom: 100px;
        left: 0;
        right: 0;
        height: 100px;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px 0;
        z-index: 10002;
        overflow-x: auto;
        display: flex;
        justify-content: center;
    }

    .photo-thumbnails {
        display: flex;
        gap: 10px;
        padding: 0 10px;
        height: 100%;
    }

    .photo-thumbnail {
        width: 80px;
        height: 80px;
        border-radius: 6px;
        overflow: hidden;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
        position: relative;
    }

    .photo-thumbnail:hover {
        transform: translateY(-3px);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .photo-thumbnail.active {
        border-color: var(--secondary-color);
        box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
    }

    .photo-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .photo-thumbnail-index {
        position: absolute;
        bottom: 2px;
        right: 2px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 10px;
        padding: 1px 4px;
        border-radius: 3px;
        font-weight: bold;
    }

    .photo-exit-animation {
        animation: slideOut 0.3s ease-out;
    }

    @keyframes slideOut {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.8); }
    }

    .photo-enter-animation {
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }

    .pdf-preview-modal .modal-dialog {
        max-width: 100%;
        height: 100vh;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .pdf-preview-modal .modal-content {
        height: 100vh;
        width: 100vw;
        border-radius: 0;
        background-color: rgba(0, 0, 0, 0.95);
        border: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10000;
    }

    .pdf-preview-modal .modal-header {
        border-bottom: 1px solid #333;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        z-index: 10001;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 15px 20px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .pdf-preview-modal .modal-body {
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 0, 0.95);
        overflow: hidden;
        height: 100vh;
        width: 100vw;
        touch-action: pan-x pan-y;
    }

    .pdf-preview-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 80px 0 20px 0;
    }

    #pdf-render-container {
        width: 100%;
        height: 100%;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding: 20px;
    }

    #pdf-render-container canvas {
        max-width: 100%;
        height: auto;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        border-radius: 4px;
    }



/* Estilos para el interruptor de sin revisión */
#sin-revision-container {
    background-color: #fff8e1;
    border-left: 4px solid #ffc107;
    margin-bottom: 20px;
}

.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.form-check-input:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25);
}

.form-text {
    margin-top: 8px;
    font-size: 0.9rem;
}

</style>
</head>
<body>
    <div class="header">Pisos Brillantes</div>
    
    <!-- Botón de Gestor de Envíos -->
    <button id="btn-sync-manager" class="btn-sync-manager">
        <i class="fa-solid fa-cloud-upload-alt"></i>
        <span class="badge">0</span>
    </button>
    
    <!-- Botón para limpiar sesión -->
    <button id="clear-session-button" onclick="confirmClearSession()" title="Borrar Sesión Actual">
        <i class="fa-solid fa-broom"></i>
    </button>

    <div class="form-container">
        <h1>Gestión de Equipos</h1>



        <div class="modo-buttons" id="modo-buttons">
            <button id="btnSalidas" class="modo-button activo" onclick="cambiarModo('salidas')">Salidas</button>
            <button id="btnEntradas" class="modo-button inactivo" onclick="cambiarModo('entradas')">Entradas</button>
        </div>

        <div class="question-container">
            <div>
                <label for="fecha"><strong>Fecha:</strong></label>
                <input type="date" id="fecha" name="fecha" class="auto-save">
            </div>

            <label for="colaborador"><strong>Colaborador:</strong></label>
            <div class="autocomplete-container">
                <input type="text" id="colaborador" name="colaborador" placeholder="Escribe el nombre del colaborador" autocomplete="off" class="auto-save">
                <div class="autocomplete-suggestions" id="colaborador-suggestions"></div>
            </div>

            <label for="area"><strong>Destino:</strong></label>
            <select id="area" name="area" class="auto-save">
                <option value="">Seleccionar área</option>
            </select>
        </div>

<div id="sin-revision-container" class="question-container" style="display: none;">
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="toggleSinRevision" style="transform: scale(1.5);">
        <label class="form-check-label" for="toggleSinRevision" style="font-size: 1.1rem; font-weight: bold; color: var(--primary-color);">
            <i class="fas fa-bolt me-2"></i>Entregar sin revisión
        </label>
        <div class="form-text text-muted">
            Al activar esta opción, es porque no es necesario realizar una revisión.
        </div>
    </div>
</div>

        <label><strong id="titulo-equipos">Seleccione la aspiradora a prestar:</strong></label>

        <form id="formulario">
            <div class="search-container">
                <input type="text" id="buscador" placeholder="Buscar aspiradoras...">
            </div>

            <div class="equipos-container" id="equipos"></div>
            <br>

            <div id="checklist-section" style="display: none;">
                <div class="checklist-header">
                    <h2 class="checklist-title" id="checklistTitulo">Checklist Preoperativo</h2>
                    <p class="checklist-subtitle" id="checklistSubtitulo">Para: <span id="checklistEquipoNombre"></span></p>
                </div>
    
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0% completado</div>
    
                <div id="checklistContainer" class="checklist-container"></div>
    
                <div class="question-container" style="margin-top: 20px;">
                    <label for="checklistObservaciones"><strong>Observaciones:</strong></label>
                    <textarea id="checklistObservaciones" rows="3" placeholder="Escribe aquí cualquier observación adicional..." style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; resize: vertical;" class="auto-save"></textarea>
                </div>
            </div>

            <div class="question-container">
                <label for="firma">Firma del Responsable:</label>
                <div id="firmaContainer" class="firma-container">
                    <canvas id="firmaCanvas" width="400" height="200" style="border: 1px solid #ccc;"></canvas>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                    <button type="button" id="toggleEraser" title="Borrador" class="icon-button">
                        <i class="fas fa-eraser"></i>
                    </button>
                    <button type="button" id="undo" title="Deshacer" class="icon-button">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button type="button" id="redo" title="Rehacer" class="icon-button">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button type="button" id="clearSignature" title="Limpiar" class="icon-button">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>

            <div class="button-container">
                <button type="button" id="btnConfirmar" onclick="validarFormularioCompleto()">Registrar Movimiento</button>
            </div>
        </form>
    </div>

    <!-- Overlay de carga -->
    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Por favor espera un momento...</h4>
            <p></p>
        </div>
    </div>

    <!-- Modal de Gestor de Envíos -->
    <div class="modal fade" id="modalSync" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-sync me-2"></i>Gestor de Envíos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body bg-light p-0">
                    <ul class="nav nav-tabs nav-justified" id="syncTabs" role="tablist" style="background: #fff; border-bottom: 1px solid #dee2e6;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold py-3" id="tab-pendientes" data-bs-toggle="tab" data-bs-target="#content-pendientes" type="button" role="tab">
                                <i class="fas fa-hourglass-half me-2 text-warning"></i>Pendientes
                                <span class="badge bg-danger ms-1" id="badge-tab-pendientes" style="display:none">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold py-3 text-secondary" id="tab-sincronizados" data-bs-toggle="tab" data-bs-target="#content-sincronizados" type="button" role="tab">
                                <i class="fas fa-check-circle me-2 text-success"></i>Sincronizados
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content p-3" id="syncTabsContent">
                        
                        <div class="tab-pane fade show active" id="content-pendientes" role="tabpanel">
                            <div class="alert alert-info border-0 shadow-sm py-2 mb-2">
                                <small><i class="fas fa-info-circle me-1"></i> Selecciona los registros para subir o eliminar.</small>
                            </div>

                            <div class="toolbar-lista">
                                <div class="form-check mb-0">
                                    <input class="form-check-input" type="checkbox" id="check-all-pendientes">
                                    <label class="form-check-label small fw-bold" for="check-all-pendientes">Seleccionar Todos</label>
                                </div>
                                <button class="btn btn-outline-danger btn-sm" id="btn-delete-pendientes-sel" disabled>
                                    <i class="fas fa-trash-alt me-1"></i> Eliminar Selección
                                </button>
                            </div>

                            <div class="list-group list-group-flush lista-scrollable mb-2" id="lista-pendientes">
                            </div>

                            <div class="d-grid gap-2 mt-3">
                                <button type="button" class="btn btn-primary rounded-pill" id="btn-sincronizar-seleccionados" disabled>
                                    <i class="fas fa-cloud-upload-alt me-2"></i>Sincronizar Seleccionados
                                </button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="content-sincronizados" role="tabpanel">
                            <div class="alert alert-light border shadow-sm text-muted py-2 mb-2">
                                <small><i class="fas fa-check-double me-1"></i> Historial de envíos exitosos.</small>
                            </div>

                            <div class="toolbar-lista">
                                <div class="form-check mb-0">
                                    <input class="form-check-input" type="checkbox" id="check-all-sincronizados">
                                    <label class="form-check-label small fw-bold" for="check-all-sincronizados">Seleccionar Todos</label>
                                </div>
                                <button class="btn btn-outline-danger btn-sm" id="btn-delete-sincronizados-sel" disabled>
                                    <i class="fas fa-trash-alt me-1"></i> Eliminar Selección
                                </button>
                            </div>

                            <div class="list-group list-group-flush lista-scrollable mb-2" id="lista-sincronizados">
                            </div>

                            <div class="d-grid gap-2 mt-3">
                                <button type="button" class="btn btn-outline-primary rounded-pill" id="btn-resync-seleccion" disabled>
                                    <i class="fas fa-redo me-2"></i> Volver a Sincronizar Seleccionados
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Vista Previa de Fotos -->
    <div class="modal fade photo-preview-modal" id="photoPreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-images me-2"></i>Vista Previa de Fotos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="photo-preview-container">
                        <div class="photo-counter" id="photo-counter">
                            1 de 1
                        </div>
                        
                        <div class="photo-view">
                            <div class="photo-loading" id="photo-loading">
                                <div class="spinner-border text-light" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <span>Cargando foto...</span>
                            </div>
                            <img id="preview-photo" src="" alt="Vista previa" style="display: none;">
                        </div>
                        
                        <div class="photo-navigation">
                            <button class="nav-btn" id="prev-photo">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="nav-btn" id="next-photo">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="photo-thumbnails-container">
                            <div class="photo-thumbnails" id="photo-thumbnails">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="photo-actions">
                        <button class="photo-action-btn" id="download-photo">
                            <i class="fas fa-download me-2"></i>Descargar
                        </button>
                        <button class="photo-action-btn delete" id="delete-photo">
                            <i class="fas fa-trash me-2"></i>Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Vista Previa de PDF -->
    <div class="modal fade pdf-preview-modal" id="modalPdfPreview" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-file-pdf me-2"></i>Vista Previa del Acta</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body bg-secondary d-flex justify-content-center" style="overflow-y: auto;">
                    <div id="pdf-render-container" class="d-flex flex-column align-items-center w-100 p-2">
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // =========================================================================
    // CONFIGURACIÓN CENTRALIZADA
    // =========================================================================

    const DB_NAME = 'AspiradorasGestionDB';
    const STORE_IMAGES = 'checklistImages';
    const STORE_SESSION = 'sessionData';
    const STORE_PENDING = 'pendingReports';
    const STORE_EQUIPOS = 'equiposData';
    const STORE_COLABORADORES = 'colaboradoresData';
    
    let db;
    let isDbInitialized = false;

    // =========================================================================
    // VARIABLES GLOBALES
    // =========================================================================

// =========================================================================
// VARIABLES GLOBALES - ACTUALIZADAS
// =========================================================================

let equipos = [];
let colaboradores = [];
let areas = ["Bodega"];
let equipoSeleccionado = null;
let modoActual = "salidas";
let ultimaTransaccion = null;
    
// Estados separados para cada modo
let estadoSalidas = {
    colaborador: '',
    area: '',
    sinRevision: false, // NUEVA PROPIEDAD
    checklist: { respuestas: [], observaciones: "", fotos: {} }
};

let estadoEntradas = {
    colaborador: '',
    area: 'Bodega', // Valor por defecto para entradas
    sinRevision: false, // NUEVA PROPIEDAD (aunque no se use en entradas)
    checklist: { respuestas: [], observaciones: "", fotos: {} }
};

// Estado actual según modo
function getEstadoActual() {
    return modoActual === 'salidas' ? estadoSalidas : estadoEntradas;
}

function setEstadoActual(estado) {
    if (modoActual === 'salidas') {
        estadoSalidas = estado;
    } else {
        estadoEntradas = estado;
    }
}

function getChecklistEstadoActual() {
    return getEstadoActual().checklist;
}

function setChecklistEstadoActual(checklist) {
    const estado = getEstadoActual();
    estado.checklist = checklist;
    setEstadoActual(estado);
}

let allColaboradores = [];
let selectedColaboradorIndex = -1;
let filteredColaboradores = [];

    // Variables para firma
    let isDrawing = false;
    let isErasing = false;
    let lastX = 0;
    let lastY = 0;
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    const undoStack = [];
    const redoStack = [];

    // Variables para vista previa de fotos
    let currentPhotoPreview = null;
    let selectedFiles = {};

    // Variables para seguimiento de sincronización
    window.isSyncing = false;

    // Checklists solo para aspiradoras
    const checklistsPreOperativos = {
        "aspiradoras": [
            "¿La aspiradora está limpia por fuera?",
            "¿El cable de alimentación no tiene cortes y no presenta daños?",
            "¿El Adaptador de Clavija (EUR - EUA) está presente?",
            "¿Las clavijas (pines) de los cables no presentan dobleces, rupturas o daños preexistentes?",
            "¿El seguro de presión está en buen estado, y asegura que la tapa encaje correctamente con el cuerpo de la aspiradora?",
            "¿El filtro de cartucho está presente, limpio y en buen estado?",
            "¿La bolsa de membrana está presente, en buen estado y bien colocada?",
            "¿La bolsa o saco de filtro está presente, no está llena ni dañada?",
            "¿El depósito de metal está vacío y limpio?",
            "¿La manguera de aspiración está presente y no presenta daños?",
            "¿La junta de sellado (o anillo de goma) de la manguera de aspiración está presente?",
            "¿La manguera de aspiración está libre de basura y no está atascada?",
            "¿Los dos tubos de aspiración están presentes y no presentan daños?",
            "¿Los tubos de aspiración están libres de basura y no están atascados?",
            "¿La boquilla de aspiración está limpia y en buen estado?",
            "¿Las ruedas giran bien y el estribo de empuje está en buen estado?",
            "¿La aspiradora enciende y aspira con fuerza cuando la activas?"
        ]
    };

    const checklistsPostOperativos = {
        "aspiradoras": [
            "¿La aspiradora está limpia por fuera?",
            "¿El cable de alimentación no tiene cortes, no presenta daños, y está bien guardado?",
            "¿El Adaptador de Clavija (EUR - EUA) está presente?",
            "¿Las clavijas (pines) de los cables no presentan nuevos dobleces, rupturas o daños?",
            "¿El seguro de presión no presenta daños, y asegura que la tapa encaje correctamente con el cuerpo de la aspiradora?",
            "¿El filtro de cartucho se limpió (si es necesario) y se revisó su estado?",
            "¿La bolsa de membrana está presente, y no presenta daños?",
            "¿La bolsa o saco de filtro se revisó y, si era necesario, se reemplazó?",
            "¿El depósito de metal esta vació y limpio?",
            "¿La manguera de aspiración está presente, libre de basura, sin daños y sin atascos?",
            "¿La junta de sellado (o anillo de goma) de la manguera ha sido devuelta?",
            "¿Los dos tubos de aspiración están presentes, libres de basura, sin daños y sin atascos?",
            "¿La boquilla de aspiración está limpia y en buen estado?",
            "¿Las ruedas giran bien y el estribo de empuje está en buen estado?"
        ]
    };

    // =========================================================================
    // INICIALIZACIÓN DE INDEXEDDB
    // =========================================================================

    async function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 3);
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains(STORE_IMAGES)) {
                    db.createObjectStore(STORE_IMAGES, { keyPath: 'id', autoIncrement: true });
                }
                
                if (!db.objectStoreNames.contains(STORE_SESSION)) {
                    db.createObjectStore(STORE_SESSION, { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains(STORE_PENDING)) {
                    db.createObjectStore(STORE_PENDING, { keyPath: 'id', autoIncrement: true });
                }
                
                if (!db.objectStoreNames.contains(STORE_EQUIPOS)) {
                    db.createObjectStore(STORE_EQUIPOS, { keyPath: 'id' });
                }
                
                if (!db.objectStoreNames.contains(STORE_COLABORADORES)) {
                    db.createObjectStore(STORE_COLABORADORES, { keyPath: 'id' });
                }
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                isDbInitialized = true;
                console.log('IndexedDB inicializada correctamente');
                
                loadInitialDataFromDB().then(() => {
                    actualizarContadorPendientes();
                    resolve(db);
                });
            };
            
            request.onerror = function(event) {
                console.error('Error al abrir IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }

    async function loadInitialDataFromDB() {
        try {
            const equiposData = await getDataFromStore(STORE_EQUIPOS, 'equipos');
            if (equiposData) {
                equipos = equiposData;
                console.log('Aspiradoras cargadas desde DB:', equipos.length);
            }
            
            const colaboradoresData = await getDataFromStore(STORE_COLABORADORES, 'colaboradores');
            if (colaboradoresData) {
                colaboradores = colaboradoresData;
                allColaboradores = colaboradoresData;
                console.log('Colaboradores cargados desde DB:', colaboradores.length);
            }
        } catch (error) {
            console.error('Error cargando datos iniciales:', error);
        }
    }

    async function saveDataToStore(storeName, key, data) {
        return new Promise((resolve, reject) => {
            if (!db) { reject('DB no inicializada'); return; }
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put({ id: key, data: data });
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject(event.target.error);
        });
    }

    async function getDataFromStore(storeName, key) {
        return new Promise((resolve, reject) => {
            if (!db) { reject('DB no inicializada'); return; }
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get(key);
            request.onsuccess = (event) => resolve(event.target.result ? event.target.result.data : null);
            request.onerror = (event) => reject(event.target.error);
        });
    }

    // =========================================================================
    // FUNCIONES PARA IMÁGENES (INDEXEDDB)
    // =========================================================================

    async function saveImageToDB(base64Data) {
        return new Promise((resolve, reject) => {
            if (!db) { reject('DB no inicializada'); return; }
            const transaction = db.transaction([STORE_IMAGES], 'readwrite');
            const store = transaction.objectStore(STORE_IMAGES);
            const request = store.add({ image: base64Data });
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });
    }

    async function getImageFromDB(id) {
        return new Promise((resolve, reject) => {
            if (!db) { reject('DB no inicializada'); return; }
            const transaction = db.transaction([STORE_IMAGES], 'readonly');
            const store = transaction.objectStore(STORE_IMAGES);
            const request = store.get(id);
            request.onsuccess = (event) => {
                const result = event.target.result;
                resolve(result ? result.image : null);
            };
            request.onerror = (event) => reject(event.target.error);
        });
    }

    async function deleteImageFromDB(id) {
        return new Promise((resolve, reject) => {
            if (!db) { reject('DB no inicializada'); return; }
            const transaction = db.transaction([STORE_IMAGES], 'readwrite');
            const store = transaction.objectStore(STORE_IMAGES);
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject(event.target.error);
        });
    }

    async function clearImageDB() {
        return new Promise((resolve, reject) => {
            if (!db) { reject('DB no inicializada'); return; }
            const transaction = db.transaction([STORE_IMAGES], 'readwrite');
            const store = transaction.objectStore(STORE_IMAGES);
            const request = store.clear();
            request.onsuccess = () => resolve();
            request.onerror = (event) => reject(event.target.error);
        });
    }

    // =========================================================================
    // FUNCIONES DE SESIÓN (INDEXEDDB) - ACTUALIZADAS
    // =========================================================================

async function saveSession() {
    if (!isDbInitialized) return;
    
    // Guardar estados actuales ANTES de guardar
    const estadoActual = getEstadoActual();
    estadoActual.colaborador = $('#colaborador').val();
    estadoActual.area = $('#area').val();
    estadoActual.sinRevision = $('#toggleSinRevision').is(':checked'); // GUARDAR ESTADO
    
    const sessionData = {
        modoActual: modoActual,
        equipoSeleccionadoNombre: equipoSeleccionado ? equipoSeleccionado.nombre : null,
        
        // GUARDAR ESTADOS COMPLETOS SEPARADOS
        estadoSalidas: estadoSalidas,
        estadoEntradas: estadoEntradas,
        
        firmaData: isCanvasBlank(canvas) ? null : canvas.toDataURL(),
        
        undoStackLength: undoStack.length,
        redoStackLength: redoStack.length,
        
        timestamp: Date.now()
    };
    
    try {
        await saveDataToStore(STORE_SESSION, 'currentSession', sessionData);
        console.log('Sesión guardada en IndexedDB');
        
        if (sessionData.equipoSeleccionadoNombre || estadoActual.colaborador || estadoActual.area) {
            document.getElementById('clear-session-button').style.display = 'flex';
        }
    } catch (error) {
        console.error('Error guardando sesión:', error);
    }
}

async function loadSession() {
    if (!isDbInitialized) return;
    
    try {
        const sessionData = await getDataFromStore(STORE_SESSION, 'currentSession');
        if (!sessionData) return;
        
        // 1. Cargar estados separados
        if (sessionData.estadoSalidas) {
            estadoSalidas = sessionData.estadoSalidas;
        }
        if (sessionData.estadoEntradas) {
            estadoEntradas = sessionData.estadoEntradas;
        }
        
        // 2. Cambiar modo si es diferente
        if (sessionData.modoActual && sessionData.modoActual !== modoActual) {
            cambiarModo(sessionData.modoActual);
        } else {
            modoActual = sessionData.modoActual || 'salidas';
        }
        
        // 3. Cargar datos del formulario según el modo actual
        const estadoActual = getEstadoActual();
        $('#colaborador').val(estadoActual.colaborador || '');
        $('#area').val(estadoActual.area || '');
        
        // 4. Cargar Equipo Seleccionado
        if (sessionData.equipoSeleccionadoNombre && equipos.length > 0) {
            const index = equipos.findIndex(e => e.nombre === sessionData.equipoSeleccionadoNombre);
            if (index !== -1) {
                equipoSeleccionado = equipos[index];
                
                // En modo entradas, usar colaborador del equipo si no hay uno guardado
                if (modoActual === "entradas" && equipoSeleccionado.asignadoA && !estadoActual.colaborador) {
                    $('#colaborador').val(equipoSeleccionado.asignadoA);
                    estadoActual.colaborador = equipoSeleccionado.asignadoA;
                }
                
                setTimeout(() => {
                    $(`#equipo-${index}`).css('border-color', '#007BFF').css('background-color', '#e6f0ff');
                    if (modoActual === "entradas") {
                        $('#buscador').prop('disabled', true);
                        $('#fecha').prop('disabled', true);
                        $('#colaborador').prop('disabled', true);
                        $('#area').prop('disabled', true).val("Bodega");
                    }
                }, 500);
            }
        }
        
        // 5. Cargar checklist del modo actual
        if (equipoSeleccionado) {
            selectedFiles = {};
            await restaurarChecklistCompleto(estadoActual.checklist);
        }
        
        // 6. Cargar Firma
        if (sessionData.firmaData) {
            const img = new Image();
            img.src = sessionData.firmaData;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                undoStack.length = sessionData.undoStackLength || 0;
                redoStack.length = sessionData.redoStackLength || 0;
                updateButtonStates();
                verificarFormulario();
            };
        }
        
        verificarFormulario();
        document.getElementById('clear-session-button').style.display = 'flex';
        
    } catch (error) {
        console.error("Error al cargar sesión desde IndexedDB:", error);
    }
}


async function clearSession() {
    try {
        const transaction = db.transaction([STORE_SESSION], 'readwrite');
        const store = transaction.objectStore(STORE_SESSION);
        await new Promise((resolve, reject) => {
            const request = store.delete('currentSession');
            request.onsuccess = () => resolve();
            request.onerror = (e) => reject(e);
        });
        
        // Limpiar estados separados
        estadoSalidas = {
            colaborador: '',
            area: '',
            checklist: { respuestas: [], observaciones: "", fotos: {} }
        };
        
        estadoEntradas = {
            colaborador: '',
            area: 'Bodega',
            checklist: { respuestas: [], observaciones: "", fotos: {} }
        };
        
        selectedFiles = {};
        equipoSeleccionado = null;
        
        $('#fecha').val('');
        $('#colaborador').val('');
        $('#area').val('');
        ocultarChecklist();
        
        clearSignature();
        
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById("fecha").value = yyyy + '-' + mm + '-' + dd;
        
        cambiarModo('salidas');
        
        document.getElementById('clear-session-button').style.display = 'none';
        
        console.log('Sesión limpiada correctamente');
        
    } catch (error) {
        console.error('Error limpiando sesión:', error);
    }
}


    function confirmClearSession() {
        Swal.fire({
            title: '¿Limpiar Formulario?',
            text: "Esta acción eliminará el progreso actual. ¿Deseas continuar?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, borrar todo',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#e74c3c'
        }).then(async (result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: '¿Estás 100% seguro?',
                    html: "Esta acción es irreversible y todo su progreso se perderá.",
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, borrar todo',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#e74c3c'
                }).then(async (deleteResult) => {
                    if (deleteResult.isConfirmed) {
                        await clearSession();
                        Swal.fire('Eliminado', 'Se ha borrado el progreso anterior.', 'success');
                    }
                });
            }
        });
    }

    async function checkForSavedSession() {
        try {
            const sessionData = await getDataFromStore(STORE_SESSION, 'currentSession');
            if (!sessionData) return;
            
            const hasData = sessionData.fecha || sessionData.colaborador || 
                          sessionData.equipoSeleccionadoNombre || 
                          ((sessionData.checklistEstadoSalidas && 
                            sessionData.checklistEstadoSalidas.respuestas && 
                            sessionData.checklistEstadoSalidas.respuestas.length > 0) ||
                           (sessionData.checklistEstadoEntradas && 
                            sessionData.checklistEstadoEntradas.respuestas && 
                            sessionData.checklistEstadoEntradas.respuestas.length > 0));
            
            if (!hasData) {
                await clearSession();
                return;
            }
            
            Swal.fire({
                title: 'Trabajo Pendiente',
                text: 'Detectamos un trabajo de gestión que no fue enviado. ¿Deseas recuperarlo?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, recuperar',
                cancelButtonText: 'No, empezar de cero',
                allowOutsideClick: false
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await loadSession();
                    Swal.fire('¡Listo!', 'Tu sesión ha sido restaurada.', 'success');
                } else if (result.isDismissed) { 
                    Swal.fire({
                        title: '¿Estás 100% seguro?',
                        html: "Esta acción es irreversible y todo su progreso se perderá.",
                        icon: 'error',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, borrar todo',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#e74c3c'
                    }).then(async (deleteResult) => {
                        if (deleteResult.isConfirmed) {
                            await clearSession();
                            Swal.fire('Eliminado', 'Se ha borrado el progreso anterior.', 'success');
                        } else {
                            await loadSession();
                            Swal.fire('¡Restaurado!', 'Tu sesión ha sido restaurada.', 'success');
                        }
                    });
                }
            });
            
        } catch (error) {
            console.error('Error verificando sesión guardada:', error);
        }
    }

    // =========================================================================
    // FUNCIONES PARA CHECKLIST - ACTUALIZADAS
    // =========================================================================

    function ocultarChecklist() {
        $('#checklist-section').hide();
        $('#checklistContainer').empty();
        $('#checklistObservaciones').val('');
        $('#progressBar').css('width', '0%');
        $('#progressText').text('0% completado');
    }

    async function mostrarChecklist() {
        if (!equipoSeleccionado) {
            ocultarChecklist();
            return;
        }

        const tipo = modoActual === 'salidas' ? 'pre' : 'post';
        const titulo = tipo === 'pre' ? 'Checklist Preoperativo' : 'Checklist Postoperativo';
        const subtitulo = tipo === 'pre' ? 'Verificación antes del uso' : 'Verificación después del uso';
        
        $('#checklistTitulo').text(titulo);
        $('#checklistSubtitulo').html(`${subtitulo} - Para: <strong>${equipoSeleccionado.nombre}</strong>`);
        
        const checklistData = tipo === 'pre' ? 
            checklistsPreOperativos["aspiradoras"] : 
            checklistsPostOperativos["aspiradoras"];
        
        generarChecklistUI(checklistData);
        
        const estadoActual = getChecklistEstadoActual();
        if (estadoActual.respuestas) {
            restaurarEstadoChecklist(estadoActual.respuestas);
        }
        
        const observacionesTextarea = document.getElementById('checklistObservaciones');
        if (observacionesTextarea && estadoActual.observaciones !== undefined) {
            observacionesTextarea.value = estadoActual.observaciones;
        } else if (observacionesTextarea) {
            observacionesTextarea.value = '';
        }
        
        if (observacionesTextarea) {
            observacionesTextarea.removeEventListener('input', guardarEstadoChecklist);
            observacionesTextarea.addEventListener('input', function() {
                guardarEstadoChecklist(); 
                saveSession();
            });
        }
        
        actualizarProgresoChecklist();
        $('#checklist-section').show();
    }

    function restaurarEstadoChecklist(respuestasGuardadas) {
        const items = document.querySelectorAll('.checklist-item');
        items.forEach((item, index) => {
            if (respuestasGuardadas[index]) {
                const respuesta = respuestasGuardadas[index];
                item.querySelector('.check-button').classList.remove('selected');
                item.querySelector('.x-button').classList.remove('selected');
                if (respuesta === '✔') {
                    item.querySelector('.check-button').classList.add('selected');
                } else if (respuesta === 'X') {
                    item.querySelector('.x-button').classList.add('selected');
                }
            }
        });
    }

function generarChecklistUI(checklist) {
    const container = document.getElementById('checklistContainer');
    if (!container) return;
    
    container.innerHTML = '';

    const estadoActual = getChecklistEstadoActual();
    if (!estadoActual.fotos) {
        estadoActual.fotos = {};
    }
    
    // Inicializar selectedFiles limpio
    selectedFiles = {};
    
    checklist.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'checklist-item';

        // Obtener fotos del estado actual
        const numFotos = (estadoActual.fotos[index] || []).length;
        
        // Inicializar array vacío si no existe
        if (!estadoActual.fotos[index]) {
            estadoActual.fotos[index] = [];
        }

        itemDiv.innerHTML = `
            <label>${item}</label>
            <div class="checklist-buttons">
                <button type="button" class="check-button" onclick="seleccionarRespuesta(${index}, '✔')">Cumple</button>
                <button type="button" class="x-button" onclick="seleccionarRespuesta(${index}, 'X')">No<br>Cumple</button>
            </div>
            
            <div class="checklist-item-fotos">
                <div class="foto-preview" id="foto-preview-${index}"></div>
                <button type="button" class="foto-button" onclick="abrirInputFoto(${index})">
                    <i class="fas fa-camera"></i> Añadir Foto (<span id="foto-count-${index}">${numFotos}</span>)
                </button>
                <input type="file" id="foto-input-${index}" accept="image/*" capture="environment" style="display: none;" onchange="manejarInputFoto(event, ${index})">
            </div>
        `;
        container.appendChild(itemDiv);

        setupDragAndDrop(`foto-preview-${index}`, index);
    });
    
    // Renderizar fotos DESPUÉS de crear todos los elementos
    setTimeout(() => {
        checklist.forEach((item, index) => {
            renderizarPreviews(index);
        });
    }, 100);
}


    function seleccionarRespuesta(index, respuesta) {
        const item = document.querySelectorAll('.checklist-item')[index];
        
        item.querySelectorAll('.check-button, .x-button').forEach(btn => {
            btn.classList.remove('selected');
        });
        
        if (respuesta === '✔') {
            item.querySelector('.check-button').classList.add('selected');
        } else {
            item.querySelector('.x-button').classList.add('selected');
        }
        
        guardarEstadoChecklist();
        actualizarProgresoChecklist();
        saveSession();
    }

function guardarEstadoChecklist() {
    const estadoActual = getChecklistEstadoActual();
    const sinRevision = modoActual === 'salidas' && $('#toggleSinRevision').is(':checked');
    
    if (sinRevision) {
        // En modo sin revisión, no hay respuestas del checklist
        estadoActual.respuestas = [];
    } else {
        // Modo normal
        const respuestas = [];
        document.querySelectorAll('.checklist-item').forEach(item => {
            const selectedButton = item.querySelector('.selected');
            respuestas.push(selectedButton ? 
                (selectedButton.classList.contains('check-button') ? '✔' : 'X') : '');
        });
        
        estadoActual.respuestas = respuestas;
    }
    
    const observacionesTextarea = document.getElementById('checklistObservaciones');
    const observaciones = observacionesTextarea ? observacionesTextarea.value : '';
    
    estadoActual.observaciones = observaciones;
}


    function actualizarProgresoChecklist() {
        const estadoActual = getChecklistEstadoActual();
        const items = document.querySelectorAll('.checklist-item');
        const totalItems = items.length;
        let itemsCompletados = 0;
        
        if (!estadoActual.fotos) estadoActual.fotos = {};

        items.forEach((item, index) => {
            const botonSeleccionado = item.querySelector('.selected') !== null;
            const hayFotos = estadoActual.fotos[index] && estadoActual.fotos[index].length > 0;
            
            if (botonSeleccionado && hayFotos) {
                itemsCompletados++;
            }
        });

        const porcentaje = totalItems > 0 ? Math.round((itemsCompletados / totalItems) * 100) : 0;
        
        document.getElementById('progressBar').style.width = porcentaje + '%';
        document.getElementById('progressText').textContent = porcentaje + '% completado';
    }

async function restaurarChecklistCompleto(estado) {
    if (!equipoSeleccionado) return;
    
    const sinRevision = modoActual === 'salidas' && estado.sinRevision;
    
    if (sinRevision) {
        // Si es sin revisión, solo mostrar observaciones
        $('#checklistObservaciones').val(estado.observaciones || '');
        $('#checklist-section').hide();
        return;
    }
    
    // LIMPIAR COMPLETAMENTE ANTES DE RESTAURAR
    const container = document.getElementById('checklistContainer');
    if (container) {
        container.innerHTML = '';
    }
    
    selectedFiles = {}; // Limpiar archivos seleccionados
    
    const tipo = modoActual === 'salidas' ? 'pre' : 'post';
    const checklistData = tipo === 'pre' ? 
        checklistsPreOperativos["aspiradoras"] : 
        checklistsPostOperativos["aspiradoras"];

    // Generar UI limpia
    generarChecklistUI(checklistData);
    
    // Restaurar respuestas
    if (estado.respuestas) {
        restaurarEstadoChecklist(estado.respuestas);
    }
    
    // Restaurar observaciones
    $('#checklistObservaciones').val(estado.observaciones || '');
    
    // Restaurar fotos (CORREGIDO: Evitar duplicación)
    if (estado.fotos) {
        const estadoActual = getChecklistEstadoActual();
        estadoActual.fotos = JSON.parse(JSON.stringify(estado.fotos)); // Copia profunda
        selectedFiles = JSON.parse(JSON.stringify(estado.fotos)); // Copia profunda
        
        // Renderizar fotos UNA SOLA VEZ
        for (const index in estado.fotos) {
            const fotosArray = estado.fotos[index];
            if (fotosArray && fotosArray.length > 0) {
                // Asegurar que no haya duplicados
                estadoActual.fotos[index] = [...new Set(fotosArray)];
                await renderizarPreviews(parseInt(index));
            }
        }
    }
    
    actualizarProgresoChecklist();
    $('#checklist-section').show();
}

    // =========================================================================
    // FUNCIONES PARA FOTOS (DRAG & DROP + VISTA PREVIA)
    // =========================================================================

    function setupDragAndDrop(previewId, index) {
        const previewContainer = document.getElementById(previewId);
        if (!previewContainer) return;
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            previewContainer.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            previewContainer.addEventListener(eventName, function(e) {
                if (!this.classList.contains('empty')) {
                    const parent = this.closest('.checklist-item-fotos');
                    if (parent) {
                        const uploadArea = parent.querySelector('.foto-button');
                        if (uploadArea) {
                            uploadArea.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
                            uploadArea.style.borderColor = '#3498db';
                        }
                    }
                }
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            previewContainer.addEventListener(eventName, function(e) {
                const parent = this.closest('.checklist-item-fotos');
                if (parent) {
                    const uploadArea = parent.querySelector('.foto-button');
                    if (uploadArea) {
                        uploadArea.style.backgroundColor = '';
                        uploadArea.style.borderColor = '';
                    }
                }
            }, false);
        });
        
        previewContainer.addEventListener('drop', async function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                let procesadas = 0;
                let errores = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    if (!file.type.match('image.*')) {
                        errores++;
                        continue;
                    }
                    
                    try {
                        await handleDroppedImage(file, index);
                        procesadas++;
                    } catch (error) {
                        errores++;
                        console.error("Error procesando imagen:", error);
                    }
                }
                
                await renderizarPreviews(index);
                
                if (errores === 0) {
                    showDragDropSuccessToast(procesadas);
                } else {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Procesamiento parcial',
                        html: `Agregadas: ${procesadas}<br>Errores: ${errores}`,
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 4000
                    });
                }
            }
        }, false);
    }

    function showDragDropSuccessToast(count) {
        $('.photo-capture-toast').remove();
        
        const toast = document.createElement('div');
        toast.className = 'photo-capture-toast';
        toast.style.cssText = 'position: fixed; bottom: 100px; right: 20px; background-color: rgba(46, 204, 113, 0.9); color: white; padding: 12px 20px; border-radius: 10px; font-weight: 600; font-size: 16px; z-index: 10004; display: flex; align-items: center; gap: 10px; animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 1.7s forwards; box-shadow: 0 4px 15px rgba(0,0,0,0.3);';
        toast.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>${count} ${count === 1 ? 'imagen agregada' : 'imágenes agregadas'}</span>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 2000);
    }

    function abrirInputFoto(index) {
        document.getElementById(`foto-input-${index}`).click();
    }

    async function manejarInputFoto(event, index) {
        if (!isDbInitialized) {
            Swal.fire('Error', 'Base de datos de fotos no inicializada.', 'error');
            return;
        }

        const files = event.target.files;
        if (!files || files.length === 0) return;

        const file = files[0];
        
        const previewContainer = document.getElementById(`foto-preview-${index}`);
        const tempSpinner = document.createElement('div');
        tempSpinner.className = 'image-preview-item';
        tempSpinner.style.cssText = 'width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;';
        tempSpinner.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border: 2px solid rgba(52, 152, 219, 0.2); border-top-color: var(--secondary-color);"></div>';
        
        if (previewContainer) {
            previewContainer.appendChild(tempSpinner);
        }

        try {
            if (!(file instanceof Blob)) {
                throw new TypeError('El archivo no es un Blob válido');
            }

            const base64Data = await compressImage(file, 0.5);
            const newId = await saveImageToDB(base64Data);

            const estadoActual = getChecklistEstadoActual();
            if (!estadoActual.fotos[index]) estadoActual.fotos[index] = [];
            estadoActual.fotos[index].push(newId);
            
            await renderizarPreviews(index);
            tempSpinner.remove();
            actualizarProgresoChecklist();
            saveSession();
            event.target.value = "";

        } catch (error) {
            console.error("Error al procesar/guardar la imagen:", error);
            tempSpinner.remove();
            Swal.fire('Error', 'No se pudo procesar o guardar la imagen.', 'error');
        }
    }

    async function handleDroppedImage(file, index) {
        if (!isDbInitialized) return;
        
        const estadoActual = getChecklistEstadoActual();
        if (!estadoActual.fotos[index]) estadoActual.fotos[index] = [];
        
        try {
            if (!(file instanceof Blob)) {
                throw new TypeError('El archivo arrastrado no es un Blob válido');
            }

            const base64Data = await fileToBase64(file);
            const newId = await saveImageToDB(base64Data);
            estadoActual.fotos[index].push(newId);
            
            saveSession();
            return newId;
            
        } catch (error) {
            console.error("Error procesando imagen arrastrada:", error);
            throw error;
        }
    }

    async function compressImage(file, quality = 0.7) {
        return new Promise((resolve, reject) => {
            if (!(file instanceof Blob)) {
                reject(new TypeError('El parámetro no es un Blob o File válido'));
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const maxWidth = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth) {
                        const ratio = maxWidth / width;
                        width = maxWidth;
                        height = Math.round(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    try {
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    } catch (error) {
                        resolve(event.target.result);
                    }
                };
                
                img.onerror = function() {
                    resolve(event.target.result);
                };
                
                img.src = event.target.result;
            };
            
            reader.onerror = function(error) {
                reject(error);
            };
            
            reader.readAsDataURL(file);
        });
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            if (!(file instanceof Blob)) {
                reject(new TypeError('El parámetro no es un Blob o File válido'));
                return;
            }

            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = (error) => reject(error);
            reader.readAsDataURL(file);
        });
    }

async function renderizarPreviews(index) {
    const previewContainer = document.getElementById(`foto-preview-${index}`);
    if (!previewContainer) return;
    
    const estadoActual = getChecklistEstadoActual();
    const idArray = estadoActual.fotos[index] || [];
    
    // Eliminar duplicados si los hay
    if (idArray.length > 0) {
        estadoActual.fotos[index] = [...new Set(idArray)];
    }
    
    // Limpiar contenedor COMPLETAMENTE
    while (previewContainer.firstChild) {
        previewContainer.removeChild(previewContainer.firstChild);
    }
    
    if (idArray.length === 0) {
        previewContainer.className = 'foto-preview empty';
        return;
    }
    
    previewContainer.className = 'foto-preview';
    
    // Crear fragmento para mejor performance
    const fragment = document.createDocumentFragment();
    
    for (let i = 0; i < idArray.length; i++) {
        const id = idArray[i];
        try {
            const base64String = await getImageFromDB(id);
            if (base64String) {
                // Verificar que no exista ya
                const existingDivs = previewContainer.querySelectorAll(`[data-id="${id}"]`);
                if (existingDivs.length > 0) {
                    continue; // Saltar si ya existe
                }
                
                const div = document.createElement("div");
                div.className = "image-preview-item";
                div.setAttribute('data-id', id);
                div.setAttribute('data-index', i);
                div.setAttribute('data-preview-index', index);
                div.style.cursor = 'pointer';
                
                div.onclick = function() {
                    openPhotoPreview(index, i);
                };
                
                const img = document.createElement("img");
                img.src = base64String;
                img.alt = `Vista previa ${i + 1}`;
                div.appendChild(img);
                
                fragment.appendChild(div);
            } else {
                // Eliminar ID no encontrado
                estadoActual.fotos[index] = estadoActual.fotos[index].filter(dbId => dbId !== id);
                saveSession();
            }
        } catch (error) {
            console.error(`Error cargando imagen ID ${id}:`, error);
        }
    }
    
    previewContainer.appendChild(fragment);
    
    // Actualizar contador
    const countSpan = document.getElementById(`foto-count-${index}`);
    if (countSpan) {
        countSpan.textContent = estadoActual.fotos[index] ? estadoActual.fotos[index].length : 0;
    }
    
    actualizarProgresoChecklist();
}


    // =========================================================================
    // VISTA PREVIA DE FOTOS (MODAL)
    // =========================================================================

    function openPhotoPreview(previewIndex, startIndex = 0) {
        const estadoActual = getChecklistEstadoActual();
        const idArray = estadoActual.fotos[previewIndex] || [];
        if (idArray.length === 0) return;
        
        currentPhotoPreview = {
            previewIndex: previewIndex,
            photoIds: [...idArray],
            currentIndex: startIndex,
            totalPhotos: idArray.length
        };
        
        const photoPreviewModal = new bootstrap.Modal(document.getElementById('photoPreviewModal'), {
            backdrop: 'static',
            keyboard: false
        });
        photoPreviewModal.show();
        
        loadPhotoForPreview();
        updatePhotoCounter();
        generatePhotoThumbnails();
        setupPhotoPreviewEvents();
    }

    async function loadPhotoForPreview() {
        if (!currentPhotoPreview) return;
        
        const { photoIds, currentIndex } = currentPhotoPreview;
        const currentId = photoIds[currentIndex];
        
        if (!currentId) return;
        
        $('#photo-loading').show();
        $('#preview-photo').hide();
        
        try {
            const base64String = await getImageFromDB(currentId);
            if (base64String) {
                const img = document.getElementById('preview-photo');
                img.src = base64String;
                
                setTimeout(() => {
                    $('#photo-loading').hide();
                    $('#preview-photo').show().addClass('photo-enter-animation');
                    
                    setTimeout(() => {
                        $('#preview-photo').removeClass('photo-enter-animation');
                    }, 300);
                }, 300);
                
                updateNavigationButtons();
                updateActiveThumbnail();
            }
        } catch (error) {
            console.error("Error cargando foto para vista previa:", error);
            $('#photo-loading').html('<span>Error cargando la foto</span>');
        }
    }

    async function generatePhotoThumbnails() {
        if (!currentPhotoPreview) return;
        
        const { photoIds } = currentPhotoPreview;
        const $thumbnailsContainer = $('#photo-thumbnails');
        $thumbnailsContainer.empty();
        
        for (let i = 0; i < photoIds.length; i++) {
            try {
                const base64String = await getImageFromDB(photoIds[i]);
                if (base64String) {
                    const thumbnail = document.createElement('div');
                    thumbnail.className = 'photo-thumbnail';
                    if (i === currentPhotoPreview.currentIndex) {
                        thumbnail.classList.add('active');
                    }
                    thumbnail.setAttribute('data-index', i);
                    thumbnail.onclick = function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        if (index !== currentPhotoPreview.currentIndex) {
                            currentPhotoPreview.currentIndex = index;
                            updatePhotoCounter();
                            loadPhotoForPreview();
                        }
                    };
                    
                    thumbnail.innerHTML = `
                        <img src="${base64String}" alt="Miniatura ${i + 1}">
                        <div class="photo-thumbnail-index">${i + 1}</div>
                    `;
                    
                    $thumbnailsContainer.append(thumbnail);
                }
            } catch (error) {
                console.error(`Error cargando miniatura ${i}:`, error);
            }
        }
    }

    function updateActiveThumbnail() {
        if (!currentPhotoPreview) return;
        
        const { currentIndex } = currentPhotoPreview;
        $('.photo-thumbnail').removeClass('active');
        $(`.photo-thumbnail[data-index="${currentIndex}"]`).addClass('active');
        
        const activeThumbnail = $(`.photo-thumbnail[data-index="${currentIndex}"]`)[0];
        if (activeThumbnail) {
            activeThumbnail.scrollIntoView({
                behavior: 'smooth',
                block: 'nearest',
                inline: 'center'
            });
        }
    }

    function updatePhotoCounter() {
        if (!currentPhotoPreview) return;
        
        const { currentIndex, totalPhotos } = currentPhotoPreview;
        $('#photo-counter').text(`${currentIndex + 1} de ${totalPhotos}`);
    }

    function updateNavigationButtons() {
        if (!currentPhotoPreview) return;
        
        const { currentIndex, totalPhotos } = currentPhotoPreview;
        
        if (currentIndex === 0) {
            $('#prev-photo').addClass('disabled');
        } else {
            $('#prev-photo').removeClass('disabled');
        }
        
        if (currentIndex === totalPhotos - 1) {
            $('#next-photo').addClass('disabled');
        } else {
            $('#next-photo').removeClass('disabled');
        }
    }

    function setupPhotoPreviewEvents() {
        $('#prev-photo').off('click').on('click', function() {
            if (!currentPhotoPreview || $(this).hasClass('disabled')) return;
            
            currentPhotoPreview.currentIndex--;
            updatePhotoCounter();
            loadPhotoForPreview();
        });
        
        $('#next-photo').off('click').on('click', function() {
            if (!currentPhotoPreview || $(this).hasClass('disabled')) return;
            
            currentPhotoPreview.currentIndex++;
            updatePhotoCounter();
            loadPhotoForPreview();
        });
        
        $('#download-photo').off('click').on('click', async function() {
            if (!currentPhotoPreview) return;
            
            const { photoIds, currentIndex } = currentPhotoPreview;
            const currentId = photoIds[currentIndex];
            
            if (!currentId) return;
            
            try {
                const base64String = await getImageFromDB(currentId);
                if (base64String) {
                    const link = document.createElement('a');
                    link.href = base64String;
                    link.download = `foto_checklist_${currentId}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Foto descargada',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            } catch (error) {
                console.error("Error descargando foto:", error);
                Swal.fire('Error', 'No se pudo descargar la foto.', 'error');
            }
        });
        
        $('#delete-photo').off('click').on('click', async function() {
            if (!currentPhotoPreview) return;
            
            const { previewIndex, photoIds, currentIndex } = currentPhotoPreview;
            const currentId = photoIds[currentIndex];
            
            if (!currentId) return;
            
            Swal.fire({
                title: '¿Eliminar esta foto?',
                text: "Esta acción no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef5350',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await deleteImageFromDB(currentId);
                        
                        const estadoActual = getChecklistEstadoActual();
                        if (estadoActual.fotos[previewIndex]) {
                            estadoActual.fotos[previewIndex] = estadoActual.fotos[previewIndex].filter(id => id !== currentId);
                        }
                        
                        currentPhotoPreview.photoIds = estadoActual.fotos[previewIndex] || [];
                        currentPhotoPreview.totalPhotos = currentPhotoPreview.photoIds.length;
                        
                        if (currentPhotoPreview.totalPhotos === 0) {
                            const photoPreviewModal = bootstrap.Modal.getInstance(document.getElementById('photoPreviewModal'));
                            if (photoPreviewModal) {
                                photoPreviewModal.hide();
                            }
                        } else {
                            if (currentPhotoPreview.currentIndex >= currentPhotoPreview.totalPhotos) {
                                currentPhotoPreview.currentIndex = currentPhotoPreview.totalPhotos - 1;
                            }
                            
                            updatePhotoCounter();
                            loadPhotoForPreview();
                            generatePhotoThumbnails();
                        }
                        
                        await renderizarPreviews(previewIndex);
                        saveSession();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Foto eliminada',
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000
                        });
                        
                    } catch (error) {
                        console.error("Error eliminando foto:", error);
                        Swal.fire('Error', 'No se pudo eliminar la foto.', 'error');
                    }
                }
            });
        });
        
        $('#photoPreviewModal').off('shown.bs.modal').on('shown.bs.modal', function() {
            $(document).on('keydown.photoPreview', function(e) {
                if (!currentPhotoPreview) return;
                
                switch(e.key) {
                    case 'ArrowLeft':
                        if (currentPhotoPreview.currentIndex > 0) {
                            e.preventDefault();
                            currentPhotoPreview.currentIndex--;
                            updatePhotoCounter();
                            loadPhotoForPreview();
                        }
                        break;
                        
                    case 'ArrowRight':
                        if (currentPhotoPreview.currentIndex < currentPhotoPreview.totalPhotos - 1) {
                            e.preventDefault();
                            currentPhotoPreview.currentIndex++;
                            updatePhotoCounter();
                            loadPhotoForPreview();
                        }
                        break;
                        
                    case 'Escape':
                        const photoPreviewModal = bootstrap.Modal.getInstance(document.getElementById('photoPreviewModal'));
                        if (photoPreviewModal) {
                            photoPreviewModal.hide();
                        }
                        break;
                }
            });
        });
        
        $('#photoPreviewModal').off('hidden.bs.modal').on('hidden.bs.modal', function() {
            $(document).off('keydown.photoPreview');
            currentPhotoPreview = null;
        });
    }

    // =========================================================================
    // FUNCIONES PARA FIRMA
    // =========================================================================

    function initializeCanvas() {
        canvas.width = 400;
        canvas.height = 200;
        ctx.strokeStyle = "#000000";
        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function getCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        if (e.touches && e.touches.length > 0) {
            return {
                x: (e.touches[0].clientX - rect.left) * scaleX,
                y: (e.touches[0].clientY - rect.top) * scaleY
            };
        } else if (e.offsetX !== undefined) {
            return {
                x: e.offsetX * scaleX,
                y: e.offsetY * scaleY
            };
        } else if (e.clientX !== undefined) {
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }
        
        return { x: 0, y: 0 };
    }

    function startDrawing(e) {
        e.preventDefault();
        saveToUndoStack();
        isDrawing = true;
        const { x, y } = getCoordinates(e);
        lastX = x;
        lastY = y;
        
        ctx.beginPath();
        ctx.arc(x, y, ctx.lineWidth/2, 0, Math.PI * 2);
        ctx.fillStyle = isErasing ? "#FFFFFF" : "#000000";
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        
        const { x, y } = getCoordinates(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = isErasing ? "#FFFFFF" : "#000000";
        ctx.lineWidth = isErasing ? 20 : 4;
        ctx.stroke();
        
        lastX = x;
        lastY = y;
    }

    function stopDrawing() {
        if (isDrawing) {
            isDrawing = false;
            setTimeout(saveSession, 500);
            setTimeout(verificarFormulario, 50);
        }
    }

    function saveToUndoStack() {
        undoStack.push(canvas.toDataURL());
        redoStack.length = 0;
        updateButtonStates();
    }

    function undo() {
        if (undoStack.length > 0) {
            redoStack.push(canvas.toDataURL());
            const lastState = undoStack.pop();
            const img = new Image();
            img.src = lastState;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                verificarFormulario();
                saveSession();
            };
            updateButtonStates();
        }
    }

    function redo() {
        if (redoStack.length > 0) {
            undoStack.push(canvas.toDataURL());
            const lastState = redoStack.pop();
            const img = new Image();
            img.src = lastState;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                verificarFormulario();
                saveSession();
            };
            updateButtonStates();
        }
    }

    function updateButtonStates() {
        document.getElementById("undo").style.display = undoStack.length > 0 ? "block" : "none";
        document.getElementById("redo").style.display = redoStack.length > 0 ? "block" : "none";
    }

    function clearSignature() {
        saveToUndoStack();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        setTimeout(() => {
            verificarFormulario();
            saveSession();
        }, 100);
        
        updateButtonStates();
    }

    function setupSignatureEvents() {
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseout", stopDrawing);
        
        canvas.addEventListener("touchstart", function(e) {
            startDrawing(e);
            e.preventDefault();
        }, { passive: false });
        
        canvas.addEventListener("touchmove", function(e) {
            draw(e);
            e.preventDefault();
        }, { passive: false });
        
        canvas.addEventListener("touchend", stopDrawing);
        canvas.addEventListener("touchcancel", stopDrawing);
        
        document.getElementById("toggleEraser").addEventListener("click", function() {
            isErasing = !isErasing;
            this.classList.toggle("active");
            this.innerHTML = isErasing ? 
                '<i class="fas fa-pen"></i>' : 
                '<i class="fas fa-eraser"></i>';
        });
        
        document.getElementById("undo").addEventListener("click", undo);
        document.getElementById("redo").addEventListener("click", redo);
        document.getElementById("clearSignature").addEventListener("click", clearSignature);
        
        canvas.addEventListener("contextmenu", function(e) { e.preventDefault(); });
        
        canvas.style.touchAction = "none";
        canvas.style.msTouchAction = "none";
    }

    function isCanvasBlank(canvas) {
        try {
            const context = canvas.getContext('2d');
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const pixelBuffer = new Uint32Array(imageData.data.buffer);
            
            let nonWhitePixels = 0;
            for (let i = 0; i < pixelBuffer.length; i++) {
                if (pixelBuffer[i] !== 0xFFFFFFFF && pixelBuffer[i] !== 0x00000000) {
                    nonWhitePixels++;
                }
            }
            const hasContent = nonWhitePixels > 100;
            return !hasContent;
            
        } catch (error) {
            console.error('Error al verificar canvas:', error);
            return true;
        }
    }

    // =========================================================================
    // FUNCIONES PRINCIPALES DE LA APLICACIÓN - ACTUALIZADAS
    // =========================================================================

    function verificarFormulario() {
        let colaborador = $("#colaborador").val();
        const hayFirma = !isCanvasBlank(canvas);
        
        let colaboradorValido = true;
        if (modoActual === "salidas") {
            colaboradorValido = allColaboradores.includes(colaborador);
        } else {
            colaboradorValido = colaborador !== '';
        }

        if (modoActual === "salidas") {
            if (colaborador && !colaboradorValido) {
                $("#colaborador").css("border-color", "red");
            } else {
                $("#colaborador").css("border-color", colaborador ? "#28a745" : "#ddd");
            }
        }
        
        if (hayFirma) {
            canvas.style.borderColor = "#28a745";
            canvas.style.borderWidth = "2px";
        } else {
            canvas.style.borderColor = "#ddd";
            canvas.style.borderWidth = "1px";
        }
    }

function configurarEventos() {
    $('#buscador').on('input', filtrarEquipos);

    // Evento para el interruptor de sin revisión
    $('#toggleSinRevision').on('change', function() {
        const estadoActual = getEstadoActual();
        estadoActual.sinRevision = $(this).is(':checked');
        
        // Actualizar la variable global correspondiente
        if (modoActual === 'salidas') {
            estadoSalidas = estadoActual;
        }
        
        // Actualizar visibilidad
        actualizarVisibilidadSegunRevision();
        
        // Si hay equipo seleccionado y activamos sin revisión, ocultar checklist
        if (equipoSeleccionado && estadoActual.sinRevision) {
            ocultarChecklist();
        } else if (equipoSeleccionado && !estadoActual.sinRevision) {
            mostrarChecklist();
        }
        
        verificarFormulario();
        saveSession();
    });
    
    // Eventos para guardar colaborador y área
    $("#colaborador, #area").on("change input", function() {
        const estadoActual = getEstadoActual();
        estadoActual.colaborador = $('#colaborador').val();
        estadoActual.area = $('#area').val();
        
        // Actualizar la variable global correspondiente
        if (modoActual === 'salidas') {
            estadoSalidas = estadoActual;
        } else {
            estadoEntradas = estadoActual;
        }
        
        verificarFormulario();
        saveSession();
    });
    
    // Evento para fecha
    $("#fecha").on("change", function() {
        verificarFormulario();
        saveSession();
    });
    
    $("#checklistObservaciones").on("input", function() {
        guardarEstadoChecklist();
        saveSession();
    });
    
    // Eventos para botones de modo
    $('#btnSalidas').on('click', function() { 
        cambiarModo('salidas'); 
    });
    $('#btnEntradas').on('click', function() { 
        cambiarModo('entradas'); 
    });
}


// Función para inicializar campos al cargar la página
function inicializarCamposDesdeEstado() {
    const estadoActual = getEstadoActual();
    
    // Establecer fecha actual si no hay fecha
    if (!$('#fecha').val()) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        $('#fecha').val(`${yyyy}-${mm}-${dd}`);
    }
    
    // Cargar colaborador y área del estado actual
    $('#colaborador').val(estadoActual.colaborador || '');
    $('#area').val(estadoActual.area || '');
    
    // Cargar estado del interruptor de sin revisión
    if (modoActual === 'salidas') {
        $('#sin-revision-container').show();
        $('#toggleSinRevision').prop('checked', estadoActual.sinRevision || false);
        actualizarVisibilidadSegunRevision();
    } else {
        $('#sin-revision-container').hide();
        $('#toggleSinRevision').prop('checked', false);
    }
    
    // Configurar campos según el modo
    if (modoActual === 'entradas') {
        $('#fecha').prop('disabled', true);
        $('#colaborador').prop('disabled', true);
        $('#area').prop('disabled', true).val("Bodega");
        
        // En modo entrada, si hay equipo seleccionado, usar su colaborador
        if (equipoSeleccionado && equipoSeleccionado.asignadoA && !estadoActual.colaborador) {
            $('#colaborador').val(equipoSeleccionado.asignadoA);
            estadoActual.colaborador = equipoSeleccionado.asignadoA;
            
            // Actualizar el estado
            estadoEntradas = estadoActual;
        }
    } else {
        $('#fecha').prop('disabled', false);
        $('#colaborador').prop('disabled', false);
        $('#area').prop('disabled', false);
    }
}


function cambiarModo(modo) {
    // Si ya estamos en ese modo, no hacer nada
    if (modo === modoActual) return;
    
    // 1. GUARDAR ESTADO ACTUAL del modo anterior ANTES de cambiar
    const estadoModoAnterior = getEstadoActual();
    estadoModoAnterior.colaborador = $('#colaborador').val();
    estadoModoAnterior.area = $('#area').val();
    estadoModoAnterior.sinRevision = $('#toggleSinRevision').is(':checked'); // Guardar estado
    
    // Actualizar el estado en la variable global correspondiente
    if (modoActual === 'salidas') {
        estadoSalidas = estadoModoAnterior;
    } else {
        estadoEntradas = estadoModoAnterior;
    }
    
    // 2. CAMBIAR EL MODO
    modoActual = modo;
    
    // 3. OBTENER ESTADO DEL NUEVO MODO
    const estadoNuevoModo = getEstadoActual();
    
    // 4. MOSTRAR/OCULTAR INTERRUPTOR DE SIN REVISIÓN
    if (modo === 'salidas') {
        $('#sin-revision-container').show();
        $('#toggleSinRevision').prop('checked', estadoNuevoModo.sinRevision || false);
    } else {
        $('#sin-revision-container').hide();
        // Siempre desactivar para entradas
        $('#toggleSinRevision').prop('checked', false);
    }
    
    // Solo ocultar checklist si no hay equipo seleccionado
    if (!equipoSeleccionado) {
        ocultarChecklist();
    }
    
    $('.equipo').css('border-color', '#ddd').css('background-color', '#f9f9f9');
    $('#buscador').val('');
    
    if (modo === 'salidas') {
        $('#btnSalidas').removeClass('inactivo').addClass('activo');
        $('#btnEntradas').removeClass('activo').addClass('inactivo');
        $('#titulo-equipos').text('Seleccione la aspiradora a prestar:');
        
        $('#fecha').prop('disabled', false);
        $('#colaborador').prop('disabled', false);
        $('#area').prop('disabled', false);
        $('#buscador').prop('disabled', false);
        
        // Cargar valores del modo salidas
        $('#colaborador').val(estadoNuevoModo.colaborador || '');
        $('#area').val(estadoNuevoModo.area || '');
        
    } else {
        $('#btnSalidas').removeClass('activo').addClass('inactivo');
        $('#btnEntradas').removeClass('inactivo').addClass('activo');
        $('#titulo-equipos').text('Seleccione la aspiradora a devolver:');
        
        $('#fecha').prop('disabled', true);
        $('#colaborador').prop('disabled', true);
        $('#area').prop('disabled', true);
        $('#buscador').prop('disabled', false);
        
        // Cargar valores del modo entradas
        $('#colaborador').val(estadoNuevoModo.colaborador || '');
        $('#area').val(estadoNuevoModo.area || 'Bodega');
        
        // En modo entrada, si hay equipo seleccionado y no hay colaborador guardado, usar el del equipo
        if (equipoSeleccionado && equipoSeleccionado.asignadoA && !estadoNuevoModo.colaborador) {
            $('#colaborador').val(equipoSeleccionado.asignadoA);
            estadoNuevoModo.colaborador = equipoSeleccionado.asignadoA;
            
            // Actualizar el estado en la variable global
            estadoEntradas = estadoNuevoModo;
        }
    }

    mostrarEquiposEnUI();
    verificarFormulario();
    
    // Si hay equipo seleccionado, mostrar checklist del modo actual (o no mostrarlo si es sin revisión)
    if (equipoSeleccionado) {
        if (modo === 'salidas' && estadoNuevoModo.sinRevision) {
            // Si está en modo salidas y tiene sin revisión activado, ocultar checklist
            ocultarChecklist();
        } else {
            mostrarChecklist();
        }
    }
    
    // Actualizar visibilidad según el interruptor
    actualizarVisibilidadSegunRevision();
    
    // Guardar la sesión con los estados actualizados
    setTimeout(saveSession, 100);
}



    async function cargarTodosLosDatos() {
        showLoadingOverlay('Por favor espera un momento...');
        
        const scriptURL = "https://script.google.com/macros/s/AKfycbxbiQDZcTJA2I9XknV-VF-3E9NdK_b8xq-8fc4LkZ4jh5n4jkJQz0_UlB_zbKpHSJGl/exec";

        try {
            const data = await $.get(scriptURL);
            hideLoadingOverlay();
            
            if (data.error) {
                Swal.fire('Error', 'No se pudieron cargar los datos: ' + data.mensaje, 'error');
                return;
            }
            
            equipos = data.equipos;
            colaboradores = data.colaboradores;
            allColaboradores = data.colaboradores;
            
            await saveDataToStore(STORE_EQUIPOS, 'equipos', data.equipos);
            await saveDataToStore(STORE_COLABORADORES, 'colaboradores', data.colaboradores);
            
            data.areas.forEach(area => {
                if (!areas.includes(area)) {
                    areas.push(area);
                }
            });

            mostrarEquiposEnUI();
            llenarSelects();
            
        } catch (error) {
            hideLoadingOverlay();
            console.error("Error en la solicitud AJAX:", error);
            
            try {
                const cachedEquipos = await getDataFromStore(STORE_EQUIPOS, 'equipos');
                const cachedColaboradores = await getDataFromStore(STORE_COLABORADORES, 'colaboradores');
                
                if (cachedEquipos && cachedColaboradores) {
                    equipos = cachedEquipos;
                    colaboradores = cachedColaboradores;
                    allColaboradores = cachedColaboradores;
                    
                    mostrarEquiposEnUI();
                    llenarSelects();
                    
                    Swal.fire({
                        icon: 'info',
                        title: 'Modo Offline',
                        text: 'Usando datos cacheados. Algunas funciones pueden estar limitadas.',
                        timer: 3000
                    });
                } else {
                    Swal.fire('Error', 'No se pudo conectar al servidor y no hay datos cacheados.', 'error');
                }
            } catch (cacheError) {
                Swal.fire('Error', 'No se pudo conectar al servidor.', 'error');
            }
        }
    }

    function llenarSelects() {
        const areaSelect = $('#area');
        areaSelect.find('option:not(:first)').remove();
        areas.forEach(area => {
            areaSelect.append(`<option value="${area}">${area}</option>`);
        });
    }

    function mostrarEquiposEnUI() {
        const equiposContainer = $('#equipos');
        equiposContainer.empty();

        equipos.forEach((equipo, index) => {
            if (equipo.nombre.startsWith("-")) {
                let categoryName = equipo.nombre.substring(1).trim();
                equiposContainer.append(`
                    <div class="category-separator">
                        <strong>${categoryName}</strong> <span class="toggle-icon">&#9660;</span>
                    </div>
                `);
                return;
            }

            if (modoActual === "salidas" && !equipo.disponible) {
                return;
            }

            if (modoActual === "entradas" && equipo.disponible) {
                return;
            }

            let estadoClass = equipo.disponible ? 'disponible' : 'no-disponible';
            let estadoText = equipo.disponible ? 'Disponible' : `Ocupada por: ${equipo.asignadoA}`;
            
            let isSelected = equipoSeleccionado && equipoSeleccionado.nombre === equipo.nombre;
            let borderStyle = isSelected ? 'border-color: #007BFF; background-color: #e6f0ff;' : '';

            let equipoHtml = `
                <div class="equipo" id="equipo-${index}" data-index="${index}" onclick="seleccionarEquipo(${index})" style="${borderStyle}">
                    <img src="${equipo.imagen || ''}" alt="${equipo.nombre}" onerror="this.style.display='none'">
                    <label>${equipo.nombre}</label>
                    <span class="${estadoClass}">${estadoText}</span>
                </div>
            `;

            equiposContainer.append(equipoHtml);

            if (!equipo.disponible && modoActual === "salidas") {
                $(`#equipo-${index}`).css('opacity', '0.6').css('cursor', 'not-allowed');
            }
        });

        $('.category-separator').off('click').on('click', function() {
            const $separator = $(this);
            const $toggleIcon = $separator.find('.toggle-icon');
            const $equiposToToggle = $separator.nextUntil('.category-separator');
            $equiposToToggle.toggle();
            $separator.toggleClass('collapsed');
            if ($separator.hasClass('collapsed')) {
                $toggleIcon.html('&#9658;');
            } else {
                $toggleIcon.html('&#9660;');
            }
        });
    }

    function filtrarEquipos() {
        const textoBusqueda = $('#buscador').val().toLowerCase();
        
        $('.equipo, .category-separator').hide();

        $('.equipo').each(function() {
            const nombreEquipo = $(this).find('label').text().toLowerCase();
            if (nombreEquipo.includes(textoBusqueda)) {
                $(this).show();
                $(this).prevAll('.category-separator:first').show().removeClass('collapsed').find('.toggle-icon').html('&#9660;');
            }
        });
        
        if (textoBusqueda === '') {
            mostrarEquiposEnUI();
        }
    }

function seleccionarEquipo(index) {
    const equipo = equipos[index];
    if (!equipo.disponible && modoActual === "salidas") {
        return;
    }

    const equipoAnterior = equipoSeleccionado;
    equipoSeleccionado = equipo;

    $('.equipo').css('border-color', '#ddd').css('background-color', '#f9f9f9');
    $(`#equipo-${index}`).css('border-color', '#007BFF').css('background-color', '#e6f0ff');
    
    const estadoActual = getEstadoActual();
    
    if (modoActual === "entradas") {
        $('#buscador').prop('disabled', true);
        $('#fecha').prop('disabled', true);
        $('#colaborador').prop('disabled', true);
        $('#area').prop('disabled', true);
        
        // En modo entrada, SIEMPRE usar colaborador del equipo
        if (equipoSeleccionado.asignadoA) {
            $('#colaborador').val(equipoSeleccionado.asignadoA);
            estadoActual.colaborador = equipoSeleccionado.asignadoA;
            
            // Actualizar el estado en la variable global correspondiente
            if (modoActual === 'salidas') {
                estadoSalidas = estadoActual;
            } else {
                estadoEntradas = estadoActual;
            }
        }
        
        // Área siempre "Bodega" en entradas
        $('#area').val("Bodega");
        estadoActual.area = "Bodega";
    } else {
        $('#colaborador').prop('disabled', false);
        $('#area').prop('disabled', false);
        // En salidas, mantener los valores del estado actual
        $('#colaborador').val(estadoActual.colaborador || '');
        $('#area').val(estadoActual.area || '');
    }

    // Solo regenerar checklist si cambió el equipo Y NO está en modo sin revisión
    if (!equipoAnterior || equipoAnterior.nombre !== equipo.nombre) {
        if (modoActual === 'salidas' && estadoActual.sinRevision) {
            // Si está en modo sin revisión, ocultar checklist
            ocultarChecklist();
        } else {
            mostrarChecklist();
        }
    }
    
    // Actualizar visibilidad según el interruptor
    actualizarVisibilidadSegunRevision();
    
    saveSession();
}


    // =========================================================================
    // VALIDACIÓN Y PROCESAMIENTO DE FORMULARIO
    // =========================================================================

function validarFormularioCompleto() {
    let fecha = $("#fecha").val();
    let colaborador = $("#colaborador").val();
    let area = $("#area").val();
    
    let colaboradorValido = true;
    if (modoActual === "salidas") {
        colaboradorValido = allColaboradores.includes(colaborador);
    } else {
        colaboradorValido = colaborador !== '';
    }

    if (!fecha || !colaborador || !area || !colaboradorValido) {
        Swal.fire('Datos Incompletos', 'Por favor completa los campos de Fecha, Colaborador (válido) y Destino.', 'warning');
        return;
    }

    if (!equipoSeleccionado) {
        Swal.fire('Aspiradora no seleccionada', 'Por favor selecciona una aspiradora.', 'warning');
        return;
    }
    
    const estadoActual = getChecklistEstadoActual();
    const sinRevision = modoActual === 'salidas' && $('#toggleSinRevision').is(':checked');
    
    // VALIDACIÓN DIFERENTE PARA MODO SIN REVISIÓN
    if (sinRevision) {
        // En modo sin revisión, no se requiere checklist, solo firma
        console.log("Modo sin revisión activado - Checklist no requerido");
    } else {
        // Validación normal del checklist
        const items = document.querySelectorAll('.checklist-item');
        const totalItems = items.length;
        let itemsCompletados = 0;
        
        if (!estadoActual.fotos) estadoActual.fotos = {};

        items.forEach((item, index) => {
            const botonSeleccionado = item.querySelector('.selected') !== null;
            const hayFotos = estadoActual.fotos[index] && estadoActual.fotos[index].length > 0;
            
            if (botonSeleccionado && hayFotos) {
                itemsCompletados++;
            }
        });

        if (itemsCompletados !== totalItems) {
            Swal.fire('Checklist Incompleto', 'Debes completar todos los puntos del checklist, incluyendo al menos una foto por cada item.', 'warning');
            return;
        }
    }
    
    const canvasFirma = document.getElementById('firmaCanvas');
    if (isCanvasBlank(canvasFirma)) {
        Swal.fire('Firma Faltante', 'La firma del responsable es obligatoria.', 'warning');
        return;
    }
    
    ultimaTransaccion = {
        fecha: fecha,
        colaborador: colaborador,
        area: area,
        equipo: equipoSeleccionado.nombre,
        tipo: modoActual,
        sinRevision: sinRevision, // NUEVO: Agregar esta propiedad
        checklistRespuestas: [],
        observaciones: document.getElementById('checklistObservaciones').value,
        fotosChecklist: estadoActual.fotos
    };
    
    // SI ES SIN REVISIÓN, LLENAR CON "-"
    if (sinRevision) {
        const checklistData = checklistsPreOperativos["aspiradoras"];
        const respuestasSinRevision = checklistData.map(() => "-");
        ultimaTransaccion.checklistRespuestas = respuestasSinRevision;
    } else {
        // Checklist normal
        const checklistRespuestas = [];
        document.querySelectorAll('.checklist-item').forEach(item => {
            const selectedButton = item.querySelector('.selected');
            checklistRespuestas.push(selectedButton ? 
                (selectedButton.classList.contains('check-button') ? '✔' : 'X') : '');
        });
        
        ultimaTransaccion.checklistRespuestas = checklistRespuestas;
    }
    
    mostrarConfirmacionFinal();
}


function mostrarConfirmacionFinal() {
    const tipoMovimiento = ultimaTransaccion.tipo === 'salidas' ? 'préstamo' : 'devolución';
    const textoAccion = ultimaTransaccion.tipo === 'salidas' ? 'solicitar' : 'devolver';
    
    // Determinar si es sin revisión
    const esSinRevision = ultimaTransaccion.sinRevision;
    
    Swal.fire({
        title: `Confirmar ${tipoMovimiento}`,
        html: `
            <div style="text-align: left;">
                <p><strong>Fecha:</strong> ${ultimaTransaccion.fecha}</p>
                <p><strong>Colaborador:</strong> ${ultimaTransaccion.colaborador}</p>
                <p><strong>Área:</strong> ${ultimaTransaccion.area}</p>
                <p><strong>Aspiradora:</strong> ${ultimaTransaccion.equipo}</p>
                ${esSinRevision ? '<p><strong style="color: #ff9800;"><i class="fas fa-bolt"></i> Modo sin revisión</strong></p>' : ''}
                ${ultimaTransaccion.observaciones ? `<p><strong>Observaciones:</strong> ${ultimaTransaccion.observaciones}</p>` : ''}
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: `Sí, ${textoAccion}`,
        cancelButtonText: 'No, revisar',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        width: '500px'
    }).then((result) => {
        if (result.isConfirmed) {
            procesarYGenerarPDF();
        }
    });
}


    async function procesarYGenerarPDF() {
        showLoadingOverlay('Procesando datos y generando documento...');
        
        try {
            await generarPDF();
            hideLoadingOverlay();
            
            Swal.fire({
                title: '¡Reporte Guardado!',
                html: `
                    <div class="text-center">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <p>El reporte está listo y se enviará una vez se sincronice.</p>
                        <p class="small text-muted">Tu progreso actual sigue aquí por si necesitas editar algo más.</p>
                    </div>
                `,
                icon: 'success',
                allowOutsideClick: false,
                showCloseButton: true,
                
                confirmButtonText: '<i class="fas fa-list-ul me-2"></i> Ver Pendientes',
                confirmButtonColor: '#2c3e50',
                
                showCancelButton: true,
                cancelButtonText: '<i class="fas fa-plus me-2"></i> Nuevo Reporte',
                cancelButtonColor: '#3498db'
            }).then((result) => {
                if (result.isConfirmed) {
                    renderizarModalPendientes();
                    $('#modalSync').modal('show');
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    confirmarNuevoReporte();
                }
            });
            
        } catch (error) {
            hideLoadingOverlay();
            console.error("Error al generar PDF:", error);
            Swal.fire('Error', 'No se pudo generar el reporte: ' + error.message, 'error');
        }
    }

    function confirmarNuevoReporte() {
        Swal.fire({
            title: '¿Iniciar nuevo reporte?',
            text: "Esto borrará todo el formulario actual. Si ya generaste el PDF, es seguro continuar.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, empezar de cero',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#2ecc71',
            cancelButtonColor: '#7f8c8d'
        }).then(async (result) => {
            if (result.isConfirmed) {
                await clearSession();
            }
        });
    }

    // =========================================================================
    // GENERACIÓN DE PDF - ACTUALIZADO
    // =========================================================================

async function generarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        format: 'letter',
        unit: 'mm'
    });
    
    doc.setFont("times", "normal");
    const tipoMovimiento = ultimaTransaccion.tipo === 'salidas' ? 'Acta de Compromiso' : 'Acta de Recepción';
    const tituloChecklist = ultimaTransaccion.tipo === 'salidas' ? 'Checklist Preoperativo' : 'Checklist Postoperativo';
    const now = new Date();
    const [yyyy, mm, dd] = ultimaTransaccion.fecha.split('-');
    const meses = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];
    const mesTexto = meses[parseInt(mm) - 1];
    let y = 15;
    const margin = 15;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const textWidth = pageWidth - (2 * margin);
    
    // Encabezado
    doc.setFontSize(16);
    doc.setTextColor(34, 49, 63);
    doc.setFont("times", "bold");
    doc.text(tipoMovimiento, pageWidth / 2, y, { align: 'center' });
    y += 8;
    doc.setDrawColor(200, 200, 200);
    doc.line(margin, y, pageWidth - margin, y);
    y += 10;
    doc.setFontSize(12);
    doc.setTextColor(50, 50, 50);
    doc.setFont("times", "normal");

    // Contenido del acta
    if (ultimaTransaccion.tipo === 'salidas') {
        const textoCompleto = `Yo ${ultimaTransaccion.colaborador} mediante la presente Acta de Compromiso hago constar que en esta fecha estoy recibiendo la aspiradora ${ultimaTransaccion.equipo}, la cual será utilizada para el desempeño de mis funciones.`;
        const lineas = doc.splitTextToSize(textoCompleto, textWidth);
        doc.text(lineas, margin, y);
        y += (lineas.length * 6) + 4;
        
        doc.setFont("times", "bold");
        const textoCompromiso = "Habiendo recibido me comprometo a lo siguiente:";
        doc.text(textoCompromiso, margin, y);
        y += 7;
        
        doc.setFont("times", "normal");
        const compromisos = [
            "- Cuidar y hacer buen uso de la misma, durante el tiempo que este bajo mi cargo en beneficio de las actividades del negocio.",
            "- En caso de accidente, daño por mal uso y cualquier que bajo mi uso dañe la aspiradora se procederá a realizar la deducción del valor completo proporcionando una nueva.",
            "- Me comprometo a cuidar todos y cada uno de los componentes de la aspiradora."
        ];
        
        compromisos.forEach(compromiso => {
            const splitText = doc.splitTextToSize(compromiso, textWidth - 5);
            doc.text(splitText, margin + 5, y);
            y += (splitText.length * 5) + 3;
        });
        
        y += 5;
        const textoFinal = `Firmo la presente en la ciudad de Tegucigalpa a los ${dd} días del mes de ${mesTexto} del ${yyyy}.`;
        const lineasFinal = doc.splitTextToSize(textoFinal, textWidth);
        doc.text(lineasFinal, margin, y);
        y += (lineasFinal.length * 6) + 10;
    } else if (ultimaTransaccion.tipo === 'entradas') {
        const textoCompleto = `Yo ${ultimaTransaccion.colaborador} mediante la presente Acta de Recepción hago constar que en esta fecha estoy entregando la aspiradora ${ultimaTransaccion.equipo}, la cual fue utilizada para el desempeño de mis funciones y ahora estoy retornando.`;
        const lineas = doc.splitTextToSize(textoCompleto, textWidth);
        doc.text(lineas, margin, y);
        y += (lineas.length * 6) + 4;
        
        doc.setFont("times", "bold");
        const textoDeclaracion = "Al entregarla declaro lo siguiente:";
        doc.text(textoDeclaracion, margin, y);
        y += 7;
        
        doc.setFont("times", "normal");
        const declaraciones = [
            "- La aspiradora se encuentra en las mismas condiciones en las que me fue entregada.",
            "- Fui responsable y cuidadoso en el uso de la aspiradora y todos sus componentes.",
            "- Cualquier daño, accidente o mal uso fue reportado en tiempo y forma."
        ];
        
        declaraciones.forEach(declaracion => {
            const splitText = doc.splitTextToSize(declaracion, textWidth - 5);
            doc.text(splitText, margin + 5, y);
            y += (splitText.length * 5) + 3;
        });
        
        y += 5;
        const textoFinal = `Firmo la presente en la ciudad de Tegucigalpa a los ${dd} días del mes de ${mesTexto} del ${yyyy}.`;
        const lineasFinal = doc.splitTextToSize(textoFinal, textWidth);
        doc.text(lineasFinal, margin, y);
        y += (lineasFinal.length * 6) + 10;
    }

    // Firma
    const canvasFirma = document.getElementById('firmaCanvas');
    const firmaDataUrl = canvasFirma.toDataURL('image/png');
    const firmaWidth = 60;
    const firmaHeight = 25;
    const firmaX = (pageWidth - firmaWidth) / 2;
    
    doc.addImage(firmaDataUrl, 'PNG', firmaX, y, firmaWidth, firmaHeight);
    y += firmaHeight + 2;
    doc.line(firmaX, y, firmaX + firmaWidth, y);
    y += 4;
    doc.setFontSize(12);
    doc.setTextColor(80, 80, 80);
    doc.setFont("times", "bold");
    doc.text(ultimaTransaccion.colaborador, pageWidth / 2, y, { align: 'center' });
    y += 10;
    doc.line(margin, y, pageWidth - margin, y);
    y += 8;

    // Para checklists largos
    if (ultimaTransaccion.checklistRespuestas.length > 8) {
        doc.addPage();
        y = 15;
    }

    // Checklist
    doc.setFontSize(14);
    doc.setTextColor(34, 49, 63);
    doc.setFont("times", "bold");
    doc.text(tituloChecklist, pageWidth / 2, y, { align: 'center' });
    y += 8;
    
    const checklistData = ultimaTransaccion.tipo === 'salidas' ? 
        checklistsPreOperativos["aspiradoras"] : 
        checklistsPostOperativos["aspiradoras"];
    
    const tableColumn = ["Punto de Verificación", "Cumple", "No Cumple"];
    const tableRows = ultimaTransaccion.checklistRespuestas.map((respuesta, index) => {
        const cumple = respuesta === "✔" ? { content: "X", styles: { fillColor: [46, 204, 113], textColor: [255, 255, 255], fontStyle: 'bold' } } : "";
        const noCumple = respuesta === "X" ? { content: "X", styles: { fillColor: [231, 76, 60], textColor: [255, 255, 255], fontStyle: 'bold' } } : "";
        return [checklistData[index] || `Item ${index + 1}`, cumple, noCumple];
    });
    
    let fontSize = 9;
    let cellPadding = 2;
    let rowHeight = 5;
    
    if (ultimaTransaccion.checklistRespuestas.length > 10) {
        fontSize = 8;
        cellPadding = 1.5;
        rowHeight = 4;
    }
    
    const anchoDisponible = pageWidth - (2 * margin);
    const col1Width = anchoDisponible * 0.75;
    const col2Width = (anchoDisponible - col1Width) / 2;
    const col3Width = col2Width;
    
    doc.autoTable({
        startY: y,
        head: [tableColumn],
        body: tableRows,
        theme: 'grid',
        tableWidth: anchoDisponible,
        margin: { 
            left: margin, 
            right: margin,
            top: y
        },
        headStyles: {
            fillColor: [0, 123, 255],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: fontSize,
            font: "times",
            cellPadding: cellPadding,
            minCellHeight: rowHeight,
            halign: 'center'
        },
        styles: {
            fontSize: fontSize,
            cellPadding: cellPadding,
            textColor: [50, 50, 50],
            lineColor: [200, 200, 200],
            lineWidth: 0.1,
            font: "times",
            minCellHeight: rowHeight
        },
        columnStyles: {
            0: {
                cellWidth: col1Width,
                fontStyle: 'bold',
                halign: 'left',
                cellPadding: {left: 3, right: 3, top: cellPadding, bottom: cellPadding}
            },
            1: {
                cellWidth: col2Width,
                halign: 'center',
                cellPadding: {left: 1, right: 1, top: cellPadding, bottom: cellPadding}
            },
            2: {
                cellWidth: col3Width,
                halign: 'center',
                cellPadding: {left: 1, right: 1, top: cellPadding, bottom: cellPadding}
            }
        },
        pageBreak: 'auto',
        showHead: 'everyPage',
        tableLineWidth: 0.1,
        tableLineColor: [200, 200, 200]
    });

    // Observaciones
    let currentY = doc.autoTable.previous.finalY + 10;
    
    if (ultimaTransaccion.observaciones && ultimaTransaccion.observaciones.trim() !== '') {
        if (currentY + 30 > pageHeight) {
            doc.addPage();
            currentY = 15;
        }
        
        doc.setFontSize(12);
        doc.setTextColor(34, 49, 63);
        doc.setFont("times", "bold");
        doc.text("Observaciones:", margin, currentY);
        currentY += 5;
        
        doc.setFontSize(10);
        doc.setTextColor(50, 50, 50);
        doc.setFont("times", "normal");
        
        const observacionesLines = doc.splitTextToSize(ultimaTransaccion.observaciones, textWidth);
        doc.text(observacionesLines, margin, currentY);
        currentY += (observacionesLines.length * 4) + 10;
    }

    // Fotos del checklist (opcional)
    const fotosAgregadas = ultimaTransaccion.fotosChecklist && Object.keys(ultimaTransaccion.fotosChecklist).some(key => ultimaTransaccion.fotosChecklist[key].length > 0);

    if (fotosAgregadas) {
        currentY = await addChecklistPhotosToPDF(doc, currentY);
    }

    // =========================================================================
    // PARTE CRÍTICA: GENERAR Y GUARDAR EL PDF CON BASE64
    // =========================================================================
    
    // Generar nombre del archivo
    const fecha = new Date(ultimaTransaccion.fecha);
    const year = fecha.getFullYear();
    const month = String(fecha.getMonth() + 1).padStart(2, '0');
    const day = String(fecha.getDate()).padStart(2, '0');
    const tipoMovimientoNombre = ultimaTransaccion.tipo === 'salidas' ? 'Salida' : 'Entrada';
    const pdfName = `${day}-${month}-${year} - ${tipoMovimientoNombre} - ${ultimaTransaccion.equipo} - ${ultimaTransaccion.colaborador}.pdf`;
    
    // 1. Generar el blob del PDF
    const pdfBlob = doc.output('blob');
    
    // 2. Convertir a base64 usando la función auxiliar
    const pdfBase64 = await blobToBase64(pdfBlob);
    
    // 3. IMPORTANTE: Crear el reporte CON el pdfBase64 (sin el prefijo data:...)
    const reporteParaGuardar = {
        fecha: ultimaTransaccion.fecha,
        colaborador: ultimaTransaccion.colaborador,
        area: ultimaTransaccion.area,
        equipo: ultimaTransaccion.equipo,
        tipo: ultimaTransaccion.tipo,
        checklistRespuestas: ultimaTransaccion.checklistRespuestas,
        observaciones: ultimaTransaccion.observaciones,
        nombreArchivo: pdfName,
        // ESTA ES LA LÍNEA MÁS IMPORTANTE: separar la parte base64 pura
        pdfBase64: pdfBase64.split(',')[1], // Quitar "data:application/pdf;base64,"
        creadoEn: Date.now(),
        estado: 'pendiente'
    };

    // 4. Guardar en IndexedDB
    await guardarReportePendiente(reporteParaGuardar);
    
    console.log('PDF generado y guardado. Base64 length:', reporteParaGuardar.pdfBase64 ? reporteParaGuardar.pdfBase64.length : 0);
}
    async function compressImageForPDF(base64String, quality = 0.7) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxWidth = 800;
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    const ratio = maxWidth / width;
                    width = maxWidth;
                    height = height * ratio;
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                resolve(compressedBase64);
            };
            img.onerror = () => resolve(null);
            img.src = base64String;
        });
    }

    async function addChecklistPhotosToPDF(doc, startY) {
        const fotosChecklist = ultimaTransaccion.fotosChecklist || {};
        const todasLasFotos = Object.values(fotosChecklist).flat();

        if (todasLasFotos.length === 0) {
            return startY;
        }

        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        const pageWidth = doc.internal.pageSize.getWidth();
        
        let currentY = startY;

        if (currentY + 20 > pageHeight - margin) {
            doc.addPage();
            currentY = 15;
        }
        
        doc.setFontSize(14);
        doc.setFont("times", "bold");
        doc.text("Evidencia Fotográfica", pageWidth / 2, currentY, { align: 'center' });
        currentY += 10;

        const imgWidth = 60;
        const imgHeight = 40;
        const spacingX = 65;
        const spacingY = 45;
        let currentX = margin;
        let imagesInRow = 0;

        for (const index in fotosChecklist) {
            const fotosItem = fotosChecklist[index] || [];
            for (const id of fotosItem) {
                try {
                    const base64String = await getImageFromDB(id);
                    if (!base64String) continue;
                    
                    const compressedBase64 = await compressImageForPDF(base64String, 0.7);
                    if (!compressedBase64) continue;
                    
                    if (imagesInRow === 3) {
                        imagesInRow = 0;
                        currentX = margin;
                        currentY += spacingY;
                    }
                    
                    if (currentY + imgHeight > pageHeight - margin) {
                        doc.addPage();
                        currentY = 15;
                        currentX = margin;
                        imagesInRow = 0;
                    }
                    
                    doc.addImage(compressedBase64, 'JPEG', currentX, currentY, imgWidth, imgHeight);
                    
                    currentX += spacingX;
                    imagesInRow++;
                    
                } catch(e) {
                    console.error("Error al añadir foto al PDF:", e);
                }
            }
        }
        
        if (imagesInRow > 0) {
            currentY += spacingY;
        }

        return currentY;
    }

    function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    // =========================================================================
    // SISTEMA DE SINCRONIZACIÓN OFFLINE - ACTUALIZADO
    // =========================================================================

    async function guardarReportePendiente(datosReporte) {
        return new Promise((resolve, reject) => {
            if (!db) return reject('DB no inicializada');
            const transaction = db.transaction([STORE_PENDING], 'readwrite');
            const store = transaction.objectStore(STORE_PENDING);
            
            const request = store.add(datosReporte);
            
            request.onsuccess = () => {
                actualizarContadorPendientes();
                resolve();
            };
            request.onerror = (e) => reject(e.target.error);
        });
    }

    async function marcarComoSincronizado(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_PENDING], 'readwrite');
            const store = transaction.objectStore(STORE_PENDING);
            
            const getRequest = store.get(id);
            
            getRequest.onsuccess = () => {
                const data = getRequest.result;
                if (data) {
                    data.estado = 'sincronizado';
                    data.sincronizadoEn = Date.now();
                    store.put(data);
                    actualizarContadorPendientes();
                    resolve();
                } else {
                    resolve();
                }
            };
            getRequest.onerror = (e) => reject(e);
        });
    }

    async function obtenerPendientes() {
        return new Promise((resolve, reject) => {
            if (!db) return resolve([]);
            const transaction = db.transaction([STORE_PENDING], 'readonly');
            const store = transaction.objectStore(STORE_PENDING);
            const request = store.getAll();
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject([]);
        });
    }

    async function borrarPendiente(id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_PENDING], 'readwrite');
            const store = transaction.objectStore(STORE_PENDING);
            const request = store.delete(id);
            request.onsuccess = () => {
                actualizarContadorPendientes();
                resolve();
            };
            request.onerror = (e) => reject(e);
        });
    }

    async function actualizarContadorPendientes() {
        try {
            const todos = await obtenerPendientes();
            const pendientes = todos.filter(r => r.estado === 'pendiente').length;
            
            const $btn = $('#btn-sync-manager');
            const $badge = $('#badge-pendientes');
            
            $badge.text(pendientes);
            
            if (pendientes > 0) {
                $btn.show().addClass('btn-sync-pendiente');
            } else {
                $btn.removeClass('btn-sync-pendiente');
                if (todos.length === 0) {
                    $btn.hide();
                } else {
                    $btn.show();
                }
            }
        } catch (e) {
            console.error("Error contando pendientes", e);
        }
    }

    // =========================================================================
    // GESTOR DE ENVÍOS (MODAL) - ACTUALIZADO
    // =========================================================================

    async function renderizarModalPendientes() {
        const todosLosRegistros = await obtenerPendientes();
        
        const pendientes = todosLosRegistros.filter(r => r.estado === 'pendiente').sort((a, b) => b.creadoEn - a.creadoEn);
        const sincronizados = todosLosRegistros.filter(r => r.estado === 'sincronizado').sort((a, b) => b.sincronizadoEn - a.sincronizadoEn);

        const $listaPendientes = $('#lista-pendientes');
        const $listaSincronizados = $('#lista-sincronizados');
        const $badgeTab = $('#badge-tab-pendientes');

        $listaPendientes.empty();
        $listaSincronizados.empty();
        
        $('#check-all-pendientes').prop('checked', false);
        $('#check-all-sincronizados').prop('checked', false);
        actualizarBotonesSeleccion();

        if (pendientes.length > 0) {
            $badgeTab.text(pendientes.length).show();
        } else {
            $badgeTab.hide();
        }

        // Renderizar Pendientes
        if (pendientes.length === 0) {
            $listaPendientes.html('<div class="text-center p-4 text-muted small">No hay reportes pendientes.</div>');
        } else {
            pendientes.forEach(reporte => {
                const fechaObj = new Date(reporte.creadoEn);
                const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const tipoTexto = reporte.tipo === 'salidas' ? 'Salida' : 'Entrada';
                const iconoTipo = reporte.tipo === 'salidas' ? 'fa-sign-out-alt' : 'fa-sign-in-alt';
                
                const html = `
                    <div class="list-group-item d-flex align-items-center" id="row-reporte-${reporte.id}">
                        <div class="me-2 checkbox-container">
                            <input class="form-check-input check-pendiente fs-5" type="checkbox" value="${reporte.id}">
                        </div>
                        
                        <div class="flex-grow-1 overflow-hidden me-2">
                            <h6 class="mb-0 fw-bold text-dark text-truncate">
                                <i class="fas ${iconoTipo} me-2 text-primary"></i>${reporte.equipo}
                            </h6>
                            <small class="text-muted d-block">
                                <i class="far fa-calendar-alt me-1"></i>${fechaStr} | 
                                <i class="fas fa-user me-1 ms-2"></i>${reporte.colaborador}
                            </small>
                            <span class="badge bg-warning text-dark rounded-pill mt-1" style="font-size: 0.7rem;">
                                ${tipoTexto} - ${reporte.area}
                            </span>
                        </div>

                        <div class="status-wrapper ms-auto" style="display:none;"></div>

                        <div class="action-buttons ms-auto d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary btn-ver-pdf" data-id="${reporte.id}" title="Ver PDF">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success btn-share-pdf" data-id="${reporte.id}" title="Compartir">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete-registro" data-id="${reporte.id}" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                $listaPendientes.append(html);
            });
        }

        // Renderizar Sincronizados
        if (sincronizados.length === 0) {
            $listaSincronizados.html('<div class="text-center p-4 text-muted small">Historial vacío.</div>');
        } else {
            sincronizados.forEach(reporte => {
                const fechaObj = new Date(reporte.sincronizadoEn || reporte.creadoEn);
                const fechaStr = fechaObj.toLocaleDateString() + ' ' + fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const tipoTexto = reporte.tipo === 'salidas' ? 'Salida' : 'Entrada';
                const iconoTipo = reporte.tipo === 'salidas' ? 'fa-sign-out-alt' : 'fa-sign-in-alt';
                
                const html = `
                    <div class="list-group-item d-flex align-items-center" id="row-reporte-${reporte.id}">
                        <div class="me-2 checkbox-container">
                            <input class="form-check-input check-sincronizado fs-5" type="checkbox" value="${reporte.id}">
                        </div>
                        
                        <div class="flex-grow-1 overflow-hidden me-2">
                            <h6 class="mb-0 text-dark text-truncate">
                                <i class="fas ${iconoTipo} me-2 text-primary"></i>${reporte.equipo}
                            </h6>
                            <small class="text-success d-block">
                                <i class="fas fa-check-double me-1"></i>${fechaStr} | 
                                <i class="fas fa-user me-1 ms-2"></i>${reporte.colaborador}
                            </small>
                            <span class="badge bg-success text-white rounded-pill mt-1" style="font-size: 0.7rem;">
                                ${tipoTexto} - ${reporte.area}
                            </span>
                        </div>

                        <div class="status-wrapper ms-auto" style="display:none;"></div>

                        <div class="action-buttons ms-auto d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary btn-ver-pdf" data-id="${reporte.id}" title="Ver PDF">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success btn-share-pdf" data-id="${reporte.id}" title="Compartir">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete-registro" data-id="${reporte.id}" title="Eliminar Historial">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                $listaSincronizados.append(html);
            });
        }
    }

    function actualizarBotonesSeleccion() {
        const pendSeleccionados = $('.check-pendiente:checked').length;
        const sincSeleccionados = $('.check-sincronizado:checked').length;

        $('#btn-sincronizar-seleccionados').prop('disabled', pendSeleccionados === 0);
        $('#btn-delete-pendientes-sel').prop('disabled', pendSeleccionados === 0);

        $('#btn-resync-seleccion').prop('disabled', sincSeleccionados === 0);
        $('#btn-delete-sincronizados-sel').prop('disabled', sincSeleccionados === 0);
    }

async function procesarColaDeEnvio(listaDeReportes) {
    if (listaDeReportes.length === 0) return;

    window.isSyncing = true;
    $('.action-buttons').attr('style', 'display: none !important');
    $('.checkbox-container').css('visibility', 'hidden');
    $('#check-all-pendientes, #check-all-sincronizados').css('visibility', 'hidden');
    $('label[for="check-all-pendientes"], label[for="check-all-sincronizados"]').css('visibility', 'hidden');
    $('#modalSync .btn-close').hide();
    $('#btn-sincronizar-seleccionados, #btn-resync-seleccion').hide();
    $('#btn-delete-pendientes-sel, #btn-delete-sincronizados-sel').hide();
    $('.btn').addClass('disabled');

    let errores = 0;
    let exitos = 0;
    
    // TUS URLs DE GOOGLE APPS SCRIPT
    const SCRIPT_URL_SALIDAS = "https://script.google.com/macros/s/AKfycbwty-nXbxJWkFKWHawv1u7T1iXrmEcFh6VLxEThG25CMgOiaTlWon_Am_1nO1AFplo/exec";
    const SCRIPT_URL_ENTRADAS = "https://script.google.com/macros/s/AKfycbw1RZIuhYYlYlkffMfMjT9-O5Ra9BsAK04J8BEXv067pHoVOd8SUPqf6tCU88GnbHZeQg/exec";

    for (const reporte of listaDeReportes) {
        const $row = $(`#row-reporte-${reporte.id}`);
        const $status = $row.find('.status-wrapper');
        
        $row.find('.action-buttons').hide();
        $status.html('<span class="badge bg-info text-dark"><i class="fas fa-spinner fa-spin"></i> Enviando datos y PDF...</span>').fadeIn();
        
        if ($row.length) {
            $row[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        try {
            // OBTENER DATOS DEL EQUIPO PARA EL RETORNABLE
            let retornable = 'Sí'; // Valor por defecto
            const equipoData = equipos.find(e => e.nombre === reporte.equipo);
            if (equipoData && equipoData.devolucion) {
                retornable = equipoData.devolucion;
            }
            
            // 1. PREPARAR DATOS PARA ENVIAR (INCLUYENDO PDF BASE64)
            const scriptURL = reporte.tipo === 'salidas' ? SCRIPT_URL_SALIDAS : SCRIPT_URL_ENTRADAS;
            
            // DATOS COMPLETOS CON PDF BASE64
            const data = {
                fecha: reporte.fecha,
                colaborador: reporte.colaborador,
                area: reporte.area,
                equipo: reporte.equipo,
                checklist: JSON.stringify(reporte.checklistRespuestas),
                observaciones: reporte.observaciones || "",
                pdfBase64: reporte.pdfBase64 || "" // ESTA ES LA CLAVE - ENVIAR EL PDF EN BASE64
            };
            
            // Agregar campo específico según el tipo
            if (reporte.tipo === 'salidas') {
                data.retornable = retornable;
            } else {
                data.tipo = 'devolucion';
            }

            // 2. ENVIAR CON $.ajax PARA EVITAR CORS
            await $.ajax({
                url: scriptURL,
                type: "POST",
                data: data,
                dataType: "text", // Importante para Google Apps Script
                success: function(response) {
                    console.log('Datos y PDF enviados exitosamente:', response);
                },
                error: function(xhr, status, error) {
                    console.error('Error enviando datos:', error);
                    throw new Error('Error enviando datos a hoja de cálculo: ' + error);
                }
            });

            // 3. MARCAR COMO SINCRONIZADO
            await marcarComoSincronizado(reporte.id);
            
            $status.html('<span class="badge bg-success"><i class="fas fa-check"></i> Enviado con PDF</span>');
            $row.addClass('list-group-item-success');
            exitos++;

        } catch (error) {
            console.error("Error subiendo reporte:", error);
            $status.html('<span class="badge bg-danger"><i class="fas fa-times"></i> Error: ' + (error.message || 'Desconocido') + '</span>');
            errores++;
        }
        
        await new Promise(r => setTimeout(r, 1000)); // Esperar 1 segundo entre envíos
    }

    if (errores === 0) {
        Swal.fire({
            icon: 'success',
            title: 'Proceso Completado',
            html: `✅ Se enviaron ${exitos} reportes correctamente.<br>📄 Los PDFs fueron subidos a Google Drive.`,
            timer: 2000,
            showConfirmButton: false,
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then(() => {
            finishSyncProcess();
        });
    } else {
        Swal.fire({
            title: 'Proceso Finalizado',
            html: `✅ Enviados con éxito: ${exitos}<br>❌ Con errores: ${errores}`,
            icon: 'warning',
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then(() => {
            finishSyncProcess();
        });
    }
}

    async function finishSyncProcess() {
        await renderizarModalPendientes();
        $('#check-all-pendientes, #check-all-sincronizados').css('visibility', 'visible');
        $('label[for="check-all-pendientes"], label[for="check-all-sincronizados"]').css('visibility', 'visible');
        $('#modalSync .btn-close').fadeIn();
        $('#btn-sincronizar-seleccionados, #btn-resync-seleccion').fadeIn();
        $('#btn-delete-pendientes-sel, #btn-delete-sincronizados-sel').fadeIn();
        $('.btn').removeClass('disabled');
        actualizarBotonesSeleccion();
        window.isSyncing = false;
    }

    $('#modalSync').on('hide.bs.modal', function (e) {
        if (window.isSyncing) {
            e.preventDefault();
            return false;
        }
    });

    async function moverAPendientesYEnviar(ids) {
        if (!db) return;
        
        const $btn = $('#btn-resync-seleccion');
        const originalText = '<i class="fas fa-redo me-2"></i> Volver a Sincronizar Seleccionados';
        
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Moviendo...');

        const transaction = db.transaction([STORE_PENDING], 'readwrite');
        const store = transaction.objectStore(STORE_PENDING);

        for (const id of ids) {
            await new Promise((resolve) => {
                const req = store.get(id);
                req.onsuccess = () => {
                    const data = req.result;
                    if (data) {
                        data.estado = 'pendiente';
                        data.creadoEn = Date.now();
                        store.put(data);
                    }
                    resolve();
                };
            });
        }

        $btn.prop('disabled', false).html(originalText);
        $('.check-sincronizado').prop('checked', false);
        actualizarBotonesSeleccion();

        await renderizarModalPendientes();
        
        const tabPendientes = new bootstrap.Tab(document.getElementById('tab-pendientes'));
        tabPendientes.show();
        
        const todos = await obtenerPendientes();
        const listaParaEnviar = todos.filter(r => ids.includes(r.id));

        await procesarColaDeEnvio(listaParaEnviar);
    }

    async function eliminarRegistrosSeleccionados(claseCheckbox) {
        const ids = [];
        $(`.${claseCheckbox}:checked`).each(function() {
            ids.push(parseInt($(this).val()));
        });

        if (ids.length === 0) return;

        Swal.fire({
            title: '¿Eliminar seleccionados?',
            text: `Se eliminarán ${ids.length} registros permanentemente.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                for (const id of ids) {
                    await borrarPendiente(id);
                }
                renderizarModalPendientes();
                Swal.fire('Eliminados', 'Los registros han sido borrados.', 'success');
            }
        });
    }

    // =========================================================================
    // VISTA PREVIA DE PDF
    // =========================================================================

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    $(document).on('click', '.btn-ver-pdf', async function(e) {
        e.stopPropagation();
        const id = parseInt($(this).data('id'));

        if (!db) {
            Swal.fire('Error', 'Base de datos no inicializada', 'error');
            return;
        }

        const btn = $(this);
        const originalHtml = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

        try {
            const transaction = db.transaction([STORE_PENDING], 'readonly');
            const store = transaction.objectStore(STORE_PENDING);
            const request = store.get(id);

            request.onsuccess = async function() {
                const data = request.result;
                if (data && data.pdfBase64) {
                    
                    const container = document.getElementById('pdf-render-container');
                    container.innerHTML = '';
                    
                    $('#modalPdfPreview').modal('show');

                    const pdfData = atob(data.pdfBase64);
                    
                    try {
                        const loadingTask = pdfjsLib.getDocument({data: pdfData});
                        const pdf = await loadingTask.promise;

                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            
                            const viewportOriginal = page.getViewport({scale: 1});
                            const containerWidth = container.clientWidth || window.innerWidth;
                            const desiredWidth = containerWidth - 20;
                            const visualScale = desiredWidth / viewportOriginal.width;
                            const pixelRatio = (window.devicePixelRatio || 1) * 1.5;
                            const renderScale = visualScale * pixelRatio;

                            const viewport = page.getViewport({scale: renderScale});

                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');

                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            canvas.style.width = "100%";
                            canvas.style.maxWidth = `${desiredWidth}px`;
                            canvas.style.height = "auto";
                            canvas.style.marginBottom = "20px";
                            canvas.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)";
                            canvas.style.borderRadius = "4px";

                            container.appendChild(canvas);

                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            await page.render(renderContext).promise;
                        }

                    } catch (renderError) {
                        console.error(renderError);
                        Swal.fire('Error Visualización', 'No se pudo renderizar el PDF.', 'error');
                    }

                } else {
                    Swal.fire('Error', 'No se encontró el PDF.', 'error');
                }
                btn.html(originalHtml).prop('disabled', false);
            };

            request.onerror = function() {
                Swal.fire('Error', 'Error al leer DB.', 'error');
                btn.html(originalHtml).prop('disabled', false);
            };

        } catch (error) {
            console.error(error);
            btn.html(originalHtml).prop('disabled', false);
        }
    });

    $('#modalPdfPreview').on('hidden.bs.modal', function () {
        document.getElementById('pdf-render-container').innerHTML = '';
    });

    // =========================================================================
    // COMPARTIR PDF
    // =========================================================================

    function base64ToBlob(base64, type = 'application/pdf') {
        const binStr = atob(base64);
        const len = binStr.length;
        const arr = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            arr[i] = binStr.charCodeAt(i);
        }
        return new Blob([arr], { type: type });
    }

    $(document).on('click', '.btn-share-pdf', async function(e) {
        e.stopPropagation();
        const id = parseInt($(this).data('id'));

        if (!db) return;

        const btn = $(this);
        const originalHtml = btn.html();
        btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

        try {
            const transaction = db.transaction([STORE_PENDING], 'readonly');
            const store = transaction.objectStore(STORE_PENDING);
            const request = store.get(id);

            request.onsuccess = async function() {
                const data = request.result;
                if (data && data.pdfBase64) {
                    
                    const blob = base64ToBlob(data.pdfBase64, 'application/pdf');
                    const file = new File([blob], data.nombreArchivo || "reporte_aspiradora.pdf", { type: "application/pdf" });

                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: 'Reporte de Aspiradora',
                                text: `Adjunto reporte de aspiradora - ${data.equipo} - ${data.colaborador}`
                            });
                        } catch (error) {
                            if (error.name !== 'AbortError') {
                                console.error('Error al compartir:', error);
                                Swal.fire('Error', 'No se pudo compartir.', 'error');
                            }
                        }
                    } else {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = data.nombreArchivo;
                        link.click();
                        Swal.fire('Descargando', 'Tu dispositivo no soporta compartir directo, se descargará el archivo.', 'info');
                    }
                }
                btn.html(originalHtml).prop('disabled', false);
            };
        } catch (error) {
            console.error(error);
            btn.html(originalHtml).prop('disabled', false);
        }
    });

    // =========================================================================
    // AUTOGUARDADO Y EVENTOS
    // =========================================================================

    function initAutocomplete() {
        const input = document.getElementById('colaborador');
        
        input.addEventListener('input', function(e) {
            const value = e.target.value.toLowerCase();
            filteredColaboradores = allColaboradores.filter(col => 
                col.toLowerCase().includes(value)
            );
            
            showSuggestions(filteredColaboradores);
            verificarFormulario();
            saveSession();
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlightSuggestion('down');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlightSuggestion('up');
            } else if (e.key === 'Enter') {
                e.preventDefault();
                selectHighlightedSuggestion();
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
        
        input.addEventListener('blur', function() {
            setTimeout(hideSuggestions, 200);
        });
        
        document.addEventListener('click', function(e) {
            const suggestionsContainer = document.getElementById('colaborador-suggestions');
            if (!input.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                hideSuggestions();
            }
        });
    }
    
    function showSuggestions(suggestions) {
        const suggestionsContainer = document.getElementById('colaborador-suggestions');
        suggestionsContainer.innerHTML = '';
        
        if (suggestions.length === 0) {
            hideSuggestions();
            return;
        }
        
        suggestions.forEach((suggestion, index) => {
            const div = document.createElement('div');
            div.className = 'autocomplete-suggestion';
            div.textContent = suggestion;
            div.dataset.index = index;
            
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                selectSuggestion(suggestion);
            });
            
            div.addEventListener('mouseover', function() {
                highlightSuggestionIndex(index);
            });
            
            suggestionsContainer.appendChild(div);
        });
        
        suggestionsContainer.style.display = 'block';
        selectedColaboradorIndex = -1;
    }
    
    function hideSuggestions() {
        const suggestionsContainer = document.getElementById('colaborador-suggestions');
        suggestionsContainer.style.display = 'none';
        selectedColaboradorIndex = -1;
    }
    
    function highlightSuggestion(direction) {
        const suggestions = document.querySelectorAll('.autocomplete-suggestion');
        if (suggestions.length === 0) return;
        
        suggestions.forEach(s => s.classList.remove('highlighted'));
        
        if (direction === 'down') {
            selectedColaboradorIndex = (selectedColaboradorIndex + 1) % suggestions.length;
        } else {
            selectedColaboradorIndex = (selectedColaboradorIndex - 1 + suggestions.length) % suggestions.length;
        }
        
        suggestions[selectedColaboradorIndex].classList.add('highlighted');
        suggestions[selectedColaboradorIndex].scrollIntoView({ block: 'nearest' });
    }
    
    function highlightSuggestionIndex(index) {
        const suggestions = document.querySelectorAll('.autocomplete-suggestion');
        suggestions.forEach(s => s.classList.remove('highlighted'));
        selectedColaboradorIndex = index;
        
        if (index >= 0 && index < suggestions.length) {
            suggestions[index].classList.add('highlighted');
        }
    }
    
    function selectHighlightedSuggestion() {
        if (selectedColaboradorIndex >= 0 && filteredColaboradores[selectedColaboradorIndex]) {
            selectSuggestion(filteredColaboradores[selectedColaboradorIndex]);
        }
    }
    
    function selectSuggestion(suggestion) {
        document.getElementById('colaborador').value = suggestion;
        hideSuggestions();
        verificarFormulario();
        saveSession();
    }

    function showLoadingOverlay(message = "Por favor espera un momento...", subMessage = "") {
        const overlay = document.getElementById('overlay');
        const loadingMessage = document.getElementById('loadingMessage');
        
        if (loadingMessage) {
            loadingMessage.querySelector('h4').textContent = message;
            if (subMessage) {
                loadingMessage.querySelector('p').textContent = subMessage;
                loadingMessage.querySelector('p').style.display = 'block';
            } else {
                loadingMessage.querySelector('p').style.display = 'none';
            }
        }
        
        overlay.style.display = 'flex';
    }

    function hideLoadingOverlay() {
        const overlay = document.getElementById('overlay');
        overlay.style.display = 'none';
    }

    // =========================================================================
    // INICIALIZACIÓN DE LA APLICACIÓN
    // =========================================================================

document.addEventListener('DOMContentLoaded', async function() {
    try {
        await initDB();
        initializeCanvas();
        setupSignatureEvents();
        configurarEventos();
        initAutocomplete();
        await checkForSavedSession();
        await cargarTodosLosDatos();
        
        // INICIALIZAR CAMPOS DESDE EL ESTADO
        inicializarCamposDesdeEstado();
        
        setupSyncManagerEvents();
        
        console.log('Aplicación de gestión de aspiradoras inicializada correctamente');
        
    } catch (error) {
        console.error("Error en inicialización:", error);
        Swal.fire('Error', 'Hubo un error al inicializar la aplicación: ' + error.message, 'error');
    }
});


    function setupSyncManagerEvents() {
        $('#btn-sync-manager').on('click', function() {
            renderizarModalPendientes();
            $('#modalSync').modal('show');
        });

        $(document).on('change', '#check-all-pendientes', function() {
            $('.check-pendiente').prop('checked', $(this).is(':checked'));
            actualizarBotonesSeleccion();
        });

        $(document).on('change', '#check-all-sincronizados', function() {
            $('.check-sincronizado').prop('checked', $(this).is(':checked'));
            actualizarBotonesSeleccion();
        });

        $(document).on('change', '.check-pendiente, .check-sincronizado', function() {
            actualizarBotonesSeleccion();
        });

        $('#btn-sincronizar-seleccionados').on('click', async function() {
            const ids = [];
            $('.check-pendiente:checked').each(function() { ids.push(parseInt($(this).val())); });
            
            if (ids.length === 0) return;

            const todos = await obtenerPendientes();
            const listaEnviar = todos.filter(r => ids.includes(r.id));
            
            await procesarColaDeEnvio(listaEnviar);
        });

        $('#btn-resync-seleccion').on('click', function() {
            const ids = [];
            $('.check-sincronizado:checked').each(function() { ids.push(parseInt($(this).val())); });
            
            if (ids.length === 0) return;
            
            moverAPendientesYEnviar(ids);
        });

        $('#btn-delete-pendientes-sel').on('click', function() {
            eliminarRegistrosSeleccionados('check-pendiente');
        });

        $('#btn-delete-sincronizados-sel').on('click', function() {
            eliminarRegistrosSeleccionados('check-sincronizado');
        });
        
        $(document).on('click', '.btn-delete-registro', function() {
            const id = parseInt($(this).data('id'));
            
            Swal.fire({
                title: '¿Eliminar registro?',
                text: "Esta acción borrará el reporte de este dispositivo permanentemente.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await borrarPendiente(id);
                    if ($('#modalSync').hasClass('show')) {
                        renderizarModalPendientes();
                    }
                    Swal.fire('Eliminado', 'El registro ha sido eliminado.', 'success');
                }
            });
        });

        $(document).on('click', '.list-group-item', function(e) {
            if ($(e.target).is('input[type="checkbox"]') || 
                $(e.target).closest('button').length > 0 || 
                $(e.target).closest('.badge').length > 0) {
                return;
            }

            const $checkbox = $(this).find('input[type="checkbox"]');
            
            if ($checkbox.length > 0) {
                $checkbox.prop('checked', !$checkbox.prop('checked'));
                $checkbox.trigger('change');
            }
        });
    }

    // =========================================================================
    // CONTROL DE VISIBILIDAD DE BOTONES FLOTANTES
    // =========================================================================

    $(document).on('show.bs.modal', '#modalSync, #modalPdfPreview, #photoPreviewModal', function () {
        $('#btn-sync-manager, #clear-session-button').hide();
    });

    $(document).on('hidden.bs.modal', '#modalSync, #modalPdfPreview, #photoPreviewModal', function () {
        setTimeout(function() {
            if ($('.modal.show').length > 0) {
                $('#btn-sync-manager, #clear-session-button').hide();
            } else {
                actualizarContadorPendientes();
                updateClearSessionButton();
            }
        }, 300);
    });

    function updateClearSessionButton() {
        const hasSession = $('#fecha').val() || $('#colaborador').val() || equipoSeleccionado;
        if (hasSession) {
            $('#clear-session-button').show();
        } else {
            $('#clear-session-button').hide();
        }
    }

    $(document).on('change input', '.auto-save', function() {
        setTimeout(updateClearSessionButton, 100);
    });

// Función para actualizar visibilidad según el estado del interruptor
function actualizarVisibilidadSegunRevision() {
    if (modoActual === 'salidas') {
        const sinRevision = $('#toggleSinRevision').is(':checked');
        
        if (sinRevision) {
            // Ocultar checklist y mostrar solo observaciones
            $('#checklist-section').hide();
            // Pero mantener el campo de observaciones disponible
            $('#checklistObservaciones').closest('.question-container').show();
        } else {
            // Mostrar checklist normal
            if (equipoSeleccionado) {
                $('#checklist-section').show();
            }
        }
    }
}

</script>
</body>
</html>
