<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pisos Brillantes</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--text-color);
            line-height: 1.6;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            text-align: center;
            padding: 18px 0;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: var(--shadow);
            position: relative;
        }

        .form-container {
            width: 90%;
            max-width: 1000px;
            margin: 25px auto;
            padding: 25px;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.8rem;
            position: relative;
            padding-bottom: 10px;
        }

        h1:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background-color: var(--secondary-color);
            border-radius: 2px;
        }

        .modo-buttons {
            display: flex;
            margin-bottom: 25px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .modo-button {
            flex: 1;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background-color: #f0f0f0;
            color: #555;
            border: none;
            outline: none;
            transition: var(--transition);
        }

        .modo-button.activo {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white;
        }

        .modo-button:hover:not(.activo) {
            background-color: #e0e0e0;
        }

        .question-container {
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .question-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .question-container input,
        .question-container select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            transition: var(--transition);
            background-color: white;
        }

        .question-container input:focus,
        .question-container select:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .question-container select:disabled, 
        .question-container input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .search-container {
            margin: 20px 0;
            position: relative;
        }

        #buscador {
            width: 100%;
            padding: 14px 20px;
            padding-left: 45px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            transition: var(--transition);
        }

        #buscador:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        .search-container:before {
            content: '\f002';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
            z-index: 2;
        }

        .category-separator {
            width: 100%;
            text-align: left;
            margin: 20px 0 10px 0;
            padding: 12px 20px;
            background: linear-gradient(to right, var(--primary-color), var(--dark-color));
            color: white;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .category-separator:hover {
            background: linear-gradient(to right, var(--dark-color), var(--primary-color));
        }

        .category-separator .toggle-icon {
            transition: transform 0.3s ease;
        }

        .category-separator.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .equipos-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .equipo {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            transition: var(--transition);
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 100%;
            cursor: pointer;
        }

        .equipo:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary-color);
        }

        .equipo img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 12px;
            pointer-events: none;
        }

        .equipo label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark-color);
            font-size: 15px;
        }

        .disponible {
            color: var(--success-color);
            font-weight: 600;
        }

        .no-disponible {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
            padding: 30px 20px;
            background: #f0f8ff;
            border: 2px dashed var(--secondary-color);
            border-radius: 12px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            box-sizing: border-box;
            color: var(--secondary-color);
            transition: var(--transition);
        }

        .file-upload:hover {
            background-color: #e6f3ff;
            border-color: var(--primary-color);
        }

        .file-upload i {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }

        .file-upload-text {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .file-upload-subtext {
            font-size: 0.85em;
            color: #666;
        }

        .file-upload input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            box-sizing: border-box;
            margin-top: 15px;
        }

        .image-preview-item {
            position: relative;
            width: 85px;
            height: 85px;
            overflow: hidden;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-icon {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            background: rgba(231, 76, 60, 0.8);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-preview-item:hover .delete-icon {
            opacity: 1;
        }

        .firma-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: #fff;
            min-height: 200px;
        }

        .firma-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .icon-button {
            background: #f8f9fa;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            color: #333;
            transition: var(--transition);
        }

        .icon-button.active {
            background: var(--secondary-color);
            color: #fff;
            border-color: var(--secondary-color);
        }

        .icon-button:hover {
            background: #e2e6ea;
        }

        #toggleEraser, #undo, #redo {
            display: none;
        }

        .button-container {
            display: flex;
            justify-content: center;
            margin-top: 25px;
            gap: 15px;
        }

        #solicitar {
            background: linear-gradient(to right, var(--success-color), #27ae60);
        }

        #devolver {
            background: linear-gradient(to right, var(--accent-color), #c0392b);
        }

        #solicitar, #devolver {
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 300px;
        }

        #solicitar:hover:not(:disabled),
        #devolver:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        #solicitar:disabled, 
        #devolver:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(52, 152, 219, 0.2);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loadingMessage {
            text-align: center;
            color: var(--dark-color);
        }

        #loadingMessage h4 {
            margin: 0 0 10px;
            font-size: 1.3rem;
        }

        #loadingMessage p {
            margin: 0;
            color: #7f8c8d;
        }

        .scroll-button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: fixed;
            right: 25px;
            z-index: 1000;
        }

        .scroll-button:hover {
            background-color: var(--primary-color);
            transform: scale(1.1);
        }

        #scroll-top-button {
            top: 25px;
        }

        #scroll-bottom-button {
            bottom: 25px;
        }

        /* Estilos para autocomplete */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        #colaborador {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            transition: var(--transition);
        }

        #colaborador:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }

        .autocomplete-suggestion {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: var(--transition);
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestion:hover,
        .autocomplete-suggestion.highlighted {
            background-color: #f0f8ff;
        }

        /* Estilos para checklist */
        .checklist-container {
            max-height: 50vh;
            overflow-y: auto;
            margin: 15px 0;
            text-align: left;
            padding-right: 12px;
        }

        .checklist-container::-webkit-scrollbar {
            width: 8px;
        }

        .checklist-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .checklist-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .checklist-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .checklist-item {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            gap: 10px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .checklist-item label {
            font-size: 13px;
            color: #333;
            flex-grow: 1;
            margin-right: 10px;
            line-height: 1.3;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .checklist-buttons {
            display: flex;
            gap: 4px;
            min-width: 115px;
        }

        .check-button, .x-button {
            width: 52px;
            height: 32px;
            border-radius: 3px;
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #ccc;
            transition: all 0.2s ease;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 2px;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.1;
            word-break: break-word;
            text-align: center;
        }

        .check-button {
            background-color: #f0f0f0;
            color: #333;
        }

        .check-button.selected {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .x-button {
            background-color: #f0f0f0;
            color: #333;
        }

        .x-button.selected {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        @media (max-width: 768px) {
            .form-container {
                width: 95%;
                padding: 15px;
                margin: 15px auto;
            }
            
            .equipos-container {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .equipo {
                padding: 12px;
            }
            
            .equipo img {
                width: 40px;
                height: 40px;
            }
            
            .category-separator {
                padding: 10px 15px;
                font-size: 1rem;
            }
            
            .scroll-button {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
                right: 15px;
            }
            
            #scroll-top-button {
                top: 15px;
            }
            
            #scroll-bottom-button {
                bottom: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .button-container {
                flex-direction: column;
                align-items: center; /* Añade esta línea */
            }
            
            #solicitar, #devolver {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .equipos-container {
                grid-template-columns: 1fr 1fr;
            }
            
            .question-container {
                padding: 15px;
            }
            
            #buscador {
                padding: 12px 15px;
                padding-left: 40px;
            }
            
            .modo-button {
                padding: 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">Pisos Brillantes</div>
    
    <div class="form-container">
        <h1>Gestión de Equipos</h1>

        <div class="modo-buttons">
            <button id="btnSalidas" class="modo-button activo" onclick="cambiarModo('salidas')">Salidas</button>
            <button id="btnEntradas" class="modo-button inactivo" onclick="cambiarModo('entradas')">Entradas</button>
        </div>

        <div class="question-container">
            <div>
                <label for="fecha"><strong>Fecha:</strong></label>
                <input type="date" id="fecha" name="fecha">
            </div>

            <label for="colaborador"><strong>Colaborador:</strong></label>
            <div class="autocomplete-container">
                <input type="text" id="colaborador" name="colaborador" placeholder="Escribe el nombre del colaborador" autocomplete="off">
                <div class="autocomplete-suggestions" id="colaborador-suggestions"></div>
            </div>

            <label for="area"><strong>Destino:</strong></label>
            <select id="area" name="area">
                <option value="">Seleccionar área</option>
            </select>
        </div>

        <label><strong id="titulo-equipos">Seleccione el equipo a prestar:</strong></label>

        <form id="formulario">
            <div class="search-container">
                <input type="text" id="buscador" placeholder="Buscar equipos...">
            </div>

            <div class="equipos-container" id="equipos"></div>
            <br>

            <div class="question-container" id="adjunto4Container">
                <label for="adjunto4"><strong>Evidencia (Fotos):</strong></label>
                <div class="file-upload" id="drag-area4">
                    <input type="file" id="adjunto4" name="adjunto4" accept="image/*" multiple capture="environment">
                    <i class="fas fa-camera"></i>
                    <div class="file-upload-text">Toca aquí para tomar fotos</div>
                    <div class="file-upload-subtext">Mantén presionado para modo cámara</div>
                </div>
                <div id="preview4" class="image-preview"></div>
            </div>

            <div class="question-container">
                <label for="firma">Firma del Responsable:</label>
                <div id="firmaContainer" class="firma-container">
                    <canvas id="firmaCanvas" width="400" height="200" style="border: 1px solid #ccc;"></canvas>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                    <button type="button" id="toggleEraser" title="Borrador" class="icon-button">
                        <i class="fas fa-eraser"></i>
                    </button>
                    <button type="button" id="undo" title="Deshacer" class="icon-button">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button type="button" id="redo" title="Rehacer" class="icon-button">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button type="button" id="clearSignature" title="Limpiar" class="icon-button">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>

            <div class="button-container">
                <button type="button" id="solicitar" disabled onclick="solicitarEquipo()">Solicitar Equipo</button>
                <button type="button" id="devolver" disabled onclick="devolverEquipo()" style="display: none;">Devolver Equipo</button>
            </div>
        </form>
    </div>

    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Por favor espera un momento...</h4>
            <p></p>
        </div>
    </div>

    <button class="scroll-button" id="scroll-top-button" onclick="scrollToTop()" title="Ir al inicio">&#9650;</button>
    <button class="scroll-button" id="scroll-bottom-button" onclick="scrollToBottom()" title="Ir al final">&#9660;</button>

    <script>
        // El código JavaScript se mantiene exactamente igual
        jQuery.fn.firstUntil = function(selector) {
            const result = $();
            this.each(function() {
                let next = $(this).next();
                while (next.length && !next.is(selector)) {
                    result.add(next);
                    next = next.next();
                }
            });
            return result;
        };

        let equipos = [];
        let colaboradores = [];
        let areas = ["Bodega"];
        let equipoSeleccionado = null;
        let categoriaSeleccionada = "";
        let modoActual = "salidas";
        let ultimaTransaccion = null;

        const checklistsPreOperativos = {
            "aspiradoras": [
                "¿La aspiradora está limpia por fuera?",
                "¿El cable de alimentación no tiene cortes y no presenta daños?",
                "¿El depósito de metal está vacío y limpio?",
                "¿El filtro de cartucho está presente, limpio y en buen estado?",
                "¿La bolsa o saco de filtro está presente, no está llena ni dañada?",
                "¿La bolsa de membrana está presente, en buen estado y bien colocada?",
                "¿El seguro de presión está en buen estado, y asegura que la tapa encaje correctamente con el cuerpo de la aspiradora?",
                "¿La manguera de aspiración está presente y no presenta daños?",
                "¿La manguera de aspiración está libre de basura y no está atascada?",
                "¿Los dos tubos de aspiración están presentes y no presentan daños?",
                "¿Los tubos de aspiración están libres de basura y no están atascados?",
                "¿La boquilla de aspiración está limpia y en buen estado?",
                "¿Las ruedas giran bien y el estribo de empuje está en buen estado?",
                "¿La aspiradora enciende y aspira con fuerza cuando la activas?"
            ],
            "pulidoras": [
                "La pulidora está limpia por fuera",
                "El cable de alimentación está en buen estado",
                "El disco de pulido está en buen estado",
                "El mecanismo de velocidad funciona correctamente",
                "El interruptor de encendido funciona",
                "La base gira libremente sin ruidos extraños",
                "El mango ajustable está firme",
                "Todos los accesorios están presentes"
            ],
            "hidrolavadoras": [
                "La hidrolavadora está limpia por fuera",
                "Nivel de combustible suficiente",
                "Manguera de alta presión en buen estado",
                "Boquilla de spray funciona correctamente",
                "Filtro de agua limpio y sin obstrucciones",
                "Conexiones de agua sin fugas",
                "Interruptor de encendido funciona",
                "Nivel de aceite del motor verificado"
            ]
        };

        const checklistsPostOperativos = {
            "aspiradoras": [
                "¿La aspiradora está limpia por fuera?",
                "¿El cable de alimentación no tiene cortes, no presenta daños, y está bien guardado?",
                "¿El depósito de metal esta vació y limpio?",
                "¿El filtro de cartucho se limpió (si es necesario) y se revisó su estado?",
                "¿La bolsa o saco de filtro se revisó y, si era necesario, se reemplazó?",
                "¿La bolsa de membrana está presente, y no presenta daños?",
                "¿El seguro de presión no presenta daños, y asegura que la tapa encaje correctamente con el cuerpo de la aspiradora?",
                "¿La manguera de aspiración está presente, libre de basura, sin daños y sin atascos?",
                "¿Los dos tubos de aspiración están presentes, libres de basura, sin daños y sin atascos?",
                "¿La boquilla de aspiración está limpia y en buen estado?",
                "¿Las ruedas giran bien y el estribo de empuje está en buen estado?"
            ],
            "pulidoras": [
                "La pulidora fue limpiada después de su uso",
                "El cable de alimentación está en buen estado",
                "El disco de pulido fue revisado y reemplazado si es necesario",
                "El mecanismo de velocidad funciona correctamente",
                "El interruptor de encendido funciona",
                "La base gira libremente sin ruidos extraños",
                "El mango ajustable está firme y en buen estado",
                "Todos los accesorios fueron devueltos"
            ],
            "hidrolavadoras": [
                "La hidrolavadora fue limpiada después de su uso",
                "Se verificó el nivel de combustible restante",
                "Manguera de alta presión en buen estado sin fugas",
                "Boquilla de spray funciona correctamente",
                "Filtro de agua limpio y sin obstrucciones",
                "Conexiones de agua fueron revisadas y ajustadas",
                "Interruptor de encendido funciona correctamente",
                "Nivel de aceite del motor verificado y completado"
            ]
        };

        document.addEventListener('DOMContentLoaded', function() {
            var today = new Date();
            var yyyy = today.getFullYear();
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var dd = String(today.getDate()).padStart(2, '0');
            document.getElementById("fecha").value = yyyy + '-' + mm + '-' + dd;

            cargarTodosLosDatos();
            configurarEventos();

            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });

            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
            });

            document.querySelectorAll('img').forEach(img => {
                img.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                });
            });
        });

        function cambiarModo(modo) {
            modoActual = modo;
            equipoSeleccionado = null;
            $('.equipo').css('border-color', '#ddd').css('background-color', '#f9f9f9');
            
            // Limpiar campos
            $('#buscador').val('');
            
            if (modo === 'salidas') {
                $('#btnSalidas').removeClass('inactivo').addClass('activo');
                $('#btnEntradas').removeClass('activo').addClass('inactivo');
                $('#solicitar').show();
                $('#devolver').hide();
                $('#titulo-equipos').text('Seleccione el equipo a prestar:');
                
                // Habilitar campos en modo salidas
                $('#fecha').prop('disabled', false);
                $('#colaborador').prop('disabled', false).val('');
                $('#area').prop('disabled', false).val('');
                $('#buscador').prop('disabled', false);
                
            } else {
                $('#btnSalidas').removeClass('activo').addClass('inactivo');
                $('#btnEntradas').removeClass('inactivo').addClass('activo');
                $('#solicitar').hide();
                $('#devolver').show();
                $('#titulo-equipos').text('Seleccione el equipo a devolver:');
                
                // Deshabilitar campos en modo entradas hasta que se seleccione un equipo
                $('#fecha').prop('disabled', true);
                $('#colaborador').prop('disabled', true).val('');
                $('#area').prop('disabled', true).val('Bodega');
                $('#buscador').prop('disabled', false);
            }

            mostrarEquiposEnUI();
            verificarFormulario();
        }

        function cargarTodosLosDatos() {
            $('#overlay').show();
            const scriptURL = "https://script.google.com/macros/s/AKfycbxbiQDZcTJA2I9XknV-VF-3E9NdK_b8xq-8fc4LkZ4jh5n4jkJQz0_UlB_zbKpHSJGl/exec";

            $.get(scriptURL, function(data) {
                $('#overlay').hide();
                if (data.error) {
                    Swal.fire('Error', 'No se pudieron cargar los datos: ' + data.mensaje, 'error');
                    return;
                }
                equipos = data.equipos;
                colaboradores = data.colaboradores;
                data.areas.forEach(area => {
                    if (!areas.includes(area)) {
                        areas.push(area);
                    }
                });

                mostrarEquiposEnUI();
                llenarSelects();
            }).fail(function(jqXHR, textStatus, errorThrown) {
                $('#overlay').hide();
                Swal.fire('Error', 'No se pudo conectar al servidor o hubo un error de red. ' + textStatus + ': ' + errorThrown, 'error');
                console.error("Error en la solicitud AJAX:", jqXHR, textStatus, errorThrown);
            });
        }

        function llenarSelects() {
            // Ya no usamos el select de colaborador, pero mantenemos la variable allColaboradores
            allColaboradores = colaboradores;
            
            const areaSelect = $('#area');
            areaSelect.find('option:not(:first)').remove();
            areas.forEach(area => {
                areaSelect.append(`<option value="${area}">${area}</option>`);
            });
        }

        function mostrarEquiposEnUI() {
            const equiposContainer = $('#equipos');
            equiposContainer.empty();

            equipos.forEach((equipo, index) => {
                if (equipo.nombre.startsWith("-")) {
                    let categoryName = equipo.nombre.substring(1).trim();
                    equiposContainer.append(`
                        <div class="category-separator">
                            <strong>${categoryName}</strong> <span class="toggle-icon">&#9660;</span>
                        </div>
                    `);
                    return;
                }

                if (modoActual === "salidas" && !equipo.disponible) {
                    return;
                }

                if (modoActual === "entradas" && equipo.disponible) {
                    return;
                }

                let estadoClass = equipo.disponible ? 'disponible' : 'no-disponible';
                let estadoText = equipo.disponible ? 'Disponible' : `Ocupada por: ${equipo.asignadoA}`;

                let equipoHtml = `
                    <div class="equipo" id="equipo-${index}" onclick="seleccionarEquipo(${index})">
                        <img src="${equipo.imagen || ''}" alt="${equipo.nombre}" onerror="this.style.display='none'">
                        <label>${equipo.nombre}</label>
                        <span class="${estadoClass}">${estadoText}</span>
                    </div>
                `;

                equiposContainer.append(equipoHtml);

                if (!equipo.disponible && modoActual === "salidas") {
                    $(`#equipo-${index}`).css('opacity', '0.6').css('cursor', 'not-allowed');
                }
            });

            $('.category-separator').on('click', function() {
                const $separator = $(this);
                const $toggleIcon = $separator.find('.toggle-icon');
                const $equiposToToggle = $separator.nextUntil('.category-separator');
                $equiposToToggle.toggle();
                $separator.toggleClass('collapsed');
                if ($separator.hasClass('collapsed')) {
                    $toggleIcon.html('&#9658;');
                } else {
                    $toggleIcon.html('&#9660;');
                }
            });
        }

        function configurarEventos() {
            $('#buscador').on('input', filtrarEquipos);
            $("#fecha, #colaborador, #area").on("change", verificarFormulario);
        }

        function filtrarEquipos() {
            const textoBusqueda = $('#buscador').val().toLowerCase();
            if (textoBusqueda === '') {
                $('.equipo').show();
                $('.category-separator').show().removeClass('collapsed').find('.toggle-icon').html('&#9660;');
                return;
            }

            $('.equipo').hide();
            $('.category-separator').hide();

            $('.equipo').each(function() {
                const nombreEquipo = $(this).find('label').text().toLowerCase();
                if (nombreEquipo.includes(textoBusqueda)) {
                    $(this).show();
                    $(this).prevAll('.category-separator:first').show().removeClass('collapsed').find('.toggle-icon').html('&#9660;');
                }
            });
        }

        function determinarCategoria(equipoIndex) {
            let categoria = "";
            for (let i = equipoIndex; i >= 0; i--) {
                if (equipos[i].nombre.startsWith("-")) {
                    categoria = equipos[i].nombre.substring(1).trim().toLowerCase();
                    break;
                }
            }
            return categoria;
        }

        function seleccionarEquipo(index) {
            const equipo = equipos[index];
            if (!equipo.disponible && modoActual === "salidas") {
                return;
            }

            $('.equipo').css('border-color', '#ddd').css('background-color', '#f9f9f9');
            $(`#equipo-${index}`).css('border-color', '#007BFF').css('background-color', '#e6f0ff');
            equipoSeleccionado = equipo;
            categoriaSeleccionada = determinarCategoria(index);

            if (modoActual === "entradas") {
                $('#buscador').prop('disabled', true);
                $('#fecha').prop('disabled', true); // Asegurar que la fecha esté deshabilitada
                $('#colaborador').prop('disabled', true);
                $('#area').prop('disabled', true).val("Bodega");
                if (equipoSeleccionado.asignadoA) {
                    $('#colaborador').val(equipoSeleccionado.asignadoA);
                }
            }

            verificarFormulario();
        }

        function isCanvasBlank(canvas) {
            const context = canvas.getContext('2d', {
                willReadFrequently: true
            });
            const pixelBuffer = new Uint32Array(
                context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            return !pixelBuffer.some(color => color !== 0);
        }

        function verificarFormulario() {
            let fecha = $("#fecha").val();
            let colaborador = $("#colaborador").val();
            let area = $("#area").val();
            const hayFotos = selectedFiles.preview4.length > 0;
            const hayFirma = !isCanvasBlank(document.getElementById('firmaCanvas'));
            
            // Validar que el colaborador ingresado existe en la lista (solo en modo salidas)
            let colaboradorValido = true;
            if (modoActual === "salidas") {
                colaboradorValido = allColaboradores.includes(colaborador);
            } else {
                // En modo entradas, el colaborador viene del equipo seleccionado
                colaboradorValido = colaborador !== '';
            }
            
            if (fecha && colaborador && area && equipoSeleccionado && hayFotos && hayFirma && colaboradorValido) {
                if (modoActual === "salidas") {
                    $("#solicitar").prop("disabled", false);
                } else {
                    $("#devolver").prop("disabled", false);
                }
            } else {
                $("#solicitar").prop("disabled", true);
                $("#devolver").prop("disabled", true);
            }
            
            // Cambiar el color del borde según si es válido o no (solo en modo salidas)
            if (modoActual === "salidas") {
                if (colaborador && !colaboradorValido) {
                    $("#colaborador").css("border-color", "red");
                } else {
                    $("#colaborador").css("border-color", colaborador ? "#28a745" : "#ddd");
                }
            }
        }

        function seleccionarBoton(event) {
            const button = $(event.target);
            const parent = button.closest('.checklist-item');
            parent.find('.check-button, .x-button').removeClass('selected');
            button.addClass('selected');
            const todosSeleccionados = verificarChecklistCompleto();
            if (Swal.getConfirmButton()) {
                Swal.getConfirmButton().disabled = !todosSeleccionados;
            }
        }

        function generarChecklistHTML(checklist, tipo) {
            let checklistHTML = `
                <div class="checklist-container">
            `;

            checklist.forEach((item, i) => {
                checklistHTML += `
                    <div class="checklist-item" id="item-${i}">
                        <label>${item}</label>
                        <div class="checklist-buttons">
                            <button type="button" class="check-button" data-value="✔" onclick="seleccionarBoton(event)">Cumple</button>
                            <button type="button" class="x-button" data-value="X" onclick="seleccionarBoton(event)">No<br>Cumple</button>
                        </div>
                    </div>
                `;
            });

            // Agregar campo de observaciones
            checklistHTML += `
                </div>
                <div style="margin-top: 20px;">
                    <label for="observaciones" style="font-weight: bold; display: block; margin-bottom: 8px;">Observaciones:</label>
                    <textarea id="observaciones" rows="3" placeholder="Escribe aquí cualquier observación adicional..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif; resize: vertical;"></textarea>
                </div>
            `;

            return checklistHTML;
        }

        function verificarChecklistCompleto() {
            const items = $('.checklist-item');
            let todosSeleccionados = true;
            items.each(function() {
                const isSelected = $(this).find('.check-button.selected, .x-button.selected').length > 0;
                if (!isSelected) {
                    todosSeleccionados = false;
                    return false;
                }
            });
            return todosSeleccionados;
        }

function solicitarEquipo() {
    let fecha = $('#fecha').val();
    let colaborador = $('#colaborador').val();
    let area = $('#area').val();
    const checklist = checklistsPreOperativos[categoriaSeleccionada] || checklistsPreOperativos["aspiradoras"];
    
    Swal.fire({
        title: 'Checklist Preoperativo',
        html: generarChecklistHTML(checklist, 'pre'),
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Confirmar y Solicitar',
        cancelButtonText: 'Cancelar',
        width: '650px',
        padding: '20px',
        didOpen: () => {
            const todosSeleccionados = verificarChecklistCompleto();
            Swal.getConfirmButton().disabled = !todosSeleccionados;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const checklistRespuestas = [];
            $('.checklist-item').each(function() {
                const selectedButton = $(this).find('.selected');
                checklistRespuestas.push(selectedButton.data('value'));
            });
            
            // Obtener observaciones
            const observaciones = document.getElementById('observaciones').value;

            ultimaTransaccion = {
                fecha: fecha,
                colaborador: colaborador,
                area: area,
                equipo: equipoSeleccionado.nombre,
                categoria: categoriaSeleccionada,
                tipo: 'salidas',
                checklist: checklist.map((item, i) => ({
                    item: item,
                    respuesta: checklistRespuestas[i]
                })),
                observaciones: observaciones
            };
            
            Swal.fire({
                title: 'Confirmar Préstamo',
                html: `
                    <div style="text-align: left;">
                        <p><strong>Fecha:</strong> ${fecha}</p>
                        <p><strong>Colaborador:</strong> ${colaborador}</p>
                        <p><strong>Área:</strong> ${area}</p>
                        <p><strong>Equipo:</strong> ${equipoSeleccionado.nombre}</p>
                        ${observaciones ? `<p><strong>Observaciones:</strong> ${observaciones}</p>` : ''}
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, enviar',
                cancelButtonText: 'No, revisar',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                width: '500px'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#overlay').show();
                    const scriptURL = "https://script.google.com/macros/s/AKfycbweOAqrT8cQuoW9xPbWBwOyLxbORFTT6HaStsNUz7i9ySkTRlElJIirZwcoGC-l8Sb-/exec";
                    $.ajax({
                        url: scriptURL,
                        type: "POST",
                        data: {
                            fecha: fecha,
                            colaborador: colaborador,
                            area: area,
                            equipo: equipoSeleccionado.nombre,
                            categoria: categoriaSeleccionada,
                            retornable: equipoSeleccionado.devolucion,
                            checklist: JSON.stringify(checklistRespuestas),
                            observaciones: observaciones
                        },
                        success: function(response) {
                            $('#overlay').hide();
                            Swal.fire({
                                title: '¡Éxito!',
                                html: `
                                    <div style="text-align: center;">
                                        <p style="font-size: 1.1em; margin-bottom: 15px;">Préstamo registrado correctamente</p>
                                        <div style="color: #28a745; font-size: 2em; margin-bottom: 15px;">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <p style="font-size: 0.9em; color: #666;">Generando PDF, por favor espera...</p>
                                    </div>
                                `,
                                icon: 'success',
                                showConfirmButton: false,
                                showCancelButton: false,
                                allowOutsideClick: false,
                                didOpen: () => {
                                    // Llamar directamente a generarPDF sin botón intermedio
                                    generarPDF();
                                }
                            }).then((result) => {
                                // Recargar si se cierra con la X (aunque en este caso no debería mostrarse la X)
                                if (result.dismiss === Swal.DismissReason.close) {
                                    location.reload();
                                }
                            });
                        },
                        error: function(xhr, status, error) {
                            $('#overlay').hide();
                            Swal.fire('Error', 'Hubo un problema al registrar el préstamo. Por favor inténtalo nuevamente.', 'error');
                        }
                    });
                }
            });
        }
    });
}



function devolverEquipo() {
    let fecha = $('#fecha').val();
    let colaborador = $('#colaborador').val();
    let area = $('#area').val();
    const checklist = checklistsPostOperativos[categoriaSeleccionada] || checklistsPostOperativos["aspiradoras"];

    Swal.fire({
        title: 'Checklist Postoperativo',
        html: generarChecklistHTML(checklist, 'post'),
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Confirmar Devolución',
        cancelButtonText: 'Cancelar',
        width: '650px',
        padding: '20px',
        didOpen: () => {
            const todosSeleccionados = verificarChecklistCompleto();
            Swal.getConfirmButton().disabled = !todosSeleccionados;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const checklistRespuestas = [];
            $('.checklist-item').each(function() {
                const selectedButton = $(this).find('.selected');
                checklistRespuestas.push(selectedButton.data('value'));
            });
            
            // Obtener observaciones
            const observaciones = document.getElementById('observaciones').value;

            ultimaTransaccion = {
                fecha: fecha,
                colaborador: colaborador,
                area: area,
                equipo: equipoSeleccionado.nombre,
                categoria: categoriaSeleccionada,
                tipo: 'entradas',
                checklist: checklist.map((item, i) => ({
                    item: item,
                    respuesta: checklistRespuestas[i]
                })),
                observaciones: observaciones
            };

            Swal.fire({
                title: 'Confirmar Devolución',
                html: `
                    <div style="text-align: left;">
                        <p><strong>Fecha:</strong> ${fecha}</p>
                        <p><strong>Colaborador:</strong> ${colaborador}</p>
                        <p><strong>Área:</strong> ${area}</p>
                        <p><strong>Equipo:</strong> ${equipoSeleccionado.nombre}</p>
                        ${observaciones ? `<p><strong>Observaciones:</strong> ${observaciones}</p>` : ''}
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, devolver',
                cancelButtonText: 'No, revisar',
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                width: '500px'
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#overlay').show();
                    const scriptURL = "https://script.google.com/macros/s/AKfycbw4OfK5DQQqbiro8olfyb8MvjQnOHGZBoELkTBJnOYS2GMpkr8yFrJJASiAiAxxePGfzA/exec";
                    $.ajax({
                        url: scriptURL,
                        type: "POST",
                        data: {
                            fecha: fecha,
                            colaborador: colaborador,
                            area: area,
                            equipo: equipoSeleccionado.nombre,
                            categoria: categoriaSeleccionada,
                            checklist: JSON.stringify(checklistRespuestas),
                            tipo: 'devolucion',
                            observaciones: observaciones
                        },
                        success: function(response) {
                            $('#overlay').hide();
                            Swal.fire({
                                title: '¡Éxito!',
                                html: `
                                    <div style="text-align: center;">
                                        <p style="font-size: 1.1em; margin-bottom: 15px;">Devolución registrada correctamente</p>
                                        <div style="color: #28a745; font-size: 2em; margin-bottom: 15px;">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                        <p style="font-size: 0.9em; color: #666;">Generando PDF, por favor espera...</p>
                                    </div>
                                `,
                                icon: 'success',
                                showConfirmButton: false,
                                showCancelButton: false,
                                allowOutsideClick: false,
                                didOpen: () => {
                                    // Llamar directamente a generarPDF sin botón intermedio
                                    generarPDF();
                                }
                            }).then((result) => {
                                // Recargar si se cierra con la X (aunque en este caso no debería mostrarse la X)
                                if (result.dismiss === Swal.DismissReason.close) {
                                    location.reload();
                                }
                            });
                        },
                        error: function(xhr, status, error) {
                            $('#overlay').hide();
                            Swal.fire('Error', 'Hubo un problema al registrar la devolución. Por favor inténtalo nuevamente.', 'error');
                        }
                    });
                }
            });
        }
    });
}


        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function scrollToBottom() {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        // Funciones agregadas para el manejo de imágenes y PDF
        const selectedFiles = {
            preview3: [],
            preview4: []
        };

        function handleFileInput(event, previewId) {
            const files = event.target.files;
            const previewContainer = document.getElementById(previewId);

            Array.from(files).forEach((file) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.classList.add('image-preview-item');
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="delete-icon" onclick="deleteImage('${previewId}', ${selectedFiles[previewId].length})">×</div>
                    `;
                    previewContainer.appendChild(div);

                    selectedFiles[previewId].push(file);
                    verificarFormulario();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = "";
        }

        function deleteImage(previewId, index) {
            const previewContainer = document.getElementById(previewId);

            if (previewContainer.children[index]) {
                previewContainer.removeChild(previewContainer.children[index]);
                selectedFiles[previewId].splice(index, 1);

                Array.from(previewContainer.children).forEach((child, newIndex) => {
                    const deleteIcon = child.querySelector('.delete-icon');
                    if (deleteIcon) {
                        deleteIcon.setAttribute('onclick', `deleteImage('${previewId}', ${newIndex})`);
                    }
                });
                verificarFormulario();
            }
        }

        document.getElementById('adjunto4').addEventListener('change', (e) => handleFileInput(e, 'preview4'));
        document.getElementById('drag-area4').addEventListener('dragover', (event) => {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('drag-area4').style.backgroundColor = "#e0f7ff";
        });
        document.getElementById('drag-area4').addEventListener('dragleave', (event) => {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('drag-area4').style.backgroundColor = "#f0f8ff";
        });
        document.getElementById('drag-area4').addEventListener('drop', (event) => {
            event.preventDefault();
            event.stopPropagation();
            const files = event.dataTransfer.files;
            handleFileInput({
                target: {
                    files
                }
            }, 'preview4');
        });

async function compressImage(file, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const maxWidth = 600;
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(dataUrl);
            };
            img.src = event.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

async function addPhotoSection(doc, title, files, startY) {
    if (files.length === 0) return startY;
    let currentY = startY;
    const pageHeight = doc.internal.pageSize.getHeight();
    const spaceNeeded = 10 + 10 + 40;
    if (currentY + spaceNeeded > pageHeight - 10) {
        doc.addPage();
        currentY = 15;
    }
    doc.setFontSize(14);
    doc.setFont("times", "bold");
    doc.text(title, 10, currentY);
    currentY += 10;
    const imgWidth = 60;
    const imgHeight = 40;
    const marginX = 15;
    const spacingX = 65;
    const spacingY = 45;
    let currentX = marginX;
    let imagesInRow = 0;
    for (const file of files) {
        const imgData = await compressImage(file, 0.5);
        if (imagesInRow === 3) {
            imagesInRow = 0;
            currentX = marginX;
            currentY += spacingY;
        }
        if (currentY + imgHeight > pageHeight - 10) {
            doc.addPage();
            currentY = 15;
            currentX = marginX;
            imagesInRow = 0;
        }
        doc.addImage(imgData, 'JPEG', currentX, currentY, imgWidth, imgHeight);
        currentX += spacingX;
        imagesInRow++;
    }
    return currentY + spacingY;
}


async function generarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'portrait',
        format: 'letter',
        unit: 'mm'
    });
    
    doc.setFont("times", "normal");
    const tipoMovimiento = ultimaTransaccion.tipo === 'salidas' ? 'Acta de Compromiso' : 'Acta de Recepción';
    const tituloChecklist = ultimaTransaccion.tipo === 'salidas' ? 'Checklist Preoperativo' : 'Checklist Postoperativo';
    const now = new Date();
    const horaGeneracion = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
    const [yyyy, mm, dd] = ultimaTransaccion.fecha.split('-');
    const meses = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];
    const mesTexto = meses[parseInt(mm) - 1];
    let y = 15;
    const margin = 15;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const textWidth = pageWidth - (2 * margin);
    
    // Encabezado
    doc.setFontSize(16);
    doc.setTextColor(34, 49, 63);
    doc.setFont("times", "bold");
    doc.text(tipoMovimiento, pageWidth / 2, y, { align: 'center' });
    y += 8;
    doc.setDrawColor(200, 200, 200);
    doc.line(margin, y, pageWidth - margin, y);
    y += 10;
    doc.setFontSize(12);
    doc.setTextColor(50, 50, 50);
    doc.setFont("times", "normal");

    // Contenido del acta
    if (ultimaTransaccion.tipo === 'salidas') {
        const textoCompleto = `Yo ${ultimaTransaccion.colaborador} mediante la presente Acta de Compromiso hago constar que en esta fecha estoy recibiendo el equipo ${ultimaTransaccion.equipo}, el cual será utilizado para el desempeño de mis funciones.`;
        const lineas = doc.splitTextToSize(textoCompleto, textWidth);
        doc.text(lineas, margin, y);
        y += (lineas.length * 6) + 4;
        
        doc.setFont("times", "bold");
        const textoCompromiso = "Habiendo recibido me comprometo a lo siguiente:";
        doc.text(textoCompromiso, margin, y);
        y += 7;
        
        doc.setFont("times", "normal");
        const compromisos = [
            "- Cuidar y hacer buen uso del mismo, durante el tiempo que este bajo mi cargo en beneficio de las actividades del negocio.",
            "- En caso de accidente, daño por mal uso y cualquier que bajo mi uso dañe el equipo se procederá a realizar la deducción del valor completo proporcionando uno nuevo.",
            "- Me comprometo a cuidar todos y cada uno de los componentes del equipo."
        ];
        
        compromisos.forEach(compromiso => {
            const splitText = doc.splitTextToSize(compromiso, textWidth - 5);
            doc.text(splitText, margin + 5, y);
            y += (splitText.length * 5) + 3;
        });
        
        y += 5;
        const textoFinal = `Firmo la presente en la ciudad de Tegucigalpa a los ${dd} días del mes de ${mesTexto} del ${yyyy}.`;
        const lineasFinal = doc.splitTextToSize(textoFinal, textWidth);
        doc.text(lineasFinal, margin, y);
        y += (lineasFinal.length * 6) + 10;
    } else if (ultimaTransaccion.tipo === 'entradas') {
        const textoCompleto = `Yo ${ultimaTransaccion.colaborador} mediante la presente Acta de Recepción hago constar que en esta fecha estoy entregando el equipo ${ultimaTransaccion.equipo}, el cual fue utilizado para el desempeño de mis funciones y ahora estoy retornando.`;
        const lineas = doc.splitTextToSize(textoCompleto, textWidth);
        doc.text(lineas, margin, y);
        y += (lineas.length * 6) + 4;
        
        doc.setFont("times", "bold");
        const textoDeclaracion = "Al entregarla declaro lo siguiente:";
        doc.text(textoDeclaracion, margin, y);
        y += 7;
        
        doc.setFont("times", "normal");
        const declaraciones = [
            "- El equipo se encuentra en las mismas condiciones en las que me fue entregado.",
            "- Fui responsable y cuidadoso en el uso del equipo y todos sus componentes.",
            "- Cualquier daño, accidente o mal uso fue reportado en tiempo y forma."
        ];
        
        declaraciones.forEach(declaracion => {
            const splitText = doc.splitTextToSize(declaracion, textWidth - 5);
            doc.text(splitText, margin + 5, y);
            y += (splitText.length * 5) + 3;
        });
        
        y += 5;
        const textoFinal = `Firmo la presente en la ciudad de Tegucigalpa a los ${dd} días del mes de ${mesTexto} del ${yyyy}.`;
        const lineasFinal = doc.splitTextToSize(textoFinal, textWidth);
        doc.text(lineasFinal, margin, y);
        y += (lineasFinal.length * 6) + 10;
    }

    // Firma
    const canvasFirma = document.getElementById('firmaCanvas');
    const firmaDataUrl = canvasFirma.toDataURL('image/png');
    const firmaWidth = 60;
    const firmaHeight = 25;
    const firmaX = (pageWidth - firmaWidth) / 2;
    doc.addImage(firmaDataUrl, 'PNG', firmaX, y, firmaWidth, firmaHeight);
    y += firmaHeight + 2;
    doc.line(firmaX, y, firmaX + firmaWidth, y);
    y += 4;
    doc.setFontSize(12);
    doc.setTextColor(80, 80, 80);
    doc.setFont("times", "bold");
    doc.text(ultimaTransaccion.colaborador, pageWidth / 2, y, { align: 'center' });
    y += 10;
    doc.line(margin, y, pageWidth - margin, y);
    y += 8;

    // Para checklists largos (más de 8 ítems), comenzar en nueva página
    if (ultimaTransaccion.checklist.length > 8) {
        doc.addPage();
        y = 15;
    }

    // Checklist
    doc.setFontSize(14);
    doc.setTextColor(34, 49, 63);
    doc.setFont("times", "bold");
    doc.text(tituloChecklist, pageWidth / 2, y, { align: 'center' });
    y += 8;
    
    // Cambiar los encabezados de la tabla
    const tableColumn = ["Punto de Verificación", "Cumple", "No Cumple"];
    const tableRows = ultimaTransaccion.checklist.map(item => {
        const cumple = item.respuesta === "✔" ? "X" : "";
        const noCumple = item.respuesta === "X" ? "X" : "";
        return [item.item, cumple, noCumple];
    });
    
    // Configuración de la tabla para checklists largos
    let fontSize = 9;
    let cellPadding = 2;
    let rowHeight = 5;
    
    // Ajustar tamaño de fuente para checklists largos
    if (ultimaTransaccion.checklist.length > 10) {
        fontSize = 8;
        cellPadding = 1.5;
        rowHeight = 4;
    }
    
    // Calcular el ancho de las columnas para centrar la tabla
    const anchoDisponible = pageWidth - (2 * margin);
    const col1Width = anchoDisponible * 0.75; // 75% para la primera columna
    const col2Width = (anchoDisponible - col1Width) / 2; // 12.5% para cada columna de check
    const col3Width = col2Width;
    
    // Configuración de autoTable para manejar múltiples páginas
    doc.autoTable({
        startY: y,
        head: [tableColumn],
        body: tableRows,
        theme: 'grid',
        tableWidth: anchoDisponible,
        margin: { 
            left: margin, 
            right: margin,
            top: y
        },
        headStyles: {
            fillColor: [0, 123, 255],
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: fontSize,
            font: "times",
            cellPadding: cellPadding,
            minCellHeight: rowHeight,
            halign: 'center'
        },
        styles: {
            fontSize: fontSize,
            cellPadding: cellPadding,
            textColor: [50, 50, 50],
            lineColor: [200, 200, 200],
            lineWidth: 0.1,
            font: "times",
            minCellHeight: rowHeight
        },
        columnStyles: {
            0: {
                cellWidth: col1Width,
                fontStyle: 'bold',
                halign: 'left',
                cellPadding: {left: 3, right: 3, top: cellPadding, bottom: cellPadding}
            },
            1: {
                cellWidth: col2Width,
                halign: 'center',
                cellPadding: {left: 1, right: 1, top: cellPadding, bottom: cellPadding}
            },
            2: {
                cellWidth: col3Width,
                halign: 'center',
                cellPadding: {left: 1, right: 1, top: cellPadding, bottom: cellPadding}
            }
        },
        pageBreak: 'auto', // Cambiado a 'auto' para permitir saltos de página automáticos
        showHead: 'everyPage', // Mostrar encabezados en cada página
        tableLineWidth: 0.1,
        tableLineColor: [200, 200, 200]
    });

    // Añadir observaciones si existen
    let currentY = doc.autoTable.previous.finalY + 10;
    
    if (ultimaTransaccion.observaciones && ultimaTransaccion.observaciones.trim() !== '') {
        // Si no hay espacio suficiente en la página actual, crear nueva página
        if (currentY + 30 > pageHeight) {
            doc.addPage();
            currentY = 15;
        }
        
        doc.setFontSize(12);
        doc.setTextColor(34, 49, 63);
        doc.setFont("times", "bold");
        doc.text("Observaciones:", margin, currentY);
        currentY += 5;
        
        doc.setFontSize(10);
        doc.setTextColor(50, 50, 50);
        doc.setFont("times", "normal");
        
        const observacionesLines = doc.splitTextToSize(ultimaTransaccion.observaciones, textWidth);
        doc.text(observacionesLines, margin, currentY);
        currentY += (observacionesLines.length * 4) + 10;
    }

    // Añadir fotos - solo si hay espacio disponible
    let photosSectionY = currentY;
    if (selectedFiles.preview4.length > 0) {
        // Verificar si hay espacio para al menos una fila de fotos
        if (photosSectionY + 60 > pageHeight) {
            doc.addPage();
            photosSectionY = 15;
        }
        photosSectionY = await addPhotoSection(doc, "Evidencia:", selectedFiles.preview4, photosSectionY);
    }

    const tipoMovimientoNombre = ultimaTransaccion.tipo === 'salidas' ? 'Salida' : 'Entrada';
    const pdfName = `${dd}-${mm}-${yyyy} - ${tipoMovimientoNombre} - ${ultimaTransaccion.equipo} - ${ultimaTransaccion.colaborador}.pdf`;
    const pdfBlob = doc.output('blob');
    const pdfFile = new File([pdfBlob], pdfName, { type: 'application/pdf' });
    
    // Cerrar el SweetAlert actual y mostrar directamente las opciones de compartir/descargar
    Swal.close();
    
    // Mostrar SweetAlert con opciones de compartir y descargar
    Swal.fire({
        title: '¡Éxito!',
        html: `
            <div style="text-align: center;">
                <p style="font-size: 1.1em; margin-bottom: 15px;">${ultimaTransaccion.tipo === 'salidas' ? 'Préstamo' : 'Devolución'} registrada correctamente</p>
                <div style="color: #28a745; font-size: 2em; margin-bottom: 15px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">¿Qué deseas hacer con el PDF?</p>
                <div style="display: flex; justify-content: center; gap: 10px;">
                    <button id="sharePdfBtn" class="swal2-confirm swal2-styled" style="background-color: #007bff;">
                        <i class="fas fa-share-alt"></i> Compartir
                    </button>
                    <button id="downloadPdfBtn" class="swal2-cancel swal2-styled" style="background-color: #6c757d;">
                        <i class="fas fa-download"></i> Descargar
                    </button>
                </div>
            </div>
        `,
        icon: 'success',
        showConfirmButton: false,
        showCloseButton: true,
        allowOutsideClick: false,
        didOpen: () => {
            // Asignar los event listeners directamente a los botones
            document.getElementById('sharePdfBtn').addEventListener('click', async function() {
                try {
                    if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                        await navigator.share({
                            files: [pdfFile],
                            title: pdfName,
                            text: `Comparto el documento de ${tipoMovimientoNombre} para el equipo ${ultimaTransaccion.equipo}.`
                        });
                    } else {
                        // Fallback: descargar el PDF si no se puede compartir
                        doc.save(pdfName);
                    }
                } catch (error) {
                    console.error('Error al compartir el archivo:', error);
                    if (error.name !== 'AbortError') {
                        // Fallback: descargar el PDF si hay error
                        doc.save(pdfName);
                    }
                }
            });
            
            document.getElementById('downloadPdfBtn').addEventListener('click', function() {
                doc.save(pdfName);
            });
        }
    }).then((result) => {
        // Este código se ejecuta cuando se cierra el SweetAlert
        if (result.dismiss === Swal.DismissReason.close) {
            // Recargar la página cuando se hace clic en la X
            location.reload();
        }
    });
}





        let isDrawing = false;
        let isErasing = false;
        let lastX = 0;
        let lastY = 0;
        const canvas = document.getElementById("firmaCanvas");
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        const undoStack = [];
        const redoStack = [];

        function saveToUndoStack() {
            undoStack.push(canvas.toDataURL());
            redoStack.length = 0;
        }

        function undo() {
            if (undoStack.length > 0) {
                saveToRedoStack();
                const lastState = undoStack.pop();
                const img = new Image();
                img.src = lastState;
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                const lastState = redoStack.pop();
                undoStack.push(canvas.toDataURL());
                const img = new Image();
                img.src = lastState;
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function saveToRedoStack() {
            redoStack.push(canvas.toDataURL());
        }

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            if (e.touches) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY
                };
            }
            return {
                x: (e.offsetX) * scaleX,
                y: (e.offsetY) * scaleY
            };
        }

        document.getElementById("toggleEraser").addEventListener("click", () => {
            isErasing = !isErasing;
            document.getElementById("toggleEraser").classList.toggle("active");
        });

        canvas.addEventListener("mousemove", (e) => {
            if (!isDrawing) return;
            const {
                x,
                y
            } = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = isErasing ? "#FFF" : "#000";
            ctx.lineWidth = isErasing ? 10 : 4;
            ctx.stroke();
            lastX = x;
            lastY = y;
        });

        canvas.addEventListener("mousedown", (e) => {
            saveToUndoStack();
            isDrawing = true;
            const {
                x,
                y
            } = getCoordinates(e);
            lastX = x;
            lastY = y;
        });

        canvas.addEventListener("mouseup", () => {
            isDrawing = false;
            verificarFormulario(); // Nuevo: verifica el formulario al terminar de dibujar
        });
        canvas.addEventListener("mouseout", () => (isDrawing = false));
        document.getElementById("undo").addEventListener("click", undo);
        document.getElementById("redo").addEventListener("click", redo);
        document.getElementById("clearSignature").addEventListener("click", () => {
            localStorage.removeItem('canvasState');
            saveToUndoStack();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            verificarFormulario(); // Nuevo: verifica el formulario al limpiar
        });

        canvas.addEventListener("touchstart", (e) => {
            e.preventDefault();
            saveToUndoStack();
            isDrawing = true;
            const {
                x,
                y
            } = getCoordinates(e);
            lastX = x;
            lastY = y;
        });

        canvas.addEventListener("touchmove", (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const {
                x,
                y
            } = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.strokeStyle = isErasing ? "#FFF" : "#000";
            ctx.lineWidth = isErasing ? 10 : 2;
            ctx.stroke();
            lastX = x;
            lastY = y;
        });

        canvas.addEventListener("touchend", (e) => {
            e.preventDefault();
            isDrawing = false;
            verificarFormulario(); // Nuevo: verifica el formulario al terminar de dibujar en móvil
        });

        canvas.addEventListener("touchcancel", (e) => {
            e.preventDefault();
            isDrawing = false;
        });

        function resizeCanvas() {
            const currentDrawing = canvas.toDataURL();
            const container = canvas.parentElement;
            canvas.style.width = "100%";
            canvas.style.height = "100%";
            const rect = container.getBoundingClientRect();
            const newWidth = rect.width;
            const newHeight = rect.height;
            if (canvas.width !== newWidth || canvas.height !== newHeight) {
                canvas.width = newWidth;
                canvas.height = newHeight;
                const img = new Image();
                img.src = currentDrawing;
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
            }
        }

        window.addEventListener("load", resizeCanvas);
        window.addEventListener("resize", resizeCanvas);

        function saveCanvasState() {
            const canvasData = canvas.toDataURL();
            localStorage.setItem('canvasState', canvasData);
        }

        function restoreCanvasState() {
            const canvasData = localStorage.getItem('canvasState');
            if (canvasData) {
                const img = new Image();
                img.src = canvasData;
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }
        canvas.addEventListener('click', restoreCanvasState);
        document.querySelectorAll('input, textarea').forEach(element => {
            element.addEventListener('focus', () => {
                saveCanvasState();
            });
        });

        // Nuevas variables para el autocomplete
        let allColaboradores = [];
        let selectedColaboradorIndex = -1;
        let filteredColaboradores = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Código existente...
            
            // Inicializar eventos para el autocomplete
            initAutocomplete();
        });

        function initAutocomplete() {
            const input = document.getElementById('colaborador');
            const suggestionsContainer = document.getElementById('colaborador-suggestions');
            
            input.addEventListener('input', function(e) {
                const value = e.target.value.toLowerCase();
                filteredColaboradores = allColaboradores.filter(col => 
                    col.toLowerCase().includes(value)
                );
                
                showSuggestions(filteredColaboradores);
                verificarFormulario();
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightSuggestion('down');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightSuggestion('up');
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    selectHighlightedSuggestion();
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });
            
            input.addEventListener('blur', function() {
                // Ocultar sugerencias después de un pequeño retraso para permitir la selección
                setTimeout(hideSuggestions, 200);
            });
            
            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    hideSuggestions();
                }
            });
        }
        
        function showSuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('colaborador-suggestions');
            suggestionsContainer.innerHTML = '';
            
            if (suggestions.length === 0) {
                hideSuggestions();
                return;
            }
            
            suggestions.forEach((suggestion, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-suggestion';
                div.textContent = suggestion;
                div.dataset.index = index;
                
                div.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    selectSuggestion(suggestion);
                });
                
                div.addEventListener('mouseover', function() {
                    highlightSuggestionIndex(index);
                });
                
                suggestionsContainer.appendChild(div);
            });
            
            suggestionsContainer.style.display = 'block';
            selectedColaboradorIndex = -1;
        }
        
        function hideSuggestions() {
            const suggestionsContainer = document.getElementById('colaborador-suggestions');
            suggestionsContainer.style.display = 'none';
            selectedColaboradorIndex = -1;
        }
        
        function highlightSuggestion(direction) {
            const suggestions = document.querySelectorAll('.autocomplete-suggestion');
            if (suggestions.length === 0) return;
            
            // Remover highlight actual
            suggestions.forEach(s => s.classList.remove('highlighted'));
            
            if (direction === 'down') {
                selectedColaboradorIndex = (selectedColaboradorIndex + 1) % suggestions.length;
            } else {
                selectedColaboradorIndex = (selectedColaboradorIndex - 1 + suggestions.length) % suggestions.length;
            }
            
            suggestions[selectedColaboradorIndex].classList.add('highlighted');
            suggestions[selectedColaboradorIndex].scrollIntoView({ block: 'nearest' });
        }
        
        function highlightSuggestionIndex(index) {
            const suggestions = document.querySelectorAll('.autocomplete-suggestion');
            suggestions.forEach(s => s.classList.remove('highlighted'));
            selectedColaboradorIndex = index;
            
            if (index >= 0 && index < suggestions.length) {
                suggestions[index].classList.add('highlighted');
            }
        }
        
        function selectHighlightedSuggestion() {
            if (selectedColaboradorIndex >= 0 && filteredColaboradores[selectedColaboradorIndex]) {
                selectSuggestion(filteredColaboradores[selectedColaboradorIndex]);
            }
        }
        
        function selectSuggestion(suggestion) {
            document.getElementById('colaborador').value = suggestion;
            hideSuggestions();
            verificarFormulario();
        }
    </script>
</body>
</html>
