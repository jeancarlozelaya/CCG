<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario de Productos Químicos & Aromas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--text-color);
            line-height: 1.6;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            text-align: center;
            padding: 18px 0;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: var(--shadow);
            position: relative;
            width: 100%;
        }

        .container {
            background: #ffffff;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            box-shadow: var(--shadow);
            margin: 25px auto;
            text-align: center;
            height: auto;
            box-sizing: border-box;
        }

        h1, h2, h3 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
            position: relative;
            padding-bottom: 10px;
        }

        h1:after, h2:after, h3:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background-color: var(--secondary-color);
            border-radius: 2px;
        }

        .question-container {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--secondary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: var(--transition);
            text-align: left;
            position: relative;
            overflow: visible;
        }

        .question-container:hover {
            border-left-color: var(--primary-color);
        }

        .question-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95em;
        }

        .question-container input,
        .question-container select,
        .question-container textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: var(--transition);
            background-color: white;
            margin-top: 5px;
        }

        .question-container input:focus,
        .question-container select:focus,
        .question-container textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .divider {
            width: 100%;
            height: 1px;
            background-color: var(--border-color);
            margin: 20px 0;
        }

        button {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            margin-top: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .add-product-btn {
            background: linear-gradient(to right, var(--success-color), #27ae60);
            width: auto;
            align-self: center;
            margin-top: 15px;
            padding: 10px 20px;
        }

        /* Botón de eliminar estilo mejorado */
        .remove-product {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            z-index: 10;
        }
        
        .remove-product:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        .remove-product i {
            font-size: 14px;
        }

        .main-button {
            background: linear-gradient(to right, var(--success-color), #27ae60);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            margin-top: 20px;
        }

        /* ESTILOS DE LA PANTALLA DE CARGA (Overlay) */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(52, 152, 219, 0.2);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loadingMessage {
            text-align: center;
            color: var(--dark-color);
        }

        #loadingMessage h4 {
            margin: 0 0 10px;
            font-size: 1.3rem;
            color: var(--primary-color);
        }

        #loadingMessage p {
            margin: 0;
            color: #7f8c8d;
        }

        /* Fin ESTILOS DE LA PANTALLA DE CARGA */

        /* Estilos para la tabla */
        #tabla-contenedor {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: relative;
        }

        #tabla-inventario {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            word-wrap: break-word;
            overflow: hidden;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-size: 1em;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .vencimiento-cercano {
            background-color: var(--warning-color) !important;
        }

        .vencimiento-expirado {
            background-color: var(--accent-color) !important;
            color: white;
        }

        .simbologia {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .por-vencerse, .vencido {
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .por-vencerse {
            background-color: var(--warning-color);
            color: black;
        }

        .vencido {
            background-color: var(--accent-color);
            color: white;
        }

        .fecha-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
        }

        .fecha-container input {
            width: 30%;
            text-align: center;
            font-size: 15px;
            box-sizing: border-box;
        }

        .fecha-container span {
            font-size: 15px;
            margin: 0 2px;
        }

        .sugerencias-productos {
            position: absolute;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: calc(100% - 30px);
            box-shadow: var(--shadow);
            margin-top: 2px;
            display: none;
        }

        .sugerencia-producto {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .sugerencia-producto:last-child {
            border-bottom: none;
        }

        .sugerencia-producto:hover {
            background-color: #f5f5f5;
        }

        .sugerencia-producto.highlighted {
            background-color: #e0e0e0;
        }

        .input-error {
            border: 2px solid var(--accent-color) !important;
            animation: shake 0.5s;
        }

        @keyframes shake {
           0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* Contenedor de productos en grid de 2 columnas */
        #products-grid-wrapper {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            align-items: start;
        }
        
        .product-item-wrapper {
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        .product-entry-section {
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            background-color: #f0f8ff;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        #productos-dinamicos-container {
            padding-bottom: 20px;
            display: contents; /* Cambiado para que funcione con grid */
        }

        .fecha-input {
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: var(--transition);
        }

        .fecha-input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .add-another-product-btn {
            background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: auto;
            align-self: center;
            margin-top: 10px;
            grid-column: 1 / -1;
            justify-self: center;
        }

        .add-another-product-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        @media (max-width: 900px) {
            #products-grid-wrapper {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 15px;
                margin: 15px auto;
            }
            
            h1, h2, h3 {
                font-size: 1.5rem;
            }
            
            .question-container {
                padding: 12px;
            }

            .simbologia {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                justify-content: center;
            }
            
            .fecha-container {
                flex-direction: row;
                gap: 5px;
            }
            
            .fecha-container input {
                width: 30%;
            }
        }

        @media (max-width: 480px) {
            .question-container {
                padding: 10px;
            }
            
            .fecha-container {
                flex-direction: row;
                gap: 5px;
            }
            
            .fecha-container input {
                width: 30%;
            }
            
            #products-grid-wrapper {
                grid-template-columns: 1fr;
            }
            
            .simbologia {
                flex-direction: row;
                flex-wrap: nowrap;
            }
            
            .por-vencerse, .vencido {
                font-size: 0.8em;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        Pisos Brillantes
    </div>

    <div class="container">
        <h2>Inventario de Productos Químicos & Aromas</h2>
        <div class="divider"></div>

        <div class="simbologia">
            <span class="por-vencerse">VENCERÁ</span>
            <span class="vencido">VENCIDO</span>
        </div>

        <div class="question-container">
            <input type="text" id="filtroProductos" placeholder="Buscar Productos...">
        </div>

        <div id="tabla-contenedor">
            <table id="tabla-inventario">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Vence</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div style="margin-top: 20px; display: none;">
            <strong>Total de Productos:</strong> <span id="totalCantidad">0</span>
        </div>

        <div class="divider"></div>

        <h3>PEPS de Productos</h3>

        <div class="question-container">
            <label for="tipoMov">Tipo de Movimiento</label>
            <select id="tipoMov">
                <option value="entrada">Entrada</option>
                <option value="salida">Salida</option>
            </select>
        </div>

        <div id="products-grid-wrapper">
            <div id="productos-dinamicos-container">
                <!-- Las entradas de productos se agregarán aquí dinámicamente -->
            </div>
        </div>

        <button id="addProductoBtn" class="add-product-btn">
            <i class="fas fa-plus-circle"></i> Agregar Producto
        </button>

        <div class="divider"></div>
        <button id="procesarBtn" class="main-button">Procesar</button>
    </div>

    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Por favor espera un momento...</h4>
        </div>
    </div>

<script>
// Variable global para productos válidos
let productosValidos = [];
let productEntryCounter = 0; // Para dar IDs únicos a cada entrada de producto

// Función para cargar productos y datos del inventario al iniciar
async function cargarProductos() {
    document.getElementById('overlay').style.display = 'flex'; // Mostrar overlay al inicio
    try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbzR675y6ZqS85Hvh1XI2SeDXL-AvK0-ixNDaAzZg6kLlzWUTVq7v2ZJGpImGK2im8Y9Lg/exec"); 
        const data = await response.json();
        
        productosValidos = data.productos || [];
        console.log("Productos cargados:", productosValidos);
        
        // Mostrar datos del inventario una vez cargados
        if (data.inventario) {
            mostrarDatosEnTabla(data.inventario);
        }
        
    } catch (error) {
        console.error("Error al cargar productos e inventario:", error);
        // Mostrar mensaje de error si falla la carga
        Swal.fire({
            text: 'Error al cargar los datos del inventario o la lista de productos. Por favor, verifica tu conexión o el script.',
            icon: 'error',
            confirmButtonText: 'Aceptar',
            customClass: {
                content: 'swal-content',
                confirmButton: 'swal-button',
                popup: 'swal-popup'
            }
        });
        mostrarDatosEnTabla([]); // Asegura que la tabla esté vacía si hay un error
    } finally {
        document.getElementById('overlay').style.display = 'none'; // Ocultar overlay al finalizar (éxito o error)
    }
}

// Función para mostrar sugerencias de productos (adaptada para IDs dinámicos)
function mostrarSugerenciasProductos(inputElement, sugerencias, textoBusqueda, entryId) {
    const contenedorId = `sugerencias-productos-${entryId}`;
    let contenedor = document.getElementById(contenedorId);

    if (!contenedor) {
        contenedor = document.createElement('div');
        contenedor.id = contenedorId;
        contenedor.className = 'sugerencias-productos'; 
        inputElement.parentNode.insertBefore(contenedor, inputElement.nextSibling);
    }
    
    contenedor.innerHTML = "";
    
    if (sugerencias.length > 0) {
        sugerencias.forEach(producto => {
            const item = document.createElement("div");
            item.className = "sugerencia-producto";
            
            const inicio = producto.toLowerCase().indexOf(textoBusqueda);
            if (inicio >= 0) {
                const antes = producto.substring(0, inicio);
                const match = producto.substring(inicio, inicio + textoBusqueda.length);
                const despues = producto.substring(inicio + textoBusqueda.length);
                
                item.innerHTML = `${antes}<strong>${match}</strong>${despues}`;
            } else {
                item.textContent = producto;
            }
            
            item.addEventListener("click", function() {
                inputElement.value = producto;
                contenedor.style.display = "none";
                validarProducto(inputElement); 
            });
            
            contenedor.appendChild(item);
        });
        
        contenedor.style.display = "block";
    } else {
        contenedor.style.display = "none";
    }
}

// Función para validar si el producto existe (adaptada para IDs dinámicos)
function validarProducto(inputElement) {
    const producto = inputElement.value.trim();
    
    if (producto === "") {
        inputElement.classList.remove("input-error");
        return true; 
    }
    
    const productoValido = productosValidos.find(p => p.toLowerCase() === producto.toLowerCase());
    
    if (!productoValido) {
        inputElement.classList.add("input-error");
        return false;
    } else {
        inputElement.value = productoValido;
        inputElement.classList.remove("input-error");
        return true;
    }
}

// Función para enviar datos a Google Sheets (sin cambios, se llamará múltiples veces)
async function enviarDatosGoogleSheets(tipoMov, producto, fechaVencimiento, cantidad) {
    var url = 'https://script.google.com/macros/s/AKfycbw6yBwDyCC4wx0TBeBeMF3gNA_x8dcpQSW-SldEiGfCkrJ1LFwqUXXA39wv52Hf4n3kTw/exec';

    var datos = {
        tipoMov: tipoMov,
        producto: producto,
        fechaVencimiento: fechaVencimiento,
        cantidad: cantidad
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(datos),
            mode: 'no-cors'
        });
        console.log('Solicitud enviada para:', producto);
        return { success: true };
    } catch (error) {
        console.error('Error al enviar datos para', producto, ':', error);
        return { success: false, message: error.message || 'Ocurrió un error al procesar la solicitud.' };
    }
}


function validarDiaMes(input, max) {
    if (input.value.length > 2) {
        input.value = input.value.slice(0, 2);
    }
    if (parseInt(input.value, 10) > max) {
        input.value = max;
    }
}

function validarAnio(input) {
    if (input.value.length > 4) {
        input.value = input.value.slice(0, 4);
    }
}

// Función para actualizar la fecha de vencimiento (adaptada para IDs dinámicos)
function actualizarFechaVencimiento(entryId) {
    const diaInput = document.getElementById(`dia-${entryId}`);
    const mesInput = document.getElementById(`mes-${entryId}`);
    const anioInput = document.getElementById(`anio-${entryId}`);
    const fechaHiddenInput = document.getElementById(`fechaVencimiento-${entryId}`);

    const dia = diaInput.value;
    const mes = mesInput.value;
    const anio = anioInput.value;

    if (dia.length >= 1 && mes.length >= 1 && anio.length >= 1) {
        const diaFormateado = dia.length === 1 ? `0${dia}` : dia;
        const mesFormateado = mes.length === 1 ? `0${mes}` : mes;
        const anioFormateado = anio.length === 4 ? anio : "";

        if (anioFormateado && diaFormateado && mesFormateado) {
            const fechaCompleta = `${diaFormateado}/${mesFormateado}/${anioFormateado}`;
            fechaHiddenInput.value = fechaCompleta;
        } else {
            fechaHiddenInput.value = "";
        }
    } else {
        fechaHiddenInput.value = "";
    }
}

// Función para validar día y mes (adaptada para IDs dinámicos)
function validarDiaYMes(event, tipo, entryId) {
    const value = event.target.value;

    if (!/^\d*$/.test(value)) {
        event.target.value = value.replace(/[^\d]/g, '');
        return;
    }

    if (tipo === 'dia' && value > 31) {
        event.target.value = 31;
    }

    if (tipo === 'mes' && value > 12) {
        event.target.value = 12;
    }

    actualizarFechaVencimiento(entryId);
}

// Función para agregar una nueva entrada de producto
function addProductEntry() {
    productEntryCounter++;
    const container = document.getElementById('productos-dinamicos-container');
    const newEntry = document.createElement('div');
    newEntry.className = 'product-item-wrapper';
    newEntry.id = `product-item-wrapper-${productEntryCounter}`;
    newEntry.innerHTML = `
        <div class="product-entry-section" id="product-entry-${productEntryCounter}">
            <button type="button" class="remove-product" onclick="confirmRemoval(${productEntryCounter})">
                <i class="fas fa-trash-alt"></i>
            </button>
            
            <div class="question-container">
                <label for="producto-${productEntryCounter}">Producto:</label>
                <input type="text" id="producto-${productEntryCounter}" placeholder="Escribe el nombre del producto..." autocomplete="off" required>
                <div id="sugerencias-productos-${productEntryCounter}" class="sugerencias-productos"></div>
            </div>

            <div class="question-container">
                <label for="fechaVencimiento-${productEntryCounter}">Fecha de Vencimiento</label>
                <div class="fecha-container">
                    <input type="number" id="dia-${productEntryCounter}" min="1" max="31" placeholder="Día" oninput="validarDiaMes(this, 31)" class="fecha-input">
                    <span>/</span>
                    <input type="number" id="mes-${productEntryCounter}" min="1" max="12" placeholder="Mes" oninput="validarDiaMes(this, 12)" class="fecha-input">
                    <span>/</span>
                    <input type="number" id="anio-${productEntryCounter}" maxlength="4" placeholder="Año" oninput="validarAnio(this)" class="fecha-input">
                </div>
                <input type="hidden" id="fechaVencimiento-${productEntryCounter}">
            </div>

            <div class="question-container">
                <label for="cantidad-${productEntryCounter}">Cantidad</label>
                <input type="number" id="cantidad-${productEntryCounter}" placeholder="Cantidad" required>
            </div>
        </div>
    `;
    container.appendChild(newEntry);

    // Adjuntar event listeners a los nuevos elementos
    const currentEntryId = productEntryCounter;
    const inputProducto = document.getElementById(`producto-${currentEntryId}`);
    
    inputProducto.addEventListener("input", function() {
        const texto = this.value.toLowerCase().trim();
        this.classList.remove("input-error");
        
        if (texto.length >= 1) {
            const sugerencias = productosValidos
                .filter(producto => producto.toLowerCase().includes(texto))
                .slice(0, 8);
            
            mostrarSugerenciasProductos(this, sugerencias, texto, currentEntryId);
        } else {
            const contenedorSugerencias = document.getElementById(`sugerencias-productos-${currentEntryId}`);
            if (contenedorSugerencias) {
                contenedorSugerencias.style.display = "none";
            }
        }
    });

    inputProducto.addEventListener("keydown", function(e) {
        const items = document.querySelectorAll(`#sugerencias-productos-${currentEntryId} .sugerencia-producto`);
        if (items.length === 0) return;
        
        const current = document.querySelector(`#sugerencias-productos-${currentEntryId} .sugerencia-producto.highlighted`);
        
        if (e.key === "ArrowDown") {
            e.preventDefault();
            if (current) current.classList.remove("highlighted");
            const next = current ? 
                (current.nextElementSibling || items[0]) : 
                items[0];
            next.classList.add("highlighted");
            next.scrollIntoView({ block: "nearest" });
        } else if (e.key === "ArrowUp") {
            e.preventDefault();
            if (current) current.classList.remove("highlighted");
            const prev = current ? 
                (current.previousElementSibling || items[items.length-1]) : 
                items[items.length-1];
            prev.classList.add("highlighted");
            prev.scrollIntoView({ block: "nearest" });
        } else if (e.key === "Enter") {
            e.preventDefault();
            if (current) {
                const productoOriginal = productosValidos.find(p => 
                    p.toLowerCase() === current.textContent.toLowerCase());
                if (productoOriginal) {
                    inputProducto.value = productoOriginal;
                }
                document.getElementById(`sugerencias-productos-${currentEntryId}`).style.display = "none";
            }
        }
    });

    inputProducto.addEventListener("blur", function() {
        setTimeout(() => {
            validarProducto(this);
            const contenedorSugerencias = document.getElementById(`sugerencias-productos-${currentEntryId}`);
            if (contenedorSugerencias) {
                contenedorSugerencias.style.display = "none";
            }
        }, 200);
    });

    document.getElementById(`dia-${currentEntryId}`).addEventListener("input", function(event) {
        validarDiaYMes(event, 'dia', currentEntryId);
    });
    document.getElementById(`mes-${currentEntryId}`).addEventListener("input", function(event) {
        validarDiaYMes(event, 'mes', currentEntryId);
    });
    document.getElementById(`anio-${currentEntryId}`).addEventListener("input", function() {
        actualizarFechaVencimiento(currentEntryId);
    });

    // Mover el botón de agregar al final del grid
    const addButton = document.getElementById('addProductoBtn');
    if (addButton && addButton.parentNode) {
        addButton.parentNode.removeChild(addButton);
        document.getElementById('products-grid-wrapper').appendChild(addButton);
    }
}

// Función para confirmar eliminación de producto
function confirmRemoval(id) {
    const productItemWrapper = document.getElementById(`product-item-wrapper-${id}`);
    if (productItemWrapper) {
        productItemWrapper.remove();
        if (document.querySelectorAll('.product-item-wrapper').length === 0) {
            addProductEntry();
        }
    }
}

document.getElementById('procesarBtn').addEventListener('click', async function() {
    const tipoMov = document.getElementById('tipoMov').value;
    const allProductEntries = document.querySelectorAll('.product-entry-section');
    const productsToProcess = [];
    let allInputsValid = true;

    document.getElementById('overlay').style.display = 'flex'; // Mostrar overlay al procesar

    for (let i = 0; i < allProductEntries.length; i++) {
        const entry = allProductEntries[i];
        const entryId = entry.id.split('-')[2]; 
        
        const inputProducto = document.getElementById(`producto-${entryId}`);
        const fechaVencimiento = document.getElementById(`fechaVencimiento-${entryId}`).value;
        const cantidadInput = document.getElementById(`cantidad-${entryId}`);
        const cantidad = parseInt(cantidadInput.value);

        // Validar producto
        if (!validarProducto(inputProducto)) {
            allInputsValid = false;
            break;
        }

        // Validar campos obligatorios
        if (!inputProducto.value || !fechaVencimiento || isNaN(cantidad) || cantidad <= 0) {
            Swal.fire({
                text: 'Por favor, completa todos los campos (producto, fecha, cantidad) y asegúrate que la cantidad sea un número positivo en cada entrada de producto.',
                icon: 'warning',
                confirmButtonText: 'Aceptar',
                customClass: {
                    content: 'swal-content',
                    confirmButton: 'swal-button',
                    popup: 'swal-popup'
                }
            });
            allInputsValid = false;
            document.getElementById('overlay').style.display = 'none';
            return; 
        }

        productsToProcess.push({
            tipoMov: tipoMov,
            producto: inputProducto.value,
            fechaVencimiento: fechaVencimiento,
            cantidad: cantidad
        });
    }

    if (!allInputsValid) {
        document.getElementById('overlay').style.display = 'none';
        return;
    }

    if (productsToProcess.length === 0) {
        Swal.fire({
            text: 'No hay productos para procesar. Agregue al menos uno.',
            icon: 'info',
            confirmButtonText: 'Aceptar',
            customClass: {
                content: 'swal-content',
                confirmButton: 'swal-button',
                popup: 'swal-popup'
            }
        });
        document.getElementById('overlay').style.display = 'none';
        return;
    }

    let allSuccess = true;
    let errorMessage = '';

    for (const productData of productsToProcess) {
        if (productData.tipoMov === 'salida') {
            const tabla = document.getElementById('tabla-inventario').getElementsByTagName('tbody')[0];
            let productoEncontrado = false;
            let cantidadDisponible = 0;

            for (let fila of tabla.rows) {
                const productoTabla = fila.cells[0].textContent.trim();
                const fechaTabla = fila.cells[1].textContent.trim(); // Ya debería estar en dd/mm/aaaa
                const cantidadTabla = parseInt(fila.cells[2].textContent.trim(), 10);

                if (productoTabla === productData.producto && fechaTabla === productData.fechaVencimiento) {
                    productoEncontrado = true;
                    cantidadDisponible = cantidadTabla;
                    break;
                }
            }

            if (!productoEncontrado) {
                allSuccess = false;
                errorMessage = `El producto "${productData.producto}" con fecha ${productData.fechaVencimiento} no existe en el inventario.`;
                break;
            }

            if (productData.cantidad > cantidadDisponible) {
                allSuccess = false;
                errorMessage = `La cantidad de "${productData.producto}" (${productData.cantidad}) excede la cantidad disponible (${cantidadDisponible}) para la fecha ${productData.fechaVencimiento}.`;
                break;
            }
        }
    }

    if (!allSuccess) {
        Swal.fire({
            text: errorMessage,
            icon: 'error',
            confirmButtonText: 'Aceptar',
            customClass: {
                content: 'swal-content',
                confirmButton: 'swal-button',
                popup: 'swal-popup'
            }
        });
        document.getElementById('overlay').style.display = 'none';
        return;
    }

    // Si todas las validaciones son correctas, proceder con el envío
    let successCount = 0;
    for (const productData of productsToProcess) {
        const result = await enviarDatosGoogleSheets(productData.tipoMov, productData.producto, productData.fechaVencimiento, productData.cantidad);
        if (result.success) {
            successCount++;
        } else {
            allSuccess = false;
            errorMessage = result.message || `Error al procesar el producto: ${productData.producto}`;
            break;
        }
    }

    document.getElementById('overlay').style.display = 'none'; // Ocultar overlay después de procesar

    if (allSuccess) {
        Swal.fire({
            text: '¡Todos los movimientos procesados exitosamente! 🥳🎉',
            icon: 'success',
            confirmButtonText: 'Aceptar',
            customClass: {
                content: 'swal-content',
                confirmButton: 'swal-button',
                popup: 'swal-popup'
            }
        }).then(() => {
            location.reload();
        });
    } else {
        Swal.fire({
            text: `Se encontraron errores: ${errorMessage}`,
            icon: 'error',
            confirmButtonText: 'Aceptar',
            customClass: {
                content: 'swal-content',
                confirmButton: 'swal-button',
                popup: 'swal-popup'
            }
        });
    }
});


function mostrarDatosEnTabla(datos) {
    const tablaCuerpo = document.querySelector("#tabla-inventario tbody");
    tablaCuerpo.innerHTML = "";

    const hoy = new Date();

    datos.sort((a, b) => {
        // Parsear las fechas para la comparación
        const parseDateForSort = (dateString) => {
            if (!dateString) return null;
            // Si es un string ISO (ej. "2026-07-10T06:00:00.000Z"), Date() lo parsea directamente
            // Si es "dd/mm/yyyy", lo parseamos manualmente para asegurar
            if (typeof dateString === "string" && /^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
                const parts = dateString.split('/');
                return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            }
            return new Date(dateString); 
        };

        const fechaVencimientoA = parseDateForSort(a[1]);
        const fechaVencimientoB = parseDateForSort(b[1]);
        
        if (fechaVencimientoA && fechaVencimientoB) {
            return fechaVencimientoA.getTime() - fechaVencimientoB.getTime();
        }
        return 0;
    });

    datos.forEach(fila => {
        const [producto, vencimiento, cantidad] = fila;
        
        let fechaVencimientoObj = null;
        let fechaFormateadaParaTabla = ""; // Variable para la fecha ya formateada en dd/mm/aaaa

        if (vencimiento) {
            // Intenta crear un objeto Date. Si es un ISO string, Date() lo parseará. Si es dd/mm/yyyy, la función formatearFecha lo manejará.
            fechaVencimientoObj = new Date(vencimiento); 
            if (!isNaN(fechaVencimientoObj.getTime())) { // Asegura que la fecha es válida
                fechaFormateadaParaTabla = formatearFecha(fechaVencimientoObj); // Usar la función para formatear
            } else {
                fechaFormateadaParaTabla = vencimiento; // Si no se puede parsear a Date, usa el string original
            }
        }

        let claseFila = "";
        if (fechaVencimientoObj && !isNaN(fechaVencimientoObj.getTime())) { // Usar getTime() para asegurar validez
            const diferenciaDias = (fechaVencimientoObj - hoy) / (1000 * 60 * 60 * 24);
            if (diferenciaDias < 0) {
                claseFila = "vencimiento-expirado";
            } else if (diferenciaDias <= 60) {
                claseFila = "vencimiento-cercano";
            }
        }

        const filaHTML = `
            <tr class="${claseFila}">
                <td>${producto || ""}</td>
                <td>${fechaFormateadaParaTabla}</td>
                <td>${cantidad || ""}</td>
            </tr>
        `;
        tablaCuerpo.insertAdjacentHTML("beforeend", filaHTML);
    });
}

// Función para convertir una fecha a formato dd/mm/aaaa
function formatearFecha(fecha) {
    // Si la fecha ya viene en formato dd/mm/yyyy, la devuelve tal cual.
    if (typeof fecha === "string" && /^\d{2}\/\d{2}\/\d{4}$/.test(fecha)) {
        return fecha;
    }
    // Si es un objeto Date o un formato diferente (como ISO string), la formatea.
    var fechaObj = new Date(fecha); 
    // Ajuste para evitar problemas de zona horaria si la fecha no tiene hora específica
    fechaObj.setMinutes(fechaObj.getMinutes() + fechaObj.getTimezoneOffset()); 
    var dia = ("0" + fechaObj.getDate()).slice(-2);
    var mes = ("0" + (fechaObj.getMonth() + 1)).slice(-2);
    var anio = fechaObj.getFullYear();
    return `${dia}/${mes}/${anio}`;
}


document.getElementById("filtroProductos").addEventListener("input", function () {
    const filtro = this.value.toLowerCase();
    const filas = document.querySelectorAll("table tbody tr");
    let totalCantidad = 0;

    filas.forEach(fila => {
        const textoFila = fila.textContent.toLowerCase();
        const cantidadCelda = fila.querySelector("td:nth-child(3)");

        if (textoFila.includes(filtro)) {
            fila.style.display = "";
            if (cantidadCelda) {
                totalCantidad += parseInt(cantidadCelda.textContent, 10) || 0;
            }
        } else {
            fila.style.display = "none";
        }
    });

    const totalCantidadElemento = document.getElementById("totalCantidad");
    totalCantidadElemento.textContent = totalCantidad;

    if (filtro === "" || totalCantidad === 0) {
        totalCantidadElemento.parentElement.style.display = "none";
    } else {
        totalCantidadElemento.parentElement.style.display = "block";
    }
});

// Inicializar al cargar la página
document.addEventListener("DOMContentLoaded", function() {
    cargarProductos();
    addProductEntry(); // Agregar la primera entrada de producto al cargar
    document.getElementById('addProductoBtn').addEventListener('click', addProductEntry);
});
</script>

</body>
</html>
