<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hoja de Liberación - Pisos Brillantes</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    /* ... (TUS ESTILOS CSS SE QUEDAN EXACTAMENTE IGUAL) ... */
    :root { --primary-color: #2c3e50; --secondary-color: #3498db; --accent-color: #e74c3c; --success-color: #2ecc71; --warning-color: #f39c12; --dark-color: #34495e; --text-color: #333; --border-color: #e0e0e0; --input-bg: #fff; --shadow-sm: 0 2px 4px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1); --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: var(--text-color); line-height: 1.6; user-select: none; overscroll-behavior: none; padding-bottom: 90px; }
    .header { background: linear-gradient(135deg, var(--primary-color), var(--dark-color)); color: white; text-align: center; padding: 18px 0; font-size: 1.5rem; font-weight: bold; box-shadow: var(--shadow-md); width: 100%; }
    .form-container { width: 96%; max-width: 800px; margin: 25px auto; padding: 30px 20px; background-color: white; border-radius: 12px; box-shadow: var(--shadow-md); }
    h1 { text-align: center; color: var(--primary-color); margin-bottom: 30px; margin-top: 10px; font-size: 1.4rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; position: relative; padding-bottom: 10px; }
    h1:after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background-color: var(--secondary-color); }
    .question-container { margin-bottom: 15px; padding: 15px 18px; border-radius: 8px; background-color: #ffffff; border: 1px solid var(--border-color); border-left: 5px solid var(--accent-color); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; justify-content: center; transition: border-left-color 0.3s ease, transform 0.2s, box-shadow 0.2s; }
    .question-container.valid { border-left-color: var(--success-color) !important; }
    .question-container.invalid { border-left-color: var(--accent-color) !important; }
    .question-container.neutral { border-left-color: #bdc3c7 !important; } 
    .question-container:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); transform: translateY(-1px); }
    .question-container label, .label-style { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark-color); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .question-container input { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem; transition: var(--transition); background-color: #fdfdfd; color: #495057; }
    .question-container input:focus { border-color: var(--secondary-color); background-color: #fff; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
    .question-container input:disabled { background-color: #f8f9fa; color: #adb5bd; cursor: not-allowed; border-style: dashed; }
    .checkbox-wrapper { display: flex; align-items: center; margin-bottom: 5px; font-size: 0.9em; color: var(--primary-color); cursor: pointer; user-select: none; font-weight: 700; }
    .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; margin-right: 10px; margin-top: 0; cursor: pointer; accent-color: var(--secondary-color); flex-shrink: 0; }
    .switch-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef; }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:focus + .slider { box-shadow: 0 0 1px var(--accent-color); }
    input:checked + .slider:before { transform: translateX(26px); }
    .slider.round { border-radius: 34px; }
    .slider.round:before { border-radius: 50%; }
    .switch-label { font-weight: bold; color: var(--dark-color); font-size: 1rem; text-transform: uppercase; }
    .signature-section { margin-top: 35px; padding: 20px; border: 1px solid var(--border-color); border-radius: 12px; background-color: #fff; text-align: center; box-shadow: var(--shadow-sm); border-left: 5px solid var(--accent-color); transition: border-left-color 0.3s; }
    .signature-section.valid { border-left-color: var(--success-color); }
    .signature-section.neutral { border-left-color: #bdc3c7; }
    .canvas-wrapper { border: 2px dashed var(--secondary-color); border-radius: 8px; background-color: #ffffff; position: relative; overflow: hidden; margin-bottom: 15px; }
    #firmaCanvas { width: 100% !important; height: 200px !important; background: #ffffff; touch-action: none; user-select: none; cursor: crosshair; display: block; }
    .firma-buttons { display: flex; gap: 10px; justify-content: center; }
    .icon-button { background: white; border: 1px solid #ced4da; border-radius: 6px; padding: 8px 14px; cursor: pointer; font-size: 16px; color: #555; transition: var(--transition); }
    .icon-button:hover { background: #f1f3f5; transform: translateY(-2px); }
    .icon-button.active { background: var(--secondary-color); color: #fff; border-color: var(--secondary-color); }
    .file-upload { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 140px; background-color: #f0f8ff; border: 2px solid var(--secondary-color); border-radius: 10px; cursor: pointer; margin-top: 10px; transition: var(--transition); position: relative; }
    .file-upload:hover { background-color: #e1f0ff; transform: scale(1.01); }
    .file-upload i { font-size: 3em; margin-bottom: 10px; color: var(--secondary-color); }
    .file-upload-text { font-size: 1em; font-weight: 600; color: var(--primary-color); }
    .file-upload input[type="file"] { display: none !important; }
    .image-preview { width: 100%; min-height: 10px; padding: 15px 0; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .image-preview-item { position: relative; width: 90px; height: 90px; overflow: hidden; border-radius: 8px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .delete-icon { position: absolute; top: 2px; right: 2px; background: rgba(231, 76, 60, 0.9); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 10; }
    .button-container { display: flex; justify-content: center; margin-top: 30px; }
    #btnGenerar { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; border-radius: 8px; padding: 15px 40px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: var(--transition); box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3); width: 100%; max-width: 350px; letter-spacing: 0.5px; }
    #btnGenerar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5); }
    .modal-history-container { text-align: left; max-height: 450px; overflow-y: auto; padding: 0; }
    .modal-history-container::-webkit-scrollbar { width: 6px; }
    .modal-history-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .modal-history-container::-webkit-scrollbar-thumb { background: #bdc3c7; border-radius: 3px; }
    .history-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 15px; border-bottom: 1px solid #eaeaea; transition: background-color 0.2s; min-height: 70px; }
    .history-item:nth-child(odd) { background-color: #ffffff; }
    .history-item:nth-child(even) { background-color: #f8f9fa; }
    .history-item:hover { background-color: #f0f4f8; }
    .h-info { flex: 1; padding-right: 15px; }
    .h-title { font-weight: 700; color: var(--primary-color); font-size: 0.95rem; margin-bottom: 4px; display: flex; align-items: center; }
    .h-title i { color: #e74c3c; margin-right: 8px; font-size: 1.1em; }
    .h-meta { font-size: 0.8rem; color: #7f8c8d; display: flex; gap: 15px; flex-wrap: wrap; }
    .h-meta span { display: flex; align-items: center; gap: 4px; }
    .h-right-panel { display: flex; align-items: center; justify-content: flex-end; min-width: 130px; margin-left: auto; }
    .h-actions { display: flex; gap: 8px; align-items: center; }
    .h-btn { width: 36px; height: 36px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .h-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .h-btn.dl { background-color: #e8f8f5; color: #2ecc71; } 
    .h-btn.dl:hover { background-color: #2ecc71; color: white; }
    .h-btn.sh { background-color: #ebf5fb; color: #3498db; }
    .h-btn.sh:hover { background-color: #3498db; color: white; }
    .h-btn.del { background-color: #fdedec; color: #e74c3c; }
    .h-btn.del:hover { background-color: #e74c3c; color: white; }
    .h-confirm { display: none; align-items: center; gap: 8px; background-color: #fff1f0; padding: 4px 10px; border-radius: 20px; animation: fadeIn 0.2s ease-in-out; border: 1px solid #fadbd8; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .h-confirm-text { font-size: 0.75rem; color: #e74c3c; font-weight: bold; margin-right: 2px; }
    .h-btn-small { width: 26px; height: 26px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; transition: transform 0.1s; }
    .h-btn-small:hover { transform: scale(1.1); }
    .bg-yes { background-color: #e74c3c; }
    .bg-no { background-color: #95a5a6; }
    .scroll-button { border: none; border-radius: 50%; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-size: 1.5em; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: var(--transition); position: fixed; z-index: 1000; color: white; }
    .scroll-button:hover { transform: scale(1.1); }
    #liberacion-pendiente-button { background-color: var(--warning-color); display: none; left: 25px; top: 90px; }
    #liberacion-pendiente-button .badge { position: absolute; top: -5px; right: -5px; background-color: var(--accent-color); color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 0.8em; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid white; }
    #btn-camara-flotante { background-color: var(--secondary-color); left: 25px; bottom: 25px; }
    #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.95); justify-content: center; align-items: center; z-index: 9999; flex-direction: column; text-align: center; }
    .spinner { width: 60px; height: 60px; border: 5px solid rgba(52, 152, 219, 0.2); border-radius: 50%; border-top-color: var(--secondary-color); animation: spin 1s ease-in-out infinite; margin-bottom: 20px; }
    #loadingMessage h4 { margin: 10px 0 5px 0; color: var(--primary-color); }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
    <div class="header">Pisos Brillantes</div>
    
    <div class="form-container">
        <h1>Datos de la Restricción</h1>

        <div class="question-container" id="container-fecha">
            <label for="fecha">FECHA:</label>
            <input type="date" id="fecha" oninput="validarYGuardar()">
        </div>

        <div class="question-container neutral" id="container-folio">
            <label class="checkbox-wrapper" for="checkFolio">
                <input type="checkbox" id="checkFolio" onchange="toggleInputState('folio', 'container-folio', this); validarYGuardar()">
                <span>Incluir FOLIO</span>
            </label>
            <input type="text" id="folio" placeholder="Ej: 001" disabled style="display: none;" oninput="validarYGuardar()">
        </div>

        <div class="question-container" id="container-dependencia">
            <label for="dependencia">DEPENDENCIA / EDIFICIO / NIVEL:</label>
            <input type="text" id="dependencia" placeholder="Escribe la ubicación completa" oninput="validarYGuardar()">
        </div>

        <h1 style="margin-top: 40px;">Detalle de Restricción</h1>
        
        <div class="table-section">
            <div class="question-container neutral" id="container-ticket">
                <label class="checkbox-wrapper" for="checkTicket">
                    <input type="checkbox" id="checkTicket" onchange="toggleInputState('ticket', 'container-ticket', this); validarYGuardar()">
                    <span>Incluir TICKET</span>
                </label>
                <input type="text" id="ticket" placeholder="Número de Ticket" disabled style="display: none;" oninput="validarYGuardar()">
            </div>
            
            <div class="question-container" id="container-descripcion">
                <label for="descripcion">DESCRIPCIÓN:</label>
                <input type="text" id="descripcion" placeholder="Descripción de la restricción del servicio" oninput="validarYGuardar()">
            </div>
            
            <div class="question-container" id="container-fechaRestriccion">
                <label for="fechaHoraRestriccion">FECHA Y HORA DE RESTRICCIÓN:</label>
                <input type="datetime-local" id="fechaHoraRestriccion" oninput="validarYGuardar()">
            </div>

            <div class="question-container neutral" id="container-fechaRepro">
                <label class="checkbox-wrapper" for="checkRepro">
                    <input type="checkbox" id="checkRepro" onchange="toggleInputState('fechaHoraReprogramacion', 'container-fechaRepro', this); validarYGuardar()">
                    <span>Incluir REPROGRAMACIÓN</span>
                </label>
                <input type="datetime-local" id="fechaHoraReprogramacion" disabled style="display: none;" oninput="validarYGuardar()">
            </div>
            
            <div class="question-container neutral">
                <label for="horasRestriccion">HORAS DE RESTRICCIÓN (Automático):</label>
                <input type="text" id="horasRestriccion" readonly value="0 hrs 0 min">
            </div>
        </div>

        <div class="signature-section" id="seccion-firma">
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="checkSinFirma" onchange="toggleSinFirma(); validarYGuardar()">
                    <span class="slider round"></span>
                </label>
                <span class="switch-label">Opción Sin Firma</span>
            </div>

            <div id="container-usuario" class="question-container">
                <label for="usuario">NOMBRE DE USUARIO / RESPONSABLE:</label>
                <input type="text" id="usuario" placeholder="Nombre completo del responsable" oninput="validarYGuardar()">
            </div>

            <div id="container-motivo" class="question-container" style="display: none;">
                <label for="motivoSinFirma" style="color: var(--dark-color);">MOTIVO POR EL QUE NO FIRMA:</label>
                <input type="text" id="motivoSinFirma" placeholder="Especifique la razón (Ej: Oficina cerrada)" oninput="validarYGuardar()">
            </div>

            <div id="contenedor-firma-wrapper">
                <div class="label-style" style="margin-bottom: 10px; text-align: center;">FIRMA DEL USUARIO</div>
                <div class="canvas-wrapper">
                    <canvas id="firmaCanvas" width="600" height="200"></canvas>
                </div>
                <div class="firma-buttons">
                    <button type="button" class="icon-button" id="toggleEraser" onclick="toggleEraser()" title="Borrador"><i class="fas fa-eraser"></i></button>
                    <button type="button" class="icon-button" id="undo" onclick="undo()" title="Deshacer"><i class="fas fa-undo"></i></button>
                    <button type="button" class="icon-button" id="redo" onclick="redo()" title="Rehacer"><i class="fas fa-redo"></i></button>
                    <button type="button" class="icon-button" onclick="clearSignature(true)" title="Limpiar Todo"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        </div>

        <div class="question-container" style="margin-top: 20px; border-left-color: #bdc3c7;" id="seccion-fotos">
            <label><i class="fas fa-camera"></i> EVIDENCIA FOTOGRÁFICA</label>
            <div class="file-upload" onclick="document.getElementById('fotoInput').click()">
                <i class="fas fa-camera"></i>
                <div class="file-upload-text">Toca para tomar foto</div>
                <input type="file" id="fotoInput" accept="image/*" capture="environment" multiple onchange="manejarFotos(this)">
            </div>
            <div class="image-preview" id="previewContainer"></div>
        </div>

        <div class="button-container">
            <button type="button" id="btnGenerar" onclick="confirmarYGenerar()">Generar Registro</button>
        </div>
    </div>

    <button class="scroll-button" id="liberacion-pendiente-button" onclick="mostrarHistorial()" title="Registros Guardados">
        <i class="fa-solid fa-download"></i><span class="badge" id="badgeHistorial">0</span>
    </button>
    <button class="scroll-button" id="btn-camara-flotante" onclick="document.getElementById('fotoInput').click()" title="Tomar Foto">
        <i class="fas fa-camera"></i>
    </button>

    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Generando Registro...</h4>
            <p>Por favor, espera un momento.</p>
        </div>
    </div>

<script>
    const HORA_INICIO_HABIL = 7; const HORA_FIN_HABIL = 23;
    const db = new Dexie("LiberacionDB");
    db.version(2).stores({ registros: '++id, timestamp', borrador: 'id' });
    let fotosSeleccionadas = []; let cargandoDatos = true; 

    // FIRMA
    let isDrawing=false, isErasing=false, lastX=0, lastY=0;
    const canvas=document.getElementById("firmaCanvas"), ctx=canvas.getContext("2d", {willReadFrequently:true});
    const undoStack=[], redoStack=[];

    function initializeCanvas() {
        ctx.lineJoin='round'; ctx.lineCap='round'; ctx.lineWidth=4; ctx.strokeStyle='#000';
        canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing); canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', (e)=>{e.preventDefault();const p=getPos(e);lastX=p.x;lastY=p.y;startDrawing(e);},{passive:false});
        canvas.addEventListener('touchmove', (e)=>{e.preventDefault();draw(e);},{passive:false});
        canvas.addEventListener('touchend', stopDrawing);
        saveToUndoStack(); actualizarBadge();
    }
    function getPos(evt) {
        const r=canvas.getBoundingClientRect(), sx=canvas.width/r.width, sy=canvas.height/r.height;
        let cx,cy; if(evt.touches && evt.touches.length>0){cx=evt.touches[0].clientX;cy=evt.touches[0].clientY;}else{cx=evt.clientX;cy=evt.clientY;}
        return {x:(cx-r.left)*sx, y:(cy-r.top)*sy};
    }
    function startDrawing(e){isDrawing=true;const p=getPos(e);lastX=p.x;lastY=p.y;}
    function draw(e){if(!isDrawing)return;const p=getPos(e);ctx.beginPath();ctx.moveTo(lastX,lastY);ctx.lineTo(p.x,p.y);
        ctx.globalCompositeOperation=isErasing?'destination-out':'source-over'; ctx.lineWidth=isErasing?20:4;
        ctx.stroke(); [lastX,lastY]=[p.x,p.y];}
    function stopDrawing(){if(isDrawing){isDrawing=false;saveToUndoStack();validarYGuardar();}}
    function toggleEraser(){isErasing=!isErasing;const b=document.getElementById('toggleEraser');if(isErasing){b.classList.add('active');canvas.style.cursor='cell';}else{b.classList.remove('active');canvas.style.cursor='crosshair';}}
    function saveToUndoStack(){undoStack.push(canvas.toDataURL());redoStack.length=0;updateButtonStates();}
    function undo(){if(undoStack.length>1){redoStack.push(undoStack.pop());restoreState(undoStack[undoStack.length-1]);}updateButtonStates();}
    function redo(){if(redoStack.length>0){const n=redoStack.pop();undoStack.push(n);restoreState(n);}updateButtonStates();}
    function restoreState(d){const i=new Image();i.src=d;i.onload=()=>{ctx.clearRect(0,0,canvas.width,canvas.height);ctx.globalCompositeOperation='source-over';ctx.drawImage(i,0,0);validarYGuardar();};}
    function clearSignature(s=false){ctx.clearRect(0,0,canvas.width,canvas.height);saveToUndoStack();if(s)validarYGuardar();}
    function updateButtonStates(){document.getElementById('undo').style.opacity=undoStack.length>1?'1':'0.5';document.getElementById('redo').style.opacity=redoStack.length>0?'1':'0.5';}
    function isCanvasBlank(c){const b=document.createElement('canvas');b.width=c.width;b.height=c.height;return c.toDataURL()===b.toDataURL();}

    // VALIDACION
    function validarCampo(inputId, containerId) {
        const input=document.getElementById(inputId), container=document.getElementById(containerId);
        if(input.disabled){container.classList.remove('invalid','valid');container.classList.add('neutral');return true;}
        if(input.value.trim()!==""){container.classList.add('valid');container.classList.remove('invalid','neutral');return true;}
        else{container.classList.add('invalid');container.classList.remove('valid','neutral');return false;}
    }
    function validarTodosLosCampos() {
        if(cargandoDatos)return;
        validarCampo('fecha','container-fecha'); validarCampo('folio','container-folio'); validarCampo('dependencia','container-dependencia');
        validarCampo('ticket','container-ticket'); validarCampo('descripcion','container-descripcion');
        validarCampo('fechaHoraRestriccion','container-fechaRestriccion'); validarCampo('fechaHoraReprogramacion','container-fechaRepro');
        
        const sf=document.getElementById('checkSinFirma').checked, ss=document.getElementById('seccion-firma'), sfo=document.getElementById('seccion-fotos');
        if(sf){
            document.getElementById('container-usuario').classList.remove('valid','invalid'); validarCampo('motivoSinFirma','container-motivo');
            ss.classList.remove('invalid'); ss.classList.add('neutral');
            sfo.style.borderLeftColor = fotosSeleccionadas.length>0?"var(--success-color)":"var(--accent-color)";
        }else{
            validarCampo('usuario','container-usuario'); document.getElementById('container-motivo').classList.remove('valid','invalid');
            if(!isCanvasBlank(canvas)){ss.classList.add('valid');ss.classList.remove('invalid','neutral');}
            else{ss.classList.add('invalid');ss.classList.remove('valid','neutral');}
            sfo.style.borderLeftColor = fotosSeleccionadas.length>0?"var(--success-color)":"#bdc3c7";
        }
    }
    function validarYGuardar(){validarTodosLosCampos();triggerAutoSave();}
    function toggleInputState(iid,cid,chk){
        const i=document.getElementById(iid); i.disabled=!chk.checked;
        if(i.disabled){i.style.display='none';i.value='';if(iid==='fechaHoraReprogramacion')calcularHorasHabiles();}
        else{i.style.display='block';if(iid==='fechaHoraReprogramacion'&&!i.value){const d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());i.value=d.toISOString().slice(0,16);calcularHorasHabiles();}}
        validarCampo(iid,cid);
    }
    function toggleSinFirma(){
        const sf=document.getElementById('checkSinFirma').checked, cu=document.getElementById('container-usuario'), cm=document.getElementById('container-motivo'), cw=document.getElementById('contenedor-firma-wrapper');
        if(sf){cu.style.display='none';cw.style.display='none';cm.style.display='flex';document.getElementById('usuario').value='';}
        else{cu.style.display='flex';cw.style.display='block';cm.style.display='none';document.getElementById('motivoSinFirma').value='';}
        validarYGuardar();
    }
    function comprimirImagen(b64){
        return new Promise(r=>{const i=new Image();i.src=b64;i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height;if(w>1000){h=Math.round((h*1000)/w);w=1000;}c.width=w;c.height=h;const x=c.getContext('2d');x.drawImage(i,0,0,w,h);r(c.toDataURL('image/jpeg',0.5));};i.onerror=()=>r(b64);});
    }
    function manejarFotos(input){if(input.files){Array.from(input.files).forEach(f=>{const r=new FileReader();r.onload=e=>{fotosSeleccionadas.push(e.target.result);agregarPreview(e.target.result,fotosSeleccionadas.length-1);validarYGuardar();};r.readAsDataURL(f);});}input.value='';}
    function agregarPreview(b,i){const c=document.getElementById('previewContainer'),d=document.createElement('div');d.className='image-preview-item';d.dataset.index=i;d.innerHTML=`<img src="${b}"><div class="delete-icon" onclick="borrarFoto(this,'${b}')"><i class="fas fa-times"></i></div>`;c.appendChild(d);}
    function borrarFoto(e,b){const i=fotosSeleccionadas.indexOf(b);if(i>-1)fotosSeleccionadas.splice(i,1);e.parentElement.remove();validarYGuardar();}

    // DB & RESTAURACIÓN
    function triggerAutoSave(){if(!cargandoDatos)guardarBorrador();}
    async function guardarBorrador(){
        if(cargandoDatos)return;
        try{await db.borrador.put({
            id:1,fecha:document.getElementById('fecha').value,checkFolio:document.getElementById('checkFolio').checked,folio:document.getElementById('folio').value,
            dependencia:document.getElementById('dependencia').value,checkTicket:document.getElementById('checkTicket').checked,ticket:document.getElementById('ticket').value,
            checkSinFirma:document.getElementById('checkSinFirma').checked,usuario:document.getElementById('usuario').value,motivoSinFirma:document.getElementById('motivoSinFirma').value,
            descripcion:document.getElementById('descripcion').value,fechaHoraRestriccion:document.getElementById('fechaHoraRestriccion').value,
            checkRepro:document.getElementById('checkRepro').checked,fechaHoraReprogramacion:document.getElementById('fechaHoraReprogramacion').value,
            firmaData:canvas.toDataURL(),fotos:fotosSeleccionadas
        });}catch(e){console.error(e);}
    }

    async function verificarBorrador(){
        try{
            const borrador = await db.borrador.get(1);
            if(borrador){
                Swal.fire({
                    title:'Trabajo Pendiente',text:'Tienes un registro sin finalizar. ¿Recuperar?',icon:'question',
                    showCancelButton:true,confirmButtonText:'Sí, recuperar',cancelButtonText:'No, empezar nuevo',
                    confirmButtonColor:'#3085d6',cancelButtonColor:'#d33'
                }).then(result => {
                    if(result.isConfirmed){
                        cargarDatosBorrador(borrador);
                        Swal.fire({ title: '¡Restaurado!', text: 'Tu sesión ha sido restaurada.', icon: 'success', confirmButtonText: 'OK' });
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        confirmarBorradoDefinitivo(borrador);
                    }
                });
            } else {
                cargarFechaDefault();
                setTimeout(()=>{cargandoDatos=false;validarTodosLosCampos();},100);
            }
        } catch(e) {
            cargarFechaDefault();
            setTimeout(()=>{cargandoDatos=false;validarTodosLosCampos();},100);
        }
    }

    function confirmarBorradoDefinitivo(borradorGuardado) {
        Swal.fire({
            title: '¿Estás 100% seguro?',
            text: "Esta acción es irreversible y todo su progreso se perderá.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Si, borrar todo',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                db.borrador.delete(1);
                cargarFechaDefault();
                document.getElementById('checkSinFirma').checked = false;
                toggleSinFirma();
                // Limpiar visualmente
                document.getElementById('folio').value = '';
                document.getElementById('dependencia').value = '';
                document.getElementById('ticket').value = '';
                document.getElementById('descripcion').value = '';
                document.getElementById('usuario').value = '';
                document.getElementById('motivoSinFirma').value = '';
                document.getElementById('checkFolio').checked = false;
                document.getElementById('checkTicket').checked = false;
                document.getElementById('checkRepro').checked = false;
                toggleInputState('folio','container-folio',document.getElementById('checkFolio'));
                toggleInputState('ticket','container-ticket',document.getElementById('checkTicket'));
                toggleInputState('fechaHoraReprogramacion','container-fechaRepro',document.getElementById('checkRepro'));
                fotosSeleccionadas = [];
                document.getElementById('previewContainer').innerHTML = '';
                clearSignature(false);

                Swal.fire({ title: 'Eliminado', text: 'Se ha borrado el progreso anterior', icon: 'success', confirmButtonText: 'OK' });
                setTimeout(()=>{cargandoDatos=false;validarTodosLosCampos();},100);
            } else {
                cargarDatosBorrador(borradorGuardado);
                Swal.fire({ title: '¡Restaurado!', text: 'Tu sesión ha sido restaurada.', icon: 'success', confirmButtonText: 'OK' });
            }
        });
    }

    function cargarDatosBorrador(d){
        if(d.fecha)document.getElementById('fecha').value=d.fecha;
        document.getElementById('checkFolio').checked=d.checkFolio; toggleInputState('folio','container-folio',document.getElementById('checkFolio')); if(d.folio)document.getElementById('folio').value=d.folio;
        if(d.dependencia)document.getElementById('dependencia').value=d.dependencia;
        document.getElementById('checkTicket').checked=d.checkTicket; toggleInputState('ticket','container-ticket',document.getElementById('checkTicket')); if(d.ticket)document.getElementById('ticket').value=d.ticket;
        if(d.descripcion)document.getElementById('descripcion').value=d.descripcion;
        if(d.fechaHoraRestriccion)document.getElementById('fechaHoraRestriccion').value=d.fechaHoraRestriccion;
        document.getElementById('checkRepro').checked=d.checkRepro; toggleInputState('fechaHoraReprogramacion','container-fechaRepro',document.getElementById('checkRepro')); if(d.fechaHoraReprogramacion)document.getElementById('fechaHoraReprogramacion').value=d.fechaHoraReprogramacion;
        calcularHorasHabiles();
        document.getElementById('checkSinFirma').checked=d.checkSinFirma||false; toggleSinFirma();
        if(d.checkSinFirma){if(d.motivoSinFirma)document.getElementById('motivoSinFirma').value=d.motivoSinFirma;}
        else{if(d.usuario)document.getElementById('usuario').value=d.usuario;if(d.firmaData){const i=new Image();i.src=d.firmaData;i.onload=()=>{if(d.firmaData!==document.createElement('canvas').toDataURL()){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(i,0,0);saveToUndoStack();}};}}
        if(d.fotos){fotosSeleccionadas=d.fotos;document.getElementById('previewContainer').innerHTML='';fotosSeleccionadas.forEach((f,i)=>agregarPreview(f,i));}
        setTimeout(()=>{cargandoDatos=false;validarTodosLosCampos();},200);
    }
    function cargarFechaDefault(){
        const d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
        document.getElementById('fecha').value=d.toISOString().split('T')[0];
        document.getElementById('fechaHoraRestriccion').value=d.toISOString().slice(0,16);
    }

    // ===== OBTENCIÓN DE IMAGEN DE FONDO (SIMPLE) =====
    // Aquí confiamos en que el Service Worker tiene la imagen en caché.
    async function obtenerImagenFondo() {
        const url = 'Imágenes/Otros/HojadeLiberación.jpg';
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Error de fetch');
            const blob = await response.blob();
            
            // Convertimos a base64 SOLO para que jsPDF lo entienda en este momento
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        } catch (error) {
            console.error("Error cargando imagen:", error);
            return null; 
        }
    }

    function calcularHorasHabiles(){
        if(!document.getElementById('checkRepro').checked){$('#horasRestriccion').val("0 hrs 0 min");return;}
        const i=$('#fechaHoraRestriccion').val(), f=$('#fechaHoraReprogramacion').val();
        if(!i||!f){$('#horasRestriccion').val("0 hrs 0 min");return;}
        const di=new Date(i), df=new Date(f); if(df<=di){$('#horasRestriccion').val("0 hrs 0 min");return;}
        let tm=0, curr=new Date(di);
        while(curr<df){
            const n=new Date(curr);n.setHours(curr.getHours()+1);n.setMinutes(0);n.setSeconds(0);n.setMilliseconds(0);
            const finP=(n<df)?n:df;
            if(esHorarioHabil(curr))tm+=(finP-curr);
            curr=finP;
        }
        const minT=Math.floor(tm/60000); $('#horasRestriccion').val(`${Math.floor(minT/60)} hrs ${minT%60} min`);
    }
    function esHorarioHabil(f){const d=f.getDay(),h=f.getHours();return(d!==0&&d!==6&&h>=HORA_INICIO_HABIL&&h<HORA_FIN_HABIL);}
    $('#fechaHoraRestriccion,#fechaHoraReprogramacion').on('change',()=>{calcularHorasHabiles();validarYGuardar();});

    function formatearFechaLatina(f){if(!f)return"";const p=f.split('-');return(p.length!=3)?f:`${p[2]}/${p[1]}/${p[0]}`;}
    function formatearFechaLargaCompleta(iso){
        if(!iso)return{linea1:"",linea2:""};
        const f=new Date(iso);
        let ft=f.toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
        ft=ft.charAt(0).toUpperCase()+ft.slice(1).replace("de 202","del 202");
        const h=f.getHours().toString().padStart(2,'0'), m=f.getMinutes().toString().padStart(2,'0');
        return {linea1:ft,linea2:`Hora: ${h}:${m}`};
    }

    function confirmarYGenerar(){
        const f=document.getElementById('fecha').value, d=document.getElementById('dependencia').value, des=document.getElementById('descripcion').value;
        const sf=document.getElementById('checkSinFirma').checked;
        if(!f||!d||!des){Swal.fire('Campos Vacíos','Revisa los campos en rojo.','warning');return;}
        if(sf){
            if(!document.getElementById('motivoSinFirma').value){Swal.fire('Falta Motivo','','warning');return;}
            if(fotosSeleccionadas.length===0){Swal.fire('Falta Foto','','error');return;}
        }else{
            if(!document.getElementById('usuario').value){Swal.fire('Falta Usuario','','warning');return;}
            if(isCanvasBlank(canvas)&&undoStack.length<=1){Swal.fire('Falta Firma','','warning');return;}
        }
        Swal.fire({title:'Confirmar',text:"¿Generar registro?",icon:'warning',showCancelButton:true,confirmButtonText:'Sí',cancelButtonText:'No'}).then(r=>{if(r.isConfirmed)generarPDFReal();});
    }

    async function generarPDFReal(){
        $('#overlay').css('display','flex');
        try{
            // OBTENER LA IMAGEN (FETCH DIRECTO)
            const imgFondoBase64 = await obtenerImagenFondo();
            
            if (!imgFondoBase64) {
                $('#overlay').hide();
                Swal.fire('Error de Imagen', 'No se pudo cargar la plantilla. Asegúrate de estar conectado o que el Service Worker haya guardado la imagen.', 'error');
                return;
            }

            const f=document.getElementById('fecha').value;
            const dep=document.getElementById('dependencia').value;
            const desc=document.getElementById('descripcion').value;
            const hrs=document.getElementById('horasRestriccion').value;
            const fRes=document.getElementById('fechaHoraRestriccion').value;
            const repro=document.getElementById('checkRepro').checked?document.getElementById('fechaHoraReprogramacion').value:null;
            const fol=document.getElementById('checkFolio').checked?document.getElementById('folio').value:"";
            const tick=document.getElementById('checkTicket').checked?document.getElementById('ticket').value:"";
            const sf=document.getElementById('checkSinFirma').checked;
            const usr=sf?document.getElementById('motivoSinFirma').value:document.getElementById('usuario').value;

            const {jsPDF}=window.jspdf; const doc=new jsPDF('l','mm','letter');
            
            // Usar la imagen obtenida
            doc.addImage(imgFondoBase64,'JPEG',0,0,279.4,215.9);
            
            doc.setFont("helvetica","normal"); doc.setFontSize(10); doc.setTextColor(0,0,0);
            
            doc.text(formatearFechaLatina(f),220,40);
            if(fol)doc.text(fol,220,52);
            doc.text(dep,75,50,{maxWidth:115});

            const cy=91; 
            
            function drawBlock(txt,x,mw){
                doc.setFontSize(8); 
                const lines=doc.splitTextToSize(txt,mw);
                const lh=3.5; 
                const bh=lines.length*lh;
                const sy=cy-(bh/2)+(lh/2)-0.5; 
                doc.text(lines,x,sy);
            }

            if(tick) doc.text(tick,27,cy,{baseline:'middle',align:'left'});
            drawBlock(desc,50,30);
            drawBlock(usr,90,28);

            if(fRes){
                const info=formatearFechaLargaCompleta(fRes);
                const fullTxt=info.linea1+"\n"+info.linea2;
                drawBlock(fullTxt,122,28);
            }

            if(repro){
                const info=formatearFechaLargaCompleta(repro);
                const fullTxt=info.linea1+"\n"+info.linea2;
                drawBlock(fullTxt,155,28);
            } else {
                doc.setFontSize(10); doc.setTextColor(100);
                doc.text("No Aplica",169,cy,{align:'center',baseline:'middle'});
                doc.setTextColor(0);
            }

            doc.setFontSize(8);
            doc.text(hrs,190,cy,{maxWidth:20,baseline:'middle'});

            if(!sf){
                const sig=canvas.toDataURL('image/png');
                doc.addImage(sig,'PNG',219,81,30,20);
            } else {
                doc.setFontSize(10); doc.setTextColor(100);
                doc.text("No Aplica",234,cy,{align:'center',baseline:'middle'});
                doc.setTextColor(0);
            }

            if(fotosSeleccionadas.length>0){
                let pImgs=0; const sx=15,sy=30,gw=85,gh=65,gx=10,gy=20;
                doc.addPage('letter','p'); doc.setFontSize(14); doc.text("Evidencia Fotográfica",108,20,{align:'center'});
                for(let i=0;i<fotosSeleccionadas.length;i++){
                    if(pImgs===6){doc.addPage('letter','p');doc.text("Evidencia Fotográfica",108,20,{align:'center'});pImgs=0;}
                    const row=Math.floor(pImgs/2), col=pImgs%2;
                    const cImg=await comprimirImagen(fotosSeleccionadas[i]);
                    doc.addImage(cImg,'JPEG',sx+(col*(gw+gx)),sy+(row*(gh+gy)),gw,gh);
                    pImgs++;
                }
            }

            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayISO = `${year}-${month}-${day}`; 
            const todayName = `${day}-${month}-${year}`; 
            
            const registrosHoy = await db.registros.filter(r => r.timestamp && r.timestamp.startsWith(todayISO)).count();
            const consecutivo = registrosHoy + 1;

            const pdfName = `${todayName} - Hoja de Liberación - ${consecutivo}.pdf`;

            const blob=doc.output('blob'); const reader=new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend=async function(){
                const item={name:pdfName,data:reader.result,timestamp:new Date().toISOString(),usuario:sf?"SIN FIRMA":document.getElementById('usuario').value};
                await db.registros.add(item); await db.borrador.delete(1);
                actualizarBadge(); $('#overlay').hide(); mostrarDialogoExito(item);
            }
        }catch(e){console.error(e);$('#overlay').hide();Swal.fire('Error','Error PDF','error');}
    }

    async function actualizarBadge(){const c=await db.registros.count();document.getElementById('badgeHistorial').textContent=c;document.getElementById('liberacion-pendiente-button').style.display=c>0?'flex':'none';}
    function mostrarDialogoExito(reg){
        window.tempPdfData=reg.data;window.tempPdfName=reg.name;
        Swal.fire({
            title:'¡Éxito!',
            html:`<div style="text-align:center;margin-top:10px;"><button onclick="descargarAhora('${reg.name}')" class="swal2-confirm swal2-styled" style="background:#2ecc71;margin:5px;"><i class="fas fa-download"></i> Descargar</button>${navigator.share?`<button onclick="compartirAhora()" class="swal2-confirm swal2-styled" style="background:#3498db;margin:5px;"><i class="fas fa-share-alt"></i> Compartir</button>`:''}</div>`,
            icon:'success',showConfirmButton:false,showCloseButton:true
        }).then(()=>location.reload());
    }

    window.mostrarHistorial=async function(){
        const docs=await db.registros.orderBy('id').reverse().toArray();
        if(docs.length===0){Swal.fire('Info','Sin registros.','info');return;}
        let h=`<div class="modal-history-container">`;
        docs.forEach(d=>{
            const dt=new Date(d.timestamp).toLocaleString();
            h+=`
            <div class="history-item" id="item-${d.id}">
                <div class="h-info">
                    <div class="h-title"><i class="fas fa-file-pdf"></i> ${d.name}</div>
                    <div class="h-meta"><span><i class="far fa-user"></i> ${d.usuario||'--'}</span><span><i class="far fa-clock"></i> ${dt}</span></div>
                </div>
                <div class="h-right-panel">
                    <div class="h-actions" id="actions-${d.id}">
                        <button class="h-btn dl" onclick="descargarDesdeDB(${d.id})"><i class="fas fa-download"></i></button>
                        ${navigator.share?`<button class="h-btn sh" onclick="compartirDesdeDB(${d.id})"><i class="fas fa-share-alt"></i></button>`:''}
                        <button class="h-btn del" onclick="confirmarBorradoLista(${d.id})"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="h-confirm" id="confirm-${d.id}">
                        <span class="h-confirm-text">¿Borrar?</span>
                        <button class="h-btn-small bg-yes" onclick="ejecutarBorrado(${d.id})"><i class="fas fa-check"></i></button>
                        <button class="h-btn-small bg-no" onclick="cancelarBorradoLista(${d.id})"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            </div>`;
        });
        h+=`</div>`;
        Swal.fire({title:'Registros Recientes',html:h,showConfirmButton:false,showCloseButton:true,width:'600px',padding:'15px',customClass:{popup:'swal-wide'}});
    };
    window.confirmarBorradoLista=id=>{document.getElementById(`actions-${id}`).style.display='none';document.getElementById(`confirm-${id}`).style.display='flex';};
    window.cancelarBorradoLista=id=>{document.getElementById(`confirm-${id}`).style.display='none';document.getElementById(`actions-${id}`).style.display='flex';};
    window.ejecutarBorrado=async id=>{await db.registros.delete(id);const i=document.getElementById(`item-${id}`);if(i){i.style.backgroundColor="#ffebee";setTimeout(()=>i.remove(),200);}actualizarBadge();const c=await db.registros.count();if(c===0)Swal.close();};
    window.descargarAhora=n=>{const a=document.createElement('a');a.href=window.tempPdfData;a.download=n;document.body.appendChild(a);a.click();document.body.removeChild(a);};
    window.compartirAhora=async()=>{if(!navigator.share)return;try{const r=await fetch(window.tempPdfData),b=await r.blob(),f=new File([b],window.tempPdfName,{type:'application/pdf'});await navigator.share({files:[f]});}catch{}};
    window.descargarDesdeDB=async id=>{const i=await db.registros.get(id);if(i){const a=document.createElement('a');a.href=i.data;a.download=i.name;document.body.appendChild(a);a.click();document.body.removeChild(a);}};
    window.compartirDesdeDB=async id=>{if(!navigator.share)return;const i=await db.registros.get(id);if(i){try{const r=await fetch(i.data),b=await r.blob(),f=new File([b],i.name,{type:'application/pdf'});await navigator.share({files:[f]});}catch{}}};
    
    // Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw-index.js')
                .then(function(registration) { console.log('✅ Service Worker OK'); })
                .catch(function(error) { console.log('❌ Error Service Worker:', error); });
        });
    }

    window.addEventListener('load', () => { initializeCanvas(); verificarBorrador(); });
</script>
</body>
</html>
