<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hoja de Liberación - Pisos Brillantes</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    /* --- Estilos Base --- */
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --dark-color: #34495e;
        --text-color: #333;
        --border-color: #e0e0e0;
        --input-bg: #fff;
        --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f7f6;
        color: var(--text-color);
        line-height: 1.6;
        user-select: none;
        overscroll-behavior: none;
        padding-bottom: 90px;
    }

    /* --- CABECERA --- */
    .header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        text-align: center;
        padding: 18px 0;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: var(--shadow-md);
        width: 100%;
    }

    .form-container {
        width: 96%; 
        max-width: 800px; 
        margin: 25px auto;
        padding: 30px 20px;
        background-color: white;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
        margin-top: 10px;
        font-size: 1.4rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        padding-bottom: 10px;
    }

    h1:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background-color: var(--secondary-color);
    }

    /* --- CONTENEDORES --- */
    .question-container {
        margin-bottom: 15px;
        padding: 15px 18px;
        border-radius: 8px;
        background-color: #ffffff;
        border: 1px solid var(--border-color);
        border-left: 5px solid var(--accent-color); 
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
        justify-content: center;
        transition: border-left-color 0.3s ease, transform 0.2s, box-shadow 0.2s;
    }
    
    .question-container.valid { border-left-color: var(--success-color) !important; }
    .question-container.invalid { border-left-color: var(--accent-color) !important; }
    .question-container.neutral { border-left-color: #bdc3c7 !important; } 

    .question-container:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transform: translateY(-1px);
    }
    
    .question-container label, .label-style {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark-color);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .question-container input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 1rem;
        transition: var(--transition);
        background-color: #fdfdfd;
        color: #495057;
    }

    .question-container input:focus {
        border-color: var(--secondary-color);
        background-color: #fff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .question-container input:disabled {
        background-color: #f8f9fa;
        color: #adb5bd;
        cursor: not-allowed;
        border-style: dashed;
    }

    /* CHECKBOXES */
    .checkbox-wrapper {
        display: flex; align-items: center; margin-bottom: 5px; font-size: 0.9em;
        color: var(--primary-color); cursor: pointer; user-select: none; font-weight: 700;
    }
    .checkbox-wrapper input[type="checkbox"] {
        width: 18px; height: 18px; margin-right: 10px; margin-top: 0;
        cursor: pointer; accent-color: var(--secondary-color); flex-shrink: 0;
    }

    /* --- INTERRUPTOR (SWITCH) --- */
    .switch-container {
        display: flex; align-items: center; justify-content: center; gap: 15px;
        margin-bottom: 25px; padding: 15px; background-color: #f8f9fa;
        border-radius: 12px; border: 1px solid #e9ecef;
    }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:focus + .slider { box-shadow: 0 0 1px var(--accent-color); }
    input:checked + .slider:before { transform: translateX(26px); }
    .slider.round { border-radius: 34px; }
    .slider.round:before { border-radius: 50%; }
    .switch-label { font-weight: bold; color: var(--dark-color); font-size: 1rem; text-transform: uppercase; }

    /* SECCIÓN FIRMA */
    .signature-section {
        margin-top: 35px; padding: 20px;
        border: 1px solid var(--border-color); border-radius: 12px;
        background-color: #fff; text-align: center;
        box-shadow: var(--shadow-sm); border-left: 5px solid var(--accent-color);
        transition: border-left-color 0.3s;
    }
    .signature-section.valid { border-left-color: var(--success-color); }
    .signature-section.neutral { border-left-color: #bdc3c7; }

    .canvas-wrapper {
        border: 2px dashed var(--secondary-color); border-radius: 8px;
        background-color: #ffffff; position: relative; overflow: hidden; margin-bottom: 15px;
    }
    #firmaCanvas {
        width: 100% !important; height: 200px !important; background: #ffffff; 
        touch-action: none; user-select: none; cursor: crosshair; display: block;
    }
    .firma-buttons { display: flex; gap: 10px; justify-content: center; }
    .icon-button {
        background: white; border: 1px solid #ced4da; border-radius: 6px; padding: 8px 14px;
        cursor: pointer; font-size: 16px; color: #555; transition: var(--transition);
    }
    .icon-button:hover { background: #f1f3f5; transform: translateY(-2px); }
    .icon-button.active { background: var(--secondary-color); color: #fff; border-color: var(--secondary-color); }

    /* FOTOS */
    .file-upload {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        width: 100%; min-height: 140px; background-color: #f0f8ff; 
        border: 2px solid var(--secondary-color); border-radius: 10px;
        cursor: pointer; margin-top: 10px; transition: var(--transition); position: relative;
    }
    .file-upload:hover { background-color: #e1f0ff; transform: scale(1.01); }
    .file-upload i { font-size: 3em; margin-bottom: 10px; color: var(--secondary-color); }
    .file-upload-text { font-size: 1em; font-weight: 600; color: var(--primary-color); }
    .file-upload input[type="file"] { display: none !important; }

    .image-preview {
        width: 100%; min-height: 10px; padding: 15px 0; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
    }
    .image-preview-item {
        position: relative; width: 90px; height: 90px; overflow: hidden; border-radius: 8px; 
        border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s;
    }
    .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .delete-icon {
        position: absolute; top: 2px; right: 2px; background: rgba(231, 76, 60, 0.9); color: white;
        border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
        font-size: 12px; cursor: pointer; z-index: 10;
    }

    /* Botones Acción */
    .button-container { display: flex; justify-content: center; margin-top: 30px; }
    #btnGenerar {
        background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border: none; border-radius: 8px;
        padding: 15px 40px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: var(--transition);
        box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3); width: 100%; max-width: 350px; letter-spacing: 0.5px;
    }
    #btnGenerar:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5); }

    /* Estilos Historial */
    .modal-history-container { text-align: left; max-height: 450px; overflow-y: auto; padding: 0; }
    .history-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 15px; border-bottom: 1px solid #eaeaea; transition: background-color 0.2s; min-height: 70px; }
    .history-item:nth-child(odd) { background-color: #ffffff; }
    .history-item:nth-child(even) { background-color: #f8f9fa; }
    .h-info { flex: 1; padding-right: 15px; }
    .h-title { font-weight: 700; color: var(--primary-color); font-size: 0.95rem; margin-bottom: 4px; display: flex; align-items: center; }
    .h-title i { color: #e74c3c; margin-right: 8px; font-size: 1.1em; }
    .h-meta { font-size: 0.8rem; color: #7f8c8d; display: flex; gap: 15px; flex-wrap: wrap; }
    .h-right-panel { display: flex; align-items: center; justify-content: flex-end; min-width: 130px; margin-left: auto; }
    .h-actions { display: flex; gap: 8px; align-items: center; }
    .h-btn { width: 36px; height: 36px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .h-btn.dl { background-color: #e8f8f5; color: #2ecc71; } 
    .h-btn.sh { background-color: #ebf5fb; color: #3498db; }
    .h-btn.del { background-color: #fdedec; color: #e74c3c; }

    /* Flotantes */
    .scroll-button { border: none; border-radius: 50%; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-size: 1.5em; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: var(--transition); position: fixed; z-index: 1000; color: white; }
    #liberacion-pendiente-button { background-color: var(--warning-color); display: none; left: 25px; top: 90px; }
    #liberacion-pendiente-button .badge { position: absolute; top: -5px; right: -5px; background-color: var(--accent-color); color: white; border-radius: 50%; width: 24px; height: 24px; font-size: 0.8em; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid white; }
    #btn-camara-flotante { background-color: var(--secondary-color); left: 25px; bottom: 25px; }

    /* Overlay Carga Corregido */
    #overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(255, 255, 255, 0.95); z-index: 9999;
        flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }
    .spinner { width: 60px; height: 60px; border: 5px solid rgba(52, 152, 219, 0.2); border-radius: 50%; border-top-color: var(--secondary-color); animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
    <div class="header">Pisos Brillantes</div>
    
    <div class="form-container">
        <h1>Datos de la Restricción</h1>

        <div class="question-container" id="container-fecha">
            <label for="fecha">FECHA:</label>
            <input type="date" id="fecha" oninput="validarYGuardar()">
        </div>

        <div class="question-container neutral" id="container-folio">
            <label class="checkbox-wrapper" for="checkFolio">
                <input type="checkbox" id="checkFolio" onchange="toggleInputState('folio', 'container-folio', this); validarYGuardar()">
                <span>Incluir FOLIO</span>
            </label>
            <input type="text" id="folio" placeholder="Ej: 001" disabled style="display: none;" oninput="validarYGuardar()">
        </div>

        <div class="question-container" id="container-dependencia">
            <label for="dependencia">DEPENDENCIA / EDIFICIO / NIVEL:</label>
            <input type="text" id="dependencia" placeholder="Escribe la ubicación completa" oninput="validarYGuardar()">
        </div>

        <h1 style="margin-top: 40px;">Detalle de Restricción</h1>
        
        <div class="table-section">
            <div class="question-container neutral" id="container-ticket">
                <label class="checkbox-wrapper" for="checkTicket">
                    <input type="checkbox" id="checkTicket" onchange="toggleInputState('ticket', 'container-ticket', this); validarYGuardar()">
                    <span>Incluir TICKET</span>
                </label>
                <input type="text" id="ticket" placeholder="Número de Ticket" disabled style="display: none;" oninput="validarYGuardar()">
            </div>
            
            <div class="question-container" id="container-descripcion">
                <label for="descripcion">DESCRIPCIÓN:</label>
                <input type="text" id="descripcion" placeholder="Descripción de la restricción del servicio" oninput="validarYGuardar()">
            </div>
            
            <div class="question-container" id="container-fechaRestriccion">
                <label for="fechaHoraRestriccion">FECHA Y HORA DE RESTRICCIÓN:</label>
                <input type="datetime-local" id="fechaHoraRestriccion" oninput="validarYGuardar()">
            </div>

            <div class="question-container neutral" id="container-fechaRepro">
                <label class="checkbox-wrapper" for="checkRepro">
                    <input type="checkbox" id="checkRepro" onchange="toggleInputState('fechaHoraReprogramacion', 'container-fechaRepro', this); validarYGuardar()">
                    <span>Incluir REPROGRAMACIÓN</span>
                </label>
                <input type="datetime-local" id="fechaHoraReprogramacion" disabled style="display: none;" oninput="validarYGuardar()">
            </div>
            
            <div class="question-container neutral">
                <label for="horasRestriccion">HORAS DE RESTRICCIÓN (Automático):</label>
                <input type="text" id="horasRestriccion" readonly value="0 hrs 0 min">
            </div>
        </div>

        <div class="signature-section" id="seccion-firma">
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="checkSinFirma" onchange="toggleSinFirma(); validarYGuardar()">
                    <span class="slider round"></span>
                </label>
                <span class="switch-label">Opción Sin Firma</span>
            </div>

            <div id="container-usuario" class="question-container">
                <label for="usuario">NOMBRE DE USUARIO / RESPONSABLE:</label>
                <input type="text" id="usuario" placeholder="Nombre completo del responsable" oninput="validarYGuardar()">
            </div>

            <div id="container-motivo" class="question-container" style="display: none;">
                <label for="motivoSinFirma">MOTIVO POR EL QUE NO FIRMA:</label>
                <input type="text" id="motivoSinFirma" placeholder="Especifique la razón" oninput="validarYGuardar()">
            </div>

            <div id="contenedor-firma-wrapper">
                <div class="label-style">FIRMA DEL USUARIO</div>
                <div class="canvas-wrapper">
                    <canvas id="firmaCanvas" width="600" height="200"></canvas>
                </div>
                <div class="firma-buttons">
                    <button type="button" class="icon-button" onclick="ctx.clearRect(0,0,canvas.width,canvas.height); validarYGuardar()">Limpiar Firma</button>
                </div>
            </div>
        </div>

        <div class="question-container" style="margin-top: 20px;" id="seccion-fotos">
            <label><i class="fas fa-camera"></i> EVIDENCIA FOTOGRÁFICA</label>
            <div class="file-upload" onclick="document.getElementById('fotoInput').click()">
                <i class="fas fa-camera"></i>
                <div class="file-upload-text">Toca para tomar foto</div>
                <input type="file" id="fotoInput" accept="image/*" capture="environment" multiple onchange="manejarFotos(this)">
            </div>
            <div class="image-preview" id="previewContainer"></div>
        </div>

        <div class="button-container">
            <button type="button" id="btnGenerar" onclick="confirmarYGenerar()">Generar Registro</button>
        </div>
    </div>

    <button class="scroll-button" id="liberacion-pendiente-button" onclick="mostrarHistorial()">
        <i class="fas fa-download"></i><span class="badge" id="badgeHistorial">0</span>
    </button>
    <button class="scroll-button" id="btn-camara-flotante" onclick="document.getElementById('fotoInput').click()">
        <i class="fas fa-camera"></i>
    </button>

    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Generando Registro...</h4>
            <p>Por favor, espera un momento.</p>
        </div>
    </div>

<script>
    const db = new Dexie("LiberacionDB");
    db.version(2).stores({ registros: '++id, timestamp', borrador: 'id' });
    let fotosSeleccionadas = [];
    let cargandoDatos = true;

    // --- MANEJO DE FIRMA ---
    const canvas = document.getElementById("firmaCanvas");
    const ctx = canvas.getContext("2d");
    let isDrawing = false;

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e.touches[0]); }, {passive: false});
    canvas.addEventListener('touchmove', e => { e.preventDefault(); draw(e.touches[0]); }, {passive: false});
    canvas.addEventListener('touchend', endDraw);

    function startDraw(e) { isDrawing = true; draw(e); }
    function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineWidth = 3; ctx.lineCap = "round"; ctx.strokeStyle = "#000";
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }
    function endDraw() { isDrawing = false; ctx.beginPath(); validarYGuardar(); }

    // --- UI Y VALIDACIONES ---
    function toggleInputState(id, cid, chk) {
        const i = document.getElementById(id);
        i.disabled = !chk.checked;
        i.style.display = chk.checked ? 'block' : 'none';
        document.getElementById(cid).classList.toggle('neutral', !chk.checked);
    }

    function toggleSinFirma() {
        const sf = document.getElementById('checkSinFirma').checked;
        document.getElementById('container-usuario').style.display = sf ? 'none' : 'flex';
        document.getElementById('contenedor-firma-wrapper').style.display = sf ? 'none' : 'block';
        document.getElementById('container-motivo').style.display = sf ? 'flex' : 'none';
    }

    function manejarFotos(input) {
        if (input.files) {
            Array.from(input.files).forEach(f => {
                const reader = new FileReader();
                reader.onload = e => { fotosSeleccionadas.push(e.target.result); renderFotos(); validarYGuardar(); };
                reader.readAsDataURL(f);
            });
        }
    }

    function renderFotos() {
        const p = document.getElementById('previewContainer');
        p.innerHTML = '';
        fotosSeleccionadas.forEach((f, i) => {
            p.innerHTML += `<div class="image-preview-item"><img src="${f}"><div class="delete-icon" onclick="borrarFoto(${i})">x</div></div>`;
        });
    }
    function borrarFoto(i) { fotosSeleccionadas.splice(i,1); renderFotos(); validarYGuardar(); }

    // --- AUTO-GUARDADO Y RECUPERACIÓN (DEXIE) ---
    async function validarYGuardar() {
        if (cargandoDatos) return;
        calcularHoras();
        await db.borrador.put({
            id: 1,
            fecha: document.getElementById('fecha').value,
            folio: document.getElementById('folio').value,
            checkFolio: document.getElementById('checkFolio').checked,
            dependencia: document.getElementById('dependencia').value,
            ticket: document.getElementById('ticket').value,
            checkTicket: document.getElementById('checkTicket').checked,
            descripcion: document.getElementById('descripcion').value,
            fRes: document.getElementById('fechaHoraRestriccion').value,
            fRepro: document.getElementById('fechaHoraReprogramacion').value,
            checkRepro: document.getElementById('checkRepro').checked,
            checkSinFirma: document.getElementById('checkSinFirma').checked,
            usuario: document.getElementById('usuario').value,
            motivo: document.getElementById('motivoSinFirma').value,
            firma: canvas.toDataURL(),
            fotos: fotosSeleccionadas
        });
    }

    async function verificarBorrador() {
        const b = await db.borrador.get(1);
        if (b && (b.dependencia || b.fotos.length > 0)) {
            Swal.fire({
                title: 'Trabajo Pendiente', text: '¿Recuperar progreso?', icon: 'question',
                showCancelButton: true, confirmButtonText: 'Sí, recuperar', cancelButtonText: 'No, empezar nuevo'
            }).then(result => {
                if (result.isConfirmed) {
                    cargarBorrador(b);
                    Swal.fire({ title: '¡Restaurado!', text: 'Tu sesión ha sido restaurada.', icon: 'success' });
                } else {
                    Swal.fire({
                        title: '¿Estás 100% seguro?', text: 'Esta acción es irreversible y todo su progreso se perderá.', icon: 'warning',
                        showCancelButton: true, confirmButtonText: 'Si, borrar todo', cancelButtonText: 'Cancelar'
                    }).then(res => {
                        if (res.isConfirmed) {
                            db.borrador.delete(1);
                            Swal.fire('Eliminado', 'Se ha borrado el progreso anterior', 'success');
                            resetDefault();
                        } else {
                            cargarBorrador(b);
                            Swal.fire({ title: '¡Restaurado!', text: 'Tu sesión ha sido restaurada.', icon: 'success' });
                        }
                    });
                }
            });
        }
        cargandoDatos = false;
        actualizarBadge();
    }

    function cargarBorrador(b) {
        document.getElementById('fecha').value = b.fecha;
        document.getElementById('checkFolio').checked = b.checkFolio; toggleInputState('folio','container-folio', {checked: b.checkFolio});
        document.getElementById('folio').value = b.folio;
        document.getElementById('dependencia').value = b.dependencia;
        document.getElementById('checkTicket').checked = b.checkTicket; toggleInputState('ticket','container-ticket', {checked: b.checkTicket});
        document.getElementById('ticket').value = b.ticket;
        document.getElementById('descripcion').value = b.descripcion;
        document.getElementById('fechaHoraRestriccion').value = b.fRes;
        document.getElementById('checkRepro').checked = b.checkRepro; toggleInputState('fechaHoraReprogramacion','container-fechaRepro', {checked: b.checkRepro});
        document.getElementById('fechaHoraReprogramacion').value = b.fRepro;
        document.getElementById('checkSinFirma').checked = b.checkSinFirma; toggleSinFirma();
        document.getElementById('usuario').value = b.usuario;
        document.getElementById('motivoSinFirma').value = b.motivo;
        fotosSeleccionadas = b.fotos; renderFotos();
        const img = new Image(); img.src = b.firma; img.onload = () => ctx.drawImage(img,0,0);
    }

    function resetDefault() { document.getElementById('fecha').valueAsDate = new Date(); }
    function calcularHoras() {
        const d1 = new Date(document.getElementById('fechaHoraRestriccion').value);
        const d2 = new Date(document.getElementById('fechaHoraReprogramacion').value);
        if (d1 && d2 && d2 > d1) {
            const diff = Math.abs(d2 - d1) / 36e5;
            document.getElementById('horasRestriccion').value = Math.floor(diff) + " hrs " + Math.round((diff % 1) * 60) + " min";
        }
    }

    // --- GENERACIÓN PDF ---
    async function obtenerImagenFondo() {
        try {
            const response = await fetch('Imágenes/Otros/HojadeLiberación.jpg');
            const blob = await response.blob();
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        } catch (e) { return null; }
    }

    async function confirmarYGenerar() {
        if (!document.getElementById('fecha').value || !document.getElementById('dependencia').value) {
            Swal.fire('Campos vacíos', 'Completa la fecha y dependencia', 'warning'); return;
        }
        Swal.fire({ title: 'Confirmar', text: '¿Generar registro?', icon: 'warning', showCancelButton: true }).then(r => { if (r.isConfirmed) generarPDF(); });
    }

    async function generarPDF() {
        document.getElementById('overlay').style.display = 'flex';
        const imgFondo = await obtenerImagenFondo();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'letter');

        if (imgFondo) doc.addImage(imgFondo, 'JPEG', 0, 0, 279, 216);

        doc.setFontSize(10);
        doc.text(document.getElementById('fecha').value.split('-').reverse().join('/'), 220, 40);
        doc.text(document.getElementById('dependencia').value, 75, 50, {maxWidth: 110});

        const cy = 91;
        function drawBlock(txt, x, mw) {
            doc.setFontSize(8);
            const lines = doc.splitTextToSize(txt || "", mw);
            const bh = lines.length * 3.5;
            const sy = cy - (bh/2) + 2;
            doc.text(lines, x, sy);
        }

        if (document.getElementById('checkTicket').checked) doc.text(document.getElementById('ticket').value, 27, cy, {baseline:'middle'});
        drawBlock(document.getElementById('descripcion').value, 50, 30);
        
        const res = document.getElementById('checkSinFirma').checked ? document.getElementById('motivoSinFirma').value : document.getElementById('usuario').value;
        drawBlock(res, 90, 28);

        drawBlock(document.getElementById('fechaHoraRestriccion').value.replace('T',' '), 122, 28);
        const repro = document.getElementById('checkRepro').checked ? document.getElementById('fechaHoraReprogramacion').value.replace('T',' ') : 'N/A';
        drawBlock(repro, 155, 28);
        
        doc.setFontSize(8);
        doc.text(document.getElementById('horasRestriccion').value, 190, cy, {baseline:'middle'});

        if (!document.getElementById('checkSinFirma').checked) {
            doc.addImage(canvas.toDataURL(), 'PNG', 219, 81, 30, 20);
        } else {
            doc.text("S/F", 234, cy, {align:'center'});
        }

        // Nombre de archivo con contador diario
        const fechaArchivo = document.getElementById('fecha').value.split('-').reverse().join('-');
        const hoyISO = new Date().toISOString().split('T')[0];
        const count = await db.registros.filter(r => r.timestamp && r.timestamp.startsWith(hoyISO)).count();
        const nombreFinal = `${fechaArchivo} - Hoja de Liberación - ${count + 1}.pdf`;

        if (fotosSeleccionadas.length > 0) {
            doc.addPage('letter', 'p');
            doc.text("Evidencia Fotográfica", 105, 20, {align:'center'});
            let y = 30;
            fotosSeleccionadas.forEach((f, i) => {
                if (i > 0 && i % 2 === 0) { doc.addPage(); y = 30; }
                doc.addImage(f, 'JPEG', 20, y, 170, 100); y += 110;
            });
        }

        const pdfData = doc.output('datauristring');
        await db.registros.add({ name: nombreFinal, data: pdfData, timestamp: new Date().toISOString() });
        await db.borrador.delete(1);

        document.getElementById('overlay').style.display = 'none';
        Swal.fire('¡Éxito!', 'PDF Generado', 'success').then(() => location.reload());
        doc.save(nombreFinal);
    }

    async function actualizarBadge() {
        const c = await db.registros.count();
        document.getElementById('badgeHistorial').innerText = c;
        document.getElementById('liberacion-pendiente-button').style.display = c > 0 ? 'flex' : 'none';
    }

    async function mostrarHistorial() {
        const regs = await db.registros.toArray();
        let list = regs.map(r => `<li>${r.name}</li>`).join('');
        Swal.fire({ title: 'Registros Recientes', html: `<ul>${list}</ul>` });
    }

    window.onload = () => { initCanvas(); verificarBorrador(); };

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('sw-index.js'); });
    }
</script>
</body>
</html>
