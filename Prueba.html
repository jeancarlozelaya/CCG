<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard Lavados Oasis</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* ESTILOS BASE OASIS */
        :root {
            --primary-color: #16a085;
            --secondary-color: #1abc9c;
            --accent-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
            --dark-color: #2c3e50;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --bg-light: #ecf0f1;
        }

        html, body {
            touch-action: manipulation;
            overflow-x: hidden;
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            color: var(--dark-color);
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            text-align: center;
            padding: 18px 0;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
        }

        .container-custom {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px 50px 15px;
        }

        .card-custom {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: none;
            margin-bottom: 25px;
            border-top: 5px solid var(--secondary-color);
            padding: 20px;
            height: 100%;
        }

        .btn-custom {
            border: none;
            font-weight: 600;
            padding: 10px 25px;
            font-size: 0.95rem;
            border-radius: 50px;
            transition: var(--transition);
            color: white !important;
            background: linear-gradient(45deg, var(--secondary-color), #48c9b0);
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-custom:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }

        .kpi-value { font-size: 2.5rem; font-weight: 800; color: var(--primary-color); }
        .kpi-label { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .kpi-icon { font-size: 2rem; color: var(--secondary-color); margin-bottom: 15px; opacity: 0.8; }

        .chart-box { position: relative; height: 300px; width: 100%; }

        /* SEMANA BADGES */
        .semana-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }
        .semana-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .semana-activa { 
            background: linear-gradient(45deg, var(--secondary-color), #48c9b0);
            color: white;
            border-color: var(--secondary-color);
        }
        .semana-inactiva { 
            background-color: #f8f9fa;
            color: #6c757d;
            border-color: #dee2e6;
        }

        /* TABLA SEMANAL */
        .tabla-semanal {
            font-size: 0.9rem;
        }
        .tabla-semanal th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }
        .tabla-semanal td {
            vertical-align: middle;
        }
        .estado-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .estado-lavado {
            background-color: #d4edda;
            color: #155724;
        }
        .estado-no-lavado {
            background-color: #f8d7da;
            color: #721c24;
        }
        .estado-pendiente {
            background-color: #fff3cd;
            color: #856404;
        }

        /* OVERLAY CARGA */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: none; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column;
        }
        .spinner {
            width: 60px; height: 60px;
            border: 5px solid rgba(26, 188, 156, 0.2);
            border-radius: 50%; border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* MODAL DETALLE SEMANA */
        .modal-detalle-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* PROGRESS BARS */
        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
        }
        .progress-bar-lavado {
            background-color: var(--success-color);
        }
        .progress-bar-no-lavado {
            background-color: var(--accent-color);
        }
        
        /* COLORES ESTADO */
        .text-al-dia { color: var(--success-color); }
        .text-atrasado { color: var(--warning-color); }
        .text-muy-atrasado { color: var(--accent-color); }
        .text-no-lavado { color: #6c757d; }
        
        /* BOTONES DE ACCIÓN */
        .btn-action {
            border: none;
            border-radius: 50px;
            width: 35px;
            height: 35px;
            font-size: 0.85rem;
            margin: 0 2px;
            transition: var(--transition);
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-ver { background: linear-gradient(45deg, var(--secondary-color), #48c9b0); }
        .btn-descargar { background: linear-gradient(45deg, #3498db, #2980b9); }
        .btn-compartir { background: linear-gradient(45deg, #9b59b6, #8e44ad); }
        .btn-eliminar { background: linear-gradient(45deg, #e74c3c, #c0392b); }
    </style>
</head>
<body>

    <div id="overlay">
        <div class="spinner"></div>
        <div id="loadingMessage">
            <h4>Cargando datos de Oasis...</h4>
            <p></p>
        </div>
    </div>

    <!-- Modal Detalle Semana -->
    <div class="modal fade" id="modalDetalleSemana" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-week me-2"></i>
                        Detalle Semana <span id="modalSemanaTitulo"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body modal-detalle-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted">Oasis Lavados</h6>
                                    <h3 id="detalleLavados" class="text-success">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-muted">Oasis No Lavados</h6>
                                    <h3 id="detalleNoLavados" class="text-danger">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Ubicación</th>
                                    <th>Estado</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaDetalleCuerpo"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="header">
        <i class="fas fa-tint me-2"></i>Dashboard Lavados de Oasis
    </div>

    <div class="container-custom">
        
        <!-- Panel de Control -->
        <div class="card-custom">
            <h5 class="mb-3 text-secondary border-bottom pb-2">
                <i class="fas fa-sliders-h me-2"></i>Panel de Control
            </h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Proyecto</label>
                    <select id="filtroProyecto" class="form-select">
                        <option value="" selected disabled>Seleccionar...</option>
                        <option value="ARPIA">ARPIA</option>
                        <option value="ARRIO">ARRIO</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Mes</label>
                    <select id="filtroMes" class="form-select"></select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Año</label>
                    <select id="filtroAnio" class="form-select"></select>
                </div>
                <div class="col-md-2">
                    <button class="btn-custom" onclick="consultarDatosOasis()">
                        <i class="fas fa-search me-1"></i> Consultar
                    </button>
                </div>
            </div>
        </div>

        <div id="dashboardContent" style="display: none;">
            
            <!-- KPI Cards -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="kpi-value" id="kpiLavados">0</div>
                        <div class="kpi-label">Oasis Lavados</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-times-circle"></i></div>
                        <div class="kpi-value" id="kpiNoLavados">0</div>
                        <div class="kpi-label">Oasis No Lavados</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-percentage"></i></div>
                        <div class="kpi-value" id="kpiCumplimiento">0%</div>
                        <div class="kpi-label">Cumplimiento</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-custom text-center">
                        <div class="kpi-icon"><i class="fas fa-calendar-week"></i></div>
                        <div class="kpi-value" id="kpiSemanas">0</div>
                        <div class="kpi-label">Semanas en Mes</div>
                    </div>
                </div>
            </div>

            <!-- Semanas del Mes -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card-custom">
                        <h5 class="mb-3 text-secondary">
                            <i class="fas fa-calendar-alt me-2"></i>Semanas del Mes
                        </h5>
                        <div id="semanasContainer" class="d-flex flex-wrap gap-3 justify-content-center">
                            <!-- Las semanas se generarán dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="chart-box">
                            <canvas id="chartMensual"></canvas>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Oasis lavados vs no lavados por semana
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card-custom">
                        <div class="chart-box">
                            <canvas id="chartAnual"></canvas>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Tendencia anual de lavados de oasis
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla Semanal (NUEVO FORMATO) -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card-custom">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-secondary mb-0">
                                <i class="fas fa-table me-2"></i>Estado de Oasis por Ubicación y Semana
                            </h5>
                            <small class="text-muted">Haz clic en una semana para ver detalles</small>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover tabla-semanal" id="tablaSemanas">
                                <thead>
                                    <tr>
                                        <th style="width: 200px;">Ubicación</th>
                                        <!-- Las columnas de semanas se generarán dinámicamente -->
                                    </tr>
                                </thead>
                                <tbody id="tablaSemanasCuerpo">
                                    <!-- El contenido se generará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de Reportes -->
            <div class="row">
                <div class="col-12">
                    <div class="card-custom">
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <h5 class="text-secondary mb-2 mb-md-0">
                                <i class="fas fa-history me-2"></i>Historial de Reportes
                            </h5>
                            <div class="input-group" style="max-width: 400px; width: 100%;">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-filter text-muted"></i>
                                </span>
                                <input type="text" id="filtroTabla" class="form-control border-start-0" 
                                       placeholder="Buscar por ubicación, semana o estado...">
                            </div>
                        </div>

                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Fecha</th>
                                        <th style="width: 80px;">Semana</th>
                                        <th>Ubicación</th>
                                        <th>Estado</th>
                                        <th class="text-center" style="width: 200px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaHistorialCuerpo"></tbody>
                            </table>
                            <div id="sinResultadosFiltro" class="text-center p-4 text-muted" style="display:none;">
                                No se encontraron resultados con ese filtro.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <div id="alertNoData" class="alert alert-warning text-center mt-4 shadow-sm" style="display:none;">
            <i class="fas fa-info-circle me-2"></i> No existen registros para el mes seleccionado.
        </div>

    </div>

    <script>
        const URL_SCRIPT_GOOGLE_OASIS = "https://script.google.com/macros/s/AKfycbyrHVgBwM3CuxPW-ZEcPFfkVXBpAw84nap1WRkjbioVuTuzmVXp93RzUTCfct6nTgVs7w/exec";
        
        let chartMensual = null;
        let chartAnual = null;
        let datosGlobales = null;
        let modalDetalleSemana = null;
        let semanaSeleccionada = null;
        let proyectoActual = "";

        const mesesNombres = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", 
                             "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        window.onload = function() {
            // Inicializar modal
            modalDetalleSemana = new bootstrap.Modal(document.getElementById('modalDetalleSemana'));
            
            // Configurar filtros de fecha
            const selectMes = document.getElementById('filtroMes');
            mesesNombres.forEach((m, i) => {
                let opt = document.createElement('option');
                opt.value = (i + 1).toString().padStart(2, '0');
                opt.text = m;
                if(i === new Date().getMonth()) opt.selected = true;
                selectMes.appendChild(opt);
            });

            const selectAnio = document.getElementById('filtroAnio');
            const currentYear = new Date().getFullYear();
            const prevYear = currentYear - 1;
            
            let optPrev = document.createElement('option');
            optPrev.value = prevYear;
            optPrev.text = prevYear;
            selectAnio.appendChild(optPrev);

            let optCurr = document.createElement('option');
            optCurr.value = currentYear;
            optCurr.text = currentYear;
            optCurr.selected = true;
            selectAnio.appendChild(optCurr);

            // Configurar filtro de tabla
            document.getElementById('filtroTabla').addEventListener('keyup', filtrarTablaLocal);
        };

        function showLoading(mensaje, submensaje = "") {
            const overlay = document.getElementById('overlay');
            const msgTitle = document.querySelector('#loadingMessage h4');
            const msgSub = document.querySelector('#loadingMessage p');
            if(msgTitle) msgTitle.textContent = mensaje;
            if(msgSub) msgSub.textContent = submensaje;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('overlay').style.display = 'none';
        }

        function consultarDatosOasis() {
            proyectoActual = document.getElementById('filtroProyecto').value;
            const mesVal = document.getElementById('filtroMes').value;
            const anio = document.getElementById('filtroAnio').value;

            if (!proyectoActual) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Proyecto Requerido',
                    text: 'Por favor, selecciona un proyecto para consultar.'
                });
                return;
            }

            showLoading("Cargando datos de Oasis...", "Espere por favor");
            
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('alertNoData').style.display = 'none';

            fetch(URL_SCRIPT_GOOGLE_OASIS, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: "obtenerDatos", 
                    proyecto: proyectoActual, 
                    mes: mesVal, 
                    anio: anio 
                })
            })
            .then(res => res.json())
            .then(data => {
                hideLoading();
                if (data.status === "error") {
                    Swal.fire("Error", data.message, "error");
                    return;
                }
                
                datosGlobales = data.data;
                renderizarDashboardOasis(datosGlobales, mesVal, anio);
                
                if (!datosGlobales.existeHoja || datosGlobales.totalOasis === 0) {
                     document.getElementById('alertNoData').style.display = 'block';
                }
            })
            .catch(err => {
                hideLoading();
                Swal.fire("Error", "Problema de conexión con el servidor.", "error");
            });
        }

        function renderizarDashboardOasis(data, mesVal, anio) {
            document.getElementById('dashboardContent').style.display = 'block';
            
            // Actualizar KPI's
            document.getElementById('kpiLavados').textContent = data.oasisLavados;
            document.getElementById('kpiNoLavados').textContent = data.oasisNoLavados;
            document.getElementById('kpiCumplimiento').textContent = `${data.porcentajeCumplimiento}%`;
            document.getElementById('kpiSemanas').textContent = data.semanasEnMes;
            
            const nombreMes = mesesNombres[parseInt(mesVal) - 1];
            
            // Crear gráfico mensual
            const ctxMensual = document.getElementById('chartMensual');
            if (chartMensual) chartMensual.destroy();
            
            chartMensual = new Chart(ctxMensual, {
                type: 'bar',
                data: {
                    labels: data.datosGraficoMensual.labels.map(s => `Sem ${s}`),
                    datasets: [
                        {
                            label: 'Oasis Lavados',
                            data: data.datosGraficoMensual.lavados,
                            backgroundColor: '#27ae60',
                            borderRadius: 4
                        },
                        {
                            label: 'Oasis No Lavados',
                            data: data.datosGraficoMensual.noLavados,
                            backgroundColor: '#e74c3c',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Lavados por Semana - ${nombreMes} ${anio}`,
                            font: { size: 14 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            title: {
                                display: true,
                                text: 'Semana',
                                font: { weight: 'bold' }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad de Oasis',
                                font: { weight: 'bold' }
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // Crear gráfico anual
            const ctxAnual = document.getElementById('chartAnual');
            if (chartAnual) chartAnual.destroy();
            
            chartAnual = new Chart(ctxAnual, {
                type: 'line',
                data: {
                    labels: data.datosGraficoAnual.labels,
                    datasets: [
                        {
                            label: 'Oasis Lavados',
                            data: data.datosGraficoAnual.lavados,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Oasis No Lavados',
                            data: data.datosGraficoAnual.noLavados,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Tendencia Anual - ${anio}`,
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad de Oasis',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                }
            });

            // Renderizar semanas
            renderizarSemanas(data);
            
            // Renderizar tabla semanal
            renderizarTablaSemanas(data);
            
            // Renderizar historial
            renderizarHistorial(data.listaReportes);
        }

        function renderizarSemanas(data) {
            const container = document.getElementById('semanasContainer');
            container.innerHTML = '';
            
            Object.keys(data.resumenSemanas).sort((a, b) => a - b).forEach(semana => {
                const resumen = data.resumenSemanas[semana];
                const total = resumen.lavados + resumen.noLavados;
                const porcentajeLavados = total > 0 ? Math.round((resumen.lavados / total) * 100) : 0;
                
                const badge = document.createElement('div');
                badge.className = `semana-badge ${semana === semanaSeleccionada ? 'semana-activa' : 'semana-inactiva'}`;
                badge.innerHTML = `
                    <div class="fw-bold">Semana ${semana}</div>
                    <small>${resumen.lavados} lavados / ${total} total</small>
                    <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar progress-bar-lavado" style="width: ${porcentajeLavados}%"></div>
                    </div>
                `;
                
                badge.onclick = () => mostrarDetalleSemana(semana, data);
                
                container.appendChild(badge);
            });
        }

        function renderizarTablaSemanas(data) {
            const thead = document.querySelector('#tablaSemanas thead tr');
            const tbody = document.getElementById('tablaSemanasCuerpo');
            
            // Limpiar contenido previo
            thead.innerHTML = '<th style="width: 200px;">Ubicación</th>';
            tbody.innerHTML = '';
            
            // Crear encabezados de semanas
            Object.keys(data.resumenSemanas).sort((a, b) => a - b).forEach(semana => {
                const th = document.createElement('th');
                th.className = 'text-center';
                th.style.cursor = 'pointer';
                th.innerHTML = `Sem ${semana}<br><small class="text-muted">${data.resumenSemanas[semana].lavados}L</small>`;
                th.onclick = () => mostrarDetalleSemana(semana, data);
                thead.appendChild(th);
            });
            
            // Crear filas para cada ubicación
            Object.keys(data.ubicacionesEstado).sort().forEach(ubicacion => {
                const estado = data.ubicacionesEstado[ubicacion];
                const tr = document.createElement('tr');
                
                // Celda de ubicación
                let ubicacionHTML = `
                    <td class="fw-bold">
                        ${ubicacion}
                        <br>
                        <small class="${getClaseEstado(estado.estadoActual)}">
                            <i class="fas fa-circle me-1" style="font-size: 8px;"></i>
                            ${estado.estadoActual}
                        </small>
                    </td>
                `;
                
                // Celdas de semanas
                Object.keys(data.resumenSemanas).sort((a, b) => a - b).forEach(semana => {
                    const ubicacionEnSemana = data.resumenSemanas[semana].ubicaciones[ubicacion];
                    
                    let contenido = '<span class="text-muted">-</span>';
                    let clase = '';
                    
                    if (ubicacionEnSemana) {
                        if (ubicacionEnSemana.lavado) {
                            contenido = '<i class="fas fa-check text-success"></i>';
                            clase = 'estado-lavado';
                        } else {
                            contenido = `<i class="fas fa-times text-danger" title="${ubicacionEnSemana.motivo}"></i>`;
                            clase = 'estado-no-lavado';
                        }
                    }
                    
                    ubicacionHTML += `<td class="text-center ${clase}">${contenido}</td>`;
                });
                
                tr.innerHTML = ubicacionHTML;
                tbody.appendChild(tr);
            });
        }

        function getClaseEstado(estado) {
            switch(estado) {
                case 'AL DÍA': return 'text-al-dia';
                case 'ATRASADO': return 'text-atrasado';
                case 'MUY ATRASADO': return 'text-muy-atrasado';
                case 'NO LAVADO': return 'text-no-lavado';
                default: return 'text-muted';
            }
        }

        function mostrarDetalleSemana(semana, data) {
            semanaSeleccionada = semana;
            
            showLoading("Cargando detalle...", `Semana ${semana}`);
            
            fetch(URL_SCRIPT_GOOGLE_OASIS, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: "obtenerDetalleSemana", 
                    proyecto: proyectoActual, 
                    semana: semana,
                    mes: document.getElementById('filtroMes').value,
                    anio: document.getElementById('filtroAnio').value
                })
            })
            .then(res => res.json())
            .then(response => {
                hideLoading();
                if (response.status === "error") {
                    Swal.fire("Error", response.message, "error");
                    return;
                }
                
                const detalle = response.data;
                mostrarModalDetalle(semana, detalle);
                
                // Actualizar visualización de semanas
                renderizarSemanas(data);
            })
            .catch(err => {
                hideLoading();
                Swal.fire("Error", "Error al cargar detalle de semana.", "error");
            });
        }

        function mostrarModalDetalle(semana, detalle) {
            document.getElementById('modalSemanaTitulo').textContent = semana;
            document.getElementById('detalleLavados').textContent = detalle.lavados;
            document.getElementById('detalleNoLavados').textContent = detalle.noLavados;
            
            const tbody = document.getElementById('tablaDetalleCuerpo');
            tbody.innerHTML = '';
            
            detalle.detalles.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.fecha}</td>
                    <td>${item.ubicacion} ${item.subUbicacion ? `<small class="text-muted">(${item.subUbicacion})</small>` : ''}</td>
                    <td>
                        <span class="estado-badge ${item.esLavado ? 'estado-lavado' : 'estado-no-lavado'}">
                            ${item.esLavado ? 'Lavado' : 'No Lavado'}
                        </span>
                        ${!item.esLavado ? `<br><small class="text-muted">${item.motivo}</small>` : ''}
                    </td>
                    <td class="text-center">
                        ${item.esLavado ? `
                            <button class="btn btn-action btn-ver" onclick="verPDF('${item.url}')" title="Ver Reporte">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-action btn-descargar" onclick="descargarPDF('${item.url}')" title="Descargar">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-action btn-compartir" onclick="compartirPDF('${item.url}', '${item.ubicacion}', '${item.fecha}')" title="Compartir">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        ` : '<span class="text-muted small">No aplica</span>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            modalDetalleSemana.show();
        }

        function renderizarHistorial(listaReportes) {
            const tbody = document.getElementById('tablaHistorialCuerpo');
            tbody.innerHTML = '';
            
            listaReportes.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.fecha}</td>
                    <td class="text-center">${item.semana || '-'}</td>
                    <td>
                        ${item.ubicacion}
                        ${item.subUbicacion ? `<br><small class="text-muted">${item.subUbicacion}</small>` : ''}
                    </td>
                    <td>
                        <span class="estado-badge ${item.esLavado ? 'estado-lavado' : 'estado-no-lavado'}">
                            ${item.esLavado ? 'Lavado' : 'No Lavado'}
                        </span>
                        ${!item.esLavado ? `<br><small class="text-muted">${item.motivo}</small>` : ''}
                    </td>
                    <td class="text-center">
                        ${item.esLavado ? `
                            <button class="btn btn-action btn-ver" onclick="verPDF('${item.url}')" title="Ver Reporte">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-action btn-descargar" onclick="descargarPDF('${item.url}')" title="Descargar">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-action btn-compartir" onclick="compartirPDF('${item.url}', '${item.ubicacion}', '${item.fecha}')" title="Compartir">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        ` : '<span class="text-muted small">-</span>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filtrarTablaLocal() {
            const texto = document.getElementById('filtroTabla').value.toLowerCase();
            const filas = document.querySelectorAll('#tablaHistorialCuerpo tr');
            let encontrados = 0;
            
            filas.forEach(fila => {
                const textoFila = fila.textContent.toLowerCase();
                if (textoFila.includes(texto)) {
                    fila.style.display = '';
                    encontrados++;
                } else {
                    fila.style.display = 'none';
                }
            });
            
            document.getElementById('sinResultadosFiltro').style.display = encontrados === 0 ? 'block' : 'none';
        }

        // Funciones para manejo de PDFs
        function verPDF(url) {
            if(!url) return;
            window.open(url, '_blank');
        }

        function descargarPDF(url) {
            if (!url) return;
            const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (match) {
                const downloadLink = `https://drive.google.com/uc?export=download&id=${match[1]}`;
                window.open(downloadLink, '_blank');
            }
        }

        async function compartirPDF(url, ubicacion, fecha) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Reporte Oasis ${ubicacion}`,
                        text: `Reporte de lavado de oasis en ${ubicacion} del ${fecha}`,
                        url: url
                    });
                } catch (err) {
                    console.log('Error compartiendo:', err);
                }
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Enlace copiado',
                        text: 'El enlace del reporte se ha copiado al portapapeles.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                });
            }
        }
    </script>
</body>
</html>
