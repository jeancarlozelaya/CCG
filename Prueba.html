<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Supervisión</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<style>
    /* --- INICIO: Estilos Base --- */
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #e74c3c;
        --warning-color: #f39c12;
        --success-color: #2ecc71;
        --dark-color: #34495e;
        --text-color: #333;
        --border-color: #ddd;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
        --light-yellow: #fff9e6;
        /* Colores de Solicitud de Insumos */
        --insumos-primary: #3f7b57;
        --insumos-accent: #2196F3;
        --insumos-light-gray: #f0f2f5;
        --insumos-danger: #ef5350;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--insumos-light-gray);
        color: var(--dark-color);
        line-height: 1.6;
        zoom: 90%;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        color: white;
        text-align: center;
        padding: 18px 0;
        font-size: 1.5rem;
        font-weight: bold;
        box-shadow: var(--shadow);
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 25px;
        font-size: 1.8rem;
        position: relative;
        padding-bottom: 10px;
        font-weight: bold;
    }

    h1:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background-color: var(--secondary-color);
        border-radius: 2px;
    }

    .container {
        max-width: 1200px;
        margin: 25px auto;
        padding: 0 15px;
    }

    .card {
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: none;
        margin-bottom: 25px;
        border-top: 5px solid var(--insumos-primary);
    }
    
    .card-body {
        padding: 2.5rem;
    }
    
    .tab-title {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
        padding: 20px 0;
        position: relative;
    }

    .tab-title h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        display: inline-block;
        padding: 0 25px;
        position: relative;
    }

    .tab-title h2:after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        border-radius: 2px;
    }

    .tab-title h2:before {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 0;
        right: 0;
        height: 1px;
        background-color: var(--border-color);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
    }

    /* Estilos de botones de formulario (Gestión) */
    .btn-primary, .btn-success, .btn-secondary, .btn-danger {
        border: none;
        font-weight: 600;
        padding: 10px 25px;
        font-size: 0.95rem;
        border-radius: 50px;
        min-width: 130px;
        transition: var(--transition);
        color: white !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .btn-primary { background: linear-gradient(45deg, var(--secondary-color), #5dade2); }
    .btn-success { background: linear-gradient(45deg, #2ecc71, #58d68d); }
    
    .btn-secondary { 
        background: linear-gradient(45deg, var(--dark-color), var(--primary-color));
    }
    
    .btn-danger { background: linear-gradient(45deg, var(--accent-color), #e74c3c); }

    /* Botón para limpiar respuestas */
    .btn-warning {
        background: linear-gradient(45deg, #f39c12, #f1c40f);
        border: none;
        font-weight: 600;
        padding: 10px 25px;
        font-size: 0.95rem;
        border-radius: 50px;
        min-width: 130px;
        transition: var(--transition);
        color: white !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .btn-primary:hover, .btn-success:hover, .btn-secondary:hover, .btn-danger:hover, .btn-warning:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }
    
    .btn-primary:disabled {
        background: #ccc;
        box-shadow: none;
        transform: none;
    }

    .form-label {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 8px;
    }

    .area-supervision {
        background-color: #fdfdfd;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
    }
    
    .pregunta-supervision {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap; /* Para móviles */
    }
    
    .pregunta-supervision .form-label {
        margin-bottom: 0;
        flex-basis: 100%; /* Ocupa todo el ancho en la primera línea */
        margin-bottom: 10px; /* Espacio antes de los botones */
    }
    
    .pregunta-supervision .btn-group,
    .toggle-buttons .btn-group { /* (Req 2) Aplicar también a los toggles */
        flex-basis: 100%; /* Ocupa todo el ancho */
        display: flex;
    }

    .pregunta-supervision .btn-group .btn,
    .toggle-buttons .btn-group .btn { /* (Req 2) */
        flex-grow: 1; /* Los botones comparten el espacio */
    }
    
    /* Colores para los botones C/NC/NA y Sí/No */
    .btn-check:checked + .btn-outline-success {
        background-color: var(--success-color);
        color: white;
    }
    .btn-check:checked + .btn-outline-danger {
        background-color: var(--insumos-danger);
        color: white;
    }
    .btn-check:checked + .btn-outline-secondary {
        background-color: var(--secondary-color);
        color: white;
    }
    
    .image-preview {
        width: 100%;
        min-height: 100px; /* Altura mínima para que se vea el dropzone */
        overflow-y: auto;
        border: 1px dashed var(--border-color);
        border-radius: 8px;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        box-sizing: border-box;
        background-color: var(--insumos-light-gray);
        margin-top: 10px;
    }

    .image-preview-item {
        position: relative;
        width: 90px;
        height: 90px;
        overflow: hidden;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease, opacity 0.3s ease; /* Añadida opacidad */
    }

    .image-preview-item:hover {
        transform: translateY(-3px);
    }

    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .delete-icon {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background: var(--insumos-danger);
        color: var(--white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10;
    }

    .image-preview-item:hover .delete-icon {
        opacity: 1;
        transform: scale(1.1);
    }
    
    .image-preview-item.deleting {
        transform: scale(0.8);
        opacity: 0;
    }

    /* Área de carga de archivos */
    .file-upload {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        min-height: 120px;
        background: var(--insumos-light-gray);
        border: 2px dashed var(--insumos-accent);
        border-radius: 10px;
        font-size: 1rem;
        color: var(--insumos-accent);
        cursor: pointer;
        margin-top: 15px;
        box-sizing: border-box;
        transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        text-align: center;
    }

    .file-upload:hover {
        border-color: var(--insumos-primary);
        background-color: rgba(33, 150, 243, 0.08);
        transform: translateY(-2px);
    }

    .file-upload input[type="file"] {
        display: none;
    }

    .file-upload-text {
        margin-top: 10px;
        font-weight: 500;
    }

    .file-upload i {
        font-size: 2.5em;
        color: var(--insumos-accent);
        margin-bottom: 5px;
    }

    .formulario-item {
        border: 1px solid var(--border-color);
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        position: relative;
        background-color: #fdfdfd;
        border-left: 4px solid var(--secondary-color);
    }
    
    /* --- Estilos de Listas (ACTUALIZADO COMPLETO) --- */
    
    /* 1. Layout flexible para todas las listas */
    .lista-calificadas .list-group-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }
    
    /* 2. Efectos Hover y Active para todas las listas */
    .lista-calificadas .list-group-item:hover,
    .lista-calificadas .list-group-item.active {
        background-color: #f0f8ff;
        font-weight: bold;
        color: var(--dark-color); /* Asegura contraste en active */
    }
    
    /* 3. Tamaño de botones de borrar (Basurero) */
    .btn-delete-item {
        padding: 3px 8px;
        font-size: 0.8rem;
    }

    .pagina {
        display: none; /* Oculto por defecto */
        animation: fadeIn 0.5s;
    }
    .pagina.active {
        display: block; /* Visible si está activo */
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .progress {
        height: 25px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    /* --- INICIO: Estilos Confirmar Borrado - CORREGIDO --- */
    .delete-confirm {
        display: none !important; /* Oculto por defecto */
        gap: 5px;
    }
    
    .list-group-item.is-deleting .delete-confirm {
        display: flex !important; /* Mostrar al confirmar */
    }
    
    /* 4. Ocultar basurero cuando se pide confirmación - CORREGIDO */
    .list-group-item.is-deleting .btn-delete-item {
        display: none !important; 
    }
    
    /* Asegurar que el botón delete original tenga la clase correcta */
    .lista-calificadas .list-group-item .btn-danger.btn-sm {
        display: inline-block !important;
    }
    
    .lista-calificadas .list-group-item.is-deleting .btn-danger.btn-sm {
        display: none !important;
    }
    
    .delete-confirm .btn {
        padding: 3px 8px;
        font-size: 0.8rem;
    }
    /* --- FIN: Estilos Confirmar Borrado --- */

    /* --- Estilos para Comentarios de No Conformidad --- */
    .comentario-nc-container {
        display: none; /* Oculto por defecto */
        margin-top: 10px;
        width: 100%;
        animation: slideDown 0.3s ease-out;
    }

    .comentario-nc-container textarea {
        background-color: #fff5f5; /* Fondo rojizo muy suave */
        border: 1px solid #ef5350; /* Borde rojo acorde al botón No Cumple */
        font-size: 0.9rem;
        resize: vertical;
        border-radius: 6px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
    }

    .comentario-nc-container textarea:focus {
        background-color: #fff;
        box-shadow: 0 0 0 0.25rem rgba(239, 83, 80, 0.25);
        border-color: #ef5350;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- Estilos Botón Flotante --- */
    .btn-flotante {
        position: fixed;
        bottom: 25px;
        left: 25px; /* Izquierda */
        width: 65px;
        height: 65px;
        background: linear-gradient(45deg, var(--secondary-color), #2980b9);
        color: white;
        border: none;
        border-radius: 50%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        z-index: 9999;
        font-size: 1.8rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-flotante:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    }
    
    .btn-flotante:active {
        transform: scale(0.95);
    }

    /* --- Estilos Modal Cámara --- */
    .camera-modal .modal-dialog {
        max-width: 100%;
        height: 100vh;
        margin: 0;
    }
    
    .camera-modal .modal-content {
        height: 100vh;
        border-radius: 0;
        background-color: #000;
    }
    
    .camera-modal .modal-header {
        border-bottom: 1px solid #333;
        background-color: #000;
        color: white;
        z-index: 1000;
    }
    
    .camera-modal .modal-body {
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #000;
        overflow: hidden;
    }
    
    .camera-modal .modal-footer {
        border-top: 1px solid #333;
        background-color: #000;
        z-index: 1000;
    }
    
    .camera-container {
        width: 100%;
        height: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .camera-view {
        width: 100%;
        height: calc(100vh - 120px);
        background-color: #000;
        overflow: hidden;
        position: relative;
    }
    
    #camera-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1); /* Espejo para simular selfie */
    }
    
    .camera-controls {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 30px;
        z-index: 100;
    }
    
    .camera-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 3px solid white;
        background-color: rgba(0, 0, 0, 0.3);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .camera-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
    }
    
    .camera-btn:active {
        transform: scale(0.95);
    }
    
    .camera-btn.capture {
        width: 80px;
        height: 80px;
        background-color: white;
        color: #333;
        font-size: 30px;
    }
    
    .camera-btn.capture:hover {
        background-color: #f0f0f0;
    }
    
    .zoom-controls {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 100;
    }
    
    .zoom-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
    }
    
    .zoom-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .flash-control {
        position: absolute;
        left: 20px;
        top: 20px;
        z-index: 100;
    }
    
    .flash-btn {
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border: 2px solid white;
        border-radius: 25px;
        padding: 8px 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .flash-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .flash-btn.active {
        background-color: #f39c12;
        color: #000;
    }
    
    .camera-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .focus-box {
        width: 150px;
        height: 150px;
        border: 3px solid rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }
    
    .camera-message {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        text-align: center;
        color: white;
        font-size: 18px;
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 100;
    }
    
    /* Estado cuando no hay cámara */
    .no-camera .camera-view {
        background-color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        text-align: center;
        padding: 20px;
    }
    
    .no-camera .camera-controls {
        display: none;
    }
    
    .no-camera .zoom-controls {
        display: none;
    }
    
    .no-camera .flash-control {
        display: none;
    }

</style>

</head>
<body>
    
    <div class="header">Pisos Brillantes</div>

    <img id="logo-loader" src="" style="display: none;" alt="Logo">

    <div class="container">
        <h1>Reporte de Supervisión</h1>

        <div class="card">
            <div class="card-body p-4 p-md-5">

                <div class="progress mb-4" role="progressbar" aria-label="Progreso de supervisión" aria-valuenow="12.5" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar" id="progress-bar" style="width: 12.5%">Paso 1</div>
                </div>

                <form id="form-supervision">
                    
                    <!-- PÁGINA 1: UBICACIÓN (FIJA) -->
                    <div id="pagina-1" class="pagina active">
                        <div class="tab-title">
                            <h2>Ubicación</h2>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="fecha-supervision" class="form-label">Fecha</label>
                                <input type="date" class="form-control auto-save" id="fecha-supervision" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="select-proyecto" class="form-label">Proyecto</label>
                                <select class="form-select auto-save" id="select-proyecto" required>
                                    <option value="">Seleccionar...</option>
                                    <!-- Las opciones se cargan dinámicamente -->
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="select-ubicacion" class="form-label">Ubicación</label>
                                <select class="form-select auto-save" id="select-ubicacion" required disabled>
                                    <option value="">Seleccione un proyecto primero...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <button type="button" class="btn btn-primary btn-navegacion" data-pagina-actual="1" data-direccion="siguiente" id="btn-pag1-siguiente" disabled>
                                Siguiente <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- CONTENEDOR PARA PÁGINAS DINÁMICAS -->
                    <div id="contenedor-paginas-dinamicas"></div>

                </form>

            </div>
        </div>
    </div>

    <!-- Modal de Cámara (solo para desktop) -->
    <div class="modal fade camera-modal" id="cameraModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-camera me-2"></i>Cámara
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="camera-container">
                        <div class="camera-view">
                            <video id="camera-video" autoplay playsinline></video>
                            <canvas id="camera-canvas" style="display:none;"></canvas>
                            <div class="camera-overlay">
                                <div class="focus-box"></div>
                            </div>
                            <div id="camera-message" class="camera-message" style="display:none;">
                                No se pudo acceder a la cámara
                            </div>
                        </div>
                        <div class="flash-control">
                            <button class="flash-btn" id="flash-toggle">
                                <i class="fas fa-bolt"></i>
                                <span>Flash</span>
                            </button>
                        </div>
                        <div class="zoom-controls">
                            <button class="zoom-btn" id="zoom-in">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="zoom-btn" id="zoom-out">
                                <i class="fas fa-search-minus"></i>
                            </button>
                        </div>
                        <div class="camera-controls">
                            <button class="camera-btn" id="switch-camera" title="Cambiar cámara">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="camera-btn capture" id="capture-btn" title="Tomar foto">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button class="camera-btn" id="close-camera" data-bs-dismiss="modal" title="Cerrar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="btn-camara-flotante" type="button" class="btn-flotante" style="display: none;">
        <i class="fas fa-camera"></i>
    </button>
    
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
<script>
        
// =========================================================================
// CONFIGURACIÓN CENTRALIZADA - AQUÍ SE AGREGAN/ELIMINAN PÁGINAS
// =========================================================================

/**
 * CONFIGURACIÓN COMPLETA DE PÁGINAS
 * 
 * Para agregar una nueva página:
 * 1. Añade un objeto en PAGES_CONFIG con sus propiedades
 * 2. Añade las preguntas en QUESTIONS_CONFIG
 * 3. El sistema manejará automáticamente: navegación, validación, PDF, etc.
 */

const PAGES_CONFIG = [
    // Página 1 - Ubicación (fija, ya existe en HTML)
    {
        id: 'pagina-1',
        tipo: 'fija',
        titulo: 'Ubicación',
        orden: 1
    },
    
    // PÁGINAS SIMPLES (una sola sección)
    {
        id: 'pagina-banos',
        tipo: 'simple',
        titulo: 'Baños Públicos',
        areaKey: 'banos',
        preguntaToggle: '¿Desea calificar Baños?',
        orden: 2,
        icono: 'fa-toilet',
        fotosRequeridas: true
    },
    {
        id: 'pagina-espacios',
        tipo: 'simple',
        titulo: 'Espacios Abiertos',
        areaKey: 'espacios',
        preguntaToggle: '¿Desea calificar Espacios Abiertos (Lobbies, Pasillos)?',
        orden: 3,
        icono: 'fa-tree',
        fotosRequeridas: true
    },
    {
        id: 'pagina-comedor',
        tipo: 'simple',
        titulo: 'Comedor',
        areaKey: 'comedor',
        preguntaToggle: '¿Desea calificar el Comedor?',
        orden: 4,
        icono: 'fa-utensils',
        fotosRequeridas: true
    },
    
    // PÁGINAS MÚLTIPLES (múltiples instancias)
    {
        id: 'pagina-juntas',
        tipo: 'multiple',
        titulo: 'Sala de Juntas',
        areaKey: 'juntas',
        preguntaToggle: '¿Desea calificar Sala de Juntas?',
        orden: 5,
        icono: 'fa-users-rays',
        nombreItem: 'Sala',
        inputPlaceholder: 'Nombre/ID de Sala',
        previewId: 'preview-juntas',
        fotosRequeridas: true
    },
    {
        id: 'pagina-oficinas',
        tipo: 'multiple',
        titulo: 'Oficinas Privadas',
        areaKey: 'oficina',
        preguntaToggle: '¿Desea calificar Oficinas Privadas?',
        orden: 6,
        icono: 'fa-door-closed',
        nombreItem: 'Oficina',
        inputPlaceholder: 'Número/Nombre de Oficina',
        previewId: 'preview-oficina',
        fotosRequeridas: true
    },
    
    // Página Final (fija)
    {
        id: 'pagina-final',
        tipo: 'fija',
        titulo: 'Comentarios Finales',
        orden: 7
    }
];

/**
 * CONFIGURACIÓN DE PREGUNTAS POR ÁREA
 */
const QUESTIONS_CONFIG = {
    'banos': [
        "¿El área se encuentra aromatizada?",
        "¿Se observa presencia de telas de araña?",
        "¿Pisos limpios, secos y sin basura?",
        "¿Las ventanas y demás vidrios se encuentran limpios?",
        "¿Paredes/azulejos se encuentran limpios y sin manchas visibles?",
        "¿Las puertas se encuentran limpias y sin manchas visibles?",
        "¿Las divisiones (puertas / acrílicos, etc) se encuentran limpias y sin manchas visibles?",
        "¿Los lavamanos están limpios, libres de sarro y en funcionamiento?",
        "¿Los espejos están limpios y sin presencia de manchas?",
        "¿Los sanitarios están limpios, libres de sarro y en funcionamiento?",
        "¿Los urinarios están limpios, libres de sarro y en funcionamiento?",
        "¿Las griferías están limpias y sin manchas visibles?",
        "¿Los basureros se encuentran limpios, con su respectiva bolsa y sin malos olores?",
        "¿Los dispensadores (papel toalla y jabón) están limpios, abastecidos y en funcionamiento?"
    ],
    'espacios': [
        "¿Pisos y alfombras se encuentran limpios, aspirados y sin residuos?",
        "¿Superficies (escritorios, mesas, mostradores) están limpias y libres de polvo?",
        "¿Mobiliario (estanterías, archivadores, gabinetes) están limpios y libres de polvo?",
        "¿Sillas se encuentran limpias, libres de polvo y ordenadas en su lugar?",
        "¿Divisiones de cubículos y paredes están limpias y sin manchas visibles?",
        "¿Interruptores de luz y otras superficies de alto contacto del área están limpios?",
        "¿Cristales de ventanas limpios y sin manchas visibles?",
        "¿Se ha vaciado la basura de todas las papeleras del área?",
        "¿El área se encuentra libre de malos olores y/o está aromatizada?",
        "¿La terraza se encuentra libre de basura, colillas y desechos visibles?",
        "¿El piso de la se encuentra barrido, sin polvo o manchas notorias?",
        "¿Mesas, sillas y mobiliario de terraza limpios y ordenados en su lugar?"
    ],
    'comedor': [
        "¿Piso de alfombra limpio, aspirado y libre de migas, residuos de comida o manchas?",
        "¿Mesas limpias, sin migas y sin residuos de alimentos o líquidos?",
        "¿Sillas limpias, sin migas y correctamente alineadas en su lugar?",
        "¿Paredes y zócalos libres de salpicaduras, manchas o marcas de manos?",
        "¿Interruptores de luz y otras superficies de alto contacto del área están limpios?",
        "¿Cristales de ventanas limpios y sin manchas visibles?",
        "¿Los basureros se encuentran limpios y sin malos olores?"
    ],
    'juntas': [
        "¿Pisos y alfombras se encuentran limpios, aspirados y sin residuos?",
        "¿Superficies de alto contacto (manijas de puerta, interruptores) están limpias?",
        "¿La mesa de reunión y las superficies auxiliares están limpias?",
        "¿Sillas se encuentran limpias, libres de polvo y ordenadas en su lugar?",
        "¿Mobiliario (estanterías, archivadores) están limpios y libres de polvo?",
        "¿Paredes están limpias y sin manchas visibles?",
        "¿Cristales de ventanas limpios y sin manchas visibles?",
        "¿Se ha vaciado la basura de todas las papeleras del área?",
        "¿El área se encuentra libre de malos olores y/o está aromatizada?"
    ],
    'oficina': [
        "¿Oficina: Pisos y alfombras se encuentran limpios, aspirados y sin residuos?",
        "¿Oficina: Superficies (escritorios, mesas) están limpias y libres de polvo?",
        "¿Oficina: Mobiliario (estanterías, archivadores) se encuentra libre de polvo?",
        "¿Oficina: Sillas se encuentran limpias, libres de polvo y ordenadas?",
        "¿Oficina: Paredes están limpias y sin manchas visibles?",
        "¿Oficina: Parte superior de mochetas y divisiones libres de polvo?",
        "¿Oficina: Puertas (ambos lados) y sus marcos están limpios y sin manchas?",
        "¿Oficina: Superficies de alto contacto (manijas de puerta, interruptores) están limpios?",
        "¿Oficina: Se ha vaciado la basura de todas las papeleras del área?",
        "¿Oficina: La oficina se encuentra libre de malos olores y/o está aromatizada?",
        "¿Baños: El área se encuentra aromatizada?",
        "¿Baños: Se observa presencia de telas de araña?",
        "¿Baños: Pisos limpios, secos y sin basura?",
        "¿Baños: Las ventanas y demás vidrios se encuentran limpios?",
        "¿Baños: Paredes/azulejos se encuentran limpios y sin manchas visibles?",
        "¿Baños: Los lavamanos están limpios, libres de sarro y en funcionamiento?",
        "¿Baños: Los espejos están limpios y sin presencia de manchas?",
        "¿Baños: Los sanitarios están limpios, libres de sarro y en funcionamiento?",
        "¿Baños: Las griferías están limpias y sin manchas visibles?",
        "¿Baños: Los basureros se encuentran limpios, con su respectiva bolsa y sin malos olores?",
        "¿Baños: Los dispensadores (papel y jabón) están limpios, abastecidos y en funcionamiento?"
    ]
};

// =========================================================================
// CONFIGURACIONES ADICIONALES
// =========================================================================

const SESSION_KEY = 'supervisionSessionData';
const DB_NAME = 'SupervisionImageDB';
const STORE_NAME = 'images';                
let db; // Variable global para la base de datos

// CONFIGURACIÓN DINÁMICA DE PROYECTOS Y UBICACIONES
// Aquí es donde puedes agregar o eliminar proyectos y ubicaciones
const CONFIG_PROYECTOS = {
    // Proyectos disponibles con sus ubicaciones
    proyectos: {
        "ARPIA": ["Administración", "Sala de Control", "Enfermería"],
        "ARRIO": ["Camerinos", "Lactancia", "Taller Eléctrico"]
    },
    
    // CONFIGURACIÓN DE FILTROS POR PROYECTO/UBICACIÓN
    // Esto controla qué páginas se muestran según el proyecto y ubicación seleccionados
    filtros: {
        // Si no se especifica filtro, se muestran todas las páginas
        // Ejemplo 1: Para ARPIA mostrar todas las ubicaciones y todas las páginas
        'ARPIA': {
            ubicaciones: null, // null = todas las ubicaciones
            paginas: null // null = todas las páginas
        },
        // Ejemplo 2: Para ARRIO solo mostrar Camerinos y solo ciertas páginas
        'ARRIO': {
            ubicaciones: ['Camerinos'], // Solo Camerinos
            paginas: ['pagina-banos', 'pagina-espacios'] // Solo estas páginas
        },
        'ARRIO': {
            ubicaciones: ['Lactancia'], // Solo Camerinos
            paginas: null // null = todas las páginas
        }



    }
};

// Variable global para las páginas disponibles según filtro
let paginasDisponibles = [...PAGES_CONFIG];

// Mapa de ubicaciones por proyecto (se inicializa dinámicamente)
let ubicacionesPorProyecto = {};

// =========================================================================
// VARIABLES GLOBALES Y ESTADO
// =========================================================================

// Almacén para IDs de fotos (se llena dinámicamente)
let selectedFiles = {};

// Almacenes para datos múltiples (se llenan dinámicamente)
let multipleData = {};

// Variables globales
let $form, $progressBar;
let logoBase64_Cache = null;

// Variables para página 1
let $selectProyecto, $selectUbicacion, $fechaInput, $btnPag1Siguiente;

// Variables para cámara
let currentPreviewId = null;
let cameraStream = null;
let currentFacingMode = 'environment';
let zoomLevel = 1;
let flashOn = false;

// =========================================================================
// FUNCIONES DE DETECCIÓN DE DISPOSITIVO
// =========================================================================

/**
 * Detecta si es un dispositivo móvil
 */
function esDispositivoMovil() {
    // Lista blanca de User Agents móviles
    const userAgent = navigator.userAgent.toLowerCase();
    
    // Solo dispositivos móviles claramente identificados
    const esMovil = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile/i.test(userAgent);
    
    // Verificación adicional: plataforma
    const plataforma = navigator.platform.toLowerCase();
    const esPlataformaMovil = /android|iphone|ipad|ipod/i.test(plataforma);
    
    // Solo retorna true si es claramente un dispositivo móvil
    return esMovil || esPlataformaMovil;
}

// =========================================================================
// FUNCIONES DE INICIALIZACIÓN DINÁMICA
// =========================================================================

/**
 * Inicializa los proyectos y ubicaciones desde la configuración
 */
function inicializarProyectosUbicaciones() {
    // Actualizar ubicacionesPorProyecto desde la configuración
    ubicacionesPorProyecto = { ...CONFIG_PROYECTOS.proyectos };
    
    // Llenar select de proyectos
    $selectProyecto.empty();
    $selectProyecto.append('<option value="">Seleccionar...</option>');
    
    Object.keys(ubicacionesPorProyecto).forEach(proyecto => {
        $selectProyecto.append(`<option value="${proyecto}">${proyecto}</option>`);
    });
}

/**
 * Filtra las páginas disponibles según el proyecto y ubicación seleccionados
 */
function filtrarPaginasDisponibles(proyecto, ubicacion) {
    const filtro = CONFIG_PROYECTOS.filtros[proyecto];
    
    if (!filtro) {
        // Si no hay filtro para este proyecto, mostrar todas las páginas
        paginasDisponibles = [...PAGES_CONFIG];
        return;
    }
    
    // Verificar filtro de ubicación
    if (filtro.ubicaciones && filtro.ubicaciones.length > 0) {
        if (!filtro.ubicaciones.includes(ubicacion)) {
            // Si la ubicación no está en la lista permitida, no mostrar páginas
            paginasDisponibles = PAGES_CONFIG.filter(p => p.id === 'pagina-1' || p.id === 'pagina-final');
            return;
        }
    }
    
    // Verificar filtro de páginas
    if (filtro.paginas && filtro.paginas.length > 0) {
        paginasDisponibles = PAGES_CONFIG.filter(p => 
            p.id === 'pagina-1' || 
            p.id === 'pagina-final' || 
            filtro.paginas.includes(p.id)
        );
    } else {
        // Si no hay filtro de páginas, mostrar todas
        paginasDisponibles = [...PAGES_CONFIG];
    }
}

/**
 * Genera el HTML para una pregunta individual
 */
function generateQuestionHTML(prefix, index, questionText) {
    const name = `${prefix.replace('_', '-')}-p${index}`;
    return `
        <div class="pregunta-supervision mb-3">
            <label class="form-label">${index + 1}. ${questionText}</label>
            <div class="btn-group auto-save" role="group">
                <input type="radio" class="btn-check" name="${name}" id="${name}-c" value="C" autocomplete="off">
                <label class="btn btn-outline-success" for="${name}-c">Cumple</label>
                
                <input type="radio" class="btn-check" name="${name}" id="${name}-nc" value="NC" autocomplete="off">
                <label class="btn btn-outline-danger" for="${name}-nc">No Cumple</label>
                
                <input type="radio" class="btn-check" name="${name}" id="${name}-na" value="NA" autocomplete="off">
                <label class="btn btn-outline-secondary" for="${name}-na">No Aplica</label>
            </div>
            
            <div id="comentario-${name}" class="comentario-nc-container">
                <label class="form-label mt-2" style="font-size: 0.85rem; font-weight: bold; color: #d32f2f;">¿Por qué no cumple?</label>
                <textarea class="form-control auto-save-comment" id="obs-${name}" rows="2" placeholder="Describa la no conformidad..."></textarea>
            </div>
        </div>
    `;
}

/**
 * Genera el HTML para una página SIMPLE
 */
function generateSimplePageHTML(pageConfig) {
    const { id, titulo, areaKey, preguntaToggle, icono } = pageConfig;
    const previewId = `preview-${areaKey}`;
    
    // Inicializar arrays si no existen
    if (!selectedFiles[previewId]) selectedFiles[previewId] = [];
    
    return `
        <div id="${id}" class="pagina">
            <div class="tab-title">
                <h2>${titulo}</h2>
            </div>
            
            <div class="mb-3 toggle-buttons">
                <label class="form-label d-block">${preguntaToggle}</label>
                <div class="btn-group auto-save" role="group">
                    <input type="radio" class="btn-check toggle-area" name="calificar-${areaKey}" id="calificar-${areaKey}-si" value="si" data-target="#area-${areaKey}" autocomplete="off">
                    <label class="btn btn-outline-success" for="calificar-${areaKey}-si"><i class="fas fa-check me-2"></i> Sí</label>
                    
                    <input type="radio" class="btn-check toggle-area" name="calificar-${areaKey}" id="calificar-${areaKey}-no" value="no" data-target="#area-${areaKey}" autocomplete="off" checked>
                    <label class="btn btn-outline-danger" for="calificar-${areaKey}-no"><i class="fas fa-times me-2"></i> No</label>
                </div>
            </div>

            <div id="area-${areaKey}" class="area-supervision" style="display: none;">
                <hr>
                <h5 class="mb-3"><i class="fas ${icono} me-2"></i>Calificación de ${titulo}</h5>
                <div id="preguntas-${areaKey}-container"></div>
                <div class="seccion-fotos mb-3 mt-4">
                    <label class="form-label">Tomar Fotos (Req. 1 o más si marca "Sí")</label>
                    <div class="file-upload" onclick="openCamera('${previewId}')">
                        <i class="fas fa-camera"></i>
                        <span class="file-upload-text">Haz clic para tomar fotos con la cámara</span>
                    </div>
                    <div id="${previewId}" class="image-preview"></div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary btn-navegacion" data-pagina-actual="${id}" data-direccion="retroceder">
                    <i class="fas fa-arrow-left me-2"></i> Retroceder
                </button>
                <button type="button" class="btn btn-primary btn-navegacion" data-pagina-actual="${id}" data-direccion="siguiente">
                    Siguiente <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    `;
}

/**
 * Genera el HTML para una página MÚLTIPLE
 */
function generateMultiplePageHTML(pageConfig) {
    const { id, titulo, areaKey, preguntaToggle, icono, nombreItem, inputPlaceholder, previewId } = pageConfig;
    
    // Inicializar arrays si no existen
    if (!selectedFiles[previewId]) selectedFiles[previewId] = [];
    if (!multipleData[areaKey]) multipleData[areaKey] = [];
    
    return `
        <div id="${id}" class="pagina">
            <div class="tab-title">
                <h2>${titulo}</h2>
            </div>
            
            <div class="mb-3 toggle-buttons">
                <label class="form-label d-block">${preguntaToggle}</label>
                <div class="btn-group auto-save" role="group">
                    <input type="radio" class="btn-check toggle-area" name="calificar-${areaKey}" id="calificar-${areaKey}-si" value="si" data-target="#area-${areaKey}" autocomplete="off">
                    <label class="btn btn-outline-success" for="calificar-${areaKey}-si"><i class="fas fa-check me-2"></i> Sí</label>
                    
                    <input type="radio" class="btn-check toggle-area" name="calificar-${areaKey}" id="calificar-${areaKey}-no" value="no" data-target="#area-${areaKey}" autocomplete="off" checked>
                    <label class="btn btn-outline-danger" for="calificar-${areaKey}-no"><i class="fas fa-times me-2"></i> No</label>
                </div>
            </div>

            <div id="area-${areaKey}" class="area-supervision" style="display: none;">
                <hr>
                <h5 class="mb-3"><i class="fas ${icono} me-2"></i>Calificación de ${titulo}</h5>
                
                <label class="form-label">${titulo} Calificadas:</label>
                <div id="lista-${areaKey}-calificadas" class="list-group mb-3 lista-calificadas"></div>
                
                <div id="formulario-${areaKey}-reutilizable" class="formulario-item">
                    <h5 id="titulo-form-${areaKey}">Nueva ${nombreItem}</h5>
                    <input type="hidden" id="${areaKey}-edit-index" value="-1"> 
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="${areaKey}-num-reutilizable" class="form-label">${inputPlaceholder}</label>
                            <input type="text" class="form-control auto-save" id="${areaKey}-num-reutilizable" required>
                        </div>
                    </div>
                    
                    <div id="preguntas-${areaKey}-container"></div>
                    
                    <div class="seccion-fotos mb-3 mt-4">
                        <label class="form-label">Tomar Fotos (Req. 1 o más)</label>
                        <div class="file-upload" onclick="openCamera('${previewId}')">
                            <i class="fas fa-camera"></i>
                            <span class="file-upload-text">Haz clic para tomar fotos con la cámara</span>
                        </div>
                        <div id="${previewId}" class="image-preview"></div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-3">
                    <button type="button" class="btn btn-warning" id="btn-limpiar-${areaKey}">
                        <i class="fas fa-broom me-2"></i> Limpiar
                    </button>
                    <button type="button" class="btn btn-success" id="btn-guardar-${areaKey}">
                        <i class="fas fa-save me-2"></i> Guardar ${nombreItem}
                    </button>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary btn-navegacion" data-pagina-actual="${id}" data-direccion="retroceder">
                    <i class="fas fa-arrow-left me-2"></i> Retroceder
                </button>
                <button type="button" class="btn btn-primary btn-navegacion" data-pagina-actual="${id}" data-direccion="siguiente">
                    Siguiente <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    `;
}

/**
 * Genera el HTML para la página final
 */
function generateFinalPageHTML() {
    return `
        <div id="pagina-final" class="pagina">
            <div class="tab-title">
                <h2>Comentarios Finales</h2>
            </div>
            
            <div class="mb-3">
                <label for="comentarios-finales" class="form-label">Comentarios de No Conformidad (Opcional)</label>
                <textarea class="form-control auto-save" id="comentarios-finales" rows="6" placeholder="Describa cualquier no conformidad..."></textarea>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-secondary btn-navegacion" data-pagina-actual="pagina-final" data-direccion="retroceder">
                    <i class="fas fa-arrow-left me-2"></i> Retroceder
                </button>
                <button type="button" class="btn btn-primary" id="btn-enviar-supervision">
                    <i class="fas fa-paper-plane me-2"></i> Enviar Supervisión
                </button>
            </div>
        </div>
    `;
}

/**
 * Genera TODAS las páginas dinámicamente según las páginas disponibles
 */
function generateAllPages() {
    const $container = $('#contenedor-paginas-dinamicas');
    $container.empty();
    
    // Ordenar páginas disponibles por orden
    const sortedPages = [...paginasDisponibles].sort((a, b) => a.orden - b.orden);
    
    // Generar cada página según su tipo
    sortedPages.forEach(pageConfig => {
        let html = '';
        
        if (pageConfig.tipo === 'simple') {
            html = generateSimplePageHTML(pageConfig);
        } else if (pageConfig.tipo === 'multiple') {
            html = generateMultiplePageHTML(pageConfig);
        } else if (pageConfig.tipo === 'fija' && pageConfig.id !== 'pagina-1') {
            if (pageConfig.id === 'pagina-final') {
                html = generateFinalPageHTML();
            }
        }
        
        if (html) {
            $container.append(html);
        }
    });
    
    // Llenar todas las preguntas después de generar las páginas
    populateAllQuestions();
    
    // Inicializar eventos para páginas múltiples
    initializeMultiplePages();
}

/**
 * Llena todos los contenedores de preguntas
 */
function populateAllQuestions() {
    for (const areaKey in QUESTIONS_CONFIG) {
        const containerId = `#preguntas-${areaKey.replace('_', '-')}-container`;
        const $container = $(containerId);
        
        if ($container.length) {
            $container.empty();
            const questions = QUESTIONS_CONFIG[areaKey];
            let html = '';
            questions.forEach((q, index) => {
                html += generateQuestionHTML(areaKey, index, q);
            });
            $container.html(html);
        }
    }
}

/**
 * Inicializa eventos para páginas múltiples
 */
function initializeMultiplePages() {
    paginasDisponibles.forEach(pageConfig => {
        if (pageConfig.tipo === 'multiple') {
            const { areaKey, nombreItem, previewId } = pageConfig;
            
            // Evento para guardar item
            $(`#btn-guardar-${areaKey}`).on('click', function() {
                guardarItemMultiple(pageConfig);
            });
            
            // Evento para limpiar respuestas
            $(`#btn-limpiar-${areaKey}`).on('click', function() {
                limpiarRespuestasMultiple(pageConfig);
            });
            
            // Evento para editar item
            $(`#lista-${areaKey}-calificadas`).on('click', `.btn-editar-${areaKey}`, function(e) {
                e.preventDefault();
                $(`#lista-${areaKey}-calificadas`).find('.list-group-item').removeClass('is-deleting');
                const index = $(this).data('index');
                cargarItemParaEdicion(pageConfig, index);
            });
            
            // Evento para iniciar eliminación
            $(`#lista-${areaKey}-calificadas`).on('click', `.btn-delete-${areaKey}`, function(e) { 
                e.stopPropagation(); 
                e.preventDefault(); 
                $(this).closest('.list-group-item').addClass('is-deleting'); 
            });
            
            // Evento para confirmar eliminación
            $(`#lista-${areaKey}-calificadas`).on('click', `.btn-confirm-delete-${areaKey}`, async function(e) {
                e.stopPropagation(); 
                e.preventDefault();
                const index = $(this).data('index');
                const data = multipleData[areaKey][index];
                
                // Eliminar fotos de la base de datos
                if (data && data.fotos) { 
                    for (const id of data.fotos) { 
                        await deleteImageFromDB(id); 
                    }
                }
                
                // Eliminar de la lista
                multipleData[areaKey].splice(index, 1);
                renderListaMultiple(pageConfig);
                
                // Si estaba editando este item, limpiar formulario
                if (parseInt($(`#${areaKey}-edit-index`).val()) === index) {
                    limpiarFormularioMultiple(pageConfig);
                } else { 
                    saveSession(); 
                }
            });
            
            // Evento para cancelar eliminación - CORREGIDO
            $(`#lista-${areaKey}-calificadas`).on('click', `.btn-cancel-delete`, function(e) {
                e.stopPropagation();
                e.preventDefault();
                $(this).closest('.list-group-item').removeClass('is-deleting');
            });
            
            // Renderizar lista inicial
            renderListaMultiple(pageConfig);
        }
    });
}

/**
 * Renderiza la lista de items para una página múltiple
 */
function renderListaMultiple(pageConfig) {
    const { areaKey, nombreItem } = pageConfig;
    const $lista = $(`#lista-${areaKey}-calificadas`);
    const data = multipleData[areaKey] || [];
    
    $lista.empty();
    if (data.length === 0) {
        $lista.append(`<p class="text-muted">Aún no hay ${nombreItem.toLowerCase()}s calificadas.</p>`);
        return;
    }
    
    data.forEach((item, index) => {
        $lista.append(createListItemHTML(areaKey, nombreItem, index, item.numero));
    });
}

/**
 * Crea el HTML para un item de lista - CORREGIDO
 */
function createListItemHTML(areaKey, nombreItem, index, name) {
    return `
        <a href="#" class="list-group-item list-group-item-action btn-editar-${areaKey}" data-index="${index}">
            <span>${name}</span>
            <div>
                <button type="button" class="btn btn-danger btn-sm btn-delete-${areaKey}" data-index="${index}" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
                <div class="delete-confirm">
                    <button type="button" class="btn btn-sm btn-success btn-confirm-delete-${areaKey}" data-index="${index}">
                        <i class="fas fa-check"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary btn-cancel-delete" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </a>
    `;
}

// =========================================================================
// FUNCIONES PARA PÁGINAS MÚLTIPLES
// =========================================================================

/**
 * Guarda un item en una página múltiple
 */
function guardarItemMultiple(pageConfig) {
    const { areaKey, nombreItem, previewId } = pageConfig;
    const nombre = $(`#${areaKey}-num-reutilizable`).val().trim();
    
    if (nombre === '') {
        Swal.fire('Dato Requerido', `Debe ingresar el nombre de la ${nombreItem.toLowerCase()}.`, 'warning');
        return;
    }
    
    const preguntasConfig = QUESTIONS_CONFIG[areaKey];
    let preguntasRespondidas = true;
    const respuestas = [];
    const observaciones = [];

    preguntasConfig.forEach((q, index) => {
        const name = `${areaKey}-p${index}`;
        const val = $(`[name="${name}"]:checked`).val() || null;
        const obs = $(`#obs-${name}`).val() || "";

        if (!val) preguntasRespondidas = false;
        respuestas.push(val);
        observaciones.push(obs);
    });

    if (!preguntasRespondidas) {
        Swal.fire('Campos Incompletos', `Debe responder todas las ${preguntasConfig.length} preguntas.`, 'warning');
        return;
    }
    
    if (selectedFiles[previewId].length === 0) {
        Swal.fire('Foto Requerida', 'Debe tomar al menos una foto.', 'warning');
        return;
    }
    
    const itemData = {
        id: Date.now(),
        numero: nombre,
        respuestas: respuestas,
        observaciones: observaciones,
        fotos: [...selectedFiles[previewId]]
    };
    
    const editIndex = parseInt($(`#${areaKey}-edit-index`).val());
    if (editIndex > -1) { 
        multipleData[areaKey][editIndex] = itemData; 
    } else { 
        multipleData[areaKey].push(itemData); 
    }
    
    renderListaMultiple(pageConfig);
    limpiarFormularioMultiple(pageConfig);
    
    Swal.fire({ 
        icon: 'success', 
        title: `${nombreItem} Guardada`, 
        toast: true, 
        position: 'top-end', 
        showConfirmButton: false, 
        timer: 2000 
    });
}

/**
 * Limpia las respuestas de una página múltiple (con confirmación)
 */
function limpiarRespuestasMultiple(pageConfig) {
    const { areaKey, nombreItem } = pageConfig;
    
    // Verificar si hay algo para limpiar
    const nombre = $(`#${areaKey}-num-reutilizable`).val().trim();
    const preguntasConfig = QUESTIONS_CONFIG[areaKey];
    let hayRespuestas = false;
    
    // Verificar si hay respuestas seleccionadas
    for (let i = 0; i < preguntasConfig.length; i++) {
        const name = `${areaKey}-p${i}`;
        if ($(`[name="${name}"]:checked`).length > 0) {
            hayRespuestas = true;
            break;
        }
    }
    
    // Verificar si hay fotos
    if (!hayRespuestas && nombre === '' && selectedFiles[pageConfig.previewId].length === 0) {
        Swal.fire('Sin cambios', 'No hay respuestas que limpiar.', 'info');
        return;
    }
    
    Swal.fire({
        title: '¿Limpiar respuestas?',
        text: `Esta acción eliminará todas las respuestas y fotos de la ${nombreItem.toLowerCase()} actual. ¿Estás seguro?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, limpiar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#f39c12'
    }).then((result) => {
        if (result.isConfirmed) {
            limpiarFormularioMultiple(pageConfig);
            Swal.fire('Limpiado', 'Las respuestas han sido limpiadas.', 'success');
        }
    });
}

/**
 * Limpia el formulario de una página múltiple
 */
function limpiarFormularioMultiple(pageConfig) {
    const { areaKey, nombreItem, previewId } = pageConfig;
    
    $(`#${areaKey}-edit-index`).val('-1');
    $(`#titulo-form-${areaKey}`).text(`Nueva ${nombreItem}`);
    $(`#${areaKey}-num-reutilizable`).val('');
    
    const preguntasConfig = QUESTIONS_CONFIG[areaKey];
    preguntasConfig.forEach((q, index) => {
        const name = `${areaKey}-p${index}`;
        $(`[name="${name}"]`).prop('checked', false);
        $(`#obs-${name}`).val('');
        $(`#comentario-${name}`).hide();
    });
    
    selectedFiles[previewId] = [];
    $(`#${previewId}`).empty();
    $(`#lista-${areaKey}-calificadas`).find('.list-group-item').removeClass('active');
    saveSession();
}

/**
 * Carga un item para edición
 */
function cargarItemParaEdicion(pageConfig, index) {
    const { areaKey, nombreItem, previewId } = pageConfig;
    const data = multipleData[areaKey][index];
    
    if (!data) return;
    
    $(`#lista-${areaKey}-calificadas`).find('.list-group-item').removeClass('active');
    $(`#lista-${areaKey}-calificadas`).find(`.btn-editar-${areaKey}[data-index="${index}"]`).addClass('active');
    
    $(`#${areaKey}-edit-index`).val(index);
    $(`#titulo-form-${areaKey}`).text('Editando: ' + data.numero);
    $(`#${areaKey}-num-reutilizable`).val(data.numero);
    
    data.respuestas.forEach((answer, i) => {
        const name = `${areaKey}-p${i}`;
        if (answer) {
            $(`[name="${name}"]`).val([answer]);
            const $comment = $(`#comentario-${name}`);
            if (answer === 'NC') $comment.show(); else $comment.hide();
        }
        $(`#obs-${name}`).val(data.observaciones[i] || '');
    });
    
    selectedFiles[previewId] = [...data.fotos];
    renderFotosPreview(previewId);
    saveSession();
}

// =========================================================================
// FUNCIONES DE PÁGINA 1 (UBICACIÓN)
// =========================================================================

/**
 * Actualiza las ubicaciones según el proyecto seleccionado
 */
function actualizarUbicaciones() {
    const proyectoVal = $selectProyecto.val();
    
    $selectUbicacion.empty();
    
    if (!proyectoVal) {
        $selectUbicacion.append('<option value="">Seleccione un proyecto primero...</option>');
        $selectUbicacion.prop('disabled', true);
    } else if (ubicacionesPorProyecto[proyectoVal] !== undefined) {
        const ubicaciones = ubicacionesPorProyecto[proyectoVal];
        $selectUbicacion.append('<option value="">Seleccionar Ubicación...</option>');
        ubicaciones.forEach((ubicacion) => {
            $selectUbicacion.append(`<option value="${ubicacion}">${ubicacion}</option>`);
        });
        $selectUbicacion.prop('disabled', false);
    } else {
        $selectUbicacion.append('<option value="">Seleccione un proyecto primero...</option>');
        $selectUbicacion.prop('disabled', true);
    }
    
    // Filtrar páginas disponibles según el proyecto seleccionado
    if (proyectoVal) {
        filtrarPaginasDisponibles(proyectoVal, '');
    }
}

/**
 * Valida los campos de la Página 1 para habilitar "Siguiente"
 */
function validarPagina1() {
    if (!$fechaInput || !$selectProyecto || !$selectUbicacion || !$btnPag1Siguiente) return;
    
    const fechaValida = $fechaInput.val() !== '';
    const proyectoValido = $selectProyecto.val() !== '';
    const ubicacionValida = $selectUbicacion.val() !== '';
    
    $btnPag1Siguiente.prop('disabled', !(fechaValida && proyectoValido && ubicacionValida));
}

// =========================================================================
// FUNCIONES DE NAVEGACIÓN
// =========================================================================

/**
 * Obtiene la lista de IDs de páginas en orden
 */
function getPageOrder() {
    return paginasDisponibles.sort((a, b) => a.orden - b.orden).map(p => p.id);
}

/**
 * Navega a una página específica
 */
function navegarPagina(paginaId) {
    $('.pagina').removeClass('active');
    $(`#${paginaId}`).addClass('active');
    
    // Actualizar barra de progreso
    const pageOrder = getPageOrder();
    const currentIndex = pageOrder.indexOf(paginaId);
    const totalPages = pageOrder.length;
    
    if (paginaId === 'pagina-1') {
        $progressBar.css('width', '12.5%').text(`Paso 1`);
    } else {
        const porcentaje = ((currentIndex + 1) / totalPages) * 100;
        $progressBar.css('width', porcentaje + '%').text(`Paso ${currentIndex + 1} de ${totalPages}`);
    }
    
    saveSession();
    updateFloatingButtonVisibility();
}

/**
 * Verifica si hay un formulario parcialmente lleno sin guardar
 */
function hayFormularioParcial(pageConfig) {
    if (pageConfig.tipo !== 'multiple') return false;
    
    const { areaKey, nombreItem } = pageConfig;
    
    // Verificar si hay nombre/ID ingresado
    const nombreInput = $(`#${areaKey}-num-reutilizable`).val().trim();
    if (nombreInput !== '') return true;
    
    // Verificar si hay respuestas seleccionadas
    const preguntasConfig = QUESTIONS_CONFIG[areaKey];
    for (let i = 0; i < preguntasConfig.length; i++) {
        const name = `${areaKey}-p${i}`;
        if ($(`[name="${name}"]:checked`).length > 0) {
            return true;
        }
    }
    
    // Verificar si hay fotos tomadas pero no guardadas
    if (selectedFiles[pageConfig.previewId] && selectedFiles[pageConfig.previewId].length > 0) {
        return true;
    }
    
    return false;
}

/**
 * Valida una página antes de navegar
 */
function validarPagina(paginaId) {
    const pageConfig = paginasDisponibles.find(p => p.id === paginaId);
    if (!pageConfig) return true;
    
    // Página 1 tiene validación especial
    if (paginaId === 'pagina-1') {
        return !$btnPag1Siguiente.prop('disabled');
    }
    
    // Páginas simples
    if (pageConfig.tipo === 'simple') {
        const { areaKey, titulo } = pageConfig;
        const previewId = `preview-${areaKey}`;
        
        if ($(`input[name="calificar-${areaKey}"]:checked`).val() === 'si') {
            // Validar preguntas
            const $preguntas = $(`#area-${areaKey} .pregunta-supervision`);
            let todasRespondidas = true;
            $preguntas.each(function() {
                if ($(this).find('.btn-check:checked').length === 0) {
                    todasRespondidas = false;
                }
            });
            
            if (!todasRespondidas) {
                Swal.fire('Campos Incompletos', `Debe responder todas las preguntas de "${titulo}" para continuar.`, 'warning');
                return false;
            }
            
            // Validar fotos si son requeridas
            if (pageConfig.fotosRequeridas && selectedFiles[previewId] && selectedFiles[previewId].length === 0) {
                Swal.fire('Foto Requerida', `Debe tomar al menos una foto para "${titulo}".`, 'warning');
                return false;
            }
        }
    }
    
    // Páginas múltiples - CORRECCIÓN: Validar formularios parciales sin guardar
    if (pageConfig.tipo === 'multiple') {
        const { areaKey, nombreItem } = pageConfig;
        
        if ($(`input[name="calificar-${areaKey}"]:checked`).val() === 'si') {
            if (multipleData[areaKey] && multipleData[areaKey].length === 0) {
                // Verificar si hay un formulario pendiente (MEJORADO)
                if (hayFormularioParcial(pageConfig)) {
                    Swal.fire(`${nombreItem} Pendiente`, `Guarde o limpie la ${nombreItem.toLowerCase()} actual antes de continuar.`, 'warning');
                    return false;
                } else {
                    Swal.fire('Incompleto', `Debe calificar y guardar al menos una ${nombreItem.toLowerCase()}.`, 'warning');
                    return false;
                }
            }
            
            // CORRECCIÓN: También verificar si hay formulario parcial incluso si ya hay items guardados
            if (hayFormularioParcial(pageConfig)) {
                Swal.fire(`${nombreItem} Pendiente`, `Tiene cambios sin guardar en la ${nombreItem.toLowerCase()} actual. Guárdela o límpiela antes de continuar.`, 'warning');
                return false;
            }
        }
    }
    
    return true;
}

// =========================================================================
// FUNCIONES PARA CÁMARA - CORREGIDAS
// =========================================================================

/**
 * Abre la cámara según el dispositivo
 */
function openCamera(previewId) {
    currentPreviewId = previewId;
    
    // VERIFICACIÓN DE SEGURIDAD EXTRA
    // Si en desktop se detecta como móvil por error, forzar modal
    const userAgent = navigator.userAgent.toLowerCase();
    const esWindows = userAgent.includes('windows') || userAgent.includes('win32');
    const esMac = userAgent.includes('macintosh') || userAgent.includes('mac os');
    const esLinux = userAgent.includes('linux') && !userAgent.includes('android');
    
    // Si es claramente desktop (Windows, Mac, Linux), usar modal siempre
    if (esWindows || esMac || esLinux) {
        openCameraModal();
        return;
    }
    
    if (esDispositivoMovil()) {
        // En móvil: usar cámara nativa
        openNativeCamera();
    } else {
        // En desktop: usar modal de cámara
        openCameraModal();
    }
}

/**
 * Abre cámara nativa en dispositivos móviles
 */
function openNativeCamera() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // Esto abre cámara trasera en móvil
    
    input.onchange = async function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            await handleCameraPhoto(file);
        }
    };
    
    // Simular clic en el input
    input.click();
}

/**
 * Abre el modal de cámara para desktop
 */
function openCameraModal() {
    const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
    cameraModal.show();
    
    // Inicializar cámara después de que el modal se muestre
    $('#cameraModal').on('shown.bs.modal', async function() {
        await initializeCamera();
    });
    
    // Detener cámara cuando se cierra el modal
    $('#cameraModal').on('hidden.bs.modal', function() {
        stopCamera();
        resetCameraControls();
    });
}

/**
 * Inicializa la cámara para desktop
 */
async function initializeCamera() {
    try {
        // Verificar si el navegador soporta getUserMedia
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showCameraError('Tu navegador no soporta el acceso a la cámara.');
            return;
        }
        
        // Configuración de la cámara
        const constraints = {
            video: {
                facingMode: currentFacingMode,
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            audio: false
        };
        
        // Obtener stream de la cámara
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElement = document.getElementById('camera-video');
        videoElement.srcObject = cameraStream;
        
        // Ocultar mensaje de error si estaba visible
        $('#camera-message').hide();
        
        // Aplicar zoom inicial
        applyZoom();
        
    } catch (error) {
        console.error('Error al acceder a la cámara:', error);
        showCameraError('No se pudo acceder a la cámara. Verifica los permisos.');
    }
}

/**
 * Muestra mensaje de error en la cámara
 */
function showCameraError(message) {
    $('#camera-message').text(message).show();
    $('.camera-container').addClass('no-camera');
}

/**
 * Detiene la cámara
 */
function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    const videoElement = document.getElementById('camera-video');
    if (videoElement) {
        videoElement.srcObject = null;
    }
}

/**
 * Resetea los controles de la cámara
 */
function resetCameraControls() {
    zoomLevel = 1;
    flashOn = false;
    currentFacingMode = 'environment';
    $('#flash-toggle').removeClass('active');
    applyZoom();
}

/**
 * Aplica el zoom actual al video
 */
function applyZoom() {
    const videoElement = document.getElementById('camera-video');
    if (videoElement) {
        videoElement.style.transform = `scaleX(-1) scale(${zoomLevel})`;
    }
}

/**
 * Maneja la foto tomada (tanto de móvil como de desktop)
 */
async function handleCameraPhoto(file) {
    if (!currentPreviewId || !db) return;
    
    if (!selectedFiles[currentPreviewId]) {
        selectedFiles[currentPreviewId] = [];
    }
    
    const previewContainer = document.getElementById(currentPreviewId);
    const loadingHtml = `<div class="image-preview-item text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Cargando...</span></div></div>`;
    
    const tempSpinner = $(loadingHtml);
    previewContainer.appendChild(tempSpinner[0]);
    
    try {
        const base64Data = await fileToBase64(file);
        const newId = await saveImageToDB(base64Data);
        selectedFiles[currentPreviewId].push(newId);
        tempSpinner.remove();
        
        const div = document.createElement("div");
        div.classList.add("image-preview-item");
        div.innerHTML = `
            <img src="${base64Data}" alt="Vista previa ${newId}">
            <div class="delete-icon" onclick="deleteImage(this, '${currentPreviewId}', ${newId})">×</div>
        `;
        previewContainer.appendChild(div);
        
        // Mostrar mensaje de éxito
        Swal.fire({
            icon: 'success',
            title: '¡Foto tomada!',
            text: 'La foto se ha guardado correctamente.',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000
        });
        
        saveSession();
    } catch (error) {
        console.error("Error guardando foto en DB:", error);
        tempSpinner.remove();
        Swal.fire('Error de Foto', 'No se pudo guardar la imagen.', 'error');
    }
}

/**
 * Captura una foto de la cámara en desktop
 */
function capturePhoto() {
    if (!cameraStream) return;
    
    const videoElement = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    const context = canvas.getContext('2d');
    
    // Configurar canvas con las mismas dimensiones que el video
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;
    
    // Aplicar espejo (flip horizontal) para que se vea como selfie
    context.translate(canvas.width, 0);
    context.scale(-1, 1);
    
    // Dibujar el frame actual del video en el canvas
    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    
    // Aplicar zoom al canvas también
    if (zoomLevel !== 1) {
        const zoomedWidth = canvas.width * zoomLevel;
        const zoomedHeight = canvas.height * zoomLevel;
        const offsetX = (canvas.width - zoomedWidth) / 2;
        const offsetY = (canvas.height - zoomedHeight) / 2;
        
        context.setTransform(1, 0, 0, 1, 0, 0); // Resetear transformación
        context.drawImage(canvas, offsetX, offsetY, zoomedWidth, zoomedHeight, 0, 0, canvas.width, canvas.height);
    }
    
    // Obtener la imagen como base64
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Procesar la foto capturada
    processCapturedPhoto(imageData);
    
    // Efecto visual de captura
    visualCaptureEffect();
}

/**
 * Procesa la foto capturada en desktop
 */
async function processCapturedPhoto(imageData) {
    if (!currentPreviewId || !db) return;
    
    if (!selectedFiles[currentPreviewId]) {
        selectedFiles[currentPreviewId] = [];
    }
    
    try {
        // Guardar en la base de datos
        const newId = await saveImageToDB(imageData);
        selectedFiles[currentPreviewId].push(newId);
        
        // Actualizar vista previa
        await renderFotosPreview(currentPreviewId);
        
        // Mostrar mensaje de éxito
        Swal.fire({
            icon: 'success',
            title: '¡Foto tomada!',
            text: 'La foto se ha guardado correctamente.',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000
        });
        
        saveSession();
        
    } catch (error) {
        console.error("Error guardando foto en DB:", error);
        Swal.fire('Error de Foto', 'No se pudo guardar la imagen.', 'error');
    }
}

/**
 * Efecto visual al capturar foto en desktop
 */
function visualCaptureEffect() {
    const cameraView = document.querySelector('.camera-view');
    if (cameraView) {
        // Flash blanco
        cameraView.style.backgroundColor = 'white';
        
        setTimeout(() => {
            cameraView.style.backgroundColor = 'transparent';
        }, 100);
        
        // Efecto de sonido (simulado)
        if (flashOn) {
            setTimeout(() => {
                cameraView.style.backgroundColor = 'white';
            }, 50);
            
            setTimeout(() => {
                cameraView.style.backgroundColor = 'transparent';
            }, 150);
        }
    }
}

/**
 * Cambia entre cámaras frontal/trasera en desktop
 */
async function switchCamera() {
    if (!cameraStream) return;
    
    try {
        // Detener cámara actual
        stopCamera();
        
        // Cambiar modo
        currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
        
        // Reinicializar con nueva cámara
        await initializeCamera();
        
    } catch (error) {
        console.error('Error al cambiar cámara:', error);
        Swal.fire('Error', 'No se pudo cambiar la cámara.', 'error');
    }
}

/**
 * Alterna el flash en desktop
 */
function toggleFlash() {
    flashOn = !flashOn;
    const flashBtn = $('#flash-toggle');
    
    if (flashOn) {
        flashBtn.addClass('active');
        // Simular flash con un overlay blanco
        $('.camera-view').css('filter', 'brightness(1.5)');
    } else {
        flashBtn.removeClass('active');
        $('.camera-view').css('filter', 'brightness(1)');
    }
}

/**
 * Aumenta el zoom en desktop
 */
function zoomIn() {
    if (zoomLevel < 3) {
        zoomLevel += 0.5;
        applyZoom();
    }
}

/**
 * Disminuye el zoom en desktop
 */
function zoomOut() {
    if (zoomLevel > 0.5) {
        zoomLevel -= 0.5;
        applyZoom();
    }
}

// =========================================================================
// INICIALIZACIÓN Y EVENTOS
// =========================================================================

document.addEventListener('DOMContentLoaded', async function() {
    
    try {
        // Inicializar logo y base de datos
        loadLogoCache();
        await initDB();
        
        // Asignar variables globales
        $form = $('#form-supervision');
        $progressBar = $('#progress-bar');
        
        // Variables de página 1
        $selectProyecto = $('#select-proyecto');
        $selectUbicacion = $('#select-ubicacion');
        $fechaInput = $('#fecha-supervision');
        $btnPag1Siguiente = $('#btn-pag1-siguiente');
        
        // Inicializar proyectos y ubicaciones
        inicializarProyectosUbicaciones();
        
        // Inicialmente, mostrar todas las páginas
        paginasDisponibles = [...PAGES_CONFIG];
        
        // Generar todas las páginas dinámicamente
        generateAllPages();
        
        // Revisar sesión guardada
        await checkForSavedSession();

    } catch (error) {
        console.error("Error en inicialización:", error);
    }
    
    // Establecer fecha por defecto
    if ($('#fecha-supervision').val() === '') {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        $('#fecha-supervision').val(`${yyyy}-${mm}-${dd}`);
    }
    
    // =========================================================================
    // EVENTOS DE NAVEGACIÓN
    // =========================================================================
    
    // Navegación desde página 1
    $('#btn-pag1-siguiente').on('click', function() {
        if (!validarPagina('pagina-1')) {
            Swal.fire('Campos Incompletos', 'Debe seleccionar Fecha, Proyecto y Ubicación.', 'warning');
            return;
        }
        
        // Obtener proyecto y ubicación seleccionados
        const proyecto = $selectProyecto.val();
        const ubicacion = $selectUbicacion.val();
        
        // Filtrar páginas disponibles según proyecto y ubicación
        filtrarPaginasDisponibles(proyecto, ubicacion);
        
        // Regenerar páginas con el filtro aplicado
        generateAllPages();
        
        const pageOrder = getPageOrder();
        const nextPageIndex = pageOrder.indexOf('pagina-1') + 1;
        if (nextPageIndex < pageOrder.length) {
            navegarPagina(pageOrder[nextPageIndex]);
        }
    });
    
    // Navegación general
    $form.on('click', '.btn-navegacion:not(#btn-pag1-siguiente)', function() {
        const $btn = $(this);
        const paginaActualId = $btn.data('pagina-actual');
        const direccion = $btn.data('direccion');
        
        const pageOrder = getPageOrder();
        const currentIndex = pageOrder.indexOf(paginaActualId);
        
        if (currentIndex === -1) {
            console.error('Página no encontrada en el flujo:', paginaActualId);
            return;
        }
        
        if (direccion === 'siguiente') {
            if (!validarPagina(paginaActualId)) return;
            
            const nextPageId = pageOrder[currentIndex + 1];
            if (nextPageId) navegarPagina(nextPageId);
        } else if (direccion === 'retroceder') {
            const prevPageId = pageOrder[currentIndex - 1];
            if (prevPageId) navegarPagina(prevPageId);
        }
    });
    
    // =========================================================================
    // EVENTOS DE PÁGINA 1
    // =========================================================================
    $selectProyecto.on('change', function() {
        actualizarUbicaciones();
        validarPagina1();
    });
    $fechaInput.on('change', validarPagina1);
    $selectUbicacion.on('change', function() {
        validarPagina1();
        
        // Cuando se selecciona una ubicación, filtrar páginas
        const proyecto = $selectProyecto.val();
        const ubicacion = $selectUbicacion.val();
        
        if (proyecto && ubicacion) {
            filtrarPaginasDisponibles(proyecto, ubicacion);
            // No regeneramos las páginas aquí, se hará al hacer clic en Siguiente
        }
    });
    
    // =========================================================================
    // EVENTOS GENERALES
    // =========================================================================
    
    // Toggles de áreas
    $form.on('change', '.toggle-area', function() {
        const targetSelector = $(this).data('target');
        const $targetArea = $(targetSelector);
        
        if (this.value === 'si') {
            $targetArea.slideDown(400, function() {
                updateFloatingButtonVisibility();
            });
        } else {
            $targetArea.slideUp(400, function() {
                updateFloatingButtonVisibility();
            });
        }
    });
    
    // Mostrar/Ocultar comentarios al marcar NC
    $form.on('change', '.btn-check', function() {
        const name = $(this).attr('name');
        const val = $(this).val();
        const $commentContainer = $(`#comentario-${name}`);
        
        if ($commentContainer.length) {
            if (val === 'NC') {
                $commentContainer.slideDown();
            } else {
                $commentContainer.slideUp();
            }
        }
        saveSession();
    });
    
    // Botón flotante de cámara
    $('#btn-camara-flotante').on('click', function(e) {
        e.preventDefault(); 
        e.stopPropagation();

        const $activePage = $('.pagina.active');
        const $visibleAreas = $activePage.find('.area-supervision').filter(':visible');
        
        if ($visibleAreas.length > 0) {
            // Buscar el primer previewId visible
            let previewId = null;
            $visibleAreas.each(function() {
                const $preview = $(this).find('.image-preview');
                if ($preview.length > 0) {
                    previewId = $preview.attr('id');
                    return false; // Salir del each
                }
            });
            
            if (previewId) {
                openCamera(previewId);
            }
        }
    });
    
    // =========================================================================
    // EVENTOS DE CÁMARA (solo desktop)
    // =========================================================================
    
    // Capturar foto
    $('#capture-btn').on('click', capturePhoto);
    
    // Cambiar cámara
    $('#switch-camera').on('click', switchCamera);
    
    // Flash
    $('#flash-toggle').on('click', toggleFlash);
    
    // Zoom
    $('#zoom-in').on('click', zoomIn);
    $('#zoom-out').on('click', zoomOut);
    
    // =========================================================================
    // EVENTO DE ENVÍO FINAL
    // =========================================================================
    $(document).on('click', '#btn-enviar-supervision', async function(e) {
        e.preventDefault();
        await generatePDF();
    });
    
    // =========================================================================
    // EVENTOS DE AUTO-GUARDADO
    // =========================================================================
    $form.on('change input', '.auto-save', saveSession);
    $form.on('change', '.btn-check', saveSession);
    $form.on('input', '.auto-save-comment', saveSession);

});

// =========================================================================
// FUNCIONES DE SESIÓN
// =========================================================================

function saveSession() {
    if (!db) return;
    
    const sessionData = {
        paginaActual: $('.pagina.active').attr('id') || 'pagina-1',
        fecha: $('#fecha-supervision').val(),
        proyecto: $('#select-proyecto').val(),
        ubicacion: $('#select-ubicacion').val(),
        
        // Toggles
        toggles: {},
        
        // Radios y comentarios
        radios: {},
        comentariosPreguntas: {},
        
        // Fotos
        fotos: selectedFiles,
        
        // Datos múltiples
        multipleData: multipleData,
        
        // Datos de formularios múltiples pendientes
        dirtyForms: {},
        
        // Comentarios finales
        comentarios: $('#comentarios-finales').val(),
        
        // Configuración de páginas disponibles
        paginasDisponibles: paginasDisponibles.map(p => p.id)
    };
    
    // Guardar toggles
    $('.toggle-area').each(function() {
        const name = $(this).attr('name');
        const value = $(this).is(':checked') ? $(this).val() : null;
        if (name && value) {
            sessionData.toggles[name] = value;
        }
    });
    
    // Guardar radios y comentarios
    $('.auto-save.btn-group').each(function() {
        const name = $(this).find('.btn-check').first().attr('name');
        if (name) {
            const value = $(`[name="${name}"]:checked`).val();
            sessionData.radios[name] = value || null;
            
            const commentVal = $(`#obs-${name}`).val();
            if (commentVal) sessionData.comentariosPreguntas[name] = commentVal;
        }
    });
    
    // Guardar formularios "sucios" de páginas múltiples
    paginasDisponibles.forEach(pageConfig => {
        if (pageConfig.tipo === 'multiple') {
            const { areaKey } = pageConfig;
            const nombreInput = $(`#${areaKey}-num-reutilizable`).val();
            const editIndex = $(`#${areaKey}-edit-index`).val();
            
            // Guardar siempre el nombre/ID, no solo si hay edición
            if (nombreInput || editIndex !== '-1') {
                const preguntasConfig = QUESTIONS_CONFIG[areaKey];
                const respuestas = preguntasConfig.map((q, i) => 
                    $(`[name="${areaKey}-p${i}"]:checked`).val() || null
                );
                const observaciones = preguntasConfig.map((q, i) => 
                    $(`#obs-${areaKey}-p${i}`).val() || ""
                );
                
                sessionData.dirtyForms[areaKey] = {
                    numero: nombreInput,
                    editIndex: editIndex,
                    respuestas: respuestas,
                    observaciones: observaciones
                };
            }
        }
    });
    
    localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
}

async function loadSession() {
    const dataString = localStorage.getItem(SESSION_KEY);
    if (!dataString) return;
    
    try {
        const data = JSON.parse(dataString);
        
        // Restaurar página 1
        $('#fecha-supervision').val(data.fecha);
        $('#select-proyecto').val(data.proyecto);
        actualizarUbicaciones();
        $('#select-ubicacion').val(data.ubicacion);
        validarPagina1();
        
        // Filtrar páginas disponibles según el proyecto y ubicación guardados
        if (data.proyecto && data.ubicacion) {
            filtrarPaginasDisponibles(data.proyecto, data.ubicacion);
        } else {
            // Si no hay proyecto/ubicación guardados, usar todas las páginas
            paginasDisponibles = [...PAGES_CONFIG];
        }
        
        // Restaurar páginas disponibles si están guardadas
        if (data.paginasDisponibles) {
            // Filtrar las páginas que existen en la configuración
            paginasDisponibles = PAGES_CONFIG.filter(p => 
                data.paginasDisponibles.includes(p.id)
            );
        }
        
        // Regenerar páginas con el filtro aplicado
        generateAllPages();
        
        // Restaurar toggles
        if (data.toggles) {
            for (const name in data.toggles) {
                const value = data.toggles[name];
                if (value) {
                    $(`[name="${name}"][value="${value}"]`).prop('checked', true);
                    
                    const targetSelector = $(`[name="${name}"][value="${value}"]`).data('target');
                    if (targetSelector && value === 'si') {
                        $(targetSelector).show();
                    }
                }
            }
        }
        
        // Restaurar radios y comentarios
        if (data.radios) {
            for (const name in data.radios) {
                if (data.radios[name]) {
                    $(`[name="${name}"]`).val([data.radios[name]]);
                    if (data.radios[name] === 'NC') {
                        $(`#comentario-${name}`).show();
                    }
                }
            }
        }
        
        if (data.comentariosPreguntas) {
            for (const name in data.comentariosPreguntas) {
                $(`#obs-${name}`).val(data.comentariosPreguntas[name]);
            }
        }
        
        // Restaurar fotos
        if (data.fotos) {
            selectedFiles = data.fotos;
            for (const previewId in selectedFiles) {
                await renderFotosPreview(previewId);
            }
        }
        
        // Restaurar datos múltiples
        if (data.multipleData) {
            multipleData = data.multipleData;
            
            // Renderizar listas
            paginasDisponibles.forEach(pageConfig => {
                if (pageConfig.tipo === 'multiple') {
                    renderListaMultiple(pageConfig);
                }
            });
        }
        
        // Restaurar formularios sucios
        if (data.dirtyForms) {
            for (const areaKey in data.dirtyForms) {
                const formData = data.dirtyForms[areaKey];
                const pageConfig = paginasDisponibles.find(p => p.areaKey === areaKey);
                
                if (pageConfig && formData) {
                    $(`#${areaKey}-num-reutilizable`).val(formData.numero || '');
                    $(`#${areaKey}-edit-index`).val(formData.editIndex || '-1');
                    
                    if (formData.editIndex && formData.editIndex !== '-1') {
                        $(`#titulo-form-${areaKey}`).text('Editando: ' + (formData.numero || 'Sin nombre'));
                    } else if (formData.numero) {
                        $(`#titulo-form-${areaKey}`).text(`Nueva ${pageConfig.nombreItem} (sin guardar)`);
                    }
                    
                    if (formData.respuestas) {
                        formData.respuestas.forEach((answer, index) => {
                            const name = `${areaKey}-p${index}`;
                            if (answer) {
                                $(`[name="${name}"]`).val([answer]);
                                const $comment = $(`#comentario-${name}`);
                                if (answer === 'NC') $comment.show(); else $comment.hide();
                            }
                        });
                    }
                    
                    if (formData.observaciones) {
                        formData.observaciones.forEach((obs, index) => {
                            $(`#obs-${areaKey}-p${index}`).val(obs || '');
                        });
                    }
                    
                    if (formData.editIndex && formData.editIndex !== '-1') {
                        $(`#lista-${areaKey}-calificadas`).find(`.btn-editar-${areaKey}[data-index="${formData.editIndex}"]`).addClass('active');
                    }
                }
            }
        }
        
        // Restaurar comentarios finales
        $('#comentarios-finales').val(data.comentarios);
        
        // Navegar a la página guardada
        $('.pagina').removeClass('active');
        const paginaGuardada = data.paginaActual || 'pagina-1';
        $(`#${paginaGuardada}`).addClass('active');
        
        navegarPagina(paginaGuardada);

    } catch (e) {
        console.error("Error al cargar sesión:", e);
        await clearSession();
    }
}

async function clearSession() {
    localStorage.removeItem(SESSION_KEY);
    
    // Limpiar arrays dinámicos
    selectedFiles = {};
    multipleData = {};
    
    // Inicializar arrays basados en configuración
    PAGES_CONFIG.forEach(pageConfig => {
        if (pageConfig.tipo === 'simple') {
            selectedFiles[`preview-${pageConfig.areaKey}`] = [];
        } else if (pageConfig.tipo === 'multiple') {
            selectedFiles[pageConfig.previewId] = [];
            multipleData[pageConfig.areaKey] = [];
        }
    });
    
    // Limpiar base de datos de imágenes
    if (db) {
        try {
            await clearImageDB();
            console.log("IndexedDB de imágenes limpiada.");
        } catch (error) {
            console.error("No se pudo limpiar la IndexedDB:", error);
        }
    }
    
    // Recargar preguntas para limpiar UI
    populateAllQuestions();
}

async function checkForSavedSession() {
    return new Promise((resolve) => {
        if (localStorage.getItem(SESSION_KEY)) {
            Swal.fire({
                title: 'Trabajo Pendiente',
                text: 'Detectamos un trabajo de supervisión que no fue enviado. ¿Deseas recuperarlo?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, recuperar',
                cancelButtonText: 'No, empezar de cero',
                allowOutsideClick: false
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await loadSession();
                    Swal.fire('¡Listo!', 'Tu sesión ha sido restaurada.', 'success');
                } else if (result.isDismissed) { 
                    Swal.fire({
                        title: '¿Estás 100% seguro?',
                        html: "Esta acción es irreversible y todo su progreso se perderá.",
                        icon: 'error',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, borrar todo',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#e74c3c'
                    }).then(async (deleteResult) => {
                        if (deleteResult.isConfirmed) {
                            await clearSession();
                            Swal.fire('Eliminado', 'Se ha borrado el progreso anterior.', 'success');
                        } else {
                            await loadSession();
                            Swal.fire('¡Restaurado!', 'Tu sesión ha sido restaurada.', 'success');
                        }
                        resolve();
                    });
                    return;
                }
                resolve();
            });
        } else {
            resolve();
        }
    });
}

// =========================================================================
// FUNCIONES DE FOTOS (INDEXEDDB)
// =========================================================================

function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onupgradeneeded = function(event) {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            }
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            console.log('IndexedDB abierta correctamente');
            resolve(db);
        };
        request.onerror = function(event) {
            console.error('Error al abrir IndexedDB:', event.target.error);
            Swal.fire('Error Crítico', 'No se pudo iniciar la base de datos local para fotos. La página no funcionará correctamente.', 'error');
            reject(event.target.error);
        };
    });
}

function saveImageToDB(base64Data) {
    return new Promise((resolve, reject) => {
        if (!db) { reject('La base de datos no está inicializada.'); return; }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.add({ image: base64Data });
        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => reject(event.target.error);
    });
}

function getImageFromDB(id) {
    return new Promise((resolve, reject) => {
        if (!db) { reject('La base de datos no está inicializada.'); return; }
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);
        request.onsuccess = (event) => resolve(event.target.result ? event.target.result.image : null);
        request.onerror = (event) => reject(event.target.error);
    });
}

function deleteImageFromDB(id) {
    return new Promise((resolve, reject) => {
        if (!db) { reject('La base de datos no está inicializada.'); return; }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = (event) => reject(event.target.error);
    });
}

function clearImageDB() {
    return new Promise((resolve, reject) => {
        if (!db) { reject('La base de datos no está inicializada.'); return; }
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.clear();
        request.onsuccess = () => resolve();
        request.onerror = (event) => reject(event.target.error);
    });
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
    });
}

async function renderFotosPreview(previewId) {
    const previewContainer = document.getElementById(previewId);
    if (!previewContainer) return; 
    
    previewContainer.innerHTML = '';
    const idArray = selectedFiles[previewId] || [];
    if (!db && idArray.length > 0) {
        previewContainer.innerHTML = '<p class="text-danger">Error: DB de fotos no lista.</p>';
        return;
    }
    
    const fragment = document.createDocumentFragment();
    const renderPromises = idArray.map(async (id) => {
        try {
            const base64String = await getImageFromDB(id);
            if (base64String) {
                const div = document.createElement("div");
                div.classList.add("image-preview-item");
                div.innerHTML = `
                    <img src="${base64String}" alt="Vista previa ${id}">
                    <div class="delete-icon" onclick="deleteImage(this, '${previewId}', ${id})">×</div>
                `;
                return div;
            } else {
                console.warn(`Image ID ${id} no encontrado en DB.`);
                selectedFiles[previewId] = selectedFiles[previewId].filter(dbId => dbId !== id);
                saveSession();
                return null;
            }
        } catch (error) {
            console.error(`Error al cargar imagen ID ${id}:`, error);
            return null;
        }
    });
    
    const elements = await Promise.all(renderPromises);
    elements.forEach(el => {
        if (el) fragment.appendChild(el);
    });
    previewContainer.appendChild(fragment);
}

async function deleteImage(buttonElement, previewId, id) {
    if (!db) { Swal.fire('Error', 'La base de datos no está lista.', 'error'); return; }
    const item = buttonElement.closest('.image-preview-item');
    if (item) {
        item.classList.add('deleting');
        setTimeout(() => { item.remove(); }, 300);
    }
    try {
        await deleteImageFromDB(id);
        if (selectedFiles[previewId]) {
            selectedFiles[previewId] = selectedFiles[previewId].filter(dbId => dbId !== id);
        }
        saveSession();
    } catch (error) {
        console.error("Error eliminando imagen:", error);
        Swal.fire('Error', 'No se pudo eliminar la imagen.', 'error');
    }
}

// =========================================================================
// FUNCIONES DE LOGO
// =========================================================================

function loadLogoCache() {
    const img = document.getElementById('logo-loader');
    if (!img) {
        console.warn('No se encontró la etiqueta <img id="logo-loader">. El PDF se generará sin logo.');
        logoBase64_Cache = null;
        return;
    }
    const convertLogo = () => {
        try {
            const canvas = document.createElement('canvas');
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            logoBase64_Cache = canvas.toDataURL('image/png');
            console.log('Logo local cargado y cacheado.');
        } catch (e) {
            console.error('Error al convertir el logo local (CORS?):', e);
            logoBase64_Cache = null;
        }
    };
    if (img.complete && img.naturalHeight !== 0) {
        convertLogo();
    } else {
        img.onload = convertLogo;
        img.onerror = () => {
            console.error('No se pudo cargar el archivo logo.png.');
            logoBase64_Cache = null;
        };
    }
}

// =========================================================================
// FUNCIONES PARA GENERAR PDF
// =========================================================================

function compressImageForPDF(base64String, quality = 0.7) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxWidth = 800; 
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
                const ratio = maxWidth / width;
                width = maxWidth;
                height = height * ratio;
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            const compressedBase64 = canvas.toDataURL('image/jpeg', quality); 
            resolve(compressedBase64);
        };
        img.onerror = () => resolve(null);
        img.src = base64String;
    });
}

const addPageFooters = (doc) => {
    const pageCount = doc.internal.getNumberOfPages();
    const pageHeight = doc.internal.pageSize.height;
    const pageWidth = doc.internal.pageSize.width;
    const margin = 40;
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Página ${i} de ${pageCount}`, pageWidth - margin, pageHeight - 15, { align: 'right' });
    }
};

const addPhotos = async (doc, imageIds, yPosRef, pageHeight, margin) => {
    if (!imageIds || imageIds.length === 0) return yPosRef.y;
    
    let yPos = yPosRef.y + 10;
    
    const imgWidth = 160; 
    const imgHeight = 120;
    const marginX = margin; 
    const spacingX = (doc.internal.pageSize.width - margin * 2 - imgWidth * 3) / 2;
    const spacingY = imgHeight + 15;
    
    let imgCount = 0;
    
    for (const id of imageIds) {
        await new Promise(resolve => setTimeout(resolve, 0));
        const base64String = await getImageFromDB(id);
        if (!base64String) continue;
        
        const compressedBase64 = await compressImageForPDF(base64String);
        if (!compressedBase64) continue;
        
        const col = imgCount % 3;
        const row = Math.floor(imgCount / 3);
        
        let x = col * (imgWidth + spacingX) + marginX;
        let y = row * spacingY + yPos;
        
        if (y + imgHeight > pageHeight - margin) {
            doc.addPage();
            yPos = margin;
            imgCount = 0;
            const newRow = Math.floor(imgCount / 3);
            y = newRow * spacingY + yPos;
        }
        
        doc.addImage(compressedBase64, 'JPEG', x, y, imgWidth, imgHeight);
        imgCount++;
    }
    
    const rowsUsed = Math.ceil(imgCount / 3);
    yPosRef.y = yPos + (rowsUsed * spacingY) + 20;
    
    return yPosRef.y;
};

const addQuestionsTable = (doc, areaKey, config, data, yPosRef) => {
    const pageHeight = doc.internal.pageSize.height;
    const margin = 40;
    const body = [];
    
    config.forEach((pregunta, index) => {
        const name = `${areaKey.replace('_', '-')}-p${index}`;
        const respuesta = data.radios[name] || '';
        
        if (respuesta === 'NA') {
            return; 
        }

        const obs = data.comentariosPreguntas ? (data.comentariosPreguntas[name] || '') : '';
        
        let celdaC = '';
        let celdaNC = '';

        if (respuesta === 'C') {
            celdaC = { 
                content: 'X', 
                styles: { fillColor: [46, 204, 113], textColor: [255, 255, 255], halign: 'center', fontStyle: 'bold' } 
            };
        } else if (respuesta === 'NC') {
            celdaNC = { 
                content: 'X', 
                styles: { fillColor: [231, 76, 60], textColor: [255, 255, 255], halign: 'center', fontStyle: 'bold' } 
            };
        }
        
        body.push([pregunta, celdaC, celdaNC, obs]);
    });

    if (body.length === 0) return;

    doc.autoTable({
        startY: yPosRef.y,
        head: [['Pregunta', 'C', 'NC', 'Observaciones']],
        body: body,
        
        theme: 'grid',
        styles: { 
            lineColor: [200, 200, 200],
            lineWidth: 0.1,
        },

        headStyles: { fillColor: [44, 62, 80], halign: 'center', valign: 'middle', fontSize: 8 },
        bodyStyles: { fontSize: 8, valign: 'middle' }, 
        columnStyles: { 
            0: { cellWidth: 'auto' }, 
            1: { cellWidth: 25, halign: 'center' }, 
            2: { cellWidth: 25, halign: 'center' }, 
            3: { cellWidth: 150, halign: 'left' } 
        },
        didDrawPage: (hookData) => {
            if (hookData.pageNumber > hookData.settings.pageNumber) { yPosRef.y = margin; }
        },
        margin: { top: margin }
    });
    yPosRef.y = doc.autoTable.previous.finalY + 15;
};

const addMultipleItemTable = (doc, item, config, yPosRef) => {
    const margin = 40;
    const body = [];
    
    config.forEach((pregunta, qIndex) => {
        const respuesta = item.respuestas[qIndex] || '';
        
        if (respuesta === 'NA') {
            return;
        }

        const obs = (item.observaciones && item.observaciones[qIndex]) ? item.observaciones[qIndex] : '';

        let celdaC = '';
        let celdaNC = '';

        if (respuesta === 'C') {
            celdaC = { 
                content: 'X', 
                styles: { fillColor: [46, 204, 113], textColor: [255, 255, 255], halign: 'center', fontStyle: 'bold' } 
            };
        } else if (respuesta === 'NC') {
            celdaNC = { 
                content: 'X', 
                styles: { fillColor: [231, 76, 60], textColor: [255, 255, 255], halign: 'center', fontStyle: 'bold' } 
            };
        }
        
        body.push([pregunta, celdaC, celdaNC, obs]);
    });

    if (body.length === 0) return;

    doc.autoTable({
        startY: yPosRef.y,
        head: [['Pregunta', 'C', 'NC', 'Observaciones']],
        body: body,

        theme: 'grid',
        styles: { 
            lineColor: [200, 200, 200],
            lineWidth: 0.1,
        },

        headStyles: { fillColor: [52, 73, 94], halign: 'center', valign: 'middle', fontSize: 8 },
        bodyStyles: { fontSize: 8, valign: 'middle' }, 
        columnStyles: { 
            0: { cellWidth: 'auto' }, 
            1: { cellWidth: 25, halign: 'center' }, 
            2: { cellWidth: 25, halign: 'center' }, 
            3: { cellWidth: 150, halign: 'left' }
        },
        didDrawPage: (hookData) => { if (hookData.pageNumber > hookData.settings.pageNumber) { yPosRef.y = margin; } },
        margin: { top: margin }
    });
    yPosRef.y = doc.autoTable.previous.finalY + 15;
};

const addSectionTitle = (doc, title, yPosRef, forceNewPage = false) => {
    const pageHeight = doc.internal.pageSize.height;
    const pageWidth = doc.internal.pageSize.width;
    const margin = 40;
    const rectHeight = 22;
    const spacingAfter = 15;
    if (forceNewPage || (yPosRef.y + rectHeight + spacingAfter > pageHeight - margin)) {
        doc.addPage();
        yPosRef.y = margin;
    }
    doc.setFillColor(44, 62, 80); 
    doc.rect(margin, yPosRef.y, pageWidth - margin * 2, rectHeight, 'F');
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255, 255, 255);
    const textY = yPosRef.y + (rectHeight / 2) + 5;
    doc.text(title, margin + 10, textY);
    doc.setTextColor(51, 51, 51);
    yPosRef.y += rectHeight + spacingAfter;
};

async function addHeaderAndComments(doc, data, yPosRef) {
    const pageWidth = doc.internal.pageSize.width;
    const margin = 40;
    const logoBase64 = logoBase64_Cache; 
    let textX = margin;
    const logoWidth = 30, logoHeight = 30, logoX = margin;
    const startYText = yPosRef.y + 10; 
    const lineHeight = 15;

    if (logoBase64) {
        try {
            doc.addImage(logoBase64, "PNG", logoX, yPosRef.y, logoWidth, logoHeight);
            textX = logoX + logoWidth + 10;
        } catch (e) { console.error("Error al añadir el logo:", e); }
    }
    
    doc.setFontSize(16); 
    doc.setFont('helvetica', 'bold');
    doc.text('Reporte de Supervisión', textX, startYText);
    
    doc.setFontSize(11); 
    doc.setFont('helvetica', 'normal');
    
    let fechaFormateada = data.fecha || 'N/A';
    if (data.fecha) {
        try {
            const fechaObj = new Date(data.fecha + 'T00:00:00'); 
            fechaFormateada = fechaObj.toLocaleDateString('es-ES', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            fechaFormateada = fechaFormateada.charAt(0).toUpperCase() + fechaFormateada.slice(1);
        } catch(e) { fechaFormateada = data.fecha; }
    }
    doc.text(`Fecha: ${fechaFormateada}`, textX, startYText + lineHeight);
    
    let locationInfo = `Proyecto: ${data.proyecto || 'N/A'}`;
    if (data.ubicacion && data.ubicacion !== 'N/A') {
        locationInfo += `, Ubicación: ${data.ubicacion}`;
    }
    doc.text(locationInfo, textX, startYText + (lineHeight * 2));
    yPosRef.y += logoHeight + 20;

    let comentarios = '';
    if (data.comentarios) { comentarios = data.comentarios; }
    
    if (comentarios) {
        addSectionTitle(doc, 'Comentarios Finales', yPosRef, false);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        const textLines = doc.splitTextToSize(comentarios, pageWidth - margin * 2);
        doc.text(textLines, margin, yPosRef.y);
        yPosRef.y += textLines.length * 14 + 15;
    }
    
    doc.setDrawColor(221, 221, 221);
    doc.line(margin, yPosRef.y, pageWidth - margin, yPosRef.y);
    yPosRef.y += 15;
}

async function generatePDFContent(doc, data, yPosRef) {
    const pageHeight = doc.internal.pageSize.height;
    const margin = 40;
    let isFirstSection = true;
    
    // Procesar páginas disponibles (ya filtradas)
    for (const pageConfig of paginasDisponibles) {
        if (pageConfig.tipo === 'simple') {
            const { areaKey, titulo } = pageConfig;
            const toggleName = `calificar-${areaKey}`;
            
            if (data.toggles && data.toggles[toggleName] === 'si') {
                addSectionTitle(doc, titulo, yPosRef, !isFirstSection); 
                isFirstSection = false;
                
                addQuestionsTable(doc, areaKey, QUESTIONS_CONFIG[areaKey], data, yPosRef);
                
                const previewId = `preview-${areaKey}`;
                if (data.fotos && data.fotos[previewId]) {
                    await addPhotos(doc, data.fotos[previewId], yPosRef, pageHeight, margin);
                }
            }
        }
    }
    
    // Procesar páginas múltiples disponibles
    for (const pageConfig of paginasDisponibles) {
        if (pageConfig.tipo === 'multiple') {
            const { areaKey, titulo } = pageConfig;
            const toggleName = `calificar-${areaKey}`;
            
            if (data.toggles && data.toggles[toggleName] === 'si' && 
                data.multipleData && data.multipleData[areaKey]) {
                
                for (const item of data.multipleData[areaKey]) {
                    addSectionTitle(doc, `${titulo}: ${item.numero}`, yPosRef, !isFirstSection); 
                    isFirstSection = false;
                    
                    addMultipleItemTable(doc, item, QUESTIONS_CONFIG[areaKey], yPosRef);
                    
                    if (item.fotos) {
                        await addPhotos(doc, item.fotos, yPosRef, pageHeight, margin);
                    }
                }
            }
        }
    }
}

/**
 * Función principal para generar el PDF.
 */
async function generatePDF() {
    
    Swal.fire({
        title: 'Generando Reporte',
        html: 'Por favor espera...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'pt', 'letter');
    const dataString = localStorage.getItem(SESSION_KEY);
    if (!dataString) {
        Swal.fire('Error', 'No se encontraron datos de sesión.', 'error'); return;
    }
    const data = JSON.parse(dataString);

    // Generar nombre de archivo dinámico
    let fechaFormateada = 'dd-mm-aaaa';
    if (data.fecha) {
        const parts = data.fecha.split('-'); 
        if (parts.length === 3) {
            fechaFormateada = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
    }
    
    const proyecto = data.proyecto || 'Proyecto';
    const ubicacion = data.ubicacion || 'Ubicación';
    
    let nombreArchivoBase = `${fechaFormateada} - Reporte de Supervisión - ${proyecto}`;
    
    if (ubicacion !== 'N/A') {
        nombreArchivoBase += ` - ${ubicacion}`;
    }
    
    const nombreArchivoFinal = `${nombreArchivoBase}.pdf`;

    const margin = 40;
    let yPosRef = { y: margin }; 

    // 1. Añadir Cabecera y Comentarios
    await addHeaderAndComments(doc, data, yPosRef);

    // 2. Generar contenido del PDF (solo páginas disponibles)
    await generatePDFContent(doc, data, yPosRef);

    // 3. Añadir pies de página
    addPageFooters(doc); 
    
    // 4. Generar Blob
    const pdfBlob = doc.output('blob');
    const pdfFile = new File([pdfBlob], nombreArchivoFinal, { type: 'application/pdf' });
    
    Swal.close();
    
    // 5. Opciones de Compartir/Descargar
    const canShare = navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] });

    if (canShare) {
        Swal.fire({
            title: '¡Reporte Generado!',
            icon: 'success',
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-share-alt me-2"></i> Compartir',
            cancelButtonText: '<i class="fas fa-download me-2"></i> Descargar',
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    await navigator.share({
                        title: 'Reporte de Supervisión',
                        text: `Reporte de ${data.proyecto}`,
                        files: [pdfFile]
                    });
                } catch (err) {
                    Swal.fire('Cancelado', 'No se pudo compartir.', 'info');
                }
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                doc.save(nombreArchivoFinal);
            }
        });
    } else {
        Swal.fire({
            title: '¡Reporte Generado!',
            icon: 'success',
            confirmButtonText: '<i class="fas fa-download me-2"></i> Descargar',
        }).then(async (result) => {
            doc.save(nombreArchivoFinal);
        });
    }
}

// =========================================================================
// FUNCIONES AUXILIARES
// =========================================================================

/**
 * Controla la visibilidad del botón flotante
 */
function updateFloatingButtonVisibility() {
    const $activePage = $('.pagina.active');
    const $visibleUploadArea = $activePage.find('.area-supervision').filter(':visible').find('.file-upload');
    
    if ($visibleUploadArea.length > 0) {
        $('#btn-camara-flotante').fadeIn();
    } else {
        $('#btn-camara-flotante').fadeOut();
    }
}

// Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw-index.js')
            .then(function(registration) {
                console.log('✅ Service Worker de Llaves registrado con éxito:', registration.scope);
            })
            .catch(function(error) {
                console.log('❌ Error al registrar Service Worker de Llaves:', error);
            });
    });
}

</script>
</body>
</html>
