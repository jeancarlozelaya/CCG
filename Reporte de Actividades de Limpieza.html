<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Reporte de Limpiezas Profundas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f9f9f9;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 10vh;
    }

    /* Header */
    .header {
        background-color: #007BFF;
        color: white;
        text-align: center;
        padding: 15px;
        width: 100%;
        font-size: 1.5em;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Contenedor del formulario */
    .container {
        background: #ffffff;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        text-align: center;
        margin: 40px auto;
        grid-row: 2;
        height: auto;
        box-sizing: border-box;
        position: relative; /* Añadido para posicionar el icono de ayuda */
    }

    h1 {
        text-align: center;
        color: #333;
    }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    input[type="date"],
    textarea,
    input[type="file"],
    button {
        width: 100%;
        margin-top: 5px;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }
    
    select {
        width: 100%;
        margin-top: 5px;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        background-color: #f9f9f9; /* Color de fondo para el select */
        color: #333;
    }

    button {
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
        padding: 12px 0;
    }

    button:hover:not(:disabled) { /* Solo al hacer hover si no está deshabilitado */
        background-color: #0056b3;
    }

    button:disabled { /* Estilo para el botón deshabilitado */
        background-color: #cccccc;
        cursor: not-allowed;
    }

    /* Estilo para los contenedores de vista previa */
    .image-preview {
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        border: 0px solid #ccc;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        box-sizing: border-box;
    }

    .image-preview-item {
        position: relative;
        width: 85px;
        height: 85px;
        overflow: hidden;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .delete-icon {
        position: absolute;
        top: 5px;
        left: 5px;
        width: 20px;
        height: 20px;
        background: rgba(255, 0, 0, 0.8);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .image-preview-item:hover .delete-icon {
        opacity: 1;
    }

    /* Estilos para el área de carga de imágenes */
    .file-upload {
        display: block;
        position: relative;
        width: 100%;
        padding: 20px;
        background: #f0f8ff;
        border: 2px dashed #007BFF; /* Borde inicial azul */
        text-align: center;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
        box-sizing: border-box;
        padding: 40px 20px;
        color: #007BFF;
        transition: background-color 0.3s ease, border-color 0.3s ease;
        margin: 10px 0;
    }

    .file-upload:hover {
        border-color: #0056b3;
    }

    .file-upload input[type="file"] {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    /* Estilo para los contenedores de preguntas */
    .question-container {
        margin-bottom: 20px;
        text-align: left;
        padding: 10px;
        border: 2px solid #ccc; /* Borde predeterminado */
        border-radius: 5px;
        background-color: #f9f9f9;
        transition: border-color 0.3s;
        box-sizing: border-box;
    }

    /* Estilo para el campo de descripción */
    .question-container textarea {
    	padding: 15px; 
    	border: 2px solid #ccc; /* Borde predeterminado */
    	border-radius: 5px;
    	width: 100%;
    	font-size: 16px;
    	background-color: #f9f9f9;
    	color: #333;
    	transition: border-color 0.3s;
    	box-sizing: border-box;
    	margin-top: 5px;
    	height: 200px; 
    	resize: vertical; 
    }

    .question-container:hover {
        border-color: #007BFF;
    }

    .question-container input[type="date"],
    .question-container textarea,
    .question-container select,
    .question-container input[type="number"],
    .question-container input[type="time"] { /* Added input[type="time"] */
        padding: 10px;
        border: 2px solid #ccc; /* Borde predeterminado */
        border-radius: 5px;
        width: 100%;
        font-size: 16px;
        background-color: #f9f9f9;
        color: #333;
        transition: border-color 0.3s;
        box-sizing: border-box;
        margin-top: 5px;
    }

    .question-container input[type="date"]:focus,
    .question-container textarea:focus,
    .question-container select:focus,
    .question-container input[type="number"]:focus,
    .question-container input[type="time"]:focus { /* Added input[type="time"] */
        border-color: #007BFF;
        outline: none;
    }

    /* Estilos de las etiquetas */
    .question-container label {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
        display: block;
    }

    /* Clases para los bordes de validación */
    .field-error {
        border-color: red !important;
    }

    .field-success {
        border-color: green !important;
    }

    /* Help Icon Button */
    .help-icon-button {
        position: absolute;
        top: 15px; 
        right: 15px; 
        cursor: pointer;
        background-color: #e6f2ff; /* Light blue background */
        border-radius: 50%;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        color: #007BFF; /* Icon color */
    }

    .help-icon-button:hover {
        background-color: #cce0ff; /* Darker blue on hover */
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        transform: scale(1.05);
    }

    .help-icon-button svg {
        width: 28px; /* Slightly larger icon */
        height: 28px;
        fill: currentColor; /* Use parent's color */
    }

    /* Custom styles for SweetAlert2 modals */
    /* Adjust overall popup size for general display */
    .swal2-popup {
        max-width: 500px !important; /* Control overall max-width */
        width: 90% !important; /* Make it responsive */
        padding: 1em !important; /* Adjust padding for a tighter look */
        /* SweetAlert2 title is outside html-container, so its padding affects overall layout */
    }

    /* Styles for the "Super Novel Menu" buttons */
    .activity-menu-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* FORCED TWO COLUMNS */
        gap: 15px; /* Space between buttons */
        padding: 10px;
    }

    .activity-menu-button {
        background-color: #007bff; /* Primary color */
        color: white;
        border: none;
        border-radius: 8px;
        padding: 15px 20px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center; /* Center content horizontally */
        gap: 10px; /* Space between icon and text */
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.2s ease-in-out;
    }

    .activity-menu-button:hover {
        background-color: #0056b3; /* Darker blue on hover */
        transform: translateY(-3px); /* Slight lift effect */
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    /* Specific custom class for the menu popup itself to control its size */
    .swal2-menu-popup {
        max-width: 600px !important; /* Can be wider for menu if needed */
        width: 90% !important; /* Make it responsive */
    }

    .swal2-list-item {
        margin-bottom: 8px; /* Espacio entre ítems de la lista de instrucciones */
    }

    /* Style for the new back button in SweetAlert2 */
    .swal2-back-button { /* Custom class for the back button */
        background-color: #6c757d; /* Grey color for back button */
        color: white;
        border: none;
        border-radius: 50%; /* Make it round */
        width: 40px; /* Adjust size */
        height: 40px; /* Adjust size */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
        z-index: 10; /* Ensure it's above other content */
        position: absolute; /* Keep absolute within its new container for exact positioning */
        top: 15px; /* Adjusted: Pushed down from the top edge of custom-modal-header */
        left: 10px; /* Adjust relative to custom header */
    }

    .swal2-back-button:hover {
        background-color: #5a6268;
        transform: scale(1.05);
    }

    /* Container for custom header (back button + title) within swal2-html-container */
    .custom-modal-header {
        display: flex;
        align-items: center; /* Vertically center items */
        position: relative; /* For absolute positioning of the button */
        width: 100%;
        min-height: 50px; /* Changed from height to min-height for flexibility */
        margin-bottom: 10px; /* Space below the header */
        padding-top: 15px; /* NEW: Added padding-top to push content down */
    }

    .custom-modal-header h2 {
        flex-grow: 1; /* Title takes up remaining space */
        text-align: center;
        margin: 0;
        font-size: 1.4em; /* Adjust title size */
        padding-left: 50px; /* Space for the back button */
        padding-right: 50px; /* Balance for centering */
        box-sizing: border-box;
    }

    /* Ensure swal2-html-container itself doesn't have extra padding that pushes content */
    .swal2-html-container {
        text-align: left;
        margin: 0 !important; /* Remove default margin */
        padding: 0 !important; /* Remove default padding for this custom case */
        width: 100%; /* Ensure it spans full width */
        box-sizing: border-box;
    }

    /* Adjust the popup padding only, no specific htmlContainer padding for content */
    .swal2-detail-popup {
        padding: 1em !important; /* Overall popup padding */
    }

    /* Hide default SweetAlert2 title for detail view */
    .swal2-detail-popup .swal2-title {
        display: none !important;
    }

    /* NEW: Styles for the SweetAlert2 close button (the 'X') */
    .swal2-close {
        box-shadow: none !important; /* Remove shadow */
        color: red !important; /* Change 'X' color to red */
        font-size: 1.8em !important; /* Make X slightly larger for visibility */
        top: 0.5em !important; /* Adjust position if needed after size change */
        right: 0.5em !important; /* Adjust position if needed after size change */
    }
</style>


</head>
<body>

 <div class="header">
  Pisos Brillantes
 </div>

 <div class="container">
    <div id="helpIconContainer" class="help-icon-button" title="Ayuda sobre actividades">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.43 14.07 13 14.59 13 15h-2v-.5c0-1.1.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.5-.72 2.76-1.87 3.49z"/>
        </svg>
    </div>
    <h1>Reporte de Actividades de Limpieza</h1>
    <div class="form-container">
        <div class="question-container" id="fechaContainer">
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" name="fecha" required>
        </div>

        <div class="question-container" id="horariosContainer">
            <label>Horario de Actividad:</label>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <div style="flex: 1;">
                    <label for="horaInicio" style="font-weight: normal; font-size: 0.9em;">Hora de Inicio:</label>
                    <input type="time" id="horaInicio" name="horaInicio" required>
                </div>
                <div style="flex: 1;">
                    <label for="horaFin" style="font-weight: normal; font-size: 0.9em;">Hora de Fin:</label>
                    <input type="time" id="horaFin" name="horaFin" required>
                </div>
            </div>
        </div>

<div class="question-container" id="edificioContainer">
    <label for="edificio">Edificio / Áreas:</label>
    <select id="edificio" name="edificio" required>
        <option value="">Selecciona un edificio/área</option>
        <option value="Torre #1">Torre #1</option>
        <option value="Torre #2">Torre #2</option>
        <option value="CBA">CBA</option>
        <option value="CBB">CBB</option>
        <option value="CBC">CBC</option>
        <option value="Sótano">Sótano</option>
        <option value="Elevadores Públicos">Elevadores Públicos</option>
        <option value="Mezanine">Mezanine</option>
        <option value="Plazas">Plazas</option>
        <option value="Exteriores">Exteriores</option>
    </select>
</div>

<div class="question-container" id="nivelContainer" style="display: none;">
    <label for="nivel">Nivel:</label>
    <input type="number" id="nivel" name="nivel" placeholder="Ingrese el número de nivel" required>
</div>

<div class="question-container" id="actividadContainer" style="display: none;">
    <label for="actividad">Actividad:</label>
    <select id="actividad" name="actividad" required>
        <option value="">Selecciona una actividad</option>
    </select>
</div>

        <div class="question-container" id="subActividadContainer" style="display: none;">
            <label for="subActividad">Sub-actividad:</label>
            <select id="subActividad" name="subActividad" required>
                <option value="">Selecciona una sub-actividad</option>
            </select>
        </div>

        <div class="question-container" id="oficinaContainer" style="display: none;">
            <label for="oficina">Oficina:</label>
            <input type="number" id="oficina" name="oficina" placeholder="Ingrese el número de oficina" required>
        </div>

        <div class="question-container" id="descripcionContainer" style="display: none;">
            <label for="descripcion">Descripción de la actividad:</label>
            <textarea id="descripcion" name="descripcion" rows="5" placeholder="Describe la actividad realizada"></textarea>
        </div>

        <div class="question-container" id="adjunto3Container">
            <label for="adjunto3">Fotos de la Limpieza (Antes):</label>
            <div class="file-upload" id="drag-area3" onclick="document.getElementById('adjunto3').click()">
                <input type="file" id="adjunto3" name="adjunto3" accept="image/*" multiple>
                <span class="file-upload-text">Haz clic o arrastra imágenes para adjuntarlas</span>
            </div>
            <div id="preview3" class="image-preview"></div>
        </div>

        <div class="question-container" id="adjunto4Container">
            <label for="adjunto4">Fotos de la Limpieza (Después):</label>
            <div class="file-upload" id="drag-area4" onclick="document.getElementById('adjunto4').click()">
                <input type="file" id="adjunto4" name="adjunto4" accept="image/*" multiple>
                <span class="file-upload-text">Haz clic o arrastra imágenes para adjuntarlas</span>
            </div>
            <div id="preview4" class="image-preview"></div>
        </div>

        <button type="button" id="generarReporteBtn" onclick="generarPDF()" disabled>Generar Reporte</button>
    </div>
</div>

<script>
    const formFields = [
        { id: 'fecha', type: 'input' },
        { id: 'edificio', type: 'select' },
        { id: 'nivel', type: 'input' },
        { id: 'actividad', type: 'select' }, 
        { id: 'subActividad', type: 'select' }, 
        { id: 'horaInicio', type: 'input' }, 
        { id: 'horaFin', type: 'input' },   
    // Quitamos preview3 para que no sea obligatorio
        { id: 'preview4', type: 'image' }
    ];

    // Establecer la fecha y hora actual por defecto
    window.onload = function() {
        const fechaInput = document.getElementById("fecha");
        const horaInicioInput = document.getElementById("horaInicio");

        const today = new Date();
        const year = today.getFullYear();
        let mm = today.getMonth() + 1; 
        let dd = today.getDate();
        let hours = today.getHours();
        let minutes = today.getMinutes();

        if (mm < 10) mm = '0' + mm;
        if (dd < 10) dd = '0' + dd;
        hours = hours < 10 ? '0' + hours : hours;
        minutes = minutes < 10 ? '0' + minutes : minutes;

        const formattedDate = year + '-' + mm + '-' + dd;
        fechaInput.value = formattedDate;
        horaInicioInput.value = `${hours}:${minutes}`; 

        formFields.forEach(field => validateField(field.id));
        updateButtonState();
        updateTimeFieldVisibility(); 
    };

    const selectedFiles = {
        preview3: [],
        preview4: [] 
    };

    // Función para actualizar la visibilidad de los campos de hora
    function updateTimeFieldVisibility() {
        const actividad = document.getElementById('actividad').value;
        const subActividad = document.getElementById('subActividad').value;
        const horariosContainer = document.getElementById('horariosContainer'); 
        const horaInicioInput = document.getElementById('horaInicio');
        const horaFinInput = document.getElementById('horaFin');

        if (actividad === 'Limpieza de Oficina' && (subActividad === 'Aspirado' || subActividad === 'Shampuseado de Alfombras')) {
            horariosContainer.style.display = 'none'; 
            horaInicioInput.value = ''; 
            horaFinInput.value = '';     
        } else {
            horariosContainer.style.display = 'block'; 
            if (horaInicioInput.value === '') {
                const now = new Date();
                let hours = now.getHours();
                let minutes = now.getMinutes();
                hours = hours < 10 ? '0' + hours : hours;
                minutes = minutes < 10 ? '0' + minutes : minutes;
                horaInicioInput.value = `${hours}:${minutes}`;
            }
        }
        updateButtonState(); 
    }

    // Lógica para el menú anidado y la visibilidad del campo de oficina
    document.getElementById('actividad').addEventListener('change', function() {
        const subActividadContainer = document.getElementById('subActividadContainer');
        const subActividadSelect = document.getElementById('subActividad');
        const oficinaContainer = document.getElementById('oficinaContainer');
        const oficinaInput = document.getElementById('oficina');
        const currentActivity = this.value;

        subActividadSelect.innerHTML = '<option value="">Selecciona una sub-actividad</option>';
        subActividadContainer.style.display = 'none';
        subActividadSelect.removeAttribute('required');
        oficinaContainer.style.display = 'none';
        oficinaInput.value = '';

        const oficinaIndex = formFields.findIndex(f => f.id === 'oficina');
        if (oficinaIndex > -1) {
            formFields.splice(oficinaIndex, 1);
        }

        if (currentActivity === 'Limpieza de Baños') {
            subActividadContainer.style.display = 'block';
            subActividadSelect.setAttribute('required', 'required');
            const options = ['Repaso de Baño', 'Profunda de Baño', 'Períodica de Baño'];
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                subActividadSelect.appendChild(opt);
            });
        } else if (currentActivity === 'Limpieza de Oficina') {
            subActividadContainer.style.display = 'block';
            subActividadSelect.setAttribute('required', 'required');
            oficinaContainer.style.display = 'block';
            oficinaInput.setAttribute('required', 'required'); // Office is required for office cleaning
            const options = ['Aspirado', 'Rutinaria', 'Shampuseado de Alfombras'];
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                subActividadSelect.appendChild(opt);
            });
             if (!formFields.find(f => f.id === 'oficina')) {
                formFields.push({ id: 'oficina', type: 'input' });
                oficinaInput.addEventListener('input', updateButtonState);
                oficinaInput.addEventListener('change', updateButtonState);
            }
        }

        validateField('actividad');
        validateField('subActividad');
        updateTimeFieldVisibility(); 
        updateButtonState();
    });

    document.getElementById('subActividad').addEventListener('change', function() {
        validateField('subActividad');
        updateTimeFieldVisibility(); 
        updateButtonState(); 
    });


    // Lógica para establecer el nivel máximo según el edificio
// Modificar el event listener del campo Edificio/Áreas
document.getElementById('edificio').addEventListener('change', function() {
    const nivelInput = document.getElementById('nivel');
    const nivelContainer = document.getElementById('nivelContainer');
    const actividadContainer = document.getElementById('actividadContainer');
    const actividadSelect = document.getElementById('actividad');
    const selectedEdificio = this.value;

    // Resetear campos dependientes
    nivelInput.value = '';
    actividadSelect.innerHTML = '<option value="">Selecciona una actividad</option>';
    
    // Ocultar campos inicialmente
    nivelContainer.style.display = 'none';
    actividadContainer.style.display = 'none';
    nivelInput.removeAttribute('required');

    // Mostrar nivel solo para edificios con niveles
    const edificiosConNiveles = ['Torre #1', 'Torre #2', 'CBA', 'CBB', 'CBC', 'Sótano'];
    if (edificiosConNiveles.includes(selectedEdificio)) {
        nivelContainer.style.display = 'block';
        nivelInput.setAttribute('required', 'required');
        
        // Configurar niveles máximos según edificio
        let maxLevel = -1;
        switch (selectedEdificio) {
            case 'Torre #1': maxLevel = 23; break;
            case 'Torre #2': maxLevel = 24; break;
            case 'CBA': maxLevel = 5; break;
            case 'CBB': maxLevel = 7; break;
            case 'CBC': maxLevel = 7; break;
            case 'Sótano': maxLevel = 4; break;
        }
        
        if (maxLevel !== -1) {
            nivelInput.setAttribute('max', maxLevel);
            nivelInput.setAttribute('min', 0);
            nivelInput.placeholder = `Ingrese el número de nivel (0-${maxLevel})`;
        }
    }

    // Configurar actividades según edificio/área seleccionado
    if (selectedEdificio) {
        actividadContainer.style.display = 'block';
        
        // Limpiar opciones anteriores
        actividadSelect.innerHTML = '<option value="">Selecciona una actividad</option>';
        
        // Agregar nuevas opciones según la selección
        switch (selectedEdificio) {
            case 'Torre #1':
            case 'Torre #2':
            case 'CBA':
            case 'CBB':
            case 'CBC':
                agregarOpcionesActividad([
                    'Baños Comunes & Núcleos',
                    'Baños Privados',
                    'Elevadores',
                    'Oficina & Espacios Abiertos',
                    'Atención al Público',
                    'Sala de Juntas',
                    'Aspirado de Alfombras'
                ]);
                break;
                
            case 'Sótano':
                agregarOpcionesActividad([
                    'Repaso de Sótano',
                    'Repaso de Baños'
                ]);
                break;
                
            case 'Elevadores Públicos':
                agregarOpcionesActividad([
                    'L40, L41, L42, L47',
                    'L43, L44, L45, L46'
                ]);
                break;
                
            case 'Mezanine':
                agregarOpcionesActividad([
                    'Repaso de Baños',
                    'Atención al Público'
                ]);
                break;
                

            case 'Plazas':
                agregarOpcionesActividad([
                    'Democracia',
                    'Etnias'
                ]);
                break;

            case 'Exteriores':
                // No mostrar actividades para estas áreas
                actividadContainer.style.display = 'none';
                break;
        }
    }

    // Validar campos después de los cambios
    validateField('edificio');
    validateField('nivel');
    validateField('actividad');
    updateButtonState();
});

// Función auxiliar para agregar opciones al select de actividades
function agregarOpcionesActividad(opciones) {
    const actividadSelect = document.getElementById('actividad');
    opciones.forEach(opcion => {
        const opt = document.createElement('option');
        opt.value = opcion;
        opt.textContent = opcion;
        actividadSelect.appendChild(opt);
    });
}



    // Función para validar un campo específico y aplicar el estilo de borde
function validateField(fieldId) {
    const element = document.getElementById(fieldId);
    if (!element) return true;

    const container = element.closest('.question-container') || element;

    if (container.style.display === 'none') {
        return true;
    }

    let isValid = false;
    
    if (fieldId === 'fecha') {
        isValid = element.value.trim() !== '';
    }
    else if (fieldId === 'edificio') {
        isValid = element.value.trim() !== '';
    } 
    else if (fieldId === 'nivel') {
        const edificio = document.getElementById('edificio').value;
        const edificiosConNiveles = ['Torre #1', 'Torre #2', 'CBA', 'CBB', 'CBC', 'Sótano'];
        
        if (edificiosConNiveles.includes(edificio)) {
            const nivelValue = parseInt(element.value);
            const maxLevel = parseInt(element.getAttribute('max'));
            
            if (element.value.trim() === '' || isNaN(nivelValue)) {
                isValid = false;
            } else {
                if (nivelValue < 0 || (!isNaN(maxLevel) && nivelValue > maxLevel)) {
                    element.value = '';
                    isValid = false;
                } else {
                    isValid = true;
                }
            }
        } else {
            isValid = true;
        }
    }
    else if (fieldId === 'actividad') {
        const edificio = document.getElementById('edificio').value;
        // Cambio importante aquí: ahora Plazas requiere actividad
        if (edificio === 'Exteriores') {
            isValid = true; // Exteriores no necesita actividad
        } else {
            isValid = element.value.trim() !== '';
        }
    }
    else if (fieldId === 'horaInicio') {
        isValid = element.value.trim() !== '';
    }
    else if (fieldId === 'horaFin') {
        if (element.value.trim() === '') {
            isValid = false;
        } else {
            const horaInicio = document.getElementById('horaInicio').value;
            if (horaInicio.trim() === '') {
                isValid = false;
            } else {
                const [hI, mI] = horaInicio.split(':').map(Number);
                const [hF, mF] = element.value.split(':').map(Number);
                
                const totalMinutesInicio = hI * 60 + mI;
                const totalMinutesFin = hF * 60 + mF;

                isValid = totalMinutesFin > totalMinutesInicio;
            }
        }
    }
    else if (fieldId === 'preview3') {
        isValid = true; // Fotos "antes" son opcionales
    }
    else if (fieldId === 'preview4') {
        isValid = selectedFiles.preview4.length > 0; // Fotos "después" son obligatorias
    }
    else if (fieldId === 'oficina') {
        const actividad = document.getElementById('actividad').value;
        if (actividad === 'Oficina & Espacios Abiertos' || actividad === 'Sala de Juntas') {
            isValid = element.value.trim() !== '';
        } else {
            isValid = true;
        }
    }
    else {
        isValid = element.value.trim() !== '';
    }

    if (isValid) {
        container.classList.remove('field-error');
        container.classList.add('field-success');
    } else {
        container.classList.remove('field-success');
        container.classList.add('field-error');
    }
    
    return isValid;
}



function updateButtonState() {
    const generarReporteBtn = document.getElementById('generarReporteBtn');
    let allFieldsValid = true;

    formFields.forEach(field => {
        if (!validateField(field.id)) {
            allFieldsValid = false;
        }
    });

    generarReporteBtn.disabled = !allFieldsValid;
}

    // Añadir EventListeners a los campos para la validación en tiempo real
    formFields.forEach(field => {
        if (field.type === 'input' || field.type === 'select' || field.type === 'textarea') {
            const element = document.getElementById(field.id);
            if (element) { 
                if (field.id !== 'nivel') { 
                    element.addEventListener('input', updateButtonState);
                }
                element.addEventListener('change', updateButtonState);
            }
        }
    });

    function handleFileInput(event, previewId) {
        const files = event.target.files;
        const previewContainer = document.getElementById(previewId);

        Array.from(files).forEach((file) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const div = document.createElement('div');
                div.classList.add('image-preview-item');
                div.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div class="delete-icon" onclick="deleteImage('${previewId}', ${selectedFiles[previewId].length})">×</div>
                `;
                previewContainer.appendChild(div);

                selectedFiles[previewId].push(file);
                updateButtonState(); 
            };
            reader.readAsDataURL(file);
        });

        event.target.value = "";
    }

    function deleteImage(previewId, index) {
        const previewContainer = document.getElementById(previewId);

        if (previewContainer.children[index]) {
            previewContainer.removeChild(previewContainer.children[index]);
            selectedFiles[previewId].splice(index, 1);

            Array.from(previewContainer.children).forEach((child, newIndex) => {
                const deleteIcon = child.querySelector('.delete-icon');
                if (deleteIcon) {
                    deleteIcon.setAttribute('onclick', `deleteImage('${previewId}', ${newIndex})`);
                }
            });
            updateButtonState(); 
        }
    }

    document.getElementById('adjunto3').addEventListener('change', (e) => handleFileInput(e, 'preview3')); 
    document.getElementById('adjunto4').addEventListener('change', (e) => handleFileInput(e, 'preview4')); 

    const dragAreas = ['drag-area3', 'drag-area4']; 
    dragAreas.forEach(area => {
        const dragArea = document.getElementById(area);
        dragArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragArea.style.backgroundColor = "#e0f7ff"; 
        });

        dragArea.addEventListener('dragleave', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragArea.style.backgroundColor = "#f0f8ff"; 
        });

        dragArea.addEventListener('drop', (event) => {
            event.preventDefault();
            event.stopPropagation();
            const files = event.dataTransfer.files;
            const previewId = area.replace("drag-area", "preview");
            handleFileInput({ target: { files } }, previewId);
        });
    });




async function generarPDF() {
    if (document.getElementById('generarReporteBtn').disabled) {
        Swal.fire({
            icon: 'warning',
            title: 'Campos Incompletos',
            html: '<div style="text-align: center;">Por favor, complete todos los campos obligatorios antes de generar el reporte.</div>',
            confirmButtonColor: '#007bff'
        });
        return;
    }

    Swal.fire({
        title: 'Procesando...',
        html: '<div style="text-align: center;">Generando su reporte PDF. Por favor, espere. <br> <span style="font-size: 0.8em;">Esto puede tardar un momento si hay muchas imágenes.</span></div>',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ format: 'letter' });
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    async function getLogoBase64() {
        if (navigator.onLine) {
            try {
                const response = await fetch("https://jeancarlozelaya.github.io/PIBRISA/Im%C3%A1genes/Icono.png");
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (error) {
                console.error("Error al cargar el logo, se omitirá:", error);
                return null;
            }
        } else {
            console.warn("Sin conexión a Internet, se omitirá la carga del logo.");
            return null;
        }
    }

    const logoBase64 = await getLogoBase64();
    
    // Obtener datos del formulario
    const fecha = document.getElementById('fecha').value;
    const edificio = document.getElementById('edificio').value;
    const nivel = document.getElementById('nivel').value;
    const actividad = document.getElementById('actividad').value;
    const oficinaInput = document.getElementById('oficina');
    const oficina = oficinaInput.closest('.question-container').style.display === 'block' ? oficinaInput.value : '';
    const horaInicio = document.getElementById('horaInicio').value;
    const horaFin = document.getElementById('horaFin').value;

    pdf.setFont("times", "bold");

    let currentY = 15;
    let textX = 10;
    const logoWidth = 30;
    const logoHeight = 30;
    const logoX = 10;

    if (logoBase64) {
        pdf.addImage(logoBase64, "PNG", logoX, currentY, logoWidth, logoHeight);
        textX = logoX + logoWidth + 5;
    }

    const startYText = logoBase64 ? (currentY + 5) : currentY;
    const lineHeight = 10;

    // Título del reporte
    pdf.setFontSize(16);
    pdf.text("Reporte de Actividades de Limpieza", textX, startYText, { align: "left" });

    currentY = startYText + lineHeight;
    
    // Fecha
    pdf.setFontSize(14);
    pdf.text(`Fecha: ${fecha}`, textX, currentY, { align: "left" });
    currentY += lineHeight;

    // Horario solo si tiene valores
    if (horaInicio && horaFin) {
        pdf.text(`Horario: ${horaInicio} - ${horaFin}`, textX, currentY, { align: "left" });
        currentY += lineHeight;
    }

    // Edificio/Área y Nivel (solo si aplica)
    let locationInfo = `Edificio/Área: ${edificio}`;
    const edificiosConNiveles = ['Torre #1', 'Torre #2', 'CBA', 'CBB', 'CBC', 'Sótano'];
    if (edificiosConNiveles.includes(edificio) && nivel) {
        locationInfo += `, Nivel: ${nivel}`;
    }
    pdf.text(locationInfo, textX, currentY, { align: "left" });
    currentY += lineHeight;

    // Actividad solo si existe
    if (actividad) {
        if (edificio === 'Plazas') {
            // Mostrar actividad para plazas (Democracia/Etnias)
            pdf.text(`Plaza: ${actividad}`, textX, currentY, { align: "left" });
            currentY += lineHeight;
        } else if (!['Plazas', 'Exteriores'].includes(edificio)) {
            // Mostrar actividad normal para otros edificios
            pdf.text(`Actividad: ${actividad}`, textX, currentY, { align: "left" });
            currentY += lineHeight;
        }
    }

    // Oficina solo si aplica
    if (oficina && (actividad === 'Oficina & Espacios Abiertos' || actividad === 'Sala de Juntas')) {
        pdf.text(`Oficina: ${oficina}`, textX, currentY, { align: "left" });
        currentY += lineHeight;
    }

    // Función para añadir sección de fotos
    async function addPhotoSection(title, files, startY) {
        if (files.length === 0) return startY;

        let currentY = startY;

        const spaceNeeded = 10 + 10 + 40;
        if (currentY + spaceNeeded > pageHeight - 10) {
            pdf.addPage();
            currentY = 15;
        }

        pdf.setFontSize(14);
        pdf.setFont("times", "bold");
        pdf.text(title, 10, currentY);
        currentY += 10;

        const imgWidth = 60;
        const imgHeight = 40;
        const marginX = 15;
        const spacingX = 65;
        const spacingY = 45;

        let currentX = marginX;
        let imagesInRow = 0;

        for (const file of files) {
            const imgData = await compressImage(file, 0.5);
            
            if (imagesInRow === 3) {
                imagesInRow = 0;
                currentX = marginX;
                currentY += spacingY;
            }

            if (currentY + imgHeight > pageHeight - 10) {
                pdf.addPage();
                currentY = 15;
                currentX = marginX;
                imagesInRow = 0;
            }

            pdf.addImage(imgData, 'JPEG', currentX, currentY, imgWidth, imgHeight);
            currentX += spacingX;
            imagesInRow++;
        }

        return currentY + spacingY;
    }

    // Procesar fotos solo si existen
    let photosSectionY = currentY + 15;
    if (selectedFiles.preview3.length > 0) {
        photosSectionY = await addPhotoSection("Fotos de la Limpieza (Antes):", selectedFiles.preview3, photosSectionY);
        photosSectionY += 15;
    }

    await addPhotoSection("Fotos de la Limpieza (Después):", selectedFiles.preview4, photosSectionY);

    // Generar nombre del archivo según el nuevo formato requerido
    let nombreArchivo = formatDateForFilename(fecha);
    
    // Agregar horario si existe (con nuevo formato)
    if (horaInicio && horaFin) {
        const [horaI, minutoI] = horaInicio.split(':');
        const [horaF, minutoF] = horaFin.split(':');
        nombreArchivo += ` - ${horaI}h${minutoI}m-${horaF}h${minutoF}m`;
    }
    
    nombreArchivo += ` - ${edificio}`;
    
    // Agregar nivel si aplica
    if (edificiosConNiveles.includes(edificio) && nivel) {
        nombreArchivo += ' - Nivel ' + nivel;
    }
    
    // Agregar actividad si aplica
    if (actividad) {
        if (edificio === 'Plazas') {
            // Solo agregar la actividad si es Plazas (Democracia/Etnias)
            nombreArchivo += ' - ' + actividad;
        } else if (!['Plazas', 'Exteriores'].includes(edificio)) {
            nombreArchivo += ' - ' + actividad;
        }
    }
    
    nombreArchivo += '.pdf';

    const pdfBlob = pdf.output('blob');
    Swal.close();

    function tryShareOrDownload() {
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], nombreArchivo, { type: 'application/pdf' })] })) {
            navigator.share({
                files: [new File([pdfBlob], nombreArchivo, { type: 'application/pdf' })],
                title: `Reporte de Actividades de Limpieza - ${nombreArchivo.replace('.pdf', '')}`,
                text: `Adjunto el reporte de actividades de limpieza para ${fecha}.`
            })
            .then(() => {
                Swal.fire({
                    icon: 'success',
                    title: '¡Reporte Compartido!',
                    html: '<div style="text-align: center;">El PDF ha sido enviado a la aplicación seleccionada.</div>',
                    confirmButtonColor: '#007bff'
                });
            })
            .catch((error) => {
                console.error('Error al compartir:', error);
                if (error.name !== 'AbortError') {
                    pdf.save(nombreArchivo);
                }
            });
        } else {
            pdf.save(nombreArchivo);
        }
    }
    
    tryShareOrDownload();
}


// Función auxiliar para formatear la fecha como aaaa-mm-dd
function formatDateForFilename(dateString) {
    const [year, month, day] = dateString.split('-');
    return `${year}-${month}-${day}`;
}

// Función para comprimir imágenes
function compressImage(file, quality) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const maxWidth = 600;
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;

                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(dataUrl);
            };
            img.src = event.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}



// Agregar en el window.onload o donde configuras los event listeners
document.getElementById('nivel').addEventListener('input', function() {
    const edificio = document.getElementById('edificio').value;
    const edificiosConNiveles = ['Torre #1', 'Torre #2', 'CBA', 'CBB', 'CBC', 'Sótano'];
    
    if (edificiosConNiveles.includes(edificio)) {
        const nivelValue = parseInt(this.value);
        const maxLevel = parseInt(this.getAttribute('max'));
        
        if (!isNaN(nivelValue)) {
            if (nivelValue < 0 || (!isNaN(maxLevel) && nivelValue > maxLevel)) {
                this.value = ''; // Vaciar el campo inmediatamente si está fuera de rango
            }
        }
    }
    validateField('nivel');
    updateButtonState();
});

document.getElementById('nivel').addEventListener('blur', function() {
    validateField('nivel');
    updateButtonState();
});














    // --- Lógica del menú de ayuda ---
    const helpContent = {
        'Limpieza de Baños': {
            'Repaso de Baño': [
                'Limpieza superficial de papeleras/contenedores de residuos y reposición de bolsas nuevas.',
                'Limpieza y desinfección superficial de inodoros y mingitorios.',
                'Limpieza y desinfección superficial de lavamanos y griferías.',
                'Limpieza y desinfección superficial de espejos y cristales.',
                'Limpieza y desinfección de perillas, pasamanos y superficies de alto contacto.',
                'Revisión y limpieza de manchas visibles en paredes y azulejos.',
                'Reponer suministros (jabón, papel higiénico, toallas de papel).',
                'Limpieza y desinfección de pisos (con barrido húmedo y antiestático si corresponde).',
                'Verificar olores y tomar medidas.',
                'Revisar estado de instalaciones sanitarias.'
            ],
            'Profunda de Baño': [
                'Limpieza y desinfección de papeleras y basureros, y reposición de bolsas nuevas.',
                'Limpieza, desinfección y pulido de inodoros (interior, exterior, asiento, tapa y base).',
                'Limpieza, desinfección y pulido de urinarios.',
                'Limpieza, desinfección y pulido de lavamanos, griferías y encimeras.',
                'Limpieza, desinfección y abrillantado de espejos.',
                'Limpieza y desinfección de superficies de alto contacto (manijas de puertas, interruptores de luz, etc.).',
                'Revisión y limpieza de rejillas de ventilación. (las que estuvieren al alcance de la mano).',
                'Revisión y limpieza de manchas visibles en paredes y azulejos.',
                'Limpieza, desinfección a fondo del piso (barrido, fregado, eliminación de manchas y derrames).',
                'Limpieza y desinfección de puertas (ambos lados) y sus marcos.',
                'Reponer todos los suministros (jabón, papel higiénico, toallas de papel, etc.).',
                'Verificar olores y tomar medidas.',
                'Revisar estado de instalaciones sanitarias.'
            ],
            'Períodica de Baño': [
                'Limpieza y desinfección profunda de paredes completas (incluyendo zócalos).',
                'Fregado profundo de pisos con maquinaria (si aplica).',
                'Limpieza de techos y luminarias.',
                'Limpieza de rejillas de ventilación/extracción de aire (todas).',
                'Limpieza y desinfección de uniones, juntas y boquillas de azulejos.',
                'Limpieza detallada de accesorios de baño (porta-rollos, jaboneras, ganchos, etc.).',
                'Lavado y desinfección a fondo de todos los contenedores de residuos.',
                'Revisar estado general de las instalaciones sanitarias (reportar anomalías).',
                'Verificar olores y tomar medidas correctivas'
            ]
        },
        'Limpieza de Oficina': {
            'Aspirado': [
                'Aspirado de todas las alfombras y tapetes.',
                'Limpieza de derrames y manchas pequeñas en alfombras.',
                'Revisión y limpieza de rodapiés y esquinas.'
            ],
            'Rutinaria': [
                'Vaciado y limpieza de papeleras y cestos de basura, reposición de bolsas.',
                'Limpieza y desinfección de superficies de alto contacto (pomos de puertas, interruptores de luz, teléfonos).',
                'Desempolvado de escritorios, mesas y otras superficies (superficialmente, sin mover objetos personales).',
                'Limpieza de pantallas de ordenador y monitores con productos adecuados.',
                'Limpieza de huellas y manchas en vidrios y espejos de la oficina.',
                'Barrido o aspirado de pisos y limpieza de manchas visibles.',
                'Revisión y limpieza de rejillas de ventilación accesibles.'
            ],
            'Shampuseado de Alfombras': [
                'Preparación del área (mover mobiliario, señalizar).',
                'Aspirado profundo de la alfombra para remover suciedad suelta.',
                'Aplicación de solución de shampoo especializado.',
                'Uso de máquina de inyección/extracción para limpiar y enjuagar la alfombra.',
                'Tratamiento de manchas difíciles.',
                'Secado asistido (ventiladores, extractores) para reducir el tiempo de secado.'
            ]
        }
    };

    // Función para mostrar el menú principal de actividades en el SweetAlert
    function showMainMenuInModal() {
        const activityOptions = Object.keys(helpContent).map(activity => {
            let icon = '';
            if (activity === 'Limpieza de Baños') icon = '🚻';
            else if (activity === 'Limpieza de Oficina') icon = '🏢';

            return `<button class="activity-menu-button" onclick="showSubMenuInModal('${activity}')">
                        <span style="font-size: 1.5em;">${icon}</span> ${activity}
                    </button>`;
        }).join('');

        Swal.update({
            title: 'Guía de Actividades',
            html: `<div class="activity-menu-grid">${activityOptions}</div>`,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                popup: 'swal2-menu-popup',
                title: 'swal2-title',
                htmlContainer: 'swal2-html-container'
            }
        });
    }

    // Función para mostrar el sub-menú de actividades
    function showSubMenuInModal(categoryName) {
        const subActivities = helpContent[categoryName];
        let htmlContent = '';

        if (subActivities && Object.keys(subActivities).length > 0) {
            const subActivityButtons = Object.keys(subActivities).map(subActivity => {
                let icon = '';
                if (subActivity === 'Repaso de Baño') icon = '🚽';
                else if (subActivity === 'Profunda de Baño') icon = '✨';
                else if (subActivity === 'Períodica de Baño') icon = '🌀';
                else if (subActivity === 'Aspirado') icon = '🧹';
                else if (subActivity === 'Rutinaria') icon = '📋';
                else if (subActivity === 'Shampuseado de Alfombras') icon = '🧼';

                return `<button class="activity-menu-button" onclick="loadInstructionsInModal('${subActivity}', '${categoryName}')">
                            <span style="font-size: 1.5em;">${icon}</span> ${subActivity}
                        </button>`;
            }).join('');
            htmlContent = `<div class="activity-menu-grid">${subActivityButtons}</div>`;
        } else {
            htmlContent = `<p>No hay sub-actividades disponibles para "${categoryName}".</p>`;
        }

        const customHeaderHtml = `
            <div class="custom-modal-header">
                <button class="swal2-back-button" onclick="showMainMenuInModal()" aria-label="Volver al Menú Principal">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="24px" height="24px">
                        <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                    </svg>
                </button>
                <h2>Selecciona Sub-Actividad</h2>
            </div>`;

        Swal.update({
            title: '',
            html: customHeaderHtml + htmlContent,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                popup: 'swal2-menu-popup',
                title: 'swal2-title',
                htmlContainer: 'swal2-html-container'
            }
        });
    }

    // Función para cargar las instrucciones en el *mismo* SweetAlert
    function loadInstructionsInModal(activityName, categoryName) {
        let instructions = [];
        if (helpContent[categoryName] && helpContent[categoryName][activityName]) {
            instructions = helpContent[categoryName][activityName];
        } else {
            // Fallback for direct top-level activities if any (though currently none in this structure)
            if (helpContent[activityName] && Array.isArray(helpContent[activityName])) {
                instructions = helpContent[activityName];
            }
        }
        
        const htmlContent = instructions.length > 0
            ? `<ul>${instructions.map(item => `<li class="swal2-list-item">${item}</li>`).join('')}</ul>`
            : `<p>No hay información detallada disponible para "${activityName}" en este momento.</p>`;

        const customHeaderHtml = `
            <div class="custom-modal-header">
                <button class="swal2-back-button" onclick="showSubMenuInModal('${categoryName}')" aria-label="Volver a Sub-Actividades">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="24px" height="24px">
                        <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                    </svg>
                </button>
                <h2>Guía para: <strong>${activityName}</strong></h2>
            </div>`;
        
        Swal.update({
            title: '',
            html: customHeaderHtml + htmlContent,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                popup: 'swal2-detail-popup',
                htmlContainer: 'swal2-html-container'
            }
        });
    }








    // Event listener inicial para el icono de ayuda
    document.getElementById('helpIconContainer').addEventListener('click', () => {
        Swal.fire({
            title: 'Guía de Actividades',
            html: '',
            allowOutsideClick: false,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                popup: 'swal2-menu-popup',
                title: 'swal2-title',
                htmlContainer: 'swal2-html-container'
            },
            didOpen: () => {
                showMainMenuInModal();
            }
        });
    });

</script>

</body>
</html>
