<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Reporte de Limpiezas Profundas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f9f9f9;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 10vh;
    }

    /* Header */
    .header {
        background-color: #007BFF;
        color: white;
        text-align: center;
        padding: 15px;
        width: 100%;
        font-size: 1.5em;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Contenedor del formulario */
    .container {
        background: #ffffff;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        text-align: center;
        margin: 40px auto;
        grid-row: 2;
        height: auto;
        box-sizing: border-box;
        position: relative; /* A√±adido para posicionar el icono de ayuda */
    }

    h1 {
        text-align: center;
        color: #333;
    }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    input[type="date"],
    textarea,
    input[type="file"],
    button {
        width: 100%;
        margin-top: 5px;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }
    
    select {
        width: 100%;
        margin-top: 5px;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        background-color: #f9f9f9; /* Color de fondo para el select */
        color: #333;
    }

    button {
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
        padding: 12px 0;
    }

    button:hover:not(:disabled) { /* Solo al hacer hover si no est√° deshabilitado */
        background-color: #0056b3;
    }

    button:disabled { /* Estilo para el bot√≥n deshabilitado */
        background-color: #cccccc;
        cursor: not-allowed;
    }

    /* Estilo para los contenedores de vista previa */
    .image-preview {
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        border: 0px solid #ccc;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        box-sizing: border-box;
    }

    .image-preview-item {
        position: relative;
        width: 85px;
        height: 85px;
        overflow: hidden;
        border-radius: 5px;
        border: 1px solid #ddd;
    }

    .image-preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .delete-icon {
        position: absolute;
        top: 5px;
        left: 5px;
        width: 20px;
        height: 20px;
        background: rgba(255, 0, 0, 0.8);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .image-preview-item:hover .delete-icon {
        opacity: 1;
    }

    /* Estilos para el √°rea de carga de im√°genes */
    .file-upload {
        display: block;
        position: relative;
        width: 100%;
        padding: 20px;
        background: #f0f8ff;
        border: 2px dashed #007BFF; /* Borde inicial azul */
        text-align: center;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
        box-sizing: border-box;
        padding: 40px 20px;
        color: #007BFF;
        transition: background-color 0.3s ease, border-color 0.3s ease;
        margin: 10px 0;
    }

    .file-upload:hover {
        border-color: #0056b3;
    }

    .file-upload input[type="file"] {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    /* Estilo para los contenedores de preguntas */
    .question-container {
        margin-bottom: 20px;
        text-align: left;
        padding: 10px;
        border: 2px solid #ccc; /* Borde predeterminado */
        border-radius: 5px;
        background-color: #f9f9f9;
        transition: border-color 0.3s;
        box-sizing: border-box;
    }

    /* Estilo para el campo de descripci√≥n */
    .question-container textarea {
    	padding: 15px; 
    	border: 2px solid #ccc; /* Borde predeterminado */
    	border-radius: 5px;
    	width: 100%;
    	font-size: 16px;
    	background-color: #f9f9f9;
    	color: #333;
    	transition: border-color 0.3s;
    	box-sizing: border-box;
    	margin-top: 5px;
    	height: 200px; 
    	resize: vertical; 
    }

    .question-container:hover {
        border-color: #007BFF;
    }

    .question-container input[type="date"],
    .question-container textarea,
    .question-container select,
    .question-container input[type="number"],
    .question-container input[type="time"] { /* Added input[type="time"] */
        padding: 10px;
        border: 2px solid #ccc; /* Borde predeterminado */
        border-radius: 5px;
        width: 100%;
        font-size: 16px;
        background-color: #f9f9f9;
        color: #333;
        transition: border-color 0.3s;
        box-sizing: border-box;
        margin-top: 5px;
    }

    .question-container input[type="date"]:focus,
    .question-container textarea:focus,
    .question-container select:focus,
    .question-container input[type="number"]:focus,
    .question-container input[type="time"]:focus { /* Added input[type="time"] */
        border-color: #007BFF;
        outline: none;
    }

    /* Estilos de las etiquetas */
    .question-container label {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 5px;
        display: block;
    }

    /* Clases para los bordes de validaci√≥n */
    .field-error {
        border-color: red !important;
    }

    .field-success {
        border-color: green !important;
    }

    /* Help Icon Button */
    .help-icon-button {
        position: absolute;
        top: 15px; 
        right: 15px; 
        cursor: pointer;
        background-color: #e6f2ff; /* Light blue background */
        border-radius: 50%;
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        color: #007BFF; /* Icon color */
    }

    .help-icon-button:hover {
        background-color: #cce0ff; /* Darker blue on hover */
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        transform: scale(1.05);
    }

    .help-icon-button svg {
        width: 28px; /* Slightly larger icon */
        height: 28px;
        fill: currentColor; /* Use parent's color */
    }

    /* Custom styles for SweetAlert2 modals */
    /* Adjust overall popup size for general display */
    .swal2-popup {
        max-width: 500px !important; /* Control overall max-width */
        width: 90% !important; /* Make it responsive */
        padding: 1em !important; /* Adjust padding for a tighter look */
        /* SweetAlert2 title is outside html-container, so its padding affects overall layout */
    }

    /* Styles for the "Super Novel Menu" buttons */
    .activity-menu-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* FORCED TWO COLUMNS */
        gap: 15px; /* Space between buttons */
        padding: 10px;
    }

    .activity-menu-button {
        background-color: #007bff; /* Primary color */
        color: white;
        border: none;
        border-radius: 8px;
        padding: 15px 20px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center; /* Center content horizontally */
        gap: 10px; /* Space between icon and text */
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.2s ease-in-out;
    }

    .activity-menu-button:hover {
        background-color: #0056b3; /* Darker blue on hover */
        transform: translateY(-3px); /* Slight lift effect */
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    /* Specific custom class for the menu popup itself to control its size */
    .swal2-menu-popup {
        max-width: 600px !important; /* Can be wider for menu if needed */
        width: 90% !important; /* Make it responsive */
    }

    .swal2-list-item {
        margin-bottom: 8px; /* Espacio entre √≠tems de la lista de instrucciones */
    }

    /* Style for the new back button in SweetAlert2 */
    .swal2-back-button { /* Custom class for the back button */
        background-color: #6c757d; /* Grey color for back button */
        color: white;
        border: none;
        border-radius: 50%; /* Make it round */
        width: 40px; /* Adjust size */
        height: 40px; /* Adjust size */
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
        z-index: 10; /* Ensure it's above other content */
        position: absolute; /* Keep absolute within its new container for exact positioning */
        top: 15px; /* Adjusted: Pushed down from the top edge of custom-modal-header */
        left: 10px; /* Adjust relative to custom header */
    }

    .swal2-back-button:hover {
        background-color: #5a6268;
        transform: scale(1.05);
    }

    /* Container for custom header (back button + title) within swal2-html-container */
    .custom-modal-header {
        display: flex;
        align-items: center; /* Vertically center items */
        position: relative; /* For absolute positioning of the button */
        width: 100%;
        min-height: 50px; /* Changed from height to min-height for flexibility */
        margin-bottom: 10px; /* Space below the header */
        padding-top: 15px; /* NEW: Added padding-top to push content down */
    }

    .custom-modal-header h2 {
        flex-grow: 1; /* Title takes up remaining space */
        text-align: center;
        margin: 0;
        font-size: 1.4em; /* Adjust title size */
        padding-left: 50px; /* Space for the back button */
        padding-right: 50px; /* Balance for centering */
        box-sizing: border-box;
    }

    /* Ensure swal2-html-container itself doesn't have extra padding that pushes content */
    .swal2-html-container {
        text-align: left;
        margin: 0 !important; /* Remove default margin */
        padding: 0 !important; /* Remove default padding for this custom case */
        width: 100%; /* Ensure it spans full width */
        box-sizing: border-box;
    }

    /* Adjust the popup padding only, no specific htmlContainer padding for content */
    .swal2-detail-popup {
        padding: 1em !important; /* Overall popup padding */
    }

    /* Hide default SweetAlert2 title for detail view */
    .swal2-detail-popup .swal2-title {
        display: none !important;
    }

    /* NEW: Styles for the SweetAlert2 close button (the 'X') */
    .swal2-close {
        box-shadow: none !important; /* Remove shadow */
        color: red !important; /* Change 'X' color to red */
        font-size: 1.8em !important; /* Make X slightly larger for visibility */
        top: 0.5em !important; /* Adjust position if needed after size change */
        right: 0.5em !important; /* Adjust position if needed after size change */
    }
</style>


</head>
<body>

 <div class="header">
  Pisos Brillantes
 </div>

 <div class="container">
    <div id="helpIconContainer" class="help-icon-button" title="Ayuda sobre actividades">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24px" height="24px">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.43 14.07 13 14.59 13 15h-2v-.5c0-1.1.45-2.11 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.5-.72 2.76-1.87 3.49z"/>
        </svg>
    </div>
    <h1>Reporte de Actividades de Limpieza</h1>
    <div class="form-container">
        <div class="question-container" id="fechaContainer">
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" name="fecha" required>
        </div>

        <div class="question-container" id="horariosContainer">
            <label>Horario de Actividad:</label>
            <div style="display: flex; gap: 10px; margin-top: 5px;">
                <div style="flex: 1;">
                    <label for="horaInicio" style="font-weight: normal; font-size: 0.9em;">Hora de Inicio:</label>
                    <input type="time" id="horaInicio" name="horaInicio" required>
                </div>
                <div style="flex: 1;">
                    <label for="horaFin" style="font-weight: normal; font-size: 0.9em;">Hora de Fin:</label>
                    <input type="time" id="horaFin" name="horaFin" required>
                </div>
            </div>
        </div>

        <div class="question-container" id="edificioContainer">
            <label for="edificio">Edificio:</label>
            <select id="edificio" name="edificio" required>
                <option value="">Selecciona un edificio</option>
                <option value="Torre #1">Torre #1</option>
                <option value="Torre #2">Torre #2</option>
                <option value="CBA">CBA</option>
                <option value="CBB">CBB</option>
                <option value="CBC">CBC</option>
                <option value="S√≥tano">S√≥tano</option>
            </select>
        </div>

        <div class="question-container" id="nivelContainer" style="display: none;">
            <label for="nivel">Nivel:</label>
            <input type="number" id="nivel" name="nivel" placeholder="Ingrese el n√∫mero de nivel" required>
        </div>

        <div class="question-container" id="actividadContainer">
            <label for="actividad">Actividad:</label>
            <select id="actividad" name="actividad" required>
                <option value="">Selecciona una actividad</option>
                <option value="Limpieza de Ba√±os">Limpieza de Ba√±os</option>
                <option value="Limpieza de Oficina">Limpieza de Oficina</option>
            </select>
        </div>

        <div class="question-container" id="subActividadContainer" style="display: none;">
            <label for="subActividad">Sub-actividad:</label>
            <select id="subActividad" name="subActividad" required>
                <option value="">Selecciona una sub-actividad</option>
            </select>
        </div>

        <div class="question-container" id="oficinaContainer" style="display: none;">
            <label for="oficina">Oficina:</label>
            <input type="number" id="oficina" name="oficina" placeholder="Ingrese el n√∫mero de oficina" required>
        </div>

        <div class="question-container" id="descripcionContainer" style="display: none;">
            <label for="descripcion">Descripci√≥n de la actividad:</label>
            <textarea id="descripcion" name="descripcion" rows="5" placeholder="Describe la actividad realizada"></textarea>
        </div>

        <div class="question-container" id="adjunto3Container">
            <label for="adjunto3">Fotos de la Limpieza (Antes):</label>
            <div class="file-upload" id="drag-area3" onclick="document.getElementById('adjunto3').click()">
                <input type="file" id="adjunto3" name="adjunto3" accept="image/*" multiple>
                <span class="file-upload-text">Haz clic o arrastra im√°genes para adjuntarlas</span>
            </div>
            <div id="preview3" class="image-preview"></div>
        </div>

        <div class="question-container" id="adjunto4Container">
            <label for="adjunto4">Fotos de la Limpieza (Despu√©s):</label>
            <div class="file-upload" id="drag-area4" onclick="document.getElementById('adjunto4').click()">
                <input type="file" id="adjunto4" name="adjunto4" accept="image/*" multiple>
                <span class="file-upload-text">Haz clic o arrastra im√°genes para adjuntarlas</span>
            </div>
            <div id="preview4" class="image-preview"></div>
        </div>

        <button type="button" id="generarReporteBtn" onclick="generarPDF()" disabled>Generar Reporte</button>
    </div>
</div>

<script>
    const formFields = [
        { id: 'fecha', type: 'input' },
        { id: 'edificio', type: 'select' },
        { id: 'nivel', type: 'input' },
        { id: 'actividad', type: 'select' }, 
        { id: 'subActividad', type: 'select' }, 
        { id: 'horaInicio', type: 'input' }, 
        { id: 'horaFin', type: 'input' },   
        { id: 'preview3', type: 'image' },
        { id: 'preview4', type: 'image' }
    ];

    // Establecer la fecha y hora actual por defecto
    window.onload = function() {
        const fechaInput = document.getElementById("fecha");
        const horaInicioInput = document.getElementById("horaInicio");

        const today = new Date();
        const year = today.getFullYear();
        let mm = today.getMonth() + 1; 
        let dd = today.getDate();
        let hours = today.getHours();
        let minutes = today.getMinutes();

        if (mm < 10) mm = '0' + mm;
        if (dd < 10) dd = '0' + dd;
        hours = hours < 10 ? '0' + hours : hours;
        minutes = minutes < 10 ? '0' + minutes : minutes;

        const formattedDate = year + '-' + mm + '-' + dd;
        fechaInput.value = formattedDate;
        horaInicioInput.value = `${hours}:${minutes}`; 

        formFields.forEach(field => validateField(field.id));
        updateButtonState();
        updateTimeFieldVisibility(); 
    };

    const selectedFiles = {
        preview3: [],
        preview4: [] 
    };

    // Funci√≥n para actualizar la visibilidad de los campos de hora
    function updateTimeFieldVisibility() {
        const actividad = document.getElementById('actividad').value;
        const subActividad = document.getElementById('subActividad').value;
        const horariosContainer = document.getElementById('horariosContainer'); 
        const horaInicioInput = document.getElementById('horaInicio');
        const horaFinInput = document.getElementById('horaFin');

        if (actividad === 'Limpieza de Oficina' && (subActividad === 'Aspirado' || subActividad === 'Shampuseado de Alfombras')) {
            horariosContainer.style.display = 'none'; 
            horaInicioInput.value = ''; 
            horaFinInput.value = '';     
        } else {
            horariosContainer.style.display = 'block'; 
            if (horaInicioInput.value === '') {
                const now = new Date();
                let hours = now.getHours();
                let minutes = now.getMinutes();
                hours = hours < 10 ? '0' + hours : hours;
                minutes = minutes < 10 ? '0' + minutes : minutes;
                horaInicioInput.value = `${hours}:${minutes}`;
            }
        }
        updateButtonState(); 
    }

    // L√≥gica para el men√∫ anidado y la visibilidad del campo de oficina
    document.getElementById('actividad').addEventListener('change', function() {
        const subActividadContainer = document.getElementById('subActividadContainer');
        const subActividadSelect = document.getElementById('subActividad');
        const oficinaContainer = document.getElementById('oficinaContainer');
        const oficinaInput = document.getElementById('oficina');
        const currentActivity = this.value;

        subActividadSelect.innerHTML = '<option value="">Selecciona una sub-actividad</option>';
        subActividadContainer.style.display = 'none';
        subActividadSelect.removeAttribute('required');
        oficinaContainer.style.display = 'none';
        oficinaInput.value = '';

        const oficinaIndex = formFields.findIndex(f => f.id === 'oficina');
        if (oficinaIndex > -1) {
            formFields.splice(oficinaIndex, 1);
        }

        if (currentActivity === 'Limpieza de Ba√±os') {
            subActividadContainer.style.display = 'block';
            subActividadSelect.setAttribute('required', 'required');
            const options = ['Repaso de Ba√±o', 'Profunda de Ba√±o', 'Per√≠odica de Ba√±o'];
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                subActividadSelect.appendChild(opt);
            });
        } else if (currentActivity === 'Limpieza de Oficina') {
            subActividadContainer.style.display = 'block';
            subActividadSelect.setAttribute('required', 'required');
            oficinaContainer.style.display = 'block';
            oficinaInput.setAttribute('required', 'required'); // Office is required for office cleaning
            const options = ['Aspirado', 'Rutinaria', 'Shampuseado de Alfombras'];
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                subActividadSelect.appendChild(opt);
            });
             if (!formFields.find(f => f.id === 'oficina')) {
                formFields.push({ id: 'oficina', type: 'input' });
                oficinaInput.addEventListener('input', updateButtonState);
                oficinaInput.addEventListener('change', updateButtonState);
            }
        }

        validateField('actividad');
        validateField('subActividad');
        updateTimeFieldVisibility(); 
        updateButtonState();
    });

    document.getElementById('subActividad').addEventListener('change', function() {
        validateField('subActividad');
        updateTimeFieldVisibility(); 
        updateButtonState(); 
    });


    // L√≥gica para establecer el nivel m√°ximo seg√∫n el edificio
    document.getElementById('edificio').addEventListener('change', function() {
        const nivelInput = document.getElementById('nivel');
        const nivelContainer = document.getElementById('nivelContainer'); 
        const selectedEdificio = this.value;
        let maxLevel = -1; 

        nivelInput.value = '';

        if (selectedEdificio === '') { 
            nivelContainer.style.display = 'none'; 
            nivelInput.removeAttribute('required'); 
            nivelInput.oninput = null; 
        }
        else {
            nivelContainer.style.display = 'block'; 
            nivelInput.setAttribute('required', 'required'); 

            switch (selectedEdificio) {
                case 'Torre #1':
                    maxLevel = 23;
                    break;
                case 'Torre #2':
                    maxLevel = 24;
                    break;
                case 'CBA':
                    maxLevel = 5;
                    break;
                case 'CBB':
                    maxLevel = 7;
                    break;
                case 'CBC':
                    maxLevel = 7;
                    break;
                case 'S√≥tano':
                    maxLevel = 4;
                    break;
                default:
                    maxLevel = -1; 
                    break;
            }

            if (maxLevel !== -1) {
                nivelInput.setAttribute('max', maxLevel);
                nivelInput.setAttribute('min', 0); 
                nivelInput.placeholder = `Ingrese el n√∫mero de nivel (0-${maxLevel})`;

                nivelInput.oninput = function() {
                    let currentVal = parseInt(this.value);
                    const maxVal = parseInt(this.max);
                    const minVal = parseInt(this.min);

                    if (!isNaN(currentVal)) {
                        if (!isNaN(maxVal) && currentVal > maxVal) {
                            this.value = maxVal; 
                        } else if (!isNaN(minVal) && currentVal < minVal) {
                            this.value = minVal; 
                        }
                    }
                    updateButtonState(); 
                };

            } else {
                nivelInput.removeAttribute('max');
                nivelInput.removeAttribute('min');
                nivelInput.placeholder = `Ingrese el n√∫mero de nivel`;
                nivelInput.oninput = null; 
            }
        }
        
        validateField('nivel'); 
        updateButtonState(); 
    });


    // Funci√≥n para validar un campo espec√≠fico y aplicar el estilo de borde
    function validateField(fieldId) {
        const element = document.getElementById(fieldId);
        if (!element) return true; 

        const container = element.closest('.question-container') || element;

        if (container.style.display === 'none') {
            return true;
        }

        let isValid = false;
        if (fieldId === 'preview3') {
            isValid = selectedFiles.preview3.length > 0;
        } else if (fieldId === 'preview4') {
            isValid = selectedFiles.preview4.length > 0;
        } else if (fieldId === 'horaInicio') {
            isValid = element.value.trim() !== ''; 
        } else if (fieldId === 'horaFin') {
            if (element.value.trim() === '') {
                isValid = false; 
            } else {
                const horaInicio = document.getElementById('horaInicio').value;
                if (horaInicio.trim() === '') {
                    isValid = false; 
                } else {
                    const [hI, mI] = horaInicio.split(':').map(Number);
                    const [hF, mF] = element.value.split(':').map(Number); 
                    
                    const totalMinutesInicio = hI * 60 + mI;
                    const totalMinutesFin = hF * 60 + mF;

                    isValid = totalMinutesFin > totalMinutesInicio; 
                }
            }
        } else if (element.tagName === 'SELECT' || element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
            if (fieldId === 'oficina') {
                const actividadSelect = document.getElementById('actividad');
                if (actividadSelect.value === 'Limpieza de Oficina') {
                    isValid = element.value.trim() !== ''; 
                } else {
                    isValid = true; // Should not happen with current logic, but as fallback.
                }
            } else if (fieldId === 'nivel') {
                const nivelValue = parseInt(element.value);
                const maxLevel = parseInt(element.getAttribute('max'));
                isValid = element.value.trim() !== '' && !isNaN(nivelValue) && nivelValue >= 0 && (isNaN(maxLevel) || nivelValue <= maxLevel);
            }
            else {
                isValid = element.value.trim() !== ''; 
            }
        }

        if (isValid) {
            container.classList.remove('field-error');
            container.classList.add('field-success');
        } else {
            container.classList.remove('field-success');
            container.classList.add('field-error');
        }
        return isValid;
    }

    // Funci√≥n para actualizar el estado del bot√≥n "Generar Reporte"
    function updateButtonState() {
        const generarReporteBtn = document.getElementById('generarReporteBtn');
        let allFieldsValid = true;

        formFields.forEach(field => {
            if (!validateField(field.id)) { 
                allFieldsValid = false;
            }
        });

        generarReporteBtn.disabled = !allFieldsValid;
    }

    // A√±adir EventListeners a los campos para la validaci√≥n en tiempo real
    formFields.forEach(field => {
        if (field.type === 'input' || field.type === 'select' || field.type === 'textarea') {
            const element = document.getElementById(field.id);
            if (element) { 
                if (field.id !== 'nivel') { 
                    element.addEventListener('input', updateButtonState);
                }
                element.addEventListener('change', updateButtonState);
            }
        }
    });

    function handleFileInput(event, previewId) {
        const files = event.target.files;
        const previewContainer = document.getElementById(previewId);

        Array.from(files).forEach((file) => {
            const reader = new FileReader();
            reader.onload = function (e) {
                const div = document.createElement('div');
                div.classList.add('image-preview-item');
                div.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <div class="delete-icon" onclick="deleteImage('${previewId}', ${selectedFiles[previewId].length})">√ó</div>
                `;
                previewContainer.appendChild(div);

                selectedFiles[previewId].push(file);
                updateButtonState(); 
            };
            reader.readAsDataURL(file);
        });

        event.target.value = "";
    }

    function deleteImage(previewId, index) {
        const previewContainer = document.getElementById(previewId);

        if (previewContainer.children[index]) {
            previewContainer.removeChild(previewContainer.children[index]);
            selectedFiles[previewId].splice(index, 1);

            Array.from(previewContainer.children).forEach((child, newIndex) => {
                const deleteIcon = child.querySelector('.delete-icon');
                if (deleteIcon) {
                    deleteIcon.setAttribute('onclick', `deleteImage('${previewId}', ${newIndex})`);
                }
            });
            updateButtonState(); 
        }
    }

    document.getElementById('adjunto3').addEventListener('change', (e) => handleFileInput(e, 'preview3')); 
    document.getElementById('adjunto4').addEventListener('change', (e) => handleFileInput(e, 'preview4')); 

    const dragAreas = ['drag-area3', 'drag-area4']; 
    dragAreas.forEach(area => {
        const dragArea = document.getElementById(area);
        dragArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragArea.style.backgroundColor = "#e0f7ff"; 
        });

        dragArea.addEventListener('dragleave', (event) => {
            event.preventDefault();
            event.stopPropagation();
            dragArea.style.backgroundColor = "#f0f8ff"; 
        });

        dragArea.addEventListener('drop', (event) => {
            event.preventDefault();
            event.stopPropagation();
            const files = event.dataTransfer.files;
            const previewId = area.replace("drag-area", "preview");
            handleFileInput({ target: { files } }, previewId);
        });
    });

    async function generarPDF() {
        if (document.getElementById('generarReporteBtn').disabled) {
            Swal.fire({
                icon: 'warning',
                title: 'Campos Incompletos',
                html: '<div style="text-align: center;">Por favor, complete todos los campos obligatorios antes de generar el reporte.</div>',
                confirmButtonColor: '#007bff'
            });
            return; 
        }

        Swal.fire({
            title: 'Procesando...',
            html: '<div style="text-align: center;">Generando su reporte PDF. Por favor, espere. <br> <span style="font-size: 0.8em;">Esto puede tardar un momento si hay muchas im√°genes.</span></div>',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ format: 'letter' });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        async function getLogoBase64() {
            if (navigator.onLine) {
                try {
                    const response = await fetch("https://jeancarlozelaya.github.io/PIBRISA/Im%C3%A1genes/Icono.png");
                    const blob = await response.blob();
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error("Error al cargar el logo, se omitir√°:", error);
                    return null; 
                }
            } else {
                console.warn("Sin conexi√≥n a Internet, se omitir√° la carga del logo.");
                return null;
            }
        }

        const logoBase64 = await getLogoBase64(); 
        
        // Obtener datos del formulario
        const fecha = document.getElementById('fecha').value;
        const edificio = document.getElementById('edificio').value; 
        const nivel = document.getElementById('nivel').value;       
        const actividad = document.getElementById('actividad').value; 
        const subActividad = document.getElementById('subActividad').value; 
        const oficinaInput = document.getElementById('oficina');
        const oficina = oficinaInput.closest('.question-container').style.display === 'block' ? oficinaInput.value : '';
        const horaInicio = document.getElementById('horaInicio').value; 
        const horaFin = document.getElementById('horaFin').value;     

        pdf.setFont("times", "bold");

        let currentY = 15; 
        let textX = 10;
        const logoWidth = 30; 
        const logoHeight = 30;
        const logoX = 10; 

        if (logoBase64) {
            pdf.addImage(logoBase64, "PNG", logoX, currentY, logoWidth, logoHeight);
            textX = logoX + logoWidth + 5;
        }

        const startYText = logoBase64 ? (currentY + 5) : currentY;
        const lineHeight = 10;

        // T√≠tulo del reporte (16pt)
        pdf.setFontSize(16); 
        pdf.text("Reporte de Actividades de Limpieza", textX, startYText, { align: "left" });

        currentY = startYText + lineHeight; 
        // Fecha y Horas (14pt) - Combinadas
        pdf.setFontSize(14); 
        let dateAndHourText = `Fecha: ${fecha}`;
        if (horaInicio && horaFin) { 
            dateAndHourText += `, Hora Inicio: ${horaInicio}, Hora Fin: ${horaFin}`;
        }
        pdf.text(dateAndHourText, textX, currentY, { align: "left" });
        currentY += lineHeight; 

        // Edificio, Nivel, Oficina en la misma l√≠nea (14pt)
        let locationInfo = `Edificio: ${edificio}, Nivel: ${nivel}`;
        if (actividad === 'Limpieza de Oficina' && oficina) {
            locationInfo += ` Oficina: ${oficina}`;
        }
        pdf.text(locationInfo, textX, currentY, { align: "left" });
        currentY += lineHeight; 

        // Actividad (14pt) - Combinar actividad principal y sub-actividad
        const actividadFinal = `${actividad} (${subActividad})`;
        pdf.setFontSize(14); 
        pdf.text(`Actividad: ${actividadFinal}`, textX, currentY, { align: "left" });
        currentY += lineHeight; 


        // Funci√≥n para a√±adir una secci√≥n de fotos al PDF 
        async function addPhotoSection(title, files, startY) {
            if (files.length === 0) return startY;

            let currentY = startY;

            const spaceNeeded = 10 + 10 + 40; 
            if (currentY + spaceNeeded > pageHeight - 10) {
                pdf.addPage();
                currentY = 15;
            }

            // T√≠tulo de la secci√≥n
            pdf.setFontSize(14);
            pdf.setFont("times", "bold");
            pdf.text(title, 10, currentY);

            currentY += 10; 

            const imgWidth = 60;
            const imgHeight = 40;
            const marginX = 15;
            const spacingX = 65;
            const spacingY = 45;

            let currentX = marginX;
            let imagesInRow = 0;

            for (const file of files) {
                const imgData = await compressImage(file, 0.5);
                
                if (imagesInRow === 3) {
                    imagesInRow = 0;
                    currentX = marginX;
                    currentY += spacingY;
                }

                if (currentY + imgHeight > pageHeight - 10) {
                    pdf.addPage();
                    currentY = 15; 
                    currentX = marginX;
                    imagesInRow = 0;
                }

                pdf.addImage(imgData, 'JPEG', currentX, currentY, imgWidth, imgHeight);
                currentX += spacingX;
                imagesInRow++;
            }

            return currentY + spacingY;
        }

        // Procesar las fotos del "Antes"
        let photosSectionY = currentY + 15;
        photosSectionY = await addPhotoSection("Fotos de la Limpieza (Antes):", selectedFiles.preview3, photosSectionY);

        // Procesar las fotos del "Despu√©s"
        photosSectionY += 15; 
        await addPhotoSection("Fotos de la Limpieza (Despu√©s):", selectedFiles.preview4, photosSectionY);


        pdf.setFontSize(12);
        pdf.setFont("Arial", "normal"); 

        let nombreArchivo = `${fecha} - ${edificio} Nivel ${nivel} - ${actividadFinal}`;
        if (actividad === 'Limpieza de Oficina' && oficina) {
            nombreArchivo += ` Oficina ${oficina}`;
        }
        nombreArchivo += ".pdf";

        const pdfBlob = pdf.output('blob');

        Swal.close(); 

        function tryShareOrDownload() {
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], nombreArchivo, { type: 'application/pdf' })] })) {
                navigator.share({
                    files: [new File([pdfBlob], nombreArchivo, { type: 'application/pdf' })],
                    title: `Reporte de Actividades de Limpieza - ${nombreArchivo.replace('.pdf', '')}`,
                    text: `Adjunto el reporte de actividades de limpieza para ${fecha}.`
                })
                .then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: '¬°Reporte Compartido!',
                        html: '<div style="text-align: center;">El PDF ha sido enviado a la aplicaci√≥n seleccionada.</div>',
                        confirmButtonColor: '#007bff'
                    });
                })
                .catch((error) => {
                    console.error('Error al compartir:', error);
                    if (error.name === 'AbortError') {
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al Compartir',
                            html: '<div style="text-align: center;">No se pudo compartir el PDF directamente. Se proceder√° con la descarga.</div>',
                            confirmButtonColor: '#007bff'
                        });
                        pdf.save(nombreArchivo);
                    }
                });
            } else {
                pdf.save(nombreArchivo);
                Swal.fire({
                    icon: 'info',
                    title: 'Reporte Descargado',
                    html: '<div style="text-align: center;">Su navegador no soporta la funci√≥n de compartir directamente o la p√°gina no se ejecuta sobre HTTPS.<br>El PDF se ha descargado.</div>',
                    confirmButtonColor: '#007bff'
                });
            }
        }
        
        tryShareOrDownload();
    }

    function compressImage(file, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    const maxWidth = 600;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;

                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(dataUrl);
                };
                img.src = event.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // --- L√≥gica del men√∫ de ayuda ---
    const helpContent = {
        'Limpieza de Ba√±os': {
            'Repaso de Ba√±o': [
                'Limpieza superficial de papeleras/contenedores de residuos y reposici√≥n de bolsas nuevas.',
                'Limpieza y desinfecci√≥n superficial de inodoros y mingitorios.',
                'Limpieza y desinfecci√≥n superficial de lavamanos y grifer√≠as.',
                'Limpieza y desinfecci√≥n superficial de espejos y cristales.',
                'Limpieza y desinfecci√≥n de perillas, pasamanos y superficies de alto contacto.',
                'Revisi√≥n y limpieza de manchas visibles en paredes y azulejos.',
                'Reponer suministros (jab√≥n, papel higi√©nico, toallas de papel).',
                'Limpieza y desinfecci√≥n de pisos (con barrido h√∫medo y antiest√°tico si corresponde).',
                'Verificar olores y tomar medidas.',
                'Revisar estado de instalaciones sanitarias.'
            ],
            'Profunda de Ba√±o': [
                'Limpieza y desinfecci√≥n de papeleras y basureros, y reposici√≥n de bolsas nuevas.',
                'Limpieza, desinfecci√≥n y pulido de inodoros (interior, exterior, asiento, tapa y base).',
                'Limpieza, desinfecci√≥n y pulido de urinarios.',
                'Limpieza, desinfecci√≥n y pulido de lavamanos, grifer√≠as y encimeras.',
                'Limpieza, desinfecci√≥n y abrillantado de espejos.',
                'Limpieza y desinfecci√≥n de superficies de alto contacto (manijas de puertas, interruptores de luz, etc.).',
                'Revisi√≥n y limpieza de rejillas de ventilaci√≥n. (las que estuvieren al alcance de la mano).',
                'Revisi√≥n y limpieza de manchas visibles en paredes y azulejos.',
                'Limpieza, desinfecci√≥n a fondo del piso (barrido, fregado, eliminaci√≥n de manchas y derrames).',
                'Limpieza y desinfecci√≥n de puertas (ambos lados) y sus marcos.',
                'Reponer todos los suministros (jab√≥n, papel higi√©nico, toallas de papel, etc.).',
                'Verificar olores y tomar medidas.',
                'Revisar estado de instalaciones sanitarias.'
            ],
            'Per√≠odica de Ba√±o': [
                'Limpieza y desinfecci√≥n profunda de paredes completas (incluyendo z√≥calos).',
                'Fregado profundo de pisos con maquinaria (si aplica).',
                'Limpieza de techos y luminarias.',
                'Limpieza de rejillas de ventilaci√≥n/extracci√≥n de aire (todas).',
                'Limpieza y desinfecci√≥n de uniones, juntas y boquillas de azulejos.',
                'Limpieza detallada de accesorios de ba√±o (porta-rollos, jaboneras, ganchos, etc.).',
                'Lavado y desinfecci√≥n a fondo de todos los contenedores de residuos.',
                'Revisar estado general de las instalaciones sanitarias (reportar anomal√≠as).',
                'Verificar olores y tomar medidas correctivas'
            ]
        },
        'Limpieza de Oficina': {
            'Aspirado': [
                'Aspirado de todas las alfombras y tapetes.',
                'Limpieza de derrames y manchas peque√±as en alfombras.',
                'Revisi√≥n y limpieza de rodapi√©s y esquinas.'
            ],
            'Rutinaria': [
                'Vaciado y limpieza de papeleras y cestos de basura, reposici√≥n de bolsas.',
                'Limpieza y desinfecci√≥n de superficies de alto contacto (pomos de puertas, interruptores de luz, tel√©fonos).',
                'Desempolvado de escritorios, mesas y otras superficies (superficialmente, sin mover objetos personales).',
                'Limpieza de pantallas de ordenador y monitores con productos adecuados.',
                'Limpieza de huellas y manchas en vidrios y espejos de la oficina.',
                'Barrido o aspirado de pisos y limpieza de manchas visibles.',
                'Revisi√≥n y limpieza de rejillas de ventilaci√≥n accesibles.'
            ],
            'Shampuseado de Alfombras': [
                'Preparaci√≥n del √°rea (mover mobiliario, se√±alizar).',
                'Aspirado profundo de la alfombra para remover suciedad suelta.',
                'Aplicaci√≥n de soluci√≥n de shampoo especializado.',
                'Uso de m√°quina de inyecci√≥n/extracci√≥n para limpiar y enjuagar la alfombra.',
                'Tratamiento de manchas dif√≠ciles.',
                'Secado asistido (ventiladores, extractores) para reducir el tiempo de secado.'
            ]
        }
    };

    // Funci√≥n para mostrar el men√∫ principal de actividades en el SweetAlert
    function showMainMenuInModal() {
        const activityOptions = Object.keys(helpContent).map(activity => {
            let icon = '';
            if (activity === 'Limpieza de Ba√±os') icon = 'üöª';
            else if (activity === 'Limpieza de Oficina') icon = 'üè¢';

            return `<button class="activity-menu-button" onclick="showSubMenuInModal('${activity}')">
                        <span style="font-size: 1.5em;">${icon}</span> ${activity}
                    </button>`;
        }).join('');

        Swal.update({
            title: 'Gu√≠a de Actividades',
            html: `<div class="activity-menu-grid">${activityOptions}</div>`,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                popup: 'swal2-menu-popup',
                title: 'swal2-title',
                htmlContainer: 'swal2-html-container'
            }
        });
    }

    // Funci√≥n para mostrar el sub-men√∫ de actividades
    function showSubMenuInModal(categoryName) {
        const subActivities = helpContent[categoryName];
        let htmlContent = '';

        if (subActivities && Object.keys(subActivities).length > 0) {
            const subActivityButtons = Object.keys(subActivities).map(subActivity => {
                let icon = '';
                if (subActivity === 'Repaso de Ba√±o') icon = 'üöΩ';
                else if (subActivity === 'Profunda de Ba√±o') icon = '‚ú®';
                else if (subActivity === 'Per√≠odica de Ba√±o') icon = 'üåÄ';
                else if (subActivity === 'Aspirado') icon = 'üßπ';
                else if (subActivity === 'Rutinaria') icon = 'üìã';
                else if (subActivity === 'Shampuseado de Alfombras') icon = 'üßº';

                return `<button class="activity-menu-button" onclick="loadInstructionsInModal('${subActivity}', '${categoryName}')">
                            <span style="font-size: 1.5em;">${icon}</span> ${subActivity}
                        </button>`;
            }).join('');
            htmlContent = `<div class="activity-menu-grid">${subActivityButtons}</div>`;
        } else {
            htmlContent = `<p>No hay sub-actividades disponibles para "${categoryName}".</p>`;
        }

        const customHeaderHtml = `
            <div class="custom-modal-header">
                <button class="swal2-back-button" onclick="showMainMenuInModal()" aria-label="Volver al Men√∫ Principal">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="24px" height="24px">
                        <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                    </svg>
                </button>
                <h2>Selecciona Sub-Actividad</h2>
            </div>`;

        Swal.update({
            title: '',
            html: customHeaderHtml + htmlContent,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                popup: 'swal2-menu-popup',
                title: 'swal2-title',
                htmlContainer: 'swal2-html-container'
            }
        });
    }

    // Funci√≥n para cargar las instrucciones en el *mismo* SweetAlert
    function loadInstructionsInModal(activityName, categoryName) {
        let instructions = [];
        if (helpContent[categoryName] && helpContent[categoryName][activityName]) {
            instructions = helpContent[categoryName][activityName];
        } else {
            // Fallback for direct top-level activities if any (though currently none in this structure)
            if (helpContent[activityName] && Array.isArray(helpContent[activityName])) {
                instructions = helpContent[activityName];
            }
        }
        
        const htmlContent = instructions.length > 0
            ? `<ul>${instructions.map(item => `<li class="swal2-list-item">${item}</li>`).join('')}</ul>`
            : `<p>No hay informaci√≥n detallada disponible para "${activityName}" en este momento.</p>`;

        const customHeaderHtml = `
            <div class="custom-modal-header">
                <button class="swal2-back-button" onclick="showSubMenuInModal('${categoryName}')" aria-label="Volver a Sub-Actividades">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="24px" height="24px">
                        <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/>
                        <path d="M0 0h24v24H0V0z" fill="none"/>
                    </svg>
                </button>
                <h2>Gu√≠a para: <strong>${activityName}</strong></h2>
            </div>`;
        
        Swal.update({
            title: '',
            html: customHeaderHtml + htmlContent,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                popup: 'swal2-detail-popup',
                htmlContainer: 'swal2-html-container'
            }
        });
    }

    // Event listener inicial para el icono de ayuda
    document.getElementById('helpIconContainer').addEventListener('click', () => {
        Swal.fire({
            title: 'Gu√≠a de Actividades',
            html: '',
            allowOutsideClick: false,
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
                popup: 'swal2-menu-popup',
                title: 'swal2-title',
                htmlContainer: 'swal2-html-container'
            },
            didOpen: () => {
                showMainMenuInModal();
            }
        });
    });
</script>

</body>
</html>
