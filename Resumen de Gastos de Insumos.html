<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pisos Brillantes - Resumen</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --text-color: #333;
      --border-color: #ddd;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: var(--text-color);
      line-height: 1.6;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
      color: white;
      text-align: center;
      padding: 18px 0;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: var(--shadow);
      position: relative;
    }

    .form-container {
      width: 90%;
      max-width: 1300px;
      margin: 25px auto;
      padding: 25px;
      background-color: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 25px;
      font-size: 1.8rem;
      position: relative;
      padding-bottom: 10px;
    }

    h1:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background-color: var(--secondary-color);
      border-radius: 2px;
    }

    /* Estilos para el contenedor de fechas y botón de carga */
    .date-filter-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .date-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-filter-container label {
      font-weight: bold;
      color: #333;
      white-space: nowrap;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .button-group button {
      flex: 1;
      min-width: 120px;
    }

    /* ESTILOS DE FECHA MEJORADOS */
    .date-filter-container input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-color: #f8f8f8;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      min-width: 140px;
    }

    .date-filter-container input[type="date"]::-webkit-calendar-picker-indicator {
      background: none;
      color: var(--secondary-color);
      font-size: 1.2em;
      cursor: pointer;
      opacity: 1;
      -webkit-filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg); 
      filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg);
    }

    .date-filter-container input[type="date"]:hover {
      border-color: var(--secondary-color);
    }

    .date-filter-container input[type="date"]:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
      background-color: #ffffff;
    }

    #btn-cargar-resumen-fechas {
      background-color: var(--success-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: var(--transition);
    }

    #btn-cargar-resumen-fechas:hover {
      background-color: #218838;
    }

    /* Estilos para el botón de gráficos */
    #btn-mostrar-graficos {
      background-color: #6f42c1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }

    #btn-mostrar-graficos:hover {
      background-color: #5a32a3;
    }

    /* Estilos para el botón de ranking */
    #btn-ranking {
      background-color: #fd7e14;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
      font-weight: 500;
    }

    #btn-ranking:hover {
      background-color: #dc6b12;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    /* Estilos para la ventana modal de resumen */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: flex-start;
      padding: 20px 0;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 900px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
    }

    .close-modal-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
      transition: var(--transition);
      z-index: 1000;
    }

    .close-modal-btn:hover,
    .close-modal-btn:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    #resumen-tabla-container {
      max-height: 70vh;
      overflow-y: auto;
      margin-top: 20px;
    }

    #resumen-tabla {
      width: 100%;
      border-collapse: collapse;
    }

    #resumen-tabla th, #resumen-tabla td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: center;
    }

    #resumen-tabla th {
      background-color: var(--secondary-color);
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    #resumen-tabla tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #resumen-tabla tbody tr:hover {
      background-color: #ddd;
    }

    /* Estilos para el campo de búsqueda del resumen */
    .resumen-search-container {
      margin-bottom: 15px;
      text-align: center;
    }

    #resumen-search-input {
      width: 80%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1em;
    }

    /* Estilos para los totales fuera de la tabla */
    #resumen-totals-section {
      margin-top: 20px;
      font-weight: bold;
      padding: 10px;
      border-top: 2px solid var(--secondary-color);
      background-color: #e9ecef;
      border-radius: 4px;
      display: none;
    }
    
    #resumen-product-sums {
      text-align: left;
      margin-top: 0px;
      font-weight: normal;
      padding-top: 0px;
    }
    
    #resumen-product-sums h4 {
      margin-top: 0;
      margin-bottom: 8px;
      color: #333;
      font-size: 1.1em;
    }
    
    #resumen-product-sums p {
      margin: 4px 0;
      padding-left: 10px;
    }

    /* Estilo para centrar el título del modal */
    .modal-title {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
      color: #333;
      font-size: 1.5em;
    }

    /* Estilo para el botón de PDF */
    #btn-generar-pdf {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }

    #btn-generar-pdf:hover {
      background-color: #c82333;
    }

    /* Estilos para el modal de gráficos */
    #graficosModal {
      display: none;
      position: fixed;
      z-index: 10001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: flex-start;
      padding: 20px 0;
    }

    .graficos-modal-content {
      background-color: #fefefe;
      margin: 20px auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 1200px;
      max-height: 90vh;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .graficos-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-top: 20px;
    }

    .grafico-item {
      flex: 1 1 45%;
      min-width: 400px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .grafico-item h3 {
      text-align: center;
      margin-top: 0;
      color: #333;
    }

    .grafico-canvas {
      width: 100% !important;
      height: 300px !important;
    }

    /* Estilos para el selector de tipo de gráfico */
    .chart-type-selector {
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }

    /* Scrollbar personalizado */
    .graficos-modal-content::-webkit-scrollbar,
    .ranking-modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .graficos-modal-content::-webkit-scrollbar-track,
    .ranking-modal-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .graficos-modal-content::-webkit-scrollbar-thumb,
    .ranking-modal-content::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .graficos-modal-content::-webkit-scrollbar-thumb:hover,
    .ranking-modal-content::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* ESTILOS ESPECÍFICOS PARA EL MODAL DE RANKING */
    #rankingModal .modal-content {
      max-width: 1200px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 25px;
    }

    /* Barra de búsqueda para ranking */
    .ranking-search-container {
      margin-bottom: 20px;
      text-align: center;
    }

    #ranking-search-input {
      width: 80%;
      max-width: 500px;
      padding: 12px 20px;
      border: 2px solid var(--border-color);
      border-radius: 30px;
      font-size: 1em;
      transition: var(--transition);
      outline: none;
    }

    #ranking-search-input:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .ranking-pdf-button {
      text-align: right;
      margin-bottom: 20px;
    }

    .ranking-pdf-button button {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .ranking-pdf-button button:hover {
      background-color: #c82333;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .ranking-pdf-button button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      transform: none;
    }

    .ranking-pdf-button button i {
      font-size: 18px;
    }

    /* Tarjetas de edificio */
    .edificio-card {
      background: white;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
      border: 1px solid #e0e0e0;
      transition: var(--transition);
    }

    .edificio-card.hidden {
      display: none;
    }

    .edificio-header {
      background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
      color: white;
      padding: 15px 20px;
      font-size: 1.3rem;
      font-weight: bold;
      border-bottom: 3px solid var(--secondary-color);
    }

    .edificio-header i {
      margin-right: 10px;
      color: var(--secondary-color);
    }

    /* Tarjetas de producto dentro de cada edificio */
    .producto-card {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .producto-card:last-child {
      border-bottom: none;
    }

    .producto-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--secondary-color);
    }

    .producto-header h4 {
      margin: 0;
      color: var(--primary-color);
      font-size: 1.2rem;
      font-weight: 600;
    }

    .producto-header h4 i {
      color: var(--secondary-color);
      margin-right: 8px;
    }

    .producto-total {
      background: linear-gradient(135deg, var(--secondary-color), #2980b9);
      color: white;
      padding: 6px 16px;
      border-radius: 30px;
      font-weight: bold;
      font-size: 0.95rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .producto-total i {
      margin-right: 5px;
    }

    /* Tabla de ranking */
    .ranking-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
    }

    .ranking-table th {
      background: linear-gradient(135deg, var(--secondary-color), #2980b9);
      color: white;
      font-weight: 600;
      padding: 12px;
      text-align: center;
      font-size: 0.95rem;
    }

    .ranking-table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      text-align: center;
    }

    .ranking-table tr:last-child td {
      border-bottom: none;
    }

    .ranking-table tbody tr:hover {
      background-color: #f0f7ff;
    }

    /* Estilos para las filas */
    .ranking-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    .ranking-table tbody tr:nth-child(1) {
      background-color: #fff9e6;
      font-weight: 500;
    }

    .ranking-table tbody tr:nth-child(1) td:first-child {
      border-left: 4px solid #ffd700;
    }

    .ranking-table tbody tr:nth-child(2) td:first-child {
      border-left: 4px solid #c0c0c0;
    }

    .ranking-table tbody tr:nth-child(3) td:first-child {
      border-left: 4px solid #cd7f32;
    }

    .porcentaje-badge {
      background: linear-gradient(135deg, var(--secondary-color), #2980b9);
      color: white;
      padding: 4px 10px;
      border-radius: 30px;
      font-size: 0.85rem;
      font-weight: bold;
      display: inline-block;
      min-width: 65px;
      text-align: center;
    }

    .cantidad-cell {
      font-weight: 600;
      color: var(--dark-color);
      text-align: center;
    }

    /* Overlay y spinner */
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(52, 152, 219, 0.2);
      border-radius: 50%;
      border-top-color: var(--secondary-color);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Media queries para responsividad */
    @media (max-width: 768px) {
      .form-container {
        width: 95%;
        padding: 15px;
        margin: 15px auto;
      }
      
      .grafico-item {
        max-width: 100%;
        min-width: 100% !important;
        flex: 1 1 100% !important;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .date-filter-container {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .date-group {
        justify-content: space-between;
        width: 100%;
      }
      
      .date-group label {
        width: 80px;
        text-align: left;
      }
      
      .date-group input[type="date"] {
        width: calc(100% - 90px);
      }
      
      .button-group {
        width: 100%;
        justify-content: space-between;
      }
      
      .button-group button {
        flex: 1;
        margin: 2px;
        font-size: 14px;
        padding: 10px 8px;
      }
      
      .ranking-table {
        font-size: 0.9rem;
      }
      
      .ranking-table th,
      .ranking-table td {
        padding: 8px;
      }
      
      .producto-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .producto-total {
        align-self: flex-start;
      }
      
      #ranking-search-input {
        width: 95%;
      }
    }

    @media (max-width: 480px) {
      .button-group button {
        font-size: 12px;
        padding: 8px 6px;
        min-width: 100px;
      }
      
      .date-group label {
        width: 70px;
        font-size: 14px;
      }
      
      .date-group input[type="date"] {
        width: calc(100% - 80px);
        font-size: 14px;
        min-width: 120px;
      }
      
      .ranking-table {
        font-size: 0.8rem;
      }
      
      .ranking-table th,
      .ranking-table td {
        padding: 6px;
      }
      
      .porcentaje-badge {
        padding: 2px 6px;
        font-size: 0.75rem;
        min-width: 50px;
      }
    }
</style>
</head>
<body>
  <div id="main-content">
    <div class="header">Pisos Brillantes</div>
    
    <div class="form-container">
      <h1>Resumen de Gastos de Insumos</h1>

      <div class="date-filter-container">
        <div class="date-group">
          <label for="fecha-inicio-resumen">Desde:</label>
          <input type="date" id="fecha-inicio-resumen">
        </div>
        <div class="date-group">
          <label for="fecha-fin-resumen">Hasta:</label>
          <input type="date" id="fecha-fin-resumen">
        </div>
        <div class="button-group">
          <button type="button" id="btn-cargar-resumen-fechas" onclick="cargarResumenDevoluciones()">Cargar Resumen</button>
          <button type="button" id="btn-mostrar-graficos" onclick="abrirModalGraficos()">Mostrar Gráficos</button>
          <button type="button" id="btn-ranking" onclick="abrirModalRanking()">Ranking</button>
        </div>
      </div>

      <div class="resumen-search-container">
        <input type="text" id="resumen-search-input" placeholder="Filtrar por Edificio, Nivel o Producto (separado por espacios)" oninput="filtrarResumen()" autocomplete="off">
      </div>

      <div id="resumen-tabla-container">
        <table id="resumen-tabla">
          <thead>
            <tr>
              <th>Edificio</th>
              <th>Nivel</th>
              <th>Producto</th>
              <th>Total de Consumo</th>
            </tr>
          </thead>
          <tbody id="resumen-tbody">
            <tr>
              <td colspan="4" style="text-align: center; color: #666; font-style: italic;">
                Seleccione un rango de fechas y haga clic en "Cargar Resumen"
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="resumen-totals-section">
          <div id="resumen-product-sums">
          </div>
      </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" style="display: none;">
      <div class="spinner"></div>
      <div id="loadingMessage">
        <h4>Por favor espera un momento...</h4>
        <p></p>
      </div>
    </div>
  </div>

  <!-- Modal para gráficos -->
  <div id="graficosModal" class="modal">
    <div class="graficos-modal-content">
      <span class="close-modal-btn" onclick="cerrarModalGraficos()">&times;</span>
      <h2 class="modal-title">Gráficos de Consumo</h2>
      
      <div style="text-align: right; margin-bottom: 20px;">
        <button type="button" id="btn-generar-pdf-graficos" onclick="generarPDFGraficos()" style="background-color: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px;">
          <i class="fas fa-file-pdf"></i> Generar PDF de Gráficos
        </button>
      </div>
      
      <div id="graficos-loading" style="text-align: center; padding: 40px;">
        <div class="spinner" style="margin: 0 auto;"></div>
        <h3 style="margin-top: 20px;">Cargando gráficos, por favor espere...</h3>
      </div>
      
      <div id="graficos-content" style="display: none;">
        <div class="chart-type-selector">
          <label for="chart-type">Tipo de Gráfico: </label>
          <select id="chart-type" onchange="actualizarGraficos()">
            <option value="bar">Barras</option>
          </select>
        </div>
        <div class="graficos-container" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
      </div>
    </div>
  </div>

  <!-- Modal para Ranking -->
  <div id="rankingModal" class="modal">
    <div class="modal-content">
      <span class="close-modal-btn" onclick="cerrarModalRanking()">&times;</span>
      <h2 class="modal-title">Ranking de Consumo por Nivel</h2>
      
      <div class="ranking-pdf-button">
        <button type="button" id="btn-generar-pdf-ranking" onclick="generarPDFRanking()" disabled>
          <i class="fas fa-file-pdf"></i> Generar PDF del Ranking
        </button>
      </div>

      <div class="ranking-search-container">
        <input type="text" id="ranking-search-input" placeholder="Buscar edificio..." oninput="filtrarRanking()" autocomplete="off">
      </div>
      
      <div id="ranking-loading" style="text-align: center; padding: 40px; display: none;">
        <div class="spinner" style="margin: 0 auto;"></div>
        <h3 style="margin-top: 20px;">Generando ranking, por favor espere...</h3>
      </div>

      <div id="ranking-content">
        <!-- Aquí se inyectará el contenido -->
      </div>
    </div>
  </div>

<script>
  // Variables globales
  let resumenData = [];
  let filteredResumenData = [];
  let allSummaryDates = [];
  let charts = {};
  // Variable global para cachear datos diarios
  let datosDiariosCache = [];

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('main-content').style.display = 'block';
    
    // Establecer fechas por defecto
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    $('#fecha-inicio-resumen').val(formatDate(firstDayOfMonth));
    $('#fecha-fin-resumen').val(formatDate(today));
    
    // Listener para mostrar/ocultar totales
    document.addEventListener('keydown', function(event) {
      if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'S') {
          const totalsSection = document.getElementById('resumen-totals-section');
          totalsSection.style.display = totalsSection.style.display === 'none' ? 'block' : 'none';
          event.preventDefault();
      }
    });
  });

  function cargarResumenDevoluciones() {
    const fechaInicio = $('#fecha-inicio-resumen').val();
    const fechaFin = $('#fecha-fin-resumen').val();

    if (!fechaInicio || !fechaFin) {
        Swal.fire('Advertencia', 'Por favor, seleccione una fecha de inicio y una fecha de fin.', 'warning');
        return;
    }

    if (new Date(fechaInicio) > new Date(fechaFin)) {
        Swal.fire('Advertencia', 'La fecha de inicio no puede ser posterior a la fecha de fin.', 'warning');
        return;
    }

    const resumenTbody = $('#resumen-tbody');
    resumenTbody.empty().append(`
        <tr id="loading-row">
            <td colspan="4" style="text-align: center; padding: 20px;">
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div class="spinner" style="margin: 0;"></div>
                    <div style="margin-top: 10px;">Cargando resumen, por favor espere...</div>
                </div>
            </td>
        </tr>
    `);
    
    $('#resumen-search-input').val('');

    const scriptResumenUrl = `https://script.google.com/macros/s/AKfycbwJKU4mJvqMjenGjobggSFmaSPSZgYF8cXzhr82h0Gbq-y3SsSqKqoHj2GU9IhAMw6C/exec?action=obtenerResumen&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`; 
    
    $.ajax({
        url: scriptResumenUrl,
        type: "GET",
        dataType: "json",
        success: function(data) {
            $('#overlay').hide();
            $('#loading-row').remove();
            
            if (data.error) {
                resumenTbody.append(`<tr><td colspan="4" style="text-align: center; color: red;">Error: ${data.mensaje}</td></tr>`);
                Swal.fire('Error', data.mensaje, 'error');
                return;
            }
            if (!data.resumen || data.resumen.length === 0) {
                resumenTbody.append('<tr><td colspan="4" style="text-align: center;">No hay datos en el historial para el rango de fechas seleccionado.</td></tr>');
                $('#resumen-product-sums').empty();
                filteredResumenData = [];
                allSummaryDates = [];
                return;
            }

            resumenData = data.resumen;
            filteredResumenData = [...resumenData];
            allSummaryDates = data.allTransactionDates || [];
            mostrarResumenEnTabla(filteredResumenData);
        },
        error: function(xhr, status, error) {
            $('#overlay').hide();
            $('#loading-row').remove();
            
            resumenTbody.empty().append(`<tr><td colspan="4" style="text-align: center; color: red;">Error al cargar resumen: ${error}</td></tr>`);
            Swal.fire('Error', 'Error al cargar el resumen: ' + error, 'error');
            $('#resumen-product-sums').empty();
            filteredResumenData = [];
            allSummaryDates = [];
        }
    });
  }

  function mostrarResumenEnTabla(dataToShow) {
    const resumenTbody = $('#resumen-tbody');
    resumenTbody.empty();
    
    let totalGeneral = 0; 
    const productSums = {}; 

    dataToShow.sort((a, b) => {
        const areaCompare = a.area.localeCompare(b.area);
        if (areaCompare !== 0) return areaCompare;

        const nivelA = String(a.nivel).toUpperCase();
        const nivelB = String(b.nivel).toUpperCase();

        if (nivelA === 'X' && nivelB !== 'X') return 1;
        if (nivelA !== 'X' && nivelB === 'X') return -1;
        if (nivelA === 'X' && nivelB === 'X') return 0;

        const numNivelA = parseInt(nivelA);
        const numNivelB = parseInt(nivelB);
        if (!isNaN(numNivelA) && !isNaN(numNivelB)) {
            const nivelCompare = numNivelA - numNivelB;
            if (nivelCompare !== 0) return nivelCompare;
        } else if (isNaN(numNivelA) && !isNaN(numNivelB)) {
            return 1; 
        } else if (!isNaN(numNivelA) && isNaN(numNivelB)) {
            return -1; 
        }
        return a.producto.localeCompare(b.producto);
    });

    if (dataToShow.length === 0) {
        resumenTbody.append('<tr><td colspan="4" style="text-align: center;">No se encontraron resultados para el filtro actual.</td></tr>');
    } else {
        dataToShow.forEach(item => {
            resumenTbody.append(`
                <tr>
                    <td>${item.area}</td>
                    <td>${item.nivel === '0' ? 'Sin Nivel' : item.nivel}</td>
                    <td>${item.producto}</td>
                    <td>${item.cantidadTotal}</td>
                </tr>
            `);
            totalGeneral += item.cantidadTotal; 

            if (productSums[item.producto]) {
                productSums[item.producto] += item.cantidadTotal;
            } else {
                productSums[item.producto] = item.cantidadTotal;
            }
        });
    }

    const resumenProductSumsDiv = $('#resumen-product-sums');
    resumenProductSumsDiv.empty();
    if (Object.keys(productSums).length > 0) {
        resumenProductSumsDiv.append('<h4>Resumen de Consumo:</h4>');
        for (const product in productSums) {
            resumenProductSumsDiv.append(`<p>${product}: ${productSums[product].toLocaleString('es-HN')} unidades</p>`);
        }
    }
  }

  function filtrarResumen() {
    const searchText = $('#resumen-search-input').val().toLowerCase().trim();
    const keywords = searchText.split(' ').filter(keyword => keyword.length > 0);

    filteredResumenData = resumenData.filter(item => {
        const area = item.area.toLowerCase();
        const nivel = String(item.nivel).toLowerCase();
        const producto = item.producto.toLowerCase();

        if (keywords.length === 0) return true;

        return keywords.every(keyword =>
            area.includes(keyword) ||
            nivel.includes(keyword) ||
            producto.includes(keyword)
        );
    });
    
    mostrarResumenEnTabla(filteredResumenData);
    
    if (document.getElementById('graficosModal').style.display === 'flex') {
        generarGraficos();
    }
  }

  function ajustarGraficosParaMovil() {
    if (window.innerWidth <= 768) {
      Object.values(charts).forEach(chart => {
        if (chart) {
          chart.resize();
        }
      });
    }
  }

  window.addEventListener('resize', ajustarGraficosParaMovil);

  function abrirModalGraficos() {
    if (filteredResumenData.length === 0) {
      Swal.fire('Advertencia', 'No hay datos en el resumen para generar gráficos. Cargue un resumen primero.', 'warning');
      return;
    }

    const modal = document.getElementById('graficosModal');
    modal.style.display = 'flex';
    modal.scrollTop = 0;

    document.getElementById('graficos-loading').style.display = 'block';
    document.getElementById('graficos-content').style.display = 'none';
    document.querySelector('.graficos-container').innerHTML = '';

    setTimeout(() => {
      generarGraficos();
    }, 100);
  }

  function cerrarModalGraficos() {
    Object.values(charts).forEach(chart => {
      if (chart) chart.destroy();
    });
    charts = {};
    document.getElementById('graficosModal').style.display = 'none';
  }

  // --- FUNCIONES PARA GRÁFICOS ---
  async function generarGraficos() {
    const loadingElement = document.getElementById('graficos-loading');
    const contentElement = document.getElementById('graficos-content');
    const graficosContainer = document.querySelector('.graficos-container');
    
    try {
      const datosResumen = prepararDatosParaGraficos();
      const datosDiarios = await cargarDatosDiarios();

      const chartType = 'bar';

      const commonTooltipOptions = {
        callbacks: {
          label: function(context) {
            return `${context.label || context.dataset.label}: ${context.raw} unidades`;
          }
        }
      };

      // Gráfico de productos
      const productoDiv = document.createElement('div');
      productoDiv.className = 'grafico-item';
      productoDiv.innerHTML = '<h3>Consumo por Producto</h3><canvas id="productoChart" class="grafico-canvas"></canvas>';
      graficosContainer.appendChild(productoDiv);

      const productoCtx = document.getElementById('productoChart').getContext('2d');
      charts.productoChart = new Chart(productoCtx, {
        type: chartType,
        data: {
          labels: datosResumen.productos.labels,
          datasets: [{
            label: 'Consumo por Producto',
            data: datosResumen.productos.data,
            backgroundColor: generarColores(datosResumen.productos.labels.length)
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: commonTooltipOptions
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Cantidad (unidades)' } }
          }
        }
      });

      // Gráficos por edificio y producto
      for (const producto in datosResumen.edificios) {
        const edificioDiv = document.createElement('div');
        edificioDiv.className = 'grafico-item';
        edificioDiv.innerHTML = `<h3>Consumo en Edificios (${producto})</h3><canvas id="edificioChart-${producto}" class="grafico-canvas"></canvas>`;
        graficosContainer.appendChild(edificioDiv);

        const edificioCtx = document.getElementById(`edificioChart-${producto}`).getContext('2d');
        charts[`edificioChart-${producto}`] = new Chart(edificioCtx, {
          type: chartType,
          data: {
            labels: datosResumen.edificios[producto].labels,
            datasets: [{
              label: `Consumo de ${producto}`,
              data: datosResumen.edificios[producto].data,
              backgroundColor: generarColores(datosResumen.edificios[producto].labels.length)
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { tooltip: commonTooltipOptions },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Cantidad (unidades)' } } }
          }
        });
      }

      // Gráficos por nivel
      for (const edificio in datosResumen.niveles) {
        for (const producto in datosResumen.niveles[edificio]) {
          const nivelDiv = document.createElement('div');
          nivelDiv.className = 'grafico-item';
          nivelDiv.innerHTML = `<h3>Consumo en ${edificio} - ${producto} por Nivel</h3><canvas id="nivelChart-${edificio}-${producto}" class="grafico-canvas"></canvas>`;
          graficosContainer.appendChild(nivelDiv);

          const nivelCtx = document.getElementById(`nivelChart-${edificio}-${producto}`).getContext('2d');
          charts[`nivelChart-${edificio}-${producto}`] = new Chart(nivelCtx, {
            type: chartType,
            data: {
              labels: datosResumen.niveles[edificio][producto].labels,
              datasets: [{
                label: `Consumo en ${edificio}`,
                data: datosResumen.niveles[edificio][producto].data,
                backgroundColor: generarColores(datosResumen.niveles[edificio][producto].labels.length)
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { tooltip: commonTooltipOptions },
              scales: { y: { beginAtZero: true, title: { display: true, text: 'Cantidad (unidades)' } } }
            }
          });
        }
      }

      // Gráficos diarios
      if (datosDiarios && datosDiarios.length > 0) {
        datosDiarios.forEach(datosProducto => {
          if (datosProducto.datos && datosProducto.datos.length > 0) {
            const diarioDiv = document.createElement('div');
            diarioDiv.className = 'grafico-item';
            diarioDiv.innerHTML = `<h3>Consumo Diario (${datosProducto.producto})</h3><canvas id="diarioChart-${datosProducto.producto}" class="grafico-canvas"></canvas>`;
            graficosContainer.appendChild(diarioDiv);

            const diarioCtx = document.getElementById(`diarioChart-${datosProducto.producto}`).getContext('2d');
            charts[`diarioChart-${datosProducto.producto}`] = new Chart(diarioCtx, {
              type: 'line',
              data: {
                labels: datosProducto.datos.map(d => d.fecha),
                datasets: [{
                  label: `Consumo Diario ${datosProducto.producto}`,
                  data: datosProducto.datos.map(d => d.cantidad),
                  borderColor: 'rgba(54, 162, 235, 1)',
                  backgroundColor: 'rgba(54, 162, 235, 0.1)',
                  tension: 0.1,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { tooltip: commonTooltipOptions },
                scales: {
                  y: { beginAtZero: true, title: { display: true, text: 'Cantidad (unidades)' } },
                  x: { title: { display: true, text: 'Fecha' } }
                }
              }
            });
          }
        });
      }

      // ============================================
      // TABLA DE PROMEDIOS DE CONSUMO DIARIO
      // ============================================
      
      // Crear contenedor para la tabla de promedios
      const promediosDiv = document.createElement('div');
      promediosDiv.className = 'grafico-item';
      promediosDiv.style.minWidth = '100%';
      promediosDiv.style.marginTop = '30px';
      promediosDiv.innerHTML = '<h3>Promedio de Consumo Diario por Producto</h3>';
      
      // Calcular promedios si hay datos diarios
      if (datosDiarios && datosDiarios.length > 0) {
        // Calcular número de días en el rango seleccionado (CORREGIDO)
        const fechaInicioStr = $('#fecha-inicio-resumen').val();
        const fechaFinStr = $('#fecha-fin-resumen').val();
        
        // Crear fechas correctamente (evitar problemas de zona horaria)
        const fechaInicio = new Date(fechaInicioStr + 'T12:00:00');
        const fechaFin = new Date(fechaFinStr + 'T12:00:00');
        
        // Calcular diferencia en días (CORREGIDO)
        const diffTime = Math.abs(fechaFin - fechaInicio);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 para incluir ambos días
        
        // Función para formatear fecha correctamente (CORREGIDA)
        const formatFecha = (dateStr) => {
          if (!dateStr) return '';
          const [year, month, day] = dateStr.split('-');
          return `${day}/${month}/${year}`;
        };
        
        // Preparar datos para la tabla
        const promediosData = [];
        
        datosDiarios.forEach(datosProducto => {
          if (datosProducto.datos && datosProducto.datos.length > 0) {
            const totalConsumo = datosProducto.datos.reduce((sum, item) => sum + item.cantidad, 0);
            const promedio = totalConsumo / diffDays;
            
            // Encontrar el día de mayor consumo
            const diaMaximo = datosProducto.datos.reduce((max, item) => 
              item.cantidad > max.cantidad ? item : max, datosProducto.datos[0]);
            
            // Encontrar el día de menor consumo (solo días con consumo > 0)
            const diasConConsumo = datosProducto.datos.filter(item => item.cantidad > 0);
            const diaMinimo = diasConConsumo.length > 0 
              ? diasConConsumo.reduce((min, item) => item.cantidad < min.cantidad ? item : min, diasConConsumo[0])
              : { fecha: 'N/A', cantidad: 0 };
            
            promediosData.push({
              producto: datosProducto.producto,
              total: totalConsumo,
              promedio: promedio,
              diasConConsumo: datosProducto.datos.filter(item => item.cantidad > 0).length,
              diaMaximo: diaMaximo,
              diaMinimo: diaMinimo
            });
          }
        });
        
        // Ordenar productos por promedio (de mayor a menor)
        promediosData.sort((a, b) => b.promedio - a.promedio);
        
        // Crear tabla HTML
        let tablaHTML = `
          <style>
            .promedios-table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 15px;
              font-size: 14px;
            }
            .promedios-table th {
              background: linear-gradient(135deg, var(--secondary-color), #2980b9);
              color: white;
              padding: 12px;
              text-align: center;
              font-weight: 600;
            }
            .promedios-table td {
              padding: 10px;
              border-bottom: 1px solid #e0e0e0;
              text-align: center;
            }
            .promedios-table tr:nth-child(even) {
              background-color: #f8f9fa;
            }
            .promedios-table tr:hover {
              background-color: #f0f7ff;
            }
            .promedio-destacado {
              font-weight: bold;
              color: var(--primary-color);
            }
            .badge-max {
              background-color: #27ae60;
              color: white;
              padding: 3px 8px;
              border-radius: 12px;
              font-size: 11px;
              font-weight: bold;
            }
            .badge-min {
              background-color: #e67e22;
              color: white;
              padding: 3px 8px;
              border-radius: 12px;
              font-size: 11px;
              font-weight: bold;
            }
          </style>
          <table class="promedios-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Total Período</th>
                <th>Promedio Diario</th>
                <th>Días con Consumo</th>
                <th>Día Mayor Consumo</th>
                <th>Día Menor Consumo</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        promediosData.forEach(item => {
          tablaHTML += `
            <tr>
              <td><strong>${item.producto}</strong></td>
              <td>${item.total.toLocaleString('es-HN')} und.</td>
              <td class="promedio-destacado">${item.promedio.toFixed(1)} und./día</td>
              <td>${item.diasConConsumo} de ${diffDays} días</td>
              <td>${item.diaMaximo.fecha}: <span class="badge-max">${item.diaMaximo.cantidad} und.</span></td>
              <td>${item.diaMinimo.fecha !== 'N/A' ? item.diaMinimo.fecha + ': ' : ''}<span class="badge-min">${item.diaMinimo.cantidad} und.</span></td>
            </tr>
          `;
        });
        
        tablaHTML += `
            </tbody>
          </table>
          <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
            * Promedio calculado sobre ${diffDays} días (${formatFecha(fechaInicioStr)} al ${formatFecha(fechaFinStr)})
          </div>
        `;
        
        promediosDiv.innerHTML += tablaHTML;
      } else {
        promediosDiv.innerHTML += '<p style="text-align: center; padding: 20px; color: #666;">No hay datos diarios disponibles para calcular promedios</p>';
      }
      
      graficosContainer.appendChild(promediosDiv);

      loadingElement.style.display = 'none';
      contentElement.style.display = 'block';

    } catch (error) {
      console.error('Error al generar gráficos:', error);
      loadingElement.innerHTML = '<div style="color: red;">Error al cargar los gráficos</div>';
    }
  }

  // Función auxiliar para formatear rango de fechas
  function formatDateRange(fechaInicio, fechaFin) {
    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
    return `${fechaInicio.toLocaleDateString('es-ES', options)} al ${fechaFin.toLocaleDateString('es-ES', options)}`;
  }



  function prepararDatosParaGraficos() {
    const datos = {
      productos: { labels: [], data: [] },
      edificios: {},
      niveles: {}
    };

    const productosMap = {};
    filteredResumenData.forEach(item => {
      if (productosMap[item.producto]) {
        productosMap[item.producto] += item.cantidadTotal;
      } else {
        productosMap[item.producto] = item.cantidadTotal;
      }
    });
    datos.productos.labels = Object.keys(productosMap);
    datos.productos.data = Object.values(productosMap);

    filteredResumenData.forEach(item => {
      if (!datos.edificios[item.producto]) {
        datos.edificios[item.producto] = { labels: [], data: [] };
      }
      
      const edificioIndex = datos.edificios[item.producto].labels.indexOf(item.area);
      if (edificioIndex === -1) {
        datos.edificios[item.producto].labels.push(item.area);
        datos.edificios[item.producto].data.push(item.cantidadTotal);
      } else {
        datos.edificios[item.producto].data[edificioIndex] += item.cantidadTotal;
      }
    });

    filteredResumenData.forEach(item => {
      if (!datos.niveles[item.area]) {
        datos.niveles[item.area] = {};
      }
      
      if (!datos.niveles[item.area][item.producto]) {
        datos.niveles[item.area][item.producto] = { labels: [], data: [] };
      }
      
      const nivel = !item.nivel || item.nivel === 'Sin Nivel' ? '0' : item.nivel;
      
      const nivelIndex = datos.niveles[item.area][item.producto].labels.indexOf(nivel);
      if (nivelIndex === -1) {
        datos.niveles[item.area][item.producto].labels.push(nivel);
        datos.niveles[item.area][item.producto].data.push(item.cantidadTotal);
      } else {
        datos.niveles[item.area][item.producto].data[nivelIndex] += item.cantidadTotal;
      }
    });

    return datos;
  }

  function generarColores(cantidad) {
    const colores = [];
    const hueStep = Math.max(1, 360 / Math.max(1, cantidad));
    for (let i = 0; i < cantidad; i++) {
      colores.push(`hsl(${i * hueStep}, 70%, 60%)`);
    }
    return colores;
  }

  function cargarDatosDiarios() {
    const fechaInicio = $('#fecha-inicio-resumen').val();
    const fechaFin = $('#fecha-fin-resumen').val();
    const filtro = $('#resumen-search-input').val() || '';

    if (!fechaInicio || !fechaFin) {
      return Promise.resolve(null);
    }

    return new Promise((resolve, reject) => {
      const scriptDiarioUrl = `https://script.google.com/macros/s/AKfycbwJbg1Fm8kJycqc0LCyNcVkMQxsyDspmKI6Yo99ktVogwDPTMBeGCpCtPFna7CjsGqGGg/exec?action=obtenerDatosDiarios&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}&filtro=${encodeURIComponent(filtro)}`;
      
      $.ajax({
        url: scriptDiarioUrl,
        type: "GET",
        dataType: "json",
        success: function(data) {
          if (data.error) {
            reject(data.mensaje);
          } else {
            // Guardar en caché para el PDF
            datosDiariosCache = data.datosDiarios || [];
            resolve(data.datosDiarios || []);
          }
        },
        error: function(xhr, status, error) {
          reject(error);
        }
      });
    });
  }

  function actualizarGraficos() {
    document.getElementById('graficos-loading').style.display = 'block';
    document.getElementById('graficos-content').style.display = 'none';
    setTimeout(generarGraficos, 100);
  }

  function generarPDFGraficos() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(16);
    doc.text("Gráficos de Consumo", doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });
    
    const fechaInicio = $('#fecha-inicio-resumen').val();
    const fechaFin = $('#fecha-fin-resumen').val();
    
    // Función para formatear fecha correctamente
    const formatFecha = (dateStr) => {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year}`;
    };
    
    if (fechaInicio || fechaFin) {
      doc.setFontSize(10);
      doc.text(`Período: ${formatFecha(fechaInicio)} al ${formatFecha(fechaFin)}`, doc.internal.pageSize.getWidth() / 2, 22, { align: "center" });
    }
    
    let yPos = 30;
    const chartIds = Object.keys(charts);
    
    // ============================================
    // SECCIÓN 1: GRÁFICOS
    // ============================================
    for (let i = 0; i < chartIds.length; i += 2) {
      // Verificar si necesitamos nueva página
      if (yPos > 230) {
        doc.addPage();
        yPos = 20;
      }
      
      const chartId1 = chartIds[i];
      const canvas1 = document.getElementById(chartId1);
      
      if (canvas1) {
        // Título del primer gráfico con soporte multi-línea
        doc.setFontSize(10);
        doc.setTextColor(44, 62, 80);
        doc.setFont(undefined, 'bold');
        
        const titulo1 = canvas1.parentElement.querySelector('h3').textContent;
        
        // Dividir título en líneas (máximo 35 caracteres por línea)
        const lineasTitulo1 = splitTextIntoLines(titulo1, 35);
        
        // Posición inicial del título (separado del borde superior)
        let tituloYPos = yPos;
        
        // Dibujar cada línea del título con separación de 4mm entre líneas
        lineasTitulo1.forEach((linea, index) => {
          doc.text(linea, doc.internal.pageSize.getWidth() / 4, tituloYPos + (index * 4), { align: "center" });
        });
        
        // Calcular altura total del título (4mm por línea + espacio adicional)
        const alturaTitulo1 = (lineasTitulo1.length * 4) + 2;
        
        // Posición del gráfico (después del título)
        const graficoYPos = tituloYPos + alturaTitulo1;
        
        const imgData1 = canvas1.toDataURL('image/png');
        doc.addImage(imgData1, 'PNG', 15, graficoYPos, 85, 50);
        
        const chartId2 = chartIds[i + 1];
        const canvas2 = chartId2 ? document.getElementById(chartId2) : null;
        
        if (canvas2) {
          // Título del segundo gráfico con soporte multi-línea
          const titulo2 = canvas2.parentElement.querySelector('h3').textContent;
          
          // Dividir título en líneas
          const lineasTitulo2 = splitTextIntoLines(titulo2, 35);
          
          // Dibujar cada línea del título
          lineasTitulo2.forEach((linea, index) => {
            doc.text(linea, (doc.internal.pageSize.getWidth() / 4) * 3, tituloYPos + (index * 4), { align: "center" });
          });
          
          // Calcular altura total del título (4mm por línea + espacio adicional)
          const alturaTitulo2 = (lineasTitulo2.length * 4) + 2;
          
          // Usar la altura mayor de los dos títulos
          const alturaMaxTitulo = Math.max(alturaTitulo1, alturaTitulo2);
          
          // Obtener imagen del segundo gráfico
          const imgData2 = canvas2.toDataURL('image/png');
          
          // Posición del segundo gráfico (misma altura que el primero)
          doc.addImage(imgData2, 'PNG', 110, graficoYPos, 85, 50);
          
          // Actualizar yPos para el siguiente par de gráficos
          // Sumamos: altura del título + altura del gráfico + espacio entre gráficos
          yPos = graficoYPos + 50 + 15; // 15mm de espacio después de los gráficos
        } else {
          // Actualizar yPos para un solo gráfico
          yPos = graficoYPos + 50 + 10; // 10mm de espacio después de un solo gráfico
        }
      }
    }

    // ============================================
    // SECCIÓN 2: TABLA DE PROMEDIOS (AL FINAL)
    // ============================================
    
    // Forzar nueva página para la tabla de promedios
    doc.addPage();
    yPos = 20;
    
    // Obtener datos diarios de la variable global
    if (datosDiariosCache && datosDiariosCache.length > 0) {
      
      // Título de la sección de promedios
      doc.setFillColor(52, 152, 219);
      doc.rect(15, yPos - 2, doc.internal.pageSize.getWidth() - 30, 8, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text("PROMEDIO DE CONSUMO DIARIO POR PRODUCTO", doc.internal.pageSize.getWidth() / 2, yPos + 3, { align: "center" });
      yPos += 15; // Espacio después del título
      
      // Calcular número de días en el rango seleccionado
      const fechaInicioStr = fechaInicio;
      const fechaFinStr = fechaFin;
      
      // Crear fechas correctamente
      const fechaInicioDate = new Date(fechaInicioStr + 'T12:00:00');
      const fechaFinDate = new Date(fechaFinStr + 'T12:00:00');
      
      // Calcular diferencia en días
      const diffTime = Math.abs(fechaFinDate - fechaInicioDate);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
      
      // Preparar datos para la tabla de promedios
      const promediosData = [];
      
      datosDiariosCache.forEach(datosProducto => {
        if (datosProducto.datos && datosProducto.datos.length > 0) {
          const totalConsumo = datosProducto.datos.reduce((sum, item) => sum + item.cantidad, 0);
          const promedio = totalConsumo / diffDays;
          
          // Encontrar el día de mayor consumo
          const diaMaximo = datosProducto.datos.reduce((max, item) => 
            item.cantidad > max.cantidad ? item : max, datosProducto.datos[0]);
          
          // Encontrar el día de menor consumo
          const diasConConsumo = datosProducto.datos.filter(item => item.cantidad > 0);
          const diaMinimo = diasConConsumo.length > 0 
            ? diasConConsumo.reduce((min, item) => item.cantidad < min.cantidad ? item : min, diasConConsumo[0])
            : { fecha: 'N/A', cantidad: 0 };
          
          promediosData.push({
            producto: datosProducto.producto,
            total: totalConsumo,
            promedio: promedio,
            diasConConsumo: diasConConsumo.length,
            diaMaximo: diaMaximo,
            diaMinimo: diaMinimo
          });
        }
      });
      
      // Ordenar por promedio (de mayor a menor)
      promediosData.sort((a, b) => b.promedio - a.promedio);
      
      if (promediosData.length > 0) {
        // Preparar datos para la tabla
        const tableData = promediosData.map(item => [
          item.producto,
          item.total.toLocaleString('es-HN'),
          item.promedio.toFixed(1),
          `${item.diasConConsumo} / ${diffDays}`,
          `${item.diaMaximo.fecha}: ${item.diaMaximo.cantidad}`,
          item.diaMinimo.fecha !== 'N/A' ? `${item.diaMinimo.fecha}: ${item.diaMinimo.cantidad}` : 'N/A'
        ]);
        
        // Crear tabla de promedios a ancho completo
        doc.autoTable({
          startY: yPos,
          head: [['Producto', 'Total', 'Prom./día', 'Días c/consumo', 'Día mayor consumo', 'Día menor consumo']],
          body: tableData,
          theme: 'grid',
          headStyles: {
            fillColor: [52, 152, 219],
            textColor: [255, 255, 255],
            fontSize: 9,
            fontStyle: 'bold',
            halign: 'center',
            valign: 'middle'
          },
          bodyStyles: {
            fontSize: 8,
            halign: 'center',
            valign: 'middle'
          },
          columnStyles: {
            0: { cellWidth: 'auto', halign: 'center' },
            1: { cellWidth: 'auto', halign: 'center' },
            2: { cellWidth: 'auto', halign: 'center' },
            3: { cellWidth: 'auto', halign: 'center' },
            4: { cellWidth: 'auto', halign: 'center' },
            5: { cellWidth: 'auto', halign: 'center' }
          },
          margin: { left: 15, right: 15 },
          didDrawPage: (data) => {
            yPos = data.cursor.y + 5;
          }
        });
        
        yPos = doc.lastAutoTable.finalY + 10;
        
        // Agregar nota del período
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`* Promedio calculado sobre ${diffDays} días (${formatFecha(fechaInicio)} al ${formatFecha(fechaFin)})`, 
                 doc.internal.pageSize.getWidth() / 2, yPos, { align: "center" });
      } else {
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text("No hay datos suficientes para calcular promedios", 
                 doc.internal.pageSize.getWidth() / 2, yPos, { align: "center" });
      }
    } else {
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text("No hay datos diarios disponibles para calcular promedios", 
               doc.internal.pageSize.getWidth() / 2, yPos, { align: "center" });
    }
    
    doc.save(`Graficos_${fechaInicio}_al_${fechaFin}.pdf`);
  }



  // Función auxiliar para dividir texto en líneas
  function splitTextIntoLines(text, maxCharsPerLine) {
    const palabras = text.split(' ');
    const lineas = [];
    let lineaActual = '';
    
    for (const palabra of palabras) {
      if ((lineaActual + ' ' + palabra).length <= maxCharsPerLine) {
        if (lineaActual === '') {
          lineaActual = palabra;
        } else {
          lineaActual += ' ' + palabra;
        }
      } else {
        if (lineaActual !== '') {
          lineas.push(lineaActual);
        }
        lineaActual = palabra;
        
        // Si una palabra sola es más larga que el máximo, la dividimos
        if (lineaActual.length > maxCharsPerLine) {
          let resto = lineaActual;
          while (resto.length > maxCharsPerLine) {
            lineas.push(resto.substring(0, maxCharsPerLine));
            resto = resto.substring(maxCharsPerLine);
          }
          lineaActual = resto;
        }
      }
    }
    
    if (lineaActual !== '') {
      lineas.push(lineaActual);
    }
    
    return lineas;
  }



  // --- FUNCIONES PARA RANKING ---
  let rankingData = {};

  function abrirModalRanking() {
    if (!filteredResumenData || filteredResumenData.length === 0) {
      Swal.fire('Advertencia', 'No hay datos en el resumen para generar el ranking. Cargue un resumen primero.', 'warning');
      return;
    }

    const modal = document.getElementById('rankingModal');
    const loading = document.getElementById('ranking-loading');
    const content = document.getElementById('ranking-content');
    const pdfButton = document.getElementById('btn-generar-pdf-ranking');
    const searchInput = document.getElementById('ranking-search-input');

    modal.style.display = 'flex';
    loading.style.display = 'block';
    content.innerHTML = '';
    if (pdfButton) pdfButton.disabled = true;
    if (searchInput) searchInput.value = '';

    setTimeout(() => {
      procesarDatosRanking();
    }, 100);
  }

  function cerrarModalRanking() {
    document.getElementById('rankingModal').style.display = 'none';
    document.getElementById('ranking-content').innerHTML = '';
  }

  function procesarDatosRanking() {
    const loading = document.getElementById('ranking-loading');
    const content = document.getElementById('ranking-content');
    const pdfButton = document.getElementById('btn-generar-pdf-ranking');
    
    try {
      rankingData = {};

      filteredResumenData.forEach(item => {
        const edificio = item.area;
        const producto = item.producto;
        const nivel = item.nivel === '0' ? 'Sin Nivel' : item.nivel;
        const cantidad = item.cantidadTotal;

        if (!rankingData[edificio]) {
          rankingData[edificio] = {};
        }

        if (!rankingData[edificio][producto]) {
          rankingData[edificio][producto] = [];
        }

        rankingData[edificio][producto].push({
          nivel: nivel,
          cantidad: cantidad
        });
      });

      // Ordenar y calcular porcentajes
      for (const edificio in rankingData) {
        for (const producto in rankingData[edificio]) {
          const niveles = rankingData[edificio][producto];
          const totalProducto = niveles.reduce((sum, item) => sum + item.cantidad, 0);
          
          niveles.sort((a, b) => b.cantidad - a.cantidad);
          
          niveles.forEach(item => {
            item.porcentaje = totalProducto > 0 ? (item.cantidad / totalProducto) * 100 : 0;
          });
        }
      }

      generarVistaRanking();

    } catch (error) {
      console.error("Error al procesar ranking:", error);
      content.innerHTML = '<div style="color: red; text-align: center; padding: 20px;">Error al generar el ranking</div>';
    } finally {
      loading.style.display = 'none';
      if (pdfButton) pdfButton.disabled = false;
    }
  }

  function generarVistaRanking() {
    const content = document.getElementById('ranking-content');
    const searchText = document.getElementById('ranking-search-input')?.value.toLowerCase() || '';
    
    let htmlContent = '';

    for (const edificio in rankingData) {
      if (searchText && !edificio.toLowerCase().includes(searchText)) {
        continue;
      }

      htmlContent += `<div class="edificio-card" data-edificio="${edificio}">`;
      htmlContent += `<div class="edificio-header"><i class="fas fa-building"></i> ${edificio}</div>`;
      
      for (const producto in rankingData[edificio]) {
        const niveles = rankingData[edificio][producto];
        const totalProducto = niveles.reduce((sum, item) => sum + item.cantidad, 0);
        
        htmlContent += `<div class="producto-card">`;
        htmlContent += `<div class="producto-header">`;
        htmlContent += `<h4><i class="fas fa-box"></i> ${producto}</h4>`;
        htmlContent += `<span class="producto-total"><i class="fas fa-chart-line"></i> Total: ${totalProducto.toLocaleString('es-HN')} unidades</span>`;
        htmlContent += `</div>`;
        
        htmlContent += `<table class="ranking-table">`;
        htmlContent += `<thead><tr><th>Nivel</th><th>Consumo</th><th>% del Total</th></tr></thead>`;
        htmlContent += `<tbody>`;

        niveles.forEach((nivelItem, index) => {
          const porcentaje = nivelItem.porcentaje;
          htmlContent += `<tr>`;
          htmlContent += `<td><strong>${nivelItem.nivel}</strong></td>`;
          htmlContent += `<td class="cantidad-cell">${nivelItem.cantidad.toLocaleString('es-HN')} und.</td>`;
          htmlContent += `<td><span class="porcentaje-badge">${porcentaje.toFixed(1)}%</span></td>`;
          htmlContent += `</tr>`;
        });

        htmlContent += `</tbody></table>`;
        htmlContent += `</div>`;
      }
      htmlContent += `</div>`;
    }

    if (htmlContent === '') {
      htmlContent = '<div style="text-align: center; padding: 40px; color: #666;"><i class="fas fa-search"></i> No se encontraron edificios que coincidan con la búsqueda</div>';
    }

    content.innerHTML = htmlContent;
  }

  function filtrarRanking() {
    generarVistaRanking();
  }

  function generarPDFRanking() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm'
    });

    const fechaInicio = $('#fecha-inicio-resumen').val();
    const fechaFin = $('#fecha-fin-resumen').val();
    const formatDate = (dateStr) => {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      return `${day}-${month}-${year}`;
    };

    // Título principal
    doc.setFontSize(18);
    doc.setTextColor(44, 62, 80);
    doc.setFont(undefined, 'bold');
    doc.text("RANKING DE CONSUMO POR NIVEL", doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });

    // Período
    doc.setFontSize(11);
    doc.setTextColor(100, 100, 100);
    doc.setFont(undefined, 'normal');
    doc.text(`Período: ${formatDate(fechaInicio)} al ${formatDate(fechaFin)}`, doc.internal.pageSize.getWidth() / 2, 22, { align: "center" });

    let yPos = 30;

    // ============================================
    // SECCIÓN 1: RESUMEN POR PRODUCTO
    // ============================================
    
    // Calcular totales por edificio y producto
    const resumenPorProducto = {};
    
    // Agrupar por producto primero
    for (const edificio in rankingData) {
      for (const producto in rankingData[edificio]) {
        if (!resumenPorProducto[producto]) {
          resumenPorProducto[producto] = [];
        }
        
        const totalProducto = rankingData[edificio][producto].reduce((sum, item) => sum + item.cantidad, 0);
        
        resumenPorProducto[producto].push({
          edificio: edificio,
          total: totalProducto
        });
      }
    }

    // Calcular total general por producto y ordenar cada lista
    for (const producto in resumenPorProducto) {
      // Calcular total general del producto (todos los edificios)
      const totalGeneralProducto = resumenPorProducto[producto].reduce((sum, item) => sum + item.total, 0);
      
      // Calcular porcentaje para cada edificio
      resumenPorProducto[producto].forEach(item => {
        item.porcentaje = totalGeneralProducto > 0 ? (item.total / totalGeneralProducto) * 100 : 0;
      });
      
      // Ordenar de mayor a menor consumo
      resumenPorProducto[producto].sort((a, b) => b.total - a.total);
    }

    // Título de la sección de resumen
    doc.setFillColor(52, 152, 219);
    doc.rect(15, yPos - 2, doc.internal.pageSize.getWidth() - 30, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text("RESUMEN POR PRODUCTO", doc.internal.pageSize.getWidth() / 2, yPos + 3, { align: "center" });
    yPos += 10;

    // Crear una tabla por cada producto
    for (const producto in resumenPorProducto) {
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }

      // Título del producto
      doc.setFillColor(240, 240, 240);
      doc.rect(15, yPos - 2, doc.internal.pageSize.getWidth() - 30, 8, 'F');
      doc.setTextColor(44, 62, 80);
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      
      // Calcular total general para mostrar
      const totalGeneral = resumenPorProducto[producto].reduce((sum, item) => sum + item.total, 0);
      doc.text(`${producto} - TOTAL GENERAL: ${totalGeneral.toLocaleString('es-HN')} unidades`, doc.internal.pageSize.getWidth() / 2, yPos + 3, { align: "center" });
      yPos += 10;

      // Preparar datos para la tabla
      const tableData = resumenPorProducto[producto].map(item => [
        item.edificio,
        item.total.toLocaleString('es-HN'),
        `${item.porcentaje.toFixed(1)}%`
      ]);

      // Crear tabla para este producto (ocupa todo el ancho)
      doc.autoTable({
        startY: yPos,
        head: [['EDIFICIO', 'CONSUMO (UNIDADES)', '% DEL TOTAL']],
        body: tableData,
        theme: 'grid',
        headStyles: {
          fillColor: [52, 152, 219],
          textColor: [255, 255, 255],
          fontSize: 10,
          fontStyle: 'bold',
          halign: 'center',
          valign: 'middle'
        },
        bodyStyles: {
          fontSize: 9,
          halign: 'center',
          valign: 'middle'
        },
        columnStyles: {
          0: { cellWidth: 'auto', halign: 'center' },
          1: { cellWidth: 'auto', halign: 'center' },
          2: { cellWidth: 'auto', halign: 'center' }
        },
        margin: { left: 15, right: 15 },
        didDrawPage: (data) => {
          yPos = data.cursor.y + 5;
        }
      });

      yPos = doc.lastAutoTable.finalY + 15;
      
      if (yPos > 270) {
        doc.addPage();
        yPos = 20;
      }
    }

    // ============================================
    // SECCIÓN 2: DETALLE POR NIVEL (EN NUEVA PÁGINA)
    // ============================================
    
    // Forzar nueva página para el detalle por nivel
    doc.addPage();
    yPos = 20;

    // Título de la sección de detalle
    doc.setFillColor(52, 152, 219);
    doc.rect(15, yPos - 2, doc.internal.pageSize.getWidth() - 30, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text("DETALLE POR NIVEL", doc.internal.pageSize.getWidth() / 2, yPos + 3, { align: "center" });
    yPos += 15;

    for (const edificio in rankingData) {
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }

      // Encabezado de edificio con fondo azul oscuro
      doc.setFillColor(44, 62, 80);
      doc.rect(15, yPos - 2, doc.internal.pageSize.getWidth() - 30, 10, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text(`EDIFICIO: ${edificio}`, doc.internal.pageSize.getWidth() / 2, yPos + 5, { align: "center" });
      yPos += 15;

      for (const producto in rankingData[edificio]) {
        const niveles = rankingData[edificio][producto];
        const totalProducto = niveles.reduce((sum, item) => sum + item.cantidad, 0);

        // Subtítulo de producto con fondo gris claro
        doc.setFillColor(240, 240, 240);
        doc.rect(15, yPos - 2, doc.internal.pageSize.getWidth() - 30, 8, 'F');
        doc.setTextColor(44, 62, 80);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`${producto} - TOTAL: ${totalProducto.toLocaleString('es-HN')} unidades`, doc.internal.pageSize.getWidth() / 2, yPos + 3, { align: "center" });
        yPos += 10;

        // Crear tabla para este producto
        const tableData = niveles.map(item => [
          item.nivel,
          item.cantidad.toLocaleString('es-HN'),
          `${item.porcentaje.toFixed(1)}%`
        ]);

        doc.autoTable({
          startY: yPos,
          head: [['NIVEL', 'CONSUMO (UNIDADES)', '% DEL TOTAL']],
          body: tableData,
          theme: 'grid',
          headStyles: {
            fillColor: [52, 152, 219],
            textColor: [255, 255, 255],
            fontSize: 10,
            fontStyle: 'bold',
            halign: 'center',
            valign: 'middle'
          },
          bodyStyles: {
            fontSize: 9,
            halign: 'center',
            valign: 'middle'
          },
          columnStyles: {
            0: { cellWidth: 'auto', halign: 'center' },
            1: { cellWidth: 'auto', halign: 'center' },
            2: { cellWidth: 'auto', halign: 'center' }
          },
          margin: { left: 15, right: 15 },
          didDrawPage: (data) => {
            yPos = data.cursor.y + 5;
          }
        });

        yPos = doc.lastAutoTable.finalY + 15;
        
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
      }
      
      // Espacio adicional entre edificios
      yPos += 5;
    }

    doc.save(`Ranking_${fechaInicio}_al_${fechaFin}.pdf`);
  }

  // Cerrar modales al hacer clic fuera
  window.onclick = function(event) {
    const rankingModal = document.getElementById('rankingModal');
    if (event.target == rankingModal) {
      cerrarModalRanking();
    }
    const graficosModal = document.getElementById('graficosModal');
    if (event.target == graficosModal) {
      cerrarModalGraficos();
    }
  }
</script>
</body>
</html>
