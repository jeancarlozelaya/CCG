<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pisos Brillantes - Resumen</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --text-color: #333;
      --border-color: #ddd;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: var(--text-color);
      line-height: 1.6;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
      color: white;
      text-align: center;
      padding: 18px 0;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: var(--shadow);
      position: relative;
    }

    .form-container {
      width: 90%;
      max-width: 1300px;
      margin: 25px auto;
      padding: 25px;
      background-color: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 25px;
      font-size: 1.8rem;
      position: relative;
      padding-bottom: 10px;
    }

    h1:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background-color: var(--secondary-color);
      border-radius: 2px;
    }

    /* Estilos para el contenedor de fechas y botón de carga */
    .date-filter-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .date-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-filter-container label {
      font-weight: bold;
      color: #333;
      white-space: nowrap;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .button-group button {
      flex: 1;
      min-width: 120px;
    }

    /* ESTILOS DE FECHA MEJORADOS */
    .date-filter-container input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-color: #f8f8f8;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      min-width: 140px;
    }

    .date-filter-container input[type="date"]::-webkit-calendar-picker-indicator {
      background: none;
      color: var(--secondary-color);
      font-size: 1.2em;
      cursor: pointer;
      opacity: 1;
      -webkit-filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg); 
      filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg);
    }

    .date-filter-container input[type="date"]:hover {
      border-color: var(--secondary-color);
    }

    .date-filter-container input[type="date"]:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
      background-color: #ffffff;
    }

    #btn-cargar-resumen-fechas {
      background-color: var(--success-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: var(--transition);
    }

    #btn-cargar-resumen-fechas:hover {
      background-color: #218838;
    }

    /* Estilos para el botón de gráficos */
    #btn-mostrar-graficos {
      background-color: #6f42c1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }

    #btn-mostrar-graficos:hover {
      background-color: #5a32a3;
    }

    /* Estilos para la ventana modal de resumen */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 900px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
    }

    .close-modal-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
      transition: var(--transition);
    }

    .close-modal-btn:hover,
    .close-modal-btn:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    #resumen-tabla-container {
      max-height: 70vh;
      overflow-y: auto;
      margin-top: 20px;
    }

    #resumen-tabla {
      width: 100%;
      border-collapse: collapse;
    }

    #resumen-tabla th, #resumen-tabla td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: center;
    }

    #resumen-tabla th {
      background-color: var(--secondary-color);
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    #resumen-tabla tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #resumen-tabla tbody tr:hover {
      background-color: #ddd;
    }

    /* Estilos para el campo de búsqueda del resumen */
    .resumen-search-container {
      margin-bottom: 15px;
      text-align: center;
    }

    #resumen-search-input {
      width: 80%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1em;
    }

    /* NUEVOS ESTILOS para los totales fuera de la tabla */
    #resumen-totals-section {
      margin-top: 20px;
      font-weight: bold;
      padding: 10px;
      border-top: 2px solid var(--secondary-color);
      background-color: #e9ecef;
      border-radius: 4px;
      display: none;
    }
    
    #resumen-product-sums {
      text-align: left;
      margin-top: 0px;
      font-weight: normal;
      padding-top: 0px;
    }
    
    #resumen-product-sums h4 {
      margin-top: 0;
      margin-bottom: 8px;
      color: #333;
      font-size: 1.1em;
    }
    
    #resumen-product-sums p {
      margin: 4px 0;
      padding-left: 10px;
    }

    /* Estilo para centrar el título del modal */
    .modal-title {
      text-align: center;
      margin-top: 0;
      margin-bottom: 20px;
      color: #333;
      font-size: 1.5em;
    }

    /* Estilo para el botón de PDF */
    #btn-generar-pdf {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }

    #btn-generar-pdf:hover {
      background-color: #c82333;
    }

    /* Estilos para el modal de gráficos */
    #graficosModal {
      display: none;
      position: fixed;
      z-index: 10001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
    }

    .graficos-modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 1200px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      position: relative;
    }

    .graficos-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      margin-top: 20px;
    }

    .grafico-item {
      flex: 1 1 45%;
      min-width: 400px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .grafico-item h3 {
      text-align: center;
      margin-top: 0;
      color: #333;
    }

    .grafico-canvas {
      width: 100% !important;
      height: 300px !important;
    }

    /* Estilos para el selector de tipo de gráfico */
    .chart-type-selector {
      margin-bottom: 20px;
      text-align: center;
    }

    .chart-type-selector select {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1em;
      background-color: #f8f8f8;
      cursor: pointer;
    }

    .chart-type-selector select:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    /* Nuevos estilos para los contenedores de gráficos por edificio y producto */
    .graficos-productos-container, .graficos-edificios-container {
      width: 100%;
      margin-top: 20px;
    }

    .graficos-productos-container h3, .graficos-edificios-container h3 {
      text-align: center;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 5px;
    }

    .graficos-productos-grid, .graficos-edificios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 10px;
    }

    .grafico-item {
      flex: 1 1 400px;
      margin: 10px;
      max-width: 45%;
    }

    .btn-generar-pdf {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
      margin-bottom: 15px;
    }

    .btn-generar-pdf:hover {
      background-color: #c82333;
    }

    .btn-generar-pdf:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(52, 152, 219, 0.2);
      border-radius: 50%;
      border-top-color: var(--secondary-color);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #loadingMessage {
      text-align: center;
      color: var(--dark-color);
    }

    #loadingMessage h4 {
      margin: 0 0 10px;
      font-size: 1.3rem;
    }

    #loadingMessage p {
      margin: 0;
      color: #7f8c8d;
    }

    .no-results {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    .button-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 20px;
    }
    
    .button-container button {
      font-size: 16px;
      padding: 12px 24px;
      background-color: var(--success-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: var(--transition);
    }

    #btn-devoluciones {
      background-color: var(--secondary-color);
    }

    #btn-devoluciones:hover {
      background-color: #0069d9;
    }

    /* Media queries para responsividad */
    @media (max-width: 768px) {
      .form-container {
        width: 95%;
        padding: 15px;
        margin: 15px auto;
      }
      
      .grafico-item {
        max-width: 100%;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      /* NUEVO: Estilos específicos para el contenedor de fechas en móviles */
      .date-filter-container {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .date-group {
        justify-content: space-between;
        width: 100%;
      }
      
      .date-group label {
        width: 80px;
        text-align: left;
      }
      
      .date-group input[type="date"] {
        width: calc(100% - 90px);
      }
      
      .button-group {
        width: 100%;
        justify-content: space-between;
      }
      
      .button-group button {
        flex: 1;
        margin: 2px;
        font-size: 14px;
        padding: 10px 8px;
      }
    }

    @media (max-width: 480px) {
      .button-group button {
        font-size: 12px;
        padding: 8px 6px;
      }
      
      .date-group label {
        width: 70px;
        font-size: 14px;
      }
      
      .date-group input[type="date"] {
        width: calc(100% - 80px);
        font-size: 14px;
      }
    }

    .chart-type-selector {
      display: none; /* La forma más común para ocultar el elemento por completo */
    }


  </style>
</head>
<body>
  <div id="main-content">
    <div class="header">Pisos Brillantes</div>
    
    <div class="form-container">
      <h1>Resumen de Gastos de Insumos</h1>

      <div class="date-filter-container">
        <div class="date-group">
          <label for="fecha-inicio-resumen">Desde:</label>
          <input type="date" id="fecha-inicio-resumen">
        </div>
        <div class="date-group">
          <label for="fecha-fin-resumen">Hasta:</label>
          <input type="date" id="fecha-fin-resumen">
        </div>
        <div class="button-group">
          <button type="button" id="btn-cargar-resumen-fechas" onclick="cargarResumenDevoluciones()">Cargar Resumen</button>
          <button type="button" id="btn-mostrar-graficos" onclick="abrirModalGraficos()">Mostrar Gráficos</button>
        </div>
      </div>

      <div class="resumen-search-container">
        <input type="text" id="resumen-search-input" placeholder="Filtrar por Edificio, Nivel o Producto (separado por espacios)" oninput="filtrarResumen()" autocomplete="off">
      </div>

      <div id="resumen-tabla-container">
        <table id="resumen-tabla">
          <thead>
            <tr>
              <th>Edificio</th>
              <th>Nivel</th>
              <th>Producto</th>
              <th>Total de Consumo</th>
            </tr>
          </thead>
          <tbody id="resumen-tbody">
            <tr>
              <td colspan="4" style="text-align: center; color: #666; font-style: italic;">
                Seleccione un rango de fechas y haga clic en "Cargar Resumen", luego podrán cargar los gráficos
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="resumen-totals-section">
          <div id="resumen-product-sums">
          </div>
      </div>

    </div>

    <!-- Overlay solo se muestra cuando se está cargando algo -->
    <div id="overlay" style="display: none;">
      <div class="spinner"></div>
      <div id="loadingMessage">
        <h4>Por favor espera un momento...</h4>
        <p></p>
      </div>
    </div>
  </div>

  <!-- Modal para gráficos -->
  <div id="graficosModal" class="modal">
    <div class="graficos-modal-content">
      <span class="close-modal-btn" onclick="cerrarModalGraficos()">&times;</span>
      <h2 class="modal-title">Gráficos de Consumo</h2>
      
      <div class="chart-type-selector">
        <label for="chart-type">Tipo de Gráfico: </label>
        <select id="chart-type" onchange="actualizarGraficos()">
          <option value="bar">Barras</option>
        </select>
      </div>
      
      <div class="graficos-container" style="display: flex; flex-wrap: wrap; justify-content: center;">
        <div class="grafico-item">
          <h3>Consumo por Producto</h3>
          <canvas id="productoChart" class="grafico-canvas"></canvas>
        </div>
        
        <!-- Nuevo contenedor para gráficos por edificio por producto -->
        <div class="graficos-productos-container">
          <h3>Consumo por Edificio (por Producto)</h3>
          <div id="graficos-productos" class="graficos-productos-grid">
            <!-- Los gráficos se generarán dinámicamente aquí -->
          </div>
        </div>
        
        <!-- Nuevo contenedor para gráficos por nivel por edificio -->
        <div class="graficos-edificios-container">
          <h3>Consumo por Nivel (por Edificio)</h3>
          <div id="graficos-edificios" class="graficos-edificios-grid">
            <!-- Los gráficos se generarán dinámicamente aquí -->
          </div>
        </div>
        
        <div class="grafico-item">
          <h3>Consumo Diario</h3>
          <canvas id="diarioChart" class="grafico-canvas"></canvas>
        </div>
      </div>
    </div>
  </div>


<script>
  // Variables globales
  let resumenData = []; // Store the fetched resumen data for filtering
  let filteredResumenData = []; // Para guardar los datos filtrados del resumen
  let allSummaryDates = []; // Para guardar todas las fechas recibidas del resumen del script
  let charts = {}; // Objeto para almacenar las instancias de los gráficos

  // Variables para el control de toques rápidos en el título del modal
  let tapCount = 0;
  let lastTapTime = 0;
  const TAP_THRESHOLD_MS = 500; // Tiempo máximo entre toques para que cuenten como rápidos

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('main-content').style.display = 'block';
    
    // Establecer fechas por defecto
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

    // Formatear las fechas para el input[type="date"] (YYYY-MM-DD)
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    $('#fecha-inicio-resumen').val(formatDate(firstDayOfMonth));
    $('#fecha-fin-resumen').val(formatDate(today));
    
    // NO cargar resumen automáticamente al abrir la página
    // Solo establecer las fechas por defecto
    
    // INICIO DE CAMBIO: Listener para la combinación de teclas
    document.addEventListener('keydown', function(event) {
      // Check for Ctrl (or Cmd on Mac) + Shift + S
      if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'S') {
          const totalsSection = document.getElementById('resumen-totals-section');
          if (totalsSection.style.display === 'none') {
              totalsSection.style.display = 'block';
          } else {
              totalsSection.style.display = 'none';
          }
          event.preventDefault(); // Previene el comportamiento por defecto del navegador para esta combinación
      }
    });
    // FIN DE CAMBIO
  });

  function cargarResumenDevoluciones() {
    const fechaInicio = $('#fecha-inicio-resumen').val();
    const fechaFin = $('#fecha-fin-resumen').val();

    if (!fechaInicio || !fechaFin) {
        Swal.fire('Advertencia', 'Por favor, seleccione una fecha de inicio y una fecha de fin.', 'warning');
        return;
    }

    if (new Date(fechaInicio) > new Date(fechaFin)) {
        Swal.fire('Advertencia', 'La fecha de inicio no puede ser posterior a la fecha de fin.', 'warning');
        return;
    }


    
    const resumenTbody = $('#resumen-tbody');
    resumenTbody.empty().append(`
        <tr id="loading-row">
            <td colspan="4" style="text-align: center; padding: 20px;">
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div class="spinner" style="margin: 0;"></div>
                    <div style="margin-top: 10px;">Cargando resumen, por favor espere...</div>
                </div>
            </td>
        </tr>
    `);
    
    // Reiniciar el input de búsqueda del resumen
    $('#resumen-search-input').val('');

    const scriptResumenUrl = `https://script.google.com/macros/s/AKfycbwJKU4mJvqMjenGjobggSFmaSPSZgYF8cXzhr82h0Gbq-y3SsSqKqoHj2GU9IhAMw6C/exec?action=obtenerResumen&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`; 
    
    $.ajax({
        url: scriptResumenUrl,
        type: "GET",
        dataType: "json",
        success: function(data) {
            // Ocultar overlay
            $('#overlay').hide();
            // Eliminar el spinner de carga
            $('#loading-row').remove();
            
            if (data.error) {
                resumenTbody.append(`<tr><td colspan="4" style="text-align: center; color: red;">Error: ${data.mensaje}</td></tr>`);
                Swal.fire('Error', data.mensaje, 'error');
                return;
            }
            if (!data.resumen || data.resumen.length === 0) {
                resumenTbody.append('<tr><td colspan="4" style="text-align: center;">No hay datos en el historial para el rango de fechas seleccionado.</td></tr>');
                $('#resumen-product-sums').empty();
                filteredResumenData = [];
                allSummaryDates = [];
                return;
            }

            resumenData = data.resumen;
            filteredResumenData = [...resumenData];
            allSummaryDates = data.allTransactionDates || [];
            mostrarResumenEnTabla(filteredResumenData);
        },
        error: function(xhr, status, error) {
            // Ocultar overlay
            $('#overlay').hide();
            // Eliminar el spinner de carga
            $('#loading-row').remove();
            
            resumenTbody.empty().append(`<tr><td colspan="4" style="text-align: center; color: red;">Error al cargar resumen: ${error}</td></tr>`);
            Swal.fire('Error', 'Error al cargar el resumen: ' + error, 'error');
            $('#resumen-product-sums').empty();
            filteredResumenData = [];
            allSummaryDates = [];
        }
    });
  }

  function mostrarResumenEnTabla(dataToShow) {
    const resumenTbody = $('#resumen-tbody');
    resumenTbody.empty(); // Esto eliminará cualquier spinner existente
    
    let totalGeneral = 0; 
    const productSums = {}; 

    // Sort data first
    dataToShow.sort((a, b) => {
        const areaCompare = a.area.localeCompare(b.area);
        if (areaCompare !== 0) return areaCompare;

        const nivelA = String(a.nivel).toUpperCase();
        const nivelB = String(b.nivel).toUpperCase();

        if (nivelA === 'X' && nivelB !== 'X') return 1;
        if (nivelA !== 'X' && nivelB === 'X') return -1;
        if (nivelA === 'X' && nivelB === 'X') return 0;

        const numNivelA = parseInt(nivelA);
        const numNivelB = parseInt(nivelB);
        if (!isNaN(numNivelA) && !isNaN(numNivelB)) {
            const nivelCompare = numNivelA - numNivelB;
            if (nivelCompare !== 0) return nivelCompare;
        } else if (isNaN(numNivelA) && !isNaN(numNivelB)) {
            return 1; 
        } else if (!isNaN(numNivelA) && isNaN(numNivelB)) {
            return -1; 
        }
        return a.producto.localeCompare(b.producto);
    });

    if (dataToShow.length === 0) {
        resumenTbody.append('<tr><td colspan="4" style="text-align: center;">No se encontraron resultados para el filtro actual.</td></tr>');
    } else {
        dataToShow.forEach(item => {
            resumenTbody.append(`
                <tr>
                    <td>${item.area}</td>
                    <td>${item.nivel === '0' ? 'Sin Nivel' : item.nivel}</td>
                    <td>${item.producto}</td>
                    <td>${item.cantidadTotal}</td>
                </tr>
            `);
            totalGeneral += item.cantidadTotal; 

            if (productSums[item.producto]) {
                productSums[item.producto] += item.cantidadTotal;
            } else {
                productSums[item.producto] = item.cantidadTotal;
            }
        });
    }

    // Update Product Sums display
    const resumenProductSumsDiv = $('#resumen-product-sums');
    resumenProductSumsDiv.empty();
    if (Object.keys(productSums).length > 0) {
        resumenProductSumsDiv.append('<h4>Resumen de Consumo:</h4>');
        for (const product in productSums) {
            resumenProductSumsDiv.append(`<p>${product}: ${productSums[product].toLocaleString('es-HN')} unidades</p>`);
        }
    }
  }

  function filtrarResumen() {
    const searchText = $('#resumen-search-input').val().toLowerCase().trim();
    const keywords = searchText.split(' ').filter(keyword => keyword.length > 0);

    // No mostrar spinner si estamos filtrando (los datos ya están cargados)
    filteredResumenData = resumenData.filter(item => {
        const area = item.area.toLowerCase();
        const nivel = String(item.nivel).toLowerCase();
        const producto = item.producto.toLowerCase();

        if (keywords.length === 0) return true;

        return keywords.every(keyword =>
            area.includes(keyword) ||
            nivel.includes(keyword) ||
            producto.includes(keyword)
        );
    });
    
    mostrarResumenEnTabla(filteredResumenData);
    
    // Actualizar gráficos si el modal está abierto
    if (document.getElementById('graficosModal').style.display === 'flex') {
        generarGraficos();
    }
  }

  // NUEVA FUNCIÓN: Generar PDF del Resumen

  // Funciones para el modal de gráficos
  function abrirModalGraficos() {
      if (filteredResumenData.length === 0) {
          Swal.fire('Advertencia', 'No hay datos en el resumen para generar gráficos. Cargue un resumen primero.', 'warning');
          return;
      }

      // Mostrar modal con estado de carga
      const modal = document.getElementById('graficosModal');
      modal.style.display = 'flex';
      
      // Limpiar contenido anterior y mostrar loader
      const content = document.querySelector('.graficos-modal-content');
      content.innerHTML = `
          <span class="close-modal-btn" onclick="cerrarModalGraficos()">&times;</span>
          <h2 class="modal-title">Gráficos de Consumo</h2>
          <div style="text-align: center; margin-bottom: 20px;">
              <button type="button" id="btn-generar-pdf-graficos" class="btn-generar-pdf" onclick="generarPDFGraficos()">
                  Generar Reporte en PDF
              </button>
          </div>
          <div id="graficos-loading" style="text-align: center; padding: 40px;">
              <div class="spinner" style="margin: 0 auto;"></div>
              <h3 style="margin-top: 20px;">Cargando gráficos, por favor espere...</h3>
          </div>
          <div id="graficos-content" style="display: none;">
              <div class="chart-type-selector">
                  <label for="chart-type">Tipo de Gráfico: </label>
                  <select id="chart-type" onchange="actualizarGraficos()">
                      <option value="bar">Barras</option>
                  </select>
              </div>
              <div class="graficos-container" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
          </div>
      `;

      // Generar gráficos (esto mostrará el contenido cuando termine)
      generarGraficos();
  }

  function cerrarModalGraficos() {
      // Destruir los gráficos existentes
      Object.values(charts).forEach(chart => {
          if (chart) chart.destroy();
      });
      charts = {};
      
      // Ocultar el modal
      document.getElementById('graficosModal').style.display = 'none';
  }

  async function generarGraficos() {
      // Obtener elementos del DOM
      const loadingElement = document.getElementById('graficos-loading');
      const contentElement = document.getElementById('graficos-content');
      const graficosContainer = document.querySelector('.graficos-container');
      const pdfButton = document.getElementById('btn-generar-pdf-graficos');
      
      // Mostrar loader y ocultar contenido
      if (loadingElement) loadingElement.style.display = 'block';
      if (contentElement) contentElement.style.display = 'none';
      if (pdfButton) pdfButton.disabled = true;
      
      // Limpiar gráficos existentes
      Object.values(charts).forEach(chart => {
          if (chart) chart.destroy();
      });
      charts = {};
      graficosContainer.innerHTML = '';

      try {
          // Obtener datos del resumen y datos diarios en paralelo
          const [datosResumen, datosDiarios] = await Promise.all([
              Promise.resolve(prepararDatosParaGraficos()),
              cargarDatosDiarios()
          ]);

          const chartType = document.getElementById('chart-type').value;

          // Configuración común para tooltips
          const commonTooltipOptions = {
              callbacks: {
                  label: function(context) {
                      return `${context.label || context.dataset.label}: ${context.raw} unidades`;
                  }
              },
              intersect: false,
              mode: 'index',
              position: 'nearest',
              filter: () => true
          };

          // 1. Gráfico de productos
          const productoDiv = document.createElement('div');
          productoDiv.className = 'grafico-item';
          productoDiv.innerHTML = '<h3>Consumo por Producto</h3><canvas id="productoChart" class="grafico-canvas"></canvas>';
          graficosContainer.appendChild(productoDiv);

          const productoCtx = document.getElementById('productoChart').getContext('2d');
          charts.productoChart = new Chart(productoCtx, {
              type: chartType,
              data: {
                  labels: datosResumen.productos.labels,
                  datasets: [{
                      label: 'Consumo por Producto',
                      data: datosResumen.productos.data,
                      backgroundColor: generarColores(datosResumen.productos.labels.length),
                      borderColor: '#333',
                      borderWidth: 1
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          position: chartType === 'pie' ? 'right' : 'top',
                      },
                      tooltip: commonTooltipOptions
                  },
                  scales: chartType !== 'pie' ? {
                      y: {
                          beginAtZero: true,
                          title: {
                              display: true,
                              text: 'Cantidad (unidades)'
                          }
                      }
                  } : undefined
              }
          });

          // 2. Gráficos por edificio y producto
          for (const producto in datosResumen.edificios) {
              const edificioDiv = document.createElement('div');
              edificioDiv.className = 'grafico-item';
              edificioDiv.innerHTML = `<h3>Consumo en Edificios (${producto})</h3><canvas id="edificioChart-${producto}" class="grafico-canvas"></canvas>`;
              graficosContainer.appendChild(edificioDiv);

              const edificioCtx = document.getElementById(`edificioChart-${producto}`).getContext('2d');
              charts[`edificioChart-${producto}`] = new Chart(edificioCtx, {
                  type: chartType,
                  data: {
                      labels: datosResumen.edificios[producto].labels,
                      datasets: [{
                          label: `Consumo de ${producto}`,
                          data: datosResumen.edificios[producto].data,
                          backgroundColor: generarColores(datosResumen.edificios[producto].labels.length),
                          borderColor: '#333',
                          borderWidth: 1
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              position: chartType === 'pie' ? 'right' : 'top',
                          },
                          tooltip: commonTooltipOptions
                      },
                      scales: chartType !== 'pie' ? {
                          y: {
                              beginAtZero: true,
                              title: {
                                  display: true,
                                  text: 'Cantidad (unidades)'
                              }
                          }
                      } : undefined
                  }
              });
          }

          // 3. Gráficos por nivel, edificio y producto
          for (const edificio in datosResumen.niveles) {
              for (const producto in datosResumen.niveles[edificio]) {
                  const nivelDiv = document.createElement('div');
                  nivelDiv.className = 'grafico-item';
                  nivelDiv.innerHTML = `<h3>Consumo en ${edificio} - ${producto} por Nivel</h3><canvas id="nivelChart-${edificio}-${producto}" class="grafico-canvas"></canvas>`;
                  graficosContainer.appendChild(nivelDiv);

                  const nivelCtx = document.getElementById(`nivelChart-${edificio}-${producto}`).getContext('2d');
                  charts[`nivelChart-${edificio}-${producto}`] = new Chart(nivelCtx, {
                      type: chartType,
                      data: {
                          labels: datosResumen.niveles[edificio][producto].labels,
                          datasets: [{
                              label: `Consumo en ${edificio}`,
                              data: datosResumen.niveles[edificio][producto].data,
                              backgroundColor: generarColores(datosResumen.niveles[edificio][producto].labels.length),
                              borderColor: '#333',
                              borderWidth: 1
                          }]
                      },
                      options: {
                          responsive: true,
                          maintainAspectRatio: false,
                          plugins: {
                              legend: {
                                  position: chartType === 'pie' ? 'right' : 'top',
                              },
                              tooltip: commonTooltipOptions
                          },
                          scales: chartType !== 'pie' ? {
                              y: {
                                  beginAtZero: true,
                                  title: {
                                      display: true,
                                      text: 'Cantidad (unidades)'
                                  }
                              }
                          } : undefined
                      }
                  });
              }
          }

          // 4. Gráficos diarios por producto
          if (datosDiarios && datosDiarios.length > 0) {
              datosDiarios.forEach(datosProducto => {
                  if (datosProducto.datos && datosProducto.datos.length > 0) {
                      const diarioDiv = document.createElement('div');
                      diarioDiv.className = 'grafico-item';
                      diarioDiv.innerHTML = `<h3>Consumo Diario (${datosProducto.producto})</h3><canvas id="diarioChart-${datosProducto.producto}" class="grafico-canvas"></canvas>`;
                      graficosContainer.appendChild(diarioDiv);

                      const diarioCtx = document.getElementById(`diarioChart-${datosProducto.producto}`).getContext('2d');
                      charts[`diarioChart-${datosProducto.producto}`] = new Chart(diarioCtx, {
                          type: 'line',
                          data: {
                              labels: datosProducto.datos.map(d => d.fecha),
                              datasets: [{
                                  label: `Consumo Diario ${datosProducto.producto}`,
                                  data: datosProducto.datos.map(d => d.cantidad),
                                  backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                  borderColor: 'rgba(54, 162, 235, 1)',
                                  borderWidth: 2,
                                  tension: 0.1,
                                  fill: true
                              }]
                          },
                          options: {
                              responsive: true,
                              maintainAspectRatio: false,
                              plugins: {
                                  legend: {
                                      position: 'top',
                                  },
                                  tooltip: commonTooltipOptions
                              },
                              scales: {
                                  y: {
                                      beginAtZero: true,
                                      title: {
                                          display: true,
                                          text: 'Cantidad (unidades)'
                                      }
                                  },
                                  x: {
                                      title: {
                                          display: true,
                                          text: 'Fecha'
                                      }
                                  }
                              },
                              elements: {
                                  point: {
                                      radius: function(context) {
                                          return context.raw > 0 ? 5 : 3;
                                      },
                                      hoverRadius: 7
                                  }
                              }
                          }
                      });
                  }
              });
          }

          // Ocultar loader y mostrar contenido
          if (loadingElement) loadingElement.style.display = 'none';
          if (contentElement) contentElement.style.display = 'block';
          if (pdfButton) pdfButton.disabled = false;

      } catch (error) {
          console.error('Error al generar gráficos:', error);
          if (loadingElement) {
              loadingElement.innerHTML = '<div style="color: red;">Error al cargar los gráficos. Intente nuevamente.</div>';
          }
          if (pdfButton) pdfButton.disabled = true;
      }
  }

  function actualizarGraficos() {
      // Mostrar loader y ocultar contenido
      const loadingElement = document.getElementById('graficos-loading');
      const contentElement = document.getElementById('graficos-content');
      
      if (loadingElement) loadingElement.style.display = 'block';
      if (contentElement) contentElement.style.display = 'none';
      
      // Llamar a generarGraficos después de un pequeño retraso para que se vea el loader
      setTimeout(generarGraficos, 100);
  }

  function prepararDatosParaGraficos() {
      const datos = {
          productos: { labels: [], data: [] },
          edificios: {},    // { producto: { labels: [edificios], data: [] } }
          niveles: {}       // { edificio: { producto: { labels: [niveles], data: [] } }
      };

      // 1. Agrupar datos por producto (total general)
      const productosMap = {};
      filteredResumenData.forEach(item => {
          if (productosMap[item.producto]) {
              productosMap[item.producto] += item.cantidadTotal;
          } else {
              productosMap[item.producto] = item.cantidadTotal;
          }
      });
      datos.productos.labels = Object.keys(productosMap);
      datos.productos.data = Object.values(productosMap);

      // 2. Agrupar datos por edificio (por producto)
      filteredResumenData.forEach(item => {
          if (!datos.edificios[item.producto]) {
              datos.edificios[item.producto] = { labels: [], data: [] };
          }
          
          const edificioIndex = datos.edificios[item.producto].labels.indexOf(item.area);
          if (edificioIndex === -1) {
              datos.edificios[item.producto].labels.push(item.area);
              datos.edificios[item.producto].data.push(item.cantidadTotal);
          } else {
              datos.edificios[item.producto].data[edificioIndex] += item.cantidadTotal;
          }
      });

      // 3. Agrupar datos por nivel (por edificio Y por producto)
      filteredResumenData.forEach(item => {
          // Inicializar estructura para el edificio si no existe
          if (!datos.niveles[item.area]) {
              datos.niveles[item.area] = {};
          }
          
          // Inicializar estructura para el producto dentro del edificio si no existe
          if (!datos.niveles[item.area][item.producto]) {
              datos.niveles[item.area][item.producto] = { labels: [], data: [] };
          }
          
          // Convertir "Sin Nivel" a "0"
          const nivel = !item.nivel || item.nivel === 'Sin Nivel' ? '0' : item.nivel;
          
          const nivelIndex = datos.niveles[item.area][item.producto].labels.indexOf(nivel);
          if (nivelIndex === -1) {
              datos.niveles[item.area][item.producto].labels.push(nivel);
              datos.niveles[item.area][item.producto].data.push(item.cantidadTotal);
          } else {
              datos.niveles[item.area][item.producto].data[nivelIndex] += item.cantidadTotal;
          }
      });

      return datos;
  }

  function generarColores(cantidad) {
      const colores = [];
      const hueStep = Math.max(1, 360 / Math.max(1, cantidad)); // Evitar división por cero
      
      for (let i = 0; i < cantidad; i++) {
          const hue = i * hueStep;
          colores.push(`hsl(${hue}, 70%, 60%)`);
      }
      
      return colores;
  }

  function cargarDatosDiarios() {
      const fechaInicio = $('#fecha-inicio-resumen').val();
      const fechaFin = $('#fecha-fin-resumen').val();
      const filtro = $('#resumen-search-input').val() || '';

      if (!fechaInicio || !fechaFin) {
          return Promise.resolve(null);
      }

      return new Promise((resolve, reject) => {
          const scriptDiarioUrl = `https://script.google.com/macros/s/AKfycbwJbg1Fm8kJycqc0LCyNcVkMQxsyDspmKI6Yo99ktVogwDPTMBeGCpCtPFna7CjsGqGGg/exec?action=obtenerDatosDiarios&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}&filtro=${encodeURIComponent(filtro)}`;
          
          $.ajax({
              url: scriptDiarioUrl,
              type: "GET",
              dataType: "json",
              success: function(data) {
                  if (data.error) {
                      console.error("Error al cargar datos diarios:", data.mensaje);
                      reject(data.mensaje);
                  } else {
                      // Verificar y normalizar los datos recibidos
                      if (data.datosDiarios && data.datosDiarios.length > 0) {
                          data.datosDiarios.forEach(producto => {
                              if (!producto.datos) producto.datos = [];
                              
                              // Asegurar que todas las cantidades sean números
                              producto.datos.forEach(item => {
                                  if (!item.fecha) item.fecha = '';
                                  item.cantidad = parseFloat(item.cantidad) || 0;
                              });
                              
                              // Ordenar por fecha
                              producto.datos.sort((a, b) => {
                                  const [diaA, mesA] = a.fecha.split('/').map(Number);
                                  const [diaB, mesB] = b.fecha.split('/').map(Number);
                                  return mesA - mesB || diaA - diaB;
                              });
                          });
                          resolve(data.datosDiarios);
                      } else {
                          // Si no hay datos, devolver array vacío
                          resolve([]);
                      }
                  }
              },
              error: function(xhr, status, error) {
                  console.error("Error en la solicitud de datos diarios:", error);
                  reject(error);
              }
          });
      });
  }

  function generarPDFGraficos() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm'
      });

      // 1. Configuración básica
      const margin = 10;
      const spacing = 10;
      const chartWidth = (doc.internal.pageSize.getWidth() - (2 * margin) - spacing) / 2;
      const chartHeight = 60;
      const maxTitleLines = 2;

      // 2. Función simplificada para preparar imagen del gráfico (sin valores)
      const prepareChartImage = (canvas) => {
          return canvas.toDataURL('image/png');
      };

      // 3. Función para dividir títulos (se mantiene igual)
      const wrapText = (text, maxWidth) => {
          const words = text.split(' ');
          const lines = [];
          let currentLine = words[0];
          
          for (let i = 1; i < words.length; i++) {
              const word = words[i];
              const width = doc.getStringUnitWidth(currentLine + ' ' + word) * doc.internal.getFontSize() / doc.internal.scaleFactor;
              
              if (width < maxWidth) {
                  currentLine += ' ' + word;
              } else {
                  lines.push(currentLine);
                  currentLine = word;
              }
              
              if (lines.length >= maxTitleLines - 1) {
                  break;
              }
          }
          
          lines.push(currentLine);
          return lines;
      };

      // 4. Función para formatear fechas (se mantiene igual)
      const formatDateForFilename = (dateStr) => {
          if (!dateStr) return '';
          const [year, month, day] = dateStr.split('-');
          return `${day}-${month}-${year}`;
      };

      // 5. Función principal para agregar gráficos (simplificada)
      const addChartToPDF = (canvas, title, x, y) => {
          // Procesar el título
          const maxTitleWidth = chartWidth - 4;
          let titleLines = wrapText(title, maxTitleWidth);
          
          if (titleLines.length > maxTitleLines) {
              titleLines = titleLines.slice(0, maxTitleLines);
              titleLines[maxTitleLines - 1] = titleLines[maxTitleLines - 1].substring(0, 30) + '...';
          }

          // Agregar título
          doc.setFontSize(9);
          titleLines.forEach((line, i) => {
              doc.text(line, x + chartWidth / 2, y + 3 + (i * 4), { align: 'center' });
          });

          // Agregar imagen del gráfico (sin valores)
          const imgData = prepareChartImage(canvas);
          const chartY = y + (titleLines.length * 4) + 2;
          
          doc.roundedRect(
              x, 
              chartY, 
              chartWidth, 
              chartHeight, 
              2, 2, 'S'
          );
          
          doc.addImage(imgData, 'PNG', 
              x + 2, 
              chartY + 2, 
              chartWidth - 4, 
              chartHeight - 4
          );

          return titleLines.length * 4 + chartHeight + 5;
      };

      // 6. Configuración del documento
      doc.setFontSize(16);
      doc.text("Resumen de Gastos de Insumos", doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });

      // Fechas del filtro
      const fechaInicio = $('#fecha-inicio-resumen').val();
      const fechaFin = $('#fecha-fin-resumen').val();

      if (fechaInicio || fechaFin) {
          doc.setFontSize(10);
          const dateRangeText = `Período: ${formatDateForFilename(fechaInicio) || 'Inicio'} al ${formatDateForFilename(fechaFin) || 'Fin'}`;
          doc.text(dateRangeText, doc.internal.pageSize.getWidth() / 2, 22, { align: "center" });
      }

      // 7. Procesar los gráficos
      let yPosition = 30;
      const chartIds = Object.keys(charts);

      for (let i = 0; i < chartIds.length; i += 2) {
          const chartId1 = chartIds[i];
          const canvas1 = document.getElementById(chartId1);
          
          const chartId2 = chartIds[i + 1];
          const canvas2 = chartId2 ? document.getElementById(chartId2) : null;

          const title1 = canvas1?.parentElement.querySelector('h3')?.textContent || `Gráfico ${i + 1}`;
          const title2 = canvas2?.parentElement.querySelector('h3')?.textContent || `Gráfico ${i + 2}`;
          
          const titleLines1 = wrapText(title1, chartWidth);
          const titleLines2 = canvas2 ? wrapText(title2, chartWidth) : [];
          
          const neededHeight = Math.max(
              titleLines1.length * 4 + chartHeight + 5,
              titleLines2.length * 4 + chartHeight + 5
          );

          if (yPosition + neededHeight > doc.internal.pageSize.getHeight() - margin) {
              doc.addPage();
              yPosition = margin;
          }

          if (canvas1) {
              const heightUsed = addChartToPDF(canvas1, title1, margin, yPosition);
              
              if (canvas2) {
                  addChartToPDF(canvas2, title2, margin + chartWidth + spacing, yPosition);
              }
              
              yPosition += neededHeight + 5;
          }
      }

      // 8. Guardar el PDF
      const filename = `Resumen de Gastos de Insumos (${formatDateForFilename(fechaInicio)} - ${formatDateForFilename(fechaFin)}).pdf`;
      doc.save(filename);
  }
</script>
</body>
</html>
